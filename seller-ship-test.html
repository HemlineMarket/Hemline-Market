<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hemline — Shipping Test (Seller)</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; line-height: 1.4; }
    h1 { font-size: 20px; margin-bottom: 16px; }
    fieldset { border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    legend { padding: 0 6px; color: #374151; }
    label { display: block; font-size: 12px; color: #374151; margin-top: 8px; }
    input { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    button { margin-top: 12px; padding: 10px 14px; border-radius: 10px; border: 0; background: black; color: white; cursor: pointer; }
    button.secondary { background: #111827; }
    .rates { margin-top: 12px; }
    .rate { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; margin-top: 8px; display:flex; align-items:center; justify-content:space-between; }
    .muted { color:#6b7280; font-size:12px; }
    .toast { margin-top: 12px; color: #065f46; background:#ecfdf5; border:1px solid #a7f3d0; padding:8px 10px; border-radius:8px; display:none; }
    .error { color:#7f1d1d; background:#fef2f2; border:1px solid #fecaca; }
    .code { white-space: pre-wrap; background:#f9fafb; border:1px dashed #e5e7eb; padding:10px; border-radius:8px; }
    .grid3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
  </style>
</head>
<body>
  <h1>Hemline — Shipping Test (Seller only)</h1>

  <fieldset>
    <legend>Destination</legend>
    <div class="row">
      <div>
        <label>Recipient Name</label>
        <input id="to_name" value="Test Buyer" />
      </div>
      <div>
        <label>Country</label>
        <input id="to_country" value="US" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Street</label>
        <input id="to_street1" value="1 Apple Way" />
      </div>
      <div>
        <label>City</label>
        <input id="to_city" value="Woburn" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>State</label>
        <input id="to_state" value="MA" />
      </div>
      <div>
        <label>ZIP</label>
        <input id="to_zip" value="01801" />
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Parcel</legend>
    <div class="grid3">
      <div>
        <label>Weight (oz)</label>
        <input id="p_weight" type="number" value="24" />
      </div>
      <div>
        <label>Length (in)</label>
        <input id="p_length" type="number" value="12" />
      </div>
      <div>
        <label>Width (in)</label>
        <input id="p_width" type="number" value="9" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Height (in)</label>
        <input id="p_height" type="number" value="2" />
      </div>
    </div>
    <button id="getRates">Get Rates</button>
    <div id="rates" class="rates"></div>
  </fieldset>

  <div id="toast" class="toast"></div>

  <script>
    const $ = id => document.getElementById(id);
    const toast = (msg, isError=false) => {
      const el = $('toast');
      el.textContent = msg;
      el.className = 'toast' + (isError ? ' error' : '');
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 4000);
    };

    function toPayload() {
      return {
        to: {
          name: $('to_name').value.trim(),
          street1: $('to_street1').value.trim(),
          city: $('to_city').value.trim(),
          state: $('to_state').value.trim(),
          zip: $('to_zip').value.trim(),
          country: $('to_country').value.trim()
        },
        parcel: {
          weight_oz: Number($('p_weight').value),
          length_in: Number($('p_length').value),
          width_in: Number($('p_width').value),
          height_in: Number($('p_height').value)
        }
      };
    }

    async function postJSON(url, data) {
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
      const txt = await res.text();
      let json; try { json = txt ? JSON.parse(txt) : {}; } catch { json = { raw: txt }; }
      if (!res.ok) throw new Error(json.error || res.statusText);
      return json;
    }

    $('getRates').addEventListener('click', async () => {
      $('rates').innerHTML = '';
      toast('Fetching rates…');
      try {
        const payload = toPayload();
        const data = await postJSON('/api/shipping/rates', payload);
        const list = data.rates || [];
        if (!list.length) {
          $('rates').innerHTML = '<div class="muted">No curated USPS rates returned for this parcel.</div>';
          toast('No rates for this parcel/destination', true);
          return;
        }
        const frag = document.createDocumentFragment();
        list.forEach(r => {
          const div = document.createElement('div');
          div.className = 'rate';
          div.innerHTML = `
            <div>
              <div><strong>${r.service_name || r.service_token || 'Service'}</strong> · ${r.provider || 'USPS'}</div>
              <div class="muted">${(r.estimated_days!=null) ? `~${r.estimated_days} days` : 'ETA varies'}</div>
            </div>
            <div>
              <button class="secondary" data-rate="${r.rate_object_id}">$${Number(r.amount).toFixed(2)} — Buy Label</button>
            </div>
          `;
          frag.appendChild(div);
        });
        $('rates').appendChild(frag);

        // Wire purchase buttons
        $('rates').querySelectorAll('button[data-rate]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const rateId = e.currentTarget.getAttribute('data-rate');
            try {
              toast('Purchasing label (Test)…');
              const resp = await postJSON('/api/shipping/label', { rate_object_id: rateId });
              const pdf = resp.label_pdf_url;
              const track = resp.tracking_number;
              const amt = resp.amount;
              $('rates').insertAdjacentHTML('beforeend',
                `<div class="code">Label purchased (TEST):
- Tracking: ${track || 'n/a'}
- Amount: $${amt != null ? Number(amt).toFixed(2) : '—'}
- PDF: <a href="${pdf}" target="_blank" rel="noopener">Open label</a></div>`);
              toast('Label created (Test). Open the PDF to view.');
            } catch (err) {
              toast('Error purchasing label: ' + err.message, true);
            }
          });
        });

        toast('Rates loaded.');
      } catch (err) {
        toast('Error fetching rates: ' + err.message, true);
      }
    });
  </script>
</body>
</html>
