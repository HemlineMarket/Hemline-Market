// FILE: api/stripe/list_transfers.js
// FIX: Renamed from list_transfers_js (was missing .js extension)
// Lists Stripe transfers for the authenticated user's connected account

import Stripe from "stripe";
import { createClient } from "@supabase/supabase-js";

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: "2024-06-20" });

function getSupabaseAdmin() {
  return createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_SERVICE_ROLE_KEY,
    { auth: { persistSession: false } }
  );
}

export default async function handler(req, res) {
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "GET, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");

  if (req.method === "OPTIONS") return res.status(200).end();
  if (req.method !== "GET") return res.status(405).json({ error: "Method not allowed" });

  try {
    // Verify JWT
    const authHeader = req.headers.authorization;
    if (!authHeader?.startsWith("Bearer ")) {
      return res.status(401).json({ error: "Unauthorized" });
    }

    const token = authHeader.replace("Bearer ", "");
    const supabase = getSupabaseAdmin();
    const { data: { user }, error: authError } = await supabase.auth.getUser(token);

    if (authError || !user) {
      return res.status(401).json({ error: "Invalid token" });
    }

    // Get user's Stripe Connect account ID from profile
    const { data: profile, error: profileError } = await supabase
      .from("profiles")
      .select("stripe_account_id")
      .eq("id", user.id)
      .maybeSingle();

    if (profileError || !profile?.stripe_account_id) {
      return res.status(400).json({ error: "No Stripe account connected" });
    }

    // List transfers to this connected account
    const transfers = await stripe.transfers.list({
      destination: profile.stripe_account_id,
      limit: 100,
    });

    return res.status(200).json({
      transfers: transfers.data.map(t => ({
        id: t.id,
        amount: t.amount,
        currency: t.currency,
        created: t.created,
        description: t.description,
        reversed: t.reversed,
      })),
      has_more: transfers.has_more,
    });

  } catch (err) {
    console.error("List transfers error:", err);
    return res.status(500).json({ error: "Failed to fetch transfers" });
  }
}
