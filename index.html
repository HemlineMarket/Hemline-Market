<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hemline Market</title>

<h1>Hemline Market</h1>

<div id="signedOut">
<input id="email" type="email" placeholder="Email" />
<button id="send">Send Magic Link</button>
<p id="msg"></p>
</div>

<div id="signedIn" style="display:none;">
<p id="who"></p>
<button id="signout">Sign out</button>

<h3>Upload an image</h3>
<input id="file" type="file" accept="image/*" />
<button id="uploadBtn">Upload</button>
<p id="uploadMsg"></p>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://clkizksbvxjkoatdajgd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = (id) => document.getElementById(id);
const showIn = (email) => { $("signedOut").style.display="none"; $("signedIn").style.display="block"; $("who").textContent = `Signed in as ${email}`; };
const showOut = () => { $("signedIn").style.display="none"; $("signedOut").style.display="block"; $("msg").textContent=""; };

// Send magic link
$("send").onclick = async () => {
const email = $("email").value.trim();
const { error } = await supabase.auth.signInWithOtp({
email,
options: { emailRedirectTo: window.location.href }
});
$("msg").textContent = error ? error.message : "Check your email for the link.";
};

// On load: show session if present
(async () => {
const { data: { session } } = await supabase.auth.getSession();
if (session?.user?.email) showIn(session.user.email);
})();

// Sign out
$("signout").onclick = async () => {
await supabase.auth.signOut();
showOut();
};

// Upload logic + public URL
$("uploadBtn").onclick = async () => {
const { data: { user } } = await supabase.auth.getUser();
if (!user) { $("uploadMsg").textContent = "You must be signed in."; return; }

const file = $("file").files[0];
if (!file) { $("uploadMsg").textContent = "Choose a file first."; return; }

const filePath = `${user.id}/${Date.now()}-${file.name}`;
const { error } = await supabase.storage.from("listing-images").upload(filePath, file);

if (error) {
$("uploadMsg").textContent = `Error: ${error.message}`;
return;
}

const { data: publicData } = supabase.storage.from("listing-images").getPublicUrl(filePath);
if (publicData?.publicUrl) {
$("uploadMsg").innerHTML = `Uploaded: <a href="${publicData.publicUrl}" target="_blank" rel="noopener">Open image</a>`;
} else {
$("uploadMsg").textContent = `Uploaded to ${filePath}`;
}
};
</script>
