<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Cart — Hemline Market</title>

  <!-- Shared CSS stack (universal) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#991b1b;
      --bg:#f4f4f7;
      --ok:#065f46;
      --okbg:#ecfdf5;
      --okbd:#a7f3d0;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:
        linear-gradient(to bottom,rgba(255,255,255,.55) 0%,rgba(255,255,255,.45) 100%),
        url("images/homepage.jpeg") center/cover fixed no-repeat,
        var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* PAGE LAYOUT (cart only) */
    .cart-wrap{
      max-width:1100px;
      margin:16px auto 28px;
      padding:0 12px;
    }
    .breadcrumb{
      color:#6b7280;
      font-size:14px;
      margin:6px 0 10px;
    }
    .breadcrumb b{color:#111827;}
    h1{margin:0 0 8px;}

    /* Status banner / cart state */
    .banner{
      margin:10px 0 16px;
      padding:14px 16px;
      border-radius:12px;
      border:1px solid var(--okbd);
      background:var(--okbg);
      color:var(--ok);
      display:flex;
      align-items:flex-start;
      gap:10px;
      font-size:14px;
      line-height:1.4;
      box-shadow:0 8px 16px rgba(0,0,0,0.03);
    }
    .banner svg{width:20px;height:20px;flex-shrink:0;}
    .banner-title{
      font-weight:700;
      margin-bottom:2px;
    }

    /* GRID + CARDS */
    .grid{
      display:grid;
      grid-template-columns:1fr 320px;
      gap:14px;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;}
    }
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
    }
    .card .hd{
      padding:12px;
      border-bottom:1px solid var(--border);
      font-weight:800;
    }
    .card .bd{
      padding:12px;
    }

    /* ITEMS */
    .item{
      display:grid;
      grid-template-columns:64px 1fr auto;
      gap:12px;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .item:last-child{border-bottom:0;}
    .thumb{
      width:64px;
      height:64px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#f8fafc;
      display:grid;
      place-items:center;
      color:#9ca3af;
      overflow:hidden;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .t1{font-weight:700;}
    .t2{
      color:#6b7280;
      font-size:13px;
      margin-top:2px;
    }
    .price{
      font-weight:700;
      min-width:88px;
      text-align:right;
    }
    .row-end{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
    }
    .link{
      color:#991b1b;
      text-decoration:none;
    }
    .t1 a:hover{
      text-decoration:underline;
      color:#991b1b;
    }
    .thumb a:hover img{
      opacity:0.85;
    }

    /* SUMMARY */
    .sum .row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .sum .row:last-child{border-bottom:0;}
    .muted{color:#6b7280;}
    .empty{
      padding:24px;
      text-align:center;
      color:#6b7280;
    }

    /* Shipping breakdown */
    .ship-lines{
      color:#6b7280;
      font-size:12px;
      line-height:1.35;
      text-align:right;
      margin-top:2px;
    }
  </style>
</head>
<body>

  <!-- Universal header placeholder -->
  <div id="hm-shell-header"></div>

  <main class="cart-wrap" id="maincontent">
    <div class="breadcrumb"><b>Cart</b> › Checkout › Payment</div>
    <h1>Your Cart</h1>

    <!-- Status banner -->
    <div id="cartBanner" class="banner" role="status" aria-live="polite" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 8v4m0 4h.01"></path>
      </svg>
      <div>
        <div id="cartBannerTitle" class="banner-title"></div>
        <div id="cartBannerText"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Items -->
      <section class="card">
        <div class="hd">Items</div>
        <div class="bd" id="items"></div>
        <div class="bd row-end">
          <a class="link" href="browse.html">Continue shopping</a>
          <a class="link" id="clearCart" href="#">Clear cart</a>
        </div>
      </section>

      <!-- Summary -->
      <aside class="card sum">
        <div class="hd">Summary</div>
        <div class="bd">
          <div class="row"><span>Subtotal</span><strong id="sub">$0.00</strong></div>
          <div class="row">
            <span>Shipping</span>
            <div style="text-align:right">
              <div id="ship">$0.00</div>
              <div id="shipLines" class="ship-lines"></div>
            </div>
          </div>
          <div class="row">
            <span>Tax</span>
            <span class="muted">Calculated at checkout</span>
          </div>
          <div class="row" style="font-weight:800">
            <span>Total</span>
            <span id="tot">$0.00</span>
          </div>
          <button id="checkout" class="hm-btn-primary" style="width:100%;margin-top:12px">Checkout</button>
        </div>
      </aside>
    </div>
  </main>

  <!-- Universal footer placeholder -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase (for universal header/session) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Universal shell JS -->
  <script src="scripts/hm-shell.js"></script>

  <!-- CART LOGIC (localStorage 'hm_cart' + per-seller shipping tiers) -->
  <script>
  (function(){
    const LS      = 'hm_cart';
    const SHIP_LS = 'hm_cart_shipping';

    const itemsEl        = document.getElementById('items');
    const subEl          = document.getElementById('sub');
    const shipEl         = document.getElementById('ship');
    const shipLinesEl    = document.getElementById('shipLines');
    const totEl          = document.getElementById('tot');
    const checkout       = document.getElementById('checkout');
    const banner         = document.getElementById('cartBanner');
    const bannerTitleEl  = document.getElementById('cartBannerTitle');
    const bannerTextEl   = document.getElementById('cartBannerText');

    const fmt = c => '$' + (Math.max(0, c) / 100).toFixed(2);

    // XSS protection - escape HTML entities
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    const read = () => {
      try{
        const data = JSON.parse(localStorage.getItem(LS) || '[]');
        // Validate that data is actually an array
        return Array.isArray(data) ? data : [];
      }catch(_){
        return [];
      }
    };

    const write = list => {
      localStorage.setItem(LS, JSON.stringify(list || []));
      // Let shared header/cart badge update if present
      if(window.HM_CART_BADGE_UPDATE){
        try{ window.HM_CART_BADGE_UPDATE(list || []); }catch(_){}
      }
    };

    // yards per item = stored yards, falling back to 1 if missing
    function itemYardsTotal(it){
      if(it.yards !== undefined && it.yards !== null && it.yards !== ''){
        const y = Number(it.yards) || 0;
        return y;
      }
      return 1;
    }

    // Prefer explicit total; otherwise treat amount as per-yard price and multiply by yards
    const lineAmount = it => {
      const explicit = Number(it.price_total || 0);
      if (explicit > 0) return explicit;

      const base  = Number(it.amount || 0);
      const yards = itemYardsTotal(it);
      if (yards > 0) return base * yards;
      return base;
    };

    // shipping tiers in cents based on total yards per seller
    const tierCents = yards => (yards < 3 ? 500 : (yards <= 10 ? 800 : 1500));

    function calcShipping(cart){
      const groups = {}; // sellerId -> { name, yards }
      cart.forEach(it=>{
        const yards = itemYardsTotal(it);
        const sellerId   = it.sellerId   || 'default_seller';
        const sellerName = it.sellerName || 'Seller';
        if(!groups[sellerId]) groups[sellerId] = { name:sellerName, yards:0 };
        groups[sellerId].yards += yards;
      });

      const lines = Object.values(groups).map(g => ({
        sellerName: g.name,
        yards     : g.yards,
        fee_cents : tierCents(g.yards)
      }));

      const total_cents = lines.reduce((sum,l)=>sum + l.fee_cents,0);
      localStorage.setItem(SHIP_LS, JSON.stringify({ lines, total_cents }));
      return { lines, total_cents };
    }

    function updateBanner(cart){
      if(!banner) return;
      if(!cart || cart.length === 0){
        banner.style.display = 'block';
        bannerTitleEl.textContent = 'Your cart is empty';
        bannerTextEl.textContent  = 'Browse Hemline Market to add fabrics and pieces to your cart.';
      }else{
        const totalItems = cart.length;
        banner.style.display = 'block';
        bannerTitleEl.textContent = 'Cart updated';
        bannerTextEl.textContent  = totalItems === 1
          ? 'You have 1 listing in your cart. You can remove it or proceed to checkout.'
          : 'You have ' + totalItems + ' listings in your cart. You can remove them or proceed to checkout.';
      }
    }

    function render(){
      const cart = read();
      itemsEl.innerHTML = '';

      if(cart.length === 0){
        itemsEl.innerHTML = '<div class="empty">Your cart is empty.</div>';
        subEl.textContent       = fmt(0);
        shipEl.textContent      = fmt(0);
        shipLinesEl.textContent = '';
        totEl.textContent       = fmt(0);
        checkout.disabled       = true;
        updateBanner(cart);
        return;
      }

      checkout.disabled = false;
      updateBanner(cart);

      let subtotal = 0;

      cart.forEach((it, i)=>{
        const line = lineAmount(it);
        subtotal += line;

        const per = it.perYd ? ('$' + Number(it.perYd).toFixed(2) + '/yd') : '';
        const yardsLabel = (it.yards !== undefined && it.yards !== null && it.yards !== '')
          ? (per ? ' · ' : '') + Number(it.yards) + ' yd'
          : '';

        // options (size, color, etc.) if present - escape all user data
        const optionBits = [];
        if(it.color) optionBits.push(escapeHtml(it.color));
        if(it.size) optionBits.push('Size ' + escapeHtml(it.size));
        if(it.optionLabel) optionBits.push(escapeHtml(it.optionLabel));
        if(Array.isArray(it.options) && it.options.length){
          optionBits.push(it.options.map(o => escapeHtml(o)).join(' · '));
        }
        const optionsHtml = optionBits.length
          ? '<div class="t2">' + optionBits.join(' · ') + '</div>'
          : '';

        const row = document.createElement('div');
        row.className = 'item';
        row.dataset.index = i;

        // Build listing link URL - use listing_id if available, fallback to id
        const itemListingId = it.listing_id || it.id;
        const listingUrl = itemListingId ? ('listing.html?id=' + encodeURIComponent(itemListingId)) : '#';
        const canLink = !!itemListingId;

        // Escape user-provided data to prevent XSS
        const safeName = escapeHtml(it.name || 'Fabric');
        const safePhoto = escapeHtml(it.photo || '');
        const safeColor = escapeHtml(it.color || '');
        const safeSize = escapeHtml(it.size || '');
        const safeOptionLabel = escapeHtml(it.optionLabel || '');

        row.innerHTML =
          '<div class="thumb">' +
            (canLink ? '<a href="'+listingUrl+'" style="display:block;width:100%;height:100%">' : '') +
            (safePhoto ? '<img alt="" src="'+safePhoto+'">' : '<span>—</span>') +
            (canLink ? '</a>' : '') +
          '</div>' +
          '<div>' +
            '<div class="t1">' +
              (canLink ? '<a href="'+listingUrl+'" class="link" style="color:inherit;text-decoration:none">' : '') +
              safeName +
              (canLink ? '</a>' : '') +
            '</div>' +
            '<div class="t2">'+(per + yardsLabel)+'</div>' +
            optionsHtml +
            '<div style="margin-top:8px;display:flex;gap:10px;align-items:center">' +
              '<span class="t2">One cut per listing</span>' +
              '<a href="#" class="link" data-act="rm">Remove</a>' +
            '</div>' +
          '</div>' +
          '<div class="price">'+fmt(line)+'</div>';

        itemsEl.appendChild(row);
      });

      const ship = calcShipping(cart);
      subEl.textContent  = fmt(subtotal);
      shipEl.textContent = fmt(ship.total_cents);
      shipLinesEl.innerHTML = ship.lines
        .map(l => `${l.sellerName}: ${l.yards.toFixed(2)} yd → ${fmt(l.fee_cents)}`)
        .join('<br>');
      totEl.textContent = fmt(subtotal + ship.total_cents);
    }

    // Remove SOLD listings from the local cart (in case someone else bought them)
    async function cleanSoldFromCart(){
      const hm = window.HM;
      const supabase = hm && hm.supabase;
      if(!supabase) return;

      const cart = read();
      if(!cart || !cart.length) return;

      const listingIds = Array.from(new Set(
        cart.map(it => it.listing_id).filter(Boolean)
      ));
      if(!listingIds.length) return;

      const { data, error } = await supabase
        .from('listings')
        .select('id, status')
        .in('id', listingIds);

      if(error || !data) return;

      const soldIds = new Set(
        data
          .filter(row => (row.status || '').toUpperCase() === 'SOLD')
          .map(row => row.id)
      );
      if(!soldIds.size) return;

      const filtered = cart.filter(it => !soldIds.has(it.listing_id));
      if(filtered.length !== cart.length){
        write(filtered);
      }
    }

    // remove-only interactions (no quantity changes)
    itemsEl.addEventListener('click', e=>{
      const act = e.target.dataset.act;
      if(act !== 'rm') return;
      e.preventDefault();

      const row = e.target.closest('.item');
      if(!row) return;
      const idx  = Number(row.dataset.index);
      const cart = read();
      if(idx < 0 || idx >= cart.length) return;

      cart.splice(idx, 1);
      write(cart);
      render();
    });

    document.getElementById('clearCart').addEventListener('click', e=>{
      e.preventDefault();
      write([]);
      render();
    });

    document.getElementById('checkout').addEventListener('click', ()=>{
      window.location.href = 'checkout.html';
    });

    // init: clean SOLD items based on Supabase, then render cart
    (async function init(){
      try{
        await cleanSoldFromCart();
      }catch(_){}
      render();
    })();
  })();
  </script>

  <!-- Render universal shell with current page -->
  <script>
    window.HM && window.HM.renderShell({ currentPage: "cart" });
  </script>
</body>
</html>
