<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hemline — Cart</title>
<style>
:root{--ink:#0f172a;--bg:#fafafa;--card:#ffffff;--line:#e5e7eb;--accent:#0ea5e9}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:24px;background:var(--bg);color:var(--ink)}
.wrap{max-width:800px;margin:auto}
h1{margin-bottom:16px}
.cart-item{display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
.thumb{width:70px;height:70px;object-fit:cover;border-radius:8px;background:#f1f5f9}
.info{flex:1}
.title{font-weight:600}
.price{color:var(--accent);font-weight:600}
.qty{display:flex;align-items:center;gap:8px}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:4px 8px;cursor:pointer}
.total{margin-top:20px;font-size:18px;font-weight:600;text-align:right}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.cta{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:10px;cursor:pointer}
.link{color:var(--accent);text-decoration:none}
</style></head>
<body>
<div class="wrap">
  <a href="listings.html" class="link" style="display:inline-block;margin-bottom:20px">← Back to Listings</a>
  <h1>Your Cart</h1>
  <div id="cart"></div>
  <div class="total" id="total"></div>
  <div class="actions">
    <a class="btn" href="cancel.html">Cancel</a>
    <button class="cta" id="checkoutBtn">Checkout</button>
  </div>
</div>

<script>
/* Config */
const SUPABASE_URL="https://clkizksbvxjkoatdajgd.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjM4MDE1ODIsImV4cCI6MjAzOTM3NzU4Mn0.MEu0Ex0bTtVnNuB-tAek95UbwsKdbWipzJrN84aKhlg";
const KEY="hem_cart";
const PH="https://via.placeholder.com/300x300?text=Fabric";
const readCart=()=>{try{return JSON.parse(localStorage.getItem(KEY)||"[]")}catch{return[]}};
const saveCart=a=>localStorage.setItem(KEY,JSON.stringify(a||[]));

function renderCart(){
  const cart=readCart();
  const wrap=document.getElementById("cart"); wrap.innerHTML="";
  let total=0;

  if(!cart.length){
    wrap.innerHTML="<p>Cart is empty.</p>";
    document.getElementById("total").textContent="";
    document.getElementById("checkoutBtn").disabled=true;
    return;
  }

  cart.forEach((it,idx)=>{
    total+= (Number(it.price)||0)*(Number(it.qty)||1);
    const div=document.createElement("div"); div.className="cart-item";
    div.innerHTML=`
      <img class="thumb" src="${it.img||PH}" alt="">
      <div class="info">
        <div class="title">${it.title||"Fabric"}</div>
        <div class="price">$${Number(it.price||0).toFixed(2)}/yd</div>
        <div class="qty">
          <button class="btn" data-a="dec">−</button>
          <strong>${it.qty||1}</strong>
          <button class="btn" data-a="inc">+</button>
          <button class="btn" data-a="rm" style="margin-left:12px">Remove</button>
        </div>
      </div>`;
    div.addEventListener("click",e=>{
      const b=e.target.closest("button"); if(!b)return;
      const a=b.getAttribute("data-a");
      const cartNow=readCart();
      if(a==="inc"){cartNow[idx].qty=(Number(cartNow[idx].qty)||1)+1;}
      else if(a==="dec"){cartNow[idx].qty=Math.max(1,(Number(cartNow[idx].qty)||1)-1);}
      else if(a==="rm"){cartNow.splice(idx,1);}
      saveCart(cartNow); renderCart();
    });
    wrap.appendChild(div);
  });

  document.getElementById("total").textContent="Total: $"+total.toFixed(2);
  document.getElementById("checkoutBtn").disabled=false;
}

/* Checkout with backup for cancel restore */
async function checkout(){
  const items=readCart(); if(!items.length) return;
  // backup current cart so cancel.html can restore it
  try{ sessionStorage.setItem("hem_cart_backup", localStorage.getItem(KEY)||"[]"); }catch(_){}
  // try to persist remotely
  try{
    await fetch(`${SUPABASE_URL}/rest/v1/orders`,{
      method:"POST",
      headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`,"Content-Type":"application/json",Prefer:"return=minimal"},
      body:JSON.stringify({items,created_at:new Date().toISOString()})
    });
  }catch(_){}
  // pass order to success + clear local cart
  sessionStorage.setItem("hem_order", JSON.stringify(items));
  localStorage.removeItem(KEY);
  window.location.href="success.html";
}

document.getElementById("checkoutBtn").addEventListener("click",checkout);
renderCart();
</script>
</body></html>
