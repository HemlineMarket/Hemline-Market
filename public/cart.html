<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Cart — Hemline Market</title>

  <!-- Shared CSS stack (universal) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>

  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#991b1b;
      --bg:#fafafa;
      --ok:#065f46;
      --okbg:#ecfdf5;
      --okbd:#a7f3d0;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      max-width:100%;
      overflow-x:hidden;
    }

    /* PAGE LAYOUT (cart only) */
    .cart-wrap{
      max-width:1100px;
      margin:16px auto 28px;
      padding:0 12px;
    }
    .breadcrumb{
      color:#6b7280;
      font-size:14px;
      margin:6px 0 10px;
    }
    .breadcrumb b{color:#111827;}
    h1{margin:0 0 8px;}

    /* Status banner */
    .banner{
      margin:10px 0 16px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--okbd);
      background:var(--okbg);
      color:var(--ok);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .banner svg{width:18px;height:18px;}

    /* GRID + CARDS */
    .grid{
      display:grid;
      grid-template-columns:1fr 320px;
      gap:14px;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;}
    }
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
    }
    .card .hd{
      padding:12px;
      border-bottom:1px solid var(--border);
      font-weight:800;
    }
    .card .bd{
      padding:12px;
    }

    /* ITEMS */
    .item{
      display:grid;
      grid-template-columns:64px 1fr auto;
      gap:12px;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .item:last-child{border-bottom:0;}
    .thumb{
      width:64px;
      height:64px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#f8fafc;
      display:grid;
      place-items:center;
      color:#9ca3af;
      overflow:hidden;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .t1{font-weight:700;}
    .t2{
      color:#6b7280;
      font-size:13px;
      margin-top:2px;
    }
    .qty{
      display:inline-flex;
      align-items:center;
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
    }
    .qty button{
      width:30px;
      height:30px;
      border:0;
      background:#fff;
      cursor:pointer;
    }
    .qty input{
      width:44px;
      text-align:center;
      border:0;
      border-left:1px solid var(--border);
      border-right:1px solid var(--border);
      height:30px;
    }
    .price{
      font-weight:700;
      min-width:88px;
      text-align:right;
    }
    .row-end{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
    }
    .link{
      color:#991b1b;
      text-decoration:none;
    }

    /* SUMMARY */
    .sum .row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .sum .row:last-child{border-bottom:0;}
    .muted{color:#6b7280;}
    .empty{
      padding:24px;
      text-align:center;
      color:#6b7280;
    }

    /* Shipping breakdown */
    .ship-lines{
      color:#6b7280;
      font-size:12px;
      line-height:1.35;
      text-align:right;
      margin-top:2px;
    }
  </style>
</head>
<body>

  <!-- Universal header placeholder -->
  <div id="hm-shell-header"></div>

  <main class="cart-wrap" id="maincontent">
    <div class="breadcrumb"><b>Cart</b> › Checkout › Payment</div>
    <h1>Your Cart</h1>

    <!-- Status banner -->
    <div id="cartBanner" class="banner" role="status" aria-live="polite" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 8v4m0 4h.01"></path>
      </svg>
      <span id="cartBannerText"></span>
    </div>

    <div class="grid">
      <!-- Items -->
      <section class="card">
        <div class="hd">Items</div>
        <div class="bd" id="items"></div>
        <div class="bd row-end">
          <a class="link" href="browse.html">Continue shopping</a>
          <a class="link" id="clearCart" href="#">Clear cart</a>
        </div>
      </section>

      <!-- Summary -->
      <aside class="card sum">
        <div class="hd">Summary</div>
        <div class="bd">
          <div class="row"><span>Subtotal</span><strong id="sub">$0.00</strong></div>
          <div class="row">
            <span>Shipping</span>
            <div style="text-align:right">
              <div id="ship">$0.00</div>
              <div id="shipLines" class="ship-lines"></div>
            </div>
          </div>
          <div class="row"><span>Tax</span><span class="muted">Calculated at checkout</span></div>
          <div class="row" style="font-weight:800"><span>Total</span><span id="tot">$0.00</span></div>
          <button id="checkout" class="hm-btn-primary" style="width:100%;margin-top:12px">Checkout</button>
        </div>
      </aside>
    </div>
  </main>

  <!-- Universal footer placeholder -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase (for universal header/session) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Universal shell JS -->
  <script src="scripts/hm-shell.js"></script>

  <!-- CART LOGIC (localStorage 'hm_cart' + per-seller shipping tiers) -->
  <script>
  (function(){
    const LS      = 'hm_cart';
    const SHIP_LS = 'hm_cart_shipping';

    const itemsEl     = document.getElementById('items');
    const subEl       = document.getElementById('sub');
    const shipEl      = document.getElementById('ship');
    const shipLinesEl = document.getElementById('shipLines');
    const totEl       = document.getElementById('tot');
    const checkout    = document.getElementById('checkout');
    const banner      = document.getElementById('cartBanner');
    const bannerText  = document.getElementById('cartBannerText');

    const fmt = c => '$' + (Math.max(0, c) / 100).toFixed(2);

    const read = () => {
      try{
        return JSON.parse(localStorage.getItem(LS) || '[]');
      }catch(_){
        return [];
      }
    };

    const write = list => {
      localStorage.setItem(LS, JSON.stringify(list || []));
      // Let shared header/cart badge update if present
      if(window.HM_CART_BADGE_UPDATE){
        try{ window.HM_CART_BADGE_UPDATE(list || []); }catch(_){}
      }
    };

    const lineAmount = it => (it.amount || 0) * (it.qty || 1);

    // shipping tiers in cents based on total yards per seller
    const tierCents = yards => (yards < 3 ? 500 : (yards <= 10 ? 800 : 1500));

    // yards per item = stored yards * qty, falling back to qty if yards missing
    function itemYardsTotal(it){
      const qty = Number(it.qty) || 1;
      if(it.yards !== undefined && it.yards !== null && it.yards !== ''){
        const y = Number(it.yards) || 0;
        return y * qty;
      }
      return qty;
    }

    function calcShipping(cart){
      const groups = {}; // sellerId -> { name, yards }
      cart.forEach(it=>{
        const yards = itemYardsTotal(it);
        const sellerId   = it.sellerId   || 'default_seller';
        const sellerName = it.sellerName || 'Seller';
        if(!groups[sellerId]) groups[sellerId] = { name:sellerName, yards:0 };
        groups[sellerId].yards += yards;
      });

      const lines = Object.values(groups).map(g => ({
        sellerName: g.name,
        yards     : g.yards,
        fee_cents : tierCents(g.yards)
      }));

      const total_cents = lines.reduce((sum,l)=>sum + l.fee_cents,0);
      localStorage.setItem(SHIP_LS, JSON.stringify({ lines, total_cents }));
      return { lines, total_cents };
    }

    function render(){
      const cart = read();
      itemsEl.innerHTML = '';

      if(cart.length === 0){
        itemsEl.innerHTML = '<div class="empty">Your cart is empty.</div>';
        subEl.textContent       = fmt(0);
        shipEl.textContent      = fmt(0);
        shipLinesEl.textContent = '';
        totEl.textContent       = fmt(0);
        checkout.disabled       = true;
        if(banner){
          banner.style.display = 'block';
          bannerText.textContent = 'Your cart is empty.';
        }
        return;
      }

      checkout.disabled = false;
      if(banner){
        banner.style.display = 'block';
        bannerText.textContent = 'Cart has items — ready to check out.';
      }

      let subtotal = 0;

      cart.forEach((it, i)=>{
        subtotal += lineAmount(it);

        const per = it.perYd ? ('$' + Number(it.perYd).toFixed(2) + '/yd') : '';
        const yardsLabel = (it.yards !== undefined && it.yards !== null && it.yards !== '')
          ? (per ? ' · ' : '') + Number(it.yards) + ' yd'
          : '';

        const row = document.createElement('div');
        row.className = 'item';
        row.dataset.index = i;

        row.innerHTML =
          '<div class="thumb">' +
            (it.photo ? '<img alt="" src="'+it.photo+'">' : '<span>—</span>') +
          '</div>' +
          '<div>' +
            '<div class="t1">'+(it.name || 'Fabric')+'</div>' +
            '<div class="t2">'+(per + yardsLabel)+'</div>' +
            '<div style="margin-top:8px;display:flex;gap:10px;align-items:center">' +
              '<div class="qty">' +
                '<button type="button" data-act="dec">−</button>' +
                '<input type="text" value="'+(it.qty || 1)+'" inputmode="numeric" aria-label="Quantity">' +
                '<button type="button" data-act="inc">+</button>' +
              '</div>' +
              '<a href="#" class="link" data-act="rm">Remove</a>' +
            '</div>' +
          '</div>' +
          '<div class="price">'+fmt(lineAmount(it))+'</div>';

        itemsEl.appendChild(row);
      });

      const ship = calcShipping(cart);
      subEl.textContent  = fmt(subtotal);
      shipEl.textContent = fmt(ship.total_cents);
      shipLinesEl.innerHTML = ship.lines
        .map(l => `${l.sellerName}: ${l.yards.toFixed(2)} yd → ${fmt(l.fee_cents)}`)
        .join('<br>');
      totEl.textContent = fmt(subtotal + ship.total_cents);
    }

    // quantity / remove interactions
    itemsEl.addEventListener('click', e=>{
      const act = e.target.dataset.act;
      if(!act) return;
      e.preventDefault();

      const row = e.target.closest('.item');
      if(!row) return;
      const idx  = Number(row.dataset.index);
      const cart = read();
      const it   = cart[idx];
      if(!it) return;

      if(act === 'inc'){
        it.qty = (it.qty || 1) + 1;
      }else if(act === 'dec'){
        it.qty = Math.max(1, (it.qty || 1) - 1);
      }else if(act === 'rm'){
        cart.splice(idx, 1);
      }

      write(cart);
      render();
    });

    itemsEl.addEventListener('input', e=>{
      if(e.target.tagName !== 'INPUT') return;
      const row = e.target.closest('.item');
      if(!row) return;
      const idx  = Number(row.dataset.index);
      const cart = read();
      const it   = cart[idx];
      if(!it) return;

      let v = parseInt(e.target.value || '1', 10);
      if(isNaN(v) || v < 1) v = 1;
      it.qty = v;
      write(cart);
      render();
    });

    document.getElementById('clearCart').addEventListener('click', e=>{
      e.preventDefault();
      write([]);
      render();
    });

    document.getElementById('checkout').addEventListener('click', ()=>{
      // Placeholder: later this can route to a real checkout flow
      window.location.href = 'checkout.html';
    });

    render();
  })();
  </script>

  <!-- Render universal shell with current page -->
  <script>
    window.HM && window.HM.renderShell({ currentPage: "cart" });
  </script>
</body>
</html>
