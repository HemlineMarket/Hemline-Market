<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Cart — Hemline Market</title>

  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#991b1b;
      --bg:#fafafa;
      --ok:#065f46;
      --okbg:#ecfdf5;
      --okbd:#a7f3d0;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* HEADER (matches other pages) */
    .hm-header{
      min-height:56px;
      background:#fff;
      border-bottom:1px solid var(--border);
      position:relative;
      z-index:101;
    }
    .hm-header .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:0 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .hm-brand{
      font-size:24px;
      font-weight:800;
      color:var(--accent);
      text-decoration:none;
    }
    .hamburger{
      display:inline-grid;
      place-items:center;
      width:36px;
      height:36px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      color:#374151;
      cursor:pointer;
    }
    .hamburger svg{width:22px;height:22px;stroke-width:2}
    .right{
      display:flex;
      align-items:center;
      gap:14px;
    }
    .hm-icon{
      color:#444;
      display:inline-grid;
      place-items:center;
    }
    .hm-icon svg{width:26px;height:26px;stroke-width:2}

    /* Account icon + login badge */
    .hm-account{
      position:relative;
      display:inline-grid;
      place-items:center;
      width:26px;
      height:26px;
    }
    .hm-account svg{
      width:26px;
      height:26px;
      stroke-width:2;
      display:block;
    }
    .hm-account-badge{
      position:absolute;
      bottom:-2px;
      right:-2px;
      width:10px;
      height:10px;
      border-radius:50%;
      border:2px solid #fff;
      background:#d1d5db;
    }
    .hm-account.is-logged-in .hm-account-badge{
      background:#16a34a;
    }
    .hm-account.is-logged-out .hm-account-badge{
      background:#d1d5db;
    }

    .hm-btn-primary{
      background:var(--accent);
      color:#fff;
      border:1px solid var(--accent);
      border-radius:999px;
      padding:10px 18px;
      font-weight:700;
      text-decoration:none;
      box-shadow:0 2px 8px rgba(153,27,27,.25);
    }

    /* LEFT SHEET MENU */
    .sheet{
      position:fixed;
      inset:0 auto 0 0;
      width:min(84vw,340px);
      background:#fff;
      border-right:1px solid var(--border);
      transform:translateX(-100%);
      transition:transform .25s ease;
      z-index:100;
      display:flex;
      flex-direction:column;
    }
    .sheet.open{transform:translateX(0);}
    .sheet header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      border-bottom:1px solid var(--border);
    }
    .sheet nav{
      display:grid;
      padding:10px;
    }
    .sheet nav a{
      padding:10px;
      border:1px solid var(--border);
      border-radius:10px;
      text-decoration:none;
      color:#1f2937;
    }
    .sheet nav a+a{margin-top:8px;}
    .sheet .close{
      display:inline-grid;
      place-items:center;
      width:30px;
      height:30px;
      border:1px solid var(--border);
      border-radius:8px;
      background:#fff;
      color:#444;
      cursor:pointer;
    }
    #sheetOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.25);
      backdrop-filter:blur(1px);
      display:none;
      z-index:90;
    }
    #sheetOverlay.show{display:block;}

    /* PAGE LAYOUT */
    .wrap{
      max-width:1100px;
      margin:16px auto 28px;
      padding:0 12px;
    }
    .breadcrumb{
      color:#6b7280;
      font-size:14px;
      margin:6px 0 10px;
    }
    .breadcrumb b{color:#111827;}
    h1{margin:0 0 8px;}

    /* Status banner */
    .banner{
      margin:10px 0 16px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--okbd);
      background:var(--okbg);
      color:var(--ok);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .banner svg{width:18px;height:18px;}

    /* GRID + CARDS */
    .grid{
      display:grid;
      grid-template-columns:1fr 320px;
      gap:14px;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;}
    }
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
    }
    .card .hd{
      padding:12px;
      border-bottom:1px solid var(--border);
      font-weight:800;
    }
    .card .bd{
      padding:12px;
    }

    /* ITEMS */
    .item{
      display:grid;
      grid-template-columns:64px 1fr auto;
      gap:12px;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .item:last-child{border-bottom:0;}
    .thumb{
      width:64px;
      height:64px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#f8fafc;
      display:grid;
      place-items:center;
      color:#9ca3af;
      overflow:hidden;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .t1{font-weight:700;}
    .t2{
      color:#6b7280;
      font-size:13px;
      margin-top:2px;
    }
    .qty{
      display:inline-flex;
      align-items:center;
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
    }
    .qty button{
      width:30px;
      height:30px;
      border:0;
      background:#fff;
      cursor:pointer;
    }
    .qty input{
      width:44px;
      text-align:center;
      border:0;
      border-left:1px solid var(--border);
      border-right:1px solid var(--border);
      height:30px;
    }
    .price{
      font-weight:700;
      min-width:88px;
      text-align:right;
    }
    .row-end{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
    }
    .link{
      color:#991b1b;
      text-decoration:none;
    }

    /* SUMMARY */
    .sum .row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .sum .row:last-child{border-bottom:0;}
    .muted{color:#6b7280;}
    .empty{
      padding:24px;
      text-align:center;
      color:#6b7280;
    }

    /* Shipping breakdown */
    .ship-lines{
      color:#6b7280;
      font-size:12px;
      line-height:1.35;
      text-align:right;
      margin-top:2px;
    }

    /* FOOTER (matches other pages) */
    .hm-footer{
      background:#fff;
      border-top:1px solid var(--border);
    }
    .footer-wrap{
      max-width:1200px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .footer-links{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
    }
    .copy{
      color:#6b7280;
      font-size:14px;
    }
    .footer-links a{
      color:#4b5563;
      text-decoration:none;
    }
    .footer-links a:hover{
      text-decoration:underline;
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header class="hm-header" role="banner">
  <div class="wrap">
    <div class="left">
      <button class="hamburger" id="openMenu" type="button" aria-label="Open menu" aria-controls="menuSheet" aria-expanded="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <line x1="4" y1="6"  x2="20" y2="6"></line>
          <line x1="4" y1="12" x2="20" y2="12"></line>
          <line x1="4" y1="18" x2="20" y2="18"></line>
        </svg>
      </button>
      <a class="hm-brand" href="index.html">Hemline Market</a>
    </div>
    <div class="right">
      <a class="hm-icon" href="browse.html" aria-label="Browse &amp; search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.3-4.3"></path>
        </svg>
      </a>
      <a class="hm-icon" href="ThreadTalk.html" aria-label="ThreadTalk" title="ThreadTalk">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M4 6.5A4.5 4.5 0 0 1 8.5 2h7A4.5 4.5 0 0 1 20 6.5v5A4.5 4.5 0 0 1 15.5 16H12l-4 4v-4H8.5A4.5 4.5 0 0 1 4 11.5z"></path>
        </svg>
      </a>
      <a class="hm-icon" href="favorites.html" aria-label="Favorites">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
      </a>
      <a class="hm-icon" href="notifications.html" aria-label="Notifications">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
      </a>
      <a class="hm-icon" href="cart.html" aria-label="Cart">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="9"  cy="21" r="1"></circle>
          <circle cx="18" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
      </a>

      <!-- Account icon with login status -->
      <a class="hm-icon hm-account is-logged-out" id="headerAccountLink" href="auth.html?view=login" aria-label="Sign in or manage your account">
        <span class="hm-account-badge" id="headerAccountBadge"></span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="8" r="3.2"></circle>
          <path d="M5 19c1.4-3 3.5-4.5 7-4.5s5.6 1.5 7 4.5"></path>
        </svg>
      </a>

      <a class="hm-btn-primary" href="sell.html">Sell</a>
    </div>
  </div>
</header>

<div id="sheetOverlay" aria-hidden="true"></div>

<!-- LEFT MENU -->
<aside class="sheet" id="menuSheet" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Site menu">
  <header>
    <strong>Menu</strong>
    <button class="close" id="closeMenu" aria-label="Close menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </header>
  <nav>
    <a href="account.html">Account</a>
    <a href="atelier.html">My Atelier</a>
    <a href="how.html">How It Works</a>
    <a href="sell.html">Sell Fabric</a>
    <a href="ThreadTalk.html">ThreadTalk</a>
    <a href="contact.html">Contact</a>
  </nav>
</aside>

<main class="wrap" id="maincontent">
  <div class="breadcrumb"><b>Cart</b> › Checkout › Payment</div>
  <h1>Your Cart</h1>

  <!-- Status banner -->
  <div id="cartBanner" class="banner" role="status" aria-live="polite" style="display:none">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="12" cy="12" r="10"></circle>
      <path d="M12 8v4m0 4h.01"></path>
    </svg>
    <span id="cartBannerText"></span>
  </div>

  <div class="grid">
    <!-- Items -->
    <section class="card">
      <div class="hd">Items</div>
      <div class="bd" id="items"></div>
      <div class="bd row-end">
        <a class="link" href="browse.html">Continue shopping</a>
        <a class="link" id="clearCart" href="#">Clear cart</a>
      </div>
    </section>

    <!-- Summary -->
    <aside class="card sum">
      <div class="hd">Summary</div>
      <div class="bd">
        <div class="row"><span>Subtotal</span><strong id="sub">$0.00</strong></div>
        <div class="row">
          <span>Shipping</span>
          <div style="text-align:right">
            <div id="ship">$0.00</div>
            <div id="shipLines" class="ship-lines"></div>
          </div>
        </div>
        <div class="row"><span>Tax</span><span class="muted">Calculated at checkout</span></div>
        <div class="row" style="font-weight:800"><span>Total</span><span id="tot">$0.00</span></div>
        <button id="checkout" class="hm-btn-primary" style="width:100%;margin-top:12px">Checkout</button>
      </div>
    </aside>
  </div>
</main>

<!-- FOOTER -->
<footer class="hm-footer" role="contentinfo">
  <div class="footer-wrap">
    <div class="copy">© 2025 Hemline Market</div>
    <nav class="footer-links" aria-label="Footer">
      <a href="about.html">About</a>
      <a href="faq.html">FAQ</a>
      <a href="contact.html">Contact</a>
      <a href="terms.html">Terms</a>
      <a href="privacy.html">Privacy</a>
    </nav>
  </div>
</footer>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // HEADER: hamburger / sheet / session-aware account icon
  (function(){
    const sheet    = document.getElementById('menuSheet');
    const openBtn  = document.getElementById('openMenu');
    const closeBtn = document.getElementById('closeMenu');
    const overlay  = document.getElementById('sheetOverlay');

    function lockScroll(lock){
      document.body.style.overflow = lock ? 'hidden' : '';
    }
    function openSheet(){
      if(!sheet) return;
      sheet.classList.add('open');
      sheet.setAttribute('aria-hidden','false');
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
      if(openBtn) openBtn.setAttribute('aria-expanded','true');
      lockScroll(true);
    }
    function closeSheet(){
      if(!sheet) return;
      sheet.classList.remove('open');
      sheet.setAttribute('aria-hidden','true');
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
      if(openBtn) openBtn.setAttribute('aria-expanded','false');
      lockScroll(false);
      if(openBtn) openBtn.focus();
    }

    if(openBtn && sheet && closeBtn && overlay){
      openBtn.addEventListener('click', e=>{ e.preventDefault(); openSheet(); });
      closeBtn.addEventListener('click', e=>{ e.preventDefault(); closeSheet(); });
      overlay.addEventListener('click', closeSheet);
      document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeSheet(); });
    }

    // Supabase client for header session state
    let supabaseClient = null;
    if (window.supabase){
      supabaseClient = window.supabase.createClient(
        "https://clkizksbvxjkoatdajgd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI",
        { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
      );
    }

    function updateHeaderForSession(session){
      const link = document.getElementById("headerAccountLink");
      if(!link) return;
      if(session && session.user){
        link.href = "account.html";
        link.setAttribute("aria-label","Your account");
        link.classList.add("is-logged-in");
        link.classList.remove("is-logged-out");
      }else{
        link.href = "auth.html?view=login";
        link.setAttribute("aria-label","Sign in or manage your account");
        link.classList.remove("is-logged-in");
        link.classList.add("is-logged-out");
      }
    }

    async function ensureSession(){
      if(!supabaseClient) return;
      try{
        const { data:{ session } } = await supabaseClient.auth.getSession();
        updateHeaderForSession(session);
      }catch(e){
        console.warn("Cart header session check failed:", e);
      }
    }

    if(supabaseClient){
      ensureSession();
      supabaseClient.auth.onAuthStateChange((_event, session)=>{
        updateHeaderForSession(session);
      });
    }
  })();
</script>

<script>
  // CART LOGIC (localStorage 'hm_cart' + per-seller shipping tiers)
  (function(){
    const LS      = 'hm_cart';
    const SHIP_LS = 'hm_cart_shipping';

    const itemsEl     = document.getElementById('items');
    const subEl       = document.getElementById('sub');
    const shipEl      = document.getElementById('ship');
    const shipLinesEl = document.getElementById('shipLines');
    const totEl       = document.getElementById('tot');
    const checkout    = document.getElementById('checkout');
    const banner      = document.getElementById('cartBanner');
    const bannerText  = document.getElementById('cartBannerText');

    const fmt = c => '$' + (Math.max(0, c) / 100).toFixed(2);

    const read = () => {
      try{
        return JSON.parse(localStorage.getItem(LS) || '[]');
      }catch(_){
        return [];
      }
    };

    const write = list => {
      localStorage.setItem(LS, JSON.stringify(list || []));
      // Let shared header/cart badge update if present
      if(window.HM_CART_BADGE_UPDATE){
        try{ window.HM_CART_BADGE_UPDATE(list || []); }catch(_){}
      }
    };

    const lineAmount = it => (it.amount || 0) * (it.qty || 1);

    // shipping tiers in cents based on total yards per seller
    const tierCents = yards => (yards < 3 ? 500 : (yards <= 10 ? 800 : 1500));

    // yards per item = stored yards * qty, falling back to qty if yards missing
    function itemYardsTotal(it){
      const qty = Number(it.qty) || 1;
      if(it.yards !== undefined && it.yards !== null && it.yards !== ''){
        const y = Number(it.yards) || 0;
        return y * qty;
      }
      return qty;
    }

    function calcShipping(cart){
      const groups = {}; // sellerId -> { name, yards }
      cart.forEach(it=>{
        const yards = itemYardsTotal(it);
        const sellerId   = it.sellerId   || 'default_seller';
        const sellerName = it.sellerName || 'Seller';
        if(!groups[sellerId]) groups[sellerId] = { name:sellerName, yards:0 };
        groups[sellerId].yards += yards;
      });

      const lines = Object.values(groups).map(g => ({
        sellerName: g.name,
        yards     : g.yards,
        fee_cents : tierCents(g.yards)
      }));

      const total_cents = lines.reduce((sum,l)=>sum + l.fee_cents,0);
      localStorage.setItem(SHIP_LS, JSON.stringify({ lines, total_cents }));
      return { lines, total_cents };
    }

    function render(){
      const cart = read();
      itemsEl.innerHTML = '';

      if(cart.length === 0){
        itemsEl.innerHTML = '<div class="empty">Your cart is empty.</div>';
        subEl.textContent       = fmt(0);
        shipEl.textContent      = fmt(0);
        shipLinesEl.textContent = '';
        totEl.textContent       = fmt(0);
        checkout.disabled       = true;
        if(banner){
          banner.style.display = 'block';
          bannerText.textContent = 'Your cart is empty.';
        }
        return;
      }

      checkout.disabled = false;
      if(banner){
        banner.style.display = 'block';
        bannerText.textContent = 'Cart has items — ready to check out.';
      }

      let subtotal = 0;

      cart.forEach((it, i)=>{
        subtotal += lineAmount(it);

        const per = it.perYd ? ('$' + Number(it.perYd).toFixed(2) + '/yd') : '';
        const yardsLabel = (it.yards !== undefined && it.yards !== null && it.yards !== '')
          ? (per ? ' · ' : '') + Number(it.yards) + ' yd'
          : '';

        const row = document.createElement('div');
        row.className = 'item';
        row.dataset.index = i;

        row.innerHTML =
          '<div class="thumb">' +
            (it.photo ? '<img alt="" src="'+it.photo+'">' : '<span>—</span>') +
          '</div>' +
          '<div>' +
            '<div class="t1">'+(it.name ||
                      '<div class="t1">'+(it.name || 'Fabric')+'</div>' +
            '<div class="t2">'+(per + yardsLabel)+'</div>' +
            '<div style="margin-top:8px;display:flex;gap:10px;align-items:center">' +
              '<div class="qty">' +
                '<button type="button" data-act="dec">−</button>' +
                '<input type="text" value="'+(it.qty || 1)+'" inputmode="numeric" aria-label="Quantity">' +
                '<button type="button" data-act="inc">+</button>' +
              '</div>' +
              '<a href="#" class="link" data-act="rm">Remove</a>' +
            '</div>' +
          '</div>' +
          '<div class="price">'+fmt(lineAmount(it))+'</div>';

        itemsEl.appendChild(row);
      });

      const ship = calcShipping(cart);
      subEl.textContent  = fmt(subtotal);
      shipEl.textContent = fmt(ship.total_cents);
      shipLinesEl.innerHTML = ship.lines
        .map(l => `${l.sellerName}: ${l.yards.toFixed(2)} yd → ${fmt(l.fee_cents)}`)
        .join('<br>');
      totEl.textContent = fmt(subtotal + ship.total_cents);
    }

    // quantity / remove interactions
    itemsEl.addEventListener('click', e=>{
      const act = e.target.dataset.act;
      if(!act) return;
      e.preventDefault();

      const row = e.target.closest('.item');
      if(!row) return;
      const idx  = Number(row.dataset.index);
      const cart = read();
      const it   = cart[idx];
      if(!it) return;

      if(act === 'inc'){
        it.qty = (it.qty || 1) + 1;
      }else if(act === 'dec'){
        it.qty = Math.max(1, (it.qty || 1) - 1);
      }else if(act === 'rm'){
        cart.splice(idx, 1);
      }

      write(cart);
      render();
    });

    itemsEl.addEventListener('input', e=>{
      if(e.target.tagName !== 'INPUT') return;
      const row = e.target.closest('.item');
      if(!row) return;
      const idx  = Number(row.dataset.index);
      const cart = read();
      const it   = cart[idx];
      if(!it) return;

      let v = parseInt(e.target.value || '1', 10);
      if(isNaN(v) || v < 1) v = 1;
      it.qty = v;
      write(cart);
      render();
    });

    document.getElementById('clearCart').addEventListener('click', e=>{
      e.preventDefault();
      write([]);
      render();
    });

    document.getElementById('checkout').addEventListener('click', ()=>{
      // Placeholder: later this can route to a real checkout flow
      window.location.href = 'checkout.html';
    });

    render();
  })();
</script>
</body>
</html>
