<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Hemline — Cart</title>
  <style>
    :root { --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#fafafa; --card:#ffffff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px;font-weight:700}
    .btn{display:inline-block;padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;margin-left:8px}
    .wrap{max-width:1100px;margin:16px auto;padding:0 16px}
    #status{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;margin-bottom:12px}

    .grid{display:grid;gap:12px}
    .card{display:grid;grid-template-columns:100px 1fr auto;gap:12px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:16px;overflow:hidden;padding:12px}
    @media (max-width:560px){ .card{grid-template-columns:80px 1fr} .remove{grid-column:1 / -1; justify-self:end} }
    .thumb{width:100%;height:120px;background:#f3f4f6;border-radius:12px;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .meta{display:grid;gap:6px}
    .title{font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .price{font-weight:700}
    .qtybar{display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .qtybtn{width:38px;height:36px;border:0;background:#fff;cursor:pointer;font-size:18px;line-height:0}
    .qtyval{min-width:40px;text-align:center}
    .remove{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    .total{margin-top:20px;padding:16px;border:1px solid var(--line);border-radius:16px;background:#fff;font-weight:700;display:flex;justify-content:space-between}
  </style>

  <!-- Env + loaders -->
  <script src="/env.js"></script>
  <script>
    (function loadSupabase(){
      function add(src, cb){const s=document.createElement('script');s.src=src;s.onload=cb;s.onerror=cb;document.head.appendChild(s);}
      add("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js", function(){
        if (!window.supabase) add("https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js", function(){});
      });
    })();
  </script>
  <script src="/app.js"></script>
</head>
<body>
  <header>
    Hemline
    <a class="btn" href="/listings.html">Listings</a>
    <a class="btn" href="/favorites.html">Favorites</a>
    <a class="btn" href="/cart.html">Cart</a>
  </header>

  <div class="wrap">
    <div id="status">Loading cart…</div>
    <div id="grid" class="grid"></div>
    <div id="total" class="total" hidden>
      <span>Total</span><span id="sum"></span>
    </div>
  </div>

  <script>
    (async () => {
      const s=document.getElementById('status');
      const grid=document.getElementById('grid');
      const totalBox=document.getElementById('total');
      const sumEl=document.getElementById('sum');

      // Wait for Supabase
      let tries=0; while(!window.supabase && tries<40){ await new Promise(r=>setTimeout(r,100)); tries++; }
      if (!window.supabase) return s.textContent='Error loading Supabase.';
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) return s.textContent='Missing env.';
      const sb=window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

      // Require login
      const { data: sess } = await sb.auth.getSession();
      const uid = sess?.session?.user?.id || null;
      if (!uid){ s.textContent='Please sign in to view your cart.'; hm.toast('Sign in to view cart.'); return; }

      async function fetchCart() {
        const cart = hm.guard(await sb.from('cart_items')
          .select('id,listing_id,qty,created_at')
          .eq('user_id',uid).order('created_at',{ascending:false}), 'Couldn’t load cart.');
        if (!cart.data?.length){ s.textContent='Cart is empty.'; totalBox.hidden=true; grid.innerHTML=''; s.hidden=false; return { rows:[], byId:new Map() }; }

        const ids=cart.data.map(r=>r.listing_id);
        const items = hm.guard(await sb.from('listings')
          .select('id,title,price_cents,cover_url')
          .in('id',ids), 'Couldn’t load items.');
        const byId=new Map(items.data.map(r=>[r.id,r]));
        s.hidden=true; return { rows:cart.data, byId };
      }

      function render({ rows, byId }) {
        let total=0;
        grid.innerHTML=rows.map(row=>{
          const item=byId.get(row.listing_id)||{};
          const price=item.price_cents||0; total+=price*row.qty;
          const img=item.cover_url?`<img src="${item.cover_url}" alt="">`:'';
          return `
            <div class="card" data-id="${row.id}" data-price="${price}" data-qty="${row.qty}">
              <div class="thumb">${img}</div>
              <div class="meta">
                <div class="title">${item.title||'Untitled'}</div>
                <div class="muted">Item price: ${price?('$'+(price/100).toFixed(2)):'—'}</div>
                <div class="qtybar" role="group" aria-label="Quantity">
                  <button type="button" class="qtybtn dec" aria-label="Decrease">−</button>
                  <div class="qtyval" aria-live="polite">${row.qty}</div>
                  <button type="button" class="qtybtn inc" aria-label="Increase">+</button>
                </div>
              </div>
              <button type="button" class="remove">Remove</button>
            </div>`;
        }).join('');
        sumEl.textContent='$'+(total/100).toFixed(2);
        totalBox.hidden=false;
      }

      function recalcTotal() {
        let sum=0;
        grid.querySelectorAll('.card').forEach(card=>{
          const price=Number(card.dataset.price||0);
          const qty=Number(card.dataset.qty||1);
          sum+=price*qty;
        });
        sumEl.textContent='$'+(sum/100).toFixed(2);
        if (!grid.children.length) { totalBox.hidden=true; s.hidden=false; s.textContent='Cart is empty.'; }
      }

      // Initial load
      const first = await fetchCart(); render(first);

      // Interactions
      grid.addEventListener('click', async (e)=>{
        const card = e.target.closest('.card'); if(!card) return;
        const id = card.dataset.id;

        // Remove
        if (e.target.closest('.remove')) {
          try {
            hm.guard(await sb.from('cart_items').delete().eq('id',id).eq('user_id',uid),'Couldn’t remove item.');
            card.remove(); recalcTotal(); hm.toast('Removed from cart.');
          } catch (err) { hm.toast(hm.normalizeSupabaseError(err)); }
          return;
        }

        // Quantity change
        const inc = e.target.closest('.inc');
        const dec = e.target.closest('.dec');
        if (!inc && !dec) return;

        const curQty = Number(card.dataset.qty||1);
        let nextQty = inc ? curQty + 1 : Math.max(0, curQty - 1);

        try {
          if (nextQty === 0) {
            // delete row
            hm.guard(await sb.from('cart_items').delete().eq('id',id).eq('user_id',uid),'Couldn’t update cart.');
            card.remove(); hm.toast('Removed from cart.');
          } else {
            // update qty
            hm.guard(await sb.from('cart_items').update({ qty: nextQty }).eq('id',id).eq('user_id',uid),'Couldn’t update cart.');
            card.dataset.qty = String(nextQty);
            card.querySelector('.qtyval').textContent = nextQty;
            hm.toast('Updated quantity.');
          }
          recalcTotal();
        } catch (err) {
          hm.toast(hm.normalizeSupabaseError(err));
        }
      });
    })();
  </script>

  <!-- Optional: header auth + cart badge if present site-wide -->
  <script src="/auth.js"></script>
</body>
</html>
