<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Cart — Hemline Market</title>

  <!-- Shared CSS stack (universal) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#991b1b;
      --bg:#f4f4f7;
      --ok:#065f46;
      --okbg:#ecfdf5;
      --okbd:#a7f3d0;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:
        url("images/homepage.jpeg") center/cover fixed no-repeat,
        var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* PAGE LAYOUT */
    .cart-wrap{
      max-width:1100px;
      margin:16px auto 28px;
      padding:0 12px;
    }
    .breadcrumb{
      color:#6b7280;
      font-size:14px;
      margin:6px 0 10px;
    }
    .breadcrumb b{color:#111827;}
    h1{margin:0 0 4px;}
    .cart-subtitle{
      color:#6b7280;
      font-size:14px;
      margin:0 0 16px;
    }

    /* Status banner */
    .banner{
      margin:10px 0 16px;
      padding:14px 16px;
      border-radius:12px;
      border:1px solid var(--okbd);
      background:var(--okbg);
      color:var(--ok);
      display:flex;
      align-items:flex-start;
      gap:10px;
      font-size:14px;
      line-height:1.4;
      box-shadow:0 8px 16px rgba(0,0,0,0.03);
    }
    .banner svg{width:20px;height:20px;flex-shrink:0;}
    .banner-title{font-weight:700;margin-bottom:2px;}

    /* GRID + CARDS */
    .grid{
      display:grid;
      grid-template-columns:1fr 340px;
      gap:14px;
      align-items:start;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;}
    }
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      margin-bottom:14px;
    }
    .card:last-child{margin-bottom:0;}

    /* SELLER GROUP CARD */
    .seller-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      margin-bottom:14px;
      overflow:hidden;
    }
    .seller-header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid #f3f4f6;
      background:#fafafa;
    }
    .seller-avatar{
      width:40px;
      height:40px;
      border-radius:50%;
      background:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      font-weight:700;
      color:#6b7280;
      overflow:hidden;
      flex-shrink:0;
    }
    .seller-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .seller-info{flex:1;min-width:0;}
    .seller-name{
      font-weight:700;
      font-size:15px;
      color:#111827;
      text-decoration:none;
      display:block;
    }
    .seller-name:hover{color:var(--accent);text-decoration:underline;}
    .seller-meta{
      font-size:12px;
      color:#6b7280;
      margin-top:2px;
    }
    .seller-items{padding:0 16px;}

    /* ITEM ROW */
    .item{
      display:grid;
      grid-template-columns:72px 1fr auto;
      gap:12px;
      align-items:center;
      padding:14px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .item:last-child{border-bottom:0;}
    .thumb{
      width:72px;
      height:72px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#f8fafc;
      display:grid;
      place-items:center;
      color:#9ca3af;
      overflow:hidden;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .t1{font-weight:700;font-size:14px;}
    .t1 a{color:inherit;text-decoration:none;}
    .t1 a:hover{color:var(--accent);text-decoration:underline;}
    .t2{
      color:#6b7280;
      font-size:13px;
      margin-top:2px;
    }
    .item-actions{
      margin-top:8px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .price{
      font-weight:700;
      font-size:15px;
      min-width:80px;
      text-align:right;
    }

    /* SELLER FOOTER */
    .seller-footer{
      padding:14px 16px;
      background:#fafafa;
      border-top:1px solid #f3f4f6;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
    }
    .seller-shipping{
      font-size:13px;
      color:#6b7280;
    }
    .seller-shipping strong{color:#111827;}
    .seller-subtotal{
      font-size:14px;
      color:#111827;
    }
    .seller-subtotal strong{font-weight:700;}
    .checkout-seller-btn{
      background:#fff;
      border:1px solid var(--accent);
      color:var(--accent);
      padding:8px 16px;
      border-radius:999px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      transition:all 0.15s ease;
    }
    .checkout-seller-btn:hover{
      background:var(--accent);
      color:#fff;
    }
    .checkout-seller-btn svg{width:14px;height:14px;}

    /* SUMMARY SIDEBAR */
    .summary-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      position:sticky;
      top:20px;
    }
    .summary-card .hd{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      font-weight:800;
    }
    .summary-card .bd{padding:16px;}
    .sum .row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      padding:10px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .sum .row:last-child{border-bottom:0;}
    .sum .row.total{
      font-weight:800;
      font-size:16px;
      padding-top:14px;
      border-top:2px solid #e5e7eb;
      margin-top:4px;
    }
    .muted{color:#6b7280;}
    .ship-breakdown{
      font-size:12px;
      color:#6b7280;
      text-align:right;
      line-height:1.5;
    }

    /* BUTTONS */
    .link{
      color:#991b1b;
      text-decoration:none;
      font-size:13px;
    }
    .link:hover{text-decoration:underline;}
    .hm-btn-primary{
      width:100%;
      margin-top:14px;
      padding:14px 20px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:10px;
      font-size:15px;
      font-weight:700;
      cursor:pointer;
      transition:background 0.15s ease;
    }
    .hm-btn-primary:hover{background:#7f1d1d;}
    .hm-btn-primary:disabled{
      background:#d1d5db;
      cursor:not-allowed;
    }

    /* EMPTY STATE */
    .empty-cart{
      padding:48px 24px;
      text-align:center;
    }
    .empty-cart svg{
      width:64px;
      height:64px;
      color:#d1d5db;
      margin-bottom:16px;
    }
    .empty-cart h2{
      font-size:18px;
      font-weight:700;
      margin:0 0 8px;
      color:#111827;
    }
    .empty-cart p{
      color:#6b7280;
      margin:0 0 20px;
      font-size:14px;
    }
    .empty-cart .hm-btn-primary{
      display:inline-block;
      width:auto;
      padding:12px 24px;
      margin:0;
    }

    /* Cart actions row */
    .cart-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 0;
      margin-top:8px;
    }

    /* Sign in prompt */
    .signin-card{
      padding:32px;
      text-align:center;
    }
    .signin-card p{
      margin:0 0 16px;
      color:#6b7280;
    }
    .signin-card a{
      color:var(--accent);
      font-weight:600;
      text-decoration:none;
    }
    .signin-card a:hover{text-decoration:underline;}

    @media(max-width:768px){
      body{background-position:20% center;}
      .seller-footer{flex-direction:column;align-items:stretch;text-align:center;}
      .checkout-seller-btn{justify-content:center;}
    }
  </style>
  <!-- Vercel Web Analytics -->
  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>

  <!-- Universal header placeholder -->
  <div id="hm-shell-header"></div>

  <main class="cart-wrap" id="maincontent">
    <div class="breadcrumb"><b>Cart</b> › Checkout › Payment</div>
    <h1>Your Cart</h1>
    <p class="cart-subtitle" id="cartSubtitle"></p>

    <!-- Sign-in prompt for logged-out users -->
    <div id="signInPrompt" class="card signin-card" style="display:none;">
      <p>Sign in to view and manage your cart</p>
      <a href="auth.html?view=login">Sign in to your account →</a>
    </div>

    <!-- Status banner -->
    <div id="cartBanner" class="banner" role="status" aria-live="polite" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M12 8v4m0 4h.01"></path>
      </svg>
      <div>
        <div id="cartBannerTitle" class="banner-title"></div>
        <div id="cartBannerText"></div>
      </div>
    </div>

    <!-- Empty state -->
    <div id="emptyState" class="card empty-cart" style="display:none;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="9" cy="21" r="1"></circle>
        <circle cx="20" cy="21" r="1"></circle>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
      </svg>
      <h2>Your cart is empty</h2>
      <p>Browse Hemline Market to find beautiful fabrics from fellow sewists.</p>
      <a href="browse.html" class="hm-btn-primary">Start shopping</a>
    </div>

    <!-- Main cart grid -->
    <div class="grid" id="cartGrid" style="display:none;">
      <!-- Seller groups (left column) -->
      <div id="sellerGroups"></div>

      <!-- Summary sidebar (right column) -->
      <aside class="summary-card sum">
        <div class="hd">Order Summary</div>
        <div class="bd">
          <div class="row">
            <span>Items (<span id="itemCount">0</span>)</span>
            <strong id="sub">$0.00</strong>
          </div>
          <div class="row">
            <span>Shipping (<span id="packageCount">0</span> package<span id="packagePlural">s</span>)</span>
            <div style="text-align:right">
              <div id="ship">$0.00</div>
              <div id="shipBreakdown" class="ship-breakdown"></div>
            </div>
          </div>
          <div class="row">
            <span>Tax</span>
            <span class="muted">Calculated at checkout</span>
          </div>
          <div class="row total">
            <span>Total</span>
            <span id="tot">$0.00</span>
          </div>
          <button id="checkoutAll" class="hm-btn-primary">Checkout All Sellers</button>
        </div>
      </aside>
    </div>

    <!-- Cart actions -->
    <div class="cart-actions" id="cartActions" style="display:none;">
      <a class="link" href="browse.html">← Continue shopping</a>
      <a class="link" id="clearCart" href="#">Clear entire cart</a>
    </div>
  </main>

  <!-- Universal footer placeholder -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Universal shell JS -->
  <script src="scripts/hm-shell.js"></script>

  <!-- CART LOGIC -->
  <script>
  (function(){
    const LS      = 'hm_cart';
    const SHIP_LS = 'hm_cart_shipping';

    // DOM elements
    const cartGrid       = document.getElementById('cartGrid');
    const sellerGroupsEl = document.getElementById('sellerGroups');
    const emptyState     = document.getElementById('emptyState');
    const cartActions    = document.getElementById('cartActions');
    const cartSubtitle   = document.getElementById('cartSubtitle');
    const itemCountEl    = document.getElementById('itemCount');
    const packageCountEl = document.getElementById('packageCount');
    const packagePluralEl= document.getElementById('packagePlural');
    const subEl          = document.getElementById('sub');
    const shipEl         = document.getElementById('ship');
    const shipBreakdownEl= document.getElementById('shipBreakdown');
    const totEl          = document.getElementById('tot');
    const checkoutAllBtn = document.getElementById('checkoutAll');
    const banner         = document.getElementById('cartBanner');
    const bannerTitleEl  = document.getElementById('cartBannerTitle');
    const bannerTextEl   = document.getElementById('cartBannerText');

    const fmt = c => '$' + (Math.max(0, c) / 100).toFixed(2);

    // XSS protection
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Remove cart hold from database
    async function removeHold(listingId) {
      if (!listingId) return;
      try {
        const userId = window.HM?.supabase?.auth?.getUser?.()?.then(r => r.data?.user?.id) || null;
        await fetch("/api/cart/hold", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ listing_id: listingId, user_id: await userId })
        });
      } catch(e) {
        console.error("[cart] removeHold failed:", e);
      }
    }

    const read = () => {
      try{
        const data = JSON.parse(localStorage.getItem(LS) || '[]');
        return Array.isArray(data) ? data : [];
      }catch(_){
        return [];
      }
    };

    const write = list => {
      localStorage.setItem(LS, JSON.stringify(list || []));
      if(window.HM_CART_BADGE_UPDATE){
        try{ window.HM_CART_BADGE_UPDATE(list || []); }catch(_){}
      }
    };

    function itemYardsTotal(it){
      if(it.yards !== undefined && it.yards !== null && it.yards !== ''){
        return Number(it.yards) || 0;
      }
      return 1;
    }

    const lineAmount = it => {
      const explicit = Number(it.price_total || 0);
      if (explicit > 0) return explicit;
      const base  = Number(it.amount || 0);
      const yards = itemYardsTotal(it);
      if (yards > 0) return base * yards;
      return base;
    };

    // Shipping tiers in cents based on total yards per seller
    const tierCents = yards => (yards < 3 ? 500 : (yards <= 10 ? 800 : 1500));

    // Group cart items by seller
    function groupBySeller(cart) {
      const groups = {};
      cart.forEach((item, idx) => {
        const sellerId = item.sellerId || item.seller_id || 'unknown';
        const sellerName = item.sellerName || item.seller_name || 'Hemline Seller';
        if (!groups[sellerId]) {
          groups[sellerId] = {
            sellerId,
            sellerName,
            items: [],
            totalYards: 0,
            subtotalCents: 0
          };
        }
        groups[sellerId].items.push({ ...item, _cartIndex: idx });
        groups[sellerId].totalYards += itemYardsTotal(item);
        groups[sellerId].subtotalCents += lineAmount(item);
      });
      return Object.values(groups);
    }

    function calcShipping(cart){
      const groups = groupBySeller(cart);
      const lines = groups.map(g => ({
        sellerId: g.sellerId,
        sellerName: g.sellerName,
        yards: g.totalYards,
        fee_cents: tierCents(g.totalYards)
      }));
      const total_cents = lines.reduce((sum, l) => sum + l.fee_cents, 0);
      localStorage.setItem(SHIP_LS, JSON.stringify({ lines, total_cents }));
      return { lines, total_cents };
    }

    function getSellerInitial(name) {
      if (!name) return '?';
      return name.charAt(0).toUpperCase();
    }

    function renderSellerCard(group, shippingCents) {
      const card = document.createElement('div');
      card.className = 'seller-card';
      
      // Header
      const header = document.createElement('div');
      header.className = 'seller-header';
      header.innerHTML = `
        <div class="seller-avatar">${getSellerInitial(group.sellerName)}</div>
        <div class="seller-info">
          <a href="seller/index.html?id=${encodeURIComponent(group.sellerId)}" class="seller-name">${escapeHtml(group.sellerName)}</a>
        </div>
      `;
      card.appendChild(header);

      // Items
      const itemsContainer = document.createElement('div');
      itemsContainer.className = 'seller-items';
      
      group.items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'item';
        itemEl.dataset.index = item._cartIndex;

        const lineCents = lineAmount(item);
        const perYd = item.perYd ? ('$' + Number(item.perYd).toFixed(2) + '/yd') : '';
        const yardsLabel = item.yards ? (perYd ? ' · ' : '') + Number(item.yards) + ' yd' : '';
        
        const listingId = item.listing_id || item.id;
        const listingUrl = listingId ? ('fabric/' + encodeURIComponent(listingId)) : '#';
        const canLink = !!listingId;

        itemEl.innerHTML = `
          <div class="thumb">
            ${canLink ? `<a href="${listingUrl}" style="display:block;width:100%;height:100%">` : ''}
            ${item.photo ? `<img alt="" src="${escapeHtml(item.photo)}" onerror="this.style.display='none'">` : '<span>—</span>'}
            ${canLink ? '</a>' : ''}
          </div>
          <div>
            <div class="t1">
              ${canLink ? `<a href="${listingUrl}">${escapeHtml(item.name || 'Fabric')}</a>` : escapeHtml(item.name || 'Fabric')}
            </div>
            <div class="t2">${perYd}${yardsLabel}</div>
            <div class="item-actions">
              <span class="t2">One cut per listing</span>
              <a href="#" class="link" data-act="rm" data-index="${item._cartIndex}">Remove</a>
            </div>
          </div>
          <div class="price">${fmt(lineCents)}</div>
        `;
        itemsContainer.appendChild(itemEl);
      });
      card.appendChild(itemsContainer);

      // Footer with shipping, subtotal, and checkout button
      const footer = document.createElement('div');
      footer.className = 'seller-footer';
      
      const sellerTotal = group.subtotalCents + shippingCents;
      
      footer.innerHTML = `
        <div>
          <div class="seller-shipping">Shipping: <strong>${fmt(shippingCents)}</strong> (${group.totalYards.toFixed(1)} yards)</div>
          <div class="seller-subtotal">Subtotal: <strong>${fmt(sellerTotal)}</strong></div>
        </div>
        <button class="checkout-seller-btn" data-seller-id="${escapeHtml(group.sellerId)}">
          Checkout ${escapeHtml(group.sellerName)} only
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </button>
      `;
      card.appendChild(footer);

      return card;
    }

    function updateBanner(cart){
      if(!banner) return;
      if(!cart || cart.length === 0){
        banner.style.display = 'none';
      }else{
        banner.style.display = 'none'; // Hide banner when items exist - the UI is clear enough
      }
    }

    function render(){
      const cart = read();
      sellerGroupsEl.innerHTML = '';

      if(cart.length === 0){
        cartGrid.style.display = 'none';
        cartActions.style.display = 'none';
        emptyState.style.display = 'block';
        cartSubtitle.textContent = '';
        checkoutAllBtn.disabled = true;
        updateBanner(cart);
        return;
      }

      emptyState.style.display = 'none';
      cartGrid.style.display = 'grid';
      cartActions.style.display = 'flex';
      checkoutAllBtn.disabled = false;
      updateBanner(cart);

      const groups = groupBySeller(cart);
      const shipping = calcShipping(cart);
      
      // Update subtitle
      const sellerCount = groups.length;
      const itemCount = cart.length;
      cartSubtitle.textContent = `${sellerCount} seller${sellerCount !== 1 ? 's' : ''}, ${itemCount} item${itemCount !== 1 ? 's' : ''}`;

      // Calculate totals
      let subtotalCents = 0;
      cart.forEach(item => {
        subtotalCents += lineAmount(item);
      });

      // Render seller cards
      groups.forEach(group => {
        const shippingLine = shipping.lines.find(l => l.sellerId === group.sellerId);
        const shippingCents = shippingLine ? shippingLine.fee_cents : 0;
        const card = renderSellerCard(group, shippingCents);
        sellerGroupsEl.appendChild(card);
      });

      // Update summary
      itemCountEl.textContent = itemCount;
      packageCountEl.textContent = sellerCount;
      packagePluralEl.textContent = sellerCount !== 1 ? 's' : '';
      subEl.textContent = fmt(subtotalCents);
      shipEl.textContent = fmt(shipping.total_cents);
      
      // Shipping breakdown
      shipBreakdownEl.innerHTML = shipping.lines
        .map(l => `${escapeHtml(l.sellerName)}: ${fmt(l.fee_cents)}`)
        .join('<br>');
      
      totEl.textContent = fmt(subtotalCents + shipping.total_cents);

      // Update checkout all button text
      if (sellerCount > 1) {
        checkoutAllBtn.textContent = `Checkout All ${sellerCount} Sellers`;
      } else {
        checkoutAllBtn.textContent = 'Proceed to Checkout';
      }
    }

    // Remove SOLD/unpublished listings from cart
    async function cleanSoldFromCart(){
      const hm = window.HM;
      const supabase = hm && hm.supabase;
      if(!supabase) return;

      const cart = read();
      if(!cart || !cart.length) return;

      const listingIds = Array.from(new Set(
        cart.map(it => it.listing_id || it.id).filter(Boolean)
      ));
      if(!listingIds.length) return;

      const { data, error } = await supabase
        .from('listings')
        .select('id, status, is_published')
        .in('id', listingIds);

      if(error || !data) return;

      const unavailableIds = new Set(
        data
          .filter(row => 
            (row.status || '').toUpperCase() === 'SOLD' || 
            row.is_published === false
          )
          .map(row => row.id)
      );
      if(!unavailableIds.size) return;

      const filtered = cart.filter(it => !unavailableIds.has(it.listing_id || it.id));
      if(filtered.length !== cart.length){
        write(filtered);
      }
    }

    // Event delegation for remove buttons
    sellerGroupsEl.addEventListener('click', e => {
      if (e.target.dataset.act === 'rm') {
        e.preventDefault();
        const idx = Number(e.target.dataset.index);
        const cart = read();
        if (idx >= 0 && idx < cart.length) {
          const removedItem = cart[idx];
          const listingId = removedItem?.id || removedItem?.listing_id;
          cart.splice(idx, 1);
          write(cart);
          render();
          if (listingId) removeHold(listingId);
        }
      }
    });

    // Checkout single seller button
    sellerGroupsEl.addEventListener('click', e => {
      const btn = e.target.closest('.checkout-seller-btn');
      if (btn) {
        const sellerId = btn.dataset.sellerId;
        // Store which seller to checkout
        sessionStorage.setItem('hm_checkout_seller', sellerId);
        window.location.href = 'checkout.html?seller=' + encodeURIComponent(sellerId);
      }
    });

    // Clear cart
    document.getElementById('clearCart').addEventListener('click', e => {
      e.preventDefault();
      if (!confirm('Remove all items from your cart?')) return;
      const cart = read();
      cart.forEach(item => {
        const listingId = item?.id || item?.listing_id;
        if (listingId) removeHold(listingId);
      });
      write([]);
      render();
    });

    // Checkout all
    checkoutAllBtn.addEventListener('click', () => {
      sessionStorage.removeItem('hm_checkout_seller'); // Clear single-seller flag
      window.location.href = 'checkout.html';
    });

    // Wait for HM.supabase
    async function ensureSession(maxWaitMs = 3000) {
      const start = Date.now();
      while (!window.HM?.supabase && (Date.now() - start < maxWaitMs)) {
        await new Promise(r => setTimeout(r, 100));
      }
      const supabase = window.HM?.supabase;
      if (!supabase) return null;
      
      let { data: { session } } = await supabase.auth.getSession();
      if (session) return session;
      
      while (!session && (Date.now() - start < maxWaitMs)) {
        await new Promise(r => setTimeout(r, 200));
        ({ data: { session } } = await supabase.auth.getSession());
      }
      return session;
    }

    // Init
    (async function init(){
      const session = await ensureSession();
      const isSignedIn = !!session?.user;
      
      const signInPrompt = document.getElementById('signInPrompt');
      
      if (!isSignedIn) {
        if (signInPrompt) signInPrompt.style.display = 'block';
        cartGrid.style.display = 'none';
        cartActions.style.display = 'none';
        emptyState.style.display = 'none';
        banner.style.display = 'none';
        return;
      }
      
      if (signInPrompt) signInPrompt.style.display = 'none';
      
      try{
        await cleanSoldFromCart();
      }catch(_){}
      render();
    })();
  })();
  </script>

  <!-- Render universal shell -->
  <script>
    window.HM && window.HM.renderShell({ currentPage: "cart" });
  </script>
</body>
</html>
