<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Checkout — Hemline Market</title>

  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">

  <!-- Shared styles (universal header/footer stack) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --checkout-bg:#f4f4f7;
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
    }
    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:var(--checkout-bg);
      -webkit-font-smoothing:antialiased;
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }

    main.checkout-wrap{
      max-width:1100px;
      margin:18px auto 32px;
      padding:0 12px 32px;
    }

    .checkout-grid{
      display:grid;
      grid-template-columns:minmax(0,1.6fr) minmax(0,1fr);
      gap:18px;
      align-items:flex-start;
    }
    @media (max-width:960px){
      .checkout-grid{ grid-template-columns:minmax(0,1fr); }
    }

    .checkout-card{
      background:#fff;
      border-radius:14px;
      border:1px solid var(--hm-border);
      box-shadow:0 8px 24px rgba(15,23,42,.04);
      padding:16px 18px 18px;
    }

    .checkout-card h1{
      margin:0 0 10px;
      font-size:22px;
      font-weight:800;
    }
    .checkout-card h2{
      margin:6px 0 10px;
      font-size:16px;
      font-weight:700;
    }

    .checkout-banner{
      margin:0 0 12px;
      padding:9px 11px;
      border-radius:10px;
      font-size:13px;
    }
    .checkout-banner.ok{
      background:#ecfdf5;
      border:1px solid #bbf7d0;
      color:#065f46;
    }
    .checkout-banner.err{
      background:#fff7ed;
      border:1px solid #fed7aa;
      color:#9a3412;
    }

    label.checkout-label{
      display:block;
      margin:6px 0 4px;
      font-size:13px;
      font-weight:600;
      color:#374151;
    }
    .checkout-input{
      height:40px;
      border-radius:10px;
      border:1px solid var(--hm-border);
      padding:0 12px;
      width:100%;
      font-size:14px;
      background:#fff;
    }

    .checkout-row{
      display:flex;
      gap:10px;
    }
    .checkout-row > *{ flex:1; min-width:0; }

    .checkout-help{
      margin-top:8px;
      font-size:12px;
      color:#6b7280;
    }

    /* Address block (match Account feel) */
    .addr-shell{
      border:1px solid var(--hm-border);
      border-radius:12px;
      padding:12px;
      background:#fff;
      margin-top:10px;
    }
    .addr-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:6px;
    }
    .addr-kicker{
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#6b7280;
      font-weight:700;
      margin:0 0 4px;
    }
    .addr-desc{
      margin:0;
      font-size:12px;
      color:#6b7280;
      line-height:1.35;
    }
    .addr-lines{
      margin-top:10px;
      font-size:13px;
      white-space:pre-line;
      color:#111827;
    }
    .addr-empty{
      color:#6b7280;
    }
    .addr-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-shrink:0;
    }

    /* Legal block */
    .checkout-legal{
      margin:18px 0 0;
      padding:12px 12px 10px;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid var(--hm-border);
    }
    .checkout-legal-heading{
      margin:0 0 6px;
      font-size:13px;
      color:#4b5563;
    }
    .checkout-legal-label{
      display:flex;
      align-items:flex-start;
      gap:8px;
      font-size:13px;
      line-height:1.4;
      color:#111827;
    }
    .checkout-legal-label input[type="checkbox"]{
      margin-top:2px;
      width:16px;
      height:16px;
      flex-shrink:0;
    }
    .checkout-legal-label a{ color:var(--hm-accent); }

    .checkout-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:40px;
      padding:0 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:700;
      border:1px solid transparent;
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn-primary{
      background:var(--hm-accent);
      border-color:var(--hm-accent);
      color:#fff;
      box-shadow:0 2px 10px rgba(153,27,27,.25);
    }
    .btn-outline{
      background:#fff;
      border-color:var(--hm-border);
      color:var(--hm-accent);
    }
    .btn-soft{
      background:#fff;
      border-color:var(--hm-border);
      color:#374151;
      font-weight:700;
    }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    /* Summary */
    .summary-title{
      margin:0 0 10px;
      font-size:16px;
      font-weight:700;
    }
    .summary-items{ font-size:14px; }
    .summary-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:6px 0;
    }
    .summary-item-name{
      color:#111827;
      max-width:70%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .summary-item-amt{ font-weight:600; color:#111827; }
    .summary-line{
      height:1px;
      background:var(--hm-border);
      margin:12px 0;
    }
    .summary-row{
      display:flex;
      justify-content:space-between;
      font-size:14px;
      margin:3px 0;
    }
    .summary-row.muted span:last-child{
      color:#6b7280;
      font-size:13px;
    }
    .summary-row.total{
      margin-top:6px;
      font-weight:800;
      font-size:16px;
    }
  </style>
</head>
<body>

<div id="hm-shell-header"></div>

<main class="checkout-wrap" id="maincontent">
  <div class="checkout-grid">
    <!-- LEFT: Contact + shipping -->
    <section class="checkout-card" aria-label="Checkout details">
      <h1>Checkout</h1>
      <div id="banner" class="checkout-banner ok" role="status" aria-live="polite" style="display:none"></div>

      <h2>Contact &amp; Shipping</h2>

      <div class="checkout-row">
        <div>
          <label class="checkout-label" for="email">Email</label>
          <input id="email" class="checkout-input" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email">
        </div>
        <div>
          <label class="checkout-label" for="phone">Phone (optional)</label>
          <input id="phone" class="checkout-input" type="tel" placeholder="(555) 555-5555" autocomplete="tel">
        </div>
      </div>

      <!-- Shipping address block -->
      <div class="addr-shell" aria-label="Shipping address">
        <div class="addr-top">
          <div>
            <div class="addr-kicker">Shipping address</div>
            <p class="addr-desc">
              This address prints on prepaid labels for your fabric sales and purchases.
            </p>
          </div>
          <div class="addr-actions">
            <button class="btn btn-soft" type="button" id="btnEditAddr">Edit address</button>
            <button class="btn btn-soft" type="button" id="btnDoneAddr" style="display:none">Done</button>
          </div>
        </div>

        <div id="addrSummary" class="addr-lines addr-empty">No address on file yet. Click <strong>Edit address</strong> to add one.</div>

        <div id="addrFormWrap" style="display:none; margin-top:10px;">
          <div class="checkout-row">
            <div>
              <label class="checkout-label" for="addr1">Address line 1</label>
              <input id="addr1" class="checkout-input" placeholder="Street address" autocomplete="address-line1">
            </div>
          </div>

          <div class="checkout-row" style="margin-top:10px">
            <div>
              <label class="checkout-label" for="addr2">Address line 2 (optional)</label>
              <input id="addr2" class="checkout-input" placeholder="Apt, suite, etc." autocomplete="address-line2">
            </div>
          </div>

          <div class="checkout-row" style="margin-top:10px">
            <div>
              <label class="checkout-label" for="city">City</label>
              <input id="city" class="checkout-input" placeholder="City" autocomplete="address-level2">
            </div>
            <div>
              <label class="checkout-label" for="state">State</label>
              <input id="state" class="checkout-input" placeholder="State" autocomplete="address-level1">
            </div>
            <div>
              <label class="checkout-label" for="zip">ZIP</label>
              <input id="zip" class="checkout-input" placeholder="ZIP" autocomplete="postal-code" inputmode="numeric">
            </div>
          </div>

          <div class="checkout-help" style="margin-top:10px;">
            You can edit the address here, then continue to payment.
          </div>
        </div>
      </div>

      <p class="checkout-help">
        Shipping label is generated after payment. You’ll confirm card details on the next step.
      </p>

      <!-- Legal acknowledgment -->
      <div class="checkout-legal">
        <p class="checkout-legal-heading">Before you continue, please confirm the following:</p>
        <label class="checkout-legal-label">
          <input id="agreeCheckout" type="checkbox">
          <span>
            I understand that Hemline Market connects buyers and independent sellers, and I agree to
            Hemline Market’s
            <a href="terms.html" target="_blank" rel="noopener">Terms of Service</a>
            and
            <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.
          </span>
        </label>
      </div>

      <div class="checkout-actions">
        <a class="btn btn-outline" href="cart.html">Back to cart</a>
        <button id="next" class="btn btn-primary" type="button">Continue to payment</button>
      </div>
    </section>

    <!-- RIGHT: Summary -->
    <aside class="checkout-card" aria-label="Order summary">
      <h2 class="summary-title">Order summary</h2>
      <div id="order-items" class="summary-items"></div>

      <div class="summary-line"></div>

      <div class="summary-row">
        <span>Subtotal</span>
        <span id="sub">$0.00</span>
      </div>
      <div class="summary-row">
        <span>Shipping</span>
        <span id="ship">$0.00</span>
      </div>
      <div class="summary-row muted">
        <span>Tax</span>
        <span>Calculated at payment</span>
      </div>

      <div class="summary-line"></div>

      <div class="summary-row total">
        <span>Total</span>
        <span id="tot">$0.00</span>
      </div>
    </aside>
  </div>
</main>

<div id="hm-shell-footer"></div>

<!-- Shell + checkout logic -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/hm-shell.js"></script>

<script>
  // Render universal header/footer
  window.HM && window.HM.renderShell({ currentPage: "checkout" });
</script>

<script>
  (function () {
    const fmt = c => "$" + (Math.max(0, c) / 100).toFixed(2);

    // Use shared supabase singleton if present (reduces multi-client warnings)
    const supabaseClient = window.__hm_supabase || (window.__hm_supabase =
      window.supabase.createClient(
        "https://clkizksbvxjkoatdajgd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI"
      )
    );

    // ------------------------
    // Cart helpers
    // ------------------------
    const CART_KEY = "hm_cart";

    function readCart() {
      try { return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); }
      catch (_) { return []; }
    }

    function writeCart(list) {
      try { localStorage.setItem(CART_KEY, JSON.stringify(list || [])); } catch(_) {}
      // update badge if your shell exposes it
      if (window.HM_CART_BADGE_UPDATE) {
        try { window.HM_CART_BADGE_UPDATE(list || []); } catch(_) {}
      }
    }

    // Extract listing id from a cart item (supports your existing shapes)
    function getListingId(it) {
      return it.listing_id || it.listingId || it.id || it.listing || null;
    }

    // Remove SOLD listings from cart, return {removedCount, removedNames}
    async function cleanSoldFromCart({ silent = false } = {}) {
      const cart = readCart();
      if (!cart.length) return { removedCount: 0, removedNames: [] };

      const ids = Array.from(new Set(cart.map(getListingId).filter(Boolean)));
      if (!ids.length) return { removedCount: 0, removedNames: [] };

      // Query listings
      const { data, error } = await supabaseClient
        .from("listings")
        .select("id, status")
        .in("id", ids);

      if (error || !data) {
        if (!silent) console.warn("Sold-check failed:", error);
        return { removedCount: 0, removedNames: [] };
      }

      const sold = new Set(
        data
          .filter(r => String(r.status || "").toUpperCase() === "SOLD")
          .map(r => r.id)
      );

      if (!sold.size) return { removedCount: 0, removedNames: [] };

      const removedNames = [];
      const filtered = cart.filter(it => {
        const id = getListingId(it);
        const isSold = id && sold.has(id);
        if (isSold) removedNames.push(it.name || "Item");
        return !isSold;
      });

      if (filtered.length !== cart.length) {
        writeCart(filtered);
      }

      return { removedCount: cart.length - filtered.length, removedNames };
    }

    // Tier rule: <3yd = $5, 3–10yd = $8, >10yd = $15 (per seller)
    function tierCents(y) {
      if (y < 3) return 500;
      if (y <= 10) return 800;
      return 1500;
    }

    function parsePerYd(it) {
      const p = parseFloat(String(it.perYd ?? "").replace(/[^\d.]/g, ""));
      return Number.isFinite(p) && p > 0 ? p : 0; // dollars per yard
    }

    function yardsForItem(it) {
      const qty = Number(it.qty || 1);
      let y = parseFloat(String(it.yards ?? "").replace(/[^\d.]/g, ""));
      if (Number.isFinite(y) && y > 0) return y * qty;

      const per = parsePerYd(it);
      if (per > 0) return 1 * qty;

      const lineCents = Number(it.amount || 0) * qty; // cents
      if (per > 0) {
        const yDerived = lineCents / Math.round(per * 100);
        if (Number.isFinite(yDerived) && yDerived > 0) return yDerived;
      }
      return 0;
    }

    const sellerKey = it =>
      it.sellerId || it.seller || it.seller_id || it.seller_name || "default";

    function totals(cart) {
      let sub = 0;
      const yardsBySeller = {};
      for (const it of cart) {
        const qty = Number(it.qty || 1);
        const line = Number(it.amount || 0) * qty;
        sub += line;

        const key = sellerKey(it);
        const yds = yardsForItem(it);
        yardsBySeller[key] = (yardsBySeller[key] || 0) + yds;
      }
      const ship = Object.values(yardsBySeller).reduce((s, y) => s + tierCents(y), 0);
      return { sub, ship, tot: sub + ship };
    }

    const itemsEl = document.getElementById("order-items");
    const subEl = document.getElementById("sub");
    const shipEl = document.getElementById("ship");
    const totEl = document.getElementById("tot");
    const next = document.getElementById("next");
    const banner = document.getElementById("banner");

    const emailEl = document.getElementById("email");
    const phoneEl = document.getElementById("phone");

    const addr1El = document.getElementById("addr1");
    const addr2El = document.getElementById("addr2");
    const cityEl  = document.getElementById("city");
    const stateEl = document.getElementById("state");
    const zipEl   = document.getElementById("zip");

    const addrSummaryEl = document.getElementById("addrSummary");
    const addrFormWrap  = document.getElementById("addrFormWrap");
    const btnEditAddr   = document.getElementById("btnEditAddr");
    const btnDoneAddr   = document.getElementById("btnDoneAddr");

    function showBanner(text, tone = "ok") {
      banner.textContent = text;
      banner.className = "checkout-banner " + (tone === "err" ? "err" : "ok");
      banner.style.display = "block";
    }

    function safeParse(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const v = JSON.parse(raw);
        return v && typeof v === "object" ? v : fallback;
      } catch (_) {
        return fallback;
      }
    }

    function writeLS(key, obj) {
      try { localStorage.setItem(key, JSON.stringify(obj)); } catch (_) {}
    }

    function buildSummaryLines(addr) {
      const lines = [];
      const l1 = (addr?.addrLine1 || addr?.line1 || "").trim();
      const l2 = (addr?.addrLine2 || addr?.line2 || "").trim();
      const city = (addr?.addrCity || addr?.city || "").trim();
      const st   = (addr?.addrState || addr?.state || "").trim();
      const zip  = (addr?.addrZip || addr?.zip || "").trim();

      if (l1) lines.push(l1);
      if (l2) lines.push(l2);

      let csz = "";
      if (city) csz += city;
      if (st)   csz += (csz ? " " : "") + st;
      if (zip)  csz += (csz ? " " : "") + zip;
      if (csz) lines.push(csz);

      lines.push("United States");
      return lines;
    }

    function setSummaryFromAddress(addr) {
      const l1 = (addr?.addrLine1 || addr?.line1 || "").trim();
      if (!l1) {
        addrSummaryEl.classList.add("addr-empty");
        addrSummaryEl.innerHTML = 'No address on file yet. Click <strong>Edit address</strong> to add one.';
        return;
      }
      addrSummaryEl.classList.remove("addr-empty");
      addrSummaryEl.textContent = buildSummaryLines(addr).join("\n");
    }

    function setFormFromAddress(addr) {
      addr1El.value = (addr?.addrLine1 || addr?.line1 || "").trim();
      addr2El.value = (addr?.addrLine2 || addr?.line2 || "").trim();
      cityEl.value  = (addr?.addrCity  || addr?.city  || "").trim();
      stateEl.value = (addr?.addrState || addr?.state || "").trim();
      zipEl.value   = (addr?.addrZip   || addr?.zip   || "").trim();
    }

    function getAddressFromForm() {
      return {
        addrLine1: addr1El.value.trim(),
        addrLine2: addr2El.value.trim(),
        addrCity:  cityEl.value.trim(),
        addrState: stateEl.value.trim(),
        addrZip:   zipEl.value.trim(),
        addrCountry: "United States",

        line1: addr1El.value.trim(),
        line2: addr2El.value.trim(),
        city:  cityEl.value.trim(),
        state: stateEl.value.trim(),
        zip:   zipEl.value.trim(),
        country: "US",
      };
    }

    function openAddrEditor() {
      addrFormWrap.style.display = "block";
      btnEditAddr.style.display = "none";
      btnDoneAddr.style.display = "inline-flex";
      addr1El.focus();
    }

    function closeAddrEditor() {
      addrFormWrap.style.display = "none";
      btnEditAddr.style.display = "inline-flex";
      btnDoneAddr.style.display = "none";
    }

    btnEditAddr.addEventListener("click", openAddrEditor);
    btnDoneAddr.addEventListener("click", () => {
      const nextAddr = getAddressFromForm();
      setSummaryFromAddress(nextAddr);
      closeAddrEditor();

      // Save to checkout snapshot (for this order)
      writeLS("hm_checkout_address", {
        email: emailEl?.value?.trim() || "",
        phone: phoneEl?.value?.trim() || "",
        line1: nextAddr.line1,
        line2: nextAddr.line2,
        city: nextAddr.city,
        state: nextAddr.state,
        zip: nextAddr.zip,
        country: "US",
      });

      // Also save back to Account key so Account stays updated
      if (window.__hm_user_id_for_address_key) {
        const ADDRESS_KEY = "hm_address_" + window.__hm_user_id_for_address_key;
        const existing = safeParse(ADDRESS_KEY, {});
        writeLS(ADDRESS_KEY, {
          ...existing,
          addrLine1: nextAddr.addrLine1,
          addrLine2: nextAddr.addrLine2,
          addrCity:  nextAddr.addrCity,
          addrState: nextAddr.addrState,
          addrZip:   nextAddr.addrZip,
          addrCountry: "United States",
        });
      }
    });

    async function hydrateDefaults() {
      // Prefill email from session if possible
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user?.id) window.__hm_user_id_for_address_key = user.id;
        if (user?.email && emailEl && !emailEl.value) emailEl.value = user.email;
      } catch (_) {}

      // 1) If checkout address exists, use it
      const checkoutAddr = safeParse("hm_checkout_address", {});
      const hasCheckout = !!(checkoutAddr?.line1 || checkoutAddr?.city || checkoutAddr?.zip);
      if (hasCheckout) {
        setFormFromAddress(checkoutAddr);
        setSummaryFromAddress({
          line1: checkoutAddr.line1,
          line2: checkoutAddr.line2,
          city: checkoutAddr.city,
          state: checkoutAddr.state,
          zip: checkoutAddr.zip,
        });
        closeAddrEditor();
        if (checkoutAddr.email && emailEl && !emailEl.value) emailEl.value = checkoutAddr.email;
        if (checkoutAddr.phone && phoneEl && !phoneEl.value) phoneEl.value = checkoutAddr.phone;
        return;
      }

      // 2) Otherwise load from Account’s localStorage key: hm_address_<userId>
      const uid = window.__hm_user_id_for_address_key;
      if (uid) {
        const ADDRESS_KEY = "hm_address_" + uid;
        const acctAddr = safeParse(ADDRESS_KEY, {});
        const hasAcct = !!(acctAddr?.addrLine1 || acctAddr?.addrCity || acctAddr?.addrZip);
        if (hasAcct) {
          setFormFromAddress(acctAddr);
          setSummaryFromAddress(acctAddr);
          closeAddrEditor();
          return;
        }
      }

      setSummaryFromAddress({});
      closeAddrEditor();
    }

    function renderCartSummary() {
      const cart = readCart();
      itemsEl.innerHTML = "";

      if (cart.length === 0) {
        subEl.textContent = fmt(0);
        shipEl.textContent = fmt(0);
        totEl.textContent = fmt(0);
        next.disabled = true;
        showBanner("Your cart is empty — add fabric to continue.", "err");
        return;
      }

      next.disabled = false;
      showBanner("Cart has items — ready to check out.", "ok");

      for (const it of cart) {
        const line = Number(it.amount || 0) * Number(it.qty || 1);
        const row = document.createElement("div");
        row.className = "summary-item";
        row.innerHTML =
          '<span class="summary-item-name">' +
          (it.name || "Item") +
          '</span><span class="summary-item-amt">' +
          fmt(line) +
          "</span>";
        itemsEl.appendChild(row);
      }

      const t = totals(cart);
      subEl.textContent = fmt(t.sub);
      shipEl.textContent = fmt(t.ship);
      totEl.textContent = fmt(t.tot);

      try { localStorage.setItem("hm_checkout_preview", JSON.stringify(t)); } catch (_) {}
    }

    // ------------------------
    // Checkout → Stripe
    // ------------------------
    async function goToStripe() {
      const agree = document.getElementById("agreeCheckout");
      if (!agree || !agree.checked) {
        showBanner("Please agree to the Terms of Service and Privacy Policy to continue.", "err");
        agree && agree.focus();
        return;
      }

      // HARD STOP: re-check SOLD right before payment to prevent race conditions
      try {
        const soldResult = await cleanSoldFromCart({ silent: true });
        if (soldResult.removedCount > 0) {
          renderCartSummary();
          showBanner(
            soldResult.removedCount === 1
              ? "One item in your cart was just purchased by someone else, so we removed it. Please review your cart."
              : soldResult.removedCount + " items in your cart were just purchased by someone else, so we removed them. Please review your cart.",
            "err"
          );
          return;
        }
      } catch (e) {
        // If the sold-check fails, we *do not* block payment, but we warn (devil’s advocate: you may want to block)
        console.warn("Pre-payment sold-check failed:", e);
      }

      const cart = readCart();
      if (!cart.length) {
        renderCartSummary();
        return;
      }

      const addrNow = getAddressFromForm();
      if (!addrNow.line1 || !addrNow.city || !addrNow.state || !addrNow.zip) {
        showBanner("Please enter your shipping address (street, city, state, ZIP).", "err");
        openAddrEditor();
        return;
      }

      const addr = {
        email: emailEl?.value?.trim() || "",
        phone: phoneEl?.value?.trim() || "",
        line1: addrNow.line1,
        line2: addrNow.line2,
        city:  addrNow.city,
        state: addrNow.state,
        zip:   addrNow.zip,
        country: "US",
      };

      // Store checkout address snapshot
      try { localStorage.setItem("hm_checkout_address", JSON.stringify(addr)); } catch (_) {}

      // Recompute shipping to pass exact cents
      const ship = (function () {
        const yardsBySeller = {};
        for (const it of cart) {
          const key = sellerKey(it);
          const yds = yardsForItem(it);
          yardsBySeller[key] = (yardsBySeller[key] || 0) + yds;
        }
        return Object.values(yardsBySeller).reduce((s, y) => s + tierCents(y), 0);
      })();

      next.disabled = true;
      const old = next.textContent;
      next.textContent = "Redirecting…";

      try {
        const resp = await fetch("/api/stripe/create_session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            cart,
            buyer: { 
              email: addr.email,
              id: window.__hm_user_id_for_address_key || ""
            },
            shipping_cents: ship,
          }),
        });

        const text = await resp.text();
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch (_) { data = { raw: text }; }

        if (!resp.ok) {
          console.error("Stripe create_session error", resp.status, data);
          const msg =
            data.error ||
            data.message ||
            `Could not start payment (status ${resp.status}). Please try again.`;
          showBanner(msg, "err");
          next.disabled = false;
          next.textContent = old;
          return;
        }

        if (data.url) {
          window.location.href = data.url;
          return;
        }

        console.error("Stripe session missing URL", data);
        showBanner("Could not start payment (no session URL).", "err");
        next.disabled = false;
        next.textContent = old;
      } catch (err) {
        console.error(err);
        showBanner("Could not start payment. Please check your connection and try again.", "err");
        next.disabled = false;
        next.textContent = old;
      }
    }

    next.addEventListener("click", goToStripe);

    // ------------------------
    // Init
    // ------------------------
    (async function init() {
      // On load, proactively remove SOLD so the user doesn’t get surprised later
      try {
        const soldResult = await cleanSoldFromCart({ silent: true });
        if (soldResult.removedCount > 0) {
          showBanner(
            soldResult.removedCount === 1
              ? "One item in your cart was already sold, so we removed it."
              : soldResult.removedCount + " items in your cart were already sold, so we removed them.",
            "err"
          );
        }
      } catch (_) {}

      renderCartSummary();
      hydrateDefaults();
    })();
  })();
</script>
</body>
</html>
