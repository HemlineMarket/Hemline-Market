<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Checkout — Hemline Market</title>

  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">

  <!-- Shared styles (universal header/footer stack) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --checkout-bg:#f4f4f7;
    }
    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:var(--checkout-bg);
      -webkit-font-smoothing:antialiased;
    }

    main.checkout-wrap{
      max-width:1100px;
      margin:18px auto 32px;
      padding:0 12px 32px;
    }

    .checkout-grid{
      display:grid;
      grid-template-columns:minmax(0,1.6fr) minmax(0,1fr);
      gap:18px;
      align-items:flex-start;
    }
    @media (max-width:960px){
      .checkout-grid{
        grid-template-columns:minmax(0,1fr);
      }
    }

    .checkout-card{
      background:#fff;
      border-radius:14px;
      border:1px solid var(--hm-border);
      box-shadow:0 8px 24px rgba(15,23,42,.04);
      padding:16px 18px 18px;
    }

    .checkout-card h1{
      margin:0 0 10px;
      font-size:22px;
      font-weight:800;
    }
    .checkout-card h2{
      margin:6px 0 10px;
      font-size:16px;
      font-weight:700;
    }

    .checkout-banner{
      margin:0 0 12px;
      padding:9px 11px;
      border-radius:10px;
      font-size:13px;
    }
    .checkout-banner.ok{
      background:#ecfdf5;
      border:1px solid #bbf7d0;
      color:#065f46;
    }
    .checkout-banner.err{
      background:#fff7ed;
      border:1px solid #fed7aa;
      color:#9a3412;
    }

    label.checkout-label{
      display:block;
      margin:6px 0 4px;
      font-size:13px;
      font-weight:600;
      color:#374151;
    }
    .checkout-input{
      height:40px;
      border-radius:10px;
      border:1px solid var(--hm-border);
      padding:0 12px;
      width:100%;
      font-size:14px;
      background:#fff;
    }

    .checkout-row{
      display:flex;
      gap:10px;
    }
    .checkout-row > *{
      flex:1;
      min-width:0;
    }

    .checkout-help{
      margin-top:8px;
      font-size:12px;
      color:#6b7280;
    }

    /* Legal block */
    .checkout-legal{
      margin:18px 0 0;
      padding:12px 12px 10px;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid var(--hm-border);
    }
    .checkout-legal-heading{
      margin:0 0 6px;
      font-size:13px;
      color:#4b5563;
    }
    .checkout-legal-label{
      display:flex;
      align-items:flex-start;
      gap:8px;
      font-size:13px;
      line-height:1.4;
      color:#111827;
    }
    .checkout-legal-label input[type="checkbox"]{
      margin-top:2px;
      width:16px;
      height:16px;
      flex-shrink:0;
    }
    .checkout-legal-label a{
      color:var(--hm-accent);
    }

    .checkout-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:40px;
      padding:0 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:700;
      border:1px solid transparent;
      cursor:pointer;
      text-decoration:none;
    }
    .btn-primary{
      background:var(--hm-accent);
      border-color:var(--hm-accent);
      color:#fff;
      box-shadow:0 2px 10px rgba(153,27,27,.25);
    }
    .btn-outline{
      background:#fff;
      border-color:var(--hm-border);
      color:var(--hm-accent);
    }
    .btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }

    /* Summary */
    .summary-title{
      margin:0 0 10px;
      font-size:16px;
      font-weight:700;
    }
    .summary-items{
      font-size:14px;
    }
    .summary-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:6px 0;
    }
    .summary-item-name{
      color:#111827;
      max-width:70%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .summary-item-amt{
      font-weight:600;
      color:#111827;
    }
    .summary-line{
      height:1px;
      background:var(--hm-border);
      margin:12px 0;
    }
    .summary-row{
      display:flex;
      justify-content:space-between;
      font-size:14px;
      margin:3px 0;
    }
    .summary-row.muted span:last-child{
      color:#6b7280;
      font-size:13px;
    }
    .summary-row.total{
      margin-top:6px;
      font-weight:800;
      font-size:16px;
    }
  </style>
</head>
<body>

<div id="hm-shell-header"></div>

<main class="checkout-wrap" id="maincontent">
  <div class="checkout-grid">
    <!-- LEFT: Contact + shipping -->
    <section class="checkout-card" aria-label="Checkout details">
      <h1>Checkout</h1>
      <div id="banner" class="checkout-banner ok" role="status" aria-live="polite" style="display:none"></div>

      <h2>Contact &amp; Shipping</h2>

      <div class="checkout-row">
        <div>
          <label class="checkout-label" for="email">Email</label>
          <input id="email" class="checkout-input" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email">
        </div>
        <div>
          <label class="checkout-label" for="phone">Phone (optional)</label>
          <input id="phone" class="checkout-input" type="tel" placeholder="(555) 555-5555" autocomplete="tel">
        </div>
      </div>

      <div class="checkout-row" style="margin-top:10px">
        <div>
          <label class="checkout-label" for="addr1">Address line 1</label>
          <input id="addr1" class="checkout-input" placeholder="Street address" autocomplete="address-line1">
        </div>
      </div>

      <div class="checkout-row" style="margin-top:10px">
        <div>
          <label class="checkout-label" for="addr2">Address line 2 (optional)</label>
          <input id="addr2" class="checkout-input" placeholder="Apt, suite, etc." autocomplete="address-line2">
        </div>
      </div>

      <div class="checkout-row" style="margin-top:10px">
        <div>
          <label class="checkout-label" for="city">City</label>
          <input id="city" class="checkout-input" placeholder="City" autocomplete="address-level2">
        </div>
        <div>
          <label class="checkout-label" for="state">State</label>
          <input id="state" class="checkout-input" placeholder="State" autocomplete="address-level1">
        </div>
        <div>
          <label class="checkout-label" for="zip">ZIP</label>
          <input id="zip" class="checkout-input" placeholder="ZIP" autocomplete="postal-code" inputmode="numeric">
        </div>
      </div>

      <p class="checkout-help">
        Shipping label is generated after payment. You’ll confirm card details on the next step.
      </p>

      <!-- Legal acknowledgment -->
      <div class="checkout-legal">
        <p class="checkout-legal-heading">Before you continue, please confirm the following:</p>
        <label class="checkout-legal-label">
          <input id="agreeCheckout" type="checkbox">
          <span>
            I understand that Hemline Market connects buyers and independent sellers, and I agree to
            Hemline Market’s
            <a href="terms.html" target="_blank" rel="noopener">Terms of Service</a>
            and
            <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.
          </span>
        </label>
      </div>

      <div class="checkout-actions">
        <a class="btn btn-outline" href="cart.html">Back to cart</a>
        <button id="next" class="btn btn-primary" type="button">Continue to payment</button>
      </div>
    </section>

    <!-- RIGHT: Summary -->
    <aside class="checkout-card" aria-label="Order summary">
      <h2 class="summary-title">Order summary</h2>
      <div id="order-items" class="summary-items"></div>

      <div class="summary-line"></div>

      <div class="summary-row">
        <span>Subtotal</span>
        <span id="sub">$0.00</span>
      </div>
      <div class="summary-row">
        <span>Shipping</span>
        <span id="ship">$0.00</span>
      </div>
      <div class="summary-row muted">
        <span>Tax</span>
        <span>Calculated at payment</span>
      </div>

      <div class="summary-line"></div>

      <div class="summary-row total">
        <span>Total</span>
        <span id="tot">$0.00</span>
      </div>
    </aside>
  </div>
</main>

<div id="hm-shell-footer"></div>

<!-- Shell + checkout logic -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/hm-shell.js"></script>

<script>
  // Render universal header/footer
  window.HM && window.HM.renderShell({ currentPage: "checkout" });
</script>

<script>
  // Shipping, totals, and Stripe Checkout redirect
  (function () {
    const fmt = c => "$" + (Math.max(0, c) / 100).toFixed(2);

    // Tier rule: <3yd = $5, 3–10yd = $8, >10yd = $15 (per seller)
    function tierCents(y) {
      if (y < 3) return 500;
      if (y <= 10) return 800;
      return 1500;
    }

    function parsePerYd(it) {
      const p = parseFloat(String(it.perYd ?? "").replace(/[^\d.]/g, ""));
      return Number.isFinite(p) && p > 0 ? p : 0; // dollars per yard
    }

    function yardsForItem(it) {
      const qty = Number(it.qty || 1);

      // 1) direct yards
      let y = parseFloat(String(it.yards ?? "").replace(/[^\d.]/g, ""));
      if (Number.isFinite(y) && y > 0) return y * qty;

      // 2) if priced per yard but yards missing, assume 1 yd per unit
      const per = parsePerYd(it);
      if (per > 0) return 1 * qty;

      // 3) derive from price/per-yd if available
      const lineCents = Number(it.amount || 0) * qty; // cents
      if (per > 0) {
        const yDerived = lineCents / Math.round(per * 100);
        if (Number.isFinite(yDerived) && yDerived > 0) return yDerived;
      }
      return 0;
    }

    const sellerKey = it =>
      it.sellerId || it.seller || it.seller_id || it.seller_name || "default";

    function totals(cart) {
      let sub = 0;
      const yardsBySeller = {};
      for (const it of cart) {
        const qty = Number(it.qty || 1);
        const line = Number(it.amount || 0) * qty;
        sub += line;

        const key = sellerKey(it);
        const yds = yardsForItem(it);
        yardsBySeller[key] = (yardsBySeller[key] || 0) + yds;
      }
      const ship = Object.values(yardsBySeller).reduce(
        (s, y) => s + tierCents(y),
        0
      );
      return { sub, ship, tot: sub + ship };
    }

    const itemsEl = document.getElementById("order-items");
    const subEl = document.getElementById("sub");
    const shipEl = document.getElementById("ship");
    const totEl = document.getElementById("tot");
    const next = document.getElementById("next");
    const banner = document.getElementById("banner");

    function showBanner(text, tone = "ok") {
      banner.textContent = text;
      banner.className =
        "checkout-banner " + (tone === "err" ? "err" : "ok");
      banner.style.display = "block";
    }

    function render() {
      const cart = JSON.parse(localStorage.getItem("hm_cart") || "[]");
      itemsEl.innerHTML = "";
      if (cart.length === 0) {
        subEl.textContent = fmt(0);
        shipEl.textContent = fmt(0);
        totEl.textContent = fmt(0);
        next.disabled = true;
        showBanner(
          "Your cart is empty — add fabric to continue.",
          "err"
        );
        return;
      }
      next.disabled = false;
      showBanner("Cart has items — ready to check out.", "ok");

      for (const it of cart) {
        const line = Number(it.amount || 0) * Number(it.qty || 1);
        const row = document.createElement("div");
        row.className = "summary-item";
        row.innerHTML =
          '<span class="summary-item-name">' +
          (it.name || "Item") +
          '</span><span class="summary-item-amt">' +
          fmt(line) +
          "</span>";
        itemsEl.appendChild(row);
      }

      const t = totals(cart);
      subEl.textContent = fmt(t.sub);
      shipEl.textContent = fmt(t.ship);
      totEl.textContent = fmt(t.tot);

      // Stash preview for later pages if needed
      try {
        localStorage.setItem(
          "hm_checkout_preview",
          JSON.stringify(t)
        );
      } catch (_) {}
    }

    async function goToStripe() {
      const agree = document.getElementById("agreeCheckout");
      if (!agree || !agree.checked) {
        showBanner(
          "Please agree to the Terms of Service and Privacy Policy to continue.",
          "err"
        );
        agree && agree.focus();
        return;
      }

      const cart = JSON.parse(localStorage.getItem("hm_cart") || "[]");
      if (!cart.length) return;

      const addr = {
        email: document.getElementById("email")?.value?.trim() || "",
        phone: document.getElementById("phone")?.value?.trim() || "",
        line1: document.getElementById("addr1")?.value?.trim() || "",
        line2: document.getElementById("addr2")?.value?.trim() || "",
        city: document.getElementById("city")?.value?.trim() || "",
        state: document.getElementById("state")?.value?.trim() || "",
        zip: document.getElementById("zip")?.value?.trim() || "",
        country: "US",
      };
      try {
        localStorage.setItem(
          "hm_checkout_address",
          JSON.stringify(addr)
        );
      } catch (_) {}

      // Recompute shipping to pass exact cents
      const { ship } = (function () {
        let sub = 0;
        const yardsBySeller = {};
        for (const it of cart) {
          const qty = Number(it.qty || 1);
          const line = Number(it.amount || 0) * qty;
          sub += line;
          const key = sellerKey(it);
          const yds = yardsForItem(it);
          yardsBySeller[key] =
            (yardsBySeller[key] || 0) + yds;
        }
        const shipCents = Object.values(yardsBySeller).reduce(
          (s, y) => s + tierCents(y),
          0
        );
        return { ship: shipCents };
      })();

      next.disabled = true;
      const old = next.textContent;
      next.textContent = "Redirecting…";

      try {
        const resp = await fetch("/api/stripe/create_session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            cart,
            buyer: { email: addr.email },
            shipping_cents: ship,
          }),
        });

        if (!resp.ok) throw new Error("Failed to create session");
        const data = await resp.json();
        if (data.url) {
          window.location.href = data.url;
          return;
        }
        throw new Error("Missing session URL");
      } catch (err) {
        console.error(err);
        showBanner(
          "Could not start payment. Please try again.",
          "err"
        );
        next.disabled = false;
        next.textContent = old;
      }
    }

    next.addEventListener("click", goToStripe);
    render();
  })();
</script>
</body>
</html>
