<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Checkout — Hemline Market</title>

  <link rel="icon" href="/favicon.ico"/>

  <!-- Shared styles -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    html,body{margin:0;background:#f4f4f7}
    main{max-width:1100px;margin:24px auto;padding:0 12px}
    .grid{display:grid;grid-template-columns:1.6fr 1fr;gap:18px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    .card{
      background:#fff;border-radius:14px;border:1px solid var(--hm-border);
      padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.05)
    }

    label{font-size:13px;font-weight:600;color:#374151}
    input{width:100%;height:40px;border-radius:10px;border:1px solid var(--hm-border);padding:0 12px}
    .row{display:flex;gap:10px;margin-bottom:10px}
    .row > *{flex:1}

    .btn{height:40px;padding:0 18px;border-radius:999px;font-weight:700;cursor:pointer}
    .btn-primary{background:#991b1b;color:#fff;border:none}
    .btn-outline{background:#fff;border:1px solid var(--hm-border);color:#991b1b}

    .summary-row{display:flex;justify-content:space-between;margin:6px 0}
    .summary-total{font-weight:800;font-size:16px}
    .banner{margin-bottom:12px;padding:10px;border-radius:10px;font-size:13px}
    .ok{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
    .err{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
  </style>
</head>
<body>

<div id="hm-shell-header"></div>

<main>
  <div class="grid">

    <!-- LEFT -->
    <section class="card">
      <h1>Checkout</h1>
      <div id="banner" class="banner ok" style="display:none"></div>

      <h3>Contact & Shipping</h3>

      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" type="email">
        </div>
        <div>
          <label>Phone (optional)</label>
          <input id="phone" type="tel">
        </div>
      </div>

      <label>Address</label>
      <input id="addr1">

      <div class="row">
        <input id="city" placeholder="City">
        <input id="state" placeholder="State">
        <input id="zip" placeholder="ZIP">
      </div>

      <label style="display:flex;gap:8px;margin-top:12px">
        <input type="checkbox" id="agree">
        I agree to the Terms & Privacy Policy
      </label>

      <div class="row" style="margin-top:14px">
        <a href="cart.html" class="btn btn-outline">Back to cart</a>
        <button id="pay" class="btn btn-primary">Continue to payment</button>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <h3>Order summary</h3>
      <div id="items"></div>
      <hr>
      <div class="summary-row"><span>Subtotal</span><span id="sub">$0.00</span></div>
      <div class="summary-row"><span>Shipping</span><span id="ship">$0.00</span></div>
      <div class="summary-row summary-total"><span>Total</span><span id="tot">$0.00</span></div>
    </aside>

  </div>
</main>

<div id="hm-shell-footer"></div>

<!-- Supabase + shell -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/hm-shell.js"></script>
<script>
  window.HM && window.HM.renderShell({ currentPage: "checkout" });
</script>

<script>
(async function () {
  const fmt = c => "$" + (c/100).toFixed(2);
  const itemsEl = document.getElementById("items");
  const subEl = document.getElementById("sub");
  const shipEl = document.getElementById("ship");
  const totEl = document.getElementById("tot");
  const banner = document.getElementById("banner");
  const payBtn = document.getElementById("pay");

  const cart = JSON.parse(localStorage.getItem("hm_cart") || "[]");
  if (!cart.length) {
    banner.textContent = "Your cart is empty.";
    banner.className = "banner err";
    banner.style.display = "block";
    payBtn.disabled = true;
    return;
  }

  let subtotal = 0;
  cart.forEach(it => {
    const line = it.amount * it.qty;
    subtotal += line;
    itemsEl.innerHTML += `<div class="summary-row"><span>${it.name}</span><span>${fmt(line)}</span></div>`;
  });

  const shipping = 500; // fixed for now
  subEl.textContent = fmt(subtotal);
  shipEl.textContent = fmt(shipping);
  totEl.textContent = fmt(subtotal + shipping);

  payBtn.onclick = async () => {
    if (!document.getElementById("agree").checked) {
      banner.textContent = "Please agree to the terms.";
      banner.className = "banner err";
      banner.style.display = "block";
      return;
    }

    const {
      data: { session }
    } = await window.HM.supabase.auth.getSession();

    if (!session?.access_token) {
      location.href = "auth.html?view=login";
      return;
    }

    payBtn.disabled = true;
    payBtn.textContent = "Redirecting…";

    const resp = await fetch("/api/stripe/create_session", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + session.access_token
      },
      body: JSON.stringify({
        cart,
        shipping_cents: shipping
      })
    });

    const data = await resp.json();
    if (!resp.ok || !data.url) {
      banner.textContent = "Payment failed. Please try again.";
      banner.className = "banner err";
      banner.style.display = "block";
      payBtn.disabled = false;
      payBtn.textContent = "Continue to payment";
      return;
    }

    window.location.href = data.url;
  };
})();
</script>
</body>
</html>
