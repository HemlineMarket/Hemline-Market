<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Checkout — Hemline Market</title>

  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">

  <!-- Shared styles (universal header/footer stack) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#991b1b;
      --bg:#fafafa;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* PAGE LAYOUT */
    main.checkout-wrap{
      max-width:1100px;
      margin:18px auto 28px;
      padding:0 12px 24px;
    }
    .checkout-grid{
      display:grid;
      grid-template-columns:1fr 360px;
      gap:18px;
    }
    @media(max-width:900px){
      .checkout-grid{
        grid-template-columns:1fr;
      }
    }
    .checkout-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
    }
    .checkout-card h1{
      margin:0 0 12px;
      font-size:24px;
      font-weight:800;
    }
    .checkout-card h2{
      margin:0 0 10px;
      font-size:18px;
    }

    label{
      display:block;
      margin:6px 0 6px;
      color:#374151;
      font-weight:600;
      font-size:13px;
    }
    input{
      height:40px;
      border:1px solid var(--border);
      border-radius:10px;
      padding:0 12px;
      width:100%;
      background:#fff;
    }
    .checkout-row{
      display:flex;
      gap:10px;
    }
    .checkout-row > *{
      flex:1;
    }
    .checkout-help{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }

    .checkout-item{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin:8px 0;
      font-size:14px;
    }
    .checkout-muted{
      color:var(--muted);
    }
    .checkout-line{
      height:1px;
      background:var(--border);
      margin:12px 0;
    }
    .checkout-total-row{
      display:flex;
      justify-content:space-between;
      margin-top:4px;
      font-size:14px;
    }
    .checkout-grand{
      font-weight:800;
      font-size:18px;
    }

    .checkout-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:42px;
      padding:0 16px;
      border-radius:999px;
      border:1px solid transparent;
      background:var(--accent);
      color:#fff;
      text-decoration:none;
      font-weight:700;
      cursor:pointer;
      font-size:14px;
    }
    .checkout-btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    .checkout-btn-outline{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:42px;
      padding:0 16px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--accent);
      text-decoration:none;
      font-weight:600;
      font-size:14px;
    }

    .checkout-banner{
      background:#ecfdf5;
      border:1px solid #bbf7d0;
      color:#065f46;
      border-radius:10px;
      padding:10px;
      margin:0 0 12px;
      font-size:13px;
    }
    .checkout-banner.empty{
      background:#fff7ed;
      border-color:#fed7aa;
      color:#9a3412;
    }
  </style>
</head>
<body>

  <!-- UNIVERSAL HEADER -->
  <div id="hm-shell-header"></div>

  <main class="checkout-wrap" id="maincontent">
    <div class="checkout-grid">
      <section class="checkout-card" aria-labelledby="checkoutHeading">
        <h1 id="checkoutHeading">Checkout</h1>
        <div id="banner" class="checkout-banner" role="status" aria-live="polite" style="display:none"></div>

        <h2>Contact &amp; Shipping</h2>

        <div class="checkout-row">
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email">
          </div>
          <div>
            <label for="phone">Phone (optional)</label>
            <input id="phone" type="tel" placeholder="(555) 555-5555" autocomplete="tel">
          </div>
        </div>

        <div class="checkout-row" style="margin-top:10px">
          <div>
            <label for="addr1">Address line 1</label>
            <input id="addr1" placeholder="Street address" autocomplete="address-line1">
          </div>
        </div>

        <div class="checkout-row" style="margin-top:10px">
          <div>
            <label for="addr2">Address line 2 (optional)</label>
            <input id="addr2" placeholder="Apt, suite, etc." autocomplete="address-line2">
          </div>
        </div>

        <div class="checkout-row" style="margin-top:10px">
          <div>
            <label for="city">City</label>
            <input id="city" placeholder="City" autocomplete="address-level2">
          </div>
          <div>
            <label for="state">State</label>
            <input id="state" placeholder="State" autocomplete="address-level1">
          </div>
          <div>
            <label for="zip">ZIP</label>
            <input id="zip" placeholder="ZIP" autocomplete="postal-code" inputmode="numeric">
          </div>
        </div>

        <p class="checkout-help">
          Shipping label is generated after payment. You’ll confirm card details on the next step.
        </p>

        <!-- Legal acknowledgment -->
        <div style="margin:16px 0">
          <label style="font-size:14px;display:flex;gap:8px;align-items:flex-start">
            <input id="agreeCheckout" type="checkbox" style="margin-top:3px">
            <span>
              I understand that Hemline Market connects buyers and independent sellers, and I agree to
              Hemline Market’s
              <a href="terms.html" target="_blank">Terms of Service</a> and
              <a href="privacy.html" target="_blank">Privacy Policy</a>.
            </span>
          </label>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
          <a class="checkout-btn-outline" href="cart.html">Back to cart</a>
          <button id="next" class="checkout-btn">Continue to payment</button>
        </div>
      </section>

      <aside class="checkout-card" aria-labelledby="orderSummaryHeading">
        <h2 id="orderSummaryHeading">Order summary</h2>
        <div id="order-items"></div>
        <div class="checkout-line"></div>
        <div class="checkout-total-row"><span>Subtotal</span><span id="sub">$0.00</span></div>
        <div class="checkout-total-row"><span>Shipping</span><span id="ship">$0.00</span></div>
        <div class="checkout-total-row"><span>Tax</span><span class="checkout-muted">Calculated at payment</span></div>
        <div class="checkout-line"></div>
        <div class="checkout-total-row checkout-grand"><span>Total</span><span id="tot">$0.00</span></div>
      </aside>
    </div>
  </main>

  <!-- UNIVERSAL FOOTER -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase + universal shell -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="scripts/hm-shell.js"></script>
  <script>
    window.HM && window.HM.renderShell({ currentPage: "checkout" });
  </script>

  <script>
  // Shipping + totals + redirect to Stripe Checkout
  (function(){
    const fmt = c => "$" + (Math.max(0,c)/100).toFixed(2);

    // Tier rule: <3yd = $5, 3–10yd = $8, >10yd = $15 (per seller)
    function tierCents(y){
      if(y < 3) return 500;
      if(y <= 10) return 800;
      return 1500;
    }

    function parsePerYd(it){
      const p = parseFloat(String(it.perYd ?? "").replace(/[^\d.]/g,""));
      return Number.isFinite(p) && p > 0 ? p : 0; // dollars per yard
    }

    function yardsForItem(it){
      const qty = Number(it.qty || 1);

      // 1) direct yards
      let y = parseFloat(String(it.yards ?? "").replace(/[^\d.]/g,""));
      if(Number.isFinite(y) && y > 0) return y * qty;

      // 2) if priced per yard but yards missing, assume 1 yd per unit
      const per = parsePerYd(it);
      if(per > 0) return 1 * qty;

      // 3) derive from price/per-yd if available
      const lineCents = Number(it.amount || 0) * qty; // cents
      if(per > 0){
        const yDerived = lineCents / Math.round(per * 100);
        if(Number.isFinite(yDerived) && yDerived > 0) return yDerived;
      }
      return 0;
    }

    const sellerKey = it =>
      (it.sellerId || it.seller || it.seller_id || it.seller_name || "default");

    function totals(cart){
      let sub = 0;
      const yardsBySeller = {};
      for(const it of cart){
        const qty  = Number(it.qty || 1);
        const line = Number(it.amount || 0) * qty;
        sub += line;

        const key = sellerKey(it);
        const yds = yardsForItem(it);
        yardsBySeller[key] = (yardsBySeller[key] || 0) + yds;
      }
      const ship = Object.values(yardsBySeller).reduce((s,y)=> s + tierCents(y), 0);
      return { sub, ship, tot: sub + ship };
    }

    const itemsEl = document.getElementById("order-items");
    const subEl   = document.getElementById("sub");
    const shipEl  = document.getElementById("ship");
    const totEl   = document.getElementById("tot");
    const next    = document.getElementById("next");
    const banner  = document.getElementById("banner");

    function showBanner(text, tone="ok"){
      banner.textContent = text;
      banner.className = tone === "err" ? "checkout-banner empty" : "checkout-banner";
      banner.style.display = "block";
    }

    function render(){
      const cart = JSON.parse(localStorage.getItem("hm_cart") || "[]");
      itemsEl.innerHTML = "";
      if(cart.length === 0){
        subEl.textContent  = fmt(0);
        shipEl.textContent = fmt(0);
        totEl.textContent  = fmt(0);
        next.disabled = true;
        showBanner("Your cart is empty — add fabric to continue.", "err");
        return;
      }
      next.disabled = false;
      showBanner("Cart has items — ready to check out.", "ok");

      for(const it of cart){
        const line = Number(it.amount || 0) * Number(it.qty || 1);
        const row = document.createElement("div");
        row.className = "checkout-item";
        row.innerHTML = `<span>${it.name || "Item"}</span><span>${fmt(line)}</span>`;
        itemsEl.appendChild(row);
      }

      const t = totals(cart);
      subEl.textContent  = fmt(t.sub);
      shipEl.textContent = fmt(t.ship);
      totEl.textContent  = fmt(t.tot);

      // Stash preview for later pages if needed
      try{
        localStorage.setItem("hm_checkout_preview", JSON.stringify(t));
      }catch(_){}
    }

    // Create Stripe Checkout Session and redirect
    async function goToStripe(){
      const agree = document.getElementById("agreeCheckout");
      if(!agree || !agree.checked){
        showBanner("Please agree to the Terms of Service and Privacy Policy to continue.", "err");
        agree?.focus();
        return;
      }

      const cart = JSON.parse(localStorage.getItem("hm_cart") || "[]");
      if(!cart.length) return;

      const addr = {
        email: document.getElementById("email")?.value?.trim() || "",
        phone: document.getElementById("phone")?.value?.trim() || "",
        line1: document.getElementById("addr1")?.value?.trim() || "",
        line2: document.getElementById("addr2")?.value?.trim() || "",
        city:  document.getElementById("city")?.value?.trim() || "",
        state: document.getElementById("state")?.value?.trim() || "",
        zip:   document.getElementById("zip")?.value?.trim() || "",
        country:"US"
      };
      try{
        localStorage.setItem("hm_checkout_address", JSON.stringify(addr));
      }catch(_){}

      // Recompute shipping to pass exact cents
      const { ship } = (function(){
        let sub=0;
        const yardsBySeller = {};
        for(const it of cart){
          const qty  = Number(it.qty || 1);
          const line = Number(it.amount || 0) * qty;
          sub += line;
          const key = sellerKey(it);
          const yds = yardsForItem(it);
          yardsBySeller[key] = (yardsBySeller[key] || 0) + yds;
        }
        const shipCents = Object.values(yardsBySeller).reduce((s,y)=> s + tierCents(y), 0);
        return { ship: shipCents };
      })();

      next.disabled = true;
      const oldText = next.textContent;
      next.textContent = "Redirecting…";

      try{
        const resp = await fetch("/api/stripe/create_session", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({
            cart,
            buyer:{ email: addr.email },
            shipping_cents: ship
          })
        });

        if(!resp.ok) throw new Error("Failed to create session");
        const data = await resp.json();
        if(data.url){
          window.location.href = data.url;
          return;
        }
        throw new Error("Missing session URL");
      }catch(err){
        console.error(err);
        showBanner("Could not start payment. Please try again.", "err");
        next.disabled = false;
        next.textContent = oldText;
      }
    }

    next.addEventListener("click", goToStripe);
    render();
  })();
  </script>
</body>
</html>
