<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Listing — Hemline Market</title>
  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#991b1b;
      --bg:#fafafa;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }
    img,svg,canvas,video{max-width:100%;height:auto;display:block}

    /* HEADER */
    .hm-header{
      min-height:56px;
      background:#fff;
      border-bottom:1px solid var(--border);
      position:relative;
      z-index:101;
    }
    .hm-header .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:0 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .hm-brand{
      font-size:24px;
      font-weight:800;
      color:var(--accent);
      text-decoration:none;
    }
    .hamburger{
      display:inline-grid;
      place-items:center;
      width:36px;
      height:36px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      color:#374151;
      cursor:pointer;
    }
    .right{
      display:flex;
      align-items:center;
      gap:14px;
    }
    .hm-icon svg{width:26px;height:26px;stroke-width:2}

    .hm-btn-primary{
      background:var(--accent);
      color:#fff;
      border:1px solid var(--accent);
      border-radius:999px;
      padding:10px 18px;
      font-weight:700;
      text-decoration:none;
      box-shadow:0 2px 8px rgba(153,27,27,.25);
    }

    /* MENU */
    .sheet{
      position:fixed;
      inset:0 auto 0 0;
      width:min(84vw,340px);
      background:#fff;
      border-right:1px solid var(--border);
      transform:translateX(-100%);
      transition:transform .25s ease;
      z-index:100;
      display:flex;
      flex-direction:column;
    }
    .sheet.open{transform:translateX(0);}
    #sheetOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.25);
      display:none;
      z-index:90;
    }
    #sheetOverlay.show{display:block}

    /* PAGE LAYOUT */
    main.wrap{
      max-width:1200px;
      margin:18px auto 28px;
      padding:0 12px;
    }
    .toprow{
      display:grid;
      grid-template-columns:minmax(0,1.2fr) minmax(0,420px);
      gap:14px;
      align-items:flex-start;
    }
    @media(max-width:960px){
      .toprow{grid-template-columns:1fr;}
    }

    /* MEDIA */
    .media{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
    }
    .hero{
      width:100%;
      aspect-ratio:4/3;
      object-fit:cover;
      background:#111827;
    }
    .thumbs{
      display:flex;
      gap:10px;
      padding:10px;
      border-top:1px solid var(--border);
      overflow-x:auto;
    }
    .thumb{
      width:74px;
      height:54px;
      border-radius:10px;
      border:2px solid transparent;
      overflow:hidden;
      flex:0 0 auto;
      cursor:pointer;
    }
    .thumb.active{border-color:var(--accent);}

    /* BUY BOX */
    .buy{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      position:sticky;
      top:78px;
    }
    .title{font-weight:800;font-size:18px;margin:0 0 2px;}
    .price-line{font-size:20px;font-weight:800;}
    .peryd{color:#6b7280;font-size:12px;margin-left:6px;}
    .strike{color:#9ca3af;text-decoration:line-through;margin-left:6px;font-size:13px;}
    .seller-name{font-weight:700;color:#111;}

    /* SPECS */
    .spec-table th,
    .spec-table td{
      padding:6px 4px;
      border-bottom:1px solid #f3f4f6;
      font-size:13px;
    }

    /* Q&A */
    .qa-list{
      border:1px solid #e5e7eb;
      border-radius:10px;
      background:#f9fafb;
      padding:10px;
      max-height:260px;
      overflow-y:auto;
    }
    .qa-item{padding:6px 4px;border-bottom:1px solid #ddd;}
    .qa-item:last-child{border-bottom:0;}
  </style>
</head>
<body>

<!-- HEADER -->
<header class="hm-header">
  <div class="wrap">
    <div class="left">
      <button id="openMenu" class="hamburger">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="4" y1="6"  x2="20" y2="6"/>
          <line x1="4" y1="12" x2="20" y2="12"/>
          <line x1="4" y1="18" x2="20" y2="18"/>
        </svg>
      </button>
      <a class="hm-brand" href="index.html">Hemline Market</a>
    </div>

    <div class="right">
      <a class="hm-icon" href="browse.html">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.3-4.3"/></svg>
      </a>
      <a class="hm-icon" href="ThreadTalk.html">
        <svg viewBox="0 0 24 24"><path d="M4 6.5A4.5 4.5 0 0 1 8.5 2h7A4.5 4.5 0 0 1 20 6.5v5A4.5 4.5 0 0 1 15.5 16H12l-4 4v-4H8.5A4.5 4.5 0 0 1 4 11.5z"/></svg>
      </a>
      <a class="hm-icon" href="favorites.html">
        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/></svg>
      </a>
      <a class="hm-icon" href="notifications.html">
        <svg viewBox="0 0 24 24"><path d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      </a>
      <a class="hm-icon" href="cart.html">
        <svg viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="18" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
      </a>

      <a class="hm-btn-primary" href="sell.html">Sell</a>
    </div>
  </div>
</header>

<div id="sheetOverlay"></div>

<aside class="sheet" id="menuSheet">
  <header>
    <strong>Menu</strong>
    <button class="close" id="closeMenu">✕</button>
  </header>
  <nav>
    <a href="account.html">Account</a>
    <a href="atelier.html">My Atelier</a>
    <a href="how.html">How It Works</a>
    <a href="sell.html">Sell Fabric</a>
    <a href="ThreadTalk.html">ThreadTalk</a>
    <a href="contact.html">Contact</a>
  </nav>
</aside>

<!-- MAIN -->
<main class="wrap">
  <div class="toprow">

    <!-- MEDIA -->
    <section>
      <article class="media">
        <img id="hero" class="hero" src="" alt="Fabric photo">
        <div class="thumbs" id="thumbs"></div>
      </article>
    </section>

    <!-- BUY BOX -->
    <aside class="buy">
      <h1 class="title" id="tTitle">Loading…</h1>
      <div class="price-line" id="tPrice"></div>
      <div class="status-row" id="tStatus"></div>

      <div class="cta">
        <button id="addToCart" class="btn btn-primary">Add to Cart</button>
        <button class="btn">Save</button>
      </div>

      <div class="mini-note">
        Seller ships within <strong>5 business days</strong> • Buyer Protection
      </div>

      <section class="specs">
        <h3>Specs</h3>
        <table class="spec-table" id="specTable"></table>
      </section>

      <div style="margin-top:14px;border-top:1px dashed #ddd;padding-top:10px;">
        <strong class="seller-name" id="sellerName">Seller</strong>
        <div id="sellerStore" style="font-size:12px;color:#6b7280;"></div>
      </div>
    </aside>
  </div>

  <!-- DESCRIPTION -->
  <article class="card" style="margin-top:12px">
    <h3>Description</h3>
    <p id="descText" class="desc-text"></p>
  </article>

  <!-- Q&A -->
  <article class="card" style="margin-top:12px">
    <h3>Q&A</h3>
    <div id="qaList" class="qa-list"></div>
    <div class="qa-form" style="margin-top:10px;">
      <textarea id="qaInput" placeholder="Have a question about this fabric?"></textarea>
      <div class="row">
        <button class="btn btn-primary" id="qaSubmit">Post question</button>
      </div>
    </div>
  </article>
</main>

<footer class="hm-footer">
  <div class="footer-wrap">
    <div class="copy">© 2025 Hemline Market</div>
    <nav class="footer-links">
      <a href="about.html">About</a>
      <a href="faq.html">FAQ</a>
      <a href="contact.html">Contact</a>
      <a href="terms.html">Terms</a>
      <a href="privacy.html">Privacy</a>
    </nav>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseClient = window.supabase.createClient(
  "https://clkizksbvxjkoatdajgd.supabase.co",
  "eyJhbGciOiJIUzI1NiIs..."
);

// Choose store > full name > display name > email handle
function profileName(p, email){
  if(!p){
    if(email) return email.split("@")[0];
    return "Member";
  }
  if(p.store_name) return p.store_name;
  if(p.first_name || p.last_name) return (p.first_name+" "+p.last_name).trim();
  if(p.display_name) return p.display_name;
  if(email) return email.split("@")[0];
  return "Member";
}

document.addEventListener("DOMContentLoaded", init);

async function init(){
  const id = new URLSearchParams(location.search).get("id");
  if(!id){ document.getElementById("tTitle").textContent="Not found"; return; }

  const { data: listing } = await supabaseClient.from("listings").select("*").eq("id", id).maybeSingle();
  if(!listing){ document.getElementById("tTitle").textContent="Not found"; return; }

  const sellerId = listing.seller_id;
  let sellerProfile = null;
  if(sellerId){
    const { data } = await supabaseClient.from("profiles")
      .select("store_name,first_name,last_name,display_name")
      .eq("id", sellerId)
      .maybeSingle();
    sellerProfile = data;
  }

  renderListing(listing, sellerProfile);
  loadQuestions(listing, sellerProfile);

  document.getElementById("qaSubmit").onclick = async () => {
    const input = document.getElementById("qaInput");
    const body = input.value.trim();
    if(!body) return;

    const { data:{ session }} = await supabaseClient.auth.getSession();
    if(!session){ location.href="auth.html?view=login"; return; }

    await supabaseClient.from("listing_questions").insert({
      listing_id: listing.id,
      author_id: session.user.id,
      body
    });

    input.value="";
    loadQuestions(listing, sellerProfile);
  };
}

function renderListing(l, sellerProfile){
  document.getElementById("tTitle").textContent = l.title;

  // price
  const price = (l.price_cents/100).toFixed(2);
  const yards = l.yards;
  const per = l.price_per_yard_cents ? (l.price_per_yard_cents/100).toFixed(2) : null;
  const orig = l.orig_price_per_yard_cents ? (l.orig_price_per_yard_cents/100).toFixed(2) : null;

  let line = `$${price} for ${yards} yards`;
  if(per) line += ` <span class="peryd">$${per}/yard</span>`;
  if(orig) line += ` <span class="strike">$${orig}/yard</span>`;
  document.getElementById("tPrice").innerHTML = line;

  document.getElementById("tStatus").textContent =
    (l.status || "Published") + (l.is_archived ? " • inactive" : " • active");

  document.getElementById("descText").textContent = l.description || "";

  // specs
  const specs = [
    ["Content", l.content],
    ["Fabric", l.fabric_type],
    ["Color", l.color],
    ["Pattern", l.pattern],
    ["Width", l.width_in ? l.width_in+"″" : ""],
    ["Weight", l.weight_gsm ? l.weight_gsm+" GSM" : ""],
    ["Origin", l.origin],
    ["Designer / Mill", l.designer],
    ["Fiber type", l.fiber_type],
    ["Feels like", l.feels_like]
  ];

  const specTable = document.getElementById("specTable");
  specTable.innerHTML = "";
  specs.forEach(([label,val])=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<th>${label}</th><td>${val||"—"}</td>`;
    specTable.appendChild(tr);
  });

  // seller name
  const name = profileName(sellerProfile, l.seller_email);
  document.getElementById("sellerName").textContent = name;
  document.getElementById("sellerStore").textContent = sellerProfile?.store_name || "";

  // photos
  const hero = document.getElementById("hero");
  const thumbs = document.getElementById("thumbs");

  const photos = (l.photo_urls && l.photo_urls.length) ? l.photo_urls : [l.primary_photo_url];
  hero.src = photos[0] || "";

  thumbs.innerHTML = "";
  photos.forEach((p,i)=>{
    const btn = document.createElement("button");
    btn.className = "thumb"+(i===0?" active":"");
    btn.innerHTML = `<img src="${p}">`;
    btn.onclick = ()=>{
      hero.src = p;
      thumbs.querySelectorAll(".thumb").forEach(t=>t.classList.remove("active"));
      btn.classList.add("active");
    };
    thumbs.appendChild(btn);
  });
}

async function loadQuestions(listing, sellerProfile){
  const { data: qs } = await supabaseClient
    .from("listing_questions")
    .select("*")
    .eq("listing_id", listing.id)
    .order("created_at",{ascending:true});

  const qaList = document.getElementById("qaList");
  qaList.innerHTML = "";

  if(!qs.length){
    qaList.innerHTML = `<p style="color:#888;font-size:13px;">No questions yet.</p>`;
    return;
  }

  const ids = qs.map(q=>q.author_id).concat(qs.map(q=>q.answer_author_id)).filter(Boolean);
  const { data: profiles } = await supabaseClient
    .from("profiles")
    .select("id,store_name,first_name,last_name,display_name")
    .in("id", ids);

  const map = {};
  profiles?.forEach(p=>{ map[p.id]=p; });

  qs.forEach(q=>{
    const asker = profileName(map[q.author_id], q.author_email);
    const wrap = document.createElement("div");
    wrap.className="qa-item";

    wrap.innerHTML = `
      <div style="font-size:12px;color:#666;">
        <strong>${asker}</strong> · ${new Date(q.created_at).toLocaleDateString()}
      </div>
      <div style="margin-top:4px;font-size:13px;">${q.body}</div>
    `;

    if(q.answer_body){
      const ansName = profileName(map[q.answer_author_id] || sellerProfile, "");
      wrap.innerHTML += `
        <div style="margin-top:8px;padding-left:10px;border-left:2px solid #ddd;">
          <div style="font-size:12px;color:#666;"><strong>${ansName}</strong> · Seller</div>
          <div style="font-size:13px;margin-top:2px;">${q.answer_body}</div>
        </div>
      `;
    }

    qaList.appendChild(wrap);
  });
}
</script>

<script src="assets/add-to-cart.js" defer></script>

</body>
</html>
