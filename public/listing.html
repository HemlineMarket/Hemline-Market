<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Listing — Hemline Market</title>

  <!-- CSS STACK -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>

  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#991b1b;
      --bg:#ffffff;
      --page:#fafafa;
    }

    html,body{
      margin:0;
      background:var(--page);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }

    main{
      max-width:1100px;
      margin:24px auto;
      padding:0 16px;
      display:flex;
      gap:32px;
    }

    .img-box img{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      object-fit:cover;
    }

    .details h1{
      margin:0 0 8px;
      font-size:28px;
      font-weight:800;
    }

    .price{
      font-size:20px;
      font-weight:700;
      margin:12px 0;
    }

    .meta{
      font-size:14px;
      color:var(--muted);
      margin-bottom:8px;
      white-space:pre-line;
    }

    label{
      display:block;
      margin-top:12px;
      font-size:14px;
      color:var(--muted);
    }

    input{
      margin-top:6px;
      width:90px;
      padding:6px;
      border-radius:8px;
      border:1px solid var(--border);
      font-size:14px;
    }

    .btn-buy{
      margin-top:20px;
      display:inline-block;
      padding:10px 18px;
      border:none;
      border-radius:999px;
      font-size:15px;
      font-weight:700;
      cursor:pointer;
      background:var(--accent);
      color:#fff;
      text-decoration:none;
    }

    .btn-buy[disabled]{
      opacity:0.6;
      cursor:not-allowed;
    }

    .status-pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      border:1px solid var(--border);
      color:var(--muted);
      margin-top:4px;
    }

    .status-pill.sold{
      border-color:#b91c1c;
      color:#b91c1c;
      background:#fef2f2;
    }

    .sold-note{
      margin-top:10px;
      font-size:13px;
      color:#b45309;
    }

    .error{
      font-size:16px;
      font-weight:600;
      color:#b91c1c;
      margin-top:8px;
    }

    @media (max-width:768px){
      main{
        flex-direction:column;
      }
    }
  </style>
</head>

<body>
  <div id="hm-shell-header"></div>

  <main id="maincontent">
    <!-- LEFT: IMAGE -->
    <div class="img-box">
      <img id="listingImage" src="" alt="Fabric listing"/>
    </div>

    <!-- RIGHT: DETAILS -->
    <div class="details">
      <h1 id="listingTitle">Loading…</h1>
      <div id="listingPrice" class="price"></div>
      <div id="listingStatus"></div>
      <div id="listingMeta" class="meta"></div>

      <div id="purchaseControls">
        <label for="yardsInput">Yards</label>
        <input id="yardsInput" type="number" min="1" value="1"/>

        <button class="btn-buy" id="buyBtn" onclick="startCheckout()">
          Purchase This Fabric
        </button>
      </div>

      <div id="soldNote" class="sold-note" style="display:none;"></div>
      <div id="errorMsg" class="error" style="display:none;"></div>
    </div>
  </main>

  <div id="hm-shell-footer"></div>

  <!-- JS STACK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="scripts/hm-shell.js"></script>
  <script src="scripts/cart.js"></script>

  <script>
    window.addEventListener("DOMContentLoaded", async () => {
      // Render header/footer + get Supabase client
      if (window.HM && typeof window.HM.renderShell === "function") {
        window.HM.renderShell({ currentPage: "" });
      }

      const supabase = window.HM && window.HM.supabase;
      const titleEl = document.getElementById("listingTitle");
      const priceEl = document.getElementById("listingPrice");
      const statusEl = document.getElementById("listingStatus");
      const metaEl = document.getElementById("listingMeta");
      const imgEl = document.getElementById("listingImage");
      const buyBtn = document.getElementById("buyBtn");
      const purchaseControls = document.getElementById("purchaseControls");
      const soldNoteEl = document.getElementById("soldNote");
      const errorMsgEl = document.getElementById("errorMsg");

      if (!supabase) {
        titleEl.textContent = "Listing unavailable.";
        errorMsgEl.style.display = "block";
        errorMsgEl.textContent = "We couldn’t connect to the database.";
        if (purchaseControls) purchaseControls.style.display = "none";
        return;
      }

      const params = new URLSearchParams(window.location.search);
      const listingId = params.get("id");

      if (!listingId) {
        titleEl.textContent = "Listing not found.";
        errorMsgEl.style.display = "block";
        errorMsgEl.textContent = "Missing listing id in the URL.";
        if (purchaseControls) purchaseControls.style.display = "none";
        return;
      }

      async function loadListing() {
        const { data, error } = await supabase
          .from("listings")
          .select("*")
          .eq("id", listingId)
          .maybeSingle();

        if (error || !data) {
          console.error("[listing] load error:", error || "no data");
          titleEl.textContent = "Listing not found.";
          errorMsgEl.style.display = "block";
          errorMsgEl.textContent =
            "This listing may have been removed by the seller.";
          if (purchaseControls) purchaseControls.style.display = "none";
          return;
        }

        // Basic fields
        const title =
          data.title || data.name || "Fabric listing";
        const pricePerYard = Number(data.price_cents || 0) / 100;
        const currency = data.currency || "USD";

        titleEl.textContent = title;
        priceEl.textContent = pricePerYard
          ? `$${pricePerYard.toFixed(2)} per yard`
          : "";

        if (data.image_url) {
          imgEl.src = data.image_url;
        } else {
          imgEl.removeAttribute("src");
        }

        // Optional meta (width, fiber, etc. if you add later)
        const metaLines = [];
        if (data.width) metaLines.push(`Width: ${data.width}`);
        if (data.content) metaLines.push(`Content: ${data.content}`);
        if (data.color) metaLines.push(`Color: ${data.color}`);
        metaEl.textContent = metaLines.join("\n");

        // Status pill
        const status = (data.status || "").toUpperCase();
        if (status === "SOLD") {
          statusEl.innerHTML =
            '<span class="status-pill sold">Sold</span>';
          if (purchaseControls) purchaseControls.style.display = "none";
          soldNoteEl.style.display = "block";
          soldNoteEl.textContent =
            "This fabric has been sold. You can still view this page from your Purchases and Sales history.";
        } else {
          statusEl.innerHTML =
            '<span class="status-pill">Available</span>';
          soldNoteEl.style.display = "none";
        }

        // Expose id on window so cart logic can use it if needed
        window.currentListingId = data.id;
      }

      await loadListing();

      // Checkout handler – kept global because of the onclick on the button.
      window.startCheckout = function startCheckout() {
        const yardsInput = document.getElementById("yardsInput");
        const yards = Number((yardsInput && yardsInput.value) || 1);

        if (!window.currentListingId) {
          alert("We couldn’t find this listing. Please refresh and try again.");
          return;
        }

        if (!window.HM || typeof window.HM.addToCart !== "function") {
          alert("Cart is not available right now. Please refresh and try again.");
          return;
        }

        const safeYards = Math.max(1, Math.floor(yards || 1));
        yardsInput.value = safeYards;

        // This only adds to cart; it does NOT delete or change the listing.
        window.HM.addToCart(window.currentListingId, safeYards);
      };
    });
  </script>
</body>
</html>
