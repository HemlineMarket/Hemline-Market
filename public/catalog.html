<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hemline Market — Catalog</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    :root {
      --gap:14px; --border:#e5e7eb; --muted:#6b7280; --ink:#111827; --bg:#ffffff; --brand:#111827;
      --soft:#f8fafc; --hover:#f1f5f9; --accent:#111827;
    }
    * { box-sizing:border-box; }
    body { margin:0; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; color:var(--ink); background:var(--bg); }

    /* Top Navbar */
    .nav { position:sticky; top:0; z-index:20; background:#fff; border-bottom:1px solid var(--border); }
    .nav-inner { max-width:1100px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; gap:14px; }
    .brand { font-weight:800; letter-spacing:.2px; color:var(--brand); text-decoration:none; font-size:18px; }
    .nav-search { flex:1; }
    .nav-search input { width:100%; padding:9px 12px; border:1px solid var(--border); border-radius:999px; }
    .nav-links { display:flex; gap:12px; align-items:center; }
    .link-btn { position:relative; padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:#fff; text-decoration:none; color:var(--ink); }
    .link-btn:hover { background:var(--hover); }
    .link-btn::after { content:""; position:absolute; left:14px; right:14px; bottom:6px; height:2px; background:#0000; transition:background .2s; }
    .link-btn:hover::after { background:#1112; }
    .link-cta { background:var(--brand); color:#fff; border-color:var(--brand); }
    .link-cta:hover { filter:brightness(0.95); }

    /* Filters row */
    header.filt { position:sticky; top:58px; z-index:10; background:#fff; border-bottom:1px solid var(--border); }
    .wrap { max-width:1100px; margin:0 auto; padding:12px 16px; }
    .controls { display:grid; grid-template-columns:1fr repeat(10, minmax(150px, 220px)); gap:var(--gap); align-items:end; }
    @media (max-width:1150px){ .controls { grid-template-columns:1fr 1fr; } }
    .control { display:flex; flex-direction:column; gap:6px; }
    .muted { color:var(--muted); }
    input, select, button { border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:#fff; transition:box-shadow .15s, background .15s; }
    input:hover, select:hover, button:hover { background:linear-gradient(#fff, #fdfefe); box-shadow:0 0 0 3px #00000007 inset; }
    button { cursor:pointer; }
    .btn { padding:9px 14px; }
    .btn.primary { background:var(--brand); color:#fff; border-color:var(--brand); }
    .btn.primary:hover { filter:brightness(0.95); }

    /* Dropdowns */
    .dropdown { position:relative; }
    .dropdown-btn { display:flex; align-items:center; gap:8px; justify-content:space-between; min-height:38px; }
    .dropdown-panel { position:absolute; top:calc(100% + 6px); left:0; min-width:520px; max-width:720px; max-height:320px; overflow:auto;
      border:1px solid var(--border); border-radius:12px; background:#fff; box-shadow:0 10px 24px rgba(0,0,0,.08); padding:10px; display:none; }
    .dropdown.open .dropdown-panel { display:block; }
    .d-search { width:100%; margin-bottom:8px; }
    .d-list { display:flex; flex-wrap:wrap; gap:8px 10px; }
    .d-list.colors { display:grid; grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); gap:8px 10px; }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; user-select:none; cursor:pointer; }
    .chip input { appearance:none; width:14px; height:14px; border-radius:999px; border:1px solid var(--border); display:inline-block; position:relative; }
    .chip input:checked { background:#111827; border-color:#111827; }
    .chip .swatch { width:12px; height:12px; border-radius:999px; border:1px solid rgba(0,0,0,.15); }
    .tags { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
    .tag { background:var(--ink); color:#fff; padding:3px 8px; border-radius:999px; font-size:12px; }
    .count-pill { background:#f3f4f6; color:#374151; padding:2px 8px; border-radius:999px; font-size:12px; }

    /* Dual-range slider */
    .range { padding:6px 0 2px; }
    .range-row { display:flex; align-items:center; gap:8px; }
    .range-track { position:relative; height:28px; flex:1; }
    .range-track input[type=range] {
      position:absolute; left:0; right:0; top:8px; height:10px; margin:0;
      -webkit-appearance:none; appearance:none; background:transparent; pointer-events:auto;
      width:100%;
    }
    .track-bg { position:absolute; left:0; right:0; top:12px; height:6px; background:#e5e7eb; border-radius:999px; }
    .track-fill { position:absolute; top:12px; height:6px; background:var(--accent); border-radius:999px; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; appearance:none; width:16px; height:16px; background:var(--accent); border-radius:50%; border:2px solid #fff; box-shadow:0 0 0 1px #0002; cursor:pointer; position:relative; z-index:2; }
    input[type=range]::-moz-range-thumb { width:16px; height:16px; background:var(--accent); border:none; border-radius:50%; box-shadow:0 0 0 1px #0002; cursor:pointer; position:relative; z-index:2; }
    input[type=range]::-webkit-slider-runnable-track { height:6px; background:transparent; }
    input[type=range]::-moz-range-track { height:6px; background:transparent; }

    main { padding:18px 16px 40px; }
    .grid { display:grid; grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) ); gap:var(--gap); }
    .card { border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.03); transition:transform .12s ease, box-shadow .12s ease; }
    .card:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.08); }
    .thumb { aspect-ratio:4/3; display:flex; align-items:center; justify-content:center; color:#6b7280; font-size:12px; }
    .body { padding:12px; display:flex; flex-direction:column; gap:6px; }
    .title { font-weight:600; }
    .spacer { flex:1; }
    .empty { border:1px dashed var(--border); border-radius:12px; padding:30px; text-align:center; color:var(--muted); }
    .countline { color:#111; font-weight:700; letter-spacing:.2px; }
  </style>
</head>
<body>

  <!-- Global Navbar -->
  <div class="nav">
    <div class="nav-inner">
      <a class="brand" href="/index.html">hemlinemarket</a>
      <div class="nav-search"><input id="globalSearch" placeholder="Search fabrics…"></div>
      <div class="nav-links">
        <a class="link-btn" href="/favorites.html">Likes</a>
        <a class="link-btn" href="/news.html">News</a>
        <a class="link-btn" href="/profile.html">Profile</a>
        <a class="link-btn link-cta" href="/sell.html">List an item</a>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <header class="filt">
    <div class="wrap">
      <div class="controls">

        <div class="control" style="grid-column:1 / -1;">
          <label class="muted">Search (title or fabric content)</label>
          <input id="q" placeholder="e.g. wool, silk, lawn" />
        </div>

        <div class="control">
          <label class="muted">Sort</label>
          <select id="sort">
            <option value="newest">Newest</option>
            <option value="price_asc">Price: Low → High</option>
            <option value="price_desc">Price: High → Low</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Stretch</label>
          <select id="stretch">
            <option value="any">Any</option>
            <option value="true">Stretch</option>
            <option value="false">No Stretch</option>
          </select>
        </div>

        <!-- Weight slider -->
        <div class="control">
          <label class="muted">Weight (gsm)</label>
          <div class="range" id="rngWeight">
            <div class="range-row">
              <input id="wmin" type="number" min="0" placeholder="min" style="width:86px">
              <div class="range-track">
                <div class="track-bg"></div>
                <div class="track-fill"></div>
                <input type="range" min="0" max="500" value="0">
                <input type="range" min="0" max="500" value="500">
              </div>
              <input id="wmax" type="number" min="0" placeholder="max" style="width:86px">
            </div>
          </div>
        </div>

        <!-- Width slider -->
        <div class="control">
          <label class="muted">Width (in)</label>
          <div class="range" id="rngWidth">
            <div class="range-row">
              <input id="widthMin" type="number" min="0" placeholder="min" style="width:86px">
              <div class="range-track">
                <div class="track-bg"></div>
                <div class="track-fill"></div>
                <input type="range" min="30" max="80" value="30">
                <input type="range" min="30" max="80" value="80">
              </div>
              <input id="widthMax" type="number" min="0" placeholder="max" style="width:86px">
            </div>
          </div>
        </div>

        <!-- Price slider -->
        <div class="control">
          <label class="muted">Price (USD)</label>
          <div class="range" id="rngPrice">
            <div class="range-row">
              <input id="pmin" type="number" min="0" placeholder="min" style="width:86px">
              <div class="range-track">
                <div class="track-bg"></div>
                <div class="track-fill"></div>
                <input type="range" min="0" max="200" value="0">
                <input type="range" min="0" max="200" value="200">
              </div>
              <input id="pmax" type="number" min="0" placeholder="max" style="width:86px">
            </div>
          </div>
        </div>

        <!-- Fabric Type dropdown (visible & working) -->
        <div class="control dropdown" id="fabricDD">
          <label class="muted">Fabric Type</label>
          <button class="dropdown-btn" id="fabricBtn">
            <span id="fabricBtnText">Select fabric types</span>
            <span id="fabricCount" class="count-pill" style="display:none;">0</span>
          </button>
          <div class="dropdown-panel" id="fabricPanel">
            <input id="fabricSearch" class="d-search" placeholder="Search types…" />
            <div id="fabricList" class="d-list"></div>
          </div>
          <div id="fabricTags" class="tags"></div>
        </div>

        <!-- Color dropdown (visible & working) -->
        <div class="control dropdown" id="colorDD">
          <label class="muted">Color</label>
          <button class="dropdown-btn" id="colorBtn">
            <span id="colorBtnText">Select colors</span>
            <span id="colorCount" class="count-pill" style="display:none;">0</span>
          </button>
          <div class="dropdown-panel" id="colorPanel">
            <input id="colorSearch" class="d-search" placeholder="Search colors…" />
            <div id="colorList" class="d-list colors"></div>
          </div>
          <div id="colorTags" class="tags"></div>
        </div>

        <div class="control">
          <label class="muted">Condition</label>
          <select id="condition">
            <option value="any">Any</option>
            <option value="new">New</option>
            <option value="washed">Washed (pre-shrunk)</option>
            <option value="used">Used</option>
            <option value="vintage">Vintage</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Department</label>
          <select id="department">
            <option value="any">Any</option>
            <option value="fashion">Fashion fabric</option>
            <option value="quilting">Quilting fabric</option>
            <option value="home">Home fabric</option>
            <option value="notions">Notions</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Country of origin</label>
          <select id="country">
            <option value="any">Any</option>
            <option>China</option><option>France</option><option>India</option><option>Italy</option>
            <option>Japan</option><option>Turkey</option><option>USA</option><option value="other">Other</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Designer</label>
          <input id="designer" placeholder="e.g. Liberty, Mood, Joann" />
        </div>

        <div class="control" style="align-self:center;">
          <button class="btn" id="reset">Reset</button>
        </div>
        <div class="control" style="align-self:center;">
          <button class="btn primary" id="apply">Apply Filters</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div id="count" class="countline" style="margin-bottom:10px;">✨ Loading… ✨</div>
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">No fabrics match your filters.</div>
    </div>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.3";

    /* ------------ Supabase ------------ */
    const SUPABASE_URL  = "https://clkizksbvxjkoatdajgd.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    /* ------------ DOM refs ------------ */
    const globalSearch = document.getElementById('globalSearch');
    const qEl = document.getElementById('q');
    const sortEl = document.getElementById('sort');
    const stretchEl = document.getElementById('stretch');
    const wminEl = document.getElementById('wmin'); const wmaxEl = document.getElementById('wmax');
    const widthMinEl = document.getElementById('widthMin'); const widthMaxEl = document.getElementById('widthMax');
    const pminEl = document.getElementById('pmin'); const pmaxEl = document.getElementById('pmax');
    const conditionEl = document.getElementById('condition');
    const departmentEl = document.getElementById('department');
    const countryEl = document.getElementById('country');
    const designerEl = document.getElementById('designer');
    const gridEl = document.getElementById('grid');
    const emptyEl = document.getElementById('empty');
    const countEl = document.getElementById('count');

    /* ------------ Navbar search → main search ------------ */
    globalSearch.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ qEl.value = globalSearch.value; query(); } });

    /* ------------ Dual-range slider wiring ------------ */
    function wireDualRange(containerId, minInput, maxInput, opts){
      const el = document.getElementById(containerId);
      const [r1, r2] = el.querySelectorAll('input[type=range]');
      const fill = el.querySelector('.track-fill');
      const minBound = +r1.min, maxBound = +r1.max;
      const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
      const syncFill = ()=>{
        const a = Math.min(+r1.value, +r2.value), b = Math.max(+r1.value, +r2.value);
        const pctA = 100*(a-minBound)/(maxBound-minBound);
        const pctB = 100*(b-minBound)/(maxBound-minBound);
        fill.style.left = pctA + '%';
        fill.style.width = (pctB - pctA) + '%';
        minInput.value = a === minBound ? '' : a;
        maxInput.value = b === maxBound ? '' : b;
      };
      const syncFromInputs = ()=>{
        const a = clamp(minInput.value===''?minBound:+minInput.value, minBound, maxBound);
        const b = clamp(maxInput.value===''?maxBound:+maxInput.value, minBound, maxBound);
        r1.value = Math.min(a,b);
        r2.value = Math.max(a,b);
        syncFill();
      };
      r1.addEventListener('input', ()=>{ if(+r1.value>+r2.value) r1.value = r2.value; syncFill(); });
      r2.addEventListener('input', ()=>{ if(+r2.value<+r1.value) r2.value = r1.value; syncFill(); });
      minInput.addEventListener('change', syncFromInputs);
      maxInput.addEventListener('change', syncFromInputs);
      // Initialize to bounds
      minInput.placeholder = `e.g. ${opts.placeholderMin}`;
      maxInput.placeholder = `e.g. ${opts.placeholderMax}`;
      r1.value = minBound; r2.value = maxBound; syncFill();
      return { syncFromInputs, reset: ()=>{ r1.value=minBound; r2.value=maxBound; minInput.value=''; maxInput.value=''; syncFill(); } };
    }

    const rngWeight = wireDualRange('rngWeight', wminEl, wmaxEl, { placeholderMin: 60, placeholderMax: 300 });
    const rngWidth  = wireDualRange('rngWidth',  widthMinEl, widthMaxEl, { placeholderMin: 44, placeholderMax: 60 });
    const rngPrice  = wireDualRange('rngPrice',  pminEl,    pmaxEl,    { placeholderMin: 10, placeholderMax: 80 });

    /* ------------ Fabric Type dropdown (alphabetical + “other” last) ------------ */
    const FABRIC_TOKENS_UNSORTED = [
      'cotton','wool','silk','linen','denim','chiffon','crepe','jersey','satin','twill','canvas','lace','velvet',
      'rayon','viscose','modal','tencel','lyocell','polyester','nylon','acrylic'
    ];
    const ALL_FABRICS = [...FABRIC_TOKENS_UNSORTED].map(s=>s.toLowerCase()).sort((a,b)=>a.localeCompare(b)).concat('other');
    const FABRIC_TOKENS = FABRIC_TOKENS_UNSORTED.map(x=>x.toLowerCase());

    const fabricState = new Set();
    const fabricDD = document.getElementById('fabricDD');
    const fabricBtn = document.getElementById('fabricBtn');
    const fabricBtnText = document.getElementById('fabricBtnText');
    const fabricBtnCount = document.getElementById('fabricCount');
    const fabricList = document.getElementById('fabricList');
    const fabricTags = document.getElementById('fabricTags');
    const fabricSearch = document.getElementById('fabricSearch');

    function renderFabricList(filter=''){
      const term=filter.trim().toLowerCase();
      fabricList.innerHTML='';
      ALL_FABRICS.filter(k=>!term||k.includes(term)).forEach(k=>{
        const row=document.createElement('label'); row.className='chip';
        row.innerHTML=`<input type="checkbox" ${fabricState.has(k)?'checked':''}><span>${k}</span>`;
        row.querySelector('input').onchange=(e)=>{ if(e.target.checked) fabricState.add(k); else fabricState.delete(k); syncFabricUI(); };
        fabricList.appendChild(row);
      });
    }
    function syncFabricUI(){
      const vals=[...fabricState];
      fabricTags.innerHTML = vals.map(v=>`<span class="tag">${v}</span>`).join('');
      if(vals.length===0){ fabricBtnText.textContent='Select fabric types'; fabricBtnCount.style.display='none'; }
      else { fabricBtnText.textContent='Fabric Type'; fabricBtnCount.style.display='inline-flex'; fabricBtnCount.textContent=vals.length; }
      renderFabricList(fabricSearch.value||'');
    }
    fabricBtn.onclick=()=>fabricDD.classList.toggle('open');
    document.addEventListener('click',(e)=>{ if(!fabricDD.contains(e.target)) fabricDD.classList.remove('open'); });
    fabricSearch.addEventListener('input',()=>renderFabricList(fabricSearch.value));
    renderFabricList(); syncFabricUI();

    /* ------------ Color dropdown (swatches + wrapped grid) ------------ */
    const COLOR_META = [
      ['beige',  '#e7d7b5'],
      ['black',  '#111827'],
      ['blue',   '#3b82f6'],
      ['brown',  '#8b5a2b'],
      ['gray',   '#9ca3af'],
      ['green',  '#22c55e'],
      ['orange', '#fb923c'],
      ['pink',   '#f472b6'],
      ['purple', '#a78bfa'],
      ['red',    '#ef4444'],
      ['white',  '#ffffff'],
      ['yellow', '#f59e0b'],
    ].sort((a,b)=>a[0].localeCompare(b[0]));
    const colorState = new Set();
    const colorDD = document.getElementById('colorDD');
    const colorBtn = document.getElementById('colorBtn');
    const colorBtnText = document.getElementById('colorBtnText');
    const colorBtnCount = document.getElementById('colorCount');
    const colorList = document.getElementById('colorList');
    const colorTags = document.getElementById('colorTags');
    const colorSearch = document.getElementById('colorSearch');

    function renderColorList(filter=''){
      const term=filter.trim().toLowerCase();
      colorList.innerHTML='';
      COLOR_META.filter(([k])=>!term||k.includes(term)).forEach(([k,hex])=>{
        const row=document.createElement('label'); row.className='chip';
        row.innerHTML=`<span class="swatch" style="background:${hex}"></span><input type="checkbox" ${colorState.has(k)?'checked':''}><span>${k}</span>`;
        row.querySelector('input').onchange=(e)=>{ if(e.target.checked) colorState.add(k); else colorState.delete(k); syncColorUI(); };
        colorList.appendChild(row);
      });
    }
    function syncColorUI(){
      const vals=[...colorState];
      colorTags.innerHTML = vals.map(v=>{
        const hex = (COLOR_META.find(([k])=>k===v)||[])[1] || '#111827';
        return `<span class="tag" style="background:${hex}; color:${v==='white'?'#111':''}">${v}</span>`;
      }).join('');
      if(vals.length===0){ colorBtnText.textContent='Select colors'; colorBtnCount.style.display='none'; }
      else { colorBtnText.textContent='Color'; colorBtnCount.style.display='inline-flex'; colorBtnCount.textContent=vals.length; }
      renderColorList(colorSearch.value||'');
    }
    colorBtn.onclick=()=>colorDD.classList.toggle('open');
    document.addEventListener('click',(e)=>{ if(!colorDD.contains(e.target)) colorDD.classList.remove('open'); });
    colorSearch.addEventListener('input',()=>renderColorList(colorSearch.value));
    renderColorList(); syncColorUI();

    /* ------------ Cards & query ------------ */
    const colorHex = (name)=> (COLOR_META.find(([k])=>k===name)||[])[1] || '#e5e7eb';
    function dollars(c){ return (c/100).toLocaleString(undefined,{style:'currency',currency:'USD'}); }
    function placeholderStyle(cname){
      const base = colorHex((cname||'').toLowerCase());
      return `background:
        radial-gradient(circle at 30% 30%, #ffffff80 0%, #ffffff00 40%),
        repeating-linear-gradient(45deg, #ffffff10 0px, #ffffff10 4px, #0000000b 4px, #0000000b 8px),
        ${base};`;
    }
    function card(item){
      const t = item.thumbnail_url
        ? `<img class="thumb" src="${item.thumbnail_url}" alt="">`
        : `<div class="thumb" style="${placeholderStyle(item.color_category)}">No image</div>`;
      const lines=[ item.fabric_content||'—', `Color: ${item.color_category??'—'}`, `Weight: ${item.weight_gsm??'—'} gsm`,
                    `Stretch: ${item.stretch?'yes':'no'}`, `Fiber: ${item.fiber_type??'—'}`, `Width: ${item.width_in??'—'} in`,
                    `Origin: ${item.country_of_origin??'—'}`, `Yards: ${item.yards_available??'—'}` ];
      return `<div class="card">${t}<div class="body"><div class="title">${item.title||'Fabric'}</div>
              <div style="display:flex;gap:8px;align-items:center;"><div>${item.price_cents!=null?dollars(item.price_cents):''}</div>
              <div class="spacer"></div><div class="muted">${new Date(item.created_at).toLocaleDateString()}</div></div>
              <div class="muted">${lines.join(' · ')}</div></div></div>`;
    }

    async function query(){
      gridEl.innerHTML=''; emptyEl.style.display='none'; countEl.textContent='✨ Finding fabrics… ✨';

      let base = supabase.from('catalog').select('*').limit(300);

      const term = (qEl.value || '').trim();
      if(term){ base = base.or(`title.ilike.%${term}%,fabric_content.ilike.%${term}%`); }

      // Colors
      if(colorState.size>0){ base = base.in('color_category', [...colorState]); }

      // Stretch
      if(stretchEl.value==='true') base = base.eq('stretch',true);
      if(stretchEl.value==='false') base = base.eq('stretch',false);

      // Weight
      const wmin=parseInt(wminEl.value,10), wmax=parseInt(wmaxEl.value,10);
      if(!isNaN(wmin)) base = base.gte('weight_gsm', wmin);
      if(!isNaN(wmax)) base = base.lte('weight_gsm', wmax);

      // Width
      const witMin=parseInt(widthMinEl.value,10), witMax=parseInt(widthMaxEl.value,10);
      if(!isNaN(witMin)) base = base.gte('width_in', witMin);
      if(!isNaN(witMax)) base = base.lte('width_in', witMax);

      // Price
      const pmin=parseInt(pminEl.value,10), pmax=parseInt(pmaxEl.value,10);
      if(!isNaN(pmin)) base = base.gte('price_cents', Math.round(pmin*100));
      if(!isNaN(pmax)) base = base.lte('price_cents', Math.round(pmax*100));

      // Sort
      if(sortEl.value==='newest') base = base.order('created_at',{ascending:false});
      if(sortEl.value==='price_asc') base = base.order('price_cents',{ascending:true});
      if(sortEl.value==='price_desc') base = base.order('price_cents',{ascending:false});

      // Fabric Type (supports “other”)
      const selected = [...fabricState];
      let rows = [];
      if (selected.length === 0) {
        const { data, error } = await base; if (error) return fail(error.message); rows = data;
      } else if (selected.length === 1 && selected[0] !== 'other') {
        const { data, error } = await base.or(`fabric_content.ilike.%${selected[0]}%`); if (error) return fail(error.message); rows = data;
      } else if (selected.length === 1 && selected[0] === 'other') {
        let q = base; FABRIC_TOKENS.forEach(tok => { q = q.not('fabric_content','ilike',`%${tok}%`); });
        const { data, error } = await q; if (error) return fail(error.message); rows = data;
      } else {
        const picks = selected.filter(x => x !== 'other'); const needOther = selected.includes('other');
        let qA = base; if (picks.length>0) qA = qA.or(picks.map(k => `fabric_content.ilike.%${k}%`).join(','));
        const resA = picks.length>0 ? await qA : { data: [], error:null };
        let resB = { data: [], error:null };
        if (needOther){ let qB=base; FABRIC_TOKENS.forEach(tok=>{ qB=qB.not('fabric_content','ilike',`%${tok}%`); }); resB=await qB; }
        if (resA.error) return fail(resA.error.message); if (resB.error) return fail(resB.error.message);
        const map=new Map(); [...(resA.data||[]), ...(resB.data||[])].forEach(r=>map.set(r.id,r)); rows=[...map.values()];
      }

      // Client-side extras
      const cond = conditionEl.value;
      const dept = departmentEl.value;
      const desg = (designerEl.value||'').trim().toLowerCase();
      const countryPick = countryEl.value;

      rows = rows.filter(r=>{
        if (cond!=='any' && (r.condition||'').toLowerCase()!==cond) return false;
        if (dept!=='any' && (r.department||'').toLowerCase()!==dept) return false;
        if (desg) {
          const hay = `${r.designer||''} ${r.title||''} ${r.fabric_content||''}`.toLowerCase();
          if (!hay.includes(desg)) return false;
        }
        if (countryPick!=='any') {
          const known = ['China','France','India','Italy','Japan','Turkey','USA'];
          const v = r.country_of_origin || '';
          if (countryPick==='other') {
            if (known.includes(v)) return false;
          } else {
            if (v !== countryPick) return false;
          }
        }
        return true;
      });

      countEl.textContent = `✨ ${rows.length} fabric${rows.length===1?'':'s'} found ✨`;
      if (rows.length === 0) { emptyEl.style.display='block'; gridEl.innerHTML=''; return; }
      gridEl.innerHTML = rows.map(card).join('');
    }

    function fail(msg){ countEl.textContent = `Error: ${msg}`; emptyEl.style.display='block'; }

    document.getElementById('apply').onclick = query;
    document.getElementById('reset').onclick = () => {
      globalSearch.value=''; qEl.value=''; sortEl.value='newest'; stretchEl.value='any';
      rngWeight.reset(); rngWidth.reset(); rngPrice.reset();
      conditionEl.value='any'; departmentEl.value='any'; countryEl.value='any'; designerEl.value='';
      fabricState.clear(); syncFabricUI(); colorState.clear(); syncColorUI();
      query();
    };

    // initial load
    query();
  </script>
</body>
</html>
