<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hemline Market — Catalog</title>
<link rel="icon" href="/favicon.ico">
<style>
  :root{
    --gap:14px; --border:#e5e7eb; --muted:#6b7280; --ink:#111827; --bg:#fff; --brand:#111827; --accent:#111827;
  }
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;color:var(--ink);background:var(--bg)}

  /* NAV */
  .nav{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--border)}
  .nav-inner{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center}
  .brand{font-weight:800;color:var(--brand);text-decoration:none;font-size:18px}
  .nav-search{flex:1}
  .nav-search input{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:999px}
  .nav-links{display:flex;gap:10px}
  .link-btn{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;text-decoration:none;color:var(--ink)}
  .link-btn:hover{background:#f1f5f9}
  .link-cta{background:var(--brand);border-color:var(--brand);color:#fff}

  /* FILTER BAR */
  header.filt{position:sticky;top:58px;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 16px}
  /* auto-fit so it never pushes off-screen */
  .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--gap);align-items:end}
  .control{display:flex;flex-direction:column;gap:6px}
  .muted{color:var(--muted)}
  input,select,button{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff}
  button{cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}

  /* DROPDOWNS */
  .dropdown{position:relative}
  .dropdown-btn{display:flex;align-items:center;justify-content:space-between;gap:8px;min-height:38px}
  .dropdown-panel{
    position:absolute;top:calc(100% + 6px);
    width:min(92vw,560px); /* clamp to viewport */
    max-height:320px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff;
    box-shadow:0 10px 24px rgba(0,0,0,.08);padding:10px;display:none
  }
  .dropdown.open .dropdown-panel{display:block}
  .dropdown.right .dropdown-panel{right:0;left:auto} /* keep panel inside window on the right edge */
  .d-search{width:100%;margin-bottom:8px}
  .d-list{display:flex;flex-wrap:wrap;gap:8px 10px}
  .d-list.colors{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px 10px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;cursor:pointer}
  .chip input{appearance:none;width:14px;height:14px;border-radius:999px;border:1px solid var(--border)}
  .chip input:checked{background:#111827;border-color:#111827}
  .chip .swatch{width:12px;height:12px;border-radius:999px;border:1px solid #0002}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{background:#111827;color:#fff;padding:3px 8px;border-radius:999px;font-size:12px}
  .count-pill{background:#f3f4f6;color:#374151;padding:2px 8px;border-radius:999px;font-size:12px}

  /* CLEAR MIN/MAX SLIDERS (two bars with bubbles) */
  .slider{padding:6px 0}
  .row{display:flex;align-items:center;gap:10px}
  .row > .label{width:34px;text-align:center;color:#111;font-weight:600}
  .bar{position:relative;flex:1;height:28px}
  .bar input[type=range]{position:absolute;left:0;right:0;top:8px;width:100%;height:10px;margin:0;background:transparent;-webkit-appearance:none;appearance:none}
  .bar .track{position:absolute;left:0;right:0;top:12px;height:6px;background:#e5e7eb;border-radius:999px}
  .bar input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:16px;height:16px;background:var(--accent);border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px #0002;cursor:pointer}
  .bar input[type=range]::-moz-range-thumb{width:16px;height:16px;background:var(--accent);border:none;border-radius:50%;box-shadow:0 0 0 1px #0002;cursor:pointer}
  .bubble{position:absolute;top:-10px;transform:translateX(-50%);background:#111827;color:#fff;padding:1px 6px;border-radius:7px;font-size:12px;white-space:nowrap}

  /* RESULTS */
  main{padding:18px 16px 40px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:var(--gap)}
  .card{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.03);transition:transform .12s,box-shadow .12s}
  .card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.08)}
  .thumb{aspect-ratio:4/3;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:12px}
  .body{padding:12px;display:flex;flex-direction:column;gap:6px}
  .title{font-weight:600}
  .spacer{flex:1}
  .empty{border:1px dashed var(--border);border-radius:12px;padding:30px;text-align:center;color:var(--muted)}
  .countline{font-weight:800}
</style>
</head>
<body>

<!-- NAV -->
<div class="nav">
  <div class="nav-inner">
    <a class="brand" href="/index.html">hemlinemarket</a>
    <div class="nav-search"><input id="globalSearch" placeholder="Search fabrics…"></div>
    <div class="nav-links">
      <a class="link-btn" href="/favorites.html">Likes</a>
      <a class="link-btn" href="/news.html">News</a>
      <a class="link-btn" href="/profile.html">Profile</a>
      <a class="link-btn link-cta" href="/sell.html">List an item</a>
    </div>
  </div>
</div>

<!-- FILTERS -->
<header class="filt">
  <div class="wrap">
    <div class="controls">

      <div class="control" style="grid-column:1/-1">
        <label class="muted">Search (title or fabric content)</label>
        <input id="q" placeholder="e.g. wool, silk, lawn"/>
      </div>

      <div class="control">
        <label class="muted">Sort</label>
        <select id="sort">
          <option value="newest">Newest</option>
          <option value="price_asc">Price: Low → High</option>
          <option value="price_desc">Price: High → Low</option>
        </select>
      </div>

      <div class="control">
        <label class="muted">Stretch</label>
        <select id="stretch">
          <option value="any">Any</option>
          <option value="true">Stretch</option>
          <option value="false">No Stretch</option>
        </select>
      </div>

      <!-- Weight slider (min / max with bubbles) -->
      <div class="control">
        <label class="muted">Weight (gsm)</label>
        <div class="slider" id="weightSlider">
          <div class="row">
            <div class="label" id="wminLabel">0</div>
            <div class="bar">
              <div class="track"></div>
              <input id="wminRange" type="range" min="0" max="500" value="0">
              <div class="bubble" id="wminBubble">0</div>
            </div>
          </div>
          <div class="row">
            <div class="label" id="wmaxLabel">500</div>
            <div class="bar">
              <div class="track"></div>
              <input id="wmaxRange" type="range" min="0" max="500" value="500">
              <div class="bubble" id="wmaxBubble">500</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Width slider -->
      <div class="control">
        <label class="muted">Width (in)</label>
        <div class="slider" id="widthSlider">
          <div class="row">
            <div class="label" id="widthMinLabel">30</div>
            <div class="bar">
              <div class="track"></div>
              <input id="widthMinRange" type="range" min="30" max="80" value="30">
              <div class="bubble" id="widthMinBubble">30</div>
            </div>
          </div>
          <div class="row">
            <div class="label" id="widthMaxLabel">80</div>
            <div class="bar">
              <div class="track"></div>
              <input id="widthMaxRange" type="range" min="30" max="80" value="80">
              <div class="bubble" id="widthMaxBubble">80</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Price slider -->
      <div class="control">
        <label class="muted">Price (USD)</label>
        <div class="slider" id="priceSlider">
          <div class="row">
            <div class="label" id="pminLabel">0</div>
            <div class="bar">
              <div class="track"></div>
              <input id="pminRange" type="range" min="0" max="200" value="0">
              <div class="bubble" id="pminBubble">$0</div>
            </div>
          </div>
          <div class="row">
            <div class="label" id="pmaxLabel">200</div>
            <div class="bar">
              <div class="track"></div>
              <input id="pmaxRange" type="range" min="0" max="200" value="200">
              <div class="bubble" id="pmaxBubble">$200</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fabric Type dropdown -->
      <div class="control dropdown" id="fabricDD">
        <label class="muted">Fabric Type</label>
        <button class="dropdown-btn" id="fabricBtn">
          <span id="fabricBtnText">Select fabric types</span>
          <span id="fabricCount" class="count-pill" style="display:none">0</span>
        </button>
        <div class="dropdown-panel" id="fabricPanel">
          <input id="fabricSearch" class="d-search" placeholder="Search types…">
          <div id="fabricList" class="d-list"></div>
        </div>
        <div id="fabricTags" class="tags"></div>
      </div>

      <!-- Color dropdown (right-aligned so it never overflows) -->
      <div class="control dropdown right" id="colorDD">
        <label class="muted">Color</label>
        <button class="dropdown-btn" id="colorBtn">
          <span id="colorBtnText">Select colors</span>
          <span id="colorCount" class="count-pill" style="display:none">0</span>
        </button>
        <div class="dropdown-panel" id="colorPanel">
          <input id="colorSearch" class="d-search" placeholder="Search colors…">
          <div id="colorList" class="d-list colors"></div>
        </div>
        <div id="colorTags" class="tags"></div>
      </div>

      <div class="control">
        <label class="muted">Condition</label>
        <select id="condition">
          <option value="any">Any</option>
          <option value="new">New</option>
          <option value="washed">Washed (pre-shrunk)</option>
          <option value="used">Used</option>
          <option value="vintage">Vintage</option>
        </select>
      </div>

      <div class="control">
        <label class="muted">Department</label>
        <select id="department">
          <option value="any">Any</option>
          <option value="fashion">Fashion fabric</option>
          <option value="quilting">Quilting fabric</option>
          <option value="home">Home fabric</option>
          <option value="notions">Notions</option>
        </select>
      </div>

      <div class="control">
        <label class="muted">Country of origin</label>
        <select id="country">
          <option value="any">Any</option>
          <option>China</option><option>France</option><option>India</option><option>Italy</option>
          <option>Japan</option><option>Turkey</option><option>USA</option><option value="other">Other</option>
        </select>
      </div>

      <div class="control">
        <label class="muted">Designer</label>
        <input id="designer" placeholder="e.g. Liberty, Mood, Joann">
      </div>

      <div class="control" style="align-self:center"><button class="btn" id="reset">Reset</button></div>
      <div class="control" style="align-self:center"><button class="btn primary" id="apply">Apply Filters</button></div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div id="count" class="countline" style="margin-bottom:10px;">✨ Loading… ✨</div>
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">No fabrics match your filters.</div>
  </div>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.3";

  const SUPABASE_URL  = "https://clkizksbvxjkoatdajgd.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  /* basic refs */
  const qEl=document.getElementById('q'), sortEl=document.getElementById('sort'), stretchEl=document.getElementById('stretch');
  const conditionEl=document.getElementById('condition'), departmentEl=document.getElementById('department'), countryEl=document.getElementById('country'), designerEl=document.getElementById('designer');
  const gridEl=document.getElementById('grid'), emptyEl=document.getElementById('empty'), countEl=document.getElementById('count');
  const globalSearch=document.getElementById('globalSearch');
  globalSearch.addEventListener('keydown',e=>{if(e.key==='Enter'){qEl.value=globalSearch.value;query();}});

  /* ------- Slider helpers (two separate bars w/ bubbles) ------- */
  function wireBubble(range, bubble, label, min, max, prefix='', suffix=''){
    const update=()=>{
      let v=+range.value;
      v = Math.max(min, Math.min(max, v));
      range.value = v;
      bubble.textContent = `${prefix}${v}${suffix}`;
      label.textContent = v;
      const pct = (v-min)/(max-min);
      bubble.style.left = (pct*100)+'%';
    };
    range.addEventListener('input', update);
    update();
    return { update };
  }

  // Weight
  const wminR=document.getElementById('wminRange'), wmaxR=document.getElementById('wmaxRange');
  const wminB=document.getElementById('wminBubble'), wmaxB=document.getElementById('wmaxBubble');
  const wminL=document.getElementById('wminLabel'),  wmaxL=document.getElementById('wmaxLabel');
  const wMin=0, wMax=500;
  const wminCtrl = wireBubble(wminR,wminB,wminL,wMin,wMax,'',''); 
  const wmaxCtrl = wireBubble(wmaxR,wmaxB,wmaxL,wMin,wMax,'','');
  // prevent crossing
  wminR.addEventListener('input',()=>{ if(+wminR.value>+wmaxR.value){ wmaxR.value=wminR.value; wmaxCtrl.update(); }});
  wmaxR.addEventListener('input',()=>{ if(+wmaxR.value<+wminR.value){ wminR.value=wmaxR.value; wminCtrl.update(); }});

  // Width
  const widthMinR=document.getElementById('widthMinRange'), widthMaxR=document.getElementById('widthMaxRange');
  const widthMinB=document.getElementById('widthMinBubble'), widthMaxB=document.getElementById('widthMaxBubble');
  const widthMinL=document.getElementById('widthMinLabel'),  widthMaxL=document.getElementById('widthMaxLabel');
  const wdMin=30, wdMax=80;
  const widthMinCtrl=wireBubble(widthMinR,widthMinB,widthMinL,wdMin,wdMax,'','');
  const widthMaxCtrl=wireBubble(widthMaxR,widthMaxB,widthMaxL,wdMin,wdMax,'','');
  widthMinR.addEventListener('input',()=>{ if(+widthMinR.value>+widthMaxR.value){ widthMaxR.value=widthMinR.value; widthMaxCtrl.update(); }});
  widthMaxR.addEventListener('input',()=>{ if(+widthMaxR.value<+widthMinR.value){ widthMinR.value=widthMaxR.value; widthMinCtrl.update(); }});

  // Price
  const pminR=document.getElementById('pminRange'), pmaxR=document.getElementById('pmaxRange');
  const pminB=document.getElementById('pminBubble'), pmaxB=document.getElementById('pmaxBubble');
  const pminL=document.getElementById('pminLabel'),  pmaxL=document.getElementById('pmaxLabel');
  const prMin=0, prMax=200;
  const pminCtrl=wireBubble(pminR,pminB,pminL,prMin,prMax,'$','');
  const pmaxCtrl=wireBubble(pmaxR,pmaxB,pmaxL,prMin,prMax,'$','');
  pminR.addEventListener('input',()=>{ if(+pminR.value>+pmaxR.value){ pmaxR.value=pminR.value; pmaxCtrl.update(); }});
  pmaxR.addEventListener('input',()=>{ if(+pmaxR.value<+pminR.value){ pminR.value=pmaxR.value; pminCtrl.update(); }});

  /* ------- Fabric dropdown ------- */
  const FABRIC_TOKENS_UNSORTED=['cotton','wool','silk','linen','denim','chiffon','crepe','jersey','satin','twill','canvas','lace','velvet','rayon','viscose','modal','tencel','lyocell','polyester','nylon','acrylic'];
  const ALL_FABRICS=[...FABRIC_TOKENS_UNSORTED].map(s=>s.toLowerCase()).sort((a,b)=>a.localeCompare(b)).concat('other');
  const FABRIC_TOKENS=FABRIC_TOKENS_UNSORTED.map(x=>x.toLowerCase());
  const fabricState=new Set();
  const fabricDD=document.getElementById('fabricDD'), fabricBtn=document.getElementById('fabricBtn'), fabricBtnText=document.getElementById('fabricBtnText'), fabricBtnCount=document.getElementById('fabricCount'), fabricList=document.getElementById('fabricList'), fabricTags=document.getElementById('fabricTags'), fabricSearch=document.getElementById('fabricSearch');
  function renderFabricList(filter=''){
    const term=filter.trim().toLowerCase(); fabricList.innerHTML='';
    ALL_FABRICS.filter(k=>!term||k.includes(term)).forEach(k=>{
      const row=document.createElement('label'); row.className='chip';
      row.innerHTML=`<input type="checkbox" ${fabricState.has(k)?'checked':''}><span>${k}</span>`;
      row.querySelector('input').onchange=e=>{ if(e.target.checked) fabricState.add(k); else fabricState.delete(k); syncFabricUI(); };
      fabricList.appendChild(row);
    });
  }
  function syncFabricUI(){
    const vals=[...fabricState];
    fabricTags.innerHTML=vals.map(v=>`<span class="tag">${v}</span>`).join('');
    if(vals.length===0){fabricBtnText.textContent='Select fabric types';fabricBtnCount.style.display='none';}
    else{fabricBtnText.textContent='Fabric Type';fabricBtnCount.style.display='inline-flex';fabricBtnCount.textContent=vals.length;}
    renderFabricList(fabricSearch.value||'');
  }
  fabricBtn.onclick=()=>fabricDD.classList.toggle('open');
  document.addEventListener('click',e=>{if(!fabricDD.contains(e.target)) fabricDD.classList.remove('open');});
  fabricSearch.addEventListener('input',()=>renderFabricList(fabricSearch.value));
  renderFabricList(); syncFabricUI();

  /* ------- Color dropdown ------- */
  const COLOR_META=[['beige','#e7d7b5'],['black','#111827'],['blue','#3b82f6'],['brown','#8b5a2b'],['gray','#9ca3af'],['green','#22c55e'],['orange','#fb923c'],['pink','#f472b6'],['purple','#a78bfa'],['red','#ef4444'],['white','#ffffff'],['yellow','#f59e0b']]
  .sort((a,b)=>a[0].localeCompare(b[0]));
  const colorState=new Set();
  const colorDD=document.getElementById('colorDD'), colorBtn=document.getElementById('colorBtn'), colorBtnText=document.getElementById('colorBtnText'), colorBtnCount=document.getElementById('colorCount'), colorList=document.getElementById('colorList'), colorTags=document.getElementById('colorTags'), colorSearch=document.getElementById('colorSearch');
  function renderColorList(filter=''){
    const term=filter.trim().toLowerCase(); colorList.innerHTML='';
    COLOR_META.filter(([k])=>!term||k.includes(term)).forEach(([k,hex])=>{
      const row=document.createElement('label'); row.className='chip';
      row.innerHTML=`<span class="swatch" style="background:${hex}"></span><input type="checkbox" ${colorState.has(k)?'checked':''}><span>${k}</span>`;
      row.querySelector('input').onchange=e=>{ if(e.target.checked) colorState.add(k); else colorState.delete(k); syncColorUI(); };
      colorList.appendChild(row);
    });
  }
  function syncColorUI(){
    const vals=[...colorState];
    colorTags.innerHTML=vals.map(v=>{const hex=(COLOR_META.find(([k])=>k===v)||[])[1]||'#111827';return `<span class="tag" style="background:${hex};color:${v==='white'?'#111':''}">${v}</span>`}).join('');
    if(vals.length===0){colorBtnText.textContent='Select colors';colorBtnCount.style.display='none';}
    else{colorBtnText.textContent='Color';colorBtnCount.style.display='inline-flex';colorBtnCount.textContent=vals.length;}
    renderColorList(colorSearch.value||'');
  }
  colorBtn.onclick=()=>colorDD.classList.toggle('open');
  document.addEventListener('click',e=>{if(!colorDD.contains(e.target)) colorDD.classList.remove('open');});
  colorSearch.addEventListener('input',()=>renderColorList(colorSearch.value));
  renderColorList(); syncColorUI();

  /* ------- Card helpers & query ------- */
  const colorHex=name=>(COLOR_META.find(([k])=>k===name)||[])[1]||'#e5e7eb';
  function dollars(c){return (c/100).toLocaleString(undefined,{style:'currency',currency:'USD'})}
  function placeholderStyle(cname){
    const base=colorHex((cname||'').toLowerCase());
    return `background:
      radial-gradient(circle at 30% 30%, #ffffff80 0%, #ffffff00 40%),
      repeating-linear-gradient(45deg,#ffffff10 0px,#ffffff10 4px,#0000000b 4px,#0000000b 8px),
      ${base};`;
  }
  function card(item){
    const t=item.thumbnail_url?`<img class="thumb" src="${item.thumbnail_url}" alt="">`:`<div class="thumb" style="${placeholderStyle(item.color_category)}">No image</div>`;
    const lines=[item.fabric_content||'—',`Color: ${item.color_category??'—'}`,`Weight: ${item.weight_gsm??'—'} gsm`,`Stretch: ${item.stretch?'yes':'no'}`,`Fiber: ${item.fiber_type??'—'}`,`Width: ${item.width_in??'—'} in`,`Origin: ${item.country_of_origin??'—'}`,`Yards: ${item.yards_available??'—'}`];
    return `<div class="card">${t}<div class="body"><div class="title">${item.title||'Fabric'}</div>
      <div style="display:flex;gap:8px;align-items:center;"><div>${item.price_cents!=null?dollars(item.price_cents):''}</div>
      <div class="spacer"></div><div class="muted">${new Date(item.created_at).toLocaleDateString()}</div></div>
      <div class="muted">${lines.join(' · ')}</div></div></div>`;
  }

  async function query(){
    gridEl.innerHTML=''; emptyEl.style.display='none'; countEl.textContent='✨ Finding fabrics… ✨';

    let base=supabase.from('catalog').select('*').limit(300);

    const term=(qEl.value||'').trim();
    if(term){ base=base.or(`title.ilike.%${term}%,fabric_content.ilike.%${term}%`); }

    if(colorState.size>0) base=base.in('color_category',[...colorState]);

    if(stretchEl.value==='true') base=base.eq('stretch',true);
    if(stretchEl.value==='false') base=base.eq('stretch',false);

    // Weight (numbers from sliders)
    const wmin=+wminR.value, wmax=+wmaxR.value;
    if(wmin>wMin) base=base.gte('weight_gsm', wmin);
    if(wmax<wMax) base=base.lte('weight_gsm', wmax);

    // Width
    const witMin=+widthMinR.value, witMax=+widthMaxR.value;
    if(witMin>wdMin) base=base.gte('width_in', witMin);
    if(witMax<wdMax) base=base.lte('width_in', witMax);

    // Price
    const pmin=+pminR.value, pmax=+pmaxR.value;
    if(pmin>prMin) base=base.gte('price_cents', Math.round(pmin*100));
    if(pmax<prMax) base=base.lte('price_cents', Math.round(pmax*100));

    // Sort
    if(sortEl.value==='newest') base=base.order('created_at',{ascending:false});
    if(sortEl.value==='price_asc') base=base.order('price_cents',{ascending:true});
    if(sortEl.value==='price_desc') base=base.order('price_cents',{ascending:false});

    // Fabric Type (supports “other”)
    const selected=[...fabricState]; let rows=[];
    if(selected.length===0){
      const {data,error}=await base; if(error) return fail(error.message); rows=data;
    }else if(selected.length===1 && selected[0]!=='other'){
      const {data,error}=await base.or(`fabric_content.ilike.%${selected[0]}%`); if(error) return fail(error.message); rows=data;
    }else if(selected.length===1 && selected[0]==='other'){
      let q=base; FABRIC_TOKENS.forEach(tok=>{ q=q.not('fabric_content','ilike',`%${tok}%`); });
      const {data,error}=await q; if(error) return fail(error.message); rows=data;
    }else{
      const picks=selected.filter(x=>x!=='other'); const needOther=selected.includes('other');
      let qA=base; if(picks.length>0) qA=qA.or(picks.map(k=>`fabric_content.ilike.%${k}%`).join(','));
      const resA=picks.length>0?await qA:{data:[],error:null};
      let resB={data:[],error:null};
      if(needOther){ let qB=base; FABRIC_TOKENS.forEach(tok=>{ qB=qB.not('fabric_content','ilike',`%${tok}%`); }); resB=await qB; }
      if(resA.error) return fail(resA.error.message);
      if(resB.error) return fail(resB.error.message);
      const map=new Map(); [...(resA.data||[]),...(resB.data||[])].forEach(r=>map.set(r.id,r)); rows=[...map.values()];
    }

    // Client-side extras
    const cond=conditionEl.value, dept=departmentEl.value, desg=(designerEl.value||'').trim().toLowerCase(), countryPick=countryEl.value;
    rows=rows.filter(r=>{
      if(cond!=='any' && (r.condition||'').toLowerCase()!==cond) return false;
      if(dept!=='any' && (r.department||'').toLowerCase()!==dept) return false;
      if(desg){ const hay=`${r.designer||''} ${r.title||''} ${r.fabric_content||''}`.toLowerCase(); if(!hay.includes(desg)) return false; }
      if(countryPick!=='any'){
        const known=['China','France','India','Italy','Japan','Turkey','USA']; const v=r.country_of_origin||'';
        if(countryPick==='other'){ if(known.includes(v)) return false; } else { if(v!==countryPick) return false; }
      }
      return true;
    });

    countEl.textContent=`✨ ${rows.length} fabric${rows.length===1?'':'s'} found ✨`;
    if(rows.length===0){ emptyEl.style.display='block'; gridEl.innerHTML=''; return; }
    gridEl.innerHTML=rows.map(card).join('');
  }

  function fail(msg){ countEl.textContent=`Error: ${msg}`; emptyEl.style.display='block'; }

  document.getElementById('apply').onclick=query;
  document.getElementById('reset').onclick=()=>{
    qEl.value=''; sortEl.value='newest'; stretchEl.value='any';
    wminR.value=0; wmaxR.value=500; wminCtrl.update(); wmaxCtrl.update();
    widthMinR.value=30; widthMaxR.value=80; widthMinCtrl.update(); widthMaxCtrl.update();
    pminR.value=0; pmaxR.value=200; pminCtrl.update(); pmaxCtrl.update();
    conditionEl.value='any'; departmentEl.value='any'; countryEl.value='any'; designerEl.value='';
    fabricState.clear(); syncFabricUI(); colorState.clear(); syncColorUI();
    query();
  };

  query();
</script>
</body>
</html>
