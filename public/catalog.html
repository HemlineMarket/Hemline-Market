<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hemline Market — Catalog</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    :root { --gap:14px; --border:#e5e7eb; --muted:#6b7280; --ink:#111827; --bg:#ffffff; }
    * { box-sizing:border-box; }
    body { margin:0; font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; color:var(--ink); background:var(--bg); }
    header { position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--border); }
    .wrap { max-width:1100px; margin:0 auto; padding:12px 16px; }
    .controls { display:grid; grid-template-columns:1fr repeat(3, minmax(160px, 220px)) repeat(3, minmax(160px, 240px)); gap:var(--gap); align-items:end; }
    @media (max-width:1100px){ .controls { grid-template-columns:1fr 1fr; } }
    .control { display:flex; flex-direction:column; gap:6px; }
    .muted { color:var(--muted); }
    input, select, button { border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:#fff; }
    button { cursor:pointer; }
    .btn { padding:9px 14px; }
    .btn.primary { background:var(--ink); color:#fff; border-color:var(--ink); }

    /* Dropdown (shared styles for Fabric + Color) */
    .dropdown { position:relative; }
    .dropdown-btn { display:flex; align-items:center; gap:8px; justify-content:space-between; min-height:38px; }
    .dropdown-panel { position:absolute; top:calc(100% + 6px); left:0; width:320px; max-height:300px; overflow:auto; border:1px solid var(--border); border-radius:12px; background:#fff; box-shadow:0 10px 24px rgba(0,0,0,.08); padding:10px; display:none; }
    .dropdown.open .dropdown-panel { display:block; }
    .d-search { width:100%; margin-bottom:8px; }
    .d-list { display:grid; grid-template-columns:1fr 1fr; gap:6px 12px; }
    .d-item { display:flex; align-items:center; gap:6px; }
    .tags { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
    .tag { background:var(--ink); color:#fff; padding:3px 8px; border-radius:999px; font-size:12px; }
    .count-pill { background:#f3f4f6; color:#374151; padding:2px 8px; border-radius:999px; font-size:12px; }

    main { padding:18px 16px 40px; }
    .grid { display:grid; grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) ); gap:var(--gap); }
    .card { border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; }
    .thumb { aspect-ratio:4/3; background:#f3f4f6; display:flex; align-items:center; justify-content:center; color:#6b7280; font-size:12px; }
    .body { padding:12px; display:flex; flex-direction:column; gap:6px; }
    .title { font-weight:600; }
    .spacer { flex:1; }
    .empty { border:1px dashed var(--border); border-radius:12px; padding:30px; text-align:center; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="controls">
        <div class="control" style="grid-column:1 / -1;">
          <label class="muted">Search (title or fabric content)</label>
          <input id="q" placeholder="e.g. wool, silk, lawn" />
        </div>

        <div class="control">
          <label class="muted">Sort</label>
          <select id="sort">
            <option value="newest">Newest</option>
            <option value="price_asc">Price: Low → High</option>
            <option value="price_desc">Price: High → Low</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Stretch</label>
          <select id="stretch">
            <option value="any">Any</option>
            <option value="true">Stretch</option>
            <option value="false">No Stretch</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Weight (gsm) min</label>
          <input id="wmin" type="number" min="0" placeholder="e.g. 60" />
        </div>

        <div class="control">
          <label class="muted">Weight (gsm) max</label>
          <input id="wmax" type="number" min="0" placeholder="e.g. 300" />
        </div>

        <!-- Fabric Type dropdown -->
        <div class="control dropdown" id="fabricDD">
          <label class="muted">Fabric Type</label>
          <button class="dropdown-btn" id="fabricBtn">
            <span id="fabricBtnText">Select fabric types</span>
            <span id="fabricCount" class="count-pill" style="display:none;">0</span>
          </button>
          <div class="dropdown-panel">
            <input id="fabricSearch" class="d-search" placeholder="Search types…" />
            <div id="fabricList" class="d-list"></div>
          </div>
          <div id="fabricTags" class="tags"></div>
        </div>

        <!-- Color dropdown -->
        <div class="control dropdown" id="colorDD">
          <label class="muted">Color</label>
          <button class="dropdown-btn" id="colorBtn">
            <span id="colorBtnText">Select colors</span>
            <span id="colorCount" class="count-pill" style="display:none;">0</span>
          </button>
          <div class="dropdown-panel">
            <input id="colorSearch" class="d-search" placeholder="Search colors…" />
            <div id="colorList" class="d-list"></div>
          </div>
          <div id="colorTags" class="tags"></div>
        </div>

        <div class="control" style="align-self:center;">
          <button class="btn" id="reset">Reset</button>
        </div>
        <div class="control" style="align-self:center;">
          <button class="btn primary" id="apply">Apply Filters</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div id="count" class="muted" style="margin-bottom:10px;"></div>
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">No fabrics match your filters.</div>
    </div>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.3";

    // --- Supabase ---
    const SUPABASE_URL  = "https://clkizksbvxjkoatdajgd.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    // --- UI refs ---
    const qEl = document.getElementById('q');
    const sortEl = document.getElementById('sort');
    const stretchEl = document.getElementById('stretch');
    const wminEl = document.getElementById('wmin');
    const wmaxEl = document.getElementById('wmax');
    const gridEl = document.getElementById('grid');
    const emptyEl = document.getElementById('empty');
    const countEl = document.getElementById('count');

    // ===== Fabric Type dropdown =====
    const FABRIC_TOKENS = [
      'cotton','wool','silk','linen','denim','chiffon','crepe','jersey','satin','twill','canvas','lace','velvet',
      'rayon','viscose','modal','tencel','lyocell','polyester','nylon','acrylic'
    ];
    const ALL_FABRICS = [...FABRIC_TOKENS, 'other'];
    const fabricState = new Set();
    const fabricDD = document.getElementById('fabricDD');
    const fabricBtn = document.getElementById('fabricBtn');
    const fabricBtnText = document.getElementById('fabricBtnText');
    const fabricBtnCount = document.getElementById('fabricCount');
    const fabricList = document.getElementById('fabricList');
    const fabricTags = document.getElementById('fabricTags');
    const fabricSearch = document.getElementById('fabricSearch');

    function renderFabricList(filter=''){
      const term = filter.trim().toLowerCase();
      fabricList.innerHTML='';
      ALL_FABRICS.filter(k=>!term || k.includes(term)).forEach(k=>{
        const row=document.createElement('label'); row.className='d-item';
        row.innerHTML=`<input type="checkbox" ${fabricState.has(k)?'checked':''}><span>${k}</span>`;
        row.querySelector('input').onchange=(e)=>{ if(e.target.checked) fabricState.add(k); else fabricState.delete(k); syncFabricUI(); };
        fabricList.appendChild(row);
      });
    }
    function syncFabricUI(){
      const vals=[...fabricState];
      fabricTags.innerHTML = vals.map(v=>`<span class="tag">${v}</span>`).join('');
      if(vals.length===0){ fabricBtnText.textContent='Select fabric types'; fabricBtnCount.style.display='none'; }
      else { fabricBtnText.textContent='Fabric Type'; fabricBtnCount.style.display='inline-flex'; fabricBtnCount.textContent=vals.length; }
      renderFabricList(fabricSearch.value||'');
    }
    fabricBtn.onclick=()=>fabricDD.classList.toggle('open');
    document.addEventListener('click',(e)=>{ if(!fabricDD.contains(e.target)) fabricDD.classList.remove('open'); });
    fabricSearch.addEventListener('input',()=>renderFabricList(fabricSearch.value));
    renderFabricList();

    // ===== Color dropdown (replaces wheel) =====
    const COLOR_OPTIONS = ['black','gray','white','beige','brown','yellow','orange','red','pink','purple','blue','green'];
    const colorState = new Set();
    const colorDD = document.getElementById('colorDD');
    const colorBtn = document.getElementById('colorBtn');
    const colorBtnText = document.getElementById('colorBtnText');
    const colorBtnCount = document.getElementById('colorCount');
    const colorList = document.getElementById('colorList');
    const colorTags = document.getElementById('colorTags');
    const colorSearch = document.getElementById('colorSearch');

    function renderColorList(filter=''){
      const term = filter.trim().toLowerCase();
      colorList.innerHTML='';
      COLOR_OPTIONS.filter(k=>!term || k.includes(term)).forEach(k=>{
        const row=document.createElement('label'); row.className='d-item';
        row.innerHTML=`<input type="checkbox" ${colorState.has(k)?'checked':''}><span>${k}</span>`;
        row.querySelector('input').onchange=(e)=>{ if(e.target.checked) colorState.add(k); else colorState.delete(k); syncColorUI(); };
        colorList.appendChild(row);
      });
    }
    function syncColorUI(){
      const vals=[...colorState];
      colorTags.innerHTML = vals.map(v=>`<span class="tag">${v}</span>`).join('');
      if(vals.length===0){ colorBtnText.textContent='Select colors'; colorBtnCount.style.display='none'; }
      else { colorBtnText.textContent='Color'; colorBtnCount.style.display='inline-flex'; colorBtnCount.textContent=vals.length; }
      renderColorList(colorSearch.value||'');
    }
    colorBtn.onclick=()=>colorDD.classList.toggle('open');
    document.addEventListener('click',(e)=>{ if(!colorDD.contains(e.target)) colorDD.classList.remove('open'); });
    colorSearch.addEventListener('input',()=>renderColorList(colorSearch.value));
    renderColorList();

    // ===== Cards & query =====
    function dollars(c){ return (c/100).toLocaleString(undefined,{style:'currency',currency:'USD'}); }
    function card(item){
      const t = item.thumbnail_url ? `<img class="thumb" src="${item.thumbnail_url}" alt="">` : `<div class="thumb">No image</div>`;
      const lines=[ item.fabric_content||'—', `Color: ${item.color_category??'—'}`, `Weight: ${item.weight_gsm??'—'} gsm`,
                    `Stretch: ${item.stretch?'yes':'no'}`, `Fiber: ${item.fiber_type??'—'}`, `Width: ${item.width_in??'—'} in`,
                    `Origin: ${item.country_of_origin??'—'}`, `Yards: ${item.yards_available??'—'}` ];
      return `<div class="card">${t}<div class="body"><div class="title">${item.title||'Fabric'}</div>
              <div style="display:flex;gap:8px;align-items:center;"><div>${item.price_cents!=null?dollars(item.price_cents):''}</div>
              <div class="spacer"></div><div class="muted">${new Date(item.created_at).toLocaleDateString()}</div></div>
              <div class="muted">${lines.join(' · ')}</div></div></div>`;
    }

    async function query(){
      gridEl.innerHTML=''; emptyEl.style.display='none'; countEl.textContent='Loading…';

      let base = supabase.from('catalog').select('*').limit(200);

      const term=qEl.value.trim();
      if(term){ base = base.or(`title.ilike.%${term}%,fabric_content.ilike.%${term}%`); }

      // Colors
      if(colorState.size>0){ base = base.in('color_category', [...colorState]); }

      // Stretch
      if(stretchEl.value==='true') base = base.eq('stretch',true);
      if(stretchEl.value==='false') base = base.eq('stretch',false);

      // Weight
      const wmin=parseInt(wminEl.value,10), wmax=parseInt(wmaxEl.value,10);
      if(!isNaN(wmin)) base = base.gte('weight_gsm', wmin);
      if(!isNaN(wmax)) base = base.lte('weight_gsm', wmax);

      // Sort
      if(sortEl.value==='newest') base = base.order('created_at',{ascending:false});
      if(sortEl.value==='price_asc') base = base.order('price_cents',{ascending:true});
      if(sortEl.value==='price_desc') base = base.order('price_cents',{ascending:false});

      // Fabric Type logic (supports “other”)
      const selected = [...fabricState];
      let rows = [];
      if (selected.length === 0) {
        const { data, error } = await base; if (error) return fail(error.message); rows = data;
      } else if (selected.length === 1 && selected[0] !== 'other') {
        const { data, error } = await base.or(`fabric_content.ilike.%${selected[0]}%`); if (error) return fail(error.message); rows = data;
      } else if (selected.length === 1 && selected[0] === 'other') {
        let q = base; FABRIC_TOKENS.forEach(tok => { q = q.not('fabric_content','ilike',`%${tok}%`); });
        const { data, error } = await q; if (error) return fail(error.message); rows = data;
      } else {
        const picks = selected.filter(x => x !== 'other'); const needOther = selected.includes('other');
        let qA = base; if (picks.length>0) qA = qA.or(picks.map(k => `fabric_content.ilike.%${k}%`).join(','));
        const resA = picks.length>0 ? await qA : { data: [], error:null };
        let resB = { data: [], error:null };
        if (needOther){ let qB=base; FABRIC_TOKENS.forEach(tok=>{ qB=qB.not('fabric_content','ilike',`%${tok}%`); }); resB=await qB; }
        if (resA.error) return fail(resA.error.message); if (resB.error) return fail(resB.error.message);
        const map=new Map(); [...(resA.data||[]), ...(resB.data||[])].forEach(r=>map.set(r.id,r)); rows=[...map.values()];
      }

      countEl.textContent = `${rows.length} fabric${rows.length===1?'':'s'}`;
      if (rows.length === 0) { emptyEl.style.display='block'; return; }
      gridEl.innerHTML = rows.map(card).join('');
    }

    function fail(msg){ countEl.textContent = `Error: ${msg}`; emptyEl.style.display='block'; }

    document.getElementById('apply').onclick = query;
    document.getElementById('reset').onclick = () => {
      qEl.value=''; sortEl.value='newest'; stretchEl.value='any'; wminEl.value=''; wmaxEl.value='';
      fabricState.clear(); syncFabricUI();
      colorState.clear(); syncColorUI();
      query();
    };

    // Init dropdown behaviors
    function attachCloseOnOutside(ddEl, btnEl){ btnEl.onclick=()=>ddEl.classList.toggle('open'); document.addEventListener('click',(e)=>{ if(!ddEl.contains(e.target)) ddEl.classList.remove('open'); }); }
    attachCloseOnOutside(fabricDD, fabricBtn);
    attachCloseOnOutside(colorDD, colorBtn);

    // Sync UIs on load
    function syncColorUI(){
      const vals=[...colorState];
      colorTags.innerHTML = vals.map(v=>`<span class="tag">${v}</span>`).join('');
      if(vals.length===0){ colorBtnText.textContent='Select colors'; colorBtnCount.style.display='none'; }
      else { colorBtnText.textContent='Color'; colorBtnCount.style.display='inline-flex'; colorBtnCount.textContent=vals.length; }
      renderColorList(colorSearch.value||'');
    }
    fabricSearch.addEventListener('input',()=>renderFabricList(fabricSearch.value));
    colorSearch.addEventListener('input',()=>renderColorList(colorSearch.value));

    function renderColorList(filter=''){ /* defined above but hoisted after sync calls */ }

    syncFabricUI();
    syncColorUI();
    query();
  </script>

  <script>
    // Ensure renderColorList exists in non-module scope for earlier reference (safeguard in some bundlers)
  </script>
</body>
</html>
