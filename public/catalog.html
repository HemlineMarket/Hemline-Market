<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hemline Market — Catalog</title>
<style>
  :root{--gap:14px;--border:#e5e7eb;--muted:#6b7280;--ink:#111827;--brand:#111827}
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,sans-serif;color:var(--ink);background:#fff}
  /* NAV (shared) */
  .nav{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--border)}
  .nav-inner{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center}
  .brand{font-weight:800;text-decoration:none;color:var(--ink);font-size:18px}
  .nav-search{flex:1}
  .nav-search input{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:999px}
  .btn{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;text-decoration:none;color:var(--ink)}
  .btn:hover{background:#f3f4f6}
  .btn.primary{background:#111827;border-color:#111827;color:#fff}

  header.filt{position:sticky;top:58px;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 16px}
  .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--gap);align-items:end}
  .control{display:flex;flex-direction:column;gap:6px}
  .muted{color:var(--muted)}
  input,select{border:1px solid var(--border);border-radius:10px;padding:8px 10px}
  .two{display:flex;gap:8px}
  .two .unit{position:relative;flex:1}
  .two .unit input{width:100%;padding-right:38px}
  .unit .u{position:absolute;right:8px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:12px}
  .dropdown{position:relative}
  .dropdown-btn{display:flex;align-items:center;justify-content:space-between;gap:8px;min-height:38px;border:1px solid var(--border);border-radius:10px;background:#fff;padding:8px 10px;cursor:pointer}
  .count-pill{background:#f3f4f6;color:#374151;padding:2px 8px;border-radius:999px;font-size:12px}
  .dropdown-panel{position:absolute;top:calc(100% + 6px);width:min(92vw,560px);max-height:320px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:0 10px 24px rgba(0,0,0,.08);padding:10px;display:none}
  .dropdown.open .dropdown-panel{display:block}
  .d-search{width:100%;margin-bottom:8px}
  .d-list{display:flex;flex-wrap:wrap;gap:8px 10px}
  .d-list.colors{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px 10px}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;cursor:pointer}
  .chip input{appearance:none;width:14px;height:14px;border-radius:999px;border:1px solid var(--border)}
  .chip input:checked{background:#111827;border-color:#111827}
  .chip .swatch{width:12px;height:12px;border-radius:999px;border:1px solid #0002}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{background:#111827;color:#fff;padding:3px 8px;border-radius:999px;font-size:12px}
  main{padding:18px 16px 40px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:var(--gap)}
  .card{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .thumb{aspect-ratio:4/3;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:12px}
  .body{padding:12px;display:flex;flex-direction:column;gap:6px}
  .title{font-weight:600}
  .empty{border:1px dashed var(--border);border-radius:12px;padding:24px;text-align:center;color:var(--muted);display:none}
  .empty h3{margin:0 0 8px 0;font-size:16px;color:var(--ink)}
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
  .countline{font-weight:800}
</style>
</head>
<body>

<!-- Shared header -->
<div class="nav">
  <div class="nav-inner">
    <a class="brand" href="/index.html">hemlinemarket</a>
    <div class="nav-search"><input id="globalSearch" placeholder="Search fabrics…"></div>
    <a class="btn" href="/catalog.html">Browse</a>
    <a class="btn" href="/favorites.html">Likes</a>
    <a class="btn" href="/news.html">News</a>
    <a class="btn" href="/profile.html">Profile</a>
    <a class="btn primary" href="/sell.html">List an item</a>
  </div>
</div>

<header class="filt">
  <div class="wrap">
    <div class="controls">
      <div class="control" style="grid-column:1/-1">
        <label class="muted">Search (title or fabric content)</label>
        <input id="q" placeholder="e.g. wool, silk, lawn" />
      </div>

      <div class="control">
        <label class="muted">Sort</label>
        <select id="sort">
          <option value="newest">Newest</option>
          <option value="price_asc">Price: Low → High</option>
          <option value="price_desc">Price: High → Low</option>
        </select>
      </div>

      <div class="control">
        <label class="muted">Stretch</label>
        <select id="stretch">
          <option value="any">Any</option>
          <option value="true">Stretch</option>
          <option value="false">No Stretch</option>
        </select>
      </div>

      <div class="control">
        <label class="muted">Weight (gsm)</label>
        <div class="two">
          <div class="unit"><input id="wMin" type="number" min="0" max="500" placeholder="min"><span class="u">gsm</span></div>
          <div class="unit"><input id="wMax" type="number" min="0" max="500" placeholder="max"><span class="u">gsm</span></div>
        </div>
      </div>

      <div class="control">
        <label class="muted">Width (in)</label>
        <div class="two">
          <div class="unit"><input id="widthMin" type="number" min="30" max="80" placeholder="min"><span class="u">in</span></div>
          <div class="unit"><input id="widthMax" type="number" min="30" max="80" placeholder="max"><span class="u">in</span></div>
        </div>
      </div>

      <div class="control">
        <label class="muted">Price (USD)</label>
        <div class="two">
          <div class="unit"><input id="pMin" type="number" min="0" max="2000" step="1" placeholder="min"><span class="u">$</span></div>
          <div class="unit"><input id="pMax" type="number" min="0" max="2000" step="1" placeholder="max"><span class="u">$</span></div>
        </div>
      </div>

      <!-- Fabric Type -->
      <div class="control dropdown" id="fabricDD">
        <label class="muted">Fabric Type</label>
        <div class="dropdown-btn" id="fabricBtn"><span id="fabricBtnText">Select fabric types</span><span id="fabricCount" class="count-pill" style="display:none">0</span></div>
        <div class="dropdown-panel" id="fabricPanel">
          <input id="fabricSearch" class="d-search" placeholder="Search types…">
          <div id="fabricList" class="d-list"></div>
        </div>
        <div id="fabricTags" class="tags"></div>
      </div>

      <!-- Color -->
      <div class="control dropdown" id="colorDD">
        <label class="muted">Color</label>
        <div class="dropdown-btn" id="colorBtn"><span id="colorBtnText">Select colors</span><span id="colorCount" class="count-pill" style="display:none">0</span></div>
        <div class="dropdown-panel" id="colorPanel">
          <input id="colorSearch" class="d-search" placeholder="Search colors…">
          <div id="colorList" class="d-list colors"></div>
        </div>
        <div id="colorTags" class="tags"></div>
      </div>

      <div class="control">
        <label class="muted">Condition</label>
        <select id="condition">
          <option value="any">Any</option>
          <option value="unknown">unknown</option>
          <option value="new">New</option>
          <option value="washed">Washed (pre-shrunk)</option>
          <option value="used">Used</option>
          <option value="vintage">Vintage</option>
        </select>
      </div>

      <div class="control">
        <label class="muted">Department</label>
        <select id="department">
          <option value="any">Any</option>
          <option value="unknown">unknown</option>
          <option value="fashion">Fashion fabric</option>
          <option value="quilting">Quilting fabric</option>
          <option value="home">Home fabric</option>
          <option value="notions">Notions</option>
        </select>
      </div>

      <div class="control">
        <label class="muted">Transparency</label>
        <select id="transparency">
          <option value="any">Any</option>
          <option value="unknown">unknown</option>
          <option>opaque</option><option>semi-sheer</option><option>sheer</option>
        </select>
      </div>

      <div class="control">
        <label class="muted">Country of origin</label>
        <select id="country">
          <option value="any">Any</option>
          <option>China</option><option>France</option><option>India</option>
          <option>Italy</option><option>Japan</option><option>Turkey</option><option>USA</option>
          <option>Other</option><option>unknown</option>
        </select>
      </div>

      <div class="control">
        <label class="muted">Designer</label>
        <input id="designer" placeholder="e.g. Liberty, Mood, Joann">
      </div>

      <div class="control" style="align-self:center"><button class="btn" id="resetBtn">Reset</button></div>
      <div class="control" style="align-self:center"><button class="btn primary" id="applyBtn">Apply Filters</button></div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div id="count" class="countline" style="margin-bottom:10px;">✨ Loading… ✨</div>
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty">
      <h3>No fabrics match these filters.</h3>
      <div><button id="emptyClear" class="btn">Clear filters</button></div>
      <div class="tips" style="margin-top:10px">
        <span class="pill">Try fewer colors</span>
        <span class="pill">Widen price range</span>
        <span class="pill">Include “unknown”</span>
      </div>
    </div>
  </div>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.3";
  const supabase = createClient("https://clkizksbvxjkoatdajgd.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI");

  const qEl=document.getElementById('q'), sortEl=document.getElementById('sort'), stretchEl=document.getElementById('stretch');
  const wMin=document.getElementById('wMin'), wMax=document.getElementById('wMax');
  const widthMin=document.getElementById('widthMin'), widthMax=document.getElementById('widthMax');
  const pMin=document.getElementById('pMin'), pMax=document.getElementById('pMax');
  const conditionEl=document.getElementById('condition'), departmentEl=document.getElementById('department'), countryEl=document.getElementById('country'), designerEl=document.getElementById('designer');
  const transparencyEl=document.getElementById('transparency');
  const gridEl=document.getElementById('grid'), emptyEl=document.getElementById('empty'), countEl=document.getElementById('count');
  const emptyClear=document.getElementById('emptyClear');
  const globalSearch=document.getElementById('globalSearch');
  globalSearch.addEventListener('input',e=>{qEl.value=e.target.value;});

  const FABRICS=['unknown','cotton','wool','silk','linen','denim','chiffon','crepe','jersey','satin','twill','canvas','lace','velvet','rayon','viscose','modal','tencel','lyocell','polyester','nylon','acrylic','other'];
  const FABRIC_TOKENS=['cotton','wool','silk','linen','denim','chiffon','crepe','jersey','satin','twill','canvas','lace','velvet','rayon','viscose','modal','tencel','lyocell','polyester','nylon','acrylic'];
  const COLORS=[['unknown','#e5e7eb'],['beige','#e7d7b5'],['black','#111827'],['blue','#3b82f6'],['brown','#8b5a2b'],['gray','#9ca3af'],['green','#22c55e'],['orange','#fb923c'],['pink','#f472b6'],['purple','#a78bfa'],['red','#ef4444'],['white','#ffffff'],['yellow','#f59e0b']].sort((a,b)=>a[0].localeCompare(b[0]));

  // dropdown data/state
  const fabricState=new Set(), colorState=new Set();
  const fabricDD=document.getElementById('fabricDD'), fabricBtn=document.getElementById('fabricBtn'), fabricBtnText=document.getElementById('fabricBtnText'), fabricBtnCount=document.getElementById('fabricCount'), fabricList=document.getElementById('fabricList'), fabricTags=document.getElementById('fabricTags'), fabricSearch=document.getElementById('fabricSearch');
  const colorDD=document.getElementById('colorDD'), colorBtn=document.getElementById('colorBtn'), colorBtnText=document.getElementById('colorBtnText'), colorBtnCount=document.getElementById('colorCount'), colorList=document.getElementById('colorList'), colorTags=document.getElementById('colorTags'), colorSearch=document.getElementById('colorSearch');

  function renderFabricList(filter=''){
    const term=filter.trim().toLowerCase(); fabricList.innerHTML='';
    [...FABRICS].sort((a,b)=>a.localeCompare(b)).forEach(k=>{
      if(term && !k.includes(term)) return;
      const row=document.createElement('label');row.className='chip';
      row.innerHTML=`<input type="checkbox" ${fabricState.has(k)?'checked':''}><span>${k}</span>`;
      row.querySelector('input').onchange=e=>{e.target.checked?fabricState.add(k):fabricState.delete(k); syncFabricUI();};
      fabricList.appendChild(row);
    });
  }
  function syncFabricUI(){
    const vals=[...fabricState]; fabricTags.innerHTML=vals.map(v=>`<span class="tag">${v}</span>`).join('');
    if(vals.length===0){fabricBtnText.textContent='Select fabric types';fabricBtnCount.style.display='none';}
    else{fabricBtnText.textContent='Fabric Type';fabricBtnCount.style.display='inline-flex';fabricBtnCount.textContent=vals.length;}
    renderFabricList(fabricSearch.value||'');
  }

  function renderColorList(filter=''){
    const term=filter.trim().toLowerCase(); colorList.innerHTML='';
    COLORS.forEach(([k,hex])=>{
      if(term && !k.includes(term)) return;
      const row=document.createElement('label');row.className='chip';
      row.innerHTML=`<span class="swatch" style="background:${hex}"></span><input type="checkbox" ${colorState.has(k)?'checked':''}><span>${k}</span>`;
      row.querySelector('input').onchange=e=>{e.target.checked?colorState.add(k):colorState.delete(k); syncColorUI();};
      colorList.appendChild(row);
    });
  }
  function syncColorUI(){
    const vals=[...colorState];
    colorTags.innerHTML=vals.map(v=>{const hex=(COLORS.find(([k])=>k===v)||[])[1]||'#111827';return `<span class="tag" style="background:${hex};color:${v==='white'?'#111':''}">${v}</span>`}).join('');
    if(vals.length===0){colorBtnText.textContent='Select colors';colorBtnCount.style.display='none';}
    else{colorBtnText.textContent='Color';colorBtnCount.style.display='inline-flex';colorBtnCount.textContent=vals.length;}
    renderColorList(colorSearch.value||'');
  }

  function openDropdown(container, btn, panel){
    const willOpen=!container.classList.contains('open');
    document.querySelectorAll('.dropdown.open').forEach(d=>d.classList.remove('open'));
    if(!willOpen) return;
    container.classList.add('open');
    const rect=btn.getBoundingClientRect(), vw=innerWidth, desired=Math.min(vw*0.92,560); panel.style.width=desired+'px';
    const rightSpace=vw-rect.left, leftSpace=rect.right;
    if(rightSpace>=desired || rightSpace>=leftSpace){panel.style.left='0px';panel.style.right='auto';}
    else{panel.style.right='0px';panel.style.left='auto';}
  }
  fabricBtn.addEventListener('click',()=>openDropdown(fabricDD,fabricBtn,document.getElementById('fabricPanel')));
  colorBtn.addEventListener('click',()=>openDropdown(colorDD,colorBtn,document.getElementById('colorPanel')));
  document.addEventListener('click',e=>{document.querySelectorAll('.dropdown').forEach(dd=>{if(!dd.contains(e.target)) dd.classList.remove('open');})});
  document.addEventListener('keydown',e=>{if(e.key==='Escape') document.querySelectorAll('.dropdown.open').forEach(d=>d.classList.remove('open'))});
  fabricSearch.addEventListener('input',()=>renderFabricList(fabricSearch.value));
  colorSearch.addEventListener('input',()=>renderColorList(colorSearch.value));
  renderFabricList(); syncFabricUI(); renderColorList(); syncColorUI();

  const colorHex=name=>(COLORS.find(([k])=>k===name)||[])[1]||'#e5e7eb';
  const dollars=c=> (c/100).toLocaleString(undefined,{style:'currency',currency:'USD'});
  const thumbStyle=cname=>`background:
    radial-gradient(circle at 30% 30%, #ffffff80 0%, #ffffff00 40%),
    repeating-linear-gradient(45deg,#ffffff10 0px,#ffffff10 4px,#0000000b 4px,#0000000b 8px),
    ${colorHex((cname||'').toLowerCase())};`;
  function card(r){
    const t=r.thumbnail_url?`<img class="thumb" src="${r.thumbnail_url}" alt="">`:`<div class="thumb" style="${thumbStyle(r.color_category)}">No image</div>`;
    const meta=[r.fabric_content||'—',`Color: ${r.color_category??'—'}`,`Weight: ${r.weight_gsm??'—'} gsm`,`Stretch: ${r.stretch?'yes':'no'}`,`Fiber: ${r.fiber_type??'—'}`,`Width: ${r.width_in??'—'} in`,`Transparency: ${r.transparency??'—'}`,`Origin: ${r.country_of_origin??'—'}`,`Yards: ${r.yards_available??'—'}`];
    return `<div class="card">${t}<div class="body"><div class="title">${r.title||'Fabric'}</div>
      <div style="display:flex;gap:8px;align-items:center;"><div>${r.price_cents!=null?dollars(r.price_cents):''}</div>
      <div class="muted" style="margin-left:auto">${new Date(r.created_at).toLocaleDateString()}</div></div>
      <div class="muted">${meta.join(' · ')}</div></div></div>`;
  }
  function intVal(el,min,max){ const v = el.value===''?null:Number(el.value); if(v==null||Number.isNaN(v)) return null; return Math.min(max,Math.max(min,v)); }
  function fail(msg){ countEl.textContent=`Error: ${msg}`; emptyEl.style.display='block'; }

  async function query(){
    document.querySelectorAll('.dropdown.open').forEach(d=>d.classList.remove('open'));
    gridEl.innerHTML=''; emptyEl.style.display='none'; countEl.textContent='✨ Finding fabrics… ✨';
    let base=supabase.from('catalog').select('*').limit(300);

    const term=(qEl.value||'').trim(); if(term) base=base.or(`title.ilike.%${term}%,fabric_content.ilike.%${term}%`);
    if(stretchEl.value==='true') base=base.eq('stretch',true);
    if(stretchEl.value==='false') base=base.eq('stretch',false);

    const wmin=intVal(wMin,0,500), wmax=intVal(wMax,0,500); if(wmin!=null) base=base.gte('weight_gsm',wmin); if(wmax!=null) base=base.lte('weight_gsm',wmax);
    const widMin=intVal(widthMin,30,80), widMax=intVal(widthMax,30,80); if(widMin!=null) base=base.gte('width_in',widMin); if(widMax!=null) base=base.lte('width_in',widMax);
    const pmin=intVal(pMin,0,200000), pmax=intVal(pMax,0,200000); if(pmin!=null) base=base.gte('price_cents',Math.round(pmin*100)); if(pmax!=null) base=base.lte('price_cents',Math.round(pmax*100));

    if(sortEl.value==='newest') base=base.order('created_at',{ascending:false});
    if(sortEl.value==='price_asc') base=base.order('price_cents',{ascending:true});
    if(sortEl.value==='price_desc') base=base.order('price_cents',{ascending:false});

    // fetch
    const {data,error}=await base; if(error) return fail(error.message);
    let rows=data||[];

    // client side fabric/color including 'unknown'
    const selectedF=[...fabricState], selectedC=[...colorState];
    if(selectedF.length>0){
      const wantUnknown=selectedF.includes('unknown'); const wantOther=selectedF.includes('other'); const picks=selectedF.filter(v=>v!=='unknown' && v!=='other');
      rows=rows.filter(r=>{
        const content=(r.fabric_content||'').toLowerCase();
        const isUnknown= !content || content==='unknown';
        const isOther = content && !FABRIC_TOKENS.some(tok=>content.includes(tok));
        const matchPick = picks.length===0 ? false : picks.some(tok=>content.includes(tok));
        return (picks.length>0 && matchPick) || (wantOther && isOther) || (wantUnknown && isUnknown);
      });
    }
    if(selectedC.length>0){
      rows=rows.filter(r=>{
        const v=(r.color_category||'').toLowerCase();
        const isUnknown= !v || v==='unknown';
        return selectedC.includes(v) || (selectedC.includes('unknown') && isUnknown);
      });
    }

    // other selects
    const cond=conditionEl.value, dept=departmentEl.value, countryPick=countryEl.value, desg=(designerEl.value||'').trim().toLowerCase(), transp=transparencyEl.value;
    rows=rows.filter(r=>{
      const condition=(r.condition||'').toLowerCase()||'unknown';
      if(cond!=='any' && condition!==cond) return false;
      const dp=(r.department||'').toLowerCase()||'unknown';
      if(dept!=='any' && dp!==dept) return false;
      if(transp!=='any'){
        const tv=(r.transparency||'unknown').toLowerCase();
        if(tv!==transp) return false;
      }
      if(desg){ const hay=`${r.designer||''} ${r.title||''} ${r.fabric_content||''}`.toLowerCase(); if(!hay.includes(desg)) return false; }
      if(countryPick!=='any'){
        const known=['China','France','India','Italy','Japan','Turkey','USA'];
        const v=r.country_of_origin||'unknown';
        if(countryPick==='Other'){ if(known.includes(v)) return false; }
        else if(countryPick==='unknown'){ if(v!=='unknown' && v!=='') return false; }
        else if(v!==countryPick) return false;
      }
      return true;
    });

    countEl.textContent=`✨ ${rows.length} fabric${rows.length===1?'':'s'} found ✨`;
    if(rows.length===0){emptyEl.style.display='block'; gridEl.innerHTML=''; return;}
    gridEl.innerHTML=rows.map(card).join('');
  }

  document.getElementById('applyBtn').onclick=query;
  document.getElementById('resetBtn').onclick=resetAll;
  emptyClear.onclick=resetAll;
  [globalSearch,qEl,wMin,wMax,widthMin,widthMax,pMin,pMax,designerEl].forEach(el=>el.addEventListener('keydown',e=>{if(e.key==='Enter') query()}));

  function resetAll(){
    [qEl,globalSearch,designerEl].forEach(el=>el.value='');
    sortEl.value='newest'; stretchEl.value='any';
    [wMin,wMax,widthMin,widthMax,pMin,pMax].forEach(el=>el.value='');
    conditionEl.value='any'; departmentEl.value='any'; countryEl.value='any'; transparencyEl.value='any';
    fabricState.clear(); colorState.clear(); syncFabricUI(); syncColorUI(); query();
  }

  // init
  renderFabricList(); syncFabricUI(); renderColorList(); syncColorUI();
  query();
</script>
</body>
</html>
