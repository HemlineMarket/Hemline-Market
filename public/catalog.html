<script>
  const SUPABASE_URL = window.ENV_SUPABASE_URL || localStorage.getItem('SUPABASE_URL');
  const SUPABASE_ANON_KEY = window.ENV_SUPABASE_ANON_KEY || localStorage.getItem('SUPABASE_ANON_KEY');
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

  const $ = (id) => document.getElementById(id);
  const resultsEl = $('results');

  function buildQuery() {
    let query = supabase.from('catalog').select('*');

    const qc = $('q').value.trim();
    if (qc) {
      query = query.or(`title.ilike.%${qc}%,fabric_content.ilike.%${qc}%`);
    }

    if ($('fabric_content').value) query = query.ilike('fabric_content', `%${$('fabric_content').value}%`);
    if ($('color_category').value) query = query.eq('color_category', $('color_category').value);
    if ($('stretch').value !== '') query = query.eq('stretch', $('stretch').value === 'true');
    if ($('weight_min').value) query = query.gte('weight_gsm', Number($('weight_min').value));
    if ($('weight_max').value) query = query.lte('weight_gsm', Number($('weight_max').value));
    if ($('texture').value) query = query.eq('texture', $('texture').value);
    if ($('drapiness').value) query = query.eq('drapiness', $('drapiness').value);
    if ($('width_min').value) query = query.gte('width_in', Number($('width_min').value));
    if ($('fiber_type').value) query = query.eq('fiber_type', $('fiber_type').value);
    if ($('country_of_origin').value) query = query.ilike('country_of_origin', `%${$('country_of_origin').value}%`);
    if ($('yards_min').value) query = query.gte('yards_available', Number($('yards_min').value));
    if ($('seller').value) query = query.eq('seller_id', $('seller').value);

    const sort = $('sort').value;
    if (sort === 'newest') query = query.order('created_at', { ascending: false });
    if (sort === 'price_asc') query = query.order('price_cents', { ascending: true });
    if (sort === 'price_desc') query = query.order('price_cents', { ascending: false });

    return query.limit(48);
  }

  function priceFmt(cents) {
    if (cents == null) return '';
    return `$${(cents/100).toFixed(2)}`;
  }

  function render(items) {
    resultsEl.innerHTML = '';
    if (!items || items.length === 0) {
      resultsEl.innerHTML = `<div class="card" style="grid-column:1/-1;">
        <div class="info"><strong>No results.</strong> Try adjusting filters.</div>
      </div>`;
      return;
    }
    for (const it of items) {
      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        <img alt="" src="${it.thumbnail_url || ''}" />
        <div class="info">
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
            <strong style="font-size:14px;line-height:1.2;">${it.title || 'Fabric'}</strong>
            <span class="pill">${priceFmt(it.price_cents)}/yd</span>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            ${it.color_category ? `<span class="pill">${it.color_category}</span>`:''}
            ${it.fiber_type ? `<span class="pill">${it.fiber_type}</span>`:''}
            ${typeof it.width_in === 'number' ? `<span class="pill">${it.width_in}" wide</span>`:''}
            ${typeof it.weight_gsm === 'number' ? `<span class="pill">${it.weight_gsm} gsm</span>`:''}
            ${it.stretch ? `<span class="pill">stretch</span>`:''}
            ${it.country_of_origin ? `<span class="pill">${it.country_of_origin}</span>`:''}
            ${typeof it.yards_available === 'number' ? `<span class="pill">${it.yards_available} yd</span>`:''}
          </div>
          ${it.fabric_content ? `<div style="color:#6b7280;font-size:12px;">${it.fabric_content}</div>`:''}
        </div>`;
      resultsEl.appendChild(card);
    }
  }

  async function run() {
    resultsEl.innerHTML = '<div>Loadingâ€¦</div>';
    const { data, error } = await buildQuery();
    if (error) {
      console.error(error);
      resultsEl.innerHTML = `<div class="card" style="grid-column:1/-1;"><div class="info">Error: ${error.message}</div></div>`;
      return;
    }
    render(data);
  }

  $('apply').addEventListener('click', run);
  $('reset').addEventListener('click', () => {
    document.querySelectorAll('#filters input, #filters select').forEach(el => el.value = '');
    $('q').value = ''; $('sort').value = 'newest';
    run();
  });
  $('q').addEventListener('keydown', (e) => { if (e.key === 'Enter') run(); });

  run(); // initial load
</script>
