<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hemline Market — Catalog</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    :root { --gap:14px; --border:#e5e7eb; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body { font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; color:#111827; background:#fff; }
    header { position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); padding:12px 16px; z-index:10; }
    .wrap { max-width:1100px; margin:0 auto; }
    .controls { display:flex; flex-wrap:wrap; gap:var(--gap); align-items:flex-end; }
    .control { display:flex; flex-direction:column; gap:6px; }
    .control input, .control select { padding:8px 10px; border:1px solid var(--border); border-radius:10px; min-width:180px; }
    .select-multi { padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; min-width:220px; }
    .tags { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
    .tag { background:#111827; color:#fff; padding:3px 8px; border-radius:999px; font-size:12px; }
    .btn { padding:9px 14px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }
    main { padding:18px 16px 40px; }
    .grid { display:grid; grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) ); gap:var(--gap); }
    .card { border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; }
    .thumb { aspect-ratio: 4 / 3; background:#f3f4f6; display:flex; align-items:center; justify-content:center; color:#6b7280; font-size:12px; }
    .card .body { padding:12px; display:flex; flex-direction:column; gap:6px; }
    .title { font-weight:600; }
    .muted { color:#6b7280; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .spacer { flex:1; }
    .empty { padding:30px; text-align:center; color:#6b7280; border:1px dashed var(--border); border-radius:12px; }

    /* color wheel */
    .wheel-wrap { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    .wheel { width:260px; height:260px; }
    .legend { display:grid; grid-template-columns: repeat(3, minmax(90px, 1fr)); gap:6px 12px; align-items:center; }
    .legend .bullet { width:12px; height:12px; border-radius:999px; display:inline-block; margin-right:6px; border:1px solid rgba(0,0,0,.15); }
    .wheel path { outline:none; transition: transform .18s ease, stroke-width .18s ease; transform-origin: 50% 50%; transform-box: fill-box; }
    .wheel path.sel { stroke:#111827; stroke-width:2.6; transform: scale(1.04); }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="controls">
        <div class="control" style="flex:1; min-width:260px;">
          <label class="muted">Search (title or fabric content)</label>
          <input id="q" placeholder="e.g. wool, silk, lawn" />
        </div>

        <div class="control">
          <label class="muted">Sort</label>
          <select id="sort">
            <option value="newest">Newest</option>
            <option value="price_asc">Price: Low → High</option>
            <option value="price_desc">Price: High → Low</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Stretch</label>
          <select id="stretch">
            <option value="any">Any</option>
            <option value="true">Stretch</option>
            <option value="false">No Stretch</option>
          </select>
        </div>

        <div class="control">
          <label class="muted">Weight (gsm) min</label>
          <input id="wmin" type="number" min="0" placeholder="e.g. 60" />
        </div>
        <div class="control">
          <label class="muted">Weight (gsm) max</label>
          <input id="wmax" type="number" min="0" placeholder="e.g. 300" />
        </div>

        <div class="control" style="min-width:100%;"></div>

        <!-- Fabric Type: multi-select dropdown -->
        <div class="control">
          <label class="muted">Fabric Type (multi-select)</label>
          <select id="fabricSelect" class="select-multi" multiple size="5">
            <option value="cotton">cotton</option>
            <option value="wool">wool</option>
            <option value="silk">silk</option>
            <option value="linen">linen</option>
            <option value="denim">denim</option>
            <option value="chiffon">chiffon</option>
            <option value="crepe">crepe</option>
            <option value="jersey">jersey</option>
            <option value="satin">satin</option>
            <option value="twill">twill</option>
            <option value="canvas">canvas</option>
            <option value="lace">lace</option>
            <option value="velvet">velvet</option>
            <option value="rayon">rayon</option>
            <option value="viscose">viscose</option>
            <option value="modal">modal</option>
            <option value="tencel">tencel</option>
            <option value="lyocell">lyocell</option>
            <option value="polyester">polyester</option>
            <option value="nylon">nylon</option>
            <option value="acrylic">acrylic</option>
          </select>
          <div id="fabricTags" class="tags"></div>
        </div>

        <div class="control" style="min-width:100%;"></div>

        <!-- Color Wheel -->
        <div class="control" style="min-width:100%;">
          <label class="muted">Color</label>
          <div class="wheel-wrap">
            <svg id="colorWheel" class="wheel" viewBox="0 0 100 100"></svg>
            <div class="legend" id="legend"></div>
          </div>
        </div>

        <div class="spacer"></div>

        <button class="btn" id="reset">Reset</button>
        <button class="btn primary" id="apply">Apply Filters</button>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div id="count" class="muted" style="margin-bottom:10px;"></div>
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">No fabrics match your filters.</div>
    </div>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.3";

    const SUPABASE_URL  = "https://clkizksbvxjkoatdajgd.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    const qEl = document.getElementById('q');
    const sortEl = document.getElementById('sort');
    const stretchEl = document.getElementById('stretch');
    const wminEl = document.getElementById('wmin');
    const wmaxEl = document.getElementById('wmax');
    const gridEl = document.getElementById('grid');
    const emptyEl = document.getElementById('empty');
    const countEl = document.getElementById('count');

    // Fabric dropdown helpers
    const fabricSelect = document.getElementById('fabricSelect');
    const fabricTags = document.getElementById('fabricTags');
    function getSelectedFabrics(){
      return Array.from(fabricSelect.selectedOptions).map(o => o.value);
    }
    function renderFabricTags(){
      const values = getSelectedFabrics();
      fabricTags.innerHTML = values.map(v => `<span class="tag">${v}</span>`).join('');
    }
    fabricSelect.addEventListener('change', renderFabricTags);
    renderFabricTags();

    // Color wheel
    const COLORS = [
      {key:'black',  fill:'#111827'},
      {key:'gray',   fill:'#9ca3af'},
      {key:'white',  fill:'#ffffff'},
      {key:'beige',  fill:'#e7d7b5'},
      {key:'brown',  fill:'#8b5a2b'},
      {key:'yellow', fill:'#f59e0b'},
      {key:'orange', fill:'#fb923c'},
      {key:'red',    fill:'#ef4444'},
      {key:'pink',   fill:'#f472b6'},
      {key:'purple', fill:'#a78bfa'},
      {key:'blue',   fill:'#3b82f6'},
      {key:'green',  fill:'#22c55e'}
    ];
    const selectedColors = new Set();
    const svg = document.getElementById('colorWheel');
    const legend = document.getElementById('legend');

    function addSlice(cx, cy, r, startDeg, endDeg, fill, key) {
      const toXY = (deg) => { const rad=(deg-90)*Math.PI/180; return [cx+r*Math.cos(rad), cy+r*Math.sin(rad)]; };
      const [x1,y1]=toXY(startDeg), [x2,y2]=toXY(endDeg);
      const largeArc = endDeg-startDeg <= 180 ? 0 : 1;
      const d = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} Z`;
      const p = document.createElementNS('http://www.w3.org/2000/svg','path');
      p.setAttribute('d', d);
      p.setAttribute('fill', fill);
      p.setAttribute('stroke', '#ffffff');
      p.setAttribute('stroke-width','0.7');
      p.style.cursor='pointer';
      p.addEventListener('click', ()=>toggleColor(key,p));
      svg.appendChild(p);
      return p;
    }
    const cx=50, cy=50, r=48, slice=360/COLORS.length, sliceElems={};
    COLORS.forEach((c,i)=>{
      const p=addSlice(cx,cy,r,i*slice,(i+1)*slice,c.fill,c.key);
      sliceElems[c.key]=p;
      const row=document.createElement('div');
      row.innerHTML=`<span class="bullet" style="background:${c.fill}"></span>${c.key}`;
      row.style.cursor='pointer';
      row.onclick=()=>toggleColor(c.key,sliceElems[c.key]);
      legend.appendChild(row);
    });
    function toggleColor(key, elem){
      if(selectedColors.has(key)){
        selectedColors.delete(key);
        elem.classList.remove('sel');
      } else {
        selectedColors.add(key);
        elem.classList.add('sel');
      }
    }
    function clearWheel(){
      selectedColors.clear();
      Object.values(sliceElems).forEach(p=>p.classList.remove('sel'));
    }

    function dollars(c){ return (c/100).toLocaleString(undefined,{style:'currency',currency:'USD'}); }
    function card(item){
      const t = item.thumbnail_url ? `<img class="thumb" src="${item.thumbnail_url}" alt="">` : `<div class="thumb">No image</div>`;
      const lines=[ item.fabric_content||'—', `Color: ${item.color_category??'—'}`, `Weight: ${item.weight_gsm??'—'} gsm`,
                    `Stretch: ${item.stretch?'yes':'no'}`, `Fiber: ${item.fiber_type??'—'}`, `Width: ${item.width_in??'—'} in`,
                    `Origin: ${item.country_of_origin??'—'}`, `Yards: ${item.yards_available??'—'}` ];
      return `<div class="card">${t}<div class="body"><div class="title">${item.title||'Fabric'}</div>
              <div class="row"><div>${item.price_cents!=null?dollars(item.price_cents):''}</div>
              <div class="spacer"></div><div class="muted">${new Date(item.created_at).toLocaleDateString()}</div></div>
              <div class="muted">${lines.join(' · ')}</div></div></div>`;
    }

    async function query(){
      gridEl.innerHTML=''; emptyEl.style.display='none'; countEl.textContent='Loading…';
      let q = supabase.from('catalog').select('*').limit(60);

      const term=qEl.value.trim();
      if(term){ q=q.or(`title.ilike.%${term}%,fabric_content.ilike.%${term}%`); }

      // Fabric types: build OR over fabric_content ILIKE
      const fabrics = getSelectedFabrics();
      if(fabrics.length>0){
        const ors = fabrics.map(k => `fabric_content.ilike.%${k}%`).join(',');
        q = q.or(ors);
      }

      // Colors
      if(selectedColors.size>0){ q=q.in('color_category', Array.from(selectedColors)); }

      // Stretch
      if(stretchEl.value==='true') q=q.eq('stretch',true);
      if(stretchEl.value==='false') q=q.eq('stretch',false);

      // Weight range
      const wmin=parseInt(wminEl.value,10), wmax=parseInt(wmaxEl.value,10);
      if(!isNaN(wmin)) q=q.gte('weight_gsm', wmin);
      if(!isNaN(wmax)) q=q.lte('weight_gsm', wmax);

      // Sort
      if(sortEl.value==='newest') q=q.order('created_at',{ascending:false});
      if(sortEl.value==='price_asc') q=q.order('price_cents',{ascending:true});
      if(sortEl.value==='price_desc') q=q.order('price_cents',{ascending:false});

      const { data, error } = await q;
      if(error){ countEl.textContent=`Error: ${error.message}`; emptyEl.style.display='block'; return; }
      countEl.textContent = `${data.length} fabric${data.length===1?'':'s'}`;
      if(data.length===0){ emptyEl.style.display='block'; return; }
      gridEl.innerHTML = data.map(card).join('');
    }

    document.getElementById('apply').addEventListener('click', query);
    document.getElementById('reset').addEventListener('click', ()=>{
      qEl.value=''; sortEl.value='newest'; stretchEl.value='any'; wminEl.value=''; wmaxEl.value='';
      // clear fabric dropdown
      Array.from(fabricSelect.options).forEach(o=>o.selected=false); renderFabricTags();
      // clear color wheel
      clearWheel();
      query();
    });

    // initial load
    query();
  </script>
</body>
</html>
