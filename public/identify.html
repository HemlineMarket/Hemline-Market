<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>AI Fabric Identifier ‚Äî Hemline Market</title>
  
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
  
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  
  <style>
    :root{
      --hm-accent:#991b1b;
    }
    body{
      margin:0;
      background:linear-gradient(135deg, #fff1f2 0%, #fef2f2 50%, #f0f9ff 100%);
      min-height:100vh;
    }
    .identify-wrap{
      max-width:800px;
      margin:0 auto;
      padding:24px 16px 60px;
    }
    .identify-header{
      text-align:center;
      margin-bottom:32px;
    }
    .identify-header h1{
      font-size:32px;
      font-weight:800;
      margin:0 0 8px;
      background:linear-gradient(135deg, #991b1b, #991b1b);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .identify-header p{
      color:#6b7280;
      margin:0;
      font-size:16px;
    }
    .identify-card{
      background:#fff;
      border-radius:16px;
      box-shadow:0 4px 24px rgba(0,0,0,0.08);
      padding:24px;
    }
    .drop-zone{
      border:2px dashed #d1d5db;
      border-radius:12px;
      padding:48px 24px;
      text-align:center;
      cursor:pointer;
      transition:all 0.2s;
      background:#fafafa;
    }
    .drop-zone:hover, .drop-zone.dragover{
      border-color:#991b1b;
      background:#fef2f2;
    }
    .drop-zone input{
      display:none;
    }
    .drop-icon{
      font-size:48px;
      margin-bottom:12px;
    }
    .drop-text{
      color:#374151;
      font-size:16px;
      margin-bottom:4px;
    }
    .drop-text span{
      color:#991b1b;
      text-decoration:underline;
      cursor:pointer;
    }
    .drop-hint{
      color:#9ca3af;
      font-size:13px;
    }
    .preview-section{
      display:none;
      margin-top:24px;
    }
    .preview-section.show{
      display:block;
    }
    .preview-img-wrap{
      position:relative;
      display:inline-block;
    }
    .preview-img{
      max-width:100%;
      max-height:300px;
      border-radius:12px;
      box-shadow:0 2px 12px rgba(0,0,0,0.1);
    }
    .preview-remove{
      position:absolute;
      top:-8px;
      right:-8px;
      width:28px;
      height:28px;
      border-radius:50%;
      background:#dc2626;
      color:#fff;
      border:none;
      cursor:pointer;
      font-size:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    .identify-btn{
      width:100%;
      margin-top:20px;
      padding:14px 24px;
      background:linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
      color:#fff;
      border:none;
      border-radius:10px;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
    }
    .identify-btn:hover:not(:disabled){
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(153,27,27,0.3);
    }
    .identify-btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }
    .results-section{
      display:none;
      margin-top:32px;
    }
    .results-section.show{
      display:block;
    }
    .results-title{
      font-size:20px;
      font-weight:700;
      margin:0 0 16px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .results-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:16px;
    }
    .result-item{
      background:#f9fafb;
      border-radius:10px;
      padding:16px;
    }
    .result-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:#6b7280;
      margin-bottom:4px;
    }
    .result-value{
      font-size:16px;
      font-weight:600;
      color:#111827;
    }
    .result-value.highlight{
      color:#991b1b;
    }
    .result-description{
      grid-column:1/-1;
    }
    .result-description .result-value{
      font-weight:400;
      font-size:14px;
      line-height:1.6;
    }
    .confidence-bar{
      height:4px;
      background:#e5e7eb;
      border-radius:2px;
      margin-top:8px;
      overflow:hidden;
    }
    .confidence-fill{
      height:100%;
      background:linear-gradient(90deg, #991b1b, #dc2626);
      border-radius:2px;
    }
    .status-msg{
      text-align:center;
      padding:16px;
      font-size:14px;
      color:#6b7280;
    }
    .status-msg.error{
      color:#dc2626;
    }
    .tips{
      margin-top:32px;
      padding:20px;
      background:linear-gradient(135deg, #fef3c7, #fef9c3);
      border-radius:12px;
    }
    .tips h3{
      margin:0 0 12px;
      font-size:14px;
      font-weight:700;
      color:#92400e;
    }
    .tips ul{
      margin:0;
      padding-left:20px;
      font-size:13px;
      color:#78350f;
    }
    .tips li{
      margin-bottom:6px;
    }
    @media(max-width:600px){
      .identify-header h1{font-size:24px;}
      .drop-zone{padding:32px 16px;}
      .results-grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
<div id="hm-shell-header"></div>

<main class="identify-wrap">
  <div class="identify-header">
    <h1>üîç AI Fabric Identifier</h1>
    <p>Upload a photo of your fabric and let AI tell you what it is</p>
  </div>
  
  <div class="identify-card">
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" accept="image/*">
      <div class="drop-icon">üì∏</div>
      <div class="drop-text">Drop a fabric photo here or <span>click to upload</span></div>
      <div class="drop-hint">Works best with close-up shots showing texture</div>
    </div>
    
    <div class="preview-section" id="previewSection">
      <div style="text-align:center;">
        <div class="preview-img-wrap">
          <img id="previewImg" class="preview-img" src="" alt="Fabric preview">
          <button type="button" class="preview-remove" id="removeBtn">√ó</button>
        </div>
      </div>
      <button type="button" class="identify-btn" id="identifyBtn">‚ú® Identify This Fabric</button>
    </div>
    
    <div id="statusMsg" class="status-msg" style="display:none;"></div>
    
    <div class="results-section" id="resultsSection">
      <div class="results-title">‚úÖ Fabric Analysis</div>
      <div class="results-grid" id="resultsGrid"></div>
    </div>
  </div>
  
  <div class="tips">
    <h3>üì∑ Tips for Best Results</h3>
    <ul>
      <li>Use good lighting - natural light works best</li>
      <li>Get close enough to show the weave/texture</li>
      <li>Include a drape shot if possible to show hand</li>
      <li>For fiber content, a burn test is still the most reliable method</li>
    </ul>
  </div>
</main>

<div id="hm-shell-footer"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/hm-shell.js"></script>

<script>
window.HM && window.HM.renderShell({ currentPage: "identify" });

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const previewSection = document.getElementById('previewSection');
const previewImg = document.getElementById('previewImg');
const removeBtn = document.getElementById('removeBtn');
const identifyBtn = document.getElementById('identifyBtn');
const statusMsg = document.getElementById('statusMsg');
const resultsSection = document.getElementById('resultsSection');
const resultsGrid = document.getElementById('resultsGrid');
const listBtn = document.getElementById('listBtn');

let currentImageBase64 = null;
let identifiedData = null;

// Drop zone events
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('dragover');
});
dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('dragover');
});
dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  const files = e.dataTransfer.files;
  if(files.length && files[0].type.startsWith('image/')){
    handleFile(files[0]);
  }
});
fileInput.addEventListener('change', (e) => {
  if(e.target.files.length){
    handleFile(e.target.files[0]);
  }
});

// Remove button
removeBtn.addEventListener('click', () => {
  currentImageBase64 = null;
  previewSection.classList.remove('show');
  dropZone.style.display = 'block';
  resultsSection.classList.remove('show');
  statusMsg.style.display = 'none';
  fileInput.value = '';
});

function handleFile(file){
  const reader = new FileReader();
  reader.onload = (e) => {
    // Compress image
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const maxSize = 1200;
      let width = img.width;
      let height = img.height;
      
      if(width > maxSize || height > maxSize){
        if(width > height){
          height = Math.round(height * maxSize / width);
          width = maxSize;
        } else {
          width = Math.round(width * maxSize / height);
          height = maxSize;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      
      currentImageBase64 = canvas.toDataURL('image/jpeg', 0.85);
      previewImg.src = currentImageBase64;
      dropZone.style.display = 'none';
      previewSection.classList.add('show');
      resultsSection.classList.remove('show');
      statusMsg.style.display = 'none';
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// Identify button
identifyBtn.addEventListener('click', async () => {
  if(!currentImageBase64) return;
  
  identifyBtn.disabled = true;
  identifyBtn.textContent = 'üîÑ Analyzing...';
  statusMsg.textContent = 'AI is examining your fabric...';
  statusMsg.className = 'status-msg';
  statusMsg.style.display = 'block';
  resultsSection.classList.remove('show');
  
  try {
    const resp = await fetch('/api/identify-fabric', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: currentImageBase64 })
    });
    
    const data = await resp.json();
    
    if(!resp.ok || data.error){
      throw new Error(data.error || 'Failed to identify fabric');
    }
    
    identifiedData = data;
    displayResults(data);
    statusMsg.style.display = 'none';
    
  } catch(err) {
    console.error('Identify error:', err);
    statusMsg.textContent = '‚ùå ' + (err.message || 'Could not identify fabric. Try a clearer photo.');
    statusMsg.className = 'status-msg error';
  } finally {
    identifyBtn.disabled = false;
    identifyBtn.textContent = '‚ú® Identify This Fabric';
  }
});

function displayResults(data){
  resultsGrid.innerHTML = '';
  
  const fields = [
    { key: 'fabricType', label: 'Fabric Type', highlight: true },
    { key: 'weight', label: 'Weight' },
    { key: 'pattern', label: 'Pattern' },
    { key: 'color', label: 'Color' },
    { key: 'texture', label: 'Texture' },
    { key: 'sheen', label: 'Sheen' },
    { key: 'stretch', label: 'Stretch' },
    { key: 'opacity', label: 'Opacity' },
    { key: 'likelyContent', label: 'Likely Content' },
    { key: 'confidence', label: 'Confidence' },
  ];
  
  fields.forEach(f => {
    if(data[f.key]){
      const div = document.createElement('div');
      div.className = 'result-item';
      
      let valueHtml = `<div class="result-value${f.highlight ? ' highlight' : ''}">${data[f.key]}</div>`;
      
      if(f.key === 'confidence'){
        const pct = parseInt(data[f.key]) || 70;
        valueHtml += `<div class="confidence-bar"><div class="confidence-fill" style="width:${pct}%"></div></div>`;
      }
      
      div.innerHTML = `
        <div class="result-label">${f.label}</div>
        ${valueHtml}
      `;
      resultsGrid.appendChild(div);
    }
  });
  
  // Description at the end
  if(data.description){
    const div = document.createElement('div');
    div.className = 'result-item result-description';
    div.innerHTML = `
      <div class="result-label">Description</div>
      <div class="result-value">${data.description}</div>
    `;
    resultsGrid.appendChild(div);
  }
  
  // Suggested uses
  if(data.suggestedUses){
    const div = document.createElement('div');
    div.className = 'result-item result-description';
    div.innerHTML = `
      <div class="result-label">Best For</div>
      <div class="result-value">${data.suggestedUses}</div>
    `;
    resultsGrid.appendChild(div);
  }
  
  // Add warning
  const warningDiv = document.createElement('div');
  warningDiv.className = 'result-item result-description';
  warningDiv.innerHTML = `
    <div style="padding:12px;background:#fef3c7;border-radius:8px;font-size:13px;color:#92400e;">
      <strong>‚ö†Ô∏è AI is a guide, not a guarantee.</strong> If you're listing this fabric, only add information you're confident about. If unsure about fiber content, select "Not sure" or perform a burn test.
    </div>
  `;
  resultsGrid.appendChild(warningDiv);
  
  resultsSection.classList.add('show');
}
</script>
</body>
</html>
