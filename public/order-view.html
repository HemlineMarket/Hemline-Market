<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Order — Hemline Market</title>

<style>
  :root{
    --ink:#111827; --muted:#6b7280; --border:#e5e7eb; --accent:#991b1b; --bg:#fafafa;
    --ok:#16a34a;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;
  }

  .wrap{max-width:1100px;margin:18px auto 28px;padding:0 12px}
  h1{margin:0 0 6px;font-size:26px;font-weight:800}
  .subtle{color:var(--muted);font-size:14px;margin:0 0 16px}

  .grid{display:grid;grid-template-columns:1.1fr 360px;gap:14px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}

  /* cards */
  .card{
    background:#fff;border:1px solid var(--border);border-radius:12px;
    box-shadow:0 6px 16px rgba(0,0,0,.06)
  }
  .card .hd{padding:12px;border-bottom:1px solid var(--border);font-weight:800}
  .card .bd{padding:12px}
  .line{height:1px;background:var(--border);margin:10px 0}

  .items{display:grid;gap:10px}
  .item{display:flex;gap:10px;align-items:center;border:1px solid var(--border);
    border-radius:10px;padding:10px}
  .thumb{width:64px;height:48px;border-radius:8px;border:1px solid var(--border);
    object-fit:cover;background:#f3f4f6}
  .grow{flex:1}

  /* timeline */
  .tl{display:grid;gap:8px}
  .step{display:flex;gap:10px;align-items:center}
  .dot{width:14px;height:14px;border-radius:50%;border:2px solid #d1d5db;background:#fff}
  .step[data-done="true"] .dot{border-color:#16a34a;background:#16a34a}
  .step span{font-size:14px}
  .note{font-size:12px;color:#6b7280}

  /* Messages */
  #msgs .msg{
    border:1px solid var(--border);border-radius:10px;padding:10px;
    background:#fff;
  }
  .msg .meta{font-size:12px;color:#6b7280;margin-bottom:4px}
  textarea{
    width:100%;min-height:90px;border:1px solid var(--border);border-radius:10px;
    padding:10px;resize:vertical
  }
  .btn{padding:10px 14px;border:1px solid var(--border);border-radius:10px;background:#fff;
    font-weight:700;cursor:pointer}
  .btn.primary{
    background:var(--accent);border-color:var(--accent);color:#fff;
    box-shadow:0 2px 8px rgba(153,27,27,.25)
  }

  /* summaries */
  .row{display:flex;justify-content:space-between}
  .muted{color:var(--muted)}
</style>
</head>

<body>
<main class="wrap">
  <h1 id="ordTitle">Order</h1>
  <p class="subtle" id="ordSub"></p>

  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="hd">Items</div>
      <div class="bd">
        <div id="items" class="items"></div>

        <div class="line"></div>
        <div id="timeline" class="tl"></div>

        <div class="line"></div>
        <h3 style="margin:0 0 8px">Messages</h3>
        <div id="msgs" class="items"></div>

        <textarea id="msgText" placeholder="Send a message…"></textarea>
        <div style="margin-top:8px;display:flex;justify-content:flex-end">
          <button class="btn primary" id="sendMsg">Send</button>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <div class="hd">Summary</div>
      <div class="bd">
        <div class="row"><span>Order ID</span><strong id="sumId"></strong></div>
        <div class="row"><span>Date</span><span id="sumDate"></span></div>
        <div class="row"><span>Status</span><span id="sumStatus"></span></div>

        <div class="line"></div>
        <div class="row"><span>Items</span><strong id="sumItems">$0.00</strong></div>
        <div class="row"><span>Shipping</span><strong id="sumShip">$0.00</strong></div>
        <div class="row"><span>Tax</span><strong id="sumTax">$0.00</strong></div>

        <div class="line"></div>
        <div class="row" style="font-weight:800">
          <span>Total</span><span id="sumTotal">$0.00</span>
        </div>

        <div class="line"></div>
        <div>
          <div style="font-weight:800;margin-bottom:6px">Ship to</div>
          <div id="shipTo" class="muted"></div>
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabase = window.supabase.createClient(
  "https://clkizksbvxjkoatdajgd.supabase.co",
  "YOUR_ANON_KEY_HERE"
);

let currentSession = null;
let currentUser = null;
let orderId = null;
let orderData = null;

/* ---------- Helpers ---------- */
function fmtMoney(n){
  return (n/100).toLocaleString("en-US",{style:"currency",currency:"USD"});
}
function esc(s){return s ? String(s).replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])) : "";}

/* ---------- Load session ---------- */
async function loadSession(){
  const { data:{session} } = await supabase.auth.getSession();
  currentSession = session;
  currentUser = session?.user || null;
}

/* ---------- Fetch order ---------- */
async function fetchOrder(){
  const { data, error } = await supabase
    .from("orders")
    .select(`*`)
    .eq("id", orderId)
    .maybeSingle();

  if(error){ console.warn(error); return null; }
  return data;
}

/* ---------- Fetch order items ---------- */
async function fetchOrderItems(){
  const { data, error } = await supabase
    .from("order_items")
    .select("*")
    .eq("order_id", orderId);

  return data || [];
}

/* ---------- Fetch messages ---------- */
async function loadMessages(){
  const msgsEl = document.getElementById("msgs");
  msgsEl.innerHTML = "";

  const { data } = await supabase
    .from("messages")
    .select("*")
    .eq("order_id", orderId)
    .order("created_at", { ascending:true });

  (data || []).forEach(m=>{
    const el = document.createElement("div");
    el.className = "msg";
    el.innerHTML = `
      <div class="meta">${m.sender_id === currentUser.id ? "You" : "Seller"} • ${new Date(m.created_at).toLocaleString()}</div>
      <div>${esc(m.body)}</div>
    `;
    msgsEl.appendChild(el);
  });
}

/* ---------- Send message + notify ---------- */
async function sendMessage(){
  const text = document.getElementById("msgText").value.trim();
  if(!text || !currentUser) return;

  document.getElementById("msgText").value = "";

  const { error } = await supabase
    .from("messages")
    .insert({
      order_id: orderId,
      sender_id: currentUser.id,
      receiver_id: orderData.seller_id === currentUser.id ? orderData.buyer_id : orderData.seller_id,
      body: text
    });

  if(error){ console.warn(error); return; }

  /* insert notification */
  await supabase.from("notifications").insert({
    user_id: orderData.seller_id === currentUser.id ? orderData.buyer_id : orderData.seller_id,
    type: "order_message",
    title: "New message on your order",
    body: text.slice(0, 140),
    href: `order-view.html?id=${orderId}`,
    link: `order-view.html?id=${orderId}`,
    order_id: orderId
  });

  loadMessages();
}

/* ---------- Render order ---------- */
async function renderOrder(){
  if(!orderData) return;

  document.getElementById("ordTitle").textContent = `Order ${orderData.human_id}`;
  document.getElementById("ordSub").textContent =
    `Placed on ${new Date(orderData.created_at).toLocaleDateString()} • Status ${orderData.status}`;

  document.getElementById("sumId").textContent = orderData.human_id;
  document.getElementById("sumDate").textContent = new Date(orderData.created_at).toLocaleDateString();
  document.getElementById("sumStatus").textContent = orderData.status;

  document.getElementById("shipTo").textContent =
    `${orderData.ship_name}\n${orderData.ship_address1}\n${orderData.ship_city}, ${orderData.ship_state} ${orderData.ship_zip}`;

  /* Items */
  const items = await fetchOrderItems();
  const itemsEl = document.getElementById("items");
  let subtotal = 0;
  itemsEl.innerHTML = "";

  items.forEach(it=>{
    subtotal += it.price_cents;

    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <img class="thumb" src="${esc(it.photo || "")}" />
      <div class="grow">
        <div style="font-weight:700">${esc(it.title)}</div>
      </div>
      <div>${fmtMoney(it.price_cents)}</div>
    `;
    itemsEl.appendChild(row);
  });

  document.getElementById("sumItems").textContent = fmtMoney(subtotal);
  document.getElementById("sumShip").textContent = fmtMoney(orderData.shipping_cents || 0);
  document.getElementById("sumTax").textContent = fmtMoney(orderData.tax_cents || 0);
  document.getElementById("sumTotal").textContent =
    fmtMoney(subtotal + (orderData.shipping_cents||0) + (orderData.tax_cents||0));

  /* Timeline */
  const tl = document.getElementById("timeline");
  tl.innerHTML = "";
  const steps = [
    {label:"Paid", ts:orderData.paid_at, done:!!orderData.paid_at},
    {label:"Preparing shipment", ts:orderData.prepared_at, done:!!orderData.prepared_at},
    {label:"Shipped", ts:orderData.shipped_at, done:!!orderData.shipped_at},
    {label:"Delivered", ts:orderData.delivered_at, done:!!orderData.delivered_at}
  ];
  steps.forEach(s=>{
    const row=document.createElement("div");
    row.className="step";
    if(s.done) row.dataset.done="true";
    row.innerHTML =
      `<div class="dot"></div><span>${s.label}</span><span class="note">• ${s.ts ? new Date(s.ts).toLocaleString() : "Pending"}</span>`;
    tl.appendChild(row);
  });

  /* Messages */
  loadMessages();
}

/* ---------- init ---------- */
window.addEventListener("DOMContentLoaded", async ()=>{
  orderId = new URL(location.href).searchParams.get("id");
  if(!orderId){ alert("No order ID provided."); return; }

  await loadSession();

  orderData = await fetchOrder();
  if(!orderData){ alert("Order not found."); return; }

  renderOrder();

  document.getElementById("sendMsg").addEventListener("click", sendMessage);
});
</script>
</body>
</html>
