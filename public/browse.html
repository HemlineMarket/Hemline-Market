<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Browse — Hemline Market</title>

  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">

  <!-- Shared styles (universal stack) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      /* Match universal tokens */
      --hm-accent:#991b1b;
      --hm-text:#111827;
      --hm-muted:#6b7280;
      --hm-border:#e5e7eb;
      --hm-bg-card:rgba(255,255,255,.96);

      /* Browse-specific aliases */
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#991b1b;
      --bg:#fafafa;
    }

    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:var(--bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* ===== BROWSE MAIN LAYOUT ===== */
    .browse-wrap{
      max-width:1100px;
      margin:18px auto 28px;
      padding:0 12px;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .topbar input[type="search"]{
      flex:1;
      min-width:0;
      padding:10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
    }
    .topbar button{
      padding:9px 12px;
      border-radius:10px;
      border:1px solid var(--accent);
      background:var(--accent);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      white-space:nowrap;
    }
    .filter-toggle{
      border-color:var(--border);
      background:#fff;
      color:#111827;
    }

    .layout{
      display:grid;
      grid-template-columns:280px 1fr;
      gap:14px;
    }
    .layout.filters-hidden .filters{display:none;}
    .layout.filters-hidden{grid-template-columns:1fr;}

    @media(max-width:900px){
      .layout{grid-template-columns:1fr;}
      .topbar input[type="search"]{flex-basis:100%;}
    }

    /* ---------- FILTERS ---------- */
    .filters{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      height:max-content;
    }
    .filters h3{margin:0 0 8px;}
    .section{
      border-top:1px solid var(--border);
      padding-top:8px;
      margin-top:8px;
    }
    .section:first-of-type{
      border-top:0;
      padding-top:0;
      margin-top:0;
    }
    .title{
      font-weight:700;
      font-size:13px;
      color:#374151;
      margin:0 0 6px;
    }
    .listbox{
      max-height:230px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px;
      background:#fff;
    }
    .row{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 4px;
      border-bottom:1px dashed #f3f4f6;
    }
    .row:last-child{border-bottom:0;}
    .row input{
      width:14px;
      height:14px;
    }
    .row label{
      font-size:12px;
      color:#374151;
    }
    .mini{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .mini .field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .mini label{
      font-size:12px;
      color:#374151;
    }
    .mini input{
      padding:7px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      font-size:13px;
      max-width:120px;
    }
    .selects{
      display:grid;
      gap:8px;
    }
    .selects select,
    .selects input{
      width:100%;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
    }

    /* COLOR BOX */
    #colorBox{
      --sw:22px;
      --gap:6px;
      display:grid;
      grid-template-columns:repeat(5,var(--sw));
      grid-template-rows:repeat(3,var(--sw));
      gap:var(--gap);
      align-content:start;
      justify-content:start;
      padding:6px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:10px;
    }
    #colorBox .sw{
      width:var(--sw);
      height:var(--sw);
      border-radius:6px;
      border:1px solid #d1d5db;
      box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);
      cursor:pointer;
      position:relative;
    }
    #colorBox .sw[data-selected="true"]{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }
    #colorBox .sw .tip{
      position:absolute;
      bottom:130%;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,.85);
      color:#fff;
      padding:2px 5px;
      border-radius:4px;
      font-size:10px;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
    }
    #colorBox .sw:hover .tip{opacity:1}
    #colorBox .sw[data-name="Gold"]{
      background:linear-gradient(135deg,#d4b870 0%,#f0dc97 50%,#ceb86b 100%);
    }
    #colorBox .sw[data-name="Silver"]{
      background:linear-gradient(135deg,#bfc6cf 0%,#e6eaef 50%,#a9b0ba 100%);
    }

    /* ---------- RESULTS ---------- */
    .results{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      min-height:300px;
    }
    .results-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }

    .browse-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
      align-items:flex-start;
    }
    @media(max-width:900px){
      .browse-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media(max-width:560px){
      /* match homepage/atelier: keep 2 columns on small phones */
      .browse-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }

    /* LISTING / ATELIER CARDS – reuse same shell */
    .listing-card{
      background:var(--hm-bg-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .listing-thumb-link{
      display:block;
      text-decoration:none;
      color:inherit;
    }
    .listing-thumb{
      aspect-ratio:4/3;
      background:linear-gradient(180deg,#f8fafc,#eef2f7);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .listing-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .listing-body{
      padding:8px 10px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .listing-title-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:6px;
    }
    .listing-title{
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-decoration:none;
      color:#111827;
    }
    .listing-dept{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#f3f4f6;
      color:#4b5563;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .listing-yards{
      font-size:12px;
      color:#4b5563;
    }
    .listing-cta-row{
      margin-top:4px;
    }
    .listing-add-btn{
      width:100%;
      border-radius:10px;
      border:1px solid var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      font-weight:700;
      font-size:13px;
      padding:8px 10px;
      cursor:pointer;
      white-space:normal;    /* allow wrap on mobile */
      line-height:1.25;
      text-align:center;
      display:inline-block;
    }
    .listing-add-btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    .listing-price-row{
      margin-top:6px;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
    }
    .listing-price-main{
      font-weight:700;
      color:#111827;
    }
    .listing-price-orig{
      text-decoration:line-through;
      color:#9ca3af;
    }
    .listing-seller-row{
      margin-top:4px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      color:#6b7280;
    }
    .listing-seller-name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>
</head>
<body>

  <!-- UNIVERSAL HEADER (injected by hm-shell.js) -->
  <div id="hm-shell-header"></div>

  <main class="browse-wrap">
    <div class="topbar">
      <input id="q" type="search" placeholder="Search fabrics…"/>
      <button id="doSearch" type="button">Search</button>
      <button id="toggleFilters" type="button" class="filter-toggle" aria-pressed="true">Hide filters</button>
    </div>

    <div class="layout" id="layout">
      <aside class="filters">
        <h3>Filters</h3>

        <!-- CONTENT (KNOWN) -->
        <section class="section">
          <div class="title">Content</div>
          <div class="listbox" id="contentBox"></div>
        </section>

        <!-- FEELS LIKE (UNKNOWN CONTENT) – dropdown -->
        <section class="section">
          <div class="title">
            Fabric feels like
            <span style="font-weight:400;font-size:11px;color:var(--muted);">
              (for mystery / unknown content)
            </span>
          </div>
          <div class="selects">
            <select id="feelsLike">
              <option value="">Any</option>
              <option>cotton / poplin</option>
              <option>linen</option>
              <option>silk</option>
              <option>chiffon</option>
              <option>crepe</option>
              <option>satin</option>
              <option>jersey knit</option>
              <option>denim</option>
              <option>flannel / brushed cotton</option>
              <option>fleece</option>
              <option>wool suiting</option>
              <option>tweed</option>
              <option>velvet / velour</option>
              <option>lace</option>
              <option>tulle</option>
              <option>organza</option>
              <option>leather</option>
              <option>faux leather</option>
              <option>vinyl</option>
              <option>suede</option>
            </select>
          </div>
        </section>

        <section class="section">
          <div class="title">Color Family</div>
          <div id="colorBox"></div>
        </section>

        <section class="section">
          <div class="title">$/yard</div>
          <div class="mini">
            <div class="field">
              <label>Min</label>
              <input id="minPrice" type="number" min="0" step="1">
            </div>
            <div class="field">
              <label>Max</label>
              <input id="maxPrice" type="number" min="0" step="1">
            </div>
          </div>
        </section>

        <section class="section">
          <div class="title">Yards</div>
          <div class="mini">
            <div class="field" style="grid-column:1/-1">
              <label>Min yards</label>
              <input id="minYards" type="number" min="0" step="1">
            </div>
          </div>
        </section>

        <section class="section">
          <div class="title">Width (in)</div>
          <div class="mini">
            <div class="field">
              <label>Min</label>
              <input id="minWidth" type="number" min="0" step="1">
            </div>
            <div class="field">
              <label>Max</label>
              <input id="maxWidth" type="number" min="0" step="1">
            </div>
          </div>
        </section>

        <section class="section">
          <div class="title">Weight (GSM)</div>
          <div class="mini">
            <div class="field">
              <label>Min GSM</label>
              <input id="minGsm" type="number" min="0" step="1">
            </div>
            <div class="field">
              <label>Max GSM</label>
              <input id="maxGsm" type="number" min="0" step="1">
            </div>
          </div>
        </section>

        <section class="section">
          <div class="title">Department</div>
          <div class="selects">
            <select id="dept">
              <option value="">Any</option>
              <option>Fashion</option>
              <option>Home</option>
              <option>Quilting</option>
              <option>Notions</option>
            </select>
          </div>
        </section>

        <section class="section">
          <div class="title">Fabric Type</div>
          <div class="selects">
            <select id="fabricType">
              <option value="">Any</option>
              <option>Canvas</option>
              <option>Chiffon</option>
              <option>Corduroy</option>
              <option>Crepe</option>
              <option>Denim</option>
              <option>Flannel</option>
              <option>Georgette</option>
              <option>Jersey</option>
              <option>Lace</option>
              <option>Lawn</option>
              <option>Organza</option>
              <option>Poplin</option>
              <option>Sateen</option>
              <option>Satin</option>
              <option>Tulle</option>
              <option>Twill</option>
              <option>Velvet</option>
              <option>Voile</option>
            </select>
          </div>
        </section>

        <section class="section">
          <div class="title">Fiber Type</div>
          <div class="selects">
            <select id="fiberType">
              <option value="">Any</option>
              <option>Natural</option>
              <option>Modified Natural</option>
              <option>Synthetic</option>
              <option>Blend</option>
            </select>
          </div>
        </section>

        <section class="section">
          <div class="title">Designer / Mill</div>
          <div class="selects">
            <input id="designer" placeholder="e.g., Loro Piana"/>
          </div>
        </section>

        <section class="section">
          <div class="title">Country / Origin</div>
          <div class="selects">
            <select id="origin">
              <option value="">Any</option>
              <option>Italy</option>
              <option>France</option>
              <option>Japan</option>
              <option>UK</option>
              <option>USA</option>
              <option>India</option>
              <option>China</option>
              <option>Korea</option>
            </select>
          </div>
        </section>

        <section class="section">
          <div class="title">Pattern</div>
          <div class="selects">
            <select id="pattern">
              <option value="">Any</option>
              <option>Solid</option>
              <option>Printed</option>
            </select>
          </div>
        </section>
      </aside>

      <section class="results">
        <div class="results-head">
          <h2 id="resultsHeading" style="margin:0;font-size:18px">Browse</h2>
          <div id="resultCount" style="color:#6b7280;font-size:13px">Loading…</div>
        </div>
        <div id="grid" class="browse-grid"></div>
        <div id="empty" style="display:none;color:#6b7280">
          No results yet. Listings will appear here once your marketplace is live.
        </div>
      </section>
    </div>
  </main>

  <!-- UNIVERSAL FOOTER (injected by hm-shell.js) -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Shared shell (universal header/footer + menu + header session) -->
  <script src="scripts/hm-shell.js"></script>

  <script>
    // Render shared header + footer
    window.HM && window.HM.renderShell({ currentPage: "browse" });
  </script>

  <script>
    /* Supabase client + listings / ateliers */

    const supabaseClient = window.supabase.createClient(
      "https://clkizksbvxjkoatdajgd.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI"
    );

    // "listings" (default) vs "ateliers"
    let currentMode = "listings";

    /* --- Filters state --- */

    const CONTENTS = [
      "Any",
      "Acetate",
      "Acrylic",
      "Alpaca",
      "Angora",
      "Bamboo",
      "Cashmere",
      "Cotton",
      "Cupro",
      "Hemp",
      "Leather",
      "Linen",
      "Lurex",
      "Modal",
      "Mohair",
      "Nylon",
      "Polyester",
      "Rayon / Viscose",
      "Silk",
      "Spandex / Elastane",
      "Tencel / Lyocell",
      "Wool",
      "Other Fibers"
    ];

    const COLORS = [
      "Black","Grey","White","Cream","Brown",
      "Pink","Red","Orange","Yellow","Green",
      "Blue","Purple","Gold","Silver"
    ];

    const selectedContents = new Set();
    let   selectedColor   = null;

    function buildFiltersUI(){
      const contentBox = document.getElementById("contentBox");
      const colorBox   = document.getElementById("colorBox");

      if(contentBox){
        contentBox.innerHTML = "";
        CONTENTS.forEach(label=>{
          const row = document.createElement("div");
          row.className = "row";
          const cb  = document.createElement("input");
          cb.type   = "checkbox";
          cb.value  = label;
          const lb  = document.createElement("label");
          lb.textContent = label;
          row.appendChild(cb);
          row.appendChild(lb);
          cb.addEventListener("change",()=>{
            if(label === "Any"){
              selectedContents.clear();
              if(cb.checked) selectedContents.add("Any");
              // uncheck others
              contentBox.querySelectorAll("input[type=checkbox]").forEach(el=>{
                if(el !== cb) el.checked = false;
              });
            }else{
              selectedContents.delete("Any");
              const anyBox = contentBox.querySelector('input[value="Any"]');
              if(anyBox) anyBox.checked = false;
              if(cb.checked) selectedContents.add(label); else selectedContents.delete(label);
            }
            runSearch();
          });
          contentBox.append
