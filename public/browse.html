<!doctype html>
<html lang="en">
<head>
  <!-- MOBILE HOTFIX: keep inside <head> -->
  <style id="hm-mobile-hotfix">
    html, body { max-width:100%; overflow-x:hidden; }
    .rail, .chiprail { overflow-x:auto; -webkit-overflow-scrolling: touch; }
    .grid, .section, .toolbar, .header, .tabbar { max-width:100%; }
    img, video, canvas, svg { max-width:100%; height:auto; }
    [style*="width:1200px"], [style*="max-width:1200px"] { width:auto !important; max-width:100% !important; }
  </style>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Browse — Hemline Market</title>

  <!-- Keep your existing shared styles -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hem-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      /* tokens used by panel + chips; mirrors Home */
      --hm-accent:#991b1b;
      --hm-text:#111827;
      --hm-muted:#6b7280;
      --hm-border:#e5e7eb;
      --ring:#0ea5b7;
      --chip:#f3f4f6;
      --chip-on:#0f766e;
      --chip-on-ink:#fff;

      /* color chips (must match Home exactly) */
      --c-white:#ffffff; --c-ivory:#fffff0; --c-beige:#d6c7b4; --c-camel:#b6895a; --c-tan:#c8a27a;
      --c-yellow:#f5d565; --c-orange:#f6a66a; --c-rust:#b54d2e; --c-red:#cc4b4b; --c-burgundy:#6b2b3d;
      --c-pink:#f3a7b6; --c-blush:#f2c7c2; --c-lilac:#b699d6; --c-purple:#6b4fa6; --c-blue:#3b82f6;
      --c-navy:#1f2a44; --c-teal:#0d9488; --c-green:#22c55e; --c-olive:#6b8f3d; --c-brown:#5b3c25;
      --c-grey:#9ca3af; --c-charcoal:#374151; --c-black:#111111;
    }
    body{margin:0;background:#fafafa;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;-webkit-font-smoothing:antialiased;color:#111827;min-height:100vh;display:flex;flex-direction:column}

    /* Header (shared) */
    .hm-header{min-height:56px;background:#fff;border-bottom:1px solid var(--hm-border)}
    .hm-header .wrap{max-width:1200px;margin:0 auto;padding:0 12px;display:flex;align-items:center;justify-content:space-between}
    .hm-header .left{display:flex;align-items:center;gap:10px}
    .hm-brand{font-size:24px;font-weight:800;color:var(--hm-accent);text-decoration:none}
    .hamburger{display:inline-grid;place-items:center;width:36px;height:36px;border:1px solid var(--hm-border);border-radius:10px;background:#fff;color:#374151}
    .hamburger svg{width:22px;height:22px;stroke-width:2}
    .right{display:flex;align-items:center;gap:14px}
    .hm-icon{color:#444;display:inline-grid;place-items:center;border-radius:10px}
    .hm-icon.active{background:var(--hm-accent);color:#fff;box-shadow:0 2px 8px rgba(153,27,27,.25)}
    .hm-icon svg{width:26px;height:26px;stroke-width:2}
    .hm-avatar{width:28px;height:28px;border-radius:50%;border:1px solid var(--hm-border);background:#fff;color:#334155;display:inline-grid;place-items:center;font-weight:700;font-size:12px;text-decoration:none;background-size:cover;background-position:center}
    .hm-btn-primary{background:var(--hm-accent);color:#fff;border:1px solid var(--hm-accent);border-radius:999px;padding:10px 18px;font-weight:700;text-decoration:none;box-shadow:0 2px 8px rgba(153,27,27,.25)}

    /* Left slide sheet (menu) */
    .sheet{position:fixed;inset:0 auto 0 0;width:min(84vw,340px);background:#fff;border-right:1px solid var(--hm-border);transform:translateX(-100%);transition:transform .25s ease;z-index:100;display:flex;flex-direction:column}
    .sheet.open{transform:translateX(0)}
    .sheet header{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--hm-border)}
    .sheet nav{display:grid;padding:10px}
    .sheet nav a{padding:10px;border:1px solid var(--hm-border);border-radius:10px;text-decoration:none;color:#1f2937}
    .sheet nav a + a{margin-top:8px}
    .sheet .close{display:inline-grid;place-items:center;width:30px;height:30px;border:1px solid var(--hm-border);border-radius:8px;background:#fff;color:#444}

    /* Page layout */
    .wrap{max-width:1200px;margin:12px auto;padding:0 12px;width:100%}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .topbar input[type="search"]{flex:1;padding:10px;border:1px solid var(--hm-border);border-radius:10px;background:#fff}
    .topbar .filter-open{padding:9px 12px;border-radius:10px;border:1px solid var(--hm-accent);background:var(--hm-accent);color:#fff;font-weight:700;display:inline-flex;align-items:center;gap:8px}

    .layout{display:grid;grid-template-columns:280px 1fr;gap:14px}
    @media (max-width:960px){ .layout{grid-template-columns:1fr} .filters{display:none} .topbar .filter-open{display:inline-flex} }

    /* Sidebar filters (desktop) */
    .filters{background:#fff;border:1px solid var(--hm-border);border-radius:12px;padding:10px}
    .filters h3{margin:0 0 6px;font-size:14px;color:#374151}
    .section{border-top:1px solid var(--hm-border);padding-top:8px;margin-top:8px}
    .section:first-of-type{border-top:0;padding-top:0;margin-top:0}
    .section .title{font-weight:700;font-size:13px;color:#374151;margin:0 0 6px}
    .row{display:flex;flex-wrap:wrap;gap:6px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--hm-border);border-radius:999px;background:#fff;padding:6px 10px;font-size:12px;cursor:pointer}
    .chip[data-on="true"]{background:var(--chip-on);color:var(--chip-on-ink);border-color:var(--chip-on)}
    .inputs{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .inputs input{padding:8px 10px;border:1px solid var(--hm-border);border-radius:10px;background:#fff}

    .sw-grid{display:grid;grid-template-columns:repeat(8,22px);gap:6px}
    .sw{width:22px;height:22px;border-radius:6px;border:1px solid #d1d5db;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);cursor:pointer;position:relative}
    .sw[data-on="true"]{outline:2px solid var(--ring);outline-offset:2px}
    .sw .tip{position:absolute;bottom:125%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:2px 5px;border-radius:4px;font-size:10px;white-space:nowrap;opacity:0;pointer-events:none}
    .sw:hover .tip{opacity:1}

    .bar-actions{display:flex;justify-content:space-between;margin-top:10px}
    .btn{padding:6px 10px;border-radius:10px;border:1px solid var(--hm-border);background:#fff;color:#374151;font-size:13px;cursor:pointer}
    .btn-primary{border-color:var(--hm-accent);background:var(--hm-accent);color:#fff}

    /* Selected chips */
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 12px}
    .chips .chip button{border:0;background:transparent;cursor:pointer;color:#6b7280;font-weight:900}

    /* Results */
    .results{background:#fff;border:1px solid var(--hm-border);border-radius:12px;padding:12px;min-height:300px}
    .results-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .browse-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width:900px){ .browse-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
    @media (max-width:560px){ .browse-grid{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid var(--hm-border);border-radius:12px;overflow:hidden}
    .ph{aspect-ratio:4/3;display:grid;place-items:center;color:#6b7280;background:linear-gradient(180deg,#f8fafc,#eef2f7)}
    .meta{padding:8px 10px}
    .meta .title{font-weight:700}
    .meta .sub{display:flex;justify-content:space-between;color:#6b7280;margin-top:6px}

    /* Sticky footer */
    footer{margin-top:auto;border-top:1px solid var(--hm-border);background:#fff}
    .footer-wrap{max-width:1200px;margin:0 auto;padding:20px 12px;display:flex;justify-content:space-between;flex-wrap:wrap;color:#6b7280}

    /* Slide-in FILTER PANEL (mobile-first; also usable on desktop) */
    .scrim{ position:fixed; inset:0; background:rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:.2s; z-index:120}
    .scrim.on{ opacity:1; pointer-events:auto}
    .panel{
      position:fixed; inset:0 auto 0 0; width:min(50vw,560px); max-width:90vw; background:#fff;
      transform:translateX(-100%); transition:.25s; z-index:130; border-right:1px solid var(--hm-border);
      display:flex; flex-direction:column;
    }
    .panel.on{ transform:none }
    .panel header{ position:sticky; top:0; background:#fff; border-bottom:1px solid var(--hm-border); z-index:2}
    .panel h2{ margin:0; padding:14px 16px}
    .panel .body{ padding:10px 16px 90px; overflow:auto}
    .panel .section{ border:1px solid var(--hm-border); border-radius:12px; margin:10px 0; background:#fff}
    .panel .section summary{
      list-style:none; cursor:pointer; user-select:none; padding:12px; font-weight:700; display:flex; justify-content:space-between; align-items:center;
    }
    .panel .section summary::-webkit-details-marker{ display:none }
    .panel .section .inner{ padding:12px; border-top:1px solid var(--hm-border)}
    .applybar{ position:sticky; bottom:0; background:linear-gradient(180deg, rgba(255,255,255,.6), #fff 40%); border-top:1px solid var(--hm-border); padding:12px 16px; display:flex; gap:10px }
    .apply{ flex:1; padding:12px 14px; border-radius:12px; border:0; background:var(--hm-accent); color:#fff; font-weight:700; cursor:pointer }
    .ghost{ background:transparent; color:var(--hm-accent); border:1px solid var(--hm-accent) }
    .filter-open svg{width:18px;height:18px}
  </style>
</head>
<body>

<!-- HEADER -->
<header class="hm-header" role="banner">
  <div class="wrap">
    <div class="left">
      <button class="hamburger" id="openMenu" aria-label="Open menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <line x1="4" y1="6" x2="20" y2="6"></line>
          <line x1="4" y1="12" x2="20" y2="12"></line>
          <line x1="4" y1="18" x2="20" y2="18"></line>
        </svg>
      </button>
      <a class="hm-brand" href="index.html">Hemline Market</a>
    </div>
    <div class="right">
      <a class="hm-icon" id="favBtn" href="favorites.html" aria-label="Favorites" title="Favorites">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
      </a>
      <a class="hm-icon" id="alertBtn" href="notifications.html" aria-label="Notifications" title="Alerts">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"/>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
        </svg>
      </a>
      <a class="hm-avatar" id="avatar" href="account.html" title="Your profile">AA</a>
      <a class="hm-btn-primary" href="seller/index.html?list=new">Sell</a>
    </div>
  </div>
</header>

<!-- LEFT MENU -->
<aside class="sheet" id="menuSheet" aria-hidden="true">
  <header>
    <strong>Menu</strong>
    <button class="close" id="closeMenu" aria-label="Close menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="18" y1="6" x2="6" y="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </header>
  <nav>
    <a href="browse.html">Browse</a>
    <a href="about.html">About</a>
    <a href="atelier.html">My Atelier</a>
    <a href="favorites.html">Favorites</a>
    <a href="orders.html">Orders</a>
    <a href="settings.html">Settings</a>
    <a href="help.html">Help</a>
  </nav>
</aside>

<div class="wrap">
  <!-- Search + selected chips + mobile filter button -->
  <div class="topbar">
    <input id="q" type="search" placeholder="Search fabrics…">
    <button class="filter-open" id="openFilters">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18M6 12h12M10 18h4"/></svg> Filters
    </button>
  </div>
  <div id="selectedChips" class="chips" aria-live="polite"></div>

  <div class="layout">
    <!-- Desktop filters -->
    <aside class="filters" id="filters">
      <h3>Filters</h3>

      <section class="section">
        <div class="title">Department</div>
        <div class="row" id="deptBox"></div>
      </section>

      <section class="section">
        <div class="title">Content</div>
        <div class="row" id="contentBox"></div>
      </section>

      <section class="section">
        <div class="title">Color</div>
        <div class="sw-grid" id="colorBox"></div>
      </section>

      <section class="section">
        <div class="title">Fabric Type</div>
        <div class="row" id="fabricTypeBox"></div>
      </section>

      <section class="section">
        <div class="title">Pattern</div>
        <div class="row" id="patternBox"></div>
      </section>

      <section class="section">
        <div class="title">Width (min/max)</div>
        <div class="inputs">
          <input id="width_min" type="number" inputmode="numeric" placeholder="Min">
          <input id="width_max" type="number" inputmode="numeric" placeholder="Max">
        </div>
      </section>

      <section class="section">
        <div class="title">Weight (GSM)</div>
        <div class="inputs">
          <input id="gsm_min" type="number" inputmode="numeric" placeholder="Min">
          <input id="gsm_max" type="number" inputmode="numeric" placeholder="Max">
        </div>
      </section>

      <section class="section">
        <div class="title">Country</div>
        <div class="row" id="countryBox"></div>
      </section>

      <section class="section">
        <div class="title">Designer</div>
        <div class="inputs" style="grid-template-columns:1fr">
          <input id="designer" placeholder="Free text (e.g., Loro Piana)">
        </div>
      </section>

      <div class="bar-actions">
        <button class="btn" id="clear">Clear</button>
        <button class="btn btn-primary" id="apply">Apply</button>
      </div>
    </aside>

    <!-- Results -->
    <section class="results">
      <div class="results-head">
        <h2 id="resultTitle" style="margin:0;font-size:18px">Browse</h2>
        <div id="resultCount" style="color:#6b7280;font-size:13px">0 results</div>
      </div>
      <div id="grid" class="browse-grid"></div>
      <div id="empty" style="display:none;color:#6b7280">No results. Try relaxing a filter.</div>
    </section>
  </div>
</div>

<!-- FOOTER -->
<footer role="contentinfo">
  <div class="footer-wrap">
    <div class="copy">© <span id="yr"></span> Hemline Market</div>
    <nav class="footer-links" aria-label="Footer">
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="faq.html">FAQ</a>
      <a href="privacy.html">Privacy</a>
      <a href="terms.html">Terms</a>
      <a href="shipping.html">Shipping & Returns</a>
    </nav>
  </div>
</footer>

<!-- SCRIM + SLIDE-IN FILTER PANEL (mobile / also usable on desktop) -->
<div class="scrim" id="scrim" aria-hidden="true"></div>
<aside class="panel" id="filterPanel" role="dialog" aria-modal="true" aria-labelledby="filterTitle">
  <header><h2 id="filterTitle">Filters</h2></header>
  <div class="body" id="panelBody">
    <!-- One-section-open accordion using <details> -->
    <details class="section" open>
      <summary>Department</summary>
      <div class="inner row" data-panel="deptBox"></div>
    </details>
    <details class="section">
      <summary>Content</summary>
      <div class="inner row" data-panel="contentBox"></div>
    </details>
    <details class="section">
      <summary>Color</summary>
      <div class="inner sw-grid" data-panel="colorBox"></div>
    </details>
    <details class="section">
      <summary>Fabric Type</summary>
      <div class="inner row" data-panel="fabricTypeBox"></div>
    </details>
    <details class="section">
      <summary>Pattern</summary>
      <div class="inner row" data-panel="patternBox"></div>
    </details>
    <details class="section">
      <summary>Width (min/max)</summary>
      <div class="inner inputs">
        <input id="width_min_p" type="number" inputmode="numeric" placeholder="Min">
        <input id="width_max_p" type="number" inputmode="numeric" placeholder="Max">
      </div>
    </details>
    <details class="section">
      <summary>Weight (GSM)</summary>
      <div class="inner inputs">
        <input id="gsm_min_p" type="number" inputmode="numeric" placeholder="Min">
        <input id="gsm_max_p" type="number" inputmode="numeric" placeholder="Max">
      </div>
    </details>
    <details class="section">
      <summary>Country</summary>
      <div class="inner row" data-panel="countryBox"></div>
    </details>
    <details class="section">
      <summary>Designer</summary>
      <div class="inner inputs" style="grid-template-columns:1fr">
        <input id="designer_p" placeholder="Free text">
      </div>
    </details>
  </div>
  <div class="applybar">
    <button class="apply ghost" id="clear_p" type="button">Clear</button>
    <button class="apply" id="apply_p" type="button">Apply</button>
  </div>
</aside>

<script>
(function(){
  /* --- Menu sheet --- */
  const sheet=document.getElementById("menuSheet");
  const openBtn=document.getElementById("openMenu");
  const closeBtn=document.getElementById("closeMenu");
  function openSheet(){ sheet.classList.add("open"); sheet.setAttribute("aria-hidden","false"); }
  function closeSheet(){ sheet.classList.remove("open"); sheet.setAttribute("aria-hidden","true"); }
  openBtn.addEventListener("click",e=>{e.preventDefault();openSheet();});
  closeBtn.addEventListener("click",e=>{e.preventDefault();closeSheet();});
  document.addEventListener("keydown",e=>{ if(e.key==="Escape") closeSheet(); });

  /* --- Favorites / Alerts active state parity with Home --- */
  const favBtn=document.getElementById('favBtn');
  const alertBtn=document.getElementById('alertBtn');
  function syncActive(a,key){
    const on = localStorage.getItem(key)==='1';
    a.classList.toggle('active', on);
    a.addEventListener('click', ()=> {
      const next = !(localStorage.getItem(key)==='1');
      localStorage.setItem(key, next ? '1':'0');
      a.classList.toggle('active', next);
    });
  }
  syncActive(favBtn,'hm_favorites_on');
  syncActive(alertBtn,'hm_alerts_on');

  /* --- Data (keep in sync with Home) --- */
  const DEPTS = ["Atelier","Everyday","Kids","Sale"];
  const CONTENT = ["Cashmere","Wool","Silk","Cotton","Linen","Bamboo","Alpaca","Rayon/Viscose","Polyester","Nylon"];
  const FABRIC_TYPES = ["Canvas","Chiffon","Corduroy","Crepe","Denim","Flannel","Georgette","Jersey","Lace","Lawn","Organza","Poplin","Sateen","Satin","Tulle","Twill","Velvet","Voile"];
  const PATTERNS = ["Solid","Printed"];
  const COUNTRIES = ["Italy","France","Japan","UK","USA","India","China","Korea"];
  const COLOR_LIST = [
    "white","ivory","beige","camel","tan","yellow","orange","rust","red","burgundy","pink","blush","lilac","purple","blue","navy","teal","green","olive","brown","grey","charcoal","black"
  ];

  /* --- Build desktop filter UI --- */
  const $ = (id)=>document.getElementById(id);
  const params = new URLSearchParams(location.search);

  function addChips(arr, host, key){
    host.innerHTML='';
    arr.forEach(v=>{
      const btn=document.createElement('button');
      btn.className='chip';
      btn.type='button';
      btn.dataset.value=v.toLowerCase().replace(/\s+/g,'_').replace(/\/.*/,'rayon'); // normalize
      btn.textContent=v;
      btn.addEventListener('click',()=>{ toggleMulti(key, btn.dataset.value, btn); });
      host.appendChild(btn);
    });
  }
  addChips(DEPTS, $('deptBox'), 'department');
  addChips(CONTENT, $('contentBox'), 'content');
  addChips(FABRIC_TYPES, $('fabricTypeBox'), 'fabric_type');
  addChips(PATTERNS, $('patternBox'), 'pattern');
  addChips(COUNTRIES, $('countryBox'), 'country');

  function makeSwatch(name){
    const sw=document.createElement('div'); sw.className='sw'; sw.title=name;
    const varName='--c-'+name;
    sw.style.background = getComputedStyle(document.documentElement).getPropertyValue(varName) || '#eee';
    sw.dataset.value=name;
    const tip=document.createElement('span'); tip.className='tip'; tip.textContent=name[0].toUpperCase()+name.slice(1);
    sw.appendChild(tip);
    sw.addEventListener('click',()=>{ toggleMulti('color', name, sw); });
    return sw;
  }
  (function buildSwatches(){
    const box=$('colorBox'); box.innerHTML='';
    COLOR_LIST.forEach(c=> box.appendChild(makeSwatch(c)));
  })();

  /* --- Slide-in Panel: clones the desktop controls for mobile --- */
  const panelMap = {
    deptBox: $('deptBox'),
    contentBox: $('contentBox'),
    colorBox: $('colorBox'),
    fabricTypeBox: $('fabricTypeBox'),
    patternBox: $('patternBox'),
    countryBox: $('countryBox')
  };
  document.querySelectorAll('[data-panel]').forEach(holder=>{
    const id=holder.getAttribute('data-panel');
    holder.appendChild(panelMap[id].cloneNode(true));
  });
  // sync inputs (width/gsm/designer) between desktop and panel
  ['width_min','width_max','gsm_min','gsm_max','designer'].forEach(k=>{
    const p = document.getElementById(k+'_p');
    const d = document.getElementById(k);
    if(p && d){
      p.addEventListener('input', ()=>{ d.value=p.value; onFieldChange(k, p.value); });
      d.addEventListener('input', ()=>{ p.value=d.value; onFieldChange(k, d.value); });
    }
  });

  /* --- Accordion: allow only one <details> open in panel --- */
  document.querySelectorAll('.panel details.section summary').forEach(s=>{
    s.addEventListener('click', (e)=>{
      const d = s.parentElement;
      if(!d.open){ // will open -> close others
        document.querySelectorAll('.panel details.section').forEach(o=>{ if(o!==d) o.open=false; });
      }
    });
  });

  /* --- Panel open/close + focus trap --- */
  const scrim = $('scrim');
  const panel = $('filterPanel');
  function openPanel(){ scrim.classList.add('on'); panel.classList.add('on'); scrim.setAttribute('aria-hidden','false'); document.addEventListener('keydown',trapTab); }
  function closePanel(){ scrim.classList.remove('on'); panel.classList.remove('on'); scrim.setAttribute('aria-hidden','true'); document.removeEventListener('keydown',trapTab); }
  $('openFilters').addEventListener('click', openPanel);
  scrim.addEventListener('click', closePanel);
  document.addEventListener('keydown', e=>{ if(e.key==='Escape' && panel.classList.contains('on')) closePanel(); });
  function trapTab(e){
    if(e.key!=='Tab') return;
    const f = panel.querySelectorAll('button,[href],input,summary,select,textarea,[tabindex]:not([tabindex="-1"])');
    const a = Array.from(f).filter(el=>!el.disabled && el.offsetParent!==null);
    const first=a[0], last=a[a.length-1];
    if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
    else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
  }
  $('apply_p').addEventListener('click', ()=>{ location.href = location.pathname + '?' + params.toString(); });
  $('clear_p').addEventListener('click', ()=>{ clearAll(); });

  /* --- State helpers (multi-select in URL) --- */
  function getSet(key){ return new Set((params.get(key)||'').split(',').filter(Boolean)); }
  function writeSet(key, set){
    if(set.size) params.set(key, Array.from(set).join(',')); else params.delete(key);
    history.replaceState(null,'','?'+params.toString());
    syncChips(); render();
  }
  function toggleMulti(key, value, el){
    const set = getSet(key);
    if(set.has(value)) set.delete(value); else set.add(value);
    writeSet(key,set);
    if(el) el.setAttribute('data-on', set.has(value) ? 'true' : 'false');
    // mirror selection to all duplicates (desktop/panel)
    document.querySelectorAll(`[data-value="${value}"]`).forEach(btn=> btn.setAttribute('data-on', set.has(value) ? 'true':'false'));
    document.querySelectorAll(`.sw[data-value="${value}"]`).forEach(sw=> sw.setAttribute('data-on', set.has(value) ? 'true':'false'));
  }
  function onFieldChange(key,val){
    if(val && String(val).trim()!=='') params.set(key, val); else params.delete(key);
    history.replaceState(null,'','?'+params.toString());
    syncChips(); render();
  }

  /* --- Build chips from URL state --- */
  const chipsEl=$('selectedChips');
  function chip(label, key, value){
    const d=document.createElement('span');
    d.className='chip';
    d.textContent=label+': '+value+' ';
    const x=document.createElement('button'); x.type='button'; x.setAttribute('aria-label','Remove '+label); x.textContent='×';
    x.addEventListener('click',()=>{
      if(['department','content','fabric_type','pattern','country','color'].includes(key)){
        const set=getSet(key); set.delete(value); writeSet(key,set);
      }else{
        params.delete(key);
        const el=$(key); if(el){ el.value=''; }
        const elp=$(key+'_p'); if(elp){ elp.value=''; }
        history.replaceState(null,'','?'+params.toString());
        syncChips(); render();
      }
    });
    d.appendChild(x);
    return d;
  }
  function syncChips(){
    chipsEl.innerHTML='';
    const q=params.get('q'); if(q) chipsEl.appendChild(chip('Search','q',q));
    ['department','content','fabric_type','pattern','country','color'].forEach(k=>{
      (params.get(k)||'').split(',').filter(Boolean).forEach(v=> chipsEl.appendChild(chip(k.replace('_',' '),k,v)));
    });
    [['width_min','Min width'],['width_max','Max width'],['gsm_min','Min GSM'],['gsm_max','Max GSM'],['designer','Designer']]
      .forEach(([k,l])=>{ const v=params.get(k); if(v) chipsEl.appendChild(chip(l,k,v)); });
  }

  /* --- Preselect from URL (support old synonyms for safety) --- */
  function normalizeIn(params){
    // synonyms -> canonical
    if(params.get('colors')){ params.set('color', params.get('colors')); params.delete('colors'); }
    if(params.get('minGsm')){ params.set('gsm_min', params.get('minGsm')); params.delete('minGsm'); }
    if(params.get('maxGsm')){ params.set('gsm_max', params.get('maxGsm')); params.delete('maxGsm'); }
    if(params.get('minWidth')){ params.set('width_min', params.get('minWidth')); params.delete('minWidth'); }
    if(params.get('maxWidth')){ params.set('width_max', params.get('maxWidth')); params.delete('maxWidth'); }
  }
  normalizeIn(params);

  // fill form fields from params
  (function hydrateUI(){
    $('q').value = params.get('q')||'';
    ['width_min','width_max','gsm_min','gsm_max','designer'].forEach(k=>{
      const v=params.get(k)||'';
      if($(k)) $(k).value=v;
      if($(k+'_p')) $(k+'_p').value=v;
    });
    // mark multiselects
    ['department','content','fabric_type','pattern','country','color'].forEach(k=>{
      const set=getSet(k);
      document.querySelectorAll(`[data-value]`).forEach(el=>{
        if(el.closest('#filters') || el.closest('#filterPanel')){
          const val=el.getAttribute('data-value');
          if(val && set.has(val)) el.setAttribute('data-on','true');
        }
      });
      document.querySelectorAll('.sw').forEach(sw=>{
        if(sw.dataset.value && set.has(sw.dataset.value)) sw.setAttribute('data-on','true');
      });
    });
    syncChips();
  })();

  // live sync for text/number fields & search
  ['q','width_min','width_max','gsm_min','gsm_max','designer'].forEach(k=>{
    const el=$(k); if(el) el.addEventListener('input', ()=> onFieldChange(k, el.value));
  });
  // panel mirrors already wired earlier

  // Apply/Clear buttons (desktop)
  $('apply').addEventListener('click',()=>{ location.href = location.pathname + '?' + params.toString(); });
  $('clear').addEventListener('click', clearAll);
  function clearAll(){
    const keys=['q','department','content','color','fabric_type','pattern','country','width_min','width_max','gsm_min','gsm_max','designer'];
    keys.forEach(k=> params.delete(k));
    history.replaceState(null,'',location.pathname);
    location.reload();
  }

  /* --- Results (demo via data/listings.json if present; fallback to inline) --- */
  const grid=$('grid');
  const empty=$('empty');
  const resultCount=$('resultCount');
  const inlineData = [
    {title:"Italian Wool Suiting", width:150, gsm:260, price:48, dept:"Atelier", fabricType:"twill", content:["wool"], pattern:"solid", color:"navy", origin:"Italy", designer:"Zegna"},
    {title:"Silk Charmeuse", width:114, gsm:80, price:42, dept:"Atelier", fabricType:"satin", content:["silk"], pattern:"solid", color:"blush", origin:"China", designer:""},
    {title:"Japanese Denim", width:145, gsm:380, price:22, dept:"Everyday", fabricType:"denim", content:["cotton"], pattern:"solid", color:"blue", origin:"Japan", designer:"Kuroki"},
    {title:"European Linen", width:140, gsm:190, price:18, dept:"Everyday", fabricType:"lawn", content:["linen"], pattern:"solid", color:"beige", origin:"France", designer:""},
    {title:"Velvet Stretch", width:150, gsm:300, price:28, dept:"Atelier", fabricType:"velvet", content:["polyester","spandex"], pattern:"solid", color:"burgundy", origin:"USA", designer:""},
    {title:"Organza Printed", width:140, gsm:60, price:35, dept:"Atelier", fabricType:"organza", content:["silk"], pattern:"printed", color:"green", origin:"India", designer:""}
  ];
  let ALL = [];

  async function load(){
    try{
      const res = await fetch('data/listings.json', {cache:'no-store'});
      if(res.ok){ ALL = await res.json(); } else { ALL = inlineData; }
    }catch(e){ ALL = inlineData; }
    render();
  }

  function toFilters(){
    const term=(params.get('q')||'').toLowerCase();
    const get=(k)=> new Set((params.get(k)||'').split(',').filter(Boolean));
    const dep=get('department'), cont=get('content'), col=get('color'), fab=get('fabric_type'), pat=get('pattern'), ctry=get('country');
    const num=(k)=>{ const v=params.get(k); return v==null||v===''?null:Number(v); };
    const wmin=num('width_min'), wmax=num('width_max'), gmin=num('gsm_min'), gmax=num('gsm_max');
    const des=(params.get('designer')||'').toLowerCase();

    return (it)=>{
      if(term && !( (it.title||'').toLowerCase().includes(term) || (it.designer||'').toLowerCase().includes(term) )) return false;
      if(dep.size && !dep.has((it.dept||'').toLowerCase())) return false;
      if(cont.size){
        const lc = (it.content||[]).map(s=>s.toLowerCase());
        if(![...cont].some(c=> lc.includes(c))) return false;
      }
      if(col.size && !col.has((it.color||'').toLowerCase())) return false;
      if(fab.size && !fab.has((it.fabricType||'').toLowerCase())) return false;
      if(pat.size && !pat.has((it.pattern||'').toLowerCase())) return false;
      if(ctry.size && !ctry.has((it.origin||'').toLowerCase())) return false;
      if(wmin!=null && (it.width||0) < wmin) return false;
      if(wmax!=null && (it.width||9999) > wmax) return false;
      if(gmin!=null && (it.gsm||0) < gmin) return false;
      if(gmax!=null && (it.gsm||9999) > gmax) return false;
      if(des && !((it.designer||'').toLowerCase().includes(des))) return false;
      return true;
    };
  }

  function render(){
    const list = ALL.filter(toFilters());
    resultCount.textContent = list.length + (list.length===1 ? ' result' : ' results');
    grid.innerHTML='';
    if(!list.length){ empty.style.display='block'; return; }
    empty.style.display='none';
    list.forEach(it=>{
      const a=document.createElement('article'); a.className='card';
      a.innerHTML=`
        <div class="ph">${it.photo ? '' : ''}</div>
        <div class="meta">
          <div class="title">${it.title}</div>
          <div class="sub"><span>${(it.origin||'').toString()}</span><span>${(it.width||'–')}″ • ${(it.gsm||'–')} GSM</span></div>
        </div>`;
      grid.appendChild(a);
    });
  }

  // kick
  $('yr').textContent = new Date().getFullYear();
  load();
})();
</script>
</body>
</html>
