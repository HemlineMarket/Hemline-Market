<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Browse — Hemline Market</title>

  <!-- Base shared styles you already use -->
  <link rel="stylesheet" href="/styles/hm-modern.css"/>
  <link rel="stylesheet" href="/styles/hem-header.css"/>
  <link rel="stylesheet" href="/styles/hm-typography.css"/>
  <link rel="stylesheet" href="/styles/hm-footer.css"/>

  <style>
    :root{ --hm-accent:#991b1b; --hm-text:#111827; --hm-muted:#6b7280; --hm-border:#e5e7eb; }
    body{margin:0;background:#fafafa;color:var(--hm-text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;-webkit-font-smoothing:antialiased}

    /* Header */
    .hm-header{min-height:56px;background:#fff;border-bottom:1px solid var(--hm-border)}
    .hm-header .wrap{max-width:1200px;margin:0 auto;padding:0 12px;display:flex;align-items:center;justify-content:space-between}
    .left{display:flex;align-items:center;gap:10px}
    .hm-brand{font-size:24px;font-weight:800;color:var(--hm-accent);text-decoration:none}
    .hamburger{display:inline-grid;place-items:center;width:36px;height:36px;border:1px solid var(--hm-border);border-radius:10px;background:#fff;color:#374151}
    .hamburger svg{width:22px;height:22px;stroke-width:2}
    .right{display:flex;align-items:center;gap:14px}
    .hm-icon{color:#444;display:inline-grid;place-items:center;position:relative}
    .hm-icon svg{width:26px;height:26px;stroke-width:2}
    .hm-avatar{width:28px;height:28px;border-radius:50%;border:1px solid var(--hm-border);background:#fff;color:#334155;display:inline-grid;place-items:center;font-weight:700;font-size:12px;text-decoration:none;background-size:cover;background-position:center}
    .hm-btn-primary{background:var(--hm-accent);color:#fff;border:1px solid var(--hm-accent);border-radius:999px;padding:10px 18px;font-weight:700;text-decoration:none;box-shadow:0 2px 8px rgba(153,27,27,.25)}
    .cart-badge{ position:absolute; top:-6px; right:-8px; min-width:18px; height:18px; padding:0 4px; display:none; align-items:center; justify-content:center; background:var(--hm-accent); color:#fff; border-radius:999px; font-size:11px; font-weight:800; line-height:18px; border:1px solid #fff; }

    /* Layout */
    .wrap{max-width:1200px;margin:12px auto;padding:0 12px}
    .topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .topbar input[type="search"]{flex:1;padding:10px;border:1px solid var(--hm-border);border-radius:10px;background:#fff}
    .topbar button{padding:9px 12px;border-radius:10px;border:1px solid var(--hm-accent);background:var(--hm-accent);color:#fff;font-weight:700}
    #openFilters{display:none}
    @media (max-width:900px){ #openFilters{display:inline-block} }

    .layout{display:grid;grid-template-columns:280px 1fr;gap:14px}
    @media (max-width:900px){ .layout{grid-template-columns:1fr} }

    .filters{background:#fff;border:1px solid var(--hm-border);border-radius:12px;padding:10px}
    @media (max-width:900px){ .filters{display:none} }
    .section{border-top:1px solid var(--hm-border);padding-top:8px;margin-top:8px}
    .section:first-of-type{border-top:0;padding-top:0;margin-top:0}
    .title{font-weight:700;font-size:13px;color:#374151;margin:0 0 6px}
    .listbox{height:230px;overflow:auto;border:1px solid var(--hm-border);border-radius:10px;padding:6px;background:#fff}
    .row{display:flex;align-items:center;gap:8px;padding:6px 4px;border-bottom:1px dashed #f3f4f6}
    .row:last-child{border-bottom:0}
    .row input{width:14px;height:14px}
    .row label{font-size:12px;color:#374151}

    #colorBox{ --sw:22px; --gap:6px; display:grid; grid-template-columns:repeat(5,var(--sw)); grid-template-rows:repeat(3,var(--sw)); gap:var(--gap); align-content:start; justify-content:start; padding:6px; background:#fff; border:1px solid var(--hm-border); border-radius:10px; }
    #colorBox .sw{ width:var(--sw); height:var(--sw); border-radius:6px; border:1px solid #d1d5db; box-shadow:inset 0 0 0 1px rgba(0,0,0,.06); cursor:pointer; position:relative; -webkit-tap-highlight-color:transparent; }
    #colorBox .sw[data-selected="true"]{ outline:2px solid var(--hm-accent); outline-offset:2px; }

    .mini{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .mini .field{display:flex;flex-direction:column;gap:4px}
    .mini label{font-size:12px;color:#374151}
    .mini input{padding:7px 10px;border:1px solid var(--hm-border);border-radius:10px;background:#fff;font-size:13px;max-width:120px}
    .selects{display:grid;gap:8px}
    .selects select,.selects input{width:100%;padding:8px 10px;border:1px solid var(--hm-border);border-radius:10px;background:#fff}

    .results{background:#fff;border:1px solid var(--hm-border);border-radius:12px;padding:12px;min-height:300px}
    .results-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .browse-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width:900px){ .browse-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
    @media (max-width:560px){ .browse-grid{grid-template-columns:1fr} }

    .card{background:#fff;border:1px solid var(--hm-border);border-radius:12px;overflow:hidden;color:inherit;text-decoration:none}
    .ph{aspect-ratio:4/3;display:grid;place-items:center;color:#6b7280;background:linear-gradient(180deg,#f8fafc,#eef2f7)}
    .meta{padding:8px 10px}
    .title{font-weight:700}

    /* NEW: force two-line meta so stats never spill */
    .price-line{display:flex;align-items:center;gap:8px}
    .price{font-weight:800}
    .specs{display:flex;flex-wrap:wrap;gap:8px;color:#6b7280;margin-top:6px}
    .specs span{white-space:nowrap}

    .add-btn{ width:100%; margin:10px 0 0; padding:10px 12px; border-radius:10px; border:1px solid var(--hm-accent); background:var(--hm-accent); color:#fff; font-weight:700; cursor:pointer; }
    .add-btn[disabled]{opacity:.6; cursor:not-allowed;}

    /* Footer */
    .hm-footer{background:#fff;border-top:1px solid var(--hm-border);margin-top:18px}
    .hm-footer .footer-wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
    .hm-footer .footer-links a{color:#4b5563;margin-left:14px;text-decoration:none}
    .hm-footer .footer-links a:first-child{margin-left:0}
  </style>
</head>
<body>

<header class="hm-header" role="banner">
  <div class="wrap">
    <div class="left">
      <button class="hamburger" id="openMenu" aria-label="Open menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <line x1="4" y1="6"  x2="20" y2="6"></line>
          <line x1="4" y1="12" x2="20" y2="12"></line>
          <line x1="4" y1="18" x2="20" y2="18"></line>
        </svg>
      </button>
      <a class="hm-brand" href="index.html">Hemline Market</a>
    </div>
    <div class="right">
      <a class="hm-icon" href="browse.html" aria-label="Browse & search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.3-4.3"></path></svg>
      </a>
      <a class="hm-icon" href="favorites.html" aria-label="Favorites">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"></path></svg>
      </a>
      <a class="hm-icon" href="notifications.html" aria-label="Notifications">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
      </a>
      <!-- Badge ONLY on Cart -->
      <a class="hm-icon" href="cart.html" aria-label="Cart">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="9" cy="21" r="1"></circle><circle cx="18" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
        <span class="cart-badge" data-cart-badge></span>
      </a>
      <a class="hm-avatar" id="avatar" href="account.html" title="Your profile">AA</a>
      <a class="hm-btn-primary" href="sell.html">Sell</a>
    </div>
  </div>
</header>

<aside class="sheet" id="menuSheet" aria-hidden="true">
  <header>
    <strong>Menu</strong>
    <button class="close" id="closeMenu" aria-label="Close menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </header>
  <nav>
    <a href="browse.html">Browse</a>
    <a href="atelier.html">My Atelier</a>
    <a href="orders.html">Orders</a>
    <a href="favorites.html">Favorites</a>
    <a href="account.html">Account</a>
    <a href="help.html">Help</a>
  </nav>
</aside>

<div class="wrap">
  <div class="topbar">
    <input id="q" type="search" placeholder="Search fabrics…">
    <button id="doSearch">Search</button>
    <button id="openFilters" class="btn" aria-label="Open filters">Filters</button>
  </div>
  <div id="selectedChips" class="chips" aria-live="polite"></div>

  <div class="layout">
    <!-- left filters (unchanged markup from your build) -->
    <aside class="filters" id="filters">
      <h3 style="margin:0 0 6px">Filters</h3>
      <section class="section"><div class="title">Content</div><div class="listbox" id="contentBox"></div></section>
      <section class="section"><div class="title">Color Family</div><div id="colorBox"></div></section>
      <section class="section"><div class="title">$/yard</div><div class="mini"><div class="field"><label>Min</label><input id="minPrice" type="number" min="0" step="1"></div><div class="field"><label>Max</label><input id="maxPrice" type="number" min="0" step="1"></div></div></section>
      <section class="section"><div class="title">Yards</div><div class="mini"><div class="field" style="grid-column:1/-1"><label>Min yards</label><input id="minYards" type="number" min="0" step="1"></div></div></section>
      <section class="section"><div class="title">Width (in)</div><div class="mini"><div class="field"><label>Min</label><input id="minWidth" type="number" min="0" step="1"></div><div class="field"><label>Max</label><input id="maxWidth" type="number" min="0" step="1"></div></div></section>
      <section class="section"><div class="title">Weight (GSM)</div><div class="mini"><div class="field"><label>Min GSM</label><input id="minGsm" type="number" min="0" step="1"></div><div class="field"><label>Max GSM</label><input id="maxGsm" type="number" min="0" step="1"></div></div></section>
      <section class="section"><div class="title">Department</div><div class="selects"><select id="dept"><option value="">Any</option><option>Fashion</option><option>Home</option><option>Quilting</option><option>Notions</option></select></div></section>
      <section class="section"><div class="title">Fabric Type</div><div class="selects"><select id="fabricType"><option value="">Any</option><option>Canvas</option><option>Chiffon</option><option>Corduroy</option><option>Crepe</option><option>Denim</option><option>Flannel</option><option>Georgette</option><option>Jersey</option><option>Lace</option><option>Lawn</option><option>Organza</option><option>Poplin</option><option>Sateen</option><option>Satin</option><option>Tulle</option><option>Twill</option><option>Velvet</option><option>Voile</option></select></div></section>
      <section class="section"><div class="title">Fiber Type</div><div class="selects"><select id="fiberType"><option value="">Any</option><option>Natural</option><option>Modified Natural</option><option>Synthetic</option><option>Blend</option></select></div></section>
      <section class="section"><div class="title">Designer / Mill</div><div class="selects"><input id="designer" placeholder="e.g., Loro Piana"></div></section>
      <section class="section"><div class="title">Country / Origin</div><div class="selects"><select id="origin"><option value="">Any</option><option>Italy</option><option>France</option><option>Japan</option><option>UK</option><option>USA</option><option>India</option><option>China</option><option>Korea</option></select></div></section>
      <section class="section"><div class="title">Pattern</div><div class="selects"><select id="pattern"><option value="">Any</option><option>Solid</option><option>Printed</option></select></div></section>
      <div style="display:flex;justify-content:space-between;margin-top:10px">
        <button class="btn" id="clear">Clear</button>
        <button class="btn btn-primary" id="apply">Apply</button>
      </div>
    </aside>

    <section class="results">
      <div class="results-head">
        <h2 id="resultTitle" style="margin:0;font-size:18px">Browse</h2>
        <div id="resultCount" style="color:#6b7280;font-size:13px">0 results</div>
      </div>
      <div id="grid" class="browse-grid"></div>
      <div id="empty" style="display:none;color:#6b7280">No results. Try relaxing a filter.</div>
    </section>
  </div>
</div>

<footer class="hm-footer" role="contentinfo">
  <div class="footer-wrap">
    <div class="copy">© 2025 Hemline Market</div>
    <nav class="footer-links" aria-label="Footer">
      <a href="about.html">About</a>
      <a href="faq.html">FAQ</a>
      <a href="contact.html">Contact</a>
      <a href="terms.html">Terms</a>
      <a href="privacy.html">Privacy</a>
    </nav>
  </div>
</footer>

<script>
/* Header & avatar */
(function(){
  const sheet=document.getElementById("menuSheet");
  document.getElementById("openMenu").onclick=(e)=>{e.preventDefault();sheet.classList.add("open");sheet.setAttribute("aria-hidden","false");}
  document.getElementById("closeMenu").onclick=(e)=>{e.preventDefault();sheet.classList.remove("open");sheet.setAttribute("aria-hidden","true");}
  document.addEventListener("keydown",e=>{ if(e.key==="Escape") sheet.classList.remove("open"); });
  try{ const a=document.getElementById("avatar"); const url=localStorage.getItem("avatarUrl"); if(url){ a.textContent=''; a.style.backgroundImage="url('"+url+"')"; } }catch(_){}
})();
</script>

<script>
/* Tiny in-page data fetch + render (same behavior as before) */
(function(){
  const CONTENT=["Any","Acetate","Acrylic","Alpaca","Angora","Bamboo","Cashmere","Cotton","Cupro","Hemp","Leather","Linen","Lurex","Modal","Mohair","Nylon","Polyester","Rayon / Viscose","Silk","Spandex / Elastane","Tencel / Lyocell","Wool","Other Fibers"];
  const COLORS=[{name:"Black",hex:"#000"},{name:"Grey",hex:"#9aa0a6"},{name:"White",hex:"#fff",border:"#d1d5db"},{name:"Cream",hex:"#f5efe4"},{name:"Brown",hex:"#7a4a2a"},{name:"Pink",hex:"#f4a4b6"},{name:"Red",hex:"#d21d2b"},{name:"Orange",hex:"#f27a22"},{name:"Yellow",hex:"#f3c321"},{name:"Green",hex:"#2f7d32"},{name:"Blue",hex:"#2166d1"},{name:"Purple",hex:"#6b2da8"}];

  const $=id=>document.getElementById(id);
  const params=new URLSearchParams(location.search);

  const contentBox=$('contentBox');
  CONTENT.forEach(v=>{
    const id='cb_'+v.replace(/[^a-z0-9]/gi,'_');
    const row=document.createElement('div'); row.className='row';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.id=id; cb.value=v;
    const lb=document.createElement('label'); lb.htmlFor=id; lb.textContent=v;
    row.append(cb,lb); contentBox.append(row);
  });

  const colorBox=$('colorBox');
  COLORS.forEach(c=>{
    const sw=document.createElement('div'); sw.className='sw'; sw.dataset.name=c.name; if(c.hex) sw.style.background=c.hex; if(c.border) sw.style.borderColor=c.border;
    colorBox.append(sw);
  });

  // Read / set controls from URL
  function setVal(k){ const v=params.get(k); if(v!==null) $(k).value=v; }
  ['q','minPrice','maxPrice','minYards','minWidth','maxWidth','minGsm','maxGsm','dept','fabricType','fiberType','designer','origin','pattern'].forEach(setVal);

  function toFilters(){
    const term=(params.get('q')||'').toLowerCase();
    const num=k=>{ const v=params.get(k); return v==null||v===''?null:Number(v); };
    const minPrice=num('minPrice'), maxPrice=num('maxPrice'), minYards=num('minYards'), minWidth=num('minWidth'), maxWidth=num('maxWidth'), minGsm=num('minGsm'), maxGsm=num('maxGsm');
    const dept=(params.get('dept')||'').toLowerCase();
    const fabricType=(params.get('fabricType')||'').toLowerCase();
    const fiberType=(params.get('fiberType')||'').toLowerCase();
    const designer=(params.get('designer')||'').toLowerCase();
    const origin=(params.get('origin')||'').toLowerCase();
    const pattern=(params.get('pattern')||'').toLowerCase();
    return (it)=>{
      if(term){ const hay=(it.title+' '+(it.designer||'')).toLowerCase(); if(!hay.includes(term)) return false; }
      if(minPrice!=null && it.price<minPrice) return false;
      if(maxPrice!=null && it.price>maxPrice) return false;
      if(minYards!=null && (it.yards??0)<minYards) return false;
      if(minWidth!=null && (it.width??0)<minWidth) return false;
      if(maxWidth!=null && (it.width??0)>maxWidth) return false;
      if(minGsm!=null && (it.gsm??0)<minGsm) return false;
      if(maxGsm!=null && (it.gsm??0)>maxGsm) return false;
      if(dept && (it.dept||'').toLowerCase()!==dept) return false;
      if(fabricType && (it.fabricType||'').toLowerCase()!==fabricType) return false;
      if(fiberType && (it.fiberType||'').toLowerCase()!==fiberType) return false;
      if(designer && !(it.designer||'').toLowerCase().includes(designer)) return false;
      if(origin && (it.origin||'').toLowerCase()!==origin) return false;
      if(pattern && (it.pattern||'').toLowerCase()!==pattern) return false;
      return true;
    };
  }

  // Load (Supabase helper if present, else JSON)
  let ALL=[];
  async function ensureHelper(){
    if(window.HM_SUPA) return;
    try{
      const html = await (await fetch('/scripts/supabase-client.js',{cache:'no-store'})).text();
      const holder=document.createElement('div'); holder.innerHTML=html.trim(); const tag=holder.firstElementChild;
      document.body.appendChild(tag); await new Promise(r=>setTimeout(r,0));
    }catch(_){}
  }
  async function load(){
    try{
      await ensureHelper();
      if(window.HM_SUPA){
        const { rows } = await window.HM_SUPA.listActiveListings({ limit: 60 });
        ALL = (rows||[]).map(r=>({
          id: r.id || r.slug || String(r.title||'item'),
          title: r.title || 'Untitled',
          price: Number(r.price||0),
          width: Number(r.width||0),
          gsm: Number(r.gsm||0),
          designer: r.designer || '',
          yards: Number(r.yards||0),
          photo: r.cover_url || r.photo_url || ''
        }));
      }
      if(!ALL.length) throw new Error('fallback');
    }catch(_){
      try{ ALL = await (await fetch('/data/listings.json',{cache:'no-store'})).json(); }
      catch(e){ ALL=[]; }
    }
    render();
  }

  const grid=$('grid'), empty=$('empty'), resultCount=$('resultCount');

  function makeCard(it){
    const a=document.createElement('a');
    a.className='card';
    a.dataset.id=it.id||it.slug||it.title;
    a.href='/product.html?id='+encodeURIComponent(a.dataset.id);

    const ph=document.createElement('div'); ph.className='ph';
    if(it.photo){ const img=new Image(); img.src=it.photo; img.alt=it.title; ph.append(img); }
    else { ph.textContent=it.title; }

    const meta=document.createElement('div'); meta.className='meta';
    const t=document.createElement('div'); t.className='title'; t.textContent=it.title;

    // Two explicit lines so specs never crowd the price
    const priceLine=document.createElement('div'); priceLine.className='price-line';
    const price=document.createElement('span'); price.className='price'; price.textContent='$'+it.price+'/yd';
    priceLine.append(price);

    const specs=document.createElement('div'); specs.className='specs';
    const w=document.createElement('span'); w.textContent = (it.width||'—') + '″';
    const g=document.createElement('span'); g.textContent = (it.gsm||'—') + ' GSM';
    specs.append(w,g);

    const btn=document.createElement('button');
    btn.className='add-btn add-to-cart';
    btn.dataset.name=it.title;
    btn.dataset.amount=String(Math.round((it.price||0)*100));
    btn.textContent='Add to Cart – $'+it.price;

    meta.append(t,priceLine,specs,btn);

    a.append(ph,meta);
    return a;
  }

  function render(){
    const match=ALL.filter(toFilters());
    resultCount.textContent = match.length + (match.length===1?' result':' results');
    grid.innerHTML='';
    if(!match.length){ empty.style.display='block'; return; }
    empty.style.display='none';
    match.forEach(it=> grid.appendChild(makeCard(it)));
  }

  // Prevent navigating when pressing the add-to-cart button inside the card
  grid.addEventListener('click', (e)=>{
    if(e.target.closest('.add-to-cart')){ e.preventDefault(); }
  });

  // Basic actions
  $('apply').onclick=()=>{ location.href = location.pathname + '?' + new URLSearchParams(params).toString(); };
  $('clear').onclick=()=>{ history.replaceState(null,'',location.pathname); location.reload(); };
  $('doSearch').onclick=()=>{ params.set('q', $('q').value.trim()); history.replaceState(null,'','?'+params.toString()); render(); };

  load();
})();
</script>

<script>
/* Minimal cart badge — ONLY on the cart icon */
(function(){
  const badges=[...document.querySelectorAll('[data-cart-badge]')];
  function read(){ try{return JSON.parse(localStorage.getItem('hm_cart')||'[]')}catch(_){return[]} }
  function total(items){ return items.reduce((n,i)=>n+(i.qty||1),0) }
  function update(){ const n=total(read()); badges.forEach(b=>{ if(n>0){ b.textContent=n; b.style.display='inline-flex'; } else { b.textContent=''; b.style.display='none'; } }); }
  update();

  document.addEventListener('click', (e)=>{
    const btn=e.target.closest('.add-to-cart'); if(!btn) return;
    e.preventDefault();
    const card=btn.closest('.card');
    const id=card?.dataset.id || btn.dataset.name || 'item';
    const name=btn.dataset.name || 'Fabric';
    const amount=parseInt(btn.dataset.amount||'0',10);
    const cart=read();
    const i=cart.findIndex(x=>x.id===id);
    if(i>=0) cart[i].qty=(cart[i].qty||1)+1; else cart.push({id,name,amount,qty:1});
    localStorage.setItem('hm_cart', JSON.stringify(cart));
    update();
    const t=btn.textContent; btn.textContent='Added ✓'; btn.disabled=true; setTimeout(()=>{ btn.textContent=t; btn.disabled=false; },900);
  });
})();
</script>

</body>
</html>
