<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Account — Hemline Market</title>

  <style>
    :root {
      --hm-bg: #faf7f4;
      --hm-card-bg: #ffffff;
      --hm-border: #e5e1dc;
      --hm-accent: #b07b5a;
      --hm-text: #2b2623;
      --hm-muted: #7b736c;
      --hm-radius-lg: 16px;
      --hm-radius-pill: 999px;
      --hm-shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.06);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: var(--hm-bg);
      color: var(--hm-text);
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* Header */

    .hm-header {
      position: sticky;
      top: 0;
      z-index: 40;
      background: rgba(250, 247, 244, 0.9);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(229, 225, 220, 0.9);
    }

    .hm-header-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 0.75rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
    }

    .hm-logo {
      font-size: 1.05rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      font-weight: 600;
    }

    .hm-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.9rem;
    }

    .hm-nav a {
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid transparent;
    }

    .hm-nav a.hm-nav-active {
      border-color: var(--hm-border);
      background: rgba(255, 255, 255, 0.8);
    }

    .hm-nav a:hover {
      border-color: var(--hm-border);
      background: rgba(255, 255, 255, 0.6);
    }

    .hm-header-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .hm-user-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: var(--hm-radius-pill);
      border: 1px solid var(--hm-border);
      background: #fffaf5;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* Layout */

    .hm-page {
      max-width: 960px;
      margin: 1.75rem auto 2.75rem;
      padding: 0 1.25rem 2.5rem;
    }

    .hm-page-header {
      margin-bottom: 1.5rem;
    }

    .hm-page-eyebrow {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--hm-muted);
      margin-bottom: 0.25rem;
    }

    .hm-page-title {
      font-size: 1.6rem;
      letter-spacing: 0.02em;
      margin: 0;
    }

    .hm-page-subtitle {
      font-size: 0.9rem;
      margin-top: 0.4rem;
      color: var(--hm-muted);
      max-width: 36rem;
    }

    .hm-account-card {
      background: var(--hm-card-bg);
      border-radius: var(--hm-radius-lg);
      box-shadow: var(--hm-shadow-soft);
      border: 1px solid var(--hm-border);
      padding: 1.5rem 1.5rem 1.75rem;
    }

    .hm-account-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }

    .hm-account-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid var(--hm-border);
      background: #fff8f2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .hm-account-heading {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .hm-account-name {
      font-size: 1rem;
      font-weight: 600;
    }

    .hm-account-email {
      font-size: 0.85rem;
      color: var(--hm-muted);
    }

    .hm-account-meta {
      font-size: 0.75rem;
      color: var(--hm-muted);
    }

    .hm-account-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 1.5rem;
    }

    @media (min-width: 768px) {
      .hm-account-grid {
        grid-template-columns: minmax(0, 1.1fr);
      }
    }

    .hm-fieldset {
      border: 0;
      padding: 0;
      margin: 0;
    }

    .hm-fieldset + .hm-fieldset {
      margin-top: 1.25rem;
    }

    .hm-legend {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--hm-muted);
      margin-bottom: 0.75rem;
    }

    .hm-form-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    @media (min-width: 640px) {
      .hm-form-row.hm-form-row-2 {
        grid-template-columns: 1fr 1fr;
      }
      .hm-form-row.hm-form-row-3 {
        grid-template-columns: 1.1fr 0.9fr 0.9fr;
      }
    }

    label.hm-label {
      font-size: 0.8rem;
      display: block;
      color: var(--hm-muted);
      margin-bottom: 0.15rem;
    }

    input.hm-input,
    select.hm-input {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 10px;
      border: 1px solid var(--hm-border);
      font-size: 0.9rem;
      background: #fffdfb;
    }

    input.hm-input[readonly] {
      background: #f5f2ee;
      color: var(--hm-muted);
    }

    .hm-input::placeholder {
      color: #c0bab4;
    }

    .hm-helper {
      font-size: 0.75rem;
      color: var(--hm-muted);
      margin-top: 0.25rem;
    }

    .hm-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-top: 1.25rem;
      flex-wrap: wrap;
    }

    .hm-btn-primary {
      border: 0;
      border-radius: var(--hm-radius-pill);
      padding: 0.55rem 1.4rem;
      font-size: 0.9rem;
      font-weight: 500;
      background: radial-gradient(circle at 0% 0%, #f4d8bf, #b07b5a);
      color: #231710;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.14);
    }

    .hm-btn-primary:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: none;
    }

    .hm-status {
      font-size: 0.8rem;
      color: var(--hm-muted);
    }

    .hm-status--error {
      color: #b3261e;
    }

    .hm-status--success {
      color: #2e7d32;
    }

    /* Footer */

    .hm-footer {
      border-top: 1px solid var(--hm-border);
      padding: 1.25rem 1.25rem 1.75rem;
      font-size: 0.8rem;
      color: var(--hm-muted);
    }

    .hm-footer-inner {
      max-width: 1120px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="hm-header">
    <div class="hm-header-inner">
      <a href="index.html" class="hm-logo">HEMLINE&nbsp;MARKET</a>

      <nav class="hm-nav" aria-label="Primary">
        <a href="atelier.html">Atelier</a>
        <a href="threadtalk.html">ThreadTalk</a>
        <a href="about.html">About</a>
      </nav>

      <div class="hm-header-right">
        <a href="account.html" id="header-user-pill" class="hm-user-pill" aria-label="Account">
          <span id="header-user-initials">RK</span>
        </a>
      </div>
    </div>
  </header>

  <!-- PAGE -->
  <main class="hm-page">
    <header class="hm-page-header">
      <div class="hm-page-eyebrow">Account</div>
      <h1 class="hm-page-title">Profile & Shop details</h1>
      <p class="hm-page-subtitle">
        This is the “back room” of Hemline Market. Keep your profile and shipping
        details up to date so orders and atelier projects stay tidy.
      </p>
    </header>

    <section class="hm-account-card" aria-label="Account settings">
      <div class="hm-account-header">
        <div class="hm-account-avatar" id="account-avatar-initials">RK</div>
        <div class="hm-account-heading">
          <div class="hm-account-name" id="account-name">Roza Kalwar</div>
          <div class="hm-account-email" id="account-email">you@example.com</div>
          <div class="hm-account-meta" id="account-meta">
            Signed in to Hemline Market
          </div>
        </div>
      </div>

      <form id="account-form" autocomplete="on">
        <div class="hm-account-grid">
          <div>
            <!-- Identity -->
            <fieldset class="hm-fieldset">
              <legend class="hm-legend">Profile</legend>

              <div class="hm-form-row hm-form-row-2">
                <div>
                  <label class="hm-label" for="first_name">First name</label>
                  <input
                    class="hm-input"
                    type="text"
                    id="first_name"
                    name="first_name"
                    autocomplete="given-name"
                    placeholder="Roza"
                  />
                </div>
                <div>
                  <label class="hm-label" for="last_name">Last name</label>
                  <input
                    class="hm-input"
                    type="text"
                    id="last_name"
                    name="last_name"
                    autocomplete="family-name"
                    placeholder="Kalwar"
                  />
                </div>
              </div>

              <div class="hm-form-row hm-form-row-2">
                <div>
                  <label class="hm-label" for="display_name">Display name</label>
                  <input
                    class="hm-input"
                    type="text"
                    id="display_name"
                    name="display_name"
                    placeholder="Afroza at Hemline Market"
                  />
                  <div class="hm-helper">
                    How your name appears on comments, atelier notes, etc.
                  </div>
                </div>
                <div>
                  <label class="hm-label" for="shop_name">Shop name</label>
                  <input
                    class="hm-input"
                    type="text"
                    id="shop_name"
                    name="shop_name"
                    placeholder="Hemline Market"
                  />
                  <div class="hm-helper">
                    Optional. This is the name visitors see for your shop.
                  </div>
                </div>
              </div>

              <div class="hm-form-row">
                <div>
                  <label class="hm-label" for="email">Email</label>
                  <input
                    class="hm-input"
                    type="email"
                    id="email"
                    name="email"
                    readonly
                  />
                  <div class="hm-helper">
                    Email is managed by sign-in. Change it via your auth provider.
                  </div>
                </div>
              </div>
            </fieldset>

            <!-- Address -->
            <fieldset class="hm-fieldset">
              <legend class="hm-legend">Shipping address</legend>

              <div class="hm-form-row">
                <div>
                  <label class="hm-label" for="address_line1">Address line 1</label>
                  <input
                    class="hm-input"
                    type="text"
                    id="address_line1"
                    name="address_line1"
                    autocomplete="address-line1"
                    placeholder="123 Atelier Lane"
                  />
                </div>
              </div>

              <div class="hm-form-row">
                <div>
                  <label class="hm-label" for="address_line2">Address line 2</label>
                  <input
                    class="hm-input"
                    type="text"
                    id="address_line2"
                    name="address_line2"
                    autocomplete="address-line2"
                    placeholder="Apt, floor, building (optional)"
                  />
                </div>
              </div>

              <div class="hm-form-row hm-form-row-3">
                <div>
                  <label class="hm-label" for="postal_code">ZIP code</label>
                  <input
                    class="hm-input"
                    type="text"
                    id="postal_code"
                    name="postal_code"
                    autocomplete="postal-code"
                    inputmode="numeric"
                    placeholder="78258"
                  />
                  <div class="hm-helper">
                    City & state will auto-fill from ZIP when possible.
                  </div>
                </div>

                <div>
                  <label class="hm-label" for="city">City</label>
                  <input
                    class="hm-input"
                    type="text"
                    id="city"
                    name="city"
                    autocomplete="address-level2"
                    placeholder="San Antonio"
                  />
                </div>

                <div>
                  <label class="hm-label" for="state">State</label>
                  <input
                    class="hm-input"
                    type="text"
                    id="state"
                    name="state"
                    autocomplete="address-level1"
                    placeholder="TX"
                  />
                </div>
              </div>

              <div class="hm-form-row">
                <div>
                  <label class="hm-label" for="country">Country / Region</label>
                  <input
                    class="hm-input"
                    type="text"
                    id="country"
                    name="country"
                    autocomplete="country-name"
                    placeholder="United States"
                  />
                </div>
              </div>
            </fieldset>

            <div class="hm-actions">
              <button class="hm-btn-primary" type="submit" id="account-save-btn">
                Save changes
              </button>
              <div class="hm-status" id="account-status" aria-live="polite">
                &nbsp;
              </div>
            </div>
          </div>
        </div>
      </form>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="hm-footer">
    <div class="hm-footer-inner">
      <div>© <span id="hm-year"></span> Hemline Market.</div>
      <div>Built in the Hemline Market atelier.</div>
    </div>
  </footer>

  <!-- SCRIPTS -->
  <script type="module">
    import { supabase } from "./scripts/supabase-client.js";

    const initialsSpan = document.querySelector("#header-user-initials");
    const headerPill = document.querySelector("#header-user-pill");

    const accountAvatar = document.querySelector("#account-avatar-initials");
    const accountName = document.querySelector("#account-name");
    const accountEmail = document.querySelector("#account-email");
    const accountMeta = document.querySelector("#account-meta");
    const accountForm = document.querySelector("#account-form");
    const saveButton = document.querySelector("#account-save-btn");
    const statusEl = document.querySelector("#account-status");

    const zipInput = document.querySelector("#postal_code");
    const cityInput = document.querySelector("#city");
    const stateInput = document.querySelector("#state");

    document.querySelector("#hm-year").textContent = new Date().getFullYear();

    async function requireSession() {
      const { data, error } = await supabase.auth.getUser();
      if (error || !data?.user) {
        window.location.href = "auth.html";
        return null;
      }
      return data.user;
    }

    function computeInitials(firstName, lastName, fallbackEmail) {
      const parts = [];
      if (firstName) parts.push(firstName.trim()[0]);
      if (lastName) parts.push(lastName.trim()[0]);
      if (!parts.length && fallbackEmail) {
        const emailPart = String(fallbackEmail).split("@")[0] || "";
        parts.push(emailPart[0] || "R");
      }
      return parts.join("").toUpperCase().slice(0, 2);
    }

    function setStatus(message, kind = "neutral") {
      if (!statusEl) return;
      statusEl.textContent = message || "";
      statusEl.classList.remove("hm-status--error", "hm-status--success");
      if (kind === "error") statusEl.classList.add("hm-status--error");
      if (kind === "success") statusEl.classList.add("hm-status--success");
    }

    async function loadProfile(user) {
      const { data, error } = await supabase
        .from("profiles")
        .select("*")
        .eq("id", user.id)
        .maybeSingle();

      if (error) {
        console.error("loadProfile error", error);
        return { profile: null };
      }

      const profile = data || {};
      const firstName = profile.first_name || "";
      const lastName = profile.last_name || "";
      const displayName = profile.display_name || "";
      const shopName = profile.shop_name || "";
      const email = user.email;

      const initials = computeInitials(firstName || profile.full_name, lastName, email);

      if (initialsSpan) initialsSpan.textContent = initials;
      if (accountAvatar) accountAvatar.textContent = initials;
      if (headerPill) headerPill.title = displayName || profile.full_name || email;
      if (accountName) {
        const fullName =
          profile.full_name ||
          [firstName, lastName].filter(Boolean).join(" ") ||
          displayName ||
          email;
        accountName.textContent = fullName;
      }
      if (accountEmail) accountEmail.textContent = email;
      if (accountMeta) accountMeta.textContent = "Signed in";

      const set = (name, value) => {
        const input = accountForm.elements[name];
        if (input && value != null) input.value = value;
      };

      set("first_name", firstName);
      set("last_name", lastName);
      set("display_name", displayName);
      set("shop_name", shopName);
      set("email", email);

      set("address_line1", profile.address_line1);
      set("address_line2", profile.address_line2);
      set("city", profile.city);
      set("state", profile.state);
      set("postal_code", profile.postal_code);
      set("country", profile.country || "United States");

      return { profile };
    }

    async function handleSave(event) {
      event.preventDefault();
      setStatus("Saving…");
      saveButton.disabled = true;

      const { data, error: userError } = await supabase.auth.getUser();
      if (userError || !data?.user) {
        window.location.href = "auth.html";
        return;
      }
      const user = data.user;

      const formData = new FormData(accountForm);

      const firstName = (formData.get("first_name") || "").toString().trim();
      const lastName = (formData.get("last_name") || "").toString().trim();
      const displayName = (formData.get("display_name") || "").toString().trim();
      const shopName = (formData.get("shop_name") || "").toString().trim();
      const addressLine1 = (formData.get("address_line1") || "").toString().trim();
      const addressLine2 = (formData.get("address_line2") || "").toString().trim();
      const city = (formData.get("city") || "").toString().trim();
      const state = (formData.get("state") || "").toString().trim();
      const postalCode = (formData.get("postal_code") || "").toString().trim();
      const country = (formData.get("country") || "").toString().trim();

      const fullName =
        [firstName, lastName].filter(Boolean).join(" ") ||
        displayName ||
        user.email;

      const payload = {
        id: user.id,
        email: user.email,
        first_name: firstName || null,
        last_name: lastName || null,
        display_name: displayName || null,
        shop_name: shopName || null,
        address_line1: addressLine1 || null,
        address_line2: addressLine2 || null,
        city: city || null,
        state: state || null,
        postal_code: postalCode || null,
        country: country || null,
        full_name: fullName || null,
        updated_at: new Date().toISOString(),
      };

      const { error } = await supabase
        .from("profiles")
        .upsert(payload, { onConflict: "id" });

      if (error) {
        console.error("saveProfile error", error);
        setStatus("Could not save changes. Please try again.", "error");
      } else {
        setStatus("Saved.", "success");
        // Keep header/avatar in sync immediately after save
        const initials = computeInitials(firstName, lastName, user.email);
        if (initialsSpan) initialsSpan.textContent = initials;
        if (accountAvatar) accountAvatar.textContent = initials;
        if (accountName) accountName.textContent = fullName;
        if (headerPill) headerPill.title = displayName || fullName;
      }

      saveButton.disabled = false;
    }

    async function autoFillCityStateFromZip() {
      if (!zipInput) return;
      const zip = zipInput.value.trim();
      if (!zip || zip.length < 5) return;

      try {
        const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
        if (!res.ok) return;
        const data = await res.json();
        const place = data?.places?.[0];
        if (!place) return;

        if (cityInput && !cityInput.value) {
          cityInput.value = place["place name"];
        }
        if (stateInput && !stateInput.value) {
          stateInput.value = place["state abbreviation"];
        }
      } catch (err) {
        console.error("ZIP lookup error", err);
      }
    }

    async function init() {
      const user = await requireSession();
      if (!user) return;

      await loadProfile(user);

      accountForm.addEventListener("submit", handleSave);

      if (zipInput) {
        zipInput.addEventListener("blur", autoFillCityStateFromZip);
      }
    }

    init();
  </script>
</body>
</html>
