<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Browse — Hemline Market</title>

  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">

  <!-- Shared styles (universal stack) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      /* Match universal tokens */
      --hm-accent:#991b1b;
      --hm-text:#111827;
      --hm-muted:#6b7280;
      --hm-border:#e5e7eb;
      --hm-bg-card:rgba(255,255,255,.96);

      /* Browse-specific aliases */
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#991b1b;
      --bg:#fafafa;
    }

    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:
        url("images/homepage.jpeg") center/cover fixed no-repeat,
        var(--bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* ===== BROWSE MAIN LAYOUT ===== */
    .browse-wrap{
      max-width:1100px;
      margin:18px auto 28px;
      padding:0 12px;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .topbar input[type="search"]{
      flex:1;
      min-width:0;
      padding:10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
    }
    .topbar button{
      padding:9px 12px;
      border-radius:10px;
      border:1px solid var(--accent);
      background:var(--accent);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      white-space:nowrap;
    }
    .filter-toggle{
      border-color:var(--border);
      background:#fff;
      color:#111827;
    }

    .layout{
      display:grid;
      grid-template-columns:280px 1fr;
      gap:14px;
    }
    .layout.filters-hidden .filters{display:none;}
    .layout.filters-hidden{grid-template-columns:1fr;}

    @media(max-width:900px){
      .layout{grid-template-columns:1fr;}
      .topbar input[type="search"]{flex-basis:100%;}
    }

    /* ---------- FILTERS ---------- */
    .filters{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      height:max-content;
    }
    .filters h3{margin:0 0 8px;}
    .section{
      border-top:1px solid var(--border);
      padding-top:8px;
      margin-top:8px;
    }
    .section:first-of-type{
      border-top:0;
      padding-top:0;
      margin-top:0;
    }
    .title{
      font-weight:700;
      font-size:13px;
      color:#374151;
      margin:0 0 6px;
    }
    .listbox{
      max-height:230px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px;
      background:#fff;
    }
    .row{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 4px;
      border-bottom:1px dashed #f3f4f6;
    }
    .row:last-child{border-bottom:0;}
    .row input{
      width:14px;
      height:14px;
    }
    .row label{
      font-size:12px;
      color:#374151;
    }
    .mini{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .mini .field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .mini label{
      font-size:12px;
      color:#374151;
    }
    .mini input{
      padding:7px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      font-size:13px;
      max-width:120px;
    }
    .selects{
      display:grid;
      gap:8px;
    }
    .selects select,
    .selects input{
      width:100%;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
    }

    /* COLOR BOX */
    #colorBox{
      --sw:22px;
      --gap:6px;
      display:grid;
      grid-template-columns:repeat(5,var(--sw));
      grid-template-rows:repeat(3,var(--sw));
      gap:var(--gap);
      align-content:start;
      justify-content:start;
      padding:6px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:10px;
    }
    #colorBox .sw{
      width:var(--sw);
      height:var(--sw);
      border-radius:6px;
      border:1px solid #d1d5db;
      box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);
      cursor:pointer;
      position:relative;
    }
    #colorBox .sw[data-selected="true"]{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }
    #colorBox .sw .tip{
      position:absolute;
      bottom:130%;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,.85);
      color:#fff;
      padding:2px 5px;
      border-radius:4px;
      font-size:10px;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
    }
    #colorBox .sw:hover .tip{opacity:1}
    #colorBox .sw[data-name="Gold"]{
      background:linear-gradient(135deg,#d4b870 0%,#f0dc97 50%,#ceb86b 100%);
    }
    #colorBox .sw[data-name="Silver"]{
      background:linear-gradient(135deg,#bfc6cf 0%,#e6eaef 50%,#a9b0ba 100%);
    }

    /* ---------- RESULTS ---------- */
    .results{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      min-height:300px;
    }
    .results-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }

    .browse-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
      align-items:flex-start;
    }
    @media(max-width:900px){
      .browse-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media(max-width:560px){
      /* match homepage/atelier: keep 2 columns on small phones */
      .browse-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }

    /* LISTING / ATELIER CARDS – reuse same shell */
    .listing-card{
      background:var(--hm-bg-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .listing-thumb-link{
      display:block;
      text-decoration:none;
      color:inherit;
    }
    .listing-thumb{
      aspect-ratio:4/3;
      background:linear-gradient(180deg,#f8fafc,#eef2f7);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .listing-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .listing-body{
      padding:8px 10px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .listing-title-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:6px;
    }
    .listing-title{
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-decoration:none;
      color:#111827;
    }
    .listing-dept{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#f3f4f6;
      color:#4b5563;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .listing-yards{
      font-size:12px;
      color:#4b5563;
    }
    .listing-cta-row{
      margin-top:4px;
    }
    .listing-add-btn{
      width:100%;
      border-radius:10px;
      border:1px solid var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      font-weight:700;
      font-size:13px;
      padding:8px 10px;
      cursor:pointer;
      white-space:normal;    /* allow wrap on mobile */
      line-height:1.25;
      text-align:center;
      display:inline-block;
    }
    .listing-add-btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    .listing-price-row{
      margin-top:6px;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
    }
    .listing-price-main{
      font-weight:700;
      color:#111827;
    }
    .listing-price-orig{
      text-decoration:line-through;
      color:#9ca3af;
    }
    .listing-seller-row{
      margin-top:4px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      color:#6b7280;
    }
    .listing-seller-name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Section Header - matches homepage */
    .section-header{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      margin:0 0 28px;
      padding:24px 20px;
      background:linear-gradient(135deg, rgba(255,255,255,0.95), rgba(254,243,242,0.9));
      border-radius:16px;
      border:1px solid rgba(153,27,27,0.15);
      box-shadow:0 8px 24px rgba(153,27,27,0.08);
    }
    .section-header h2{
      margin:0 0 8px;
      font-size:36px;
      font-weight:700;
      color:#991b1b;
      font-family: Georgia, 'Times New Roman', serif;
      letter-spacing: 2px;
      text-transform:uppercase;
      position:relative;
    }
    .section-header h2::after{
      content:"";
      display:block;
      width:60px;
      height:3px;
      background:#991b1b;
      margin:12px auto 0;
      border-radius:2px;
    }
    .section-header-subtitle{
      font-size:15px;
      color:#4b5563;
      margin-top:4px;
    }
    .browse-controls{
      display:flex;
      align-items:center;
      gap:20px;
      margin-top:8px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .sort-control{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
      color:#4b5563;
    }
    .sort-control select{
      padding:6px 12px;
      border:1px solid #e5e7eb;
      border-radius:6px;
      font-size:14px;
      color:#374151;
      background:#fff;
      cursor:pointer;
    }
    .sort-control select:focus{
      outline:none;
      border-color:#991b1b;
    }

    /* Empty State - matches homepage */
    .home-empty{
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      padding:40px 20px;
      background:#fff;
      border-radius:14px;
      border:1px solid #e5e7eb;
    }
    .empty-illustration{
      margin-bottom:16px;
      opacity:0.9;
    }
    .empty-title{
      margin:0 0 8px;
      font-size:18px;
      font-weight:700;
      color:#111827;
    }
    .empty-text{
      margin:0 0 16px;
      font-size:14px;
      color:#6b7280;
      max-width:300px;
    }
    .empty-cta{
      padding:10px 20px;
      background:#991b1b;
      color:#fff;
      font-weight:600;
      font-size:14px;
      border-radius:8px;
      text-decoration:none;
      border:none;
      cursor:pointer;
    }
    .empty-cta:hover{
      filter:brightness(1.1);
    }
  @media(max-width:768px){body{background-position:20% center;}}
  </style>
</head>
<body>

  <!-- UNIVERSAL HEADER (injected by hm-shell.js) -->
  <div id="hm-shell-header"></div>

  <main class="browse-wrap">
    <div class="topbar">
      <input id="q" type="search" placeholder="Search fabrics…"/>
      <button id="doSearch" type="button">Search</button>
      <button id="toggleFilters" type="button" class="filter-toggle" aria-pressed="true">Hide filters</button>
    </div>

    <div class="layout" id="layout">
      <aside class="filters">
        <h3>Filters</h3>

        <!-- CONTENT (KNOWN) -->
        <section class="section">
          <div class="title">Content</div>
          <div class="listbox" id="contentBox"></div>
        </section>

        <!-- FEELS LIKE (UNKNOWN CONTENT) – dropdown -->
        <section class="section">
          <div class="title">
            Fabric feels like
            <span style="font-weight:400;font-size:11px;color:var(--muted);">
              (for mystery / unknown content)
            </span>
          </div>
          <div class="selects">
            <select id="feelsLike">
              <option value="">Any</option>
              <option>cotton / poplin</option>
              <option>linen</option>
              <option>silk</option>
              <option>chiffon</option>
              <option>crepe</option>
              <option>satin</option>
              <option>jersey knit</option>
              <option>denim</option>
              <option>flannel / brushed cotton</option>
              <option>fleece</option>
              <option>wool suiting</option>
              <option>tweed</option>
              <option>velvet / velour</option>
              <option>lace</option>
              <option>tulle</option>
              <option>organza</option>
              <option>leather</option>
              <option>faux leather</option>
              <option>vinyl</option>
              <option>suede</option>
            </select>
          </div>
        </section>

        <section class="section">
          <div class="title">Color Family</div>
          <div id="colorBox"></div>
        </section>

        <section class="section">
          <div class="title">$/yard</div>
          <div class="mini">
            <div class="field">
              <label>Min</label>
              <input id="minPrice" type="number" min="0" step="1">
            </div>
            <div class="field">
              <label>Max</label>
              <input id="maxPrice" type="number" min="0" step="1">
            </div>
          </div>
        </section>

        <section class="section">
          <div class="title">Yards</div>
          <div class="mini">
            <div class="field" style="grid-column:1/-1">
              <label>Min yards</label>
              <input id="minYards" type="number" min="0" step="1">
            </div>
          </div>
        </section>

        <section class="section">
          <div class="title">Width (in)</div>
          <div class="mini">
            <div class="field">
              <label>Min</label>
              <input id="minWidth" type="number" min="0" step="1">
            </div>
            <div class="field">
              <label>Max</label>
              <input id="maxWidth" type="number" min="0" step="1">
            </div>
          </div>
        </section>

        <section class="section">
          <div class="title">Weight (GSM)</div>
          <div class="mini">
            <div class="field">
              <label>Min GSM</label>
              <input id="minGsm" type="number" min="0" step="1">
            </div>
            <div class="field">
              <label>Max GSM</label>
              <input id="maxGsm" type="number" min="0" step="1">
            </div>
          </div>
        </section>

        <section class="section">
          <div class="title">Department</div>
          <div class="selects">
            <select id="dept">
              <option value="">Any</option>
              <option>Fashion</option>
              <option>Home</option>
              <option>Quilting</option>
              <option>Notions</option>
            </select>
          </div>
        </section>

        <section class="section">
          <div class="title">Fabric Type</div>
          <div class="selects">
            <select id="fabricType">
              <option value="">Any</option>
              <option>Canvas</option>
              <option>Chiffon</option>
              <option>Corduroy</option>
              <option>Crepe</option>
              <option>Denim</option>
              <option>Flannel</option>
              <option>Georgette</option>
              <option>Jersey</option>
              <option>Lace</option>
              <option>Lawn</option>
              <option>Organza</option>
              <option>Poplin</option>
              <option>Sateen</option>
              <option>Satin</option>
              <option>Tulle</option>
              <option>Twill</option>
              <option>Velvet</option>
              <option>Voile</option>
            </select>
          </div>
        </section>

        <section class="section">
          <div class="title">Fiber Type</div>
          <div class="selects">
            <select id="fiberType">
              <option value="">Any</option>
              <option>Natural</option>
              <option>Modified Natural</option>
              <option>Synthetic</option>
              <option>Blend</option>
            </select>
          </div>
        </section>

        <section class="section">
          <div class="title">Designer / Mill</div>
          <div class="selects">
            <input id="designer" placeholder="e.g., Loro Piana"/>
          </div>
        </section>

        <section class="section">
          <div class="title">Country / Origin</div>
          <div class="selects">
            <select id="origin">
              <option value="">Any</option>
              <option>Italy</option>
              <option>France</option>
              <option>Japan</option>
              <option>UK</option>
              <option>USA</option>
              <option>India</option>
              <option>China</option>
              <option>Korea</option>
            </select>
          </div>
        </section>

        <section class="section">
          <div class="title">Pattern</div>
          <div class="selects">
            <select id="pattern">
              <option value="">Any</option>
              <option>Solid</option>
              <option>Printed</option>
            </select>
          </div>
        </section>
      </aside>

      <section class="results">
        <div class="section-header">
          <h2>New Arrivals</h2>
          <div class="browse-controls">
            <div id="resultCount" class="section-header-subtitle">Loading…</div>
            <div class="sort-control">
              <label for="sortBy">Sort by:</label>
              <select id="sortBy">
                <option value="newest">Newest</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="yards-high">Most Yards</option>
              </select>
            </div>
          </div>
        </div>
        <div id="grid" class="browse-grid"></div>
        
        <!-- Empty state - no filters applied -->
        <div id="empty" class="home-empty" style="display:none;">
          <img src="images/empty-state.svg" alt="" class="empty-illustration" width="200" height="160" loading="lazy"/>
          <h3 class="empty-title">No listings yet</h3>
          <p class="empty-text">Once sellers start listing fabric, new cards will appear here.</p>
          <a href="sell.html" class="empty-cta">Be the first to list fabric →</a>
        </div>
        
        <!-- Empty state - filters applied but no results -->
        <div id="emptyFiltered" class="home-empty" style="display:none;">
          <img src="images/empty-state.svg" alt="" class="empty-illustration" width="200" height="160" loading="lazy"/>
          <h3 class="empty-title">No matches found</h3>
          <p class="empty-text">We couldn't find fabrics matching your filters. Try broadening your search!</p>
          <button onclick="clearAllFilters()" class="empty-cta">Clear all filters →</button>
        </div>
      </section>
    </div>
  </main>

  <!-- UNIVERSAL FOOTER (injected by hm-shell.js) -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Shared shell (universal header/footer + menu + header session) -->
  <script src="scripts/hm-shell.js"></script>

  <script>
    // Render shared header + footer
    window.HM && window.HM.renderShell({ currentPage: "browse" });
  </script>

  <script>
    /* Supabase client + listings / ateliers */

    const supabaseClient = window.supabase.createClient(
      "https://clkizksbvxjkoatdajgd.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI"
    );

    // "listings" (default) vs "ateliers"
    let currentMode = "listings";

    /* --- Filters state --- */

    const CONTENTS = [
      "Acetate",
      "Acrylic",
      "Alpaca",
      "Angora",
      "Bamboo",
      "Cashmere",
      "Cotton",
      "Cupro",
      "Hemp",
      "Leather",
      "Linen",
      "Lurex",
      "Modal",
      "Mohair",
      "Nylon",
      "Polyester",
      "Rayon / Viscose",
      "Silk",
      "Spandex / Elastane",
      "Tencel / Lyocell",
      "Wool",
      "Other Fibers"
    ];

    const COLORS = [
      "Black","Grey","White","Cream","Brown",
      "Pink","Red","Orange","Yellow","Green",
      "Blue","Purple","Gold","Silver"
    ];

    const selectedContents = new Set();
    const selectedColors = new Set();

    function buildFiltersUI(){
      const contentBox = document.getElementById("contentBox");
      const colorBox   = document.getElementById("colorBox");

      if(contentBox){
        contentBox.innerHTML = "";
        CONTENTS.forEach(label=>{
          const row = document.createElement("div");
          row.className = "row";
          const cb  = document.createElement("input");
          cb.type   = "checkbox";
          cb.name   = "content";
          cb.value  = label;
          const lb  = document.createElement("label");
          lb.textContent = label;
          row.appendChild(cb);
          row.appendChild(lb);
          cb.addEventListener("change",()=>{
            if(cb.checked) selectedContents.add(label); else selectedContents.delete(label);
            runSearch();
          });
          contentBox.appendChild(row);
        });
      }

      if(colorBox){
        colorBox.innerHTML = "";
        COLORS.forEach(name=>{
          const sw = document.createElement("button");
          sw.type = "button";
          sw.className = "sw";
          sw.dataset.name = name;
          sw.setAttribute("aria-label", name);
          const tip = document.createElement("span");
          tip.className = "tip";
          tip.textContent = name;
          sw.appendChild(tip);
          if(name !== "Gold" && name !== "Silver"){
            sw.style.backgroundColor = name.toLowerCase();
          }
          sw.addEventListener("click", ()=>{
            if(selectedColors.has(name)){
              selectedColors.delete(name);
              sw.dataset.selected = "false";
            }else{
              selectedColors.add(name);
              sw.dataset.selected = "true";
            }
            runSearch();
          });
          colorBox.appendChild(sw);
        });
      }
    }

    /* Toggle filters panel */
    (function(){
      const layout = document.getElementById('layout');
      const toggle = document.getElementById('toggleFilters');
      if(!layout || !toggle) return;

      toggle.addEventListener('click', ()=>{
        const hidden = layout.classList.toggle('filters-hidden');
        toggle.textContent = hidden ? 'Show filters' : 'Hide filters';
        toggle.setAttribute('aria-pressed', hidden ? 'false' : 'true');
      });
    })();

    /* --- Helpers --- */
    function moneyFromCents(c){
      if(c == null) return null;
      const v = c / 100;
      return v.toLocaleString("en-US",{
        style:"currency",
        currency:"USD",
        minimumFractionDigits:2,
        maximumFractionDigits:2
      });
    }

    function numeric(val){
      const n = parseFloat(val);
      return Number.isFinite(n) ? n : null;
    }

    /* Fetch profiles for seller display names for listings */
    async function fetchProfilesForListings(listings){
      const map = {};
      const ids = Array.from(new Set(
        (listings || [])
          .map(l => l.seller_id)
          .filter(Boolean)
      ));
      if(!ids.length) return map;

      try{
        const { data, error } = await supabaseClient
          .from("profiles")
          .select("id, display_name, store_name, first_name, last_name")
          .in("id", ids);

        if(error){
          console.error("Profile fetch error", error);
          return map;
        }
        (data || []).forEach(p=>{
          map[p.id] = p;
        });
      }catch(e){
        console.error("Profile fetch exception", e);
      }
      return map;
    }

    /* --- Atelier search --- */
    async function runAtelierSearch(){
      const grid    = document.getElementById("grid");
      const emptyEl = document.getElementById("empty");
      const countEl = document.getElementById("resultCount");
      const qInput  = document.getElementById("q");

      if(grid) grid.innerHTML = "";
      if(emptyEl) emptyEl.style.display = "none";
      if(countEl) countEl.textContent = "Loading…";

      const searchTerm = (qInput?.value || "").trim().toLowerCase();

      let profiles = [];
      try{
        const { data, error } = await supabaseClient
          .from("profiles")
          .select("id, display_name, store_name, first_name, last_name, bio")
          .order("store_name", { ascending:true });

        if(error){
          console.error("Atelier fetch error", error);
          if(countEl) countEl.textContent = "Error loading ateliers";
          return;
        }
        profiles = data || [];
      }catch(e){
        console.error("Atelier fetch exception", e);
        if(countEl) countEl.textContent = "Error loading ateliers";
        return;
      }

      let filtered = profiles;
      if(searchTerm){
        filtered = profiles.filter(p=>{
          const store = (p.store_name || "").toLowerCase();
          const disp  = (p.display_name || "").toLowerCase();
          const full  = ((p.first_name || "") + " " + (p.last_name || "")).trim().toLowerCase();
          return store.includes(searchTerm) || disp.includes(searchTerm) || full.includes(searchTerm);
        });
      }

      const total = filtered.length;
      if(countEl){
        countEl.textContent = total === 1 ? "1 atelier" : total + " ateliers";
      }

      if(!total){
        if(emptyEl){
          emptyEl.textContent = "No ateliers match that search yet.";
          emptyEl.style.display = "block";
        }
        return;
      }

      filtered.forEach(p=>{
        const card = document.createElement("article");
        card.className = "listing-card";

        const storeName = p.store_name || p.display_name || "Atelier";
        const ownerName = ((p.first_name || "") + " " + (p.last_name || "")).trim();
        // IMPORTANT: use ?u=<id> so atelier.html opens the correct seller,
        // not the currently logged-in user.
        const href = "atelier.html?u=" + encodeURIComponent(p.id);

        card.innerHTML = `
          <a class="listing-thumb-link" href="${href}">
            <div class="listing-thumb" aria-hidden="true">
              <!-- placeholder atelier tile -->
            </div>
          </a>
          <div class="listing-body">
            <div class="listing-title-row">
              <a class="listing-title" href="${href}">${storeName}</a>
            </div>
            ${ownerName ? `<div class="listing-yards">${ownerName}</div>` : ""}
            ${p.bio ? `<div class="listing-price-row"><span class="listing-price-main">${p.bio}</span></div>` : ""}
            <div class="listing-cta-row">
              <a href="${href}" class="listing-add-btn">
                View atelier
              </a>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    /* --- Listing search + render --- */
    async function runListingSearch(){
      const grid       = document.getElementById("grid");
      const emptyEl    = document.getElementById("empty");
      const emptyFilteredEl = document.getElementById("emptyFiltered");
      const countEl    = document.getElementById("resultCount");
      const qInput     = document.getElementById("q");
      const minPriceEl = document.getElementById("minPrice");
      const maxPriceEl = document.getElementById("maxPrice");
      const minYardsEl = document.getElementById("minYards");
      const deptEl     = document.getElementById("dept");
      const fabricEl   = document.getElementById("fabricType");
      const fiberEl    = document.getElementById("fiberType");
      const patternEl  = document.getElementById("pattern");
      const originEl   = document.getElementById("origin");
      const designerEl = document.getElementById("designer");
      const feelsEl    = document.getElementById("feelsLike");

      if(grid) grid.innerHTML = "";
      if(emptyEl) emptyEl.style.display = "none";
      if(emptyFilteredEl) emptyFilteredEl.style.display = "none";
      if(countEl) countEl.textContent = "Loading…";

      let listings = [];
      try{
        // Fetch all listings, filter client-side (same approach as atelier.html)
        // This ensures we don't miss listings due to DB-level filter issues
        const { data, error } = await supabaseClient
          .from("listings")
          .select("*")
          .order("published_at", { ascending:false, nullsFirst: false });

        if(error){
          console.error("Listings fetch error", error);
          if(countEl) countEl.textContent = "Error loading listings";
          return;
        }
        listings = data || [];
      }catch(e){
        console.error("Listings fetch exception", e);
        if(countEl) countEl.textContent = "Error loading listings";
        return;
      }

      /* Client-side filtering so we don't care about missing columns */
      const searchTerm = (qInput?.value || "").trim().toLowerCase();
      const minPrice   = numeric(minPriceEl?.value);
      const maxPrice   = numeric(maxPriceEl?.value);
      const minYards   = numeric(minYardsEl?.value);

      const deptVal    = (deptEl?.value || "").trim();
      const fabricVal  = (fabricEl?.value || "").trim();
      const fiberVal   = (fiberEl?.value || "").trim();
      const patternVal = (patternEl?.value || "").trim();
      const originVal  = (originEl?.value || "").trim();
      const designerVal= (designerEl?.value || "").trim().toLowerCase();
      const feelsVal   = (feelsEl?.value || "").trim().toLowerCase();

      const now = new Date();
      
      let filtered = listings.filter(l => {
        // Must be published (is_published true)
        if(l.is_published !== true) return false;
        
        // Status must be active (case-insensitive), hide sold listings
        const status = (l.status || "active").toLowerCase();
        if(status === "sold") return false;
        if(status !== "active") return false;
        
        // Hide listings with no yards available
        if(l.yards_available != null && Number(l.yards_available) <= 0) return false;
        
        // published_at must be null or in the past
        if(l.published_at && new Date(l.published_at) > now) return false;

        if(searchTerm){
          const hay = ((l.title || "") + " " + (l.description || "")).toLowerCase();
          if(!hay.includes(searchTerm)) return false;
        }

        if(minPrice != null && l.price_cents != null){
          if(l.price_cents < Math.round(minPrice * 100)) return false;
        }
        if(maxPrice != null && l.price_cents != null){
          if(l.price_cents > Math.round(maxPrice * 100)) return false;
        }

        if(minYards != null && l.yards_available != null){
          if(Number(l.yards_available) < minYards) return false;
        }

        if(deptVal && l.dept && l.dept !== deptVal) return false;
        if(fabricVal && l.fabric_type && l.fabric_type !== fabricVal) return false;
        if(fiberVal && l.fiber_type && l.fiber_type !== fiberVal) return false;
        if(patternVal && l.pattern && l.pattern !== patternVal) return false;
        if(originVal && l.origin && l.origin !== originVal) return false;

        if(designerVal){
          const dName = (l.designer || "").toLowerCase();
          if(!dName.includes(designerVal)) return false;
        }

        // content filter
        if(selectedContents.size){
          if(!selectedContents.has("Any")){
            const lc = (l.content || "").toLowerCase();
            let hit = false;
            for(const v of selectedContents){
              if(lc === v.toLowerCase()){ hit = true; break; }
            }
            if(!hit) return false;
          }
        }

        // feels-like dropdown
        if(feelsVal){
          const src = l.feels_like;
          let arr = [];
          if(Array.isArray(src)){
            arr = src;
          }else if(typeof src === "string" && src.trim().length){
            arr = src.split(",").map(s=>s.trim());
          }
          const lowerSet = new Set(arr.map(v=>v.toLowerCase()));
          if(!lowerSet.has(feelsVal)) return false;
        }

        // color family - now supports multiple colors
        if(selectedColors.size > 0){
          if(!l.color_family || !selectedColors.has(l.color_family)) return false;
        }

        return true;
      });

      const total = filtered.length;
      if(countEl){
        // Hide count when 0 results
        if(total === 0){
          countEl.style.display = "none";
        } else {
          countEl.style.display = "block";
          countEl.textContent = total === 1 ? "1 result" : total + " results";
        }
      }

      // Check if any filters are applied
      const hasFilters = searchTerm || minPrice || maxPrice || minYards || deptVal || fabricVal || fiberVal || patternVal || originVal || designerVal || feelsVal || selectedColors.size > 0 || selectedContents.size > 0;

      if(!total){
        if(hasFilters){
          // Show "no matches" empty state
          if(emptyEl) emptyEl.style.display = "none";
          if(emptyFilteredEl) emptyFilteredEl.style.display = "flex";
        } else {
          // Show "no listings yet" empty state
          if(emptyEl) emptyEl.style.display = "flex";
          if(emptyFilteredEl) emptyFilteredEl.style.display = "none";
        }
        return;
      } else {
        if(emptyEl) emptyEl.style.display = "none";
        if(emptyFilteredEl) emptyFilteredEl.style.display = "none";
      }

      // Sort results based on dropdown selection
      const sortBy = document.getElementById("sortBy")?.value || "newest";
      filtered.sort((a, b) => {
        switch(sortBy) {
          case "price-low":
            return (a.price_cents || 0) - (b.price_cents || 0);
          case "price-high":
            return (b.price_cents || 0) - (a.price_cents || 0);
          case "yards-high":
            return (b.yards_available || 0) - (a.yards_available || 0);
          case "newest":
          default:
            return new Date(b.published_at || 0) - new Date(a.published_at || 0);
        }
      });

      const profileMap = await fetchProfilesForListings(filtered);

      if(grid){
        filtered.forEach(l => {
          const yardsAvail = l.yards_available != null ? Number(l.yards_available) : null;
          const priceCents = l.price_cents != null ? Number(l.price_cents) : null;
          const origPriceCents = l.orig_price_cents != null ? Number(l.orig_price_cents) : null;

          const status = (l.status || "active").toLowerCase();
          const isSold = status === "sold" || (yardsAvail != null && yardsAvail <= 0) || l.yards_available === 0;
          const canBuy = !isSold && priceCents != null && yardsAvail != null && yardsAvail > 0;

          let totalCents = null;
          if(priceCents != null && yardsAvail != null){
            totalCents = Math.round(priceCents * yardsAvail);
          }

          const prof = profileMap[l.seller_id] || {};
          const displayName = (prof.first_name && prof.last_name)
            ? (prof.first_name + " " + prof.last_name)
            : (prof.display_name || "");
          const storeName = prof.store_name || displayName || "Hemline Market seller";

          const href = "listing.html?id=" + encodeURIComponent(l.id);
          const safeTitle = l.title || "Untitled listing";
          const safeAlt = safeTitle.replace(/"/g,"&quot;");

          const card = document.createElement("article");
          card.className = "listing-card";

          card.innerHTML = `
            <a class="listing-thumb-link" href="${href}">
              <div class="listing-thumb" aria-hidden="true">
                ${l.image_url_1 ? `<img src="${l.image_url_1}" alt="${safeAlt}">` : ""}
              </div>
            </a>
            <div class="listing-body">
              <div class="listing-title-row">
                <a class="listing-title" href="${href}">${safeTitle}</a>
                ${l.dept ? `<span class="listing-dept">${l.dept}</span>` : ""}
              </div>
              ${yardsAvail != null ? `<div class="listing-yards">${yardsAvail} yards</div>` : ""}
              <div class="listing-cta-row">
                <button type="button" class="listing-add-btn add-to-cart">
                  ${
                    canBuy && totalCents != null && yardsAvail != null
                      ? `Add to Cart — ${moneyFromCents(totalCents)} for ${yardsAvail} yards`
                      : (isSold ? "Sold out" : "Add to Cart")
                  }
                </button>
              </div>
              <div class="listing-price-row">
                ${
                  priceCents != null
                    ? `<span class="listing-price-main">${moneyFromCents(priceCents)}/yard</span>`
                    : `<span class="listing-price-main">Price coming soon</span>`
                }
                ${
                  origPriceCents != null
                    ? `<span class="listing-price-orig">${moneyFromCents(origPriceCents)}/yard</span>`
                    : ""
                }
              </div>
              <div class="listing-seller-row">
                <span class="listing-seller-name">${storeName}</span>
              </div>
            </div>
          `;

          const btn = card.querySelector(".listing-add-btn");
          if(btn){
            const perYdDollars = priceCents != null ? (priceCents / 100) : 0;
            const firstImg = l.image_url_1 || "";

            btn.dataset.id = l.id;
            btn.dataset.name = safeTitle;
            btn.dataset.amount = totalCents != null ? String(totalCents) : "0";
            btn.dataset.price = perYdDollars ? perYdDollars.toFixed(2) : "0";
            btn.dataset.yards = yardsAvail != null ? String(yardsAvail) : "0";
            btn.dataset.sellerId = l.seller_id || "";
            btn.dataset.sellerName = storeName || "";
            btn.dataset.photo = firstImg;

            if(!canBuy){
              btn.disabled = true;
              btn.textContent = isSold ? "Sold out" : "Unavailable";
            }
          }

          grid.appendChild(card);
        });
      }
    }

    async function runSearch(){
      if(currentMode === "ateliers"){
        await runAtelierSearch();
      }else{
        await runListingSearch();
      }
    }

    /* Initial boot */
    document.addEventListener("DOMContentLoaded", ()=>{
      buildFiltersUI();

      const searchBtn = document.getElementById("doSearch");
      const qInput    = document.getElementById("q");
      const layout    = document.getElementById("layout");
      const toggle    = document.getElementById("toggleFilters");
      const heading   = document.getElementById("resultsHeading");

      // Read URL params from homepage search
      const params = new URLSearchParams(window.location.search);
      const initialQ = params.get("q") || "";
      const urlMode  = params.get("mode") === "ateliers" ? "ateliers" : "listings";
      currentMode = urlMode;

      if(qInput) qInput.value = initialQ;

      if(currentMode === "ateliers"){
        if(heading) heading.textContent = "Ateliers";
        if(qInput) qInput.placeholder = "Search ateliers by name…";
        if(layout){
          layout.classList.add("filters-hidden");
        }
        if(toggle){
          toggle.textContent = "Show filters";
          toggle.setAttribute("aria-pressed","false");
        }
      }else{
        if(heading) heading.textContent = "Browse";
      }

      if(searchBtn) searchBtn.addEventListener("click", ()=>{
        // On mobile, hide filters after search to show results
        if(window.innerWidth < 900 && layout && !layout.classList.contains("filters-hidden")){
          layout.classList.add("filters-hidden");
          if(toggle){
            toggle.textContent = "Show filters";
            toggle.setAttribute("aria-pressed","false");
          }
        }
        runSearch();
      });
      if(qInput) qInput.addEventListener("keydown", e=>{
        if(e.key === "Enter"){
          e.preventDefault();
          // On mobile, hide filters after search to show results
          if(window.innerWidth < 900 && layout && !layout.classList.contains("filters-hidden")){
            layout.classList.add("filters-hidden");
            if(toggle){
              toggle.textContent = "Show filters";
              toggle.setAttribute("aria-pressed","false");
            }
          }
          runSearch();
        }
      });

      runSearch();
      
      // Sort dropdown change listener
      document.getElementById("sortBy")?.addEventListener("change", runSearch);
    });
    
    // Clear all filters and re-run search
    function clearAllFilters(){
      document.getElementById("q").value = "";
      document.getElementById("minPrice").value = "";
      document.getElementById("maxPrice").value = "";
      document.getElementById("minYards").value = "";
      document.getElementById("dept").value = "";
      document.getElementById("fabricType").value = "";
      document.getElementById("fiberType").value = "";
      document.getElementById("pattern").value = "";
      document.getElementById("origin").value = "";
      document.getElementById("designer").value = "";
      document.getElementById("feelsLike").value = "";
      
      // Clear color selection (update data attribute and clear Set)
      document.querySelectorAll("#colorBox .sw").forEach(sw => sw.dataset.selected = "false");
      selectedColors.clear();
      
      // Clear content checkboxes and Set
      document.querySelectorAll("input[name='content']").forEach(cb => cb.checked = false);
      selectedContents.clear();
      
      // Clear URL params
      window.history.replaceState({}, "", window.location.pathname);
      
      // Re-run search
      if(typeof runSearch === "function") runSearch();
    }
  </script>

  <!-- GLOBAL CART HANDLER -->
  <script src="assets/add-to-cart.js" defer></script>

</body>
</html>
