<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Browse — Hemline Market</title>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">

<style>
:root{
  --ink:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --accent:#991b1b;
  --bg:#fafafa;
}

*{box-sizing:border-box}

html,body{
  margin:0;
  max-width:100%;
  overflow-x:hidden;
  background:var(--bg);
  color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
}

/* ---------- HEADER ---------- */
.hm-header{
  min-height:56px;
  background:#fff;
  border-bottom:1px solid var(--border);
  position:relative;
  z-index:101;
}
.hm-header .wrap{
  max-width:1200px;
  margin:0 auto;
  padding:0 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.left{
  display:flex;
  align-items:center;
  gap:10px;
}
.hm-brand{
  font-size:24px;
  font-weight:800;
  color:var(--accent);
  text-decoration:none;
}
.hamburger{
  display:inline-grid;
  place-items:center;
  width:36px;
  height:36px;
  border:1px solid var(--border);
  border-radius:10px;
  background:#fff;
  color:#374151;
  cursor:pointer;
}
.hamburger svg{
  width:22px;
  height:22px;
  stroke-width:2;
}
.right{
  display:flex;
  align-items:center;
  gap:14px;
}
.hm-icon{
  color:#444;
  display:inline-grid;
  place-items:center;
}
.hm-icon svg{
  width:26px;
  height:26px;
  stroke-width:2;
}

/* Account icon + login badge */
.hm-account{
  position:relative;
  display:inline-grid;
  place-items:center;
  width:26px;
  height:26px;
}
.hm-account svg{
  width:26px;
  height:26px;
  stroke-width:2;
}
.hm-account-badge{
  position:absolute;
  bottom:-2px;
  right:-2px;
  width:10px;
  height:10px;
  border-radius:50%;
  border:2px solid #fff;
  background:#d1d5db;
}
.hm-account.is-logged-in .hm-account-badge{background:#16a34a;}
.hm-account.is-logged-out .hm-account-badge{background:#d1d5db;}

.hm-btn-primary{
  background:var(--accent);
  color:#fff;
  border:1px solid var(--accent);
  border-radius:999px;
  padding:10px 18px;
  font-weight:700;
  text-decoration:none;
  box-shadow:0 2px 8px rgba(153,27,27,.25);
}

/* ---------- LEFT SHEET MENU ---------- */
.sheet{
  position:fixed;
  inset:0 auto 0 0;
  width:min(84vw,340px);
  background:#fff;
  border-right:1px solid var(--border);
  transform:translateX(-100%);
  transition:transform .25s ease;
  z-index:100;
  display:flex;
  flex-direction:column;
}
.sheet.open{transform:translateX(0);}
.sheet header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px;
  border-bottom:1px solid var(--border);
}
.sheet nav{
  display:grid;
  padding:10px;
}
.sheet nav a{
  padding:10px;
  border:1px solid var(--border);
  border-radius:10px;
  text-decoration:none;
  color:#1f2937;
}
.sheet nav a+a{margin-top:8px;}
.sheet .close{
  display:inline-grid;
  place-items:center;
  width:30px;
  height:30px;
  border:1px solid var(--border);
  border-radius:8px;
  background:#fff;
  color:#444;
  cursor:pointer;
}

/* Overlay */
#sheetOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.25);
  backdrop-filter:blur(1px);
  display:none;
  z-index:90;
}
#sheetOverlay.show{display:block}

/* ---------- MAIN LAYOUT ---------- */
.wrap{
  max-width:1100px;
  margin:18px auto 28px;
  padding:0 12px;
}
.topbar{
  display:flex;
  gap:10px;
  align-items:center;
  margin-bottom:12px;
  flex-wrap:wrap;
}
.topbar input[type="search"]{
  flex:1;
  min-width:0;
  padding:10px;
  border:1px solid var(--border);
  border-radius:10px;
  background:#fff;
}
.topbar button{
  padding:9px 12px;
  border-radius:10px;
  border:1px solid var(--accent);
  background:var(--accent);
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
.filter-toggle{
  border-color:var(--border);
  background:#fff;
  color:#111827;
}
.layout{
  display:grid;
  grid-template-columns:280px 1fr;
  gap:14px;
}
.layout.filters-hidden .filters{display:none;}
.layout.filters-hidden{grid-template-columns:1fr;}
@media(max-width:900px){
  .layout{grid-template-columns:1fr;}
  .topbar input[type="search"]{flex-basis:100%;}
}

/* ---------- FILTERS ---------- */
.filters{
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  height:max-content;
}
.filters h3{margin:0 0 8px;}
.section{
  border-top:1px solid var(--border);
  padding-top:8px;
  margin-top:8px;
}
.section:first-of-type{
  border-top:0;
  padding-top:0;
  margin-top:0;
}
.title{
  font-weight:700;
  font-size:13px;
  color:#374151;
  margin:0 0 6px;
}
.listbox{
  max-height:230px;
  overflow:auto;
  border:1px solid var(--border);
  border-radius:10px;
  padding:6px;
  background:#fff;
}
.row{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 4px;
  border-bottom:1px dashed #f3f4f6;
}
.row:last-child{border-bottom:0;}
.row input{
  width:14px;
  height:14px;
}
.row label{
  font-size:12px;
  color:#374151;
}
.mini{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.mini .field{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.mini label{
  font-size:12px;
  color:#374151;
}
.mini input{
  padding:7px 10px;
  border:1px solid var(--border);
  border-radius:10px;
  background:#fff;
  font-size:13px;
  max-width:120px;
}
.selects{
  display:grid;
  gap:8px;
}
.selects select,
.selects input{
  width:100%;
  padding:8px 10px;
  border:1px solid var(--border);
  border-radius:10px;
  background:#fff;
}

/* COLOR BOX */
#colorBox{
  --sw:22px;
  --gap:6px;
  display:grid;
  grid-template-columns:repeat(5,var(--sw));
  grid-template-rows:repeat(3,var(--sw));
  gap:var(--gap);
  align-content:start;
  justify-content:start;
  padding:6px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:10px;
}
#colorBox .sw{
  width:var(--sw);
  height:var(--sw);
  border-radius:6px;
  border:1px solid #d1d5db;
  box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);
  cursor:pointer;
  position:relative;
}
#colorBox .sw[data-selected="true"]{
  outline:2px solid var(--accent);
  outline-offset:2px;
}
#colorBox .sw .tip{
  position:absolute;
  bottom:130%;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  color:#fff;
  padding:2px 5px;
  border-radius:4px;
  font-size:10px;
  white-space:nowrap;
  opacity:0;
  pointer-events:none;
}
#colorBox .sw:hover .tip{opacity:1}
#colorBox .sw[data-name="Gold"]{
  background:linear-gradient(135deg,#d4b870 0%,#f0dc97 50%,#ceb86b 100%);
}
#colorBox .sw[data-name="Silver"]{
  background:linear-gradient(135deg,#bfc6cf 0%,#e6eaef 50%,#a9b0ba 100%);
}

/* ---------- RESULTS ---------- */
.results{
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  min-height:300px;
}
.results-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.browse-grid{
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:12px;
}
@media(max-width:900px){
  .browse-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
}
@media(max-width:560px){
  .browse-grid{grid-template-columns:1fr;}
}
.card{
  display:block;
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  text-decoration:none;
  color:inherit;
}
.ph{
  aspect-ratio:4/3;
  display:grid;
  place-items:center;
  color:#6b7280;
  background:linear-gradient(180deg,#f8fafc,#eef2f7);
}
.ph img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.meta{
  padding:8px 10px 10px;
}
.meta .title{
  font-weight:800;
  margin-bottom:4px;
  line-height:1.2;
}
.meta .sub{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  justify-content:space-between;
  font-size:13px;
  color:#6b7280;
}
.meta .sub span{white-space:nowrap;}

.add-btn{
  width:100%;
  margin-top:4px;
  padding:9px 10px;
  border-radius:10px;
  border:1px solid var(--accent);
  background:var(--accent);
  color:#fff;
  font-weight:700;
  cursor:pointer;
  font-size:13px;
  white-space:nowrap;
}

.price-row{
  margin-top:6px;
  font-size:12px;
  color:#4b5563;
}
.price-sale{
  font-weight:600;
}
.price-orig{
  margin-left:6px;
  color:#9ca3af;
  text-decoration:line-through;
}

/* ---------- FOOTER ---------- */
.hm-footer{
  background:#fff;
  border-top:1px solid var(--border);
}
.footer-wrap{
  max-width:1200px;
  margin:0 auto;
  padding:10px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.footer-links{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
}
.copy{
  color:#6b7280;
  font-size:14px;
}
</style>
</head>
<body>

<header class="hm-header" role="banner">
  <div class="wrap">
    <div class="left">
      <button id="openMenu" class="hamburger" type="button" aria-label="Open menu" aria-controls="menuSheet" aria-expanded="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <line x1="4" y1="6"  x2="20" y2="6"></line>
          <line x1="4" y1="12" x2="20" y2="12"></line>
          <line x1="4" y1="18" x2="20" y2="18"></line>
        </svg>
      </button>
      <a class="hm-brand" href="index.html">Hemline Market</a>
    </div>
    <div class="right">
      <a class="hm-icon" href="browse.html" aria-label="Browse &amp; search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.3-4.3"></path>
        </svg>
      </a>
      <a class="hm-icon" href="ThreadTalk.html" aria-label="ThreadTalk" title="ThreadTalk">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M4 6.5A4.5 4.5 0 0 1 8.5 2h7A4.5 4.5 0 0 1 20 6.5v5A4.5 4.5 0 0 1 15.5 16H12l-4 4v-4H8.5A4.5 4.5 0 0 1 4 11.5z"></path>
        </svg>
      </a>
      <a class="hm-icon" href="favorites.html" aria-label="Favorites">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
      </a>
      <a class="hm-icon" href="notifications.html" aria-label="Notifications">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
      </a>
      <a class="hm-icon" href="cart.html" aria-label="Cart">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="9"  cy="21" r="1"></circle>
          <circle cx="18" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
      </a>

      <!-- Account icon with login status -->
      <a class="hm-icon hm-account is-logged-out" id="headerAccountLink" href="auth.html?view=login" aria-label="Sign in or manage your account">
        <span class="hm-account-badge" id="headerAccountBadge"></span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="8" r="3.2"></circle>
          <path d="M5 19c1.4-3 3.5-4.5 7-4.5s5.6 1.5 7 4.5"></path>
        </svg>
      </a>

      <a class="hm-btn-primary" href="sell.html">Sell</a>
    </div>
  </div>
</header>

<div id="sheetOverlay" aria-hidden="true"></div>

<aside class="sheet" id="menuSheet" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Site menu">
  <header>
    <strong>Menu</strong>
    <button class="close" id="closeMenu" aria-label="Close menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </header>
  <nav>
    <a href="account.html">Account</a>
    <a href="atelier.html">My Atelier</a>
    <a href="how.html">How It Works</a>
    <a href="sell.html">Sell Fabric</a>
    <a href="ThreadTalk.html">ThreadTalk</a>
    <a href="contact.html">Contact</a>
  </nav>
</aside>

<main class="wrap">
  <div class="topbar">
    <input id="q" type="search" placeholder="Search fabrics…"/>
    <button id="doSearch" type="button">Search</button>
    <button id="toggleFilters" type="button" class="filter-toggle" aria-pressed="true">Hide filters</button>
  </div>

  <div class="layout" id="layout">
    <aside class="filters">
      <h3>Filters</h3>

      <!-- CONTENT (KNOWN) -->
      <section class="section">
        <div class="title">Content</div>
        <div class="listbox" id="contentBox"></div>
      </section>

      <!-- FEELS LIKE (UNKNOWN CONTENT) -->
      <section class="section">
        <div class="title">
          Fabric feels like
          <span style="font-weight:400;font-size:11px;color:var(--muted);">
            (for mystery / unknown content)
          </span>
        </div>
        <div class="listbox" id="feelsBox"></div>
      </section>

      <section class="section">
        <div class="title">Color Family</div>
        <div id="colorBox"></div>
      </section>

      <section class="section">
        <div class="title">$/yard</div>
        <div class="mini">
          <div class="field">
            <label>Min</label>
            <input id="minPrice" type="number" min="0" step="1">
          </div>
          <div class="field">
            <label>Max</label>
            <input id="maxPrice" type="number" min="0" step="1">
          </div>
        </div>
      </section>

      <section class="section">
        <div class="title">Yards</div>
        <div class="mini">
          <div class="field" style="grid-column:1/-1">
            <label>Min yards</label>
            <input id="minYards" type="number" min="0" step="1">
          </div>
        </div>
      </section>

      <section class="section">
        <div class="title">Width (in)</div>
        <div class="mini">
          <div class="field">
            <label>Min</label>
            <input id="minWidth" type="number" min="0" step="1">
          </div>
          <div class="field">
            <label>Max</label>
            <input id="maxWidth" type="number" min="0" step="1">
          </div>
        </div>
      </section>

      <section class="section">
        <div class="title">Weight (GSM)</div>
        <div class="mini">
          <div class="field">
            <label>Min GSM</label>
            <input id="minGsm" type="number" min="0" step="1">
          </div>
          <div class="field">
            <label>Max GSM</label>
            <input id="maxGsm" type="number" min="0" step="1">
          </div>
        </div>
      </section>

      <section class="section">
        <div class="title">Department</div>
        <div class="selects">
          <select id="dept">
            <option value="">Any</option>
            <option>Fashion</option>
            <option>Home</option>
            <option>Quilting</option>
            <option>Notions</option>
          </select>
        </div>
      </section>

      <section class="section">
        <div class="title">Fabric Type</div>
        <div class="selects">
          <select id="fabricType">
            <option value="">Any</option>
            <option>Canvas</option>
            <option>Chiffon</option>
            <option>Corduroy</option>
            <option>Crepe</option>
            <option>Denim</option>
            <option>Flannel</option>
            <option>Georgette</option>
            <option>Jersey</option>
            <option>Lace</option>
            <option>Lawn</option>
            <option>Organza</option>
            <option>Poplin</option>
            <option>Sateen</option>
            <option>Satin</option>
            <option>Tulle</option>
            <option>Twill</option>
            <option>Velvet</option>
            <option>Voile</option>
          </select>
        </div>
      </section>

      <section class="section">
        <div class="title">Fiber Type</div>
        <div class="selects">
          <select id="fiberType">
            <option value="">Any</option>
            <option>Natural</option>
            <option>Modified Natural</option>
            <option>Synthetic</option>
            <option>Blend</option>
          </select>
        </div>
      </section>

      <section class="section">
        <div class="title">Designer / Mill</div>
        <div class="selects">
          <input id="designer" placeholder="e.g., Loro Piana"/>
        </div>
      </section>

      <section class="section">
        <div class="title">Country / Origin</div>
        <div class="selects">
          <select id="origin">
            <option value="">Any</option>
            <option>Italy</option>
            <option>France</option>
            <option>Japan</option>
            <option>UK</option>
            <option>USA</option>
            <option>India</option>
            <option>China</option>
            <option>Korea</option>
          </select>
        </div>
      </section>

      <section class="section">
        <div class="title">Pattern</div>
        <div class="selects">
          <select id="pattern">
            <option value="">Any</option>
            <option>Solid</option>
            <option>Printed</option>
          </select>
        </div>
      </section>
    </aside>

    <section class="results">
      <div class="results-head">
        <h2 style="margin:0;font-size:18px">Browse</h2>
        <div id="resultCount" style="color:#6b7280;font-size:13px">Loading…</div>
      </div>
      <div id="grid" class="browse-grid"></div>
      <div id="empty" style="display:none;color:#6b7280">
        No results yet. Listings will appear here once your marketplace is live.
      </div>
    </section>
  </div>
</main>

<footer class="hm-footer" role="contentinfo">
  <div class="footer-wrap">
    <div class="copy">© 2025 Hemline Market</div>
    <nav class="footer-links" aria-label="Footer">
      <a href="about.html">About</a>
      <a href="faq.html">FAQ</a>
      <a href="contact.html">Contact</a>
      <a href="terms.html">Terms</a>
      <a href="privacy.html">Privacy</a>
    </nav>
  </div>
</footer>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* Hamburger / overlay */
(function(){
  const sheet    = document.getElementById('menuSheet');
  const openBtn  = document.getElementById('openMenu');
  const closeBtn = document.getElementById('closeMenu');
  const overlay  = document.getElementById('sheetOverlay');

  function lockScroll(lock){ document.body.style.overflow = lock ? 'hidden' : ''; }
  function openSheet(){
    if(!sheet) return;
    sheet.classList.add('open');
    sheet.setAttribute('aria-hidden','false');
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    if(openBtn) openBtn.setAttribute('aria-expanded','true');
    lockScroll(true);
  }
  function closeSheet(){
    if(!sheet) return;
    sheet.classList.remove('open');
    sheet.setAttribute('aria-hidden','true');
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden','true');
    if(openBtn) openBtn.setAttribute('aria-expanded','false');
    lockScroll(false);
    if(openBtn) openBtn.focus();
  }

  if(openBtn && sheet && closeBtn && overlay){
    openBtn.addEventListener('click', e=>{ e.preventDefault(); openSheet(); });
    closeBtn.addEventListener('click', e=>{ e.preventDefault(); closeSheet(); });
    overlay.addEventListener('click', closeSheet);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeSheet(); });
  }
})();
</script>

<script>
/* Supabase client + header session + listings */

const supabaseClient = window.supabase.createClient(
  "https://clkizksbvxjkoatdajgd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI"
);

function updateHeaderForSession(session){
  const link = document.getElementById("headerAccountLink");
  if(!link) return;
  if(session && session.user){
    link.href = "account.html";
    link.setAttribute("aria-label","Your account");
    link.classList.add("is-logged-in");
    link.classList.remove("is-logged-out");
  }else{
    link.href = "auth.html?view=login";
    link.setAttribute("aria-label","Sign in or manage your account");
    link.classList.remove("is-logged-in");
    link.classList.add("is-logged-out");
  }
}

(async function initHeaderSession(){
  const { data:{ session } } = await supabaseClient.auth.getSession();
  updateHeaderForSession(session || null);
  supabaseClient.auth.onAuthStateChange((_event, newSession)=>{
    updateHeaderForSession(newSession || null);
  });
})();

/* Toggle filters */
(function(){
  const layout = document.getElementById('layout');
  const toggle = document.getElementById('toggleFilters');
  if(!layout || !toggle) return;

  toggle.addEventListener('click', ()=>{
    const hidden = layout.classList.toggle('filters-hidden');
    toggle.textContent = hidden ? 'Show filters' : 'Hide filters';
    toggle.setAttribute('aria-pressed', hidden ? 'false' : 'true');
  });
})();

/* Filter option definitions */
const CONTENTS = [
  "Any",
  "Not sure (content unknown)",
  "Acetate","Acrylic","Alpaca","Angora","Bamboo","Cashmere",
  "Cotton","Cupro","Hemp","Leather","Linen","Lurex","Modal",
  "Mohair","Nylon","Polyester","Rayon / Viscose","Silk",
  "Spandex / Elastane","Tencel / Lyocell","Wool","Other Fibers"
];

const FEELS = [
  "Feels like cotton / poplin",
  "Feels like linen",
  "Feels like silk",
  "Feels like chiffon",
  "Feels like crepe",
  "Feels like satin",
  "Feels like jersey / t-shirt knit",
  "Feels like denim",
  "Feels like flannel / brushed cotton",
  "Feels like fleece",
  "Feels like wool suiting",
  "Feels like tweed",
  "Feels like cashmere",
  "Feels like velvet / velour",
  "Feels like lace",
  "Feels like tulle",
  "Feels like organza",
  "Feels like leather",
  "Feels like suede",
  "Feels like faux leather",
  "Feels like vinyl"
];

const COLORS = [
  {name:"Black",hex:"#000000"},
  {name:"Grey",hex:"#9aa0a6"},
  {name:"White",hex:"#ffffff",border:"#d1d5db"},
  {name:"Cream",hex:"#f5efe4"},
  {name:"Brown",hex:"#7a4a2a"},
  {name:"Pink",hex:"#f4a4b6"},
  {name:"Red",hex:"#d21d2b"},
  {name:"Orange",hex:"#f27a22"},
  {name:"Yellow",hex:"#f3c321"},
  {name:"Green",hex:"#2f7d32"},
  {name:"Blue",hex:"#216dff"},
  {name:"Purple",hex:"#6b2da8"},
  {name:"Gold"},
  {name:"Silver"}
];

function el(tag, cls, txt){
  const n=document.createElement(tag);
  if(cls) n.className=cls;
  if(txt!=null) n.textContent=txt;
  return n;
}

/* Build filter UI */
(function buildFilters(){
  const box = document.getElementById('contentBox');
  box.innerHTML='';
  CONTENTS.forEach(v=>{
    const id='c_'+v.replace(/[^a-z0-9]/gi,'_');
    const row=el('div','row');
    const cb =el('input');
    cb.type='checkbox';
    cb.id=id;
    cb.value=v;
    const lb=el('label','',v);
    lb.htmlFor=id;
    row.append(cb,lb);
    box.append(row);
  });

  const feelsBox = document.getElementById('feelsBox');
  feelsBox.innerHTML='';
  FEELS.forEach(v=>{
    const id='f_'+v.replace(/[^a-z0-9]/gi,'_');
    const row=el('div','row');
    const cb =el('input');
    cb.type='checkbox';
    cb.id=id;
    cb.value=v;
    const lb=el('label','',v);
    lb.htmlFor=id;
    row.append(cb,lb);
    feelsBox.append(row);
  });

  const colorBox=document.getElementById('colorBox');
  colorBox.innerHTML='';
  COLORS.forEach(c=>{
    const sw=el('div','sw');
    sw.dataset.name=c.name;
    sw.title=c.name;
    if(c.hex) sw.style.background=c.hex;
    if(c.border) sw.style.borderColor=c.border;
    sw.append(el('span','tip',c.name));
    colorBox.append(sw);
  });
})();

/* Filter state */
const state = {
  q:'',
  content:new Set(),
  feelsLike:new Set(),
  colors:new Set(),
  minPrice:'',
  maxPrice:'',
  minYards:'',
  minWidth:'',
  maxWidth:'',
  minGsm:'',
  maxGsm:'',
  dept:'',
  fabricType:'',
  fiberType:'',
  designer:'',
  origin:'',
  pattern:''
};

let LISTINGS = [];

const grid       = document.getElementById('grid');
const empty      = document.getElementById('empty');
const resultSpan = document.getElementById('resultCount');

/* Search + filter events */
document.getElementById('doSearch').onclick = () => {
  state.q = document.getElementById('q').value.trim().toLowerCase();
  render();
};

document.getElementById('contentBox').addEventListener('change', e=>{
  if(e.target.type==='checkbox'){
    if(e.target.checked){
      if(e.target.value!=='Any') state.content.add(e.target.value);
    }else{
      state.content.delete(e.target.value);
    }
    render();
  }
});

document.getElementById('feelsBox').addEventListener('change', e=>{
  if(e.target.type==='checkbox'){
    if(e.target.checked) state.feelsLike.add(e.target.value);
    else state.feelsLike.delete(e.target.value);
    render();
  }
});

document.getElementById('colorBox').addEventListener('click', e=>{
  const sw=e.target.closest('.sw');
  if(!sw) return;
  const name=sw.dataset.name;
  if(sw.dataset.selected){
    sw.removeAttribute('data-selected');
    state.colors.delete(name);
  }else{
    sw.dataset.selected='true';
    state.colors.add(name);
  }
  render();
});

[
  'minPrice','maxPrice','minYards','minWidth','maxWidth',
  'minGsm','maxGsm','dept','fabricType','fiberType',
  'designer','origin','pattern'
].forEach(id=>{
  const node=document.getElementById(id);
  node.addEventListener('input', ()=>{
    state[id]=node.value.trim();
    render();
  });
  if(node.tagName==='SELECT'){
    node.addEventListener('change', ()=>{
      state[id]=node.value.trim();
      render();
    });
  }
});

function n(v){ return v===''?null:Number(v); }

function pass(it){
  if(state.q && !(`${it.title}`.toLowerCase().includes(state.q))) return false;

  if(state.content.size){
    const lc=(it.content||[]).map(s=>s.toLowerCase());
    const has=[...state.content].some(c=>lc.includes(c.toLowerCase()));
    if(!has) return false;
  }

  if(state.feelsLike.size){
    const lf=(it.feelsLike||[]).map(s=>s.toLowerCase());
    const hasFeel=[...state.feelsLike].some(c=>lf.includes(c.toLowerCase()));
    if(!hasFeel) return false;
  }

  if(state.colors.size && it.colorFamily && !state.colors.has(it.colorFamily)) return false;

  if(n(state.minPrice)!=null && it.pricePerYard!=null && it.pricePerYard < n(state.minPrice)) return false;
  if(n(state.maxPrice)!=null && it.pricePerYard!=null && it.pricePerYard > n(state.maxPrice)) return false;

  if(n(state.minYards)!=null && it.yards < n(state.minYards)) return false;

  if(n(state.minWidth)!=null && it.width != null && it.width < n(state.minWidth)) return false;
  if(n(state.maxWidth)!=null && it.width != null && it.width > n(state.maxWidth)) return false;

  if(n(state.minGsm)!=null && it.gsm != null && it.gsm < n(state.minGsm)) return false;
  if(n(state.maxGsm)!=null && it.gsm != null && it.gsm > n(state.maxGsm)) return false;

  if(state.dept && it.dept !== state.dept) return false;
  if(state.fabricType && it.fabricType !== state.fabricType) return false;
  if(state.fiberType && it.fiberType !== state.fiberType) return false;

  if(state.designer && !(it.designer||'').toLowerCase().includes(state.designer.toLowerCase())) return false;
  if(state.origin && it.origin !== state.origin) return false;
  if(state.pattern && it.pattern !== state.pattern) return false;

  return true;
}

function cents(x){ return Math.round(Number(x||0)*100); }

function makeCard(it){
  const a=el('a','card');
  a.href='listing.html?id='+encodeURIComponent(it.id);
  a.dataset.id=it.id;

  const ph=el('div','ph',it.photo?'':it.title);
  if(it.photo){
    const img=new Image();
    img.src=it.photo;
    img.alt=it.title;
    ph.append(img);
  }

  const meta=el('div','meta');
  const t=el('div','title',it.title);

  const total = it.totalPrice ?? 0;
  const yardsLabel = it.yards ? `${it.yards} ${it.yards === 1 ? 'yard' : 'yards'}` : '';
  const btnLabel = yardsLabel
    ? `Add to Cart — $${total.toFixed(2)} for ${yardsLabel}`
    : `Add to Cart — $${total.toFixed(2)}`;

  const btn=el('button','add-btn add-to-cart',btnLabel);
  btn.type='button';
  const amountCents=cents(total);
  btn.dataset.name=it.title;
  btn.dataset.amount=String(amountCents);
  btn.dataset.yards=String(it.yards ?? '');
  btn.dataset.price=String(it.pricePerYard ?? '');
  btn.dataset.sellerId=it.sellerId || ('seller_'+it.id);
  btn.dataset.sellerName=it.sellerName || 'Seller';

  const priceRow = it.pricePerYardText
    ? el('div','price-row')
    : null;

  if(priceRow){
    const saleSpan = el('span','price-sale', it.pricePerYardText);
    priceRow.appendChild(saleSpan);
    if(it.origPerYardText){
      const origSpan = el('span','price-orig', it.origPerYardText);
      priceRow.appendChild(origSpan);
    }
  }

  meta.append(t,btn);
  if(priceRow) meta.append(priceRow);
  a.append(ph,meta);
  return a;
}

function render(){
  const list=LISTINGS.filter(pass);
  resultSpan.textContent = list.length + (list.length===1 ? ' result' : ' results');

  grid.innerHTML='';
  if(!list.length){
    empty.style.display='block';
    return;
  }
  empty.style.display='none';
  list.forEach(it=>grid.append(makeCard(it)));
}

/* Load listings from the real `listings` table */
(async function loadListings(){
  try{
    resultSpan.textContent = 'Loading…';

    const { data, error } = await supabaseClient
      .from('listings')
      .select(`
        id,
        seller_id,
        title,
        description,
        price_cents,
        yards_available,
        status,
        is_published,
        created_at
      `)
      .eq('is_published', true)
      .eq('status', 'active')
      .order('created_at', { ascending: false });

    if (error){
      console.error('Error loading listings', error);
      resultSpan.textContent = 'Error loading listings';
      grid.innerHTML = '';
      empty.style.display = 'block';
      return;
    }

    LISTINGS = (data || []).map(row => {
      const yards = row.yards_available != null ? Number(row.yards_available) : 0;

      // price_cents is PER YARD
      const pricePerYard = row.price_cents != null
        ? Number(row.price_cents) / 100
        : null;

      const totalPrice = pricePerYard != null && yards
        ? pricePerYard * yards
        : (pricePerYard ?? 0);

      return {
        id: row.id,
        sellerId: row.seller_id || null,
        sellerName: null, // to be filled from profiles later

        title: row.title || 'Untitled listing',
        desc: row.description || '',

        yards,
        pricePerYard,
        totalPrice,
        pricePerYardText: pricePerYard != null ? `$${pricePerYard.toFixed(2)}/yard` : '',
        origPerYardText: '', // no orig_price yet

        width: null,
        gsm: null,
        colorFamily: '',
        dept: '',
        fabricType: '',
        fiberType: '',
        designer: '',
        origin: '',
        pattern: '',
        content: [],
        feelsLike: [],
        photo: '' // media wiring later
      };
    });

    if (!LISTINGS.length){
      resultSpan.textContent = '0 results';
      grid.innerHTML = '';
      empty.style.display = 'block';
      return;
    }

    render();
  }catch(err){
    console.error('Unexpected error loading listings', err);
    resultSpan.textContent = 'Error loading listings';
    grid.innerHTML = '';
    empty.style.display = 'block';
  }
})();
</script>

<script src="assets/add-to-cart.js" defer></script>
</body>
</html>
