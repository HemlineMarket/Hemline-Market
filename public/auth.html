<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Sign In — Hemline Market</title>

  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">

  <!-- Shared site styles (match homepage) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --hm-border:#e5e7eb;
      --hm-accent:#991b1b;
      --ink:#111827;
      --muted:#6b7280;
    }

    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:
        url("images/saffron.jpeg") center/cover fixed no-repeat,
        #1a1a1a;
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    main img, main svg, main canvas, main video{
      max-width:100%;
      height:auto;
      display:block;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:0 12px;
    }

    /* Auth cards */
    .auth-container{
      max-width:420px;
      margin:40px auto;
      background:#fff;
      border:1px solid var(--hm-border);
      border-radius:12px;
      padding:24px;
      display:grid;
      gap:16px;
      box-shadow:0 10px 20px rgba(15,23,42,.06);
    }

    h1{
      margin:0 0 8px;
      text-align:center;
      font-size:22px;
    }

    .muted{
      text-align:center;
      color:var(--muted);
      margin:0;
      font-size:14px;
    }

    .muted a{
      color:var(--hm-accent);
      text-decoration:none;
      font-weight:600;
    }

    .muted a:hover{
      text-decoration:underline;
    }

    form{
      display:grid;
      gap:12px;
    }

    input{
      padding:12px;
      border:1px solid var(--hm-border);
      border-radius:8px;
      font:inherit;
    }

    button.primary{
      background:var(--hm-accent);
      color:#fff;
      border:none;
      border-radius:8px;
      padding:12px;
      font-weight:700;
      cursor:pointer;
    }

    button.primary:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    button.oauth{
      border:1px solid #d1d5db;
      border-radius:8px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:center;
      background:#fff;
      cursor:pointer;
      font:inherit;
    }

    button.oauth .icon{
      width:20px;
      height:20px;
      border-radius:999px;
      background:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }

    button.oauth .icon svg{
      width:18px;
      height:18px;
      display:block;
    }

    button.oauth .icon.apple{
      background:#000;
    }

    button.oauth .icon.apple svg{
      fill:#fff;
    }

    .divider{
      display:flex;
      align-items:center;
      gap:12px;
      color:#6b7280;
      font-size:14px;
    }

    .divider::before,
    .divider::after{
      content:"";
      flex:1;
      height:1px;
      background:#e5e7eb;
    }

    .links{
      text-align:center;
      display:grid;
      gap:6px;
      font-size:14px;
    }

    .links a{
      color:var(--hm-accent);
      text-decoration:none;
    }

    .links a:hover{
      text-decoration:underline;
    }

    .hidden{
      display:none;
    }

    .note{
      font-size:13px;
      color:#6b7280;
      text-align:center;
    }

    .password-requirements{
      font-size:13px;
      color:#6b7280;
      display:grid;
      gap:4px;
      padding:8px 0;
    }

    .pw-rule{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .pw-icon{
      font-size:12px;
      width:16px;
      text-align:center;
    }

    .pw-rule.valid{
      color:#059669;
    }

    .pw-rule.valid .pw-icon::before{
      content:"✓";
    }

    .pw-rule.invalid{
      color:#dc2626;
    }

    .pw-rule.invalid .pw-icon::before{
      content:"✗";
    }

    @media (max-width:640px){
      .auth-container{
        margin:24px 12px;
      }
      .wrap{
        padding:0 8px;
      }
    }
  </style>
</head>
<body>

  <noscript>
    <div style="padding:40px;text-align:center;background:#fef2f2;color:#991b1b;">
      <h2>JavaScript Required</h2>
      <p>Please enable JavaScript to use Hemline Market.</p>
    </div>
  </noscript>

  <!-- UNIVERSAL HEADER injected by hm-shell.js -->
  <div id="hm-shell-header"></div>

  <main class="wrap" role="main">
    <div class="auth-container" id="card-login">
      <h1>Sign in to your account</h1>
      <p class="muted">
        New to Hemline?
        <a href="#" id="link-signup">Create account</a>
      </p>

      <form id="login" action="javascript:void(0)" onsubmit="return false;" novalidate>
        <input type="email" id="li-email" placeholder="Email" required>
        <input type="password" id="li-pass" placeholder="Password" required>
        <button class="primary" type="submit">Log in</button>
      </form>

      <div class="divider">or</div>

      <button class="oauth" id="login-google" type="button">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" width="18" height="18" style="flex-shrink:0;">
        <span>Continue with Google</span>
      </button>

      <button class="oauth" id="login-apple" type="button">
        <svg viewBox="0 0 384 512" width="16" height="16" style="flex-shrink:0;">
          <path d="M318.7 268.7c-.2-36.7 16.4-64.4 50-84.8-18.8-26.9-47.2-41.7-84.7-44.6-35.5-2.8-74.3 20.7-88.5 20.7-15 0-49.4-19.7-76.4-19.7C63.3 141.2 4 184.8 4 273.5q0 39.3 14.4 81.2c12.8 36.7 59 126.7 107.2 125.2 25.2-.6 43-17.9 75.8-17.9 31.8 0 48.3 17.9 76.4 17.9 48.6-.7 90.4-82.5 102.6-119.3-65.2-30.7-61.7-90-61.7-91.9zm-56.6-164.2c27.3-32.4 24.8-61.9 24-72.5-24.1 1.4-52 16.4-67.9 34.9-17.5 19.8-27.8 44.3-25.6 71.9 26.1 2 49.9-11.4 69.5-34.3z" fill="#000"/>
        </svg>
        <span>Continue with Apple</span>
      </button>

      <div class="links">
        <a href="#" id="link-forgot">Forgot password?</a>
        <a href="#" id="link-otp">Email me a sign-in code</a>
        <span class="muted" id="status">Checking session…</span>
        <a class="note hidden" id="goto-dash" href="index.html">
          You’re already signed in — go to homepage
        </a>
      </div>
    </div>

    <div class="auth-container hidden" id="card-signup">
      <h1>Create your account</h1>
      <p class="muted">Spin up your seller profile and start listing fabric finds.</p>
      <form id="signup" action="javascript:void(0)" onsubmit="return false;" novalidate>
        <input type="email" id="su-email" placeholder="Email" required>
        <input type="password" id="su-pass" placeholder="Password" required minlength="8">
        <div class="password-requirements" id="pw-requirements">
          <div class="pw-rule" id="pw-length">
            <span class="pw-icon">○</span> At least 8 characters
          </div>
          <div class="pw-rule" id="pw-letter">
            <span class="pw-icon">○</span> At least one letter (a-z)
          </div>
          <div class="pw-rule" id="pw-number">
            <span class="pw-icon">○</span> At least one number (0-9)
          </div>
        </div>
        <button class="primary" type="submit" id="signup-btn" disabled>Create account</button>
      </form>
      <p class="note">
        We'll send a confirmation email to verify your address.
      </p>
      <div class="links">
        <a href="#" id="back-from-signup">Back to sign in</a>
      </div>
    </div>

    <div class="auth-container hidden" id="card-forgot">
      <h1>Reset your password</h1>
      <p class="muted">We’ll send a secure reset link to your inbox.</p>
      <form id="reset">
        <input type="email" id="rp-email" placeholder="Email" required>
        <button class="primary" type="submit">Send reset link</button>
      </form>
      <div class="links">
        <a href="#" id="back-from-forgot">Back to sign in</a>
      </div>
    </div>

    <div class="auth-container hidden" id="card-otp">
      <h1>Email a sign-in code</h1>
      <p class="muted">Quick like a running stitch — no password needed.</p>
      <form id="otp">
        <input type="email" id="otp-email" placeholder="Email" required>
        <button class="primary" type="submit">Send code</button>
      </form>
      <div class="links">
        <a href="#" id="back-from-otp">Back to sign in</a>
      </div>
    </div>
  </main>

  <!-- UNIVERSAL FOOTER injected by hm-shell.js -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Shared shell: universal header/footer + menu + header session + HM.supabase -->
  <script src="scripts/hm-shell.js"></script>
  
  <!-- Rate limiting for security -->
  <script src="scripts/rate-limit.js"></script>
  
  <!-- Accessibility improvements -->
  <script src="scripts/accessibility.js"></script>

  <script>
    // Render shared header + footer (also sets window.HM.supabase)
    window.HM && window.HM.renderShell({ currentPage: "auth" });

    // Use existing supabase client or create one (avoid redeclaration)
    var supabase = window.supabase_client || (window.HM && window.HM.supabase);
    if (!supabase) {
      supabase = window.supabase.createClient(
        "https://clkizksbvxjkoatdajgd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI"
      );
    }
    // Store globally to prevent duplicate clients
    window.supabase_client = supabase;

    // Session status (for the small note under the links)
    (async ()=>{
      const { data:{ session } } = await supabase.auth.getSession();
      const st = document.getElementById('status');
      const go = document.getElementById('goto-dash');
      if(!st || !go) return;

      if(session && session.user){
        st.textContent = `Logged in as ${session.user.email}`;
        go.classList.remove('hidden');
      } else {
        st.textContent = 'Not logged in.';
        go.classList.add('hidden');
      }
    })();

    // Card toggles
    const show = id => document.getElementById(id).classList.remove('hidden');
    const hide = id => document.getElementById(id).classList.add('hidden');

    document.getElementById('link-signup').onclick = (e)=>{
      e.preventDefault(); hide('card-login'); show('card-signup');
    };
    document.getElementById('back-from-signup').onclick = (e)=>{
      e.preventDefault(); hide('card-signup'); show('card-login');
    };
    document.getElementById('link-forgot').onclick = (e)=>{
      e.preventDefault(); hide('card-login'); show('card-forgot');
    };
    document.getElementById('back-from-forgot').onclick = (e)=>{
      e.preventDefault(); hide('card-forgot'); show('card-login');
    };
    document.getElementById('link-otp').onclick = (e)=>{
      e.preventDefault(); hide('card-login'); show('card-otp');
    };
    document.getElementById('back-from-otp').onclick = (e)=>{
      e.preventDefault(); hide('card-otp'); show('card-login');
    };

    function isStrongPassword(pw){
      if(!pw || pw.length < 8) return false;
      if(!/[A-Za-z]/.test(pw)) return false;
      if(!/[0-9]/.test(pw)) return false;
      return true;
    }

    // Real-time password validation
    const pwInput = document.getElementById('su-pass');
    const pwLength = document.getElementById('pw-length');
    const pwLetter = document.getElementById('pw-letter');
    const pwNumber = document.getElementById('pw-number');
    const signupBtn = document.getElementById('signup-btn');
    const suEmail = document.getElementById('su-email');

    function validatePassword() {
      const pw = pwInput.value;
      
      const hasLength = pw.length >= 8;
      const hasLetter = /[A-Za-z]/.test(pw);
      const hasNumber = /[0-9]/.test(pw);
      
      // Update visual indicators
      pwLength.className = 'pw-rule ' + (hasLength ? 'valid' : (pw.length > 0 ? 'invalid' : ''));
      pwLength.querySelector('.pw-icon').textContent = hasLength ? '' : (pw.length > 0 ? '' : '○');
      
      pwLetter.className = 'pw-rule ' + (hasLetter ? 'valid' : (pw.length > 0 ? 'invalid' : ''));
      pwLetter.querySelector('.pw-icon').textContent = hasLetter ? '' : (pw.length > 0 ? '' : '○');
      
      pwNumber.className = 'pw-rule ' + (hasNumber ? 'valid' : (pw.length > 0 ? 'invalid' : ''));
      pwNumber.querySelector('.pw-icon').textContent = hasNumber ? '' : (pw.length > 0 ? '' : '○');
      
      // Enable/disable signup button - use proper email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const emailValid = emailRegex.test(suEmail.value);
      signupBtn.disabled = !(hasLength && hasLetter && hasNumber && emailValid);
    }

    pwInput.addEventListener('input', validatePassword);
    suEmail.addEventListener('input', validatePassword);

    // Email + Password login → go to homepage
    const loginForm = document.getElementById("login");
    
    // Prevent any default form submission
    loginForm.setAttribute("action", "javascript:void(0)");
    loginForm.setAttribute("onsubmit", "return false;");
    
    loginForm.addEventListener("submit", async function(e) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      const btn = this.querySelector('button[type="submit"]');
      const origText = btn.textContent;
      
      // Check if already processing
      if (btn.disabled) {
        return false;
      }
      
      // Check rate limit
      if (window.HM_checkRateLimit) {
        const rateCheck = window.HM_checkRateLimit();
        if (!rateCheck.allowed) {
          alert(`Too many login attempts. Please wait ${rateCheck.waitSeconds} seconds and try again.`);
          return false;
        }
      }
      
      btn.disabled = true;
      btn.textContent = "Logging in...";
      
      const email = document.getElementById("li-email").value.trim();
      const password = document.getElementById("li-pass").value;
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        
        if (error) {
          // Record failed attempt for rate limiting
          if (window.HM_recordFailedAttempt) {
            window.HM_recordFailedAttempt();
            const remaining = window.HM_getRemainingAttempts ? window.HM_getRemainingAttempts() : null;
            if (remaining !== null && remaining <= 2) {
              alert(error.message + `\n\n${remaining} attempt${remaining !== 1 ? 's' : ''} remaining before temporary lockout.`);
            } else {
              alert(error.message || "Login failed. Please check your email and password.");
            }
          } else {
            alert(error.message || "Login failed. Please check your email and password.");
          }
          btn.disabled = false;
          btn.textContent = origText;
          return false;
        }
        
        if (data && data.session) {
          // Clear rate limit on successful login
          if (window.HM_clearRateLimit) {
            window.HM_clearRateLimit();
          }
          // Announce for screen readers
          if (window.HM_announce) {
            window.HM_announce('Login successful. Redirecting...', 'polite');
          }
          // Use replace to prevent back button issues
          window.location.replace("index.html");
        } else {
          alert("Login failed. Please try again.");
          btn.disabled = false;
          btn.textContent = origText;
        }
      } catch(err) {
        alert("Login error: " + (err.message || "Please try again."));
        btn.disabled = false;
        btn.textContent = origText;
      }
      
      return false;
    }, { capture: true });

    // Sign up → create user + display_name (from email local-part), with password rules
    document.getElementById("signup").onsubmit = async (e)=>{
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      const origText = btn.textContent;
      
      const email = document.getElementById("su-email").value.trim();
      const password = document.getElementById("su-pass").value;

      if(!isStrongPassword(password)){
        alert("Password must be at least 8 characters and include at least one letter and one number.");
        return;
      }

      btn.disabled = true;
      btn.textContent = "Creating account...";

      const local = email.split("@")[0] || "";
      const display_name = local || "Hemline sewist";

      const { error } = await supabase.auth.signUp({
        email,
        password,
        options:{ data:{ display_name } }
      });

      btn.disabled = false;
      btn.textContent = origText;
      alert(error ? error.message : "Check your email to confirm.");
      hide('card-signup');
      show('card-login');
    };

    // Forgot password
    document.getElementById("reset").onsubmit = async (e)=>{
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      const origText = btn.textContent;
      
      btn.disabled = true;
      btn.textContent = "Sending...";
      
      const email = document.getElementById("rp-email").value.trim();
      const { error } = await supabase.auth.resetPasswordForEmail(email,{
        redirectTo: location.origin + "/auth.html"
      });
      
      btn.disabled = false;
      btn.textContent = origText;
      alert(error ? error.message : "Reset link sent.");
      hide('card-forgot');
      show('card-login');
    };

    // OTP
    document.getElementById("otp").onsubmit = async (e)=>{
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      const origText = btn.textContent;
      
      btn.disabled = true;
      btn.textContent = "Sending...";
      
      const email = document.getElementById("otp-email").value.trim();
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options:{ emailRedirectTo: location.origin + "/auth.html" }
      });
      
      btn.disabled = false;
      btn.textContent = origText;
      alert(error ? error.message : "Code sent!");
      hide('card-otp');
      show('card-login');
    };

    // OAuth → homepage
    document.getElementById("login-google").onclick = async ()=>{
      const { error } = await supabase.auth.signInWithOAuth({
        provider:"google",
        options:{ redirectTo: location.origin + "/index.html" }
      });
      if(error) alert(error.message);
    };

    document.getElementById("login-apple").onclick = async ()=>{
      const { error } = await supabase.auth.signInWithOAuth({
        provider:"apple",
        options:{ redirectTo: location.origin + "/index.html" }
      });
      if(error) alert(error.message);
    };
  </script>
</body>
</html>
