<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Sale Details — Hemline Market</title>

  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
      --hm-card:rgba(255,255,255,.96);
      --hm-green:#065f46;
      --hm-green-bg:#ecfdf5;
      --hm-blue:#1e40af;
      --hm-blue-bg:#eff6ff;
      --hm-yellow:#92400e;
      --hm-yellow-bg:#fef3c7;
    }
    html,body{margin:0;background:var(--hm-bg);color:var(--hm-text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    
    .wrap{max-width:900px;margin:0 auto;padding:18px 12px 40px}
    
    /* Back link */
    .back{
      display:inline-flex;align-items:center;gap:6px;
      color:var(--hm-accent);text-decoration:none;font-weight:600;
      margin-bottom:16px;font-size:14px;
    }
    .back:hover{text-decoration:underline}
    .back svg{width:18px;height:18px}

    /* Page header */
    .pageHeader{
      display:flex;justify-content:space-between;align-items:flex-start;
      margin-bottom:20px;flex-wrap:wrap;gap:12px;
    }
    .pageHeader h1{margin:0;font-size:24px}
    .orderNumber{color:var(--hm-muted);font-size:14px;margin-top:4px}

    /* Main grid */
    .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media(max-width:800px){.grid{grid-template-columns:1fr}}

    /* Cards */
    .card{
      background:var(--hm-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      overflow:hidden;
    }
    .card-header{
      padding:14px 16px;
      border-bottom:1px solid var(--hm-border);
      font-weight:700;
      font-size:15px;
      background:#fafafa;
    }
    .card-body{padding:16px}

    /* Status badge */
    .statusBadge{
      display:inline-flex;align-items:center;gap:5px;
      font-size:12px;font-weight:700;padding:6px 12px;
      border-radius:999px;text-transform:uppercase;letter-spacing:0.3px;
    }
    .statusBadge.paid{background:var(--hm-yellow-bg);color:var(--hm-yellow);border:1px solid #fcd34d}
    .statusBadge.shipped{background:var(--hm-blue-bg);color:var(--hm-blue);border:1px solid #93c5fd}
    .statusBadge.delivered,.statusBadge.complete{background:var(--hm-green-bg);color:var(--hm-green);border:1px solid #6ee7b7}
    .statusBadge.canceled{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}

    /* Item display */
    .itemRow{
      display:flex;gap:14px;align-items:flex-start;
      padding-bottom:16px;margin-bottom:16px;
      border-bottom:1px solid #f3f4f6;
    }
    .itemThumb{
      width:100px;height:100px;border-radius:10px;overflow:hidden;
      background:#f3f4f6;border:1px solid var(--hm-border);flex-shrink:0;
    }
    .itemThumb img{width:100%;height:100%;object-fit:cover}
    .itemInfo{flex:1}
    .itemTitle{font-weight:700;font-size:16px;margin-bottom:4px}
    .itemMeta{color:var(--hm-muted);font-size:13px}
    .itemPrice{font-weight:700;font-size:18px;text-align:right}

    /* Price breakdown */
    .priceRow{
      display:flex;justify-content:space-between;
      padding:8px 0;font-size:14px;
    }
    .priceRow.total{
      border-top:2px solid var(--hm-border);
      margin-top:8px;padding-top:12px;
      font-weight:700;font-size:16px;
    }
    .priceRow .label{color:var(--hm-muted)}
    .priceRow.total .label{color:var(--hm-text)}
    .earnings{
      background:var(--hm-green-bg);
      padding:12px;border-radius:8px;margin-top:12px;
      display:flex;justify-content:space-between;
      font-weight:700;color:var(--hm-green);
    }

    /* Info rows */
    .infoRow{
      display:flex;justify-content:space-between;
      padding:10px 0;border-bottom:1px solid #f3f4f6;
      font-size:14px;
    }
    .infoRow:last-child{border-bottom:none}
    .infoRow .label{color:var(--hm-muted);font-weight:500}
    .infoRow .value{font-weight:600;text-align:right}
    .infoRow .value a{color:var(--hm-accent);text-decoration:none}
    .infoRow .value a:hover{text-decoration:underline}

    /* Status timeline */
    .timeline{padding:8px 0}
    .timelineStep{
      display:flex;align-items:flex-start;gap:12px;
      padding:12px 0;position:relative;
    }
    .timelineStep:not(:last-child)::before{
      content:'';position:absolute;left:11px;top:36px;
      width:2px;height:calc(100% - 24px);background:#e5e7eb;
    }
    .timelineStep.complete:not(:last-child)::before{background:var(--hm-green)}
    .timelineDot{
      width:24px;height:24px;border-radius:50%;
      background:#fff;border:2px solid #e5e7eb;
      display:flex;align-items:center;justify-content:center;
      flex-shrink:0;font-size:12px;
    }
    .timelineStep.complete .timelineDot{
      background:var(--hm-green);border-color:var(--hm-green);color:#fff;
    }
    .timelineStep.active .timelineDot{
      background:var(--hm-accent);border-color:var(--hm-accent);color:#fff;
    }
    .timelineContent{flex:1}
    .timelineTitle{font-weight:600;font-size:14px}
    .timelineDate{color:var(--hm-muted);font-size:12px;margin-top:2px}

    /* Action buttons */
    .actions{
      display:flex;flex-direction:column;gap:10px;
      margin-top:16px;
    }
    .btn{
      padding:12px 16px;border-radius:10px;border:1px solid var(--hm-border);
      background:#fff;font-weight:600;font-size:14px;cursor:pointer;
      text-decoration:none;color:#374151;text-align:center;
      display:flex;align-items:center;justify-content:center;gap:8px;
      transition:all 0.15s;
    }
    .btn:hover{background:#f9fafb;border-color:#d1d5db}
    .btn-primary{
      background:var(--hm-accent);border-color:var(--hm-accent);color:#fff;
    }
    .btn-primary:hover{background:#7f1d1d}
    .btn-success{
      background:var(--hm-green);border-color:var(--hm-green);color:#fff;
    }
    .btn-success:hover{background:#064e3b}
    .btn svg{width:18px;height:18px}

    /* Shipping address box */
    .addressBox{
      background:#f9fafb;padding:12px;border-radius:8px;
      font-size:14px;line-height:1.5;
    }
    .addressBox .name{font-weight:600}

    /* Loading & error states */
    .loading{text-align:center;padding:60px 20px;color:var(--hm-muted)}
    .error{
      background:#fef2f2;border:1px solid #fecaca;
      color:#991b1b;padding:16px;border-radius:10px;text-align:center;
    }

    /* Tracking link */
    .trackingLink{
      display:flex;align-items:center;gap:8px;
      background:var(--hm-blue-bg);padding:12px;border-radius:8px;
      font-size:14px;color:var(--hm-blue);
    }
    .trackingLink a{color:var(--hm-blue);font-weight:600}

    /* Message textarea */
    .messageBox{
      width:100%;padding:10px;border:1px solid var(--hm-border);
      border-radius:8px;font-size:14px;resize:vertical;
      min-height:80px;font-family:inherit;
    }
    .messageBox:focus{outline:none;border-color:var(--hm-accent)}
  </style>
</head>

<body>
  <div id="hm-shell-header"></div>

  <main class="wrap">
    <a class="back" href="sales.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back to Sales
    </a>

    <div id="content">
      <div class="loading">Loading order details...</div>
    </div>
  </main>

  <div id="hm-shell-footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="scripts/hm-shell.js"></script>

  <script>
    window.HM && window.HM.renderShell({ currentPage: "sales" });

    const supabaseClient = window.__hm_supabase || (window.__hm_supabase =
      window.supabase.createClient(
        "https://clkizksbvxjkoatdajgd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI"
      )
    );

    const contentEl = document.getElementById("content");

    // Helpers
    function money(cents){ return "$" + (Number(cents || 0) / 100).toFixed(2); }
    function fmtDate(iso){
      if(!iso) return "";
      return new Date(iso).toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric",year:"numeric"});
    }
    function fmtDateTime(iso){
      if(!iso) return "";
      return new Date(iso).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"});
    }
    function getOrderId(){
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    function getStatusInfo(status){
      const s = (status || "").toUpperCase();
      if(s === "PAID" || s === "PENDING") return { class:"paid", label:"Awaiting Shipment", step:1 };
      if(s === "SHIPPED") return { class:"shipped", label:"Shipped", step:2 };
      if(s === "DELIVERED") return { class:"delivered", label:"Delivered", step:3 };
      if(s === "COMPLETE") return { class:"complete", label:"Order Complete", step:4 };
      if(s === "CANCELED" || s === "CANCELLED") return { class:"canceled", label:"Cancelled", step:0 };
      return { class:"", label:status || "Unknown", step:0 };
    }

    function getImage(order, listing){
      return listing?.image_url_1 || listing?.image_url || 
             order?.listing_snapshot?.image_url_1 || order?.listing_snapshot?.image_url ||
             order?.listing_image_url || null;
    }

    function getTitle(order, listing){
      return listing?.title || order?.listing_snapshot?.title || 
             order?.listing_title || "Listing";
    }

    async function loadOrder(){
      const orderId = getOrderId();
      if(!orderId){
        contentEl.innerHTML = '<div class="error">No order ID provided.</div>';
        return;
      }

      // Check auth
      const { data: sessData } = await supabaseClient.auth.getSession();
      const user = sessData?.session?.user;
      if(!user){
        contentEl.innerHTML = '<div class="error">Please sign in to view this order.</div>';
        return;
      }

      // Fetch order
      const { data: order, error: orderErr } = await supabaseClient
        .from("orders")
        .select("*")
        .eq("id", orderId)
        .eq("seller_id", user.id)
        .maybeSingle();

      if(orderErr || !order){
        contentEl.innerHTML = '<div class="error">Order not found or you don\'t have permission to view it.</div>';
        return;
      }

      // Fetch listing details if available
      let listing = null;
      if(order.listing_id){
        const { data } = await supabaseClient
          .from("listings")
          .select("id, title, image_url_1, image_url, price_cents")
          .eq("id", order.listing_id)
          .maybeSingle();
        listing = data;
      }

      renderOrder(order, listing, user);
    }

    function renderOrder(order, listing, user){
      const img = getImage(order, listing);
      const title = getTitle(order, listing);
      const statusInfo = getStatusInfo(order.status);
      
      const itemsCents = Number(order.items_cents || order.total_cents || 0);
      const shipCents = Number(order.shipping_cents || 0);
      const totalCents = Number(order.total_cents || (itemsCents + shipCents));
      
      // Calculate seller earnings (assume 80% after fees for display)
      const platformFee = Math.round(totalCents * 0.20);
      const earnings = totalCents - platformFee;

      const buyerEmail = order.buyer_email || "Unknown buyer";
      const buyerName = buyerEmail.split("@")[0];
      const orderShort = order.id.slice(0, 8);

      // Shipping address from order (if stored) or from Stripe session
      const shippingAddress = order.shipping_address || order.listing_snapshot?.shipping_address || null;

      contentEl.innerHTML = `
        <div class="pageHeader">
          <div>
            <h1>Sale Details</h1>
            <div class="orderNumber">Order #${orderShort} · ${fmtDate(order.created_at)}</div>
          </div>
          <span class="statusBadge ${statusInfo.class}">${statusInfo.label}</span>
        </div>

        <div class="grid">
          <!-- Left column -->
          <div>
            <!-- Item card -->
            <div class="card" style="margin-bottom:16px">
              <div class="card-header">Item Sold</div>
              <div class="card-body">
                <div class="itemRow">
                  <div class="itemThumb">
                    ${img ? `<img src="${img}" alt="${title}">` : ''}
                  </div>
                  <div class="itemInfo">
                    <div class="itemTitle">${title}</div>
                    <div class="itemMeta">
                      ${order.listing_id ? `<a href="listing.html?id=${order.listing_id}">View listing</a>` : ''}
                    </div>
                  </div>
                  <div class="itemPrice">${money(itemsCents)}</div>
                </div>

                <div class="priceRow">
                  <span class="label">Item price</span>
                  <span>${money(itemsCents)}</span>
                </div>
                <div class="priceRow">
                  <span class="label">Shipping</span>
                  <span>${money(shipCents)}</span>
                </div>
                <div class="priceRow total">
                  <span class="label">Order Total</span>
                  <span>${money(totalCents)}</span>
                </div>
                <div class="earnings">
                  <span>Your Earnings</span>
                  <span>${money(earnings)}</span>
                </div>
              </div>
            </div>

            <!-- Order Timeline -->
            <div class="card">
              <div class="card-header">Order Timeline</div>
              <div class="card-body">
                <div class="timeline">
                  ${renderTimeline(order, statusInfo.step)}
                </div>
                
                ${order.tracking_number ? `
                  <div class="trackingLink">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                      <rect x="1" y="3" width="15" height="13" rx="2"/>
                      <path d="M16 8h4l3 3v5a2 2 0 0 1-2 2h-1"/>
                      <circle cx="5.5" cy="18.5" r="2.5"/>
                      <circle cx="18.5" cy="18.5" r="2.5"/>
                    </svg>
                    Tracking: <a href="https://tools.usps.com/go/TrackConfirmAction?tLabels=${order.tracking_number}" target="_blank">${order.tracking_number}</a>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>

          <!-- Right column -->
          <div>
            <!-- Buyer info -->
            <div class="card" style="margin-bottom:16px">
              <div class="card-header">Buyer</div>
              <div class="card-body">
                <div class="infoRow">
                  <span class="label">Name</span>
                  <span class="value">@${buyerName}</span>
                </div>
                <div class="infoRow">
                  <span class="label">Email</span>
                  <span class="value">${buyerEmail}</span>
                </div>
                
                ${shippingAddress ? `
                  <div style="margin-top:12px">
                    <div class="label" style="margin-bottom:8px;font-weight:600">Ship To:</div>
                    <div class="addressBox">
                      <div class="name">${shippingAddress.name || buyerName}</div>
                      <div>${shippingAddress.line1 || shippingAddress.address1 || ''}</div>
                      ${shippingAddress.line2 || shippingAddress.address2 ? `<div>${shippingAddress.line2 || shippingAddress.address2}</div>` : ''}
                      <div>${shippingAddress.city || ''}, ${shippingAddress.state || ''} ${shippingAddress.postal_code || shippingAddress.zip || ''}</div>
                    </div>
                  </div>
                ` : `
                  <div style="margin-top:12px;padding:12px;background:#fef3c7;border-radius:8px;font-size:13px;color:#92400e">
                    ⚠️ Shipping address will appear here once available from Stripe checkout.
                  </div>
                `}
              </div>
            </div>

            <!-- Actions -->
            <div class="card">
              <div class="card-header">Actions</div>
              <div class="card-body">
                <div class="actions">
                  ${statusInfo.step === 1 ? `
                    <button class="btn btn-primary" id="markShippedBtn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="3" width="15" height="13" rx="2"/>
                        <path d="M16 8h4l3 3v5a2 2 0 0 1-2 2h-1"/>
                        <circle cx="5.5" cy="18.5" r="2.5"/>
                        <circle cx="18.5" cy="18.5" r="2.5"/>
                      </svg>
                      Mark as Shipped
                    </button>
                  ` : ''}
                  
                  ${order.listing_id ? `
                    <a href="listing.html?id=${order.listing_id}" class="btn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                      </svg>
                      View Listing
                    </a>
                  ` : ''}

                  <a href="mailto:${buyerEmail}?subject=Your Hemline Market Order ${orderShort}" class="btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Message Buyer
                  </a>

                  <a href="contact.html?subject=Order ${orderShort}" class="btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                      <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Get Help
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Mark as shipped button handler
      const markShippedBtn = document.getElementById("markShippedBtn");
      if(markShippedBtn){
        markShippedBtn.addEventListener("click", async () => {
          const tracking = prompt("Enter tracking number (optional):");
          
          markShippedBtn.disabled = true;
          markShippedBtn.textContent = "Updating...";

          const updateData = {
            status: "SHIPPED",
            shipped_at: new Date().toISOString()
          };
          if(tracking && tracking.trim()){
            updateData.tracking_number = tracking.trim();
          }

          const { error } = await supabaseClient
            .from("orders")
            .update(updateData)
            .eq("id", order.id)
            .eq("seller_id", user.id);

          if(error){
            alert("Could not update order. Please try again.");
            markShippedBtn.disabled = false;
            markShippedBtn.textContent = "Mark as Shipped";
          } else {
            location.reload();
          }
        });
      }
    }

    function renderTimeline(order, currentStep){
      const steps = [
        { label: "Sold", date: order.created_at, step: 1 },
        { label: "Shipped", date: order.shipped_at, step: 2 },
        { label: "Delivered", date: order.delivered_at, step: 3 },
        { label: "Order Complete", date: order.completed_at, step: 4 }
      ];

      // Handle cancelled orders
      if(currentStep === 0){
        return `
          <div class="timelineStep complete">
            <div class="timelineDot">✓</div>
            <div class="timelineContent">
              <div class="timelineTitle">Order Placed</div>
              <div class="timelineDate">${fmtDateTime(order.created_at)}</div>
            </div>
          </div>
          <div class="timelineStep active">
            <div class="timelineDot">✕</div>
            <div class="timelineContent">
              <div class="timelineTitle">Cancelled</div>
              <div class="timelineDate">${fmtDateTime(order.canceled_at) || ''}</div>
            </div>
          </div>
        `;
      }

      return steps.map(s => {
        const isComplete = currentStep >= s.step;
        const isActive = currentStep === s.step;
        const classes = isComplete ? "complete" : (isActive ? "active" : "");
        
        return `
          <div class="timelineStep ${classes}">
            <div class="timelineDot">${isComplete ? "✓" : s.step}</div>
            <div class="timelineContent">
              <div class="timelineTitle">${s.label}</div>
              ${s.date ? `<div class="timelineDate">${fmtDateTime(s.date)}</div>` : ''}
            </div>
          </div>
        `;
      }).join("");
    }

    // Load on page ready
    loadOrder();
  </script>
</body>
</html>
