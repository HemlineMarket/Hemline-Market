<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Sale Details ‚Äî Hemline Market</title>

  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
  <link rel="apple-touch-icon" href="/images/icon.png">
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
      --hm-card:rgba(255,255,255,.96);
      --hm-green:#065f46;
      --hm-green-bg:#ecfdf5;
      --hm-blue:#1e40af;
      --hm-blue-bg:#eff6ff;
      --hm-yellow:#92400e;
      --hm-yellow-bg:#fef3c7;
    }
    html,body{margin:0;background:url("images/homepage.jpeg") center/cover fixed no-repeat,var(--hm-bg);color:var(--hm-text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    
    .wrap{max-width:900px;margin:0 auto;padding:18px 12px 40px}
    
    .back{
      display:inline-flex;align-items:center;gap:6px;
      color:var(--hm-accent);text-decoration:none;font-weight:600;
      margin-bottom:16px;font-size:14px;
    }
    .back:hover{text-decoration:underline}
    .back svg{width:18px;height:18px}

    .pageHeader{
      display:flex;justify-content:space-between;align-items:flex-start;
      margin-bottom:20px;flex-wrap:wrap;gap:12px;
    }
    .pageHeader h1{margin:0;font-size:24px}
    .orderNumber{color:var(--hm-muted);font-size:14px;margin-top:4px}

    .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media(max-width:800px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--hm-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      overflow:hidden;
    }
    .card-header{
      padding:14px 16px;
      border-bottom:1px solid var(--hm-border);
      font-weight:700;
      font-size:15px;
      background:#fafafa;
    }
    .card-body{padding:16px}

    .statusBadge{
      display:inline-flex;align-items:center;gap:5px;
      font-size:12px;font-weight:700;padding:6px 12px;
      border-radius:999px;text-transform:uppercase;letter-spacing:0.3px;
    }
    .statusBadge.paid{background:var(--hm-yellow-bg);color:var(--hm-yellow);border:1px solid #fcd34d}
    .statusBadge.shipped{background:var(--hm-blue-bg);color:var(--hm-blue);border:1px solid #93c5fd}
    .statusBadge.delivered,.statusBadge.complete{background:var(--hm-green-bg);color:var(--hm-green);border:1px solid #6ee7b7}
    .statusBadge.canceled{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}

    .itemRow{
      display:flex;gap:14px;align-items:flex-start;
      padding-bottom:16px;margin-bottom:16px;
      border-bottom:1px solid #f3f4f6;
    }
    .itemThumb{
      width:100px;height:100px;border-radius:10px;overflow:hidden;
      background:#f9fafb;border:1px solid var(--hm-border);flex-shrink:0;
      display:flex;align-items:center;justify-content:center;
    }
    .itemThumb img{width:100%;height:100%;object-fit:cover}
    .thumb-placeholder{
      width:100%;height:100%;
      display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    }
    .thumb-placeholder svg{color:#9ca3af;}
    .itemInfo{flex:1}
    .itemTitle{font-weight:700;font-size:16px;margin-bottom:4px}
    .itemMeta{color:var(--hm-muted);font-size:13px}
    .itemPrice{font-weight:700;font-size:18px;text-align:right}

    .priceRow{
      display:flex;justify-content:space-between;
      padding:8px 0;font-size:14px;
    }
    .priceRow.total{
      border-top:2px solid var(--hm-border);
      margin-top:8px;padding-top:12px;
      font-weight:700;font-size:16px;
    }
    .priceRow .label{color:var(--hm-muted)}
    .priceRow.total .label{color:var(--hm-text)}
    .earnings{
      background:var(--hm-green-bg);
      padding:12px;border-radius:8px;margin-top:12px;
    }
    .earnings .row{
      display:flex;justify-content:space-between;
      font-weight:700;color:var(--hm-green);
    }
    .earnings .detail{
      font-size:12px;color:var(--hm-muted);margin-top:6px;
      font-weight:normal;
    }
    .earnings .founding-badge{
      display:inline-block;
      background:#fef3c7;color:#92400e;
      font-size:11px;font-weight:600;
      padding:2px 6px;border-radius:4px;
      margin-left:6px;
    }

    .infoRow{
      display:flex;justify-content:space-between;
      padding:10px 0;border-bottom:1px solid #f3f4f6;
      font-size:14px;
    }
    .infoRow:last-child{border-bottom:none}
    .infoRow .label{color:var(--hm-muted);font-weight:500}
    .infoRow .value{font-weight:600;text-align:right}
    .infoRow .value a{color:var(--hm-accent);text-decoration:none}
    .infoRow .value a:hover{text-decoration:underline}

    .timeline{padding:8px 0}
    .timelineStep{
      display:flex;align-items:flex-start;gap:12px;
      padding:12px 0;position:relative;
    }
    .timelineStep:not(:last-child)::before{
      content:'';position:absolute;left:11px;top:36px;
      width:2px;height:calc(100% - 24px);background:#e5e7eb;
    }
    .timelineStep.complete:not(:last-child)::before{background:var(--hm-green)}
    .timelineDot{
      width:24px;height:24px;border-radius:50%;
      background:#fff;border:2px solid #e5e7eb;
      display:flex;align-items:center;justify-content:center;
      flex-shrink:0;font-size:12px;
    }
    .timelineStep.complete .timelineDot{
      background:var(--hm-green);border-color:var(--hm-green);color:#fff;
    }
    .timelineStep.active .timelineDot{
      background:var(--hm-accent);border-color:var(--hm-accent);color:#fff;
    }
    .timelineContent{flex:1}
    .timelineTitle{font-weight:600;font-size:14px}
    .timelineDate{color:var(--hm-muted);font-size:12px;margin-top:2px}

    .trackingLink{
      display:flex;align-items:center;gap:8px;
      background:var(--hm-blue-bg);padding:12px;border-radius:8px;
      font-size:14px;color:var(--hm-blue);margin-top:12px;
    }
    .trackingLink a{color:var(--hm-blue);font-weight:600}

    .actions{
      display:flex;flex-direction:column;gap:10px;
      margin-top:16px;
    }
    .btn{
      padding:12px 16px;border-radius:10px;border:1px solid var(--hm-border);
      background:#fff;font-weight:600;font-size:14px;cursor:pointer;
      text-decoration:none;color:#374151;text-align:center;
      display:flex;align-items:center;justify-content:center;gap:8px;
      transition:all 0.15s;
    }
    .btn:hover{background:#f9fafb;border-color:#d1d5db}
    .btn-primary{
      background:var(--hm-accent);border-color:var(--hm-accent);color:#fff;
    }
    .btn-primary:hover{background:#7f1d1d}
    .btn-success{
      background:var(--hm-green);border-color:var(--hm-green);color:#fff;
    }
    .btn-success:hover{background:#064e3b}
    .btn svg{width:18px;height:18px}

    .addressBox{
      background:#f9fafb;padding:12px;border-radius:8px;
      font-size:14px;line-height:1.5;
    }
    .addressBox .name{font-weight:600}

    .loading{text-align:center;padding:60px 20px;color:var(--hm-muted)}
    .error{
      background:#fef2f2;border:1px solid #fecaca;
      color:#991b1b;padding:16px;border-radius:10px;text-align:center;
    }

    /* Star rating styles */
    .star-rating{display:flex;gap:4px;margin-bottom:12px}
    .star-btn{background:none;border:none;font-size:28px;cursor:pointer;padding:0;color:#d1d5db;transition:color 0.15s}
    .star-btn:hover{color:#fbbf24}
    .star-btn.active{color:#fbbf24}
    
    /* Accept delivery highlight */
    .accept-highlight{
      background:var(--hm-green-bg);
      border:2px solid #6ee7b7;
      border-radius:10px;
      padding:16px;
      margin-bottom:16px;
    }
    .accept-highlight p{
      margin:0 0 12px;
      font-size:14px;
      color:var(--hm-green);
    }
  @media(max-width:768px){body{background-position:20% center;}}
  </style>
</head>

<body>
  <div id="hm-shell-header"></div>

  <main class="wrap">
    <a class="back" href="sales.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back to Sales
    </a>

    <div id="content">
      <div class="loading">Loading order details...</div>
    </div>
  </main>

  <div id="hm-shell-footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="scripts/hm-shell.js"></script>

  <script>
    window.HM && window.HM.renderShell({ currentPage: "sales" });

    const supabaseClient = window.__hm_supabase || (window.__hm_supabase =
      window.supabase.createClient(
        "https://clkizksbvxjkoatdajgd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI",
        { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
      )
    );

    const contentEl = document.getElementById("content");

    function fmtPrice(cents){
      return "$" + (cents/100).toFixed(2);
    }
    function fmtDateTime(iso){
      if(!iso) return "";
      const d = new Date(iso);
      return d.toLocaleDateString([], { month:"short", day:"numeric", year:"numeric" }) +
        " " + d.toLocaleTimeString([], { hour:"numeric", minute:"2-digit" });
    }

    async function loadOrder(){
      const params = new URLSearchParams(window.location.search);
      const orderId = params.get("id");

      if(!orderId){
        contentEl.innerHTML = `<div class="error">No order ID provided.</div>`;
        return;
      }

      const { data: { session } } = await supabaseClient.auth.getSession();
      if(!session?.user){
        window.location.href = "auth.html?redirect=" + encodeURIComponent(window.location.href);
        return;
      }

      const user = session.user;

      const { data: order, error } = await supabaseClient
        .from("orders")
        .select("*")
        .eq("id", orderId)
        .eq("seller_id", user.id)
        .single();

      if(error || !order){
        contentEl.innerHTML = `<div class="error">Order not found or you don't have permission to view it.</div>`;
        return;
      }

      // Fetch listing details
      let listing = null;
      if(order.listing_id){
        const { data: l } = await supabaseClient
          .from("listings")
          .select("id, title, image_url, image_url_1, size")
          .eq("id", order.listing_id)
          .single();
        listing = l;
      }

      // Fetch buyer info
      let buyerName = order.shipping_name || "Buyer";
      let buyerEmail = "";
      if(order.buyer_id){
        const { data: profile } = await supabaseClient
          .from("profiles")
          .select("first_name, last_name, email")
          .eq("id", order.buyer_id)
          .single();
        if(profile){
          buyerName = `${profile.first_name || ""} ${profile.last_name || ""}`.trim() || buyerName;
          buyerEmail = profile.email || "";
        }
      }

      renderOrder(order, listing, user, buyerName, buyerEmail);
    }

    function getStatusInfo(status){
      const map = {
        "PAID": { label: "Paid - Awaiting Shipment", class: "paid", step: 1 },
        "SHIPPED": { label: "Shipped", class: "shipped", step: 2 },
        "IN_TRANSIT": { label: "In Transit", class: "shipped", step: 2 },
        "DELIVERED": { label: "Delivered", class: "delivered", step: 3 },
        "COMPLETE": { label: "Complete", class: "complete", step: 4 },
        "CANCELED": { label: "Canceled", class: "canceled", step: 0 },
        "REFUNDED": { label: "Refunded", class: "canceled", step: 0 }
      };
      return map[status] || { label: status, class: "paid", step: 1 };
    }

    function renderOrder(order, listing, user, buyerName, buyerEmail){
      const statusInfo = getStatusInfo(order.status);
      const orderShort = order.id.slice(0, 8);

      // Try multiple image sources: order field, listing image_url, listing image_url_1
      const itemImg = order.listing_image_url || listing?.image_url || listing?.image_url_1 || null;
      const itemTitle = listing?.title || order.item_title || order.listing_title || "Item";
      const itemSize = listing?.size || order.item_size || "";

      // Use multiple possible column names for compatibility
      const subtotal = order.item_price_cents || order.items_cents || 0;
      const shipping = order.shipping_cost_cents || order.shipping_cents || 0;
      const tax = order.tax_cents || 0;
      const total = order.total_cents || (subtotal + shipping + tax);
      
      // Calculate seller earnings (simple: item price minus platform fee)
      const platformFee = Math.round(subtotal * 0.10); // 10% platform fee example
      const sellerEarnings = subtotal - platformFee;

      // Check if within 30-minute buyer cancel window
      const orderCreatedMs = new Date(order.created_at).getTime();
      const nowMs = Date.now();
      const minutesSinceOrder = (nowMs - orderCreatedMs) / 60000;
      const withinCancelWindow = minutesSinceOrder < 30;
      const minutesRemaining = Math.ceil(30 - minutesSinceOrder);

      // Check if seller can accept delivery (status is DELIVERED and not yet accepted)
      const canAcceptDelivery = order.status === "DELIVERED" && !order.seller_accepted_at;
      
      // Check if seller can rate buyer (after accepting delivery)
      const canRateBuyer = order.seller_accepted_at && !order.seller_rated_buyer;
      const hasRatedBuyer = order.seller_rated_buyer;

      contentEl.innerHTML = `
        <div class="pageHeader">
          <div>
            <h1>Sale Details</h1>
            <div class="orderNumber">Order #${orderShort} ¬∑ ${fmtDateTime(order.created_at)}</div>
          </div>
          <span class="statusBadge ${statusInfo.class}">${statusInfo.label}</span>
        </div>

        <div class="grid">
          <!-- Left column -->
          <div>
            <div class="card" style="margin-bottom:16px">
              <div class="card-header">Item Sold</div>
              <div class="card-body">
                <div class="itemRow">
                  ${itemImg ? (order.listing_id 
                    ? `<a href="listing.html?id=${order.listing_id}" class="itemThumb" style="display:block;text-decoration:none;"><img src="${itemImg}" alt="${itemTitle}" onerror="this.style.display='none';this.parentElement.style.background='#f3f4f6';this.parentElement.innerHTML='<span style=color:#9ca3af;font-size:11px>N/A</span>';"></a>`
                    : `<div class="itemThumb"><img src="${itemImg}" alt="${itemTitle}" onerror="this.style.display='none';this.parentElement.style.background='#f3f4f6';this.parentElement.innerHTML='<span style=color:#9ca3af;font-size:11px>N/A</span>';"></div>`) 
                  : ''}
                  <div class="itemInfo">
                    <div class="itemTitle">${order.listing_id ? `<a href="listing.html?id=${order.listing_id}" style="color:var(--accent);text-decoration:underline;">${itemTitle}</a>` : itemTitle}</div>
                    <div class="itemMeta">
                      ${itemSize ? `Size: ${itemSize}` : ""}
                    </div>
                  </div>
                  <div class="itemPrice">${fmtPrice(subtotal)}</div>
                </div>

                <div class="priceRow">
                  <span class="label">Item Price</span>
                  <span>${fmtPrice(subtotal)}</span>
                </div>
                <div class="priceRow">
                  <span class="label">Shipping (paid by buyer)</span>
                  <span>${fmtPrice(shipping)}</span>
                </div>
                ${tax ? `
                  <div class="priceRow">
                    <span class="label">Tax</span>
                    <span>${fmtPrice(tax)}</span>
                  </div>
                ` : ""}
                <div class="priceRow total">
                  <span class="label">Order Total</span>
                  <span>${fmtPrice(total)}</span>
                </div>

                <div class="earnings">
                  <div class="row">
                    <span>Your Earnings</span>
                    <span>${fmtPrice(sellerEarnings)}</span>
                  </div>
                  <div class="detail">
                    Item price minus 10% platform fee
                  </div>
                </div>
              </div>
            </div>

            <!-- Order Timeline -->
            <div class="card">
              <div class="card-header">Order Status</div>
              <div class="card-body">
                <div class="timeline">
                  ${renderTimeline(order, statusInfo.step)}
                </div>
                
                ${order.tracking_number ? `
                  <div class="trackingLink">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                      <rect x="1" y="3" width="15" height="13" rx="2"/>
                      <path d="M16 8h4l3 3v5a2 2 0 0 1-2 2h-1"/>
                      <circle cx="5.5" cy="18.5" r="2.5"/>
                      <circle cx="18.5" cy="18.5" r="2.5"/>
                    </svg>
                    Tracking: <a href="https://tools.usps.com/go/TrackConfirmAction?tLabels=${order.tracking_number}" target="_blank">${order.tracking_number}</a>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>

          <!-- Right column -->
          <div>
            <!-- 30-minute cancel window warning -->
            ${withinCancelWindow && order.status === "PAID" ? `
              <div class="card" style="margin-bottom:16px">
                <div class="card-body" style="background:#fef3c7;border:1px solid #fcd34d;border-radius:8px;">
                  <div style="display:flex;align-items:center;gap:10px;color:#92400e;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                      <circle cx="12" cy="12" r="10"/>
                      <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <div>
                      <strong>‚è±Ô∏è Cancel Window Active</strong>
                      <p style="margin:4px 0 0;font-size:13px;">The buyer can cancel for ${minutesRemaining} more minute${minutesRemaining !== 1 ? 's' : ''}. Please wait before printing your label and shipping.</p>
                    </div>
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- Accept Delivery Section (for seller) -->
            ${canAcceptDelivery ? `
              <div class="card" style="margin-bottom:16px">
                <div class="card-header">‚úÖ Accept Delivery</div>
                <div class="card-body">
                  <div class="accept-highlight">
                    <p><strong>The buyer has received their order!</strong></p>
                    <p>Please confirm the delivery to complete this sale and release your earnings.</p>
                    <button class="btn btn-success" id="acceptDeliveryBtn" style="width:100%">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M20 6L9 17l-5-5"/>
                      </svg>
                      Accept Delivery
                    </button>
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- Rate Buyer Section -->
            ${canRateBuyer ? `
              <div class="card" style="margin-bottom:16px" id="rateBuyerCard">
                <div class="card-header">‚≠ê Rate Buyer</div>
                <div class="card-body">
                  <p style="font-size:13px;color:var(--hm-muted);margin:0 0 12px;">How was your experience with this buyer?</p>
                  <div class="star-rating" id="buyerStarRating">
                    ${[1,2,3,4,5].map(n => `
                      <button type="button" class="star-btn" data-rating="${n}">‚òÖ</button>
                    `).join('')}
                  </div>
                  <textarea id="buyerRatingComment" placeholder="Add a comment (optional)" style="width:100%;padding:10px;border:1px solid var(--hm-border);border-radius:8px;font-size:14px;min-height:60px;resize:vertical;box-sizing:border-box;"></textarea>
                  <button id="submitBuyerRatingBtn" class="btn btn-primary" style="margin-top:10px;width:100%;" disabled>
                    Submit Rating
                  </button>
                </div>
              </div>
            ` : ''}

            <!-- Already rated buyer -->
            ${hasRatedBuyer ? `
              <div class="card" style="margin-bottom:16px">
                <div class="card-header">‚≠ê Your Buyer Rating</div>
                <div class="card-body">
                  <div style="font-size:20px;margin-bottom:4px;">${'‚òÖ'.repeat(order.seller_buyer_rating || 0)}${'‚òÜ'.repeat(5-(order.seller_buyer_rating || 0))}</div>
                  ${order.seller_buyer_comment ? `<p style="font-size:14px;color:var(--hm-text);margin:0;">${order.seller_buyer_comment}</p>` : ''}
                </div>
              </div>
            ` : ''}

            <!-- Shipping Info -->
            ${order.label_url || order.tracking_number ? `
              <div class="card" style="margin-bottom:16px">
                <div class="card-header">üì¶ Shipping</div>
                <div class="card-body">
                  ${order.label_url ? `
                    <a href="${order.label_url}" target="_blank" class="btn btn-primary" style="margin-bottom:12px;width:100%">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                      </svg>
                      Download Label (PDF)
                    </a>
                  ` : ''}
                  ${order.shipping_carrier ? `
                    <div class="infoRow">
                      <span class="label">Carrier</span>
                      <span class="value">${order.shipping_carrier} ${order.shipping_service || ''}</span>
                    </div>
                  ` : ''}
                  ${order.tracking_number ? `
                    <div class="infoRow">
                      <span class="label">Tracking</span>
                      <span class="value">
                        <a href="${order.tracking_url || 'https://tools.usps.com/go/TrackConfirmAction?tLabels=' + order.tracking_number}" target="_blank">${order.tracking_number}</a>
                      </span>
                    </div>
                  ` : ''}
                </div>
              </div>
            ` : ''}

            <!-- Buyer info -->
            <div class="card" style="margin-bottom:16px">
              <div class="card-header">Buyer</div>
              <div class="card-body">
                <div class="infoRow">
                  <span class="label">Name</span>
                  <span class="value">${buyerName}</span>
                </div>
                ${buyerEmail ? `
                  <div class="infoRow">
                    <span class="label">Email</span>
                    <span class="value">${buyerEmail}</span>
                  </div>
                ` : ''}
                <div class="addressBox" style="margin-top:12px;">
                  <div class="name">${order.shipping_name || ''}</div>
                  ${order.shipping_address_line1 ? `<div>${order.shipping_address_line1}</div>` : ''}
                  ${order.shipping_address_line2 ? `<div>${order.shipping_address_line2}</div>` : ''}
                  ${(order.shipping_city || order.shipping_state || order.shipping_postal_code) ? `<div>${[order.shipping_city, order.shipping_state].filter(Boolean).join(', ')} ${order.shipping_postal_code || ''}</div>` : ''}
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="card">
              <div class="card-header">Actions</div>
              <div class="card-body">
                <div class="actions">
                  ${statusInfo.step === 1 ? `
                    <button class="btn btn-primary" id="markShippedBtn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="3" width="15" height="13" rx="2"/>
                        <path d="M16 8h4l3 3v5a2 2 0 0 1-2 2h-1"/>
                        <circle cx="5.5" cy="18.5" r="2.5"/>
                        <circle cx="18.5" cy="18.5" r="2.5"/>
                      </svg>
                      Mark as Shipped
                    </button>
                  ` : ''}
                  
                  ${order.listing_id ? `
                    <a href="listing.html?id=${order.listing_id}" class="btn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                      </svg>
                      View Listing
                    </a>
                  ` : ''}

                  <a href="messages.html?to=${order.buyer_id || ''}&order=${order.id}" class="btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Message Buyer
                  </a>

                  <a href="contact.html?subject=Order ${orderShort}" class="btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                      <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Get Help
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Mark as Shipped button handler - FIXED: Now sends notifications to buyer
      const shippedBtn = document.getElementById("markShippedBtn");
      if(shippedBtn){
        shippedBtn.addEventListener("click", async () => {
          const trackingNumber = prompt("Enter tracking number (optional):");
          
          shippedBtn.disabled = true;
          shippedBtn.textContent = "Updating...";

          try {
            // Update order in database
            const { error } = await supabaseClient
              .from("orders")
              .update({
                status: "SHIPPED",
                shipped_at: new Date().toISOString(),
                tracking_number: trackingNumber || null,
                shipping_status: "SHIPPED"
              })
              .eq("id", order.id)
              .eq("seller_id", user.id);

            if(error){
              throw new Error("Database update failed");
            }

            // Create in-app notification for buyer
            if(order.buyer_id){
              await supabaseClient.from("notifications").insert({
                user_id: order.buyer_id,
                type: "shipped",
                kind: "shipped",
                title: "Your order has shipped! üì¶",
                body: `"${order.listing_title || 'Your order'}" is on its way.${trackingNumber ? ' Tracking: ' + trackingNumber : ''}`,
                href: "/purchases.html",
                link: "/purchases.html"
              });
            }

            // Optionally send email via API (fire and forget)
            if(order.buyer_email){
              fetch("/api/notify/shipped", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${session.access_token}` },
                body: JSON.stringify({
                  order_id: order.id,
                  buyer_email: order.buyer_email,
                  listing_title: order.listing_title,
                  tracking_number: trackingNumber || null,
                  tracking_url: trackingNumber ? `https://tools.usps.com/go/TrackConfirmAction?tLabels=${trackingNumber}` : null
                })
              }).catch(e => console.warn("Shipped email notification failed:", e));
            }

            location.reload();

          } catch(err){
            console.error("Mark shipped error:", err);
            alert("Could not update order. Please try again.");
            shippedBtn.disabled = false;
            shippedBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13" rx="2"/><path d="M16 8h4l3 3v5a2 2 0 0 1-2 2h-1"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg> Mark as Shipped`;
          }
        });
      }

      // Accept Delivery button handler
      const acceptBtn = document.getElementById("acceptDeliveryBtn");
      if(acceptBtn){
        acceptBtn.addEventListener("click", async () => {
          if(!confirm("Confirm that the buyer has received their order?")) return;
          
          acceptBtn.disabled = true;
          acceptBtn.textContent = "Processing...";

          const { error } = await supabaseClient
            .from("orders")
            .update({
              status: "COMPLETE",
              seller_accepted_at: new Date().toISOString(),
              completed_at: new Date().toISOString()
            })
            .eq("id", order.id)
            .eq("seller_id", user.id);

          if(error){
            alert("Could not accept delivery. Please try again.");
            acceptBtn.disabled = false;
            acceptBtn.textContent = "Accept Delivery";
          } else {
            location.reload();
          }
        });
      }

      // Star rating for buyer
      const starBtns = document.querySelectorAll('#buyerStarRating .star-btn');
      const submitRatingBtn = document.getElementById('submitBuyerRatingBtn');
      
      starBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const rating = parseInt(btn.dataset.rating);
          starBtns.forEach((star, i) => {
            star.style.color = i < rating ? '#fbbf24' : '#d1d5db';
          });
          if(submitRatingBtn){
            submitRatingBtn.disabled = false;
            submitRatingBtn.dataset.rating = rating;
          }
        });
      });

      // Submit buyer rating
      if(submitRatingBtn){
        submitRatingBtn.addEventListener('click', async () => {
          const rating = parseInt(submitRatingBtn.dataset.rating);
          const comment = document.getElementById('buyerRatingComment')?.value || '';

          if(!rating || rating < 1 || rating > 5){
            alert('Please select a star rating');
            return;
          }

          submitRatingBtn.disabled = true;
          submitRatingBtn.textContent = 'Submitting...';

          const { error } = await supabaseClient
            .from("orders")
            .update({
              seller_rated_buyer: true,
              seller_buyer_rating: rating,
              seller_buyer_comment: comment,
              seller_rated_at: new Date().toISOString()
            })
            .eq("id", order.id)
            .eq("seller_id", user.id);

          if(error){
            alert('Failed to submit rating. Please try again.');
            submitRatingBtn.disabled = false;
            submitRatingBtn.textContent = 'Submit Rating';
          } else {
            location.reload();
          }
        });
      }
    }

    function renderTimeline(order, currentStep){
      const steps = [
        { label: "Sold", date: order.created_at, step: 1 },
        { label: "Shipped", date: order.shipped_at, step: 2 },
        { label: "Delivered", date: order.delivered_at, step: 3 },
        { label: "Order Complete", date: order.completed_at || order.seller_accepted_at, step: 4 }
      ];

      if(currentStep === 0){
        return `
          <div class="timelineStep complete">
            <div class="timelineDot">‚úì</div>
            <div class="timelineContent">
              <div class="timelineTitle">Order Placed</div>
              <div class="timelineDate">${fmtDateTime(order.created_at)}</div>
            </div>
          </div>
          <div class="timelineStep active">
            <div class="timelineDot">‚úï</div>
            <div class="timelineContent">
              <div class="timelineTitle">Cancelled</div>
              <div class="timelineDate">${fmtDateTime(order.canceled_at) || ''}</div>
            </div>
          </div>
        `;
      }

      return steps.map(s => {
        const isComplete = currentStep >= s.step;
        const isActive = currentStep === s.step;
        const classes = isComplete ? "complete" : (isActive ? "active" : "");
        
        return `
          <div class="timelineStep ${classes}">
            <div class="timelineDot">${isComplete ? "‚úì" : s.step}</div>
            <div class="timelineContent">
              <div class="timelineTitle">${s.label}</div>
              ${s.date ? `<div class="timelineDate">${fmtDateTime(s.date)}</div>` : ''}
            </div>
          </div>
        `;
      }).join("");
    }

    loadOrder();
  </script>
</body>
</html>
