<!-- File: public/messages.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Messages — Hemline Market</title>

  <!-- UNIVERSAL CSS STACK -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <!-- Page-specific styles only -->
  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --bg:#fff;
      --accent:#991b1b;
      --bg-page:#fafafa;
    }

    html,body{
      margin:0;
      background:var(--bg-page);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      max-width:100%;
      overflow-x:hidden;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:0 12px 16px;
    }

    h1{
      margin:18px 0 12px;
      font-size:24px;
      font-weight:800;
    }

    .page{
      display:grid;
      grid-template-columns:320px 1fr;
      gap:16px;
      margin:16px 0;
    }

    .panel{
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
    }

    /* INBOX COLUMN */
    .inbox{
      display:flex;
      flex-direction:column;
    }

    .search{
      padding:10px;
      border-bottom:1px solid var(--line);
    }

    .search input{
      width:100%;
      padding:10px;
      border:1px solid var(--line);
      border-radius:10px;
      font:inherit;
    }

    .threads{
      overflow:auto;
      max-height:calc(100vh - 220px);
    }

    .empty-state{
      padding:16px 14px;
      font-size:13px;
      color:var(--muted);
    }

    .thread{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:10px;
      padding:12px;
      border-top:1px solid var(--line);
      cursor:pointer;
      background:#fff;
      transition:background .12s ease;
    }

    .thread:first-child{
      border-top:0;
    }

    .thread:hover{
      background:#f9fafb;
    }

    .thread.active{
      background:#fef2f2;
    }

    .avatar{
      width:36px;
      height:36px;
      border-radius:50%;
      background:#e5e7eb;
      display:grid;
      place-items:center;
      font-weight:700;
      font-size:14px;
      color:#111827;
    }

    .thread-main{
      min-width:0;
    }

    .thread-name{
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .thread-preview{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pill{
      font-size:11px;
      border:1px solid var(--line);
      padding:2px 8px;
      border-radius:999px;
      color:#374151;
      align-self:flex-start;
      white-space:nowrap;
    }

    .pill.red{
      border-color:#fca5a5;
      color:#991b1b;
    }

    /* CHAT COLUMN */
    .chat{
      display:flex;
      flex-direction:column;
      height:calc(100vh - 220px);
    }

    .chat.empty .chat-header,
    .chat.empty .chat-scroll{
      display:none;
    }

    .chat.empty .chat-empty{
      display:flex;
    }

    .chat-header{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      gap:10px;
      background:#fff;
    }

    .chat-header-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .chat-header-name{
      font-weight:700;
      font-size:14px;
    }

    .chat-header-meta{
      font-size:12px;
      color:var(--muted);
    }

    .chat-empty{
      flex:1;
      align-items:center;
      justify-content:center;
      text-align:center;
      color:var(--muted);
      font-size:14px;
      padding:32px 24px;
      display:none;
    }

    .chat-scroll{
      flex:1;
      overflow:auto;
      padding:14px 16px;
      display:grid;
      gap:10px;
      background:#fcfcfc;
    }

    /* Smaller, cleaner bubbles – now no forced tall height */
    .bubble{
      display:inline-block;
      max-width:40%;
      padding:6px 9px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
      word-wrap:break-word;
      min-height:0;          /* important: override any old min-height */
    }

    .bubble.me{
      justify-self:end;
      background:#fef2f2;
      border-color:#fca5a5;
    }

    .stamp{
      font-size:12px;
      color:var(--muted);
      justify-self:center;
    }

    .composer{
      border-top:1px solid var(--line);
      padding:10px;
      display:flex;
      gap:8px;
      background:#fff;
    }

    .composer textarea{
      flex:1;
      min-height:42px;
      max-height:120px;
      padding:10px;
      border:1px solid var(--line);
      border-radius:10px;
      resize:vertical;
      font:inherit;
    }

    .composer button{
      background:var(--accent);
      color:#fff;
      border:0;
      border-radius:10px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
      font:inherit;
      white-space:nowrap;
    }

    .composer button:disabled{
      opacity:.6;
      cursor:default;
    }

    @media (max-width:900px){
      .page{
        grid-template-columns:1fr;
      }
      .chat{
        height:auto;
      }
      .threads{
        max-height:none;
      }
    }
  </style>
</head>
<body>

<!-- UNIVERSAL HEADER -->
<div id="hm-shell-header"></div>

<!-- MAIN -->
<main class="wrap" id="maincontent">
  <h1>Messages</h1>

  <div class="page">
    <!-- Inbox -->
    <section class="panel inbox" aria-label="Inbox">
      <div class="search">
        <input id="searchInput" placeholder="Search messages…"/>
      </div>
      <div class="threads" id="threadsList">
        <div class="empty-state" id="threadsEmpty">
          No conversations yet. When you message a seller or buyer, threads will appear here.
        </div>
      </div>
    </section>

    <!-- Chat -->
    <section class="panel chat empty" aria-label="Conversation" id="chatPanel">
      <div class="chat-header">
        <div class="avatar" id="chatAvatar">?</div>
        <div class="chat-header-main">
          <div class="chat-header-name" id="chatName">Select a conversation</div>
          <div class="chat-header-meta" id="chatMeta">Choose a thread on the left to view messages.</div>
        </div>
      </div>
      <div class="chat-empty">
        <div>
          <div style="font-weight:600;margin-bottom:4px;">Select a conversation</div>
          <div>Choose a thread on the left to view messages.</div>
        </div>
      </div>
      <div class="chat-scroll" id="chatScroll"></div>
      <div class="composer">
        <textarea id="msgInput" placeholder="Write a reply…"></textarea>
        <button id="sendBtn" disabled>Send</button>
      </div>
    </section>
  </div>
</main>

<!-- UNIVERSAL FOOTER -->
<div id="hm-shell-footer"></div>

<!-- JS STACK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/hm-shell.js"></script>

<script>
  // --- Supabase client ---
  const supabaseClient = window.supabase.createClient(
    "https://clkizksbvxjkoatdajgd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI",
    { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
  );

  // --- Helpers ---
  function initialsFromName(first, last, fallback){
    if(first && last) return (first[0]+last[0]).toUpperCase();
    if(first) return (first[0]+(first[1]||"")).toUpperCase();
    if(fallback) return fallback[0].toUpperCase();
    return "?";
  }

  function shortTimeLabel(iso){
    if(!iso) return "";
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return "";
    const today = new Date();
    const sameDay = d.toDateString() === today.toDateString();
    if(sameDay){
      return d.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"});
    }
    const diffMs = today - d;
    const diffDays = Math.floor(diffMs/86400000);
    if(diffDays === 1) return "Yesterday";
    if(diffDays < 7) return d.toLocaleDateString([],{weekday:"short"});
    return d.toLocaleDateString();
  }

  function formatStamp(iso){
    if(!iso) return "";
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return "";
    return d.toLocaleString([],{
      month:"short", day:"numeric",
      hour:"numeric", minute:"2-digit"
    });
  }

  async function ensureSession(maxWaitMs=3000){
    let { data:{ session } } = await supabaseClient.auth.getSession();
    if(session?.user) return session;
    const start = Date.now();
    while(!session?.user && Date.now()-start < maxWaitMs){
      await new Promise(r=>setTimeout(r,120));
      ({ data:{ session } } = await supabaseClient.auth.getSession());
    }
    return session || null;
  }

  // --- DOM refs ---
  const threadsListEl = document.getElementById("threadsList");
  const threadsEmptyEl = document.getElementById("threadsEmpty");
  const searchInputEl  = document.getElementById("searchInput");

  const chatPanelEl  = document.getElementById("chatPanel");
  const chatAvatarEl = document.getElementById("chatAvatar");
  const chatNameEl   = document.getElementById("chatName");
  const chatMetaEl   = document.getElementById("chatMeta");
  const chatScrollEl = document.getElementById("chatScroll");
  const msgInputEl   = document.getElementById("msgInput");
  const sendBtnEl    = document.getElementById("sendBtn");

  let currentUser = null;
  let currentThreadId = null;
  let currentOtherUserId = null;
  let currentOtherName = "";
  let allThreads = [];

  // --- Init ---
  async function initMessagesPage(){
    const session = await ensureSession();
    if(!session?.user){
      window.location.href = "auth.html";
      return;
    }
    currentUser = session.user;

    const params = new URLSearchParams(window.location.search);
    // support BOTH ?to= and existing ?user= from Atelier
    const toUserId = params.get("to") || params.get("user") || null;

    let initialThreadId = null;
    if(toUserId && toUserId !== currentUser.id){
      initialThreadId = await getOrCreateThread(currentUser.id, toUserId);
    }

    await loadThreads(initialThreadId);

    sendBtnEl.disabled = false;
    sendBtnEl.addEventListener("click", handleSend);
    msgInputEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        handleSend();
      }
    });

    searchInputEl.addEventListener("input", applyThreadFilter);
  }

  async function getOrCreateThread(userId, otherUserId){
    // Look for existing thread in either direction
    const { data, error } = await supabaseClient
      .from("message_threads")
      .select("*")
      .or(
        `and(user_a.eq.${userId},user_b.eq.${otherUserId}),` +
        `and(user_a.eq.${otherUserId},user_b.eq.${userId})`
      )
      .limit(1)
      .maybeSingle();

    if(error && error.code !== "PGRST116"){
      console.error("Error checking existing thread", error);
    }
    if(data?.id){
      return data.id;
    }

    const { data:created, error:insertErr } = await supabaseClient
      .from("message_threads")
      .insert({
        user_a: userId,
        user_b: otherUserId,
        last_message_at: null,
        last_message_preview: null
      })
      .select("*")
      .single();

    if(insertErr){
      console.error("Error creating thread", insertErr);
      return null;
    }
    return created.id;
  }

  async function loadThreads(preselectThreadId){
    const uid = currentUser.id;

    const { data, error } = await supabaseClient
      .from("message_threads")
      .select("*")
      .or(`user_a.eq.${uid},user_b.eq.${uid}`)
      .order("last_message_at", { ascending:false, nullsLast:true })
      .order("created_at", { ascending:false });

    if(error){
      console.error("Error loading threads", error);
      threadsEmptyEl.textContent = "We couldn’t load your messages. Please refresh.";
      return;
    }

    allThreads = data || [];

    if(!allThreads.length){
      threadsEmptyEl.style.display = "block";
      threadsListEl.querySelectorAll(".thread").forEach(el=>el.remove());
      makeChatEmpty();
      return;
    }

    threadsEmptyEl.style.display = "none";

    const otherIds = [];
    const uidStr = String(uid);
    allThreads.forEach(t=>{
      const other = (t.user_a === uidStr) ? t.user_b : t.user_a;
      if(other && !otherIds.includes(other)) otherIds.push(other);
    });

    let profilesById = {};
    if(otherIds.length){
      const { data:profiles, error:profileErr } = await supabaseClient
        .from("profiles")
        .select("id, first_name, last_name, store_name, email")
        .in("id", otherIds);

      if(profileErr){
        console.error("Error loading profiles for threads", profileErr);
      }else{
        profilesById = Object.fromEntries((profiles || []).map(p=>[p.id,p]));
      }
    }

    threadsListEl.querySelectorAll(".thread").forEach(el=>el.remove());

    allThreads.forEach(thread=>{
      const otherId = (thread.user_a === uidStr) ? thread.user_b : thread.user_a;
      const prof = profilesById[otherId] || {};
      const first = prof.first_name || "";
      const last  = prof.last_name  || "";
      const displayName =
        (first || last) ? (first + " " + last).trim()
        : prof.store_name || "Hemline member";

      const initials = initialsFromName(first,last,displayName);

      const row = document.createElement("button");
      row.type = "button";
      row.className = "thread";
      row.dataset.threadId = thread.id;
      row.dataset.otherUserId = otherId || "";
      row.dataset.otherName = displayName;

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = initials;

      const main = document.createElement("div");
      main.className = "thread-main";

      const nameEl = document.createElement("div");
      nameEl.className = "thread-name";
      nameEl.textContent = displayName;

      const previewEl = document.createElement("div");
      previewEl.className = "thread-preview";
      previewEl.textContent = thread.last_message_preview || "(No messages yet)";

      main.appendChild(nameEl);
      main.appendChild(previewEl);

      const pill = document.createElement("div");
      pill.className = "pill";
      const label = shortTimeLabel(thread.last_message_at || thread.created_at);
      pill.textContent = label || "Today";

      row.appendChild(avatar);
      row.appendChild(main);
      row.appendChild(pill);

      row.addEventListener("click", ()=> openThread(thread.id, otherId, displayName, initials));

      threadsListEl.appendChild(row);
    });

    if(preselectThreadId){
      const target = allThreads.find(t=>t.id === preselectThreadId);
      if(target){
        const otherId = (target.user_a === uid ? target.user_b : target.user_a);
        let prof = null;
        try{
          const { data:profData } = await supabaseClient
            .from("profiles")
            .select("id, first_name, last_name, store_name, email")
            .eq("id", otherId)
            .maybeSingle();
          prof = profData || {};
        }catch(e){}

        const first = prof?.first_name || "";
        const last  = prof?.last_name  || "";
        const displayName =
          (first || last) ? (first + " " + last).trim()
          : prof?.store_name || "Hemline member";
        const initials = initialsFromName(first,last,displayName);

        openThread(target.id, otherId, displayName, initials);
      }
    }else{
      makeChatEmpty();
    }
  }

  function makeChatEmpty(){
    currentThreadId = null;
    currentOtherUserId = null;
    currentOtherName = "";
    chatPanelEl.classList.add("empty");
    chatScrollEl.innerHTML = "";
    chatNameEl.textContent = "Select a conversation";
    chatMetaEl.textContent = "Choose a thread on the left to view messages.";
    chatAvatarEl.textContent = "?";
  }

  async function openThread(threadId, otherUserId, otherName, initials){
    currentThreadId = threadId;
    currentOtherUserId = otherUserId;
    currentOtherName = otherName || "Hemline member";

    threadsListEl.querySelectorAll(".thread").forEach(el=>{
      el.classList.toggle("active", el.dataset.threadId === threadId);
    });

    chatPanelEl.classList.remove("empty");
    chatAvatarEl.textContent = initials || (currentOtherName[0] || "?");
    chatNameEl.textContent = currentOtherName;
    chatMetaEl.textContent = "No messages yet. Send the first message.";

    const { data, error } = await supabaseClient
      .from("messages")
      .select("*")
      .eq("thread_id", threadId)
      .order("created_at", { ascending:true });

    chatScrollEl.innerHTML = "";

    if(error){
      console.error("Error loading messages", error);
      const errBubble = document.createElement("div");
      errBubble.className = "bubble";
      errBubble.textContent = "We couldn’t load this conversation. Please refresh.";
      chatScrollEl.appendChild(errBubble);
      return;
    }

    if(!data || !data.length){
      const stamp = document.createElement("div");
      stamp.className = "stamp";
      stamp.textContent = "No messages yet. Send the first message.";
      chatScrollEl.appendChild(stamp);
      chatScrollEl.scrollTop = chatScrollEl.scrollHeight;
      return;
    }

    let lastStamp = "";
    data.forEach(msg=>{
      const mine = msg.sender_id === currentUser.id;

      const bubble = document.createElement("div");
      bubble.className = "bubble" + (mine ? " me" : "");
      bubble.textContent = msg.body || "";
      chatScrollEl.appendChild(bubble);

      const stampStr = formatStamp(msg.created_at);
      if(stampStr && stampStr !== lastStamp){
        const stamp = document.createElement("div");
        stamp.className = "stamp";
        stamp.textContent = stampStr;
        chatScrollEl.appendChild(stamp);
        lastStamp = stampStr;
      }
    });

    chatMetaEl.textContent = "Last updated " + formatStamp(data[data.length-1].created_at);
    chatScrollEl.scrollTop = chatScrollEl.scrollHeight;
  }

  async function handleSend(){
    const text = (msgInputEl.value || "").trim();
    if(!text || !currentThreadId || !currentUser) return;

    sendBtnEl.disabled = true;

    try{
      const { data:inserted, error } = await supabaseClient
        .from("messages")
        .insert({
          thread_id: currentThreadId,
          sender_id: currentUser.id,
          body: text
        })
        .select("*")
        .single();

      if(error){
        console.error("Error sending message", error);
        alert("We couldn’t send that message. Please try again.");
        return;
      }

      const bubble = document.createElement("div");
      bubble.className = "bubble me";
      bubble.textContent = text;
      chatScrollEl.appendChild(bubble);

      const stamp = document.createElement("div");
      stamp.className = "stamp";
      stamp.textContent = formatStamp(inserted.created_at);
      chatScrollEl.appendChild(stamp);

      chatScrollEl.scrollTop = chatScrollEl.scrollHeight;
      msgInputEl.value = "";

      const preview = text.length > 140 ? text.slice(0,137) + "…" : text;
      await supabaseClient
        .from("message_threads")
        .update({
          last_message_at: inserted.created_at,
          last_message_preview: preview
        })
        .eq("id", currentThreadId);

      if(currentOtherUserId && currentOtherUserId !== currentUser.id){
        const title = "New message from " + (currentUser.email || "Hemline member");
        await supabaseClient.from("notifications").insert({
          user_id: currentOtherUserId,
          kind: "message",
          title,
          body: preview,
          message_thread_id: currentThreadId,
          message_id: inserted.id
        });
      }

      loadThreads(currentThreadId);
    }finally{
      sendBtnEl.disabled = false;
    }
  }

  function applyThreadFilter(){
    const q = (searchInputEl.value || "").toLowerCase().trim();
    const rows = threadsListEl.querySelectorAll(".thread");
    if(!rows.length) return;
    let anyVisible = false;
    rows.forEach(row=>{
      const name = (row.dataset.otherName || "").toLowerCase();
      const preview = (row.querySelector(".thread-preview")?.textContent || "").toLowerCase();
      const match = !q || name.includes(q) || preview.includes(q);
      row.style.display = match ? "grid" : "none";
      if(match) anyVisible = true;
    });
    threadsEmptyEl.style.display = anyVisible ? "none" : "block";
    if(!anyVisible){
      threadsEmptyEl.textContent = "No conversations match your search.";
    }else{
      threadsEmptyEl.textContent = "No conversations yet. When you message a seller or buyer, threads will appear here.";
    }
  }

  initMessagesPage();
</script>

<script>
  window.HM && window.HM.renderShell({ currentPage: "messages" });
</script>

</body>
</html>
