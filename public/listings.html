<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hemline â€” Listings</title>
  <style>
    body { font-family: system-ui, sans-serif; margin:24px; background:#fafafa; color:#111; }
    h1 { font-size:1.5rem; margin-bottom:16px; }
    #listings { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .listing-card { opacity:0; transform:translateY(20px); transition:all .3s ease; background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.05); }
    .listing-card.show { opacity:1; transform:none; }
    .imgwrap { position:relative; overflow:hidden; }
    .imgwrap img { width:100%; display:block; }
    .badge { position:absolute; top:8px; left:8px; background:#0ea5e9; color:white; padding:2px 6px; border-radius:6px; font-size:12px; }
    .fav { position:absolute; top:8px; right:8px; cursor:pointer; font-size:18px; color:#999; }
    .fav.active { color:red; }
    .overlay { position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.5); color:white; text-align:center; font-size:14px; padding:4px; opacity:0; transition:.2s; }
    .imgwrap:hover .overlay { opacity:1; }
    .info { padding:12px; }
    .title { font-size:16px; margin:0 0 8px; }
    .price { font-size:14px; font-weight:bold; }
    .hm-add { margin-top:8px; padding:6px 10px; border:none; background:#111827; color:#fff; border-radius:6px; cursor:pointer; }
    #empty { display:none; margin-top:16px; color:#555; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Fabric Listings</h1>
    <div id="listings"></div>
    <div id="empty">No fabrics found.</div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabaseUrl = "YOUR_SUPABASE_URL";
    const supabaseKey = "YOUR_SUPABASE_ANON_KEY";
    const supabase = createClient(supabaseUrl, supabaseKey);

    function humanizeDate(str){
      if(!str) return '';
      const d = new Date(str);
      return d.toLocaleDateString();
    }

    function imgWithFallback(url, alt){
      const img=document.createElement('img');
      img.src=url||'https://via.placeholder.com/400x300?text=No+Image';
      img.alt=alt||'';
      return img;
    }

    function renderCard(item, idxOffset){
      const price = (typeof item.price_cents==='number')
        ? (item.price_cents/100).toFixed(2)
        : (item.price || '0.00');
      const when = humanizeDate(item.created_at||item.date);

      const card = document.createElement('div');
      card.className='listing-card';

      const imgwrap=document.createElement('div');
      imgwrap.className='imgwrap';
      const img = imgWithFallback(item.image_url,item.title||'');
      imgwrap.appendChild(img);

      const badge=document.createElement('div');
      badge.className='badge';
      badge.textContent=when;
      imgwrap.appendChild(badge);

      const overlay=document.createElement('div');
      overlay.className='overlay';
      overlay.textContent=item.quickpeek||"Quick View";
      imgwrap.appendChild(overlay);

      const info=document.createElement('div');
      info.className='info';
      info.innerHTML=`
        <h3 class="title">${item.title||''}</h3>
        <div class="price"><span class="cur">$</span>${price}</div>
      `;

      const btn = document.createElement('button');
      btn.className='hm-add';
      btn.textContent='Add to cart';
      btn.setAttribute('data-add-to-cart','1');
      btn.setAttribute('data-id', item.id);
      btn.setAttribute('data-title', item.title || 'Fabric');
      btn.setAttribute('data-price-cents', item.price_cents || 0);
      btn.setAttribute('data-seller-id', item.seller_id || 'unknown');
      info.appendChild(btn);

      card.appendChild(imgwrap);
      card.appendChild(info);

      setTimeout(()=>card.classList.add('show'), idxOffset);
      return card;
    }

    const container = document.getElementById('listings');
    const emptyMsg = document.getElementById('empty');

    async function loadListings(){
      const { data, error } = await supabase
        .from('listings')
        .select('*')
        .order('created_at', { ascending: false });

      console.log("Supabase fetch result:", { data, error });

      if (error) {
        emptyMsg.textContent = "Error loading listings: " + error.message;
        emptyMsg.style.display='block';
        return;
      }

      if (!data || !data.length) {
        emptyMsg.style.display='block';
        container.style.display='none';
        return;
      }

      emptyMsg.style.display='none';
      container.style.display='grid';
      container.innerHTML='';

      data.forEach((item, idx) => {
        const card = renderCard(item, idx*50);
        container.appendChild(card);
      });
    }

    loadListings();
  </script>
</body>
</html>
