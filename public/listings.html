<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Hemline — Listings</title>
  <style>
    :root { --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#fafafa; --card:#ffffff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px;font-weight:700}
    .btn{display:inline-block;padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;margin-left:8px}
    #status{max-width:1100px;margin:12px auto;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    main{max-width:1100px;margin:0 auto;padding:0 16px 24px}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:560px){.grid{grid-template-columns:1fr 1fr}}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr 1fr}}

    .card{position:relative;display:block;background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .tile{display:block;color:inherit;text-decoration:none}
    /* Peach background is our version marker; we’ll remove later */
    .thumb{display:block;aspect-ratio:4/5;background:#ffeccc}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:10px 12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .price{font-weight:700}
    .sub{margin-top:2px;color:var(--muted);font-size:13px;min-height:1.2em}

    .heart{
      position:absolute;top:10px;right:10px;width:40px;height:40px;
      border:1px solid var(--line);border-radius:999px;background:#fff;
      display:grid;place-items:center;cursor:pointer;z-index:3;pointer-events:auto
    }
    .heart svg{width:18px;height:18px;fill:none;stroke:#111;stroke-width:2}
    .heart.active svg{fill:#ef4444;stroke:#ef4444}
    .heart:active{transform:scale(.96)}

    a,a:visited,a:active{color:inherit;text-decoration:none;-webkit-tap-highlight-color:transparent}
    .tile:active .title,.tile:active .price{color:inherit}
    button{-webkit-tap-highlight-color:transparent}
  </style>

  <!-- Env + loaders (cache-busted) -->
  <script src="/env.js?v=10"></script>
  <script>
    (function loadSupabase(){
      function inject(src, cb){var s=document.createElement('script');s.src=src; s.onload=cb; s.onerror=cb; document.head.appendChild(s);}
      inject("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js?v=10", function(){
        if (!window.supabase) inject("https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js?v=10", function(){});
      });
    })();
  </script>
  <script src="/app.js?v=10"></script>
</head>
<body>
  <header>
    Hemline
    <a class="btn" href="/index.html">Home</a>
    <a class="btn" href="/cart.html">Cart</a>
    <a class="btn" href="/favorites.html">Favorites</a>
  </header>

  <div id="status">Loading v10…</div>
  <main>
    <div id="grid" class="grid" aria-live="polite"></div>
  </main>

  <script>
    (async () => {
      const s = document.getElementById('status');
      const grid = document.getElementById('grid');

      // Wait for Supabase
      let tries=0; while(!window.supabase && tries<20){ await new Promise(r=>setTimeout(r,150)); tries++; }
      if (!window.supabase){ s.textContent='Error: Supabase failed to load.'; return; }
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){ s.textContent='Missing env.'; return; }

      const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
      const { data: sessionData } = await sb.auth.getSession();
      const userId = sessionData?.session?.user?.id || null;

      let { data, error } = await sb.from('listings')
        .select('id,title,price_cents,status,created_at')
        .eq('status','active').order('created_at',{ascending:false}).limit(30);
      try { hm.guard({ data, error }, 'Couldn’t load listings.'); } catch(_){ s.textContent='Couldn’t load listings.'; return; }
      if (!data || data.length===0){ s.textContent='No active listings found.'; return; }

      // Preload favorites
      let favIds = new Set();
      if (userId) {
        try {
          const res = await sb.from('favorites').select('listing_id').order('created_at',{ascending:false}).limit(500);
          const rows = hm.guard(res, 'Couldn’t load favorites.'); favIds = new Set(rows.map(r=>r.listing_id));
        } catch(_) {}
      }

      s.textContent = 'Loaded ' + data.length + ' listing(s).';
      grid.innerHTML = data.map(r => {
        const price = r.price_cents ? '$'+(r.price_cents/100).toFixed(2) : '';
        const fav = favIds.has(r.id) ? ' active' : '';
        return `
          <div class="card" data-id="${r.id}">
            <a class="tile" href="/listing.html?id=${encodeURIComponent(r.id)}">
              <span class="thumb"><img alt="" style="display:none"></span>
              <span class="meta">
                <span class="row">
                  <span class="title">${r.title ?? 'Untitled'}</span>
                  <span class="price">${price}</span>
                </span>
                <span class="sub" id="sub-${r.id}"></span>
              </span>
            </a>
            <button type="button" class="heart${fav}" data-heart aria-label="Save">
              <svg viewBox="0 0 24 24"><path d="M20.8 4.6a5.6 5.6 0 0 0-7.9 0l-.9.9-.9-.9a5.6 5.6 0 1 0-7.9 7.9l.9.9 7.9 7.9 7.9-7.9.9-.9a5.6 5.6 0 0 0 0-7.9z"/></svg>
            </button>
          </div>
        `;
      }).join('');

      // Heart toggles — now with immediate feedback so you SEE the click
      grid.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-heart]');
        if (!btn) return;
        e.preventDefault(); e.stopPropagation();

        hm.toast('Tapped ♥'); // immediate visible confirmation

        const id = btn.closest('.card')?.dataset?.id; if (!id) return;

        // Require login
        const { data: sessionNow } = await sb.auth.getSession();
        const uid = sessionNow?.session?.user?.id || null;
        if (!uid) { hm.toast('Sign in to save favorites.'); return; }

        try {
          if (btn.classList.contains('active')) {
            const res = await sb.from('favorites').delete().eq('listing_id', id).eq('user_id', uid);
            hm.guard(res, 'Couldn’t remove favorite.');
            btn.classList.remove('active');
            hm.toast('Removed from Favorites.');
          } else {
            const res = await sb.from('favorites').insert({ listing_id:id, user_id:uid });
            hm.guard(res, 'Couldn’t save favorite.');
            btn.classList.add('active');
            hm.toast('Saved to Favorites.');
          }
        } catch (err) {
          hm.toast(hm.normalizeSupabaseError(err));
        }
      });
    })();
  </script>
</body>
</html>
