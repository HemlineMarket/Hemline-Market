<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hemline — Listings</title>

<style>
  :root { --ink:#0f172a; --line:#e5e7eb; --bg:#fafafa; --accent:#111827; --badge:#0ea5e9; --card:#ffffff; }
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; margin:24px; background:var(--bg); color:var(--ink); }
  .wrap { max-width: 1000px; margin:auto; }
  .grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }

  .input, .select {
    height:36px; padding:0 12px; border:1px solid var(--line); border-radius:10px; background:#fff;
    font-size:14px; outline:none;
  }
  .input:focus, .select:focus { box-shadow:0 0 0 3px rgba(14,165,233,.15); border-color:#94d7f5; }

  .toolbar {
    position: sticky; top: 0; z-index: 10;
    display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 10px; align-items: center;
    padding: 10px 12px; margin: 8px 0 16px;
    background: rgba(250,250,250,.85); backdrop-filter: blur(6px);
    border: 1px solid var(--line); border-radius: 12px;
  }
  .toolbar label { display:flex; align-items:center; gap:8px; font-weight:600; }
  .chips { display:flex; gap:8px; flex-wrap:wrap; }
  .chip { padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:var(--card); font-size:12px; cursor:pointer; }
  .chip.active { border-color:#0ea5e9; color:#0ea5e9; font-weight:700; }
  .count { justify-self:end; font-size:12px; color:#64748b; }

  .listing-card {
    position:relative; border-radius:14px; overflow:hidden; background:#fff;
    border:1px solid var(--line); box-shadow:0 2px 6px rgba(0,0,0,.05);
    transition:transform .2s ease, box-shadow .25s ease;
    opacity:0; transform:translateY(8px);
    will-change: transform, box-shadow;
  }
  .listing-card.show { opacity:1; transform:translateY(0); animation:fadeUp .38s ease both; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  @media (prefers-reduced-motion: reduce){ .listing-card,.listing-card.show{ transition:none; animation:none; opacity:1; transform:none; } }
  .listing-card:hover { box-shadow:0 12px 24px rgba(0,0,0,.18); }

  .imgwrap {
    position:relative; background:#f8fafc; overflow:hidden;
    perspective: 800px;
  }
  .listing-card img {
    width:100%; height:240px; object-fit:cover; display:block;
    transform-style: preserve-3d; transition: transform .25s ease, filter .25s ease;
    will-change: transform;
  }

  /* Sheen highlight */
  .imgwrap::after{
    content:""; position:absolute; inset:-20%;
    background: linear-gradient(75deg, rgba(255,255,255,0) 40%, rgba(255,255,255,.45) 50%, rgba(255,255,255,0) 60%);
    transform: translateX(-120%) rotate(8deg);
    transition: transform .6s ease;
    pointer-events:none;
  }
  .imgwrap:hover::after{ transform: translateX(60%) rotate(8deg); }
  @media (prefers-reduced-motion: reduce){
    .imgwrap::after { display:none; }
  }

  .overlay { position:absolute; inset:0; background:rgba(0,0,0,.45); color:#fff;
    display:flex; align-items:center; justify-content:center; font-weight:600; font-size:15px;
    opacity:0; transition:opacity .25s ease; }
  .imgwrap:hover .overlay { opacity:1; }

  .badge { position:absolute; left:8px; top:8px; background:rgba(14,165,233,.95); color:#fff;
    padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600;
    border:1px solid rgba(255,255,255,.5); box-shadow:0 2px 6px rgba(0,0,0,.08); }

  .info { padding:12px; display:flex; align-items:flex-end; justify-content:space-between; gap:12px; }
  .title { font-weight:600; line-height:1.2; margin:0; }
  .price { font-weight:800; letter-spacing:.2px; color:var(--accent); font-size:22px; line-height:1; white-space:nowrap; }
  .price .cur { opacity:.55; font-weight:600; margin-right:1px; }

  /* hide any legacy date text under cards */
  time, [datetime], .info .date, .card-date, .meta-date, .muted small, .card small { display:none !important; }

  .fav { position:absolute; top:8px; right:8px; cursor:pointer; font-size:20px;
         color:#cbd5e1; transition:transform 0.2s ease, color 0.2s ease; user-select:none; }
  .fav.active { color:#e11d48; }
  .fav.pop { transform:scale(1.4); }

  .ph { width:100%; height:240px; display:grid; place-items:center;
    background:linear-gradient(135deg,#f3f4f6 10%, #eef2f7 90%); color:#64748b; font-weight:600; }
  .ph .dot { width:52px; height:52px; border-radius:14px; border:1px solid #e5e7eb; display:grid; place-items:center;
    background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.05); }

  .empty { text-align:center; padding:60px 20px; color:#64748b; display:none; }
  .empty svg { width:80px; height:80px; margin-bottom:16px; opacity:.7; }
  .empty h2 { font-size:20px; margin:0 0 8px; color:#0f172a; }
  .empty p { margin:0 0 20px; }
  .btn { display:inline-block; padding:10px 18px; border-radius:999px; background:#0ea5e9; color:#fff; font-weight:600; text-decoration:none; }

  .skeleton-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .sk-card { border:1px solid var(--line); border-radius:12px; background:#fff; overflow:hidden; }
  .sk-img { height:240px; background:linear-gradient(90deg,#f3f4f6 25%,#eef1f5 37%,#f3f4f6 63%); }
  .sk-row { height:18px; margin:12px; border-radius:6px;
    background:linear-gradient(90deg,#f3f4f6 25%,#eef1f5 37%,#f3f4f6 63%); }
  .sk-row.w60 { width:60%; } .sk-row.w30 { width:30%; }
  @keyframes shimmer { 0%{background-position:-200px 0} 100%{background-position:200px 0} }
  .sk-img, .sk-row { background-size:400px 100%; animation:shimmer 1.2s infinite linear; }
  @media (prefers-reduced-motion: reduce){ .sk-img,.sk-row { animation:none; } }

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(860px,92vw);background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #e5e7eb}
  .modal-title{font-weight:700}
  .modal-close{border:1px solid #e5e7eb;border-radius:10px;background:#fff;padding:6px 10px;cursor:pointer}
  .modal-body{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:14px}
  .modal-body img{width:100%;height:360px;object-fit:cover;border:1px solid #e5e7eb;border-radius:12px}
  .kv{color:#64748b;font-size:14px;margin:4px 0}
  .bigprice{font-size:28px;font-weight:800}
  @media (max-width:720px){ .modal-body{grid-template-columns:1fr} .modal-body img{height:260px} }

  #toTop{
    position:fixed; right:18px; bottom:18px; z-index:60;
    border:1px solid #e5e7eb; background:#111827; color:#fff;
    border-radius:999px; padding:10px 12px; font-weight:700; cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,.18); transform:translateY(20px); opacity:0;
    transition:opacity .2s ease, transform .2s ease;
  }
  #toTop.show{ opacity:1; transform:translateY(0); }
  #toast{
    position:fixed; left:50%; bottom:28px; transform:translate(-50%, 20px);
    background:#111827; color:#fff; padding:10px 14px; border-radius:10px;
    border:1px solid #e5e7eb; box-shadow:0 8px 24px rgba(0,0,0,.18);
    opacity:0; transition:opacity .2s ease, transform .2s ease; z-index:70; pointer-events:none;
    font-weight:600;
  }
  #toast.show{ opacity:1; transform:translate(-50%, 0); }

  .loadmore-wrap{display:flex;justify-content:center;margin:16px 0}
  #loadMore{padding:10px 16px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer;font-weight:700}
  #loadMore[disabled]{opacity:.5;cursor:not-allowed}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
  const SUPABASE_URL = "https://clkizksbvxjkoatdajgd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI";
  window.supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 12px">Fabric Listings</h1>

    <div class="toolbar" id="toolbar">
      <input id="q" class="input" placeholder="Search title or description…">
      <select id="sortBy" class="select" aria-label="Sort by">
        <option value="new">Newest</option>
        <option value="plh">Price: Low → High</option>
        <option value="phl">Price: High → Low</option>
      </select>
      <label><input type="checkbox" id="onlyFavs"> Favorites only</label>
      <div class="chips" id="priceChips">
        <button class="chip" data-range="u20">Under $20</button>
        <button class="chip" data-range="20-50">$20–$50</button>
        <button class="chip" data-range="50p">$50+</button>
      </div>
      <span class="count">
        <span class="chip" id="favCount">♥ 0 saved</span>
        <span id="resultCount" style="margin-left:8px;"></span>
      </span>
    </div>

    <div id="skeletons" class="skeleton-grid" aria-hidden="true"></div>
    <div id="listings" class="grid" style="display:none;"></div>

    <div id="empty" class="empty">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7l9-4 9 4M4 10h16v10H4z"/>
      </svg>
      <h2>No fabrics match your filters</h2>
      <p>Try adjusting your search or clear filters to see more.</p>
      <a href="#" class="btn" onclick="clearFilters()">Clear filters</a>
    </div>

    <div class="loadmore-wrap"><button id="loadMore" disabled>Load more</button></div>
  </div>

  <div id="qv" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="qv-title">
    <div class="modal">
      <div class="modal-header">
        <div id="qv-title" class="modal-title">Item</div>
        <button class="modal-close" onclick="closeQV()">Close</button>
      </div>
      <div class="modal-body">
        <img id="qv-img" alt="">
        <div>
          <div id="qv-price" class="bigprice" style="margin-bottom:6px">$0.00</div>
          <div id="qv-when" class="kv">New arrival</div>
          <div id="qv-desc" style="margin-top:10px;line-height:1.4"></div>
          <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
            <button id="qv-fav" class="modal-close" style="background:#111827;color:#fff;border-color:#111827">♥ Add to favorites</button>
            <a id="qv-open" class="modal-close" href="#" target="_blank" rel="noopener" style="text-decoration:none">Open image</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button id="toTop" aria-label="Back to top">↑</button>
  <div id="toast" role="status" aria-live="polite"></div>

<script>
  const LS_KEY = 'hemlinemarket:favorites';
  const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function getFavStore(){ try { return new Set(JSON.parse(localStorage.getItem(LS_KEY) || '[]')); } catch { return new Set(); } }
  function saveFavStore(set){ try { localStorage.setItem(LS_KEY, JSON.stringify([...set])); } catch {} }
  function keyFor(item){ return item.id ?? item.image_url ?? item.title ?? String(Math.random()); }

  function humanizeDate(iso){ if(!iso) return "New arrival"; const dt=new Date(iso); if(isNaN(dt)) return "New arrival";
    const now=new Date(); const d=Math.floor((now-dt)/(24*60*60*1000)); if(d<=1) return "New arrival"; if(d<7) return d+" days ago"; return dt.toLocaleDateString(); }

  function imgWithFallback(src, alt=''){
    const img=document.createElement('img'); img.loading='lazy'; img.decoding='async'; img.src=src; img.alt=alt;
    img.onerror=()=>{ if(img.dataset.failed) return; img.dataset.failed=1; const wrap=img.parentElement; const ph=document.createElement('div'); ph.className='ph'; ph.innerHTML='<div class="dot">🧵</div>'; wrap.replaceChild(ph,img); };
    return img;
  }

  function clearFilters(){
    document.getElementById('onlyFavs').checked=false;
    document.getElementById('q').value='';
    priceRange=null; syncChipStates(); resetPaging(); renderPage();
  }

  function openQV(item){
    const $ = id => document.getElementById(id);
    const price = (typeof item.price_cents==='number') ? (item.price_cents/100).toFixed(2) : (item.price || '0.00');
    $('qv-title').textContent = item.title || '';
    $('qv-img').src = item.image_url || '';
    $('qv-img').alt = item.title || '';
    $('qv-price').textContent = `$${price}`;
    $('qv-when').textContent = humanizeDate(item.created_at || item.date);
    $('qv-desc').textContent = item.description || '';
    $('qv-open').href = item.image_url || '#';

    const favBtn = $('qv-fav');
    favBtn.onclick = () => {
      let set = getFavStore();
      const k = keyFor(item);
      if(set.has(k)) set.delete(k); else set.add(k);
      saveFavStore(set);
      closeQV();
    };

    document.getElementById('qv').style.display='flex';
  }
  function closeQV(){ document.getElementById('qv').style.display='none'; }
  document.addEventListener('click', (e)=>{ const qv=document.getElementById('qv'); if(qv && qv.style.display==='flex' && e.target===qv){ closeQV(); } });

  let currentData = [];
  let favSet = getFavStore();
  let priceRange = null;
  let pageSize = 12;
  let pageIndex = 0;
  let filteredSorted = [];

  function resetPaging(){ pageIndex = 0; document.getElementById('listings').innerHTML=''; }

  function updateFavCount(){ document.getElementById('favCount').textContent = `♥ ${favSet.size} saved`; }
  function updateResultCount(n){ document.getElementById('resultCount').textContent = n ? `${n} item${n>1?'s':''}` : ''; }
  function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }

  function priceMatches(cents){
    if(priceRange === 'u20')  return cents < 2000;
    if(priceRange === '20-50') return cents >= 2000 && cents <= 5000;
    if(priceRange === '50p')   return cents > 5000;
    return true;
  }
  function syncChipStates(){ document.querySelectorAll('.chip[data-range]').forEach(btn=>btn.classList.toggle('active', btn.dataset.range===priceRange)); }

  function matchesQuery(item, q){
    if(!q) return true;
    const s = q.toLowerCase();
    return (item.title || '').toLowerCase().includes(s)
        || (item.description || '').toLowerCase().includes(s);
  }

  function sortRows(rows){
    const mode = document.getElementById('sortBy').value;
    if(mode === 'new'){
      return rows.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
    }
    if(mode === 'plh'){
      return rows.sort((a,b)=>{
        const pa = (typeof a.price_cents==='number') ? a.price_cents : Math.round(parseFloat(a.price||'0')*100);
        const pb = (typeof b.price_cents==='number') ? b.price_cents : Math.round(parseFloat(b.price||'0')*100);
        return pa - pb;
      });
    }
    if(mode === 'phl'){
      return rows.sort((a,b)=>{
        const pa = (typeof a.price_cents==='number') ? a.price_cents : Math.round(parseFloat(a.price||'0')*100);
        const pb = (typeof b.price_cents==='number') ? b.price_cents : Math.round(parseFloat(b.price||'0')*100);
        return pb - pa;
      });
    }
    return rows;
  }

  function applyFilters(){
    const onlyFavs = document.getElementById('onlyFavs').checked;
    const q = document.getElementById('q').value.trim();

    let rows = (currentData||[]).filter(it=>{
      const cents = typeof it.price_cents==='number' ? it.price_cents : Math.round(parseFloat(it.price||'0')*100);
      const favOK = !onlyFavs || favSet.has(keyFor(it));
      const priceOK = priceMatches(cents);
      const textOK = matchesQuery(it, q);
      return favOK && priceOK && textOK;
    });

    rows = sortRows(rows);
    filteredSorted = rows;
    updateResultCount(rows.length);
    document.getElementById('empty').style.display = rows.length ? 'none':'block';
    resetPaging();
  }

  function renderCard(item, idxOffset){
    const price=(typeof item.price_cents==='number')?(item.price_cents/100).toFixed(2):(item.price||'0.00');
    const when=humanizeDate(item.created_at||item.date);
    const k = keyFor(item);

    const card=document.createElement('div'); card.className='listing-card';

    const imgwrap=document.createElement('div'); imgwrap.className='imgwrap';
    const img = imgWithFallback(item.image_url,item.title||'');
    imgwrap.appendChild(img);

    const badge=document.createElement('div'); badge.className='badge'; badge.textContent=when; imgwrap.appendChild(badge);

    const fav=document.createElement('div'); fav.className='fav'; fav.textContent='♥';
    if (favSet.has(k)) fav.classList.add('active');
    fav.addEventListener('click',e=>{
      e.stopPropagation();
      fav.classList.toggle('active');
      fav.classList.add('pop'); setTimeout(()=>fav.classList.remove('pop'),200);
      if (fav.classList.contains('active')) { favSet.add(k); toast('Saved'); }
      else { favSet.delete(k); toast('Removed'); }
      saveFavStore(favSet); updateFavCount();
      if (document.getElementById('onlyFavs').checked && !fav.classList.contains('active')) {
        card.remove(); updateResultCount(document.getElementById('listings').children.length);
        if (!document.getElementById('listings').children.length) {
          document.getElementById('empty').style.display='block';
          document.getElementById('listings').style.display='none';
        }
      }
    });
    imgwrap.appendChild(fav);

    const overlay=document.createElement('div'); overlay.className='overlay'; overlay.textContent=item.quickpeek||"Quick View";
    imgwrap.appendChild(overlay);

    const info=document.createElement('div'); info.className='info';
    info.innerHTML=`<h3 class="title">${item.title||''}</h3><div class="price"><span class="cur">$</span>${price}</div>`;

    card.appendChild(imgwrap); card.appendChild(info);

    // Click to open modal
    card.addEventListener('click', (e)=>{ if(!e.target.classList.contains('fav')) openQV(item); });

    // PARALLAX: tilt image with pointer (reduced-motion safe)
    if(!reduceMotion){
      const maxTilt = 8; // degrees
      const damp = 0.15;
      let rx = 0, ry = 0, vx = 0, vy = 0, rafId = null;

      function animate(){
        vx += (rx - vx) * damp;
        vy += (ry - vy) * damp;
        img.style.transform = `rotateX(${vx}deg) rotateY(${vy}deg) scale(1.03)`;
        rafId = requestAnimationFrame(animate);
      }

      imgwrap.addEventListener('mouseenter', ()=>{
        cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(animate);
      });

      imgwrap.addEventListener('mousemove', (ev)=>{
        const r = imgwrap.getBoundingClientRect();
        const px = (ev.clientX - r.left) / r.width;   // 0..1
        const py = (ev.clientY - r.top)  / r.height;  // 0..1
        // invert X (move left -> rotateY positive) and center both axes
        ry = (px - 0.5) * (maxTilt * 2); // rotateY
        rx = -(py - 0.5) * (maxTilt * 2); // rotateX
      });

      imgwrap.addEventListener('mouseleave', ()=>{
        rx = 0; ry = 0;
        setTimeout(()=>{
          cancelAnimationFrame(rafId);
          img.style.transform = '';
        }, 120);
      });
    }

    if(!reduceMotion){
      setTimeout(()=>card.classList.add('show'), idxOffset); 
    } else {
      card.classList.add('show');
    }
    return card;
  }

  function renderPage(){
    const container = document.getElementById('listings');
    if(!filteredSorted.length){
      container.style.display = 'none';
      document.getElementById('loadMore').disabled = true;
      return;
    }
    container.style.display = 'grid';

    const start = pageIndex * pageSize;
    const end = Math.min(start + pageSize, filteredSorted.length);
    for(let i=start;i<end;i++){
      const card = renderCard(filteredSorted[i], 30*(i-start));
      container.appendChild(card);
    }

    pageIndex++;
    const btn = document.getElementById('loadMore');
    btn.disabled = (pageIndex * pageSize >= filteredSorted.length);
    if (btn.disabled) btn.textContent = 'All caught up';
    else btn.textContent = 'Load more';
  }

  async function loadListings(){
    const sk = document.getElementById('skeletons');
    sk.innerHTML = '';
    for (let i=0;i<6;i++){ sk.insertAdjacentHTML('beforeend', `<div class="sk-card"><div class="sk-img"></div><div class="sk-row w60"></div><div class="sk-row w30" style="margin-top:-6px;"></div></div>`); }
    sk.style.display='grid';
    document.getElementById('listings').style.display='none';
    document.getElementById('empty').style.display='none';

    const { data, error } = await window.supa
      .from('listings')
      .select('id,title,price_cents,price,image_url,created_at,description')
      .order('created_at', { ascending: false })
      .limit(200);

    sk.style.display='none';

    if (error) {
      console.error('Error loading listings:', error);
      document.getElementById('empty').style.display='block';
      return;
    }

    currentData = data || [];
    updateFavCount();
    applyFilters();
    renderPage();
  }

  // Debounced search
  (function(){
    const qEl = document.getElementById('q');
    let t=null;
    qEl.addEventListener('input', ()=>{
      clearTimeout(t);
      t=setTimeout(()=>{ applyFilters(); renderPage(); }, 250);
    });
  })();

  // Sort handler
  document.getElementById('sortBy').addEventListener('change', ()=>{ applyFilters(); renderPage(); });

  // To-top FAB
  (function(){
    const btn=document.getElementById('toTop');
    const onScroll=()=>{ if(window.scrollY>500){ btn.classList.add('show'); } else { btn.classList.remove('show'); } };
    window.addEventListener('scroll', onScroll, { passive:true });
    btn.addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));
    onScroll();
  })();

  // Toolbar filters
  document.getElementById('onlyFavs').addEventListener('change', ()=>{ applyFilters(); renderPage(); });
  document.getElementById('priceChips').addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip[data-range]');
    if(!btn) return;
    priceRange = (priceRange === btn.dataset.range) ? null : btn.dataset.range;
    syncChipStates(); applyFilters(); renderPage();
  });

  // Load more
  document.getElementById('loadMore').addEventListener('click', ()=>renderPage());

  // Infinite scroll sentinel
  const sentinel = document.createElement('div');
  sentinel.style.height = '1px';
  document.body.appendChild(sentinel);
  const io = new IntersectionObserver((entries)=>{
    const btn = document.getElementById('loadMore');
    if(entries[0].isIntersecting && btn && !btn.disabled){
      btn.click();
    }
  }, { rootMargin: '600px' });
  io.observe(sentinel);

  loadListings();
</script>
</body>
</html>
