<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Hemline — Listings</title>
  <style>
    body { margin:0; background:#fafafa; color:#0f172a; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }
    header { position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; padding:12px 16px; font-weight:700; }
    main { max-width:1100px; margin:16px auto; padding:0 16px; }
    .btn { display:inline-block; padding:8px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; margin-left:8px; }

    /* Prevent default link color changes/highlights */
    a, a:visited, a:active { color:inherit; text-decoration:none; -webkit-tap-highlight-color: transparent; }
    button { -webkit-tap-highlight-color: transparent; }

    #status { padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; margin-bottom:12px; }

    .grid { display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:560px){ .grid{ grid-template-columns:1fr 1fr; } }
    @media (min-width:900px){ .grid{ grid-template-columns:1fr 1fr 1fr; } }

    .card { position:relative; background:#fff; border:1px solid #e5e7eb; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; }
    .tile { display:block; position:relative; z-index:1; color:inherit; } /* keep text color fixed */
    .thumb { aspect-ratio: 4/5; background:#f3f4f6; }
    .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .meta { padding:10px 12px; display:flex; flex-direction:column; gap:4px; color:inherit; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; color:inherit; }
    .title { font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:inherit; }
    .price { font-weight:700; color:inherit; }
    .tile:active .title, .tile:active .price { color:inherit; } /* suppress active color */

    /* Heart button (above link) */
    .heart {
      position:absolute; top:10px; right:10px; width:40px; height:40px;
      border:1px solid #e5e7eb; border-radius:999px; background:#fff;
      display:grid; place-items:center; cursor:pointer; z-index:3;
    }
    .heart svg { width:18px; height:18px; fill:none; stroke:#111; stroke-width:2; }
    .heart.active svg { fill:#ef4444; stroke:#ef4444; }
    .heart:active { transform:scale(.96); }
  </style>

  <!-- Env + loaders -->
  <script src="/env.js?v=7"></script>
  <script>
    (function loadSupabase(){
      function inject(src, cb){var s=document.createElement('script');s.src=src; s.onload=cb; s.onerror=cb; document.head.appendChild(s);}
      inject("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js", function(){
        if (!window.supabase) inject("https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js?v=7", function(){});
      });
    })();
  </script>
  <script src="/app.js?v=7"></script>
</head>
<body>
  <header>
    Hemline
    <a class="btn" href="/index.html">Home</a>
    <a class="btn" href="/cart.html">Cart</a>
    <a class="btn" href="/favorites.html">Favorites</a>
  </header>

  <main>
    <div id="status">Loading…</div>
    <div id="grid" class="grid" aria-live="polite"></div>
  </main>

  <script>
    (async () => {
      const s = document.getElementById('status');

      // Wait for Supabase
      let tries=0; while(!window.supabase && tries<20){ await new Promise(r=>setTimeout(r,150)); tries++; }
      if (!window.supabase){ s.textContent='Error: Supabase failed to load.'; return; }
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY){ s.textContent='Missing env.'; return; }

      const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
      const { data: sessionData } = await sb.auth.getSession();
      const userId = sessionData?.session?.user?.id || null;

      s.textContent = 'Connected. Loading listings…';
      let { data, error } = await sb.from('listings')
        .select('id,title,price_cents,status,created_at')
        .eq('status','active')
        .order('created_at',{ascending:false})
        .limit(30);
      try { hm.guard({ data, error }, 'Couldn’t load listings.'); }
      catch(_){ s.textContent='Couldn’t load listings.'; return; }
      if (!data || data.length===0){ s.textContent='No active listings found.'; return; }

      // Preload favorite ids
      let favIds = new Set();
      if (userId) {
        try {
          const res = await sb.from('favorites').select('listing_id').order('created_at',{ascending:false}).limit(500);
          const rows = hm.guard(res, 'Couldn’t load favorites.');
          favIds = new Set(rows.map(r => r.listing_id));
        } catch(_) {}
      }

      // Render cards
      const grid = document.getElementById('grid');
      s.textContent = 'Loaded ' + data.length + ' listing(s).';
      grid.innerHTML = data.map(r => {
        const price = r.price_cents ? '$'+(r.price_cents/100).toFixed(2) : '';
        const favClass = favIds.has(r.id) ? ' active' : '';
        return `
          <div class="card" data-id="${r.id}">
            <a class="tile" href="/listing.html?id=${encodeURIComponent(r.id)}">
              <span class="thumb"><img alt="" style="display:none"></span>
              <span class="meta">
                <span class="row">
                  <span class="title">${r.title ?? 'Untitled'}</span>
                  <span class="price">${price}</span>
                </span>
              </span>
            </a>
            <button type="button" class="heart${favClass}" data-heart aria-label="Save">
              <svg viewBox="0 0 24 24"><path d="M20.8 4.6a5.6 5.6 0 0 0-7.9 0l-.9.9-.9-.9a5.6 5.6 0 1 0-7.9 7.9l.9.9 7.9 7.9 7.9-7.9.9-.9a5.6 5.6 0 0 0 0-7.9z"/></svg>
            </button>
          </div>
        `;
      }).join('');

      // Heart interactions
      grid.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-heart]');
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();

        const card = btn.closest('.card');
        const id = card?.dataset?.id;
        if (!id) return;

        if (!userId) { hm.toast('Sign in to save favorites.'); return; }

        try {
          if (btn.classList.contains('active')) {
            const res = await sb.from('favorites').delete().eq('listing_id', id).eq('user_id', userId);
            hm.guard(res, 'Couldn’t remove favorite.');
            btn.classList.remove('active');
            hm.toast('Removed from Favorites.');
          } else {
            const res = await sb.from('favorites').insert({ listing_id: id, user_id: userId });
            hm.guard(res, 'Couldn’t save favorite.');
            btn.classList.add('active');
            hm.toast('Saved to Favorites.');
          }
        } catch (_) {}
      });
    })();
  </script>
</body>
</html>
