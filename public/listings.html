<div id="listings"></div>
<div id="empty" style="display:none;">No fabrics found.</div>

<script>
function renderCard(item, idxOffset){
  const price = (typeof item.price_cents==='number')
    ? (item.price_cents/100).toFixed(2)
    : (item.price || '0.00');
  const when = humanizeDate(item.created_at||item.date);
  const k = keyFor(item);

  const card = document.createElement('div');
  card.className='listing-card';

  const imgwrap=document.createElement('div');
  imgwrap.className='imgwrap';
  const img = imgWithFallback(item.image_url,item.title||'');
  imgwrap.appendChild(img);

  const badge=document.createElement('div');
  badge.className='badge';
  badge.textContent=when;
  imgwrap.appendChild(badge);

  const fav=document.createElement('div');
  fav.className='fav';
  fav.textContent='â™¥';
  if (favSet.has(k)) fav.classList.add('active');
  fav.addEventListener('click',e=>{
    e.stopPropagation();
    fav.classList.toggle('active');
    fav.classList.add('pop');
    setTimeout(()=>fav.classList.remove('pop'),200);
    if (fav.classList.contains('active')) {
      favSet.add(k); toast('Saved');
    } else {
      favSet.delete(k); toast('Removed');
    }
    saveFavStore(favSet); updateFavCount();
    if (document.getElementById('onlyFavs').checked && !fav.classList.contains('active')) {
      card.remove(); 
      updateResultCount(document.getElementById('listings').children.length);
      if (!document.getElementById('listings').children.length) {
        document.getElementById('empty').style.display='block';
        document.getElementById('listings').style.display='none';
      }
    }
  });
  imgwrap.appendChild(fav);

  const overlay=document.createElement('div');
  overlay.className='overlay';
  overlay.textContent=item.quickpeek||"Quick View";
  imgwrap.appendChild(overlay);

  const info=document.createElement('div');
  info.className='info';
  info.innerHTML=`
    <h3 class="title">${item.title||''}</h3>
    <div class="price"><span class="cur">$</span>${price}</div>
  `;

  // Add-to-cart button
  const btn = document.createElement('button');
  btn.className='hm-add';
  btn.textContent='Add to cart';
  btn.setAttribute('data-add-to-cart','1');
  btn.setAttribute('data-id', item.id);
  btn.setAttribute('data-title', item.title || 'Fabric');
  btn.setAttribute('data-price-cents', item.price_cents || 0);
  btn.setAttribute('data-seller-id', item.seller_id || 'unknown');
  info.appendChild(btn);

  card.appendChild(imgwrap);
  card.appendChild(info);

  // Click to open modal
  card.addEventListener('click',(e)=>{
    if(!e.target.classList.contains('fav') && !e.target.hasAttribute('data-add-to-cart')){
      openQV(item);
    }
  });

  // Tilt effect
  if(!reduceMotion){
    const maxTilt=8; const damp=0.15;
    let rx=0, ry=0, vx=0, vy=0, rafId=null;
    function animate(){
      vx += (rx - vx) * damp;
      vy += (ry - vy) * damp;
      img.style.transform=`rotateX(${vx}deg) rotateY(${vy}deg) scale(1.03)`;
      rafId=requestAnimationFrame(animate);
    }
    imgwrap.addEventListener('mouseenter',()=>{
      cancelAnimationFrame(rafId);
      rafId=requestAnimationFrame(animate);
    });
    imgwrap.addEventListener('mousemove',(ev)=>{
      const r=imgwrap.getBoundingClientRect();
      const px=(ev.clientX-r.left)/r.width;
      const py=(ev.clientY-r.top)/r.height;
      ry=(px-0.5)*(maxTilt*2);
      rx=-(py-0.5)*(maxTilt*2);
    });
    imgwrap.addEventListener('mouseleave',()=>{
      rx=0; ry=0;
      setTimeout(()=>{
        cancelAnimationFrame(rafId);
        img.style.transform='';
      },120);
    });
  }

  if(!reduceMotion){
    setTimeout(()=>card.classList.add('show'), idxOffset);
  } else {
    card.classList.add('show');
  }
  return card;
}

// --- Data fetch + render ---
document.addEventListener('DOMContentLoaded', async () => {
  const container = document.getElementById('listings');
  const emptyMsg = document.getElementById('empty');

  try {
    const { data, error } = await supabase
      .from('listings')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error(error);
      emptyMsg.style.display='block';
      container.style.display='none';
      return;
    }

    if (!data || !data.length) {
      emptyMsg.style.display='block';
      container.style.display='none';
      return;
    }

    data.forEach((item, idx) => {
      const card = renderCard(item, idx*100);
      container.appendChild(card);
    });
  } catch (err) {
    console.error(err);
    emptyMsg.style.display='block';
    container.style.display='none';
  }
});
</script>
