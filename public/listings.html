<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hemline — Listings</title>
  <style>
    :root{--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--card:#f8fafc;--heart:#e11d48}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding-bottom:8px;margin-bottom:14px}
    nav a{padding:8px 10px;border-radius:10px;color:inherit;text-decoration:none}
    nav a:hover{background:var(--card)}
    h1{margin:0}

    .filters{display:grid;grid-template-columns:1fr 110px 110px 160px 150px 100px;gap:8px;border:1px solid var(--line);background:var(--card);border-radius:12px;padding:10px}
    .filters input,.filters select,.filters button{padding:10px;border:1px solid var(--line);border-radius:10px}
    .filters label{display:flex;align-items:center;gap:6px;font-size:14px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-top:14px}
    .card{position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff;cursor:pointer}
    .imgbox{position:relative;background:#fff}
    .card img{width:100%;height:200px;object-fit:cover;display:block}
    .meta{padding:10px}
    .title{font-weight:600}
    .price{color:#0f172a;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .err{color:#b91c1c}

    /* Heart button */
    .fav{
      position:absolute;right:10px;top:10px;
      display:grid;place-items:center;
      width:36px;height:36px;border-radius:999px;
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      box-shadow:0 2px 6px rgba(0,0,0,.05);
      cursor:pointer;
      transition:transform .12s ease;
    }
    .fav:hover{transform:scale(1.04)}
    .fav svg{width:20px;height:20px;display:block}
    .fav .heart{
      fill:transparent;stroke:#111827;stroke-width:1.6;
      transition:fill .18s ease, stroke .18s ease;
    }
    .fav.on{background:#fff}
    .fav.on .heart{fill:var(--heart);stroke:var(--heart)}

    /* pop animation when toggled */
    .fav.pop{animation:pop .22s ease;}
    @keyframes pop{
      0%{transform:scale(.85)}
      60%{transform:scale(1.18)}
      100%{transform:scale(1)}
    }

    /* Recently viewed strip */
    .strip{display:grid;grid-auto-flow:column;grid-auto-columns:120px;gap:10px;overflow-x:auto;padding-bottom:6px}
    .thumb{border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff}
    .thumb img{width:120px;height:80px;object-fit:cover;display:block}
    .thumb .tmeta{padding:6px;font-size:12px}
    .section{margin-top:22px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Fabric Listings</h1>
      <nav>
        <a href="/">Home</a>
        <a href="/seller-dashboard.html">Seller</a>
      </nav>
    </header>

    <!-- Filters -->
    <form id="filterForm" class="filters">
      <input id="q" placeholder="Search title or description…"/>
      <input id="min" type="number" min="0" step="0.01" placeholder="Min $"/>
      <input id="max" type="number" min="0" step="0.01" placeholder="Max $"/>
      <select id="sort">
        <option value="new">Newest</option>
        <option value="price_asc">Price: Low → High</option>
        <option value="price_desc">Price: High → Low</option>
      </select>
      <label><input id="favOnly" type="checkbox"/> Favorites only</label>
      <button type="submit">Apply</button>
    </form>

    <div id="status" class="muted" style="margin-top:10px">Loading…</div>
    <div id="grid" class="grid"></div>
    <div style="margin-top:8px">
      <button id="resetBtn" style="padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff">Reset</button>
    </div>

    <!-- Recently viewed -->
    <div class="section">
      <h3 style="margin:14px 0 8px">Recently viewed</h3>
      <div id="recentStrip" class="strip"></div>
    </div>
  </div>

  <!-- Supabase (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    // ---- CONFIG ----
    const SUPABASE_URL = "https://clkizksbvxjkoatdajgd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI";
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = id => document.getElementById(id);
    const money = cents => `$${(Number(cents||0)/100).toFixed(2)}`;

    // ---- URL state helpers ----
    function initFromURL() {
      const p = new URLSearchParams(location.search);
      $("q").value = p.get("q") || "";
      $("min").value = p.get("min") || "";
      $("max").value = p.get("max") || "";
      $("sort").value = p.get("sort") || "new";
      $("favOnly").checked = p.get("fav") === "1";
    }
    function persistToURL() {
      const p = new URLSearchParams();
      if ($("q").value) p.set("q",$("q").value);
      if ($("min").value) p.set("min",$("min").value);
      if ($("max").value) p.set("max",$("max").value);
      if ($("sort").value && $("sort").value!=="new") p.set("sort",$("sort").value);
      if ($("favOnly").checked) p.set("fav","1");
      history.replaceState(null,"",`${location.pathname}?${p.toString()}`);
    }

    // ---- Favorites & Recently viewed (localStorage) ----
    const FAV_KEY = "hm_favorites_v1";
    const RECENT_KEY = "hm_recent_v1";

    function getFavs(){ try{return new Set(JSON.parse(localStorage.getItem(FAV_KEY)||"[]"));}catch{return new Set();} }
    function saveFavs(set){ localStorage.setItem(FAV_KEY, JSON.stringify(Array.from(set))); }
    function toggleFav(id){
      const favs = getFavs();
      if (favs.has(id)) favs.delete(id); else favs.add(id);
      saveFavs(favs);
    }
    function isFav(id){ return getFavs().has(id); }

    function pushRecent(item){
      try{
        const list = JSON.parse(localStorage.getItem(RECENT_KEY)||"[]");
        const filtered = list.filter(x=>x.id!==item.id);
        filtered.unshift({ id:item.id, image_url:item.image_url, title:item.title, price_cents:item.price_cents });
        localStorage.setItem(RECENT_KEY, JSON.stringify(filtered.slice(0,12)));
        renderRecent();
      }catch{}
    }
    function renderRecent(){
      const strip = $("recentStrip");
      strip.innerHTML = "";
      let items = [];
      try{ items = JSON.parse(localStorage.getItem(RECENT_KEY)||"[]"); }catch{}
      if (!items.length){ strip.innerHTML = '<div class="muted">No recent items yet.</div>'; return; }
      for(const r of items){
        const div = document.createElement("div");
        div.className = "thumb";
        div.innerHTML = `
          <img src="${r.image_url}" alt="${r.title}">
          <div class="tmeta">${r.title}</div>
        `;
        strip.appendChild(div);
      }
    }

    // SVG heart
    const HEART_SVG = `
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path class="heart" d="M12.001 5.882c1.425-2.533 5.17-2.66 6.76-.294 1.22 1.84.73 4.3-.99 5.64l-4.91 3.92a1 1 0 0 1-1.22 0l-4.91-3.92c-1.72-1.34-2.21-3.8-.99-5.64 1.59-2.366 5.335-2.239 6.76.294z"/>
      </svg>`;

    // ---- Fetch & render ----
    async function loadListings() {
      const q = $("q").value.trim();
      const min = $("min").value.trim();
      const max = $("max").value.trim();
      const sort = $("sort").value;
      const favOnly = $("favOnly").checked;
      const favs = getFavs();

      let query = db.from("listings").select("*");

      if (q) query = query.or(`title.ilike.%${q}%,description.ilike.%${q}%`);
      if (min) {
        const minCents = Math.round(parseFloat(min)*100);
        if (!isNaN(minCents)) query = query.gte("price_cents",minCents);
      }
      if (max) {
        const maxCents = Math.round(parseFloat(max)*100);
        if (!isNaN(maxCents)) query = query.lte("price_cents",maxCents);
      }

      if (sort==="price_asc") query = query.order("price_cents",{ascending:true});
      else if (sort==="price_desc") query = query.order("price_cents",{ascending:false});
      else query = query.order("created_at",{ascending:false});

      $("status").textContent = "Loading…";
      $("grid").innerHTML = "";

      const { data, error } = await query.limit(60);
      if (error) { $("status").className="err"; $("status").textContent = "Error: "+error.message; return; }
      let rows = data || [];
      if (favOnly) rows = rows.filter(r=>favs.has(r.id));

      $("status").className="muted";
      $("status").textContent = `Showing ${rows.length} item${rows.length>1?"s":""}.`;

      const grid = $("grid");
      for (const row of rows) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="imgbox">
            <img src="${row.image_url}" alt="${row.title}">
            <button class="fav ${isFav(row.id)?'on':''}" aria-label="Favorite" title="Favorite">
              ${HEART_SVG}
            </button>
          </div>
          <div class="meta">
            <div class="title">${row.title}</div>
            <div class="price">${money(row.price_cents)}</div>
            <div class="muted">${new Date(row.created_at).toLocaleDateString()}</div>
          </div>
        `;

        // toggle favorite + pop animation
        const favBtn = card.querySelector(".fav");
        favBtn.addEventListener("click",(ev)=>{
          ev.stopPropagation();
          toggleFav(row.id);
          const on = isFav(row.id);
          favBtn.classList.toggle("on", on);
          // trigger pop
          favBtn.classList.remove("pop");
          // force reflow so animation restarts
          // eslint-disable-next-line no-unused-expressions
          favBtn.offsetHeight;
          favBtn.classList.add("pop");
        });

        // mark as recently viewed when clicked
        card.addEventListener("click", ()=> pushRecent(row));

        grid.appendChild(card);
      }
    }

    function submitFilters(ev){ ev?.preventDefault(); persistToURL(); loadListings(); }

    window.addEventListener("DOMContentLoaded", () => {
      initFromURL();
      $("filterForm").addEventListener("submit", submitFilters);
      $("resetBtn").addEventListener("click", () => { $("q").value=""; $("min").value=""; $("max").value=""; $("sort").value="new"; $("favOnly").checked=false; submitFilters(); });
      renderRecent();
      loadListings();
    });
  </script>
</body>
</html>
