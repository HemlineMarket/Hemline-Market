<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Hemline — Listings</title>
  <style>
    body { margin:0; background:#fafafa; color:#0f172a; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }
    header { position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; padding:12px 16px; font-weight:700; }
    main { max-width:1100px; margin:16px auto; padding:0 16px; }
    .btn { display:inline-block; padding:8px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; margin-left:8px; }
    #status { padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff; margin-bottom:12px; }
    .grid { display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:560px){ .grid{ grid-template-columns:1fr 1fr; } }
    @media (min-width:900px){ .grid{ grid-template-columns:1fr 1fr 1fr; } }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:12px; }
  </style>

  <!-- Env first (cache-busted) -->
  <script src="/env.js?v=3"></script>

  <!-- Supabase UMD with dual CDN (sync, cache-busted) -->
  <script>
    (function loadSupabase(){
      function inject(src, cb){
        var s=document.createElement('script');
        s.src=src; s.onload=cb; s.onerror=cb; document.head.appendChild(s);
      }
      inject("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js", function(){
        if (!window.supabase) {
          inject("https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js?v=3", function(){});
        }
      });
    })();
  </script>

  <!-- Hemline helpers (cache-busted) -->
  <script src="/app.js?v=3"></script>
</head>
<body>
  <header>
    Hemline
    <a class="btn" href="/index.html">Home</a>
    <a class="btn" href="/cart.html">Cart</a>
    <a class="btn" href="/favorites.html">Favorites</a>
  </header>
  <main>
    <div id="status">Booting v3…</div>
    <div id="grid" class="grid" aria-live="polite"></div>
  </main>

  <script>
    (async () => {
      const s = document.getElementById('status');

      // Wait up to ~3s for Supabase to appear
      let tries = 0;
      while (!window.supabase && tries < 20) {
        await new Promise(r => setTimeout(r, 150));
        tries++;
      }
      if (!window.supabase) { s.textContent = 'Error: Supabase library failed to load.'; return; }

      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        s.textContent = 'Missing env: SUPABASE_URL or ANON key.';
        return;
      }

      // Guard before calling createClient
      const lib = window.supabase;
      if (!lib || typeof lib.createClient !== 'function') {
        s.textContent = 'Error: Supabase global present but createClient missing.';
        return;
      }

      const client = lib.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
      s.textContent = 'Connected (v3). Loading listings…';

      try {
        const { data, error } = await client
          .from('listings')
          .select('id,title,price_cents,status,created_at')
          .eq('status','active')
          .order('created_at', { ascending:false })
          .limit(20);

        hm.guard({ data, error }, 'Couldn’t load listings.');

        if (!data || data.length === 0) {
          s.textContent = 'No active listings found.';
          return;
        }

        s.textContent = 'Loaded ' + data.length + ' listing(s).';
        document.getElementById('grid').innerHTML = data.map(r => `
          <div class="card">
            <div><strong>${r.title ?? 'Untitled'}</strong></div>
            <div>${r.price_cents ? '$' + (r.price_cents/100).toFixed(2) : ''}</div>
          </div>
        `).join('');
      } catch (err) {
        const msg = hm?.normalizeSupabaseError ? hm.normalizeSupabaseError(err) : (err.message || 'Failed');
        s.textContent = 'Error: ' + msg;
      }
    })();
  </script>
</body>
</html>
