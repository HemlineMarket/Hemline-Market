<script src="/cart.js"></script>
<script>
(function(){
  function toast(msg){
    let t=document.querySelector('.hm-toast');
    if(!t){
      t=document.createElement('div');
      t.className='hm-toast';
      document.body.appendChild(t);
    }
    t.textContent=msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),1400);
  }

  // Handle Add-to-cart clicks
  document.addEventListener('click', (e)=>{
    const el = e.target.closest('[data-add-to-cart]');
    if(!el) return;
    e.preventDefault();
    const item = {
      id: el.getAttribute('data-id'),
      title: el.getAttribute('data-title') || 'Fabric',
      seller_id: el.getAttribute('data-seller-id') || 'unknown',
      unit_price_cents: parseInt(el.getAttribute('data-price-cents')||'0',10),
      qty: parseInt(el.getAttribute('data-qty')||'1',10)
    };
    if(!item.id){ toast('Missing item id'); return; }
    if(!window.HEM_CART){ toast('Cart not loaded'); return; }
    window.HEM_CART.addItem(item);
    toast('Added to cart');
  });

  // Inject Add-to-cart buttons directly when rendering each card
  const oldRenderCard = window.renderCard;
  window.renderCard = function(item, idxOffset){
    const card = oldRenderCard(item, idxOffset);

    // Find info area under the card
    const info = card.querySelector('.info');
    if(info && !info.querySelector('[data-add-to-cart]')){
      const btn = document.createElement('button');
      btn.className='hm-add';
      btn.textContent='Add to cart';
      btn.setAttribute('data-add-to-cart','1');
      btn.setAttribute('data-id', item.id);
      btn.setAttribute('data-title', item.title || 'Fabric');
      btn.setAttribute('data-price-cents', item.price_cents || 0);
      btn.setAttribute('data-seller-id', item.seller_id || 'unknown');
      info.appendChild(btn);
    }

    return card;
  };
})();
</script>

<div class="hm-toast" aria-live="polite"></div>
