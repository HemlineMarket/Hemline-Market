<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Fabric Listings</title>
  <style>
    :root { --ink:#0f172a; --line:#e5e7eb; --bg:#fafafa; --card:#ffffff; --accent:#111827; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; margin:24px; background:var(--bg); color:var(--ink); }
    h1 { font-size:1.6rem; font-weight:800; margin:0 0 16px; }
    #listings { display:grid; grid-template-columns:1fr; gap:16px; max-width:820px; }
    .listing-card { background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,.06); }
    .imgwrap { background:#f3f4f6; }
    .imgwrap img { width:100%; height:200px; object-fit:cover; display:block; }
    .info { padding:12px; display:flex; justify-content:space-between; align-items:flex-end; gap:12px; }
    .meta { display:flex; flex-direction:column; gap:4px; }
    .title { font-weight:700; margin:0; }
    .price { font-weight:800; }
    .error { color:#d00; margin-top:12px; }
    /* Add-to-cart UI */
    .hm-add { padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:var(--accent); color:#fff; font-weight:700; cursor:pointer; white-space:nowrap; }
    .hm-toast{position:fixed;right:14px;bottom:14px;background:#111827;color:#fff;padding:10px 12px;border-radius:10px;font:600 13px system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif;box-shadow:0 6px 24px rgba(0,0,0,.15);opacity:0;transform:translateY(8px);transition:all .25s}
    .hm-toast.show{opacity:1;transform:translateY(0)}
    .hm-cart-fab{position:fixed;right:14px;bottom:64px;background:#fff;border:1px solid var(--line);border-radius:999px;padding:10px 12px;font:600 13px system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif;box-shadow:0 6px 24px rgba(0,0,0,.08);text-decoration:none;color:#111827}
  </style>
</head>
<body>
  <h1>Fabric Listings</h1>
  <div id="listings"></div>
  <div id="empty" style="display:none;">No fabrics found.</div>
  <div id="error" class="error" style="display:none;">Error loading listings.</div>

  <!-- Floating link to "Cart" page -->
  <a class="hm-cart-fab" href="/cart.html">Cart</a>
  <div class="hm-toast" aria-live="polite"></div>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <!-- Your cart runtime (already created earlier) -->
  <script src="/cart.js"></script>

  <script>
    /* Project credentials */
    const SUPABASE_URL = "https://clkizksbvxjkoatdajgd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* Inline SVG placeholder (no external DNS) */
    const FALLBACK_IMG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="600" height="360">
        <rect width="100%" height="100%" fill="#eef2f7"/>
        <rect x="60" y="40" width="480" height="280" rx="12" fill="#e5e7eb"/>
        <text x="50%" y="52%" text-anchor="middle" fill="#94a3b8" font-family="system-ui,Segoe UI,Roboto,Arial" font-size="20">
          Hemline image placeholder
        </text>
      </svg>`
    );

    function toast(msg){
      let t=document.querySelector('.hm-toast');
      t.textContent=msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'),1400);
    }

    // Global click handler for "Add to cart"
    document.addEventListener('click', (e)=>{
      const el = e.target.closest('[data-add-to-cart]');
      if(!el) return;
      e.preventDefault();

      const item = {
        id: el.getAttribute('data-id'),
        title: el.getAttribute('data-title') || 'Fabric',
        seller_id: el.getAttribute('data-seller-id') || 'unknown',
        unit_price_cents: parseInt(el.getAttribute('data-price-cents')||'0',10),
        qty: 1
      };

      if(!window.HEM_CART){ toast('Cart not loaded'); return; }
      if(!item.id){ toast('Missing item id'); return; }

      window.HEM_CART.addItem(item);
      toast('Added to cart');
    });

    async function loadListings() {
      const { data, error } = await supabase
        .from("listings")
        .select("id, seller_id, title, description, price_cents, image_url, created_at")
        .order("created_at", { ascending: false });

      console.log("Supabase fetch result:", { data, error });

      const container = document.getElementById("listings");
      const emptyEl = document.getElementById("empty");
      const errEl = document.getElementById("error");

      if (error) { errEl.style.display = "block"; return; }
      if (!data || data.length === 0) { emptyEl.style.display = "block"; return; }

      container.innerHTML = "";
      data.forEach(item => {
        const card = document.createElement("div");
        card.className = "listing-card";

        const imgwrap = document.createElement("div");
        imgwrap.className = "imgwrap";
        const img = document.createElement("img");
        img.src = item.image_url || FALLBACK_IMG;
        img.alt = item.title || "Fabric";
        imgwrap.appendChild(img);

        const info = document.createElement("div");
        info.className = "info";

        const meta = document.createElement("div");
        meta.className = "meta";
        const price = (Number(item.price_cents || 0) / 100).toFixed(2);
        meta.innerHTML = `
          <div class="title">${item.title || "Untitled"}</div>
          <div class="price">$${price}</div>
        `;

        // Add-to-cart button with required data- attributes
        const btn = document.createElement("button");
        btn.className = "hm-add";
        btn.textContent = "Add to cart";
        btn.setAttribute("data-add-to-cart","1");
        btn.setAttribute("data-id", item.id);
        btn.setAttribute("data-title", item.title || "Fabric");
        btn.setAttribute("data-price-cents", item.price_cents || 0);
        btn.setAttribute("data-seller-id", item.seller_id || "unknown");

        info.appendChild(meta);
        info.appendChild(btn);
        card.appendChild(imgwrap);
        card.appendChild(info);
        container.appendChild(card);
      });
    }

    loadListings();
  </script>
</body>
</html>
