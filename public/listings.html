<script src="/cart.js"></script>
<script>
(function(){
  const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

  function toast(msg){
    let t=document.querySelector('.hm-toast');
    if(!t){
      t=document.createElement('div');
      t.className='hm-toast';
      document.body.appendChild(t);
    }
    t.textContent=msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),1400);
  }

  // Handle clicks on Add-to-cart
  document.addEventListener('click', (e)=>{
    const el = e.target.closest('[data-add-to-cart]');
    if(!el) return;
    e.preventDefault();
    const item = {
      id: el.getAttribute('data-id'),
      title: el.getAttribute('data-title') || 'Fabric',
      seller_id: el.getAttribute('data-seller-id') || 'unknown',
      unit_price_cents: parseInt(el.getAttribute('data-price-cents')||'0',10),
      qty: parseInt(el.getAttribute('data-qty')||'1',10)
    };
    if(!item.id){ toast('Missing item id'); return; }
    if(!window.HEM_CART){ toast('Cart not loaded'); return; }
    window.HEM_CART.addItem(item);
    toast('Added to cart');
  });

  // Auto-inject Add-to-cart buttons for each listing card
  $$('[data-listing-id]').forEach(card=>{
    if(card.querySelector('[data-add-to-cart]')) return;

    const id = card.getAttribute('data-listing-id');
    const title = card.getAttribute('data-title') || card.querySelector('h3, .title')?.textContent?.trim() || 'Fabric';
    const price = card.getAttribute('data-price-cents') || card.querySelector('.price')?.textContent?.replace(/\D/g,'') || '0';
    const seller = card.getAttribute('data-seller-id') || 'unknown';

    const btn = document.createElement('button');
    btn.className='hm-add';
    btn.textContent='Add to cart';
    btn.setAttribute('data-add-to-cart','1');
    btn.setAttribute('data-id', id);
    btn.setAttribute('data-title', title);
    btn.setAttribute('data-price-cents', price);
    btn.setAttribute('data-seller-id', seller);

    (card.querySelector('.info') || card).appendChild(btn);
  });
})();
</script>
