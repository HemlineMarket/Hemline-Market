<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Sales ‚Äî Hemline Market</title>

  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>

  <!-- Supabase client (your project already has this) -->
  <script defer src="scripts/supabase-client.js"></script>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
      --hm-card:#ffffff;
      --hm-shadow:0 8px 24px rgba(17,24,39,.08);
      --hm-radius:16px;
    }

    html, body { margin:0; background:var(--hm-bg); color:var(--hm-text); }
    .wrap{ max-width:980px; margin:0 auto; padding:28px 16px 48px; }

    .page-title{ font-size:28px; font-weight:800; margin:4px 0 6px; }
    .page-sub{ color:var(--hm-muted); margin:0 0 18px; }

    .card{
      background:var(--hm-card);
      border:1px solid var(--hm-border);
      border-radius:var(--hm-radius);
      box-shadow:var(--hm-shadow);
      padding:16px;
    }

    .empty{
      text-align:center;
      padding:18px;
      color:var(--hm-muted);
    }

    .sale-row{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--hm-border);
      background:#fff;
    }
    .sale-left{ min-width:0; flex:1; }
    .sale-right{ min-width:260px; display:flex; justify-content:flex-end; }
    @media (max-width: 820px){
      .sale-row{ flex-direction:column; }
      .sale-right{ justify-content:flex-start; min-width:0; }
    }

    /* Mini listing tile (Browse-style, clickable) */
    .mini-tile{
      display:flex;
      gap:12px;
      align-items:center;
      width:100%;
      text-decoration:none;
      color:inherit;
    }
    .mini-img{
      width:64px; height:64px; border-radius:12px;
      border:1px solid var(--hm-border);
      overflow:hidden;
      background:linear-gradient(180deg, rgba(17,24,39,.06), rgba(17,24,39,.02));
      flex:0 0 auto;
    }
    .mini-img img{ width:100%; height:100%; object-fit:cover; display:block; }
    .mini-meta{ min-width:0; flex:1; }
    .mini-title{
      font-weight:800;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin:0 0 4px;
    }
    .mini-sub{
      color:var(--hm-muted);
      font-size:13px;
      margin:0;
    }
    .mini-cta{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }
    .mini-pill{
      border:1px solid var(--hm-border);
      border-radius:999px;
      padding:6px 10px;
      font-weight:700;
      font-size:13px;
      background:#fff;
      white-space:nowrap;
    }
    .mini-arrow{
      font-size:18px;
      color:var(--hm-muted);
      line-height:1;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--hm-border);
      background:#fff;
    }

    .sale-details{
      margin-top:8px;
      display:grid;
      grid-template-columns: 1fr;
      gap:4px;
      color:var(--hm-muted);
      font-size:13px;
    }
    .sale-details b{ color:var(--hm-text); font-weight:800; }

    .actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    select, button{
      font:inherit;
    }
    select{
      border:1px solid var(--hm-border);
      border-radius:10px;
      padding:8px 10px;
      background:#fff;
      min-width:220px;
    }
    button{
      border:1px solid var(--hm-border);
      border-radius:10px;
      padding:9px 12px;
      background:#fff;
      cursor:pointer;
      font-weight:800;
    }
    button.primary{
      background:var(--hm-accent);
      border-color:var(--hm-accent);
      color:#fff;
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; }

    .note{
      margin-top:10px;
      color:var(--hm-muted);
      font-size:12px;
    }

    /* optional debug strip: only appears when ?debug=1 */
    .debug{
      margin-top:10px;
      font-size:12px;
      color:var(--hm-muted);
      background:#fff;
      border:1px dashed var(--hm-border);
      border-radius:12px;
      padding:10px 12px;
    }
  </style>
</head>

<body>
  <!-- Your existing shared header should already render here (hm-header.css) -->
  <header class="hm-header">
    <div class="hm-header__inner">
      <a class="hm-header__brand" href="/">Hemline Market</a>
      <nav class="hm-header__nav">
        <a class="hm-header__icon" href="/browse.html" aria-label="Browse">üîé</a>
        <a class="hm-header__icon" href="/favorites.html" aria-label="Favorites">‚ô°</a>
        <a class="hm-header__icon" href="/messages.html" aria-label="Messages">üí¨</a>
        <a class="hm-header__icon" href="/sales.html" aria-label="Sales">üßæ</a>
        <a class="hm-header__icon" href="/cart.html" aria-label="Cart">üõí</a>
        <a class="hm-header__icon" href="/account.html" aria-label="Account">üë§</a>
        <a class="hm-header__sell" href="/sell.html">Sell</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="page-title">Your Sales</div>
    <p class="page-sub">Fabric buyers purchased from your listings.</p>

    <div id="root" class="card">
      <div class="empty">Loading‚Ä¶</div>
    </div>

    <div id="debug" class="debug" style="display:none;"></div>
  </main>

  <footer class="hm-footer">
    <div class="hm-footer__inner">
      <div>¬© 2025 Hemline Market</div>
      <div class="hm-footer__links">
        <a href="/about.html">About</a>
        <a href="/faq.html">FAQ</a>
        <a href="/contact.html">Contact</a>
        <a href="/terms.html">Terms</a>
        <a href="/privacy.html">Privacy</a>
      </div>
    </div>
  </footer>

  <script>
    (function(){
      const $root = document.getElementById('root');
      const $debug = document.getElementById('debug');

      const DEBUG = new URLSearchParams(location.search).get('debug') === '1';

      function money(cents){
        const n = Number(cents || 0);
        return (n/100).toLocaleString(undefined, { style:'currency', currency:'USD' });
      }
      function fmtDate(iso){
        try{
          const d = new Date(iso);
          return d.toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric' });
        }catch(e){ return ''; }
      }

      // Shipping tiers (same policy you showed)
      function computeShippingCentsFromYards(yards){
        const y = Number(yards || 0);
        if (y <= 0) return 0;
        if (y < 3) return 500;      // Lightweight
        if (y <= 10) return 800;    // Standard
        return 1400;                // Heavy
      }

      // Prefer actual stored values if present; otherwise compute from yards
      function getYardsFromOrder(order){
        // We store qty in listing_snapshot->items[0].qty in your test data
        // Some rows may not have it; fall back to 1
        const snap = order.listing_snapshot || {};
        const qty = snap?.items?.[0]?.qty;
        const n = Number(qty);
        return Number.isFinite(n) && n > 0 ? n : 1;
      }

      function getImageFromOrderOrListing(order, listing){
        // Try explicit order fields
        const direct =
          order.listing_image_url ||
          order.image_url ||
          order.listing_snapshot?.image_url ||
          order.listing_snapshot?.imageUrl ||
          order.listing_snapshot?.image ||
          order.listing_snapshot?.items?.[0]?.image_url ||
          order.listing_snapshot?.items?.[0]?.imageUrl;

        if (direct) return direct;

        // Try listing record
        if (listing && listing.image_url) return listing.image_url;

        return '';
      }

      function safeText(x){
        return (x === null || x === undefined) ? '' : String(x);
      }

      async function getClient(){
        // Support either window.supabase (common) or window.supabaseClient
        if (window.supabase) return window.supabase;
        if (window.supabaseClient) return window.supabaseClient;
        throw new Error('Supabase client not found. Ensure scripts/supabase-client.js loads and sets window.supabase.');
      }

      async function loadSales(){
        const supabase = await getClient();

        const { data: { user }, error: userErr } = await supabase.auth.getUser();
        if (userErr) throw userErr;

        if (!user){
          $root.innerHTML = `
            <div class="empty">
              <div style="font-weight:800; color: var(--hm-text); margin-bottom:6px;">Sign in to view your sales.</div>
              <div>Go to <a href="/account.html">Account</a> to sign in.</div>
            </div>
          `;
          return;
        }

        // Pull orders where current user is seller.
        // We DO NOT show any ‚ÄúSigned in as ‚Ä¶‚Äù unless ?debug=1
        const { data: orders, error: ordersErr } = await supabase
          .from('orders')
          .select('id, created_at, status, seller_id, buyer_id, buyer_email, listing_id, listing_title, total_cents, items_cents, shipping_cents, listing_image_url, listing_snapshot, cancel_reason, canceled_at, cancel_requested_at')
          .eq('seller_id', user.id)
          .order('created_at', { ascending: false })
          .limit(50);

        if (ordersErr) throw ordersErr;

        if (DEBUG){
          $debug.style.display = 'block';
          $debug.textContent = `Signed in user_id=${user.id}`;
        }

        if (!orders || orders.length === 0){
          $root.innerHTML = `<div class="empty">You haven‚Äôt sold anything yet.</div>`;
          return;
        }

        // Fetch listing details for link + possible image fallback
        const listingIds = Array.from(new Set(orders.map(o => o.listing_id).filter(Boolean)));
        let listingsById = {};
        if (listingIds.length){
          const { data: listings, error: listErr } = await supabase
            .from('listings')
            .select('id, title, image_url, price_cents')
            .in('id', listingIds);

          if (!listErr && listings){
            listingsById = Object.fromEntries(listings.map(l => [l.id, l]));
          }
        }

        $root.innerHTML = '';
        for (const o of orders){
          const yards = getYardsFromOrder(o);

          // items_cents is best for ‚Äú$X for Y yards‚Äù (poshmark-like)
          const itemsCents = Number(o.items_cents ?? o.total_cents ?? 0);
          const storedShip = Number(o.shipping_cents ?? 0);
          const shipCents = storedShip > 0 ? storedShip : computeShippingCentsFromYards(yards);

          const totalCents = Number(o.total_cents ?? (itemsCents + shipCents));
          const title = safeText(o.listing_title || listingsById[o.listing_id]?.title || 'Listing');
          const listingHref = o.listing_id ? `/listing.html?id=${encodeURIComponent(o.listing_id)}` : '#';

          const img = getImageFromOrderOrListing(o, listingsById[o.listing_id]);
          const buyer = safeText(o.buyer_email || '');

          const canCancel = (o.status === 'PAID'); // keep simple for now

          const row = document.createElement('div');
          row.className = 'sale-row';

          row.innerHTML = `
            <div class="sale-left">
              <a class="mini-tile" href="${listingHref}">
                <div class="mini-img">
                  ${img ? `<img src="${img}" alt="">` : ``}
                </div>
                <div class="mini-meta">
                  <div class="mini-title">${escapeHtml(title)}</div>
                  <p class="mini-sub">Sold ¬∑ ${escapeHtml(fmtDate(o.created_at))}</p>
                </div>
                <div class="mini-cta">
                  <div class="mini-pill">${escapeHtml(money(itemsCents))} for ${escapeHtml(String(yards))} yd</div>
                  <div class="mini-arrow" aria-hidden="true">‚Ä∫</div>
                </div>
              </a>

              <div class="sale-details">
                <div><b>Buyer:</b> ${buyer ? escapeHtml(buyer) : '‚Äî'}</div>
                <div><b>Shipping:</b> ${escapeHtml(money(shipCents))} &nbsp;¬∑&nbsp; <b>Total spent:</b> ${escapeHtml(money(totalCents))}</div>
              </div>

              <div class="actions">
                <select class="cancel-reason" ${canCancel ? '' : 'disabled'}>
                  <option value="">Cancel reason‚Ä¶</option>
                  <option value="cannot_ship">Can‚Äôt ship within 5 business days</option>
                  <option value="listing_issue">Listing issue / inventory problem</option>
                  <option value="buyer_requested">Buyer requested cancellation</option>
                  <option value="other">Other</option>
                </select>
                <button class="primary cancel-btn" ${canCancel ? '' : 'disabled'}>Cancel order</button>
              </div>

              <div class="note">
                ${canCancel ? 'Canceling will mark the order as canceled (you can refine refund/Stripe handling later).' : `Status: ${escapeHtml(String(o.status || '‚Äî'))}`}
              </div>
            </div>
          `;

          // Wire cancel
          const $reason = row.querySelector('.cancel-reason');
          const $btn = row.querySelector('.cancel-btn');

          $btn?.addEventListener('click', async (e) => {
            e.preventDefault();
            const reason = ($reason?.value || '').trim();
            if (!reason){
              alert('Please select a cancel reason.');
              return;
            }

            $btn.disabled = true;
            try{
              const { error: updErr } = await supabase
                .from('orders')
                .update({
                  status: 'CANCELED',
                  cancel_reason: reason,
                  canceled_at: new Date().toISOString(),
                  canceled_by: user.id
                })
                .eq('id', o.id)
                .eq('seller_id', user.id);

              if (updErr) throw updErr;

              // Refresh
              await loadSales();
            }catch(err){
              console.error(err);
              alert(err?.message || 'Failed to cancel order.');
              $btn.disabled = false;
            }
          });

          $root.appendChild(row);
        }
      }

      function escapeHtml(str){
        return String(str)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }

      // Start
      window.addEventListener('error', (e) => {
        console.error(e.error || e.message);
      });

      // Load once supabase script is ready
      const start = async () => {
        try{
          await loadSales();
        }catch(err){
          console.error(err);
          $root.innerHTML = `<div class="empty">Error loading sales: ${escapeHtml(err?.message || String(err))}</div>`;
        }
      };

      // if supabase client script loads after DOM, give it a moment
      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', start);
      } else {
        start();
      }
    })();
  </script>
</body>
</html>
