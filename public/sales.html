<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Sales ‚Äî Hemline Market</title>

  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">

  <!-- Shared styles (universal stack) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-text:#111827;
      --hm-muted:#6b7280;
      --hm-border:#e5e7eb;
      --hm-bg:#f4f4f7;
      --hm-card:rgba(255,255,255,.96);
    }
    html,body{
      margin:0;
      background:var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    .wrap{
      max-width:1100px;
      margin:18px auto 28px;
      padding:0 12px;
    }

    .page-title{
      font-size:28px;
      margin:6px 0 4px;
    }
    .page-sub{
      color:var(--hm-muted);
      margin:0 0 14px;
      font-size:13px;
    }

    .statusline{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin:6px 0 14px;
      color:var(--hm-muted);
      font-size:12px;
    }

    .panel{
      background:#fff;
      border:1px solid var(--hm-border);
      border-radius:12px;
      padding:12px;
    }

    /* Sales card */
    .sale-card{
      background:var(--hm-card);
      border:1px solid var(--hm-border);
      border-radius:14px;
      overflow:hidden;
      display:grid;
      grid-template-columns:140px 1fr;
      margin:10px 0;
    }
    @media (max-width:640px){
      .sale-card{ grid-template-columns:110px 1fr; }
    }

    .thumb-link{
      display:block;
      text-decoration:none;
      color:inherit;
      background:linear-gradient(180deg,#f8fafc,#eef2f7);
      border-right:1px solid var(--hm-border);
      min-height:110px;
      position:relative;
    }
    .thumb{
      width:100%;
      height:100%;
      display:block;
      object-fit:cover;
    }
    .thumb-fallback{
      width:100%;
      height:100%;
      min-height:110px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      color:#6b7280;
      user-select:none;
      padding:10px;
      text-align:center;
    }
    .thumb-fallback .icon{
      width:44px;
      height:44px;
      border-radius:12px;
      background:#fff;
      border:1px solid var(--hm-border);
      display:grid;
      place-items:center;
      font-size:20px;
    }
    .thumb-fallback .label{
      font-weight:800;
      letter-spacing:.02em;
      font-size:12px;
      color:#374151;
    }
    .thumb-fallback .sub{
      font-size:11px;
      color:var(--hm-muted);
      line-height:1.2;
      max-width:120px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .sale-body{
      padding:10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .toprow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      min-width:0;
    }
    .title{
      font-weight:800;
      font-size:14px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .title a{
      color:inherit;
      text-decoration:none;
    }
    .title a:hover{ text-decoration:underline; }

    .rightmeta{
      text-align:right;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .rightmeta .big{
      font-weight:900;
      font-size:14px;
    }
    .rightmeta .small{
      color:var(--hm-muted);
      font-size:12px;
      margin-top:2px;
    }

    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      color:var(--hm-muted);
      font-size:12px;
      align-items:center;
    }
    .pill{
      font-size:11px;
      font-weight:800;
      border:1px solid var(--hm-border);
      background:#f3f4f6;
      color:#374151;
      padding:2px 8px;
      border-radius:999px;
    }
    .pill.paid{ background:#eef2ff; border-color:#c7d2fe; color:#3730a3; }
    .pill.shipped{ background:#ecfdf5; border-color:#bbf7d0; color:#065f46; }
    .pill.refunded{ background:#fff7ed; border-color:#fed7aa; color:#9a3412; }
    .pill.canceled{ background:#fef2f2; border-color:#fecaca; color:#991b1b; }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:4px;
    }
    select{
      padding:8px 10px;
      border:1px solid var(--hm-border);
      border-radius:10px;
      background:#fff;
      font-size:13px;
      min-width:220px;
      height:36px;
    }
    .btn{
      padding:7px 10px;
      border-radius:10px;
      border:1px solid var(--hm-border);
      background:#fff;
      color:#111827;
      font-weight:800;
      cursor:pointer;
      height:36px;
      font-size:13px;
    }
    .btn-danger{
      border-color:var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
    }
    .btn[disabled], select[disabled]{
      opacity:.55;
      cursor:not-allowed;
    }

    .note{
      font-size:12px;
      color:var(--hm-muted);
      margin-top:2px;
    }

    .empty{
      color:var(--hm-muted);
      padding:14px 2px 0;
      font-size:13px;
    }

    .error{
      color:#991b1b;
      background:#fff;
      border:1px solid #fecaca;
      padding:10px 12px;
      border-radius:12px;
      margin-top:10px;
      font-size:13px;
    }
  </style>
</head>
<body>

  <!-- UNIVERSAL HEADER (injected by hm-shell.js) -->
  <div id="hm-shell-header"></div>

  <main class="wrap">
    <h1 class="page-title">Your Sales</h1>
    <p class="page-sub">Fabric buyers purchased from your listings.</p>

    <div class="statusline">
      <div id="signedInLine">Checking sign-in‚Ä¶</div>
      <div id="countLine"></div>
    </div>

    <section class="panel">
      <div id="salesList"></div>
      <div id="empty" class="empty" style="display:none;">You haven‚Äôt sold anything yet.</div>
      <div id="err" class="error" style="display:none;"></div>
    </section>
  </main>

  <!-- UNIVERSAL FOOTER (injected by hm-shell.js) -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Shared shell (universal header/footer + menu + header session) -->
  <script src="scripts/hm-shell.js"></script>

  <script>
    window.HM && window.HM.renderShell({ currentPage: "sales" });
  </script>

  <script>
    // ---- Supabase client (single instance) ----
    const SUPABASE_URL = "https://clkizksbvxjkoatdajgd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI";

    const supabaseClient = (window.__hmSupabase ||= window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY,
      {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      }
    ));

    const elList  = document.getElementById("salesList");
    const elEmpty = document.getElementById("empty");
    const elErr   = document.getElementById("err");
    const elSigned= document.getElementById("signedInLine");
    const elCount = document.getElementById("countLine");

    // listing_id -> { image_url_1, title }
    const listingMeta = new Map();

    function moneyFromCents(c){
      if(c == null || !Number.isFinite(Number(c))) return null;
      return (Number(c)/100).toLocaleString("en-US", { style:"currency", currency:"USD" });
    }

    function formatDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleDateString("en-US", { month:"short", day:"numeric", year:"numeric" });
      }catch(_){
        return "";
      }
    }

    function getQtyFromSnapshot(snap){
      try{
        if(!snap) return null;
        const items = snap.items;
        if(Array.isArray(items) && items[0] && items[0].qty != null){
          const q = Number(items[0].qty);
          return Number.isFinite(q) ? q : null;
        }
      }catch(_){}
      return null;
    }

    function getThumbFromSnapshot(snap){
      try{
        if(!snap) return "";
        return snap.image_url || snap.image_url_1 || snap.photo || "";
      }catch(_){}
      return "";
    }

    // Shipping policy fallback (only used when stored shipping is missing/0)
    function shippingByPolicy(qty){
      if(qty == null || !Number.isFinite(Number(qty))) return null;
      const y = Number(qty);
      if(y < 3) return 500;
      if(y <= 10) return 800;
      return 1400;
    }

    function statusClass(s){
      const v = String(s || "").toUpperCase();
      if(v === "PAID") return "paid";
      if(v === "SHIPPED") return "shipped";
      if(v === "REFUNDED") return "refunded";
      if(v === "CANCELED" || v === "CANCELLED") return "canceled";
      return "";
    }

    // Cancel should only be available before shipped.
    function isShipped(o){
      const st = String(o.status || "").toUpperCase();
      if(st === "SHIPPED" || st === "DELIVERED" || st === "COMPLETED") return true;
      // allow future schema without breaking:
      if(o.shipped_at) return true;
      if(o.tracking_number) return true;
      return false;
    }

    function clearUI(){
      elErr.style.display = "none";
      elErr.textContent = "";
      elEmpty.style.display = "none";
      elList.innerHTML = "";
      elCount.textContent = "";
    }

    async function cancelOrder(orderId, reason){
      if(!orderId) return;
      if(!reason){
        alert("Please choose a cancellation reason first.");
        return;
      }

      const patch = {
        status: "CANCELED",
        updated_at: new Date().toISOString(),
        cancel_reason: reason
      };

      const { error } = await supabaseClient
        .from("orders")
        .update(patch)
        .eq("id", orderId);

      if(error){
        console.error("Cancel failed:", error);
        alert("Cancel failed. Check RLS/policies for updating orders.");
        return;
      }
      await loadSales();
    }

    async function fetchListingMeta(listingIds){
      const ids = Array.from(new Set((listingIds || []).filter(Boolean)));
      const missing = ids.filter(id => !listingMeta.has(id));
      if(!missing.length) return;

      const { data, error } = await supabaseClient
        .from("listings")
        .select("id, title, image_url_1")
        .in("id", missing);

      if(error){
        console.warn("Could not fetch listing meta:", error);
        return;
      }
      (data || []).forEach(l => listingMeta.set(l.id, { title: l.title || "", image_url_1: l.image_url_1 || "" }));
    }

    function renderSaleRow(o){
      const listingId = o.listing_id;
      const href = listingId ? ("listing.html?id=" + encodeURIComponent(listingId)) : "#";

      const snap = o.listing_snapshot || null;
      const qty = getQtyFromSnapshot(snap);

      // Thumb: snapshot -> listings table -> fallback tile
      const snapThumb = getThumbFromSnapshot(snap);
      const meta = listingId ? (listingMeta.get(listingId) || {}) : {};
      const thumb = snapThumb || meta.image_url_1 || "";

      const title = o.listing_title || meta.title || "Untitled listing";

      const itemsCents = (o.items_cents != null ? Number(o.items_cents) : null);
      const storedShip = (o.shipping_cents != null ? Number(o.shipping_cents) : null);
      const totalCents = (o.total_cents != null ? Number(o.total_cents) : null);

      // Shipping display: prefer stored shipping, otherwise policy fallback (but DO NOT label it ‚Äúpolicy‚Äù)
      let shipCents = storedShip;
      if((shipCents == null || shipCents === 0) && qty != null){
        shipCents = shippingByPolicy(qty);
      }

      // Total spent: prefer stored total, otherwise derive.
      let spentCents = totalCents;
      if(spentCents == null && itemsCents != null){
        spentCents = itemsCents + (shipCents || 0);
      }

      const st = String(o.status || "").toUpperCase() || "‚Äî";
      const pillCls = statusClass(st);

      const rightBig = (spentCents != null && qty != null)
        ? `${moneyFromCents(spentCents)} for ${qty} yards`
        : (spentCents != null ? moneyFromCents(spentCents) : "‚Äî");

      const shipLine = (shipCents != null)
        ? `${moneyFromCents(shipCents)} shipping`
        : `Shipping: ‚Äî`;

      const shipped = isShipped(o);
      const canCancel = (st === "PAID") && !shipped;

      const card = document.createElement("article");
      card.className = "sale-card";
      card.innerHTML = `
        <a class="thumb-link" href="${href}" aria-label="Open listing">
          ${
            thumb
              ? `<img class="thumb" src="${thumb}" alt="">`
              : `
                <div class="thumb-fallback" aria-hidden="true">
                  <div class="icon">üì¶</div>
                  <div class="label">Listing</div>
                  <div class="sub">${(title || "").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
                </div>
              `
          }
        </a>

        <div class="sale-body">
          <div class="toprow">
            <div style="min-width:0">
              <p class="title"><a href="${href}">${title}</a></p>
              <div class="meta">
                <span class="pill ${pillCls}">${st}</span>
                ${shipped ? `<span class="pill shipped">SHIPPED</span>` : ``}
                ${qty != null ? `<span>${qty} yards</span>` : ``}
                <span>Sold ¬∑ ${formatDate(o.created_at)}</span>
                <span>Buyer: ${o.buyer_email || "‚Äî"}</span>
              </div>
            </div>

            <div class="rightmeta">
              <div class="big">${rightBig}</div>
              <div class="small">${shipLine}</div>
            </div>
          </div>

          ${
            canCancel
              ? `
                <div class="actions">
                  <select data-cancel-reason>
                    <option value="">Cancel reason‚Ä¶</option>
                    <option value="Out of stock">Out of stock</option>
                    <option value="Cannot ship in time">Cannot ship in time</option>
                    <option value="Item damaged / incorrect">Item damaged / incorrect</option>
                    <option value="Buyer requested cancel">Buyer requested cancel</option>
                    <option value="Other">Other</option>
                  </select>

                  <button class="btn btn-danger" data-cancel-btn>Cancel order</button>
                </div>
                <div class="note">Cancel is available until the order is marked shipped.</div>
              `
              : ``
          }
        </div>
      `;

      if(canCancel){
        const sel = card.querySelector("[data-cancel-reason]");
        const btn = card.querySelector("[data-cancel-btn]");
        btn.addEventListener("click", () => cancelOrder(o.id, sel.value));
      }

      return card;
    }

    async function loadSales(){
      clearUI();
      elSigned.textContent = "Checking sign-in‚Ä¶";

      const { data: sessionData } = await supabaseClient.auth.getSession();
      const user = sessionData?.session?.user;

      if(!user){
        elSigned.textContent = "Not signed in";
        elEmpty.style.display = "block";
        elEmpty.textContent = "Sign in to view your sales.";
        return;
      }

      elSigned.textContent = "Signed in";

      // Seller view uses seller_id = current user
      const { data, error } = await supabaseClient
        .from("orders")
        .select("id, created_at, status, shipped_at, tracking_number, seller_id, buyer_email, buyer_id, listing_id, listing_title, items_cents, shipping_cents, total_cents, listing_snapshot")
        .eq("seller_id", user.id)
        .order("created_at", { ascending:false });

      if(error){
        console.error("Sales load error:", error);
        elErr.style.display = "block";
        elErr.textContent = "Error loading sales. (Check orders RLS for seller read, and confirm you are signed in.)";
        return;
      }

      const rows = data || [];
      elCount.textContent = rows.length ? (rows.length === 1 ? "1 sale" : rows.length + " sales") : "";

      if(!rows.length){
        elEmpty.style.display = "block";
        return;
      }

      // Fill in thumbnails/titles (so the left block actually looks like a listing)
      await fetchListingMeta(rows.map(r => r.listing_id));

      const frag = document.createDocumentFragment();
      rows.forEach(o => frag.appendChild(renderSaleRow(o)));
      elList.appendChild(frag);
    }

    document.addEventListener("DOMContentLoaded", loadSales);
  </script>
</body>
</html>
