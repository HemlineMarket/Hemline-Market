<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Sales — Hemline Market</title>

  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    .sales-wrap{max-width:900px;margin:20px auto;padding:0 14px}
    .sale-card{
      display:grid;
      grid-template-columns:96px 1fr;
      gap:14px;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
    }
    .sale-thumb{
      width:96px;height:96px;
      border-radius:10px;
      overflow:hidden;
      background:#f3f4f6;
      display:grid;place-items:center;
      font-weight:700;color:#9ca3af;
    }
    .sale-thumb img{width:100%;height:100%;object-fit:cover}
    .sale-title{font-weight:700}
    .sale-meta{font-size:13px;color:#6b7280}
    .sale-right{margin-left:auto;text-align:right}
    .sale-total{font-weight:700}
    .sale-actions{margin-top:8px;display:flex;gap:8px}
    .btn-small{
      padding:6px 10px;
      border-radius:8px;
      font-size:13px;
      border:1px solid #e5e7eb;
      background:#fff;
      cursor:pointer;
    }
    .btn-danger{
      background:#7f1d1d;
      color:#fff;
      border-color:#7f1d1d;
    }
  </style>
</head>

<body>

<div id="hm-shell-header"></div>

<main class="sales-wrap">
  <h1>Your Sales</h1>
  <p class="muted">Fabric buyers purchased from your listings.</p>

  <div id="sales"></div>
</main>

<div id="hm-shell-footer"></div>

<!-- Supabase CDN ONLY -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/hm-shell.js"></script>

<script>
  window.HM && window.HM.renderShell({ currentPage: "sales" });

  const supabase = window.supabase.createClient(
    "https://clkizksbvxjkoatdajgd.supabase.co",
    "YOUR_PUBLIC_ANON_KEY"
  );

  async function loadSales(){
    const { data: { user } } = await supabase.auth.getUser();
    if(!user) return;

    const { data, error } = await supabase
      .from("orders")
      .select(`
        id,
        created_at,
        buyer_email,
        items_cents,
        shipping_cents,
        status,
        listing:listings (
          id,
          title,
          image_url_1,
          yards_available
        )
      `)
      .eq("seller_id", user.id)
      .order("created_at", { ascending:false });

    if(error){
      console.error(error);
      document.getElementById("sales").textContent = "Error loading sales.";
      return;
    }

    const root = document.getElementById("sales");
    root.innerHTML = "";

    data.forEach(o=>{
      const card = document.createElement("div");
      card.className = "sale-card";

      const shipped = o.status === "shipped";

      card.innerHTML = `
        <div class="sale-thumb">
          ${o.listing?.image_url_1
            ? `<img src="${o.listing.image_url_1}">`
            : "Fabric"}
        </div>

        <div>
          <div class="sale-title">${o.listing?.title || "Listing"}</div>
          <div class="sale-meta">
            ${o.items_cents/100} for ${o.listing?.yards_available || ""} yards ·
            Sold ${new Date(o.created_at).toLocaleDateString()}
          </div>
          <div class="sale-meta">
            Buyer: ${o.buyer_email}
          </div>

          <div class="sale-actions">
            ${
              !shipped
                ? `<button class="btn-small btn-danger">Cancel</button>`
                : ""
            }
          </div>
        </div>

        <div class="sale-right">
          <div class="sale-total">$${(o.items_cents/100).toFixed(2)}</div>
          <div class="sale-meta">Shipping $${(o.shipping_cents/100).toFixed(2)}</div>
        </div>
      `;

      root.appendChild(card);
    });
  }

  loadSales();
</script>

</body>
</html>
