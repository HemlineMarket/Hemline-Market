<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Sales — Hemline Market</title>

  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">

  <!-- Shared styles (universal stack) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-text:#111827;
      --hm-muted:#6b7280;
      --hm-border:#e5e7eb;
      --hm-bg:#fafafa;
      --hm-bg-card:rgba(255,255,255,.96);
    }

    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    .sales-wrap{
      max-width:1100px;
      margin:18px auto 28px;
      padding:0 12px;
    }

    .page-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }

    .page-title{
      margin:0;
      font-size:28px;
      letter-spacing:-0.02em;
    }

    .page-sub{
      margin:6px 0 0;
      color:var(--hm-muted);
      font-size:13px;
    }

    .card{
      background:#fff;
      border:1px solid var(--hm-border);
      border-radius:12px;
      padding:12px;
    }

    .state{
      color:var(--hm-muted);
      font-size:13px;
      padding:14px;
      border:1px dashed #e5e7eb;
      border-radius:12px;
      background:#fff;
    }

    /* --- Sales list --- */
    .sales-list{
      display:grid;
      gap:10px;
      margin-top:10px;
    }

    .sale-row{
      background:var(--hm-bg-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      overflow:hidden;
      display:grid;
      grid-template-columns: 140px 1fr;
    }

    @media(max-width:700px){
      .sale-row{ grid-template-columns: 120px 1fr; }
    }

    /* left: mini listing link (browse-style thumbnail) */
    .mini-link{
      display:block;
      text-decoration:none;
      color:inherit;
      border-right:1px solid var(--hm-border);
      background:linear-gradient(180deg,#f8fafc,#eef2f7);
    }
    .mini-thumb{
      aspect-ratio:4/3;
      width:100%;
      overflow:hidden;
      display:grid;
      place-items:center;
    }
    .mini-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .mini-fallback{
      width:100%;
      height:100%;
      display:grid;
      place-items:center;
      color:#9ca3af;
      font-weight:800;
      font-size:28px;
      letter-spacing:-0.03em;
    }

    /* right: content */
    .sale-body{
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .sale-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .sale-title{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }

    .sale-title a{
      color:var(--hm-text);
      text-decoration:none;
      font-weight:800;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .meta-line{
      color:var(--hm-muted);
      font-size:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pill{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#fff;
      color:#374151;
      font-weight:700;
    }

    .amount{
      text-align:right;
      flex:0 0 auto;
      display:flex;
      flex-direction:column;
      gap:2px;
      align-items:flex-end;
    }

    .amount .big{
      font-weight:900;
      font-size:14px;
      color:#111827;
      white-space:nowrap;
    }
    .amount .small{
      color:var(--hm-muted);
      font-size:12px;
      white-space:nowrap;
    }

    .actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:4px;
    }

    select, button{
      font-family:inherit;
    }

    .reason{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--hm-border);
      background:#fff;
      font-size:13px;
      min-width:220px;
    }

    .btn{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
    }
    .btn.secondary{
      border-color:var(--hm-border);
      background:#fff;
      color:#111827;
      font-weight:800;
    }
    .btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
    }

    .note{
      color:var(--hm-muted);
      font-size:12px;
    }

    .toast{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#fff;
      color:#111827;
      font-size:13px;
      display:none;
    }
    .toast.ok{ border-color:#86efac; background:#f0fdf4; }
    .toast.err{ border-color:#fecaca; background:#fef2f2; }
  </style>
</head>

<body>
  <!-- UNIVERSAL HEADER (injected by hm-shell.js) -->
  <div id="hm-shell-header"></div>

  <main class="sales-wrap">
    <div class="page-head">
      <div>
        <h1 class="page-title">Your Sales</h1>
        <p class="page-sub">Fabric buyers purchased from your listings.</p>
      </div>
      <div id="signedInHint" class="note"></div>
    </div>

    <section class="card">
      <div id="state" class="state">Loading…</div>
      <div id="sales" class="sales-list" style="display:none"></div>
      <div id="toast" class="toast"></div>
    </section>
  </main>

  <!-- UNIVERSAL FOOTER (injected by hm-shell.js) -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Shared shell (universal header/footer + menu + header session) -->
  <script src="scripts/hm-shell.js"></script>

  <script>
    // Render shared header + footer
    window.HM && window.HM.renderShell({ currentPage: "sales" });
  </script>

  <script>
    // ===== Supabase client (CDN style, like browse.html) =====
    const supabaseClient = window.supabase.createClient(
      "https://clkizksbvxjkoatdajgd.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI"
    );

    // ===== Helpers =====
    function moneyFromCents(c){
      if(c == null) return null;
      const v = Number(c) / 100;
      return v.toLocaleString("en-US",{
        style:"currency",
        currency:"USD",
        minimumFractionDigits:2,
        maximumFractionDigits:2
      });
    }

    function fmtDate(d){
      try{
        const dt = new Date(d);
        return dt.toLocaleDateString("en-US",{ month:"short", day:"numeric", year:"numeric" });
      }catch(_){ return ""; }
    }

    // keep it readable + safer than full email everywhere
    function maskEmail(email){
      if(!email || typeof email !== "string") return "";
      const at = email.indexOf("@");
      if(at <= 1) return email;
      const name = email.slice(0, at);
      const domain = email.slice(at + 1);
      const head = name.slice(0, 2);
      return head + "•••@" + domain;
    }

    // Shipping policy (your doc): <3yd $5, 3–10yd $8, >10yd $14
    function shippingFromYards(yards){
      const y = Number(yards);
      if(!Number.isFinite(y) || y <= 0) return 0;
      if(y < 3) return 500;
      if(y <= 10) return 800;
      return 1400;
    }

    function getQtyFromSnapshot(snap){
      // supports either array or {items:[...]}
      try{
        const items = Array.isArray(snap) ? snap : (snap && snap.items ? snap.items : null);
        if(!items || !items.length) return null;
        const q = items[0]?.qty;
        const n = Number(q);
        return Number.isFinite(n) ? n : null;
      }catch(_){ return null; }
    }

    function getTitleFromSnapshot(snap){
      try{
        const items = Array.isArray(snap) ? snap : (snap && snap.items ? snap.items : null);
        if(!items || !items.length) return null;
        return items[0]?.title || null;
      }catch(_){ return null; }
    }

    function getImageFromSnapshot(snap){
      try{
        const items = Array.isArray(snap) ? snap : (snap && snap.items ? snap.items : null);
        if(!items || !items.length) return null;
        return items[0]?.image_url || items[0]?.photo || null;
      }catch(_){ return null; }
    }

    function setToast(type, msg){
      const t = document.getElementById("toast");
      if(!t) return;
      t.className = "toast " + (type || "");
      t.textContent = msg || "";
      t.style.display = msg ? "block" : "none";
    }

    // ===== Load + render =====
    async function loadSales(){
      const state = document.getElementById("state");
      const list  = document.getElementById("sales");
      const hint  = document.getElementById("signedInHint");

      setToast("", "");
      state.style.display = "block";
      list.style.display = "none";
      state.textContent = "Loading…";

      // Get signed-in user
      const { data: auth } = await supabaseClient.auth.getUser();
      const user = auth?.user;

      if(!user){
        state.textContent = "Sign in to view your sales.";
        if(hint) hint.textContent = "";
        return;
      }

      if(hint) hint.textContent = "Signed in";

      // Fetch sales for this seller
      const { data: orders, error } = await supabaseClient
        .from("orders")
        .select("id, created_at, status, seller_id, buyer_id, buyer_email, listing_id, listing_title, listing_image_url, listing_snapshot, items_cents, shipping_cents, total_cents")
        .eq("seller_id", user.id)
        .order("created_at", { ascending:false })
        .limit(50);

      if(error){
        console.error(error);
        state.textContent = "Error loading sales.";
        setToast("err", error.message || "Failed to load sales.");
        return;
      }

      const rows = orders || [];
      if(!rows.length){
        state.textContent = "You haven’t sold anything yet.";
        return;
      }

      // Render
      list.innerHTML = "";
      rows.forEach(o => {
        const listingHref = "listing.html?id=" + encodeURIComponent(o.listing_id || "");
        const snap = o.listing_snapshot;

        const qty = getQtyFromSnapshot(snap);
        const title = o.listing_title || getTitleFromSnapshot(snap) || "Listing";
        const img = o.listing_image_url || getImageFromSnapshot(snap) || "";

        const itemsCents = (o.items_cents != null) ? Number(o.items_cents)
                        : (o.total_cents != null) ? Number(o.total_cents)
                        : null;

        // If shipping_cents is missing/0, compute from qty so the seller sees what buyer paid in checkout
        const shippingCentsStored = (o.shipping_cents != null) ? Number(o.shipping_cents) : 0;
        const shippingCents = (shippingCentsStored && shippingCentsStored > 0)
          ? shippingCentsStored
          : shippingFromYards(qty);

        const totalCents = (o.total_cents != null)
          ? Number(o.total_cents)
          : ((itemsCents != null) ? (itemsCents + shippingCents) : null);

        const status = (o.status || "PAID").toUpperCase();
        const canCancel = (status === "PAID"); // keep simple for MVP

        const buyerDisplay = maskEmail(o.buyer_email || "");

        const row = document.createElement("div");
        row.className = "sale-row";
        row.innerHTML = `
          <a class="mini-link" href="${listingHref}" aria-label="View listing">
            <div class="mini-thumb">
              ${
                img
                  ? `<img src="${img}" alt="${title.replace(/"/g,"&quot;")}">`
                  : `<div class="mini-fallback">HM</div>`
              }
            </div>
          </a>

          <div class="sale-body">
            <div class="sale-top">
              <div class="sale-title">
                <a href="${listingHref}">${title}</a>
                <div class="meta-line">
                  <span class="pill">${status}</span>
                  ${qty != null ? `<span>${qty} yards</span>` : ""}
                  <span>Sold · ${fmtDate(o.created_at)}</span>
                  ${buyerDisplay ? `<span>Buyer: ${buyerDisplay}</span>` : ""}
                </div>
              </div>

              <div class="amount">
                <div class="big">
                  ${ (itemsCents != null && qty != null) ? `${moneyFromCents(itemsCents)} for ${qty} yards` : (itemsCents != null ? moneyFromCents(itemsCents) : "") }
                </div>
                <div class="small">
                  ${moneyFromCents(shippingCents)} shipping · ${totalCents != null ? moneyFromCents(totalCents) + " total" : ""}
                </div>
              </div>
            </div>

            <div class="actions">
              <button class="btn secondary" type="button" data-view="${listingHref}">View listing</button>

              <select class="reason" ${canCancel ? "" : "disabled"} data-reason>
                <option value="">Cancel reason…</option>
                <option value="out_of_stock">Out of stock / can’t fulfill</option>
                <option value="shipping_issue">Shipping issue / can’t ship on time</option>
                <option value="listing_error">Listing error</option>
                <option value="buyer_request">Buyer requested cancel</option>
                <option value="other">Other</option>
              </select>

              <button class="btn" type="button" ${canCancel ? "" : "disabled"} data-cancel>
                Cancel order
              </button>

              <span class="note" data-note></span>
            </div>
          </div>
        `;

        // Wire buttons
        row.querySelector('[data-view]').addEventListener("click", (e) => {
          e.preventDefault();
          window.location.href = listingHref;
        });

        const cancelBtn = row.querySelector("[data-cancel]");
        const reasonSel = row.querySelector("[data-reason]");
        const noteEl    = row.querySelector("[data-note]");

        async function doCancel(){
          setToast("", "");
          const reason = (reasonSel?.value || "").trim();
          if(!reason){
            setToast("err", "Pick a cancel reason first.");
            return;
          }

          cancelBtn.disabled = true;
          reasonSel.disabled = true;
          noteEl.textContent = "Cancelling…";

          // Try to update order status (RLS must allow seller update)
          const { error: upErr } = await supabaseClient
            .from("orders")
            .update({
              status: "CANCELED",
              cancel_reason: reason,
              canceled_at: new Date().toISOString()
            })
            .eq("id", o.id);

          if(upErr){
            console.error(upErr);
            setToast("err", upErr.message || "Cancel failed.");
            cancelBtn.disabled = false;
            reasonSel.disabled = false;
            noteEl.textContent = "";
            return;
          }

          setToast("ok", "Order canceled.");
          // refresh list
          await loadSales();
        }

        cancelBtn.addEventListener("click", doCancel);

        list.appendChild(row);
      });

      state.style.display = "none";
      list.style.display = "grid";
    }

    document.addEventListener("DOMContentLoaded", loadSales);
  </script>
</body>
</html>
