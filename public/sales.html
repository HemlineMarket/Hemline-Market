<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Sales â€” Hemline Market</title>

  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>

  <!-- Shared styles -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-text:#111827;
      --hm-muted:#6b7280;
      --hm-border:#e5e7eb;
      --hm-bg:#f4f4f7;
      --hm-card:rgba(255,255,255,.96);
    }
    html,body{
      margin:0;
      background:var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }
    .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
    .sale-card{
      background:var(--hm-card);
      border:1px solid var(--hm-border);
      border-radius:14px;
      display:grid;
      grid-template-columns:140px 1fr;
      overflow:hidden;
      margin-bottom:12px;
    }
    .thumb-link{
      display:block;
      background:#f1f5f9;
      border-right:1px solid var(--hm-border);
    }
    .thumb{width:100%;height:100%;object-fit:cover}
    .thumb-fallback{
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      color:#6b7280;
      font-size:12px;
    }
    .sale-body{padding:12px;display:flex;flex-direction:column;gap:6px}
    .toprow{display:flex;justify-content:space-between;gap:10px}
    .title{font-weight:800;font-size:14px;margin:0}
    .title a{color:inherit;text-decoration:none}
    .meta{font-size:12px;color:var(--hm-muted);display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      font-size:11px;font-weight:800;
      padding:2px 8px;border-radius:999px;
      border:1px solid var(--hm-border);background:#f3f4f6;
    }
    .pill.paid{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
    .rightmeta{text-align:right;font-size:12px}
    .rightmeta .big{font-weight:900;font-size:14px}
    .actions{display:flex;gap:10px;margin-top:6px}
    select,button{
      height:36px;border-radius:10px;font-size:13px
    }
    select{border:1px solid var(--hm-border);padding:0 10px}
    .btn-danger{
      background:var(--hm-accent);
      color:#fff;border:1px solid var(--hm-accent);
      padding:0 12px;font-weight:800
    }
    .error{
      background:#fff;border:1px solid #fecaca;
      padding:10px;border-radius:12px;color:#991b1b
    }
  </style>
</head>
<body>

<div id="hm-shell-header"></div>

<main class="wrap">
  <h1>Your Sales</h1>
  <p class="hm-muted">Fabric buyers purchased from your listings.</p>

  <div id="salesList"></div>
  <div id="err" class="error" style="display:none"></div>
</main>

<div id="hm-shell-footer"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/hm-shell.js"></script>
<script>
  window.HM && window.HM.renderShell({ currentPage:"sales" });
</script>

<script>
  const supabaseClient = window.supabase.createClient(
    "https://clkizksbvxjkoatdajgd.supabase.co",
    "YOUR_ANON_KEY"
  );

  const list = document.getElementById("salesList");
  const err  = document.getElementById("err");

  const money = c => "$" + (c/100).toFixed(2);

  function isShipped(o){
    return ["SHIPPED","DELIVERED","COMPLETED"].includes(
      String(o.status||"").toUpperCase()
    );
  }

  async function loadSales(){
    const { data:session } = await supabaseClient.auth.getSession();
    if(!session?.session?.user){
      err.style.display="block";
      err.textContent="You are not signed in.";
      return;
    }

    const { data, error } = await supabaseClient
      .from("orders")
      .select(`
        id, created_at, status,
        buyer_email,
        listing_id, listing_title,
        items_cents, shipping_cents, total_cents,
        listing_snapshot
      `)
      .eq("seller_id", session.session.user.id)
      .order("created_at",{ascending:false});

    if(error){
      err.style.display="block";
      err.textContent="Error loading sales.";
      console.error(error);
      return;
    }

    list.innerHTML="";

    data.forEach(o=>{
      const snap = o.listing_snapshot || {};
      const qty = snap?.items?.[0]?.qty ?? "";
      const img = snap.image_url || "";
      const shipped = isShipped(o);

      const card = document.createElement("article");
      card.className="sale-card";
      card.innerHTML = `
        <a class="thumb-link" href="listing.html?id=${o.listing_id}">
          ${img ? `<img class="thumb" src="${img}">`
          : `<div class="thumb-fallback">ðŸ“¦<div>${o.listing_title}</div></div>`}
        </a>
        <div class="sale-body">
          <div class="toprow">
            <div>
              <p class="title"><a href="listing.html?id=${o.listing_id}">${o.listing_title}</a></p>
              <div class="meta">
                <span class="pill paid">${o.status}</span>
                <span>${qty} yards</span>
                <span>Buyer: ${o.buyer_email}</span>
              </div>
            </div>
            <div class="rightmeta">
              <div class="big">${money(o.total_cents)} for ${qty} yards</div>
              <div>${money(o.shipping_cents)} shipping</div>
            </div>
          </div>

          ${(!shipped && o.status==="PAID") ? `
            <div class="actions">
              <select>
                <option value="">Cancel reasonâ€¦</option>
                <option>Out of stock</option>
                <option>Cannot ship in time</option>
                <option>Buyer requested cancel</option>
              </select>
              <button class="btn-danger">Cancel order</button>
            </div>
          ` : ``}
        </div>
      `;
      list.appendChild(card);
    });
  }

  loadSales();
</script>
</body>
</html>
