<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Sign In — Hemline Market</title>

  <!-- Shared site styles (match homepage) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --hm-border:#e5e7eb;
      --hm-accent:#991b1b;
      --ink:#111827;
      --muted:#6b7280;
    }

    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:#fafafa;
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    main img, main svg, main canvas, main video{
      max-width:100%;
      height:auto;
      display:block;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:0 12px;
    }

    /* Auth cards */
    .auth-container{
      max-width:420px;
      margin:40px auto;
      background:#fff;
      border:1px solid var(--hm-border);
      border-radius:12px;
      padding:24px;
      display:grid;
      gap:16px;
      box-shadow:0 10px 20px rgba(15,23,42,.06);
    }

    h1{
      margin:0 0 8px;
      text-align:center;
      font-size:22px;
    }

    .muted{
      text-align:center;
      color:var(--muted);
      margin:0;
      font-size:14px;
    }

    form{
      display:grid;
      gap:12px;
    }

    input{
      padding:12px;
      border:1px solid var(--hm-border);
      border-radius:8px;
      font:inherit;
    }

    button.primary{
      background:var(--hm-accent);
      color:#fff;
      border:none;
      border-radius:8px;
      padding:12px;
      font-weight:700;
      cursor:pointer;
    }

    button.primary:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    button.oauth{
      border:1px solid #d1d5db;
      border-radius:8px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:center;
      background:#fff;
      cursor:pointer;
      font:inherit;
    }

    button.oauth .icon{
      width:20px;
      height:20px;
      border-radius:999px;
      background:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }

    button.oauth .icon svg{
      width:18px;
      height:18px;
      display:block;
    }

    button.oauth .icon.apple{
      background:#000;
    }

    button.oauth .icon.apple svg{
      fill:#fff;
    }

    .divider{
      display:flex;
      align-items:center;
      gap:12px;
      color:#6b7280;
      font-size:14px;
    }

    .divider::before,
    .divider::after{
      content:"";
      flex:1;
      height:1px;
      background:#e5e7eb;
    }

    .links{
      text-align:center;
      display:grid;
      gap:6px;
      font-size:14px;
    }

    .links a{
      color:var(--hm-accent);
      text-decoration:none;
    }

    .links a:hover{
      text-decoration:underline;
    }

    .hidden{
      display:none;
    }

    .note{
      font-size:13px;
      color:#6b7280;
      text-align:center;
    }

    .password-requirements{
      font-size:13px;
      color:#6b7280;
      display:grid;
      gap:4px;
      padding:8px 0;
    }

    .pw-rule{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .pw-icon{
      font-size:12px;
      width:16px;
      text-align:center;
    }

    .pw-rule.valid{
      color:#059669;
    }

    .pw-rule.valid .pw-icon::before{
      content:"✓";
    }

    .pw-rule.invalid{
      color:#dc2626;
    }

    .pw-rule.invalid .pw-icon::before{
      content:"✗";
    }

    @media (max-width:640px){
      .auth-container{
        margin:24px 12px;
      }
      .wrap{
        padding:0 8px;
      }
    }
  </style>
</head>
<body>

  <!-- UNIVERSAL HEADER injected by hm-shell.js -->
  <div id="hm-shell-header"></div>

  <main class="wrap" role="main">
    <div class="auth-container" id="card-login">
      <h1>Sign in to your account</h1>
      <p class="muted">
        New to Hemline?
        <a href="#" id="link-signup">Create account</a>
      </p>

      <form id="login" action="javascript:void(0)" onsubmit="return false;" novalidate>
        <input type="email" id="li-email" placeholder="Email" required>
        <input type="password" id="li-pass" placeholder="Password" required>
        <button class="primary" type="submit">Log in</button>
      </form>

      <div class="divider">or</div>

      <button class="oauth" id="login-google" type="button">
        <span class="icon">
          <!-- Google "G" logo -->
          <svg viewBox="0 0 24 24">
            <path fill="#EA4335" d="M12 10.2v3.9h5.4A4.9 4.9 0 0 1 12 19.6 7.6 7.6 0 1 1 19.6 12v1.1H12z"/>
            <path fill="#FBBC05" d="M5.3 9.7A4.5 4.5 0 0 1 9.4 6.2c1.3 0 2.4.5 3.3 1.3l2.5-2.5A7.6 7.6 0 0 0 4.4 8.4z"/>
            <path fill="#34A853" d="M12 19.6a7.5 7.5 0 0 0 5.3-2.1L15 15.3A4.6 4.6 0 0 1 9.4 17a4.5 4.5 0 0 1-4.1-2.8l-2.5 1.9A7.6 7.6 0 0 0 12 19.6z"/>
            <path fill="#4285F4" d="M19.6 12c0-.5-.1-1-.2-1.5H12v3.6h5.4A4.7 4.7 0 0 0 19.6 12z"/>
          </svg>
        </span>
        <span>Continue with Google</span>
      </button>

      <button class="oauth" id="login-apple" type="button">
        <span class="icon apple">
          <!-- Apple logo -->
          <svg viewBox="0 0 24 24">
            <path d="M16.7 2c-.9.1-2 .6-2.6 1.3-.6.7-1.1 1.8-.9 2.8 1-.1 2.1-.6 2.8-1.3.6-.7 1.1-1.8.9-2.8zm2.2 6.1c-1.3-.1-2.4.7-3 0-.6-.7-1.1-1.1-1.8-1.1-.7 0-1.3.4-1.8 1.1-.8 1.1-1.2 3-0.3 4.5.4.7.9 1.5 1.6 1.5.6 0 .7-.4 1.6-.4.9 0 .9.4 1.6.4.7 0 1.1-.7 1.5-1.4.5-.7.7-1.4.7-1.4-.1-.1-1.4-.5-1.4-2.1 0-1.3 1.1-1.9 1.1-1.9-.7-1-1.8-1.1-2-1.1z"/>
          </svg>
        </span>
        <span>Continue with Apple</span>
      </button>

      <div class="links">
        <a href="#" id="link-forgot">Forgot password?</a>
        <a href="#" id="link-otp">Email me a sign-in code</a>
        <span class="muted" id="status">Checking session…</span>
        <a class="note hidden" id="goto-dash" href="index.html">
          You’re already signed in — go to homepage
        </a>
      </div>
    </div>

    <div class="auth-container hidden" id="card-signup">
      <h1>Create your account</h1>
      <p class="muted">Spin up your seller profile and start listing fabric finds.</p>
      <form id="signup" action="javascript:void(0)" onsubmit="return false;" novalidate>
        <input type="email" id="su-email" placeholder="Email" required>
        <input type="password" id="su-pass" placeholder="Password" required minlength="8">
        <div class="password-requirements" id="pw-requirements">
          <div class="pw-rule" id="pw-length">
            <span class="pw-icon">○</span> At least 8 characters
          </div>
          <div class="pw-rule" id="pw-letter">
            <span class="pw-icon">○</span> At least one letter (a-z)
          </div>
          <div class="pw-rule" id="pw-number">
            <span class="pw-icon">○</span> At least one number (0-9)
          </div>
        </div>
        <button class="primary" type="submit" id="signup-btn" disabled>Create account</button>
      </form>
      <p class="note">
        We'll send a confirmation email to verify your address.
      </p>
      <div class="links">
        <a href="#" id="back-from-signup">Back to sign in</a>
      </div>
    </div>

    <div class="auth-container hidden" id="card-forgot">
      <h1>Reset your password</h1>
      <p class="muted">We’ll send a secure reset link to your inbox.</p>
      <form id="reset">
        <input type="email" id="rp-email" placeholder="Email" required>
        <button class="primary" type="submit">Send reset link</button>
      </form>
      <div class="links">
        <a href="#" id="back-from-forgot">Back to sign in</a>
      </div>
    </div>

    <div class="auth-container hidden" id="card-otp">
      <h1>Email a sign-in code</h1>
      <p class="muted">Quick like a running stitch — no password needed.</p>
      <form id="otp">
        <input type="email" id="otp-email" placeholder="Email" required>
        <button class="primary" type="submit">Send code</button>
      </form>
      <div class="links">
        <a href="#" id="back-from-otp">Back to sign in</a>
      </div>
    </div>
  </main>

  <!-- UNIVERSAL FOOTER injected by hm-shell.js -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Shared shell: universal header/footer + menu + header session + HM.supabase -->
  <script src="scripts/hm-shell.js"></script>

  <script>
    // Render shared header + footer (also sets window.HM.supabase)
    window.HM && window.HM.renderShell({ currentPage: "auth" });

    // Use existing supabase client or create one (avoid redeclaration)
    var supabase = window.supabase_client || (window.HM && window.HM.supabase);
    if (!supabase) {
      supabase = window.supabase.createClient(
        "https://clkizksbvxjkoatdajgd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI"
      );
    }
    // Store globally to prevent duplicate clients
    window.supabase_client = supabase;

    // Session status (for the small note under the links)
    (async ()=>{
      const { data:{ session } } = await supabase.auth.getSession();
      const st = document.getElementById('status');
      const go = document.getElementById('goto-dash');
      if(!st || !go) return;

      if(session && session.user){
        st.textContent = `Logged in as ${session.user.email}`;
        go.classList.remove('hidden');
      } else {
        st.textContent = 'Not logged in.';
        go.classList.add('hidden');
      }
    })();

    // Card toggles
    const show = id => document.getElementById(id).classList.remove('hidden');
    const hide = id => document.getElementById(id).classList.add('hidden');

    document.getElementById('link-signup').onclick = (e)=>{
      e.preventDefault(); hide('card-login'); show('card-signup');
    };
    document.getElementById('back-from-signup').onclick = (e)=>{
      e.preventDefault(); hide('card-signup'); show('card-login');
    };
    document.getElementById('link-forgot').onclick = (e)=>{
      e.preventDefault(); hide('card-login'); show('card-forgot');
    };
    document.getElementById('back-from-forgot').onclick = (e)=>{
      e.preventDefault(); hide('card-forgot'); show('card-login');
    };
    document.getElementById('link-otp').onclick = (e)=>{
      e.preventDefault(); hide('card-login'); show('card-otp');
    };
    document.getElementById('back-from-otp').onclick = (e)=>{
      e.preventDefault(); hide('card-otp'); show('card-login');
    };

    function isStrongPassword(pw){
      if(!pw || pw.length < 8) return false;
      if(!/[A-Za-z]/.test(pw)) return false;
      if(!/[0-9]/.test(pw)) return false;
      return true;
    }

    // Real-time password validation
    const pwInput = document.getElementById('su-pass');
    const pwLength = document.getElementById('pw-length');
    const pwLetter = document.getElementById('pw-letter');
    const pwNumber = document.getElementById('pw-number');
    const signupBtn = document.getElementById('signup-btn');
    const suEmail = document.getElementById('su-email');

    function validatePassword() {
      const pw = pwInput.value;
      
      const hasLength = pw.length >= 8;
      const hasLetter = /[A-Za-z]/.test(pw);
      const hasNumber = /[0-9]/.test(pw);
      
      // Update visual indicators
      pwLength.className = 'pw-rule ' + (hasLength ? 'valid' : (pw.length > 0 ? 'invalid' : ''));
      pwLength.querySelector('.pw-icon').textContent = hasLength ? '' : (pw.length > 0 ? '' : '○');
      
      pwLetter.className = 'pw-rule ' + (hasLetter ? 'valid' : (pw.length > 0 ? 'invalid' : ''));
      pwLetter.querySelector('.pw-icon').textContent = hasLetter ? '' : (pw.length > 0 ? '' : '○');
      
      pwNumber.className = 'pw-rule ' + (hasNumber ? 'valid' : (pw.length > 0 ? 'invalid' : ''));
      pwNumber.querySelector('.pw-icon').textContent = hasNumber ? '' : (pw.length > 0 ? '' : '○');
      
      // Enable/disable signup button
      const emailValid = suEmail.value.includes('@');
      signupBtn.disabled = !(hasLength && hasLetter && hasNumber && emailValid);
    }

    pwInput.addEventListener('input', validatePassword);
    suEmail.addEventListener('input', validatePassword);

    // Email + Password login → go to homepage
    const loginForm = document.getElementById("login");
    
    // Prevent any default form submission
    loginForm.setAttribute("action", "javascript:void(0)");
    loginForm.setAttribute("onsubmit", "return false;");
    
    loginForm.addEventListener("submit", async function(e) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      const btn = this.querySelector('button[type="submit"]');
      const origText = btn.textContent;
      
      // Check if already processing
      if (btn.disabled) {
        console.log("[Auth] Login already in progress, ignoring duplicate submit");
        return false;
      }
      
      btn.disabled = true;
      btn.textContent = "Logging in...";
      
      const email = document.getElementById("li-email").value.trim();
      const password = document.getElementById("li-pass").value;
      
      console.log("[Auth] Attempting login for:", email);
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        
        console.log("[Auth] Response received", { hasSession: !!data?.session, error: error?.message });
        
        if (error) {
          console.error("[Auth] Login error:", error);
          alert(error.message || "Login failed. Please check your email and password.");
          btn.disabled = false;
          btn.textContent = origText;
          return false;
        }
        
        if (data && data.session) {
          console.log("[Auth] Login successful, redirecting...");
          // Use replace to prevent back button issues
          window.location.replace("index.html");
        } else {
          console.warn("[Auth] No session returned");
          alert("Login failed. Please try again.");
          btn.disabled = false;
          btn.textContent = origText;
        }
      } catch(err) {
        console.error("[Auth] Login exception:", err);
        alert("Login error: " + (err.message || "Please try again."));
        btn.disabled = false;
        btn.textContent = origText;
      }
      
      return false;
    }, { capture: true });

    // Sign up → create user + display_name (from email local-part), with password rules
    document.getElementById("signup").onsubmit = async (e)=>{
      e.preventDefault();
      const email = document.getElementById("su-email").value.trim();
      const password = document.getElementById("su-pass").value;

      if(!isStrongPassword(password)){
        alert("Password must be at least 8 characters and include at least one letter and one number.");
        return;
      }

      const local = email.split("@")[0] || "";
      const display_name = local || "Hemline sewist";

      const { error } = await supabase.auth.signUp({
        email,
        password,
        options:{ data:{ display_name } }
      });

      alert(error ? error.message : "Check your email to confirm.");
      hide('card-signup');
      show('card-login');
    };

    // Forgot password
    document.getElementById("reset").onsubmit = async (e)=>{
      e.preventDefault();
      const email = document.getElementById("rp-email").value.trim();
      const { error } = await supabase.auth.resetPasswordForEmail(email,{
        redirectTo: location.origin + "/auth.html"
      });
      alert(error ? error.message : "Reset link sent.");
      hide('card-forgot');
      show('card-login');
    };

    // OTP
    document.getElementById("otp").onsubmit = async (e)=>{
      e.preventDefault();
      const email = document.getElementById("otp-email").value.trim();
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options:{ emailRedirectTo: location.origin + "/auth.html" }
      });
      alert(error ? error.message : "Code sent!");
      hide('card-otp');
      show('card-login');
    };

    // OAuth → homepage
    document.getElementById("login-google").onclick = async ()=>{
      const { error } = await supabase.auth.signInWithOAuth({
        provider:"google",
        options:{ redirectTo: location.origin + "/index.html" }
      });
      if(error) alert(error.message);
    };

    document.getElementById("login-apple").onclick = async ()=>{
      const { error } = await supabase.auth.signInWithOAuth({
        provider:"apple",
        options:{ redirectTo: location.origin + "/index.html" }
      });
      if(error) alert(error.message);
    };
  </script>
</body>
</html>
