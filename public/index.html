<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hemline Market</title>

  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">

  <!-- Shared styles -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
      --hm-bg-card:rgba(255,255,255,.96);
    }

    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    img,svg,canvas,video{max-width:100%;height:auto;display:block}

    /* PAGE WRAP */
    main.hm-home{
      max-width:1200px;
      margin:18px auto 28px;
      padding:0 12px 24px;
    }

    /* HERO */
    .hero{
      background:rgba(255,255,255,.96);
      border-radius:18px;
      border:1px solid var(--hm-border);
      box-shadow:0 10px 30px rgba(15,23,42,.08);
      padding:16px 16px 14px;
      margin-bottom:16px;
    }
    .hero-header{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:8px 12px;
      margin-bottom:10px;
    }
    .hero-title{
      font-size:20px;
      font-weight:800;
      letter-spacing:.03em;
    }
    .hero-sub{
      font-size:13px;
      color:var(--hm-muted);
      margin:0;
    }
    .hero-search-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .hero-search-row select{
      padding:9px 10px;
      border-radius:999px;
      border:1px solid var(--hm-border);
      font-size:13px;
      background:#fff;
    }
    .hero-search-input{
      flex:1;
      min-width:0;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--hm-border);
      font-size:14px;
      background:#fff;
    }
    .hero-search-btn{
      padding:9px 14px;
      border-radius:999px;
      border:1px solid var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      white-space:nowrap;
    }

    /* HOW IT WORKS CARD */
    .how-card{
      margin-top:14px;
      background:#fff;
      border-radius:14px;
      border:1px solid var(--hm-border);
      padding:14px 16px;
      font-size:13px;
      color:#374151;
    }
    .how-title{
      margin:0 0 6px;
      font-size:14px;
      font-weight:700;
    }
    .how-card ul{
      margin:0 0 6px 18px;
      padding:0;
    }
    .how-card li{
      margin-bottom:2px;
    }
    .how-foot{
      font-size:12px;
      color:#6b7280;
    }

    /* SECTION HEADER */
    .section-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:18px 0 10px;
    }
    .section-header h2{
      margin:0;
      font-size:18px;
      font-weight:700;
    }
    .section-header span{
      font-size:12px;
      color:#6b7280;
    }

    /* NEW LISTINGS GRID */
    .home-listings-wrapper{
      background:transparent;
    }

    .home-listings-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
      align-items:stretch;
      grid-auto-rows:1fr;
    }
    @media(max-width:900px){
      .home-listings-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    @media(max-width:560px){
      .home-listings-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    @media(max-width:400px){
      .home-listings-grid{
        grid-template-columns:1fr;
      }
    }

    .home-empty{
      font-size:13px;
      color:#6b7280;
      padding:10px 2px;
    }

    /* LISTING CARDS (match Atelier/Browse small-card look) */
    .home-listings-grid .listing-card{
      background:var(--hm-bg-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:100%;
    }
    .home-listings-grid .listing-thumb-link{
      display:block;
      text-decoration:none;
      color:inherit;
    }
    .home-listings-grid .listing-thumb{
      aspect-ratio:1/1;
      background:linear-gradient(180deg,#f8fafc,#eef2f7);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .home-listings-grid .listing-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .home-listings-grid .listing-body{
      padding:8px 10px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:1;
    }
    .home-listings-grid .listing-title-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:6px;
    }
    .home-listings-grid .listing-title{
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-decoration:none;
      color:#111827;
    }
    .home-listings-grid .listing-dept{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#f3f4f6;
      color:#4b5563;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .home-listings-grid .listing-yards{
      font-size:12px;
      color:#4b5563;
    }
    .home-listings-grid .listing-cta-row{
      margin-top:4px;
    }
    .home-listings-grid .listing-add-btn{
      width:100%;
      border-radius:10px;
      border:1px solid var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      font-weight:700;
      font-size:13px;
      padding:8px 10px;
      cursor:pointer;
      white-space:nowrap;
    }
    .home-listings-grid .listing-add-btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    .home-listings-grid .listing-price-row{
      margin-top:6px;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      margin-top:auto; /* push prices/seller row toward bottom */
    }
    .home-listings-grid .listing-price-main{
      font-weight:700;
      color:#111827;
    }
    .home-listings-grid .listing-price-orig{
      text-decoration:line-through;
      color:#9ca3af;
    }
    .home-listings-grid .listing-seller-row{
      margin-top:4px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      color:#6b7280;
    }
    .home-listings-grid .listing-seller-name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>
</head>
<body>

  <!-- Universal header (hm-shell will inject) -->
  <div id="hm-shell-header"></div>

  <main class="hm-home" id="maincontent">
    <!-- HERO -->
    <section class="hero" aria-label="Search fabrics">
      <div class="hero-header">
        <div>
          <div class="hero-title">Find your next fabric creation</div>
          <p class="hero-sub">
            Buy &amp; sell your fabrics with prepaid, trackable shipping.
          </p>
        </div>
      </div>
      <div class="hero-search-row">
        <select aria-label="Browse type">
          <option>Listings</option>
          <option>Ateliers</option>
        </select>
        <input
          class="hero-search-input"
          type="search"
          placeholder="Search fabrics, shops, or styles…"
          onclick="window.location.href='browse.html'"
        />
        <button
          class="hero-search-btn"
          type="button"
          onclick="window.location.href='browse.html'"
        >
          Search
        </button>
      </div>

      <div class="how-card" aria-label="How Hemline Market works">
        <div class="how-title">How Hemline Market works</div>
        <ul>
          <li>Browse fabrics from independent sellers.</li>
          <li>List your own fabric.</li>
          <li>Secure checkout with prepaid labels.</li>
        </ul>
        <div class="how-foot">
          Sew more. Waste less. Create freely.
        </div>
      </div>
    </section>

    <!-- NEW LISTINGS -->
    <section class="home-listings-wrapper" aria-label="New listings">
      <div class="section-header">
        <h2>New Listings</h2>
        <span id="homeListingsCount">Loading…</span>
      </div>
      <div id="homeListingsGrid" class="home-listings-grid"></div>
      <div id="homeListingsEmpty" class="home-empty" style="display:none;">
        No listings yet. Once sellers start listing fabric, new cards will appear here.
      </div>
    </section>
  </main>

  <!-- Universal footer -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Shell (header/footer) -->
  <script src="scripts/hm-shell.js"></script>

  <script>
    // Render shared header + footer
    window.HM && window.HM.renderShell({ currentPage: "home" });
  </script>

  <script>
    // Supabase client for homepage listings
    const supabaseClient = window.supabase.createClient(
      "https://clkizksbvxjkoatdajgd.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI"
    );

    function moneyFromCents(c){
      if(c == null) return "";
      const v = Number(c) / 100;
      return v.toLocaleString("en-US",{
        style:"currency",
        currency:"USD",
        minimumFractionDigits:2,
        maximumFractionDigits:2
      });
    }

    function computeYards(row){
      const y1 = row.yards_available;
      const y2 = row.yardage;
      const raw = (y1 != null ? Number(y1) : (y2 != null ? Number(y2) : null));
      if(!Number.isFinite(raw) || raw <= 0) return null;
      return raw;
    }

    async function fetchProfilesForListings(listings){
      const map = {};
      const ids = Array.from(new Set(
        (listings || [])
          .map(l => l.seller_id)
          .filter(Boolean)
      ));
      if(!ids.length) return map;

      try{
        const { data, error } = await supabaseClient
          .from("profiles")
          .select("id, display_name, store_name, first_name, last_name")
          .in("id", ids);

        if(error){
          console.error("Profile fetch error", error);
          return map;
        }
        (data || []).forEach(p=>{
          map[p.id] = p;
        });
      }catch(e){
        console.error("Profile fetch exception", e);
      }
      return map;
    }

    async function loadHomeListings(){
      const grid  = document.getElementById("homeListingsGrid");
      const empty = document.getElementById("homeListingsEmpty");
      const count = document.getElementById("homeListingsCount");

      if(grid) grid.innerHTML = "";
      if(empty) empty.style.display = "none";
      if(count) count.textContent = "Loading…";

      let listings = [];
      try{
        const { data, error } = await supabaseClient
          .from("listings")
          .select("*")
          .eq("is_published", true)
          .order("created_at",{ ascending:false })
          .limit(12);

        if(error){
          console.error("Home listings error", error);
          if(count) count.textContent = "Error loading listings";
          return;
        }
        listings = (data || []).filter(l => (l.status || "active") === "active");
      }catch(e){
        console.error("Home listings exception", e);
        if(count) count.textContent = "Error loading listings";
        return;
      }

      const total = listings.length;
      if(count){
        count.textContent = total === 1 ? "1 listing" : total + " listings";
      }

      if(!total){
        if(empty) empty.style.display = "block";
        return;
      }

      const profileMap = await fetchProfilesForListings(listings);

      listings.forEach(item=>{
        const yards = computeYards(item);
        const priceCents = item.price_cents != null ? Number(item.price_cents) : null;
        const origPriceCents = item.orig_price_cents != null ? Number(item.orig_price_cents) : null;

        const perYdMoney = priceCents != null ? moneyFromCents(priceCents) : "";
        const origPerMoney = origPriceCents != null ? moneyFromCents(origPriceCents) : "";

        const totalCents = (priceCents != null && yards != null) ? priceCents * yards : null;
        const totalMoney = totalCents != null ? moneyFromCents(totalCents) : "";

        const status = (item.status || "active").toLowerCase();
        const isSold = status === "sold";
        const canBuy = !isSold && priceCents != null && yards != null && yards > 0;

        const card = document.createElement("article");
        card.className = "listing-card";

        const href = "listing.html?id=" + encodeURIComponent(item.id);
        const safeTitle = item.title || "Untitled listing";
        const safeAlt = safeTitle.replace(/"/g,"&quot;");

        const prof = profileMap[item.seller_id] || {};
        const displayName = (prof.first_name && prof.last_name)
          ? (prof.first_name + " " + prof.last_name)
          : (prof.display_name || "");
        const storeName = prof.store_name || displayName || "Hemline Market seller";

        card.innerHTML = `
          <a class="listing-thumb-link" href="${href}">
            <div class="listing-thumb" aria-hidden="true">
              ${item.image_url_1 ? `<img src="${item.image_url_1}" alt="${safeAlt}">` : ""}
            </div>
          </a>
          <div class="listing-body">
            <div class="listing-title-row">
              <a class="listing-title" href="${href}">${safeTitle}</a>
              ${item.dept ? `<span class="listing-dept">${item.dept}</span>` : ""}
            </div>
            ${yards != null ? `<div class="listing-yards">${yards} yards</div>` : ""}
            <div class="listing-cta-row">
              <button type="button" class="listing-add-btn add-to-cart">
                ${
                  canBuy && totalMoney && yards
                    ? `Add to Cart — ${totalMoney} for ${yards} yards`
                    : (isSold ? "Sold out" : "Add to Cart")
                }
              </button>
            </div>
            <div class="listing-price-row">
              ${
                perYdMoney
                  ? `<span class="listing-price-main">${perYdMoney}/yard</span>`
                  : `<span class="listing-price-main">Price coming soon</span>`
              }
              ${
                origPerMoney
                  ? `<span class="listing-price-orig">${origPerMoney}/yard</span>`
                  : ""
              }
            </div>
            <div class="listing-seller-row">
              <span class="listing-seller-name">${storeName}</span>
            </div>
          </div>
        `;

        const btn = card.querySelector(".listing-add-btn");
        if(btn){
          const perYdDollars = priceCents != null ? (priceCents / 100) : 0;
          const firstImg = item.image_url_1 || "";

          btn.dataset.id = item.id;
          btn.dataset.name = safeTitle;
          btn.dataset.amount = totalCents != null ? String(totalCents) : "0";
          btn.dataset.price = perYdDollars ? perYdDollars.toFixed(2) : "0";
          btn.dataset.yards = yards != null ? String(yards) : "0";
          btn.dataset.sellerId = item.seller_id || "";
          btn.dataset.sellerName = storeName;
          btn.dataset.photo = firstImg;

          if(!canBuy){
            btn.disabled = true;
            btn.textContent = isSold ? "Sold out" : "Unavailable";
          }
        }

        grid.appendChild(card);
      });
    }

    document.addEventListener("DOMContentLoaded", loadHomeListings);
  </script>

  <!-- Cart scripts -->
  <script src="scripts/cart.js"></script>
  <script src="scripts/cart-hooks.js"></script>
  <script src="assets/add-to-cart.js" defer></script>

</body>
</html>
