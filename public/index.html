<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hemline Market</title>

  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">

  <!-- Shared styles -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      /* Brand palette */
      --hm-accent:#991b1b;        /* Hemline Bordeaux */
      --hm-accent-soft:#fef3f2;   /* Soft blush */
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;

      --hm-eco:#246b4a;           /* Deep eco green (for future use) */
      --hm-eco-soft:#e4f5ec;
      --hm-sand:#fffbf7;          /* Warm sand card bg */

      --hm-bg-card:rgba(255,255,255,.96);
    }

    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* background photo */
    body{
      background:
        url("images/homepage.jpeg") center/cover fixed no-repeat,
        var(--hm-bg);
    }

    img,svg,canvas,video{max-width:100%;height:auto;display:block}

    /* PAGE WRAP */
    main.hm-home{
      max-width:1200px;
      margin:18px auto 28px;
      padding:0 12px 24px;
    }

    /* HERO */
    .hero{
      background:rgba(255,255,255,.96);
      border-radius:18px;
      border:1px solid var(--hm-border);
      box-shadow:0 10px 30px rgba(15,23,42,.08);
      padding:16px 16px 16px;
      margin-bottom:16px;
    }
    .hero-header{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px 12px;
      margin-bottom:10px;
    }
    .hero-slogan{
      font-size:22px;
      font-weight:800;
      color:var(--hm-text);
      margin:0;
      max-width:720px;
    }

    /* SOFTER SEARCH BAR */
    .hero-search-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
      padding:4px;
      border-radius:999px;
      border:1px solid #f3d6c9;
      background:var(--hm-accent-soft);
      box-shadow:0 3px 10px rgba(148,27,27,.05);
    }
    .hero-search-input-wrap{
      position:relative;
      flex:1;
      min-width:0;
    }
    .hero-search-icon{
      position:absolute;
      left:10px;
      top:50%;
      transform:translateY(-50%);
      font-size:14px;
      color:var(--hm-muted);
      pointer-events:none;
    }
    .hero-search-input{
      width:100%;
      padding:9px 12px 9px 30px;
      border-radius:999px;
      border:none;
      font-size:14px;
      background:transparent;
      color:var(--hm-text);
    }
    .hero-search-input::placeholder{
      color:#9ca3af;
    }
    .hero-search-input:focus{
      outline:none;
    }
    .hero-search-row:focus-within{
      box-shadow:0 0 0 2px rgba(153,27,27,.18);
    }
    .hero-search-btn{
      padding:9px 16px;
      border-radius:999px;
      border:none;
      background:var(--hm-accent);
      color:#fff;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 4px 12px rgba(153,27,27,.25);
    }
    .hero-search-btn:hover{
      filter:brightness(1.02);
    }

    /* HOW IT WORKS CARD */
    .how-card{
      margin-top:14px;
      background:#fff7f3; /* soft peach */
      border-radius:14px;
      border:1px solid #f2c9b4;
      padding:14px 16px;
      font-size:13px;
      color:#374151;
      box-shadow:0 6px 16px rgba(15,23,42,.03);
    }

    .how-text{
      min-width:0;
    }
    .how-title{
      margin:0 0 8px;
      font-size:15px;
      font-weight:700;
      color:var(--hm-accent);
    }
    .how-card ul{
      margin:0 0 6px 0;
      padding:0;
      list-style:none;
    }
    .how-card li{
      margin-bottom:4px;
      position:relative;
      padding-left:18px;
    }
    .how-card li::before{
      content:"‚úì";
      position:absolute;
      left:0;
      top:0;
      font-size:11px;
      color:var(--hm-accent);
    }

    /* ABOUT HEMLINE MARKET CARD */
    .about-card{
      margin-top:14px;
      background:var(--hm-sand); /* warm sand */
      border-radius:14px;
      border:1px solid #f3e2c8;
      padding:14px 16px 12px;
      font-size:13px;
      color:#374151;
      line-height:1.55;
      box-shadow:0 6px 16px rgba(15,23,42,.03);
    }
    .about-card-inner{
      max-width:100%;
    }
    .about-title{
      margin:0 0 8px;
      font-size:15px;
      font-weight:700;
      color:var(--hm-accent);
    }
    .about-card p{
      margin:0 0 8px;
    }
    .about-card p strong{
      font-weight:600;
    }
    .about-card p:last-child{
      margin-bottom:0;
      font-weight:600;
    }

    .about-link{
      color:var(--hm-accent);
      font-weight:600;
      text-decoration:none;
    }
    .about-link:hover{
      text-decoration:underline;
    }

    .about-cta-row{
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid #f3e2c8;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      font-size:13px;
    }
    .about-cta-copy{
      color:#4b5563;
      font-size:13px;
      font-weight:500;
    }
    .about-cta-btn{
      text-decoration:none;
      font-size:13px;
      font-weight:600;
      padding:7px 14px;
      border-radius:999px;
      background:#fff;
      color:var(--hm-accent);
      border:1px solid var(--hm-accent);
      transition:all .15s;
    }
    .about-cta-btn:hover{
      background:var(--hm-accent);
      color:#fff;
    }

    /* Trust badges */
    .trust-badges{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:12px 0 6px;
    }
    .trust-badge{
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:8px;
      font-size:12px;
      font-weight:500;
      color:#374151;
    }
    .trust-icon{
      font-size:14px;
    }

    @media(max-width:640px){
      .about-cta-row{
        flex-direction:column;
        align-items:flex-start;
      }
    }

    /* THREADTALK PROMO ‚Äì burgundy */
    .threadtalk-promo{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(153,27,27,.45);
      background:linear-gradient(120deg,#3b1010,#991b1b);
      color:#fef9f5;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:10px 14px;
    }
    .tt-promo-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .tt-promo-eyebrow{
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      opacity:.9;
    }
    .tt-promo-title{
      font-size:16px;
      font-weight:700;
      white-space:nowrap;
    }
    .tt-promo-sub{
      font-size:13px;
      opacity:.95;
      margin:0;
    }

    .tt-promo-tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .tt-promo-tag{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(254,249,195,.25);
      background:rgba(15,23,42,.16);
      color:#fefce8;
      text-decoration:none;
      white-space:nowrap;
    }
    .tt-promo-tag:hover{
      background:rgba(15,23,42,.26);
    }

    .tt-promo-link{
      flex:0 0 auto;
      text-decoration:none;
      font-size:15px;
      font-weight:700;
      padding:10px 26px;
      border-radius:999px;
      border:1px solid #fef3c7;
      background:#fef3c7;
      color:#7f1d1d;
      white-space:nowrap;
      box-shadow:0 8px 18px rgba(15,23,42,.24);
    }
    .tt-promo-link:hover{
      background:#fde68a;
      border-color:#fde68a;
    }

    @media(max-width:640px){
      .threadtalk-promo{
        align-items:flex-start;
      }
      .tt-promo-main{
        width:100%;
      }
      .tt-promo-title{
        white-space:normal;
      }
      .tt-promo-tags{
        width:100%;
        margin-top:6px;
        display:grid;
        grid-template-columns:repeat(4,minmax(0,1fr));
        row-gap:4px;
        column-gap:4px;
      }
      .tt-promo-tag{
        font-size:10px;
        padding:3px 4px;
        text-align:center;
        white-space:normal;
      }
      .tt-promo-link{
        width:100%;
        text-align:center;
        justify-content:center;
        margin-top:10px;
      }
    }

    /* SECTION HEADER */
    .section-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:18px 0 10px;
    }
    .section-header h2{
      margin:0;
      font-size:18px;
      font-weight:700;
    }
    .section-header span{
      font-size:12px;
      color:#6b7280;
    }

    /* NEW LISTINGS GRID */
    .home-listings-wrapper{
      background:transparent;
    }

    .home-listings-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
      align-items:stretch;
      grid-auto-rows:1fr;
    }
    @media(max-width:900px){
      .home-listings-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    @media(max-width:560px){
      .home-listings-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    @media(max-width:400px){
      .home-listings-grid{
        grid-template-columns:1fr;
      }
    }

    .home-empty{
      font-size:13px;
      color:#6b7280;
      padding:10px 2px;
    }

    /* LISTING CARDS */
    .home-listings-grid .listing-card{
      background:var(--hm-bg-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:100%;
    }
    .home-listings-grid .listing-thumb-link{
      display:block;
      text-decoration:none;
      color:inherit;
    }
    .home-listings-grid .listing-thumb{
      aspect-ratio:1/1;
      background:linear-gradient(180deg,#f8fafc,#eef2f7);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .home-listings-grid .listing-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .home-listings-grid .listing-body{
      padding:8px 10px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:1;
    }
    .home-listings-grid .listing-title-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:6px;
    }
    .home-listings-grid .listing-title{
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-decoration:none;
      color:#111827;
    }
    .home-listings-grid .listing-dept{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#f3f4f6;
      color:#4b5563;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .home-listings-grid .listing-yards{
      font-size:12px;
      color:#4b5563;
    }
    .home-listings-grid .listing-cta-row{
      margin-top:4px;
    }
    .home-listings-grid .listing-add-btn{
      width:100%;
      border-radius:10px;
      border:1px solid var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      font-weight:700;
      font-size:13px;
      padding:8px 10px;
      cursor:pointer;
      white-space:nowrap;
    }
    .home-listings-grid .listing-add-btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    .home-listings-grid .listing-price-row{
      margin-top:6px;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      margin-top:auto;
    }
    .home-listings-grid .listing-price-main{
      font-weight:700;
      color:#111827;
    }
    .home-listings-grid .listing-price-orig{
      text-decoration:line-through;
      color:#9ca3af;
    }
    .home-listings-grid .listing-seller-row{
      margin-top:4px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      color:#6b7280;
    }
    .home-listings-grid .listing-seller-name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>
</head>
<body>

  <div id="hm-shell-header"></div>

  <main class="hm-home" id="maincontent">
    <section class="hero" aria-label="Search fabrics">
      <div class="hero-header">
        <div>
          <div class="hero-slogan">
            Welcome to Hemline Market, where sewing meets sustainability.
          </div>
        </div>
      </div>

      <div class="how-card" aria-label="How Hemline Market works">
        <div class="how-text">
          <div class="how-title">How Hemline Market works</div>
          <ul>
            <li>Browse fabrics from independent sellers.</li>
            <li>List your own fabric and reach fellow sewists.</li>
            <li>Prepaid shipping labels are emailed to sellers automatically.</li>
            <li>Secure payments through Stripe protect both buyers and sellers.</li>
          </ul>
        </div>
      </div>

      <form id="homeSearchForm" class="hero-search-row" role="search">
        <div class="hero-search-input-wrap">
          <span class="hero-search-icon" aria-hidden="true">üîç</span>
          <input
            id="homeSearchInput"
            class="hero-search-input"
            type="search"
            placeholder="Search fabrics by color, content, type, weight, yards, price, and more!"
          />
        </div>
        <button class="hero-search-btn" type="submit">
          Search
        </button>
      </form>

      <div class="about-card" aria-label="About Hemline Market">
        <div class="about-card-inner">
          <h2 class="about-title">About Hemline Market</h2>
          <p>
            <strong>Hemline Market was created for sewists who care about slow fashion, sustainability, and sharing the fabrics we love.</strong>
            Whether it's quilting cotton, silk charmeuse, or wool gabardine, passing materials along helps reduce waste and spark creativity.
          </p>
          <p>
            Think of Hemline Market as similar to eBay or Poshmark, but for sewists, with prepaid shipping labels, secure Stripe payments, and built-in purchase protection.
          </p>
          <p>
            <a href="ThreadTalk.html" class="about-link">ThreadTalk</a>, our sewing forum, is a place to connect, share ideas, and grow together as makers.
          </p>
          <p>
            <strong>The first 300 verified sellers will lock in reduced selling fees for life.</strong>
          </p>

          <div class="trust-badges">
            <div class="trust-badge">
              <span class="trust-icon">üîí</span>
              <span>Secure Stripe payments</span>
            </div>
            <div class="trust-badge">
              <span class="trust-icon">üì¶</span>
              <span>Prepaid shipping labels</span>
            </div>
            <div class="trust-badge">
              <span class="trust-icon">‚úÖ</span>
              <span>Buyer & seller protection</span>
            </div>
          </div>

          <div class="about-cta-row">
            <span class="about-cta-copy">
              Find your next fabric creation, or help someone else start theirs.
            </span>
            <a class="about-cta-btn" href="account.html">
              Create a free account
            </a>
          </div>
        </div>
      </div>

      <div class="threadtalk-promo" aria-label="ThreadTalk community">
        <div class="tt-promo-main">
          <div class="tt-promo-eyebrow">NEW ¬∑ COMMUNITY</div>
          <div class="tt-promo-title">ThreadTalk: Hemline Market‚Äôs sewing forum</div>
          <p class="tt-promo-sub">
            Ask for fabric advice, share works in progress, and get feedback from other sewists.
          </p>
          <div class="tt-promo-tags">
            <a class="tt-promo-tag" href="/showcase.html">Showcase</a>
            <a class="tt-promo-tag" href="/tailoring.html">Tailoring</a>
            <a class="tt-promo-tag" href="/stitch-school.html">Stitch School</a>
            <a class="tt-promo-tag" href="/fabric-sos.html">Fabric SOS</a>
            <a class="tt-promo-tag" href="/before-after.html">Before &amp; After</a>
            <a class="tt-promo-tag" href="/pattern-hacks.html">Pattern Hacks</a>
            <a class="tt-promo-tag" href="/stash-confessions.html">Stash Confessions</a>
            <a class="tt-promo-tag" href="/loose-threads.html">Loose Threads</a>
          </div>
        </div>
        <a class="tt-promo-link" href="ThreadTalk.html">Open ThreadTalk</a>
      </div>
    </section>

    <section class="home-listings-wrapper" aria-label="New listings">
      <div class="section-header">
        <h2>New Listings</h2>
        <span id="homeListingsCount">Loading‚Ä¶</span>
      </div>
      <div id="homeListingsGrid" class="home-listings-grid"></div>
      <div id="homeListingsEmpty" class="home-empty" style="display:none;">
        No listings yet. Once sellers start listing fabric, new cards will appear here.
      </div>
    </section>
  </main>

  <div id="hm-shell-footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="scripts/hm-shell.js"></script>

  <script>
    window.HM && window.HM.renderShell({ currentPage: "home" });
  </script>

  <script>
    const HM = window.HM || {};
    const supabaseClient = HM.supabase;

    if (!supabaseClient) {
      console.warn("[Home] Supabase client not found on window.HM.supabase; listings disabled for now.");
    }

    function moneyFromCents(c){
      if(c == null) return "";
      const v = Number(c) / 100;
      return v.toLocaleString("en-US",{
        style:"currency",
        currency:"USD",
        minimumFractionDigits:2,
        maximumFractionDigits:2
      });
    }

    function computeYards(row){
      const y1 = row.yards_available;
      const y2 = row.yardage;
      const raw = (y1 != null ? Number(y1) : (y2 != null ? Number(y2) : null));
      if(!Number.isFinite(raw) || raw <= 0) return null;
      return raw;
    }

    async function fetchProfilesForListings(listings){
      const map = {};
      const ids = Array.from(new Set(
        (listings || [])
          .map(l => l.seller_id)
          .filter(Boolean)
      ));
      if(!ids.length) return map;

      try{
        const { data, error } = await supabaseClient
          .from("profiles")
          .select("id, display_name, store_name, first_name, last_name")
          .in("id", ids);

        if(error){
          console.error("Profile fetch error", error);
          return map;
        }
        (data || []).forEach(p=>{
          map[p.id] = p;
        });
      }catch(e){
        console.error("Profile fetch exception", e);
      }
      return map;
    }

    async function loadHomeListings(){
      const grid  = document.getElementById("homeListingsGrid");
      const empty = document.getElementById("homeListingsEmpty");
      const count = document.getElementById("homeListingsCount");

      if(grid) grid.innerHTML = "";
      if(empty) empty.style.display = "none";
      if(count) count.textContent = "Loading‚Ä¶";

      if (!supabaseClient) {
        if (count) count.textContent = "Listings coming soon";
        return;
      }

      let listings = [];
      try{
        // Fetch all listings, filter client-side (same approach as atelier.html)
        const { data, error } = await supabaseClient
          .from("listings")
          .select("*")
          .order("published_at", { ascending:false, nullsFirst: false })
          .limit(50);

        if(error){
          console.error("Home listings error", error);
          if(count) count.textContent = "Error loading listings";
          return;
        }
        
        const now = new Date();
        // Client-side filtering: is_published true, status active, published_at in past or null
        listings = (data || []).filter(l => {
          if(l.is_published !== true) return false;
          const status = (l.status || "active").toLowerCase();
          if(status !== "active") return false;
          if(l.published_at && new Date(l.published_at) > now) return false;
          return true;
        }).slice(0, 12); // Limit to 12 for homepage
      }catch(e){
        console.error("Home listings exception", e);
        if(count) count.textContent = "Error loading listings";
        return;
      }

      const total = listings.length;
      if(count){
        count.textContent = total === 1 ? "1 listing" : total + " listings";
      }

      if(!total){
        if(empty) empty.style.display = "block";
        return;
      }

      const profileMap = await fetchProfilesForListings(listings);

      listings.forEach(item=>{
        const yards = computeYards(item);
        const priceCents = item.price_cents != null ? Number(item.price_cents) : null;
        const origPriceCents = item.orig_price_cents != null ? Number(item.orig_price_cents) : null;

        const perYdMoney = priceCents != null ? moneyFromCents(priceCents) : "";
        const origPerMoney = origPriceCents != null ? moneyFromCents(origPriceCents) : "";

        const totalCents = (priceCents != null && yards != null) ? priceCents * yards : null;
        const totalMoney = totalCents != null ? moneyFromCents(totalCents) : "";

        const status = (item.status || "active").toLowerCase();
        const isSold = status === "sold";
        const canBuy = !isSold && priceCents != null && yards != null && yards > 0;

        const card = document.createElement("article");
        card.className = "listing-card";

        const href = "listing.html?id=" + encodeURIComponent(item.id);
        const safeTitle = item.title || "Untitled listing";
        const safeAlt = safeTitle.replace(/"/g,"&quot;");

        const prof = profileMap[item.seller_id] || {};
        const displayName = (prof.first_name && prof.last_name)
          ? (prof.first_name + " " + prof.last_name)
          : (prof.display_name || "");
        const storeName = prof.storeName || prof.store_name || displayName || "Hemline Market seller";

        card.innerHTML = `
          <a class="listing-thumb-link" href="${href}">
            <div class="listing-thumb" aria-hidden="true">
              ${item.image_url_1 ? `<img src="${item.image_url_1}" alt="${safeAlt}">` : ""}
            </div>
          </a>
          <div class="listing-body">
            <div class="listing-title-row">
              <a class="listing-title" href="${href}">${safeTitle}</a>
              ${item.dept ? `<span class="listing-dept">${item.dept}</span>` : ""}
            </div>
            ${yards != null ? `<div class="listing-yards">${yards} yards</div>` : ""}
            <div class="listing-cta-row">
              <button
                type="button"
                class="listing-add-btn add-to-cart"
                data-add-to-cart="1"
                data-listing-id="${String(item.id)}"
                data-name="${String(safeTitle).replace(/"/g,'&quot;')}"
                data-photo="${String(item.image_url_1 || "")}"
                data-yards="${yards != null ? String(yards) : "0"}"
                data-price="${priceCents != null ? (priceCents/100).toFixed(2) : "0"}"
                data-amount="${totalCents != null ? String(totalCents) : "0"}"
                data-seller-id="${String(item.seller_id || "")}"
                data-seller-name="${String(storeName).replace(/"/g,'&quot;')}"
              >
                ${
                  canBuy && totalMoney && yards
                    ? `Add to Cart ‚Äî ${totalMoney} for ${yards} yards`
                    : (isSold ? "Sold out" : "Add to Cart")
                }
              </button>
            </div>
            <div class="listing-price-row">
              ${
                perYdMoney
                  ? `<span class="listing-price-main">${perYdMoney}/yard</span>`
                  : `<span class="listing-price-main">Price coming soon</span>`
              }
              ${
                origPerMoney
                  ? `<span class="listing-price-orig">${origPerMoney}/yard</span>`
                  : ""
              }
            </div>
            <div class="listing-seller-row">
              <span class="listing-seller-name">${storeName}</span>
            </div>
          </div>
        `;

        const btn = card.querySelector(".listing-add-btn");
        if(btn){
          if(!canBuy){
            btn.disabled = true;
            btn.textContent = isSold ? "Sold out" : "Unavailable";
          }
        }

        grid.appendChild(card);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("homeSearchForm");
      const input = document.getElementById("homeSearchInput");

      if(form && input){
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const q = input.value.trim();

          const params = new URLSearchParams();
          if(q) params.set("q", q);

          const qs = params.toString();
          const url = "browse.html" + (qs ? "?" + qs : "");
          window.location.href = url;
        });
      }

      loadHomeListings();
    });
  </script>

  <script src="scripts/cart.js"></script>
  <script src="scripts/cart-hooks.js"></script>
  <script src="assets/add-to-cart.js" defer></script>

  <script>
    // Index-only: make Add to Cart work even for dynamically created cards
    (function(){
      function toNum(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }

      function addToCartFromDataset(ds){
        // supports both dataset variants: data-* OR your older btn.dataset.*
        const id = ds.listingId || ds.id || "";
        if(!id) return false;

        const yards = toNum(ds.yards);
        const price = toNum(ds.price); // dollars per yard
        const amount = toNum(ds.amount); // total cents if provided

        const item = {
          id: String(id),
          name: ds.name || "Listing",
          photo: ds.photo || "",
          yards: yards,
          qty: yards || 1,
          price: price || 0,
          amount: amount || 0,
          sellerId: ds.sellerId || "",
          sellerName: ds.sellerName || ""
        };

        // Try common cart APIs; fall back to localStorage
        try{
          if(window.HM && typeof window.HM.addToCart === "function"){
            window.HM.addToCart(item);
            return true;
          }
        }catch(e){}

        try{
          if(window.Cart && typeof window.Cart.add === "function"){
            window.Cart.add(item);
            return true;
          }
        }catch(e){}

        try{
          const key = "hm_cart";
          const existing = JSON.parse(localStorage.getItem(key) || "[]");
          const arr = Array.isArray(existing) ? existing : [];
          arr.push(item);
          localStorage.setItem(key, JSON.stringify(arr));
          window.dispatchEvent(new CustomEvent("hm:cart-updated", { detail: { source: "index" } }));
          return true;
        }catch(e){
          console.error("[index] cart fallback failed", e);
          return false;
        }
      }

      document.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-add-to-cart], .add-to-cart, .listing-add-btn");
        if(!btn) return;

        // Only handle buttons on index that represent add-to-cart
        const isAdd = btn.matches("[data-add-to-cart]") || btn.classList.contains("add-to-cart") || btn.classList.contains("listing-add-btn");
        if(!isAdd) return;

        // Prevent any link/button default that might interfere
        e.preventDefault();
        e.stopPropagation();

        // If disabled, do nothing
        if(btn.disabled) return;

        const ok = addToCartFromDataset(btn.dataset || {});
        if(ok){
          const old = btn.textContent;
          btn.textContent = "Added ‚úì";
          btn.disabled = true;
          setTimeout(() => {
            btn.disabled = false;
            btn.textContent = old;
          }, 900);
        } else {
          alert("Could not add to cart. Please refresh and try again.");
        }
      }, true);
    })();
  </script>

</body>
</html>
