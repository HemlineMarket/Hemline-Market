// Supabase Edge Function: onboard
// Handles Stripe Connect onboarding for individual seller accounts
//
// This creates individual (not business) Stripe Express accounts and
// generates login links for existing accounts.
//
// Deploy with: supabase functions deploy onboard

import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import Stripe from "https://esm.sh/stripe@14.5.0";

const stripe = new Stripe(Deno.env.get("STRIPE_SECRET_KEY") || "", {
  apiVersion: "2024-06-20",
  httpClient: Stripe.createFetchHttpClient(),
});

const supabaseUrl = Deno.env.get("SUPABASE_URL") || "";
const supabaseServiceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") || "";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
};

serve(async (req: Request) => {
  // Handle CORS preflight
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  if (req.method !== "POST") {
    return new Response(
      JSON.stringify({ error: "Method Not Allowed" }),
      { status: 405, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }

  try {
    // Get the authorization header
    const authHeader = req.headers.get("Authorization");
    if (!authHeader || !authHeader.startsWith("Bearer ")) {
      return new Response(
        JSON.stringify({ error: "Unauthorized", message: "Please sign in to set up payments" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const token = authHeader.replace("Bearer ", "");

    // Create Supabase client with service role for admin operations
    const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {
      auth: { persistSession: false },
    });

    // Verify the user's JWT
    const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);

    if (authError || !user) {
      return new Response(
        JSON.stringify({ error: "Invalid session", message: "Please sign in again" }),
        { status: 401, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    const userId = user.id;
    const userEmail = user.email || "";

    // Parse request body (optional - for return URLs)
    let body: { return_url?: string; refresh_url?: string } = {};
    try {
      const text = await req.text();
      if (text) {
        body = JSON.parse(text);
      }
    } catch {
      // Ignore parse errors, use defaults
    }

    const origin = req.headers.get("origin") || "https://hemlinemarket.com";
    const returnUrl = body.return_url || `${origin}/account.html`;
    const refreshUrl = body.refresh_url || `${origin}/account.html`;

    // Check if user already has a Stripe account
    const { data: profile } = await supabaseAdmin
      .from("profiles")
      .select("stripe_account_id")
      .eq("id", userId)
      .maybeSingle();

    // If user already has a Stripe account, create a login link to their dashboard
    if (profile?.stripe_account_id) {
      try {
        // Create a login link to the user's INDIVIDUAL Stripe Express dashboard
        const loginLink = await stripe.accounts.createLoginLink(
          profile.stripe_account_id,
          {
            redirect_url: returnUrl,
          }
        );

        return new Response(
          JSON.stringify({
            url: loginLink.url,
            accountId: profile.stripe_account_id,
            existing: true,
          }),
          { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      } catch (loginErr) {
        // Login link failed - account might need re-onboarding
        console.log("Login link failed, creating new onboarding link:", loginErr);
        
        // Try to create a new account link for the existing account
        try {
          const accountLink = await stripe.accountLinks.create({
            account: profile.stripe_account_id,
            type: "account_onboarding",
            return_url: returnUrl,
            refresh_url: refreshUrl,
          });

          return new Response(
            JSON.stringify({
              url: accountLink.url,
              accountId: profile.stripe_account_id,
              existing: true,
              needsOnboarding: true,
            }),
            { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
          );
        } catch (accountLinkErr) {
          console.error("Account link also failed:", accountLinkErr);
          // Fall through to create a new account
        }
      }
    }

    // Create a NEW Stripe Express account for the user
    // IMPORTANT: business_type is 'individual' - NOT 'company'
    const account = await stripe.accounts.create({
      type: "express",
      country: "US",
      business_type: "individual",  // <-- THIS IS THE KEY FIX
      email: userEmail,
      capabilities: {
        card_payments: { requested: true },
        transfers: { requested: true },
      },
      metadata: {
        hemline_user_id: userId,
      },
    });

    // Save the Stripe account ID to the user's profile
    const { error: updateError } = await supabaseAdmin
      .from("profiles")
      .update({ stripe_account_id: account.id })
      .eq("id", userId);

    if (updateError) {
      console.error("Failed to save Stripe account ID:", updateError);
      // Continue anyway - the account was created successfully
    }

    // Create an account link for onboarding
    const accountLink = await stripe.accountLinks.create({
      account: account.id,
      type: "account_onboarding",
      return_url: returnUrl,
      refresh_url: refreshUrl,
    });

    return new Response(
      JSON.stringify({
        url: accountLink.url,
        accountId: account.id,
        existing: false,
      }),
      { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );

  } catch (err) {
    console.error("Stripe Connect error:", err);
    return new Response(
      JSON.stringify({
        error: "Setup failed",
        message: err instanceof Error ? err.message : "Could not set up payment account",
      }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
