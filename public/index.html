<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hemline Market â€” Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Single-file HOME (root:/index.html). No external assets required. -->
  <style>
    :root{
      /* Core tokens (match across pages) */
      --bg: #ffffff;
      --ink: #1f2937;
      --muted: #6b7280;
      --brand: #0f766e;
      --chip: #f3f4f6;
      --chip-ink: #111827;
      --chip-on: #0f766e;
      --chip-on-ink:#ffffff;
      --rail: #f9fafb;
      --card:#ffffff;
      --ring:#0ea5b7;
      --border:#e5e7eb;

      /* Color chips (keep identical on Browse) */
      --c-white:#ffffff; --c-ivory:#fffff0; --c-beige:#d6c7b4; --c-camel:#b6895a; --c-tan:#c8a27a;
      --c-yellow:#f5d565; --c-orange:#f6a66a; --c-rust:#b54d2e; --c-red:#cc4b4b; --c-burgundy:#6b2b3d;
      --c-pink:#f3a7b6; --c-blush:#f2c7c2; --c-lilac:#b699d6; --c-purple:#6b4fa6; --c-blue:#3b82f6;
      --c-navy:#1f2a44; --c-teal:#0d9488; --c-green:#22c55e; --c-olive:#6b8f3d; --c-brown:#5b3c25;
      --c-grey:#9ca3af; --c-charcoal:#374151; --c-black:#111111;

      /* Layout */
      --max: 1200px;
      --radius: 14px;
      --pad: 16px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      display:flex; min-height:100vh; flex-direction:column;
    }
    a{color:inherit; text-decoration:none}
    button{font:inherit}

    /* Header */
    header{
      position:sticky; top:0; z-index:40;
      backdrop-filter:saturate(1.2) blur(6px);
      background:color-mix(in oklab, var(--bg) 85%, #ffffff 15%);
      border-bottom:1px solid var(--border);
    }
    .bar{max-width:var(--max); margin:0 auto; padding:10px var(--pad); display:flex; gap:10px; align-items:center}
    .logo{font-weight:700; letter-spacing:.3px}
    .grow{flex:1}
    .search{
      display:flex; align-items:center; gap:8px; background:var(--rail);
      padding:10px 12px; border-radius:999px; border:1px solid var(--border);
    }
    .search input{
      appearance:none; border:0; outline:0; background:transparent; width:100%;
    }
    .iconbtn{
      display:inline-flex; align-items:center; justify-content:center;
      width:38px; height:38px; border-radius:999px; border:1px solid var(--border); background:var(--card);
    }
    .iconbtn[aria-pressed="true"]{ background:var(--brand); border-color:var(--brand)}
    .iconbtn[aria-pressed="true"] svg{ fill:#fff; stroke:#fff }

    nav a{
      padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:var(--card);
      display:inline-block;
    }
    nav a:focus-visible, .iconbtn:focus-visible, .chip:focus-visible, .filter-open:focus-visible, .apply:focus-visible{
      outline: 3px solid var(--ring);
      outline-offset: 2px;
    }

    /* Rails & chips */
    .wrap{max-width:var(--max); margin:0 auto; padding:24px var(--pad) 40px}
    .section-title{font-size:18px; font-weight:700; margin:12px 0 8px}
    .rail{
      display:flex; gap:10px; overflow-x:auto; padding:10px; border-radius:var(--radius); background:var(--rail);
      scroll-snap-type:x mandatory;
    }
    .rail::-webkit-scrollbar{height:8px}
    .rail::-webkit-scrollbar-thumb{background:#d1d5db; border-radius:999px}

    .chip{
      flex:0 0 auto; padding:9px 12px; border-radius:999px; background:var(--chip); color:var(--chip-ink);
      border:1px solid var(--border); cursor:pointer; user-select:none;
      scroll-snap-align:start;
    }
    .chip[data-on="true"]{ background:var(--chip-on); color:var(--chip-on-ink); border-color:var(--chip-on) }

    /* Color chips (round) */
    .colorchip{
      width:34px; height:34px; border-radius:999px; border:2px solid rgba(0,0,0,.08);
      flex:0 0 auto; position:relative; overflow:hidden; background:#fff; cursor:pointer;
    }
    .colorchip[data-on="true"]{ outline:3px solid var(--ring); outline-offset:2px }
    .colorchip i{position:absolute; inset:0; border-radius:inherit; display:block}
    .colorchip small{
      position:absolute; left:50%; top:100%; transform:translate(-50%,4px);
      font-size:11px; color:var(--muted); white-space:nowrap;
    }

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .filter-open{
      padding:10px 14px; border-radius:999px; border:1px solid var(--brand); background:transparent; color:var(--brand);
      display:inline-flex; gap:8px; align-items:center; cursor:pointer;
    }

    /* Cards (example grids) */
    .grid{
      display:grid; gap:14px; grid-template-columns:repeat(2, minmax(0,1fr));
    }
    @media(min-width:720px){ .grid{ grid-template-columns:repeat(4,minmax(0,1fr)) } }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden;
    }
    .card img{ display:block; width:100%; height:180px; object-fit:cover; background:#eee }
    .card .meta{ padding:10px 12px; display:flex; justify-content:space-between; gap:8px; align-items:center}
    .heart{
      width:32px; height:32px; border-radius:999px; border:1px solid var(--border); display:inline-flex; align-items:center; justify-content:center;
      background:#fff; cursor:pointer;
    }
    .heart[data-on="true"] svg{ fill:#ef4444; stroke:#ef4444 }

    /* Slide-in Filter Panel (shared pattern with browse) */
    .scrim{ position:fixed; inset:0; background:rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:.2s; z-index:50}
    .scrim.on{ opacity:1; pointer-events:auto}
    .panel{
      position:fixed; inset:0 auto 0 0; width:min(560px, 90vw); background:var(--bg);
      transform:translateX(-100%); transition:.25s; z-index:60; border-right:1px solid var(--border);
      display:flex; flex-direction:column;
    }
    .panel.on{ transform:none }
    .panel header{ position:sticky; top:0; background:var(--bg); border-bottom:1px solid var(--border); z-index:2}
    .panel h2{ margin:0; padding:14px var(--pad)}
    .panel .body{ padding:10px var(--pad) 90px; overflow:auto}
    .panel .section{ border:1px solid var(--border); border-radius:12px; margin:10px 0; background:#fff}
    .panel .section summary{
      list-style:none; cursor:pointer; user-select:none; padding:12px; font-weight:600; display:flex; justify-content:space-between; align-items:center;
    }
    .panel .section summary::-webkit-details-marker{ display:none }
    .panel .section .inner{ padding:12px; border-top:1px solid var(--border)}
    .inputs{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .inputs input, .inputs select, .panel input[type="text"]{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border);
    }
    .applybar{
      position:sticky; bottom:0; z-index:2; background:linear-gradient(180deg, rgba(255,255,255,.6), var(--bg) 40%);
      border-top:1px solid var(--border); padding:12px var(--pad); display:flex; gap:10px;
    }
    .apply{
      flex:1; padding:14px 16px; border-radius:12px; border:0; background:var(--brand); color:#fff; font-weight:700; cursor:pointer;
    }
    .ghost{ background:transparent; color:var(--brand); border:1px solid var(--brand) }

    /* Sticky footer */
    footer{ margin-top:auto; border-top:1px solid var(--border); background:#fff }
    .foot{ max-width:var(--max); margin:0 auto; padding:24px var(--pad); color:var(--muted); display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px }
  </style>
</head>
<body>
  <a href="#main" class="sr" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden">Skip to content</a>

  <header>
    <div class="bar">
      <div class="logo" aria-label="Hemline Market">Hemline Market</div>

      <div class="grow">
        <label class="search" aria-label="Search fabrics">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input id="q" name="q" placeholder="Search content (e.g., cashmere, denim, silk)"/>
          <button type="button" class="filter-open" id="openFromSearch" aria-haspopup="dialog" aria-controls="filterPanel">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 6h18M6 12h12M10 18h4"/></svg>
            Filters
          </button>
        </label>
      </div>

      <nav class="row" aria-label="Primary">
        <a href="browse.html">Browse</a>
        <a href="sell.html">Sell</a>
      </nav>

      <button class="iconbtn" id="favBtn" aria-label="Favorites" aria-pressed="false" title="Favorites">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      </button>
      <button class="iconbtn" id="alertBtn" aria-label="Alerts" aria-pressed="false" title="Alerts">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
      </button>
    </div>
  </header>

  <main id="main" class="wrap" tabindex="-1">
    <!-- Home chips that open the shared filter panel -->
    <div class="row" style="margin-bottom:12px">
      <button class="filter-open" data-focus="department" aria-haspopup="dialog" aria-controls="filterPanel">Department</button>
      <button class="filter-open" data-focus="content">Content</button>
      <button class="filter-open" data-focus="color">Color</button>
      <button class="filter-open" data-focus="fabric-type">Fabric Type</button>
      <button class="filter-open" data-focus="pattern">Pattern</button>
      <button class="filter-open" data-focus="width">Width</button>
      <button class="filter-open" data-focus="weight">Weight (GSM)</button>
      <button class="filter-open" data-focus="country">Country</button>
      <button class="filter-open" data-focus="designer">Designer</button>
    </div>

    <!-- Color chips rail (always visible) -->
    <h2 class="section-title">Shop by Color</h2>
    <div class="rail" id="colorRail" aria-label="Color filters (tap to preselect)">
      <!-- Each chip sets ?color=... and opens panel -->
      <!-- Keep values consistent with browse -->
      <button class="colorchip" data-color="white" title="White"><i style="background:var(--c-white)"></i><small>White</small></button>
      <button class="colorchip" data-color="ivory" title="Ivory"><i style="background:var(--c-ivory)"></i><small>Ivory</small></button>
      <button class="colorchip" data-color="beige" title="Beige"><i style="background:var(--c-beige)"></i><small>Beige</small></button>
      <button class="colorchip" data-color="camel" title="Camel"><i style="background:var(--c-camel)"></i><small>Camel</small></button>
      <button class="colorchip" data-color="tan" title="Tan"><i style="background:var(--c-tan)"></i><small>Tan</small></button>
      <button class="colorchip" data-color="yellow" title="Yellow"><i style="background:var(--c-yellow)"></i><small>Yellow</small></button>
      <button class="colorchip" data-color="orange" title="Orange"><i style="background:var(--c-orange)"></i><small>Orange</small></button>
      <button class="colorchip" data-color="rust" title="Rust"><i style="background:var(--c-rust)"></i><small>Rust</small></button>
      <button class="colorchip" data-color="red" title="Red"><i style="background:var(--c-red)"></i><small>Red</small></button>
      <button class="colorchip" data-color="burgundy" title="Burgundy"><i style="background:var(--c-burgundy)"></i><small>Burgundy</small></button>
      <button class="colorchip" data-color="pink" title="Pink"><i style="background:var(--c-pink)"></i><small>Pink</small></button>
      <button class="colorchip" data-color="blush" title="Blush"><i style="background:var(--c-blush)"></i><small>Blush</small></button>
      <button class="colorchip" data-color="lilac" title="Lilac"><i style="background:var(--c-lilac)"></i><small>Lilac</small></button>
      <button class="colorchip" data-color="purple" title="Purple"><i style="background:var(--c-purple)"></i><small>Purple</small></button>
      <button class="colorchip" data-color="blue" title="Blue"><i style="background:var(--c-blue)"></i><small>Blue</small></button>
      <button class="colorchip" data-color="navy" title="Navy"><i style="background:var(--c-navy)"></i><small>Navy</small></button>
      <button class="colorchip" data-color="teal" title="Teal"><i style="background:var(--c-teal)"></i><small>Teal</small></button>
      <button class="colorchip" data-color="green" title="Green"><i style="background:var(--c-green)"></i><small>Green</small></button>
      <button class="colorchip" data-color="olive" title="Olive"><i style="background:var(--c-olive)"></i><small>Olive</small></button>
      <button class="colorchip" data-color="brown" title="Brown"><i style="background:var(--c-brown)"></i><small>Brown</small></button>
      <button class="colorchip" data-color="grey" title="Grey"><i style="background:var(--c-grey)"></i><small>Grey</small></button>
      <button class="colorchip" data-color="charcoal" title="Charcoal"><i style="background:var(--c-charcoal)"></i><small>Charcoal</small></button>
      <button class="colorchip" data-color="black" title="Black"><i style="background:var(--c-black)"></i><small>Black</small></button>
    </div>

    <!-- Content chips rail -->
    <h2 class="section-title">Popular Content</h2>
    <div class="rail" id="contentRail" aria-label="Fiber content chips">
      <!-- Keep these labels & values consistent with browse page -->
      <button class="chip" data-chip="content" data-value="cashmere">Cashmere</button>
      <button class="chip" data-chip="content" data-value="wool">Wool</button>
      <button class="chip" data-chip="content" data-value="silk">Silk</button>
      <button class="chip" data-chip="content" data-value="cotton">Cotton</button>
      <button class="chip" data-chip="content" data-value="linen">Linen</button>
      <button class="chip" data-chip="content" data-value="bamboo">Bamboo</button>
      <button class="chip" data-chip="content" data-value="alpaca">Alpaca</button>
      <button class="chip" data-chip="content" data-value="rayon">Rayon/Viscose</button>
      <button class="chip" data-chip="content" data-value="polyester">Polyester</button>
      <button class="chip" data-chip="content" data-value="nylon">Nylon</button>
    </div>

    <!-- Example listings (optional eye candy) -->
    <h2 class="section-title">New Arrivals</h2>
    <div class="grid" id="grid">
      <!-- Demo cards; in production, render real listings -->
      <article class="card">
        <img src="https://images.unsplash.com/photo-1512436991641-6745cdb1723f?q=80&w=1200&auto=format&fit=crop" alt="Italian wool suiting in navy" />
        <div class="meta">
          <div><strong>Italian Wool Suiting</strong><br><small class="muted">Navy Â· 150cm</small></div>
          <button class="heart" aria-label="Save" title="Save"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></button>
        </div>
      </article>
      <article class="card">
        <img src="https://images.unsplash.com/photo-1556306535-abccb408c19f?q=80&w=1200&auto=format&fit=crop" alt="Silk charmeuse bolt in champagne" />
        <div class="meta">
          <div><strong>Silk Charmeuse</strong><br><small class="muted">Champagne Â· 114cm</small></div>
          <button class="heart" aria-label="Save" title="Save"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></button>
        </div>
      </article>
      <article class="card">
        <img src="https://images.unsplash.com/photo-1467043153537-a4f57095882d?q=80&w=1200&auto=format&fit=crop" alt="Japanese denim raw indigo" />
        <div class="meta">
          <div><strong>Japanese Denim</strong><br><small class="muted">Raw Indigo Â· 145cm</small></div>
          <button class="heart" aria-label="Save" title="Save"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></button>
        </div>
      </article>
      <article class="card">
        <img src="https://images.unsplash.com/photo-1567502058429-b22a04e2d2b8?q=80&w=1200&auto=format&fit=crop" alt="Linen plain weave bolt" />
        <div class="meta">
          <div><strong>European Linen</strong><br><small class="muted">Natural Â· 140cm</small></div>
          <button class="heart" aria-label="Save" title="Save"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></button>
        </div>
      </article>
    </div>
  </main>

  <!-- Footer -->
  <footer role="contentinfo">
    <div class="foot">
      <span>&copy; <span id="yr"></span> Hemline Market</span>
      <span class="row">
        <a href="terms.html">Terms</a>
        <a href="privacy.html">Privacy</a>
        <a href="shipping.html">Shipping &amp; Returns</a>
        <a href="contact.html">Contact</a>
      </span>
    </div>
  </footer>

  <!-- Scrim + Panel -->
  <div class="scrim" id="scrim" aria-hidden="true"></div>
  <aside class="panel" id="filterPanel" role="dialog" aria-modal="true" aria-labelledby="filterTitle">
    <header><h2 id="filterTitle">Filters</h2></header>
    <div class="body" id="panelBody">
      <!-- Department -->
      <details class="section" id="sec-department" open>
        <summary>Department</summary>
        <div class="inner row">
          <button class="chip" data-chip="department" data-value="atelier">Atelier</button>
          <button class="chip" data-chip="department" data-value="everyday">Everyday</button>
          <button class="chip" data-chip="department" data-value="kids">Kids</button>
          <button class="chip" data-chip="department" data-value="sale">Sale</button>
        </div>
      </details>

      <!-- Content -->
      <details class="section" id="sec-content">
        <summary>Content</summary>
        <div class="inner row" id="contentSection">
          <!-- Buttons duplicated to ensure parity -->
          <button class="chip" data-chip="content" data-value="cashmere">Cashmere</button>
          <button class="chip" data-chip="content" data-value="wool">Wool</button>
          <button class="chip" data-chip="content" data-value="silk">Silk</button>
          <button class="chip" data-chip="content" data-value="cotton">Cotton</button>
          <button class="chip" data-chip="content" data-value="linen">Linen</button>
          <button class="chip" data-chip="content" data-value="bamboo">Bamboo</button>
          <button class="chip" data-chip="content" data-value="alpaca">Alpaca</button>
          <button class="chip" data-chip="content" data-value="rayon">Rayon/Viscose</button>
          <button class="chip" data-chip="content" data-value="polyester">Polyester</button>
          <button class="chip" data-chip="content" data-value="nylon">Nylon</button>
        </div>
      </details>

      <!-- Color -->
      <details class="section" id="sec-color">
        <summary>Color</summary>
        <div class="inner rail" id="panelColors" aria-label="Color">
          <!-- Same set as top rail -->
          <!-- (generated by JS for DRY) -->
        </div>
      </details>

      <!-- Fabric Type -->
      <details class="section" id="sec-fabric-type">
        <summary>Fabric Type</summary>
        <div class="inner row">
          <button class="chip" data-chip="fabric_type" data-value="canvas">Canvas</button>
          <button class="chip" data-chip="fabric_type" data-value="chiffon">Chiffon</button>
          <button class="chip" data-chip="fabric_type" data-value="corduroy">Corduroy</button>
          <button class="chip" data-chip="fabric_type" data-value="crepe">Crepe</button>
          <button class="chip" data-chip="fabric_type" data-value="denim">Denim</button>
          <button class="chip" data-chip="fabric_type" data-value="flannel">Flannel</button>
          <button class="chip" data-chip="fabric_type" data-value="georgette">Georgette</button>
          <button class="chip" data-chip="fabric_type" data-value="jersey">Jersey</button>
          <button class="chip" data-chip="fabric_type" data-value="lace">Lace</button>
          <button class="chip" data-chip="fabric_type" data-value="lawn">Lawn</button>
          <button class="chip" data-chip="fabric_type" data-value="organza">Organza</button>
          <button class="chip" data-chip="fabric_type" data-value="poplin">Poplin</button>
          <button class="chip" data-chip="fabric_type" data-value="sateen">Sateen</button>
          <button class="chip" data-chip="fabric_type" data-value="satin">Satin</button>
          <button class="chip" data-chip="fabric_type" data-value="tulle">Tulle</button>
          <button class="chip" data-chip="fabric_type" data-value="twill">Twill</button>
          <button class="chip" data-chip="fabric_type" data-value="velvet">Velvet</button>
          <button class="chip" data-chip="fabric_type" data-value="voile">Voile</button>
        </div>
      </details>

      <!-- Pattern -->
      <details class="section" id="sec-pattern">
        <summary>Pattern</summary>
        <div class="inner row">
          <button class="chip" data-chip="pattern" data-value="solid">Solid</button>
          <button class="chip" data-chip="pattern" data-value="printed">Printed</button>
        </div>
      </details>

      <!-- Width / Weight -->
      <details class="section" id="sec-width">
        <summary>Width (cm)</summary>
        <div class="inner inputs">
          <input type="number" inputmode="numeric" placeholder="Min" id="widthMin">
          <input type="number" inputmode="numeric" placeholder="Max" id="widthMax">
        </div>
      </details>

      <details class="section" id="sec-weight">
        <summary>Weight (GSM)</summary>
        <div class="inner inputs">
          <input type="number" inputmode="numeric" placeholder="Min" id="gsmMin">
          <input type="number" inputmode="numeric" placeholder="Max" id="gsmMax">
        </div>
      </details>

      <!-- Country -->
      <details class="section" id="sec-country">
        <summary>Country</summary>
        <div class="inner row">
          <button class="chip" data-chip="country" data-value="italy">Italy</button>
          <button class="chip" data-chip="country" data-value="france">France</button>
          <button class="chip" data-chip="country" data-value="japan">Japan</button>
          <button class="chip" data-chip="country" data-value="uk">UK</button>
          <button class="chip" data-chip="country" data-value="usa">USA</button>
          <button class="chip" data-chip="country" data-value="india">India</button>
          <button class="chip" data-chip="country" data-value="china">China</button>
          <button class="chip" data-chip="country" data-value="korea">Korea</button>
        </div>
      </details>

      <!-- Designer -->
      <details class="section" id="sec-designer">
        <summary>Designer</summary>
        <div class="inner">
          <input type="text" id="designerInput" placeholder="Type a designer or mill name" />
        </div>
      </details>
    </div>
    <div class="applybar">
      <button class="apply ghost" id="clearAll" type="button">Clear</button>
      <button class="apply" id="apply" type="button" data-dest="browse.html">Apply &amp; Browse</button>
    </div>
  </aside>

  <script>
    // --- Utilities -----------------------------------------------------------
    const $ = (q,el=document)=>el.querySelector(q);
    const $$ = (q,el=document)=>Array.from(el.querySelectorAll(q));
    const qs = new URLSearchParams(location.search);
    const state = new Map(); // key -> Set<string> for multi chips
    const setOn = (el, on)=> el?.setAttribute && el.setAttribute('data-on', on ? 'true':'false');

    const persist = {
      readBool: (k, d=false)=> localStorage.getItem(k) ? localStorage.getItem(k)==='1' : d,
      writeBool: (k, v)=> localStorage.setItem(k, v ? '1':'0')
    };

    const colors = [
      "white","ivory","beige","camel","tan","yellow","orange","rust","red","burgundy","pink","blush",
      "lilac","purple","blue","navy","teal","green","olive","brown","grey","charcoal","black"
    ];

    // Build color chips inside panel from top rail to keep parity
    (function buildPanelColors(){
      const host = $("#panelColors");
      $("#colorRail").querySelectorAll(".colorchip").forEach(ch=>{
        const b = ch.cloneNode(true);
        b.classList.remove("colorchip"); // display same UI but click sets chip
        b.classList.add("colorchip");    // keep same look
        host.appendChild(b);
      });
    })();

    // --- Favorites & Alerts buttons (persist across pages) -------------------
    const favBtn = $("#favBtn");
    const alertBtn = $("#alertBtn");
    const syncToggle = (btn,key)=>{
      const on = persist.readBool(key,false);
      btn.setAttribute("aria-pressed", on ? "true":"false");
      btn.addEventListener("click", ()=>{
        const next = btn.getAttribute("aria-pressed")!=="true";
        btn.setAttribute("aria-pressed", next ? "true":"false");
        persist.writeBool(key, next);
      });
    };
    syncToggle(favBtn, "hm_favorites_on");
    syncToggle(alertBtn, "hm_alerts_on");

    // --- Hearts on cards (demo) ---------------------------------------------
    $$(".heart").forEach(h=>{
      h.addEventListener("click", ()=>{
        const on = h.getAttribute("data-on")==="true";
        h.setAttribute("data-on", on ? "false":"true");
      });
    });

    // --- Slide-in filter panel ----------------------------------------------
    const scrim = $("#scrim");
    const panel = $("#filterPanel");
    const openPanel = (focusSectionId)=>{
      scrim.classList.add("on");
      panel.classList.add("on");
      scrim.setAttribute("aria-hidden","false");
      // Focus tapped section if provided
      if(focusSectionId){
        const sec = $("#sec-"+focusSectionId);
        if(sec){ sec.open = true; setTimeout(()=>{ sec.querySelector("summary")?.focus(); }, 50); }
      } else {
        setTimeout(()=> panel.querySelector("summary")?.focus(), 30);
      }
      // Focus trap
      document.addEventListener("keydown", trapTab);
    };
    const closePanel = ()=>{
      scrim.classList.remove("on");
      panel.classList.remove("on");
      scrim.setAttribute("aria-hidden","true");
      document.removeEventListener("keydown", trapTab);
      $("#openFromSearch").focus();
    };
    scrim.addEventListener("click", closePanel);
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && panel.classList.contains("on")) closePanel(); });

    // Focus trap inside panel
    function trapTab(e){
      if(e.key!=="Tab") return;
      const focusables = $$('button, [href], input, summary, select, textarea, [tabindex]:not([tabindex="-1"])', panel)
        .filter(el=>!el.hasAttribute("disabled") && el.offsetParent!==null);
      const first = focusables[0], last = focusables[focusables.length-1];
      if(e.shiftKey && document.activeElement===first){ last.focus(); e.preventDefault(); }
      else if(!e.shiftKey && document.activeElement===last){ first.focus(); e.preventDefault(); }
    }

    // Openers
    $("#openFromSearch").addEventListener("click", ()=>openPanel());
    $$(".filter-open").forEach(b=>{
      b.addEventListener("click", ()=>{
        const sec = b.dataset.focus || "";
        openPanel(sec);
      });
    });

    // Clicking color chips: mark and open panel (focus color section)
    const markColorChip = (el, on)=> setOn(el, on);
    function setColor(value, on){
      // set both in top rail and panel rail
      $$('#colorRail .colorchip, #panelColors .colorchip').forEach(c=>{
        if(c.dataset.color===value){ markColorChip(c, on); }
      });
      if(on){ (state.get('color') || state.set('color', new Set()).get('color')).add(value); }
      else{ state.get('color')?.delete(value); }
    }
    $$('#colorRail .colorchip, #panelColors .colorchip').forEach(el=>{
      el.addEventListener("click", ()=>{
        const v = el.dataset.color;
        const on = !(el.getAttribute("data-on")==="true");
        setColor(v, on);
        openPanel('color');
      });
    });

    // Chips (multi-select toggles)
    function toggleChip(btn){
      const key = btn.dataset.chip;
      const val = btn.dataset.value;
      const set = state.get(key) || new Set();
      if(btn.getAttribute("data-on")==="true"){ set.delete(val); setOn(btn,false); }
      else { set.add(val); setOn(btn,true); }
      state.set(key,set);
    }
    document.addEventListener("click", (e)=>{
      const target = e.target.closest(".chip");
      if(!target) return;
      toggleChip(target);
    });

    // Width/Weight/designer read/write helpers
    function readFieldState(){
      const out = {};
      if($("#widthMin").value) out.width_min = $("#widthMin").value;
      if($("#widthMax").value) out.width_max = $("#widthMax").value;
      if($("#gsmMin").value) out.gsm_min = $("#gsmMin").value;
      if($("#gsmMax").value) out.gsm_max = $("#gsmMax").value;
      if($("#designerInput").value.trim()) out.designer = $("#designerInput").value.trim();
      return out;
    }
    function writeFieldState(params){
      $("#widthMin").value = params.get('width_min') || '';
      $("#widthMax").value = params.get('width_max') || '';
      $("#gsmMin").value   = params.get('gsm_min')   || '';
      $("#gsmMax").value   = params.get('gsm_max')   || '';
      $("#designerInput").value = params.get('designer') || '';
    }

    // Apply / Clear
    $("#apply").addEventListener("click", ()=>{
      const dest = $("#apply").dataset.dest || "browse.html";
      const out = new URLSearchParams();

      // search box -> maps to content if it matches a known content
      const q = $("#q").value.trim();
      if(q) out.set('q', q);

      for(const [k,set] of state.entries()){
        if(set.size) out.set(k, Array.from(set).join(','));
      }
      const fields = readFieldState();
      Object.entries(fields).forEach(([k,v])=> out.set(k, v));

      // Navigate with deep link (state persists on back/forward)
      location.href = dest + (out.toString() ? ('?'+out.toString()) : '');
    });

    $("#clearAll").addEventListener("click", ()=>{
      state.clear();
      $$(".chip").forEach(c=>setOn(c,false));
      $$(".colorchip").forEach(c=>setOn(c,false));
      $("#widthMin").value = $("#widthMax").value = $("#gsmMin").value = $("#gsmMax").value = "";
      $("#designerInput").value = "";
      $("#q").value = "";
    });

    // --- Preselect logic (URL params mirror Browse) -------------------------
    function preselectFromParams(params){
      // q -> if matches a content token, mark it
      const q = (params.get('q') || '').toLowerCase();
      const contentTokens = ['cashmere','wool','silk','cotton','linen','bamboo','alpaca','rayon','viscose','polyester','nylon'];
      if(q){
        const match = contentTokens.find(tok => q.includes(tok));
        if(match){ params.set('content', (params.get('content') ? params.get('content')+',' : '') + (match==='viscose'?'rayon':match)); }
        $("#q").value = params.get('q');
      }

      // Chips (multi)
      const multiKeys = ['department','content','fabric_type','pattern','country','color'];
      multiKeys.forEach(key=>{
        const raw = params.get(key);
        if(!raw) return;
        const values = raw.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
        values.forEach(v=>{
          // mark chips
          $$(`.chip[data-chip="${key}"][data-value="${v}"]`).forEach(btn=>setOn(btn,true));
          (state.get(key) || state.set(key,new Set()).get(key)).add(v);
          if(key==='color') setColor(v, true);
        });
      });

      // numeric/text fields
      writeFieldState(params);
    }

    // Sync colorchip visual on load (when arrived via ?color=blue, etc.)
    function reflectColorParam(){
      const raw = qs.get('color');
      if(!raw) return;
      raw.split(',').forEach(v=>setColor(v.trim().toLowerCase(), true));
    }

    // Year
    $("#yr").textContent = new Date().getFullYear();

    // Parse existing params (preselect)
    preselectFromParams(qs);
    reflectColorParam();

    // Clicking top content chips should simply toggle & open the panel
    $$('#contentRail .chip').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        toggleChip(btn);
        openPanel('content');
      });
    });

    // When a colorchip on top rail is tapped, update URL (so back/forward preserves) but stay on page
    $$('#colorRail .colorchip').forEach(el=>{
      el.addEventListener("click", ()=>{
        const set = state.get('color') || new Set();
        const arr = Array.from(set);
        const p = new URLSearchParams(location.search);
        if(arr.length){ p.set('color', arr.join(',')); } else { p.delete('color'); }
        const u = location.pathname + (p.toString()?('?'+p.toString()):'');
        history.replaceState(null, '', u);
      });
    });
  </script>
</body>
</html>
