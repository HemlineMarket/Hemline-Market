<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Hemline Market — Find your next fabric creation</title>

  <!-- Shared styles -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-text:#111827;
      --hm-muted:#6b7280;
      --hm-border:#e5e7eb;
      --hm-bg-card:rgba(255,255,255,.96);
    }

    body{
      margin:0;
      background:url("images/homepage.jpeg") center/cover fixed no-repeat;
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* Utility */
    .is-hidden{display:none !important;}
    .muted-small{margin:10px 2px 0;font-size:13px;color:var(--hm-muted);}

    /* Hero + UI */
    .hero-wrap{
      max-width:1200px;
      margin:14px auto 0;
      padding:0 12px;
    }
    .hero-card{
      background:rgba(255,255,255,.94);
      border-radius:14px;
      box-shadow:0 6px 14px rgba(0,0,0,.10);
      padding:12px;
    }
    .home-hero h1{
      font-size:22px;
      margin:0 0 4px;
      font-weight:800;
    }
    .home-hero p{
      margin:0 0 8px;
      color:var(--hm-muted);
      font-size:13px;
    }

    .cta-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:8px 0 10px;
    }
    .cta{
      border:1px solid var(--hm-border);
      border-radius:10px;
      padding:8px 12px;
      background:#fff;
      font-weight:700;
      text-decoration:none;
      color:#1f2937;
    }
    .cta--primary{
      border-color:var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
    }

    .search-card{
      display:grid;
      grid-template-columns:120px 1fr auto;
      gap:8px;
      margin-bottom:10px;
    }
    .search-card select,
    .search-card input{
      padding:8px 10px;
      border:1px solid var(--hm-border);
      border-radius:10px;
      background:#fff;
    }
    .search-card button{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      font-weight:700;
    }
    @media (max-width:760px){
      .search-card{grid-template-columns:1fr;gap:6px}
    }

    .tab-row{
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:8px;
      margin-bottom:8px;
    }
    .tab{
      display:flex;
      align-items:center;
      justify-content:center;
      height:36px;
      border:1.5px solid var(--hm-border);
      border-radius:999px;
      background:#fff;
      font-weight:700;
      font-size:13px;
      color:#374151;
      cursor:pointer;
      user-select:none;
    }
    .tab:after{
      content:"+";
      margin-left:6px;
      font-weight:900;
      color:#6b7280;
    }
    .tab[aria-expanded="true"]{
      border-color:var(--hm-accent);
      box-shadow:0 0 0 2px rgba(153,27,27,.10);
    }
    .tab[aria-expanded="true"]:after{content:"–"}

    .panel-grid{
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:8px;
    }
    .panel{
      display:none;
      background:rgba(255,255,255,.98);
      border:1px solid var(--hm-border);
      border-radius:12px;
      padding:8px;
      min-height:54px;
    }
    .panel.open{display:block}

    .content-panel .list{
      max-height:160px;
      overflow:auto;
      padding:4px;
      border:1px solid var(--hm-border);
      border-radius:10px;
      background:#fff;
    }
    .check{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-bottom:1px dashed #f1f5f9;
    }
    .check:last-child{border-bottom:0}
    .check input{width:14px;height:14px}
    .check label{font-size:12px;color:#374151}

    .row{display:flex;gap:8px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:4px}
    .field label{font-size:12px;color:#374151}
    .field input,
    .field select{
      padding:7px 10px;
      border:1px solid var(--hm-border);
      border-radius:10px;
      background:#fff;
      font-size:13px;
      min-width:120px;
    }

    .global-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:8px;
    }
    .btn{
      padding:6px 10px;
      border-radius:10px;
      border:1px solid var(--hm-border);
      background:#fff;
      color:#374151;
      cursor:pointer;
      font-size:13px;
    }
    .btn-primary{
      border-color:var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
    }

    /* HOW IT WORKS card */
    .how-it-works{
      margin:16px auto 8px;
      max-width:1200px;
      padding:0 12px;
    }
    .hiw-shell{
      background:rgba(255,255,255,.96);
      border:1px solid var(--hm-border);
      border-radius:14px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
      padding:14px 16px 12px;
    }
    .hiw-header{
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-bottom:8px;
    }
    .hiw-title{
      font-size:15px;
      font-weight:800;
    }
    .hiw-subtitle{
      font-size:13px;
      color:var(--hm-muted);
    }
    .hiw-list{
      margin:4px 0 0;
      padding-left:18px;
      font-size:13px;
    }
    .hiw-list li{margin:2px 0;}
    .hiw-tagline{
      margin-top:8px;
      font-size:13px;
      font-weight:600;
    }
    @media (max-width:768px){
      .how-it-works{padding:0 8px;margin-top:10px;}
    }

    /* Layout + New Listings grid */
    .layout{
      max-width:1200px;
      margin:12px auto 0;
      padding:0 12px;
    }
    .section h2{
      margin:0 0 8px;
      font-size:18px;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:900px){
      .grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width:560px){
      .grid{grid-template-columns:1fr}
    }

    /* Listing cards */
    .listing-card{
      background:var(--hm-bg-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .listing-thumb-link{
      display:block;
      text-decoration:none;
      color:inherit;
    }
    .listing-thumb{
      aspect-ratio:1/1;
      background:linear-gradient(180deg,#f8fafc,#eef2f7);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .listing-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .listing-body{
      padding:8px 10px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .listing-title-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:6px;
    }
    .listing-title{
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-decoration:none;
      color:#111827;
    }
    .listing-dept{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#f3f4f6;
      color:#4b5563;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .listing-yards{
      font-size:12px;
      color:#4b5563;
    }
    .listing-cta-row{
      margin-top:4px;
    }
    .listing-add-btn{
      width:100%;
      border-radius:10px;
      border:1px solid var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      font-weight:700;
      font-size:13px;
      padding:8px 10px;
      cursor:pointer;
    }
    .listing-add-btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    .listing-price-row{
      margin-top:6px;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
    }
    .listing-price-main{
      font-weight:700;
      color:#111827;
    }
    .listing-price-orig{
      text-decoration:line-through;
      color:#9ca3af;
    }
    .listing-seller-row{
      margin-top:4px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      color:#6b7280;
    }
    .listing-seller-name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .below-rails{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    @media (max-width:900px){
      .below-rails{grid-template-columns:1fr;gap:10px}
    }
    .panel header{
      padding:8px 10px;
      border-bottom:1px solid var(--hm-border);
      font-weight:700;
    }
    .panel .panel-body{padding:8px 10px}

    .likes-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:6px;
    }
    .like{
      height:40px;
      border-radius:999px;
      border:1px dashed var(--hm-border);
      background:rgba(255,255,255,.9);
    }

    @media (max-width:640px){
      .hm-header .wrap{padding:0 8px}
      .hm-btn-primary{padding:8px 14px}
    }
  </style>
</head>
<body>

  <!-- UNIVERSAL HEADER (injected by hm-shell.js) -->
  <div id="hm-shell-header"></div>

  <!-- HERO -->
  <section class="hero-wrap">
    <div class="hero-card home-hero">
      <h1>Find your next fabric creation</h1>
      <p>Buy &amp; sell your fabrics with prepaid, trackable shipping.</p>

      <div class="cta-row" id="heroAuthCtas">
        <a class="cta" href="auth.html?view=login">Log in</a>
        <a class="cta" href="auth.html?view=signup">Sign up</a>
        <a class="cta cta--primary" href="sell.html">Start selling</a>
      </div>

      <form id="homeSearch" class="search-card" role="search" aria-label="Search">
        <label class="is-hidden" for="searchType">Search type</label>
        <select name="type" id="searchType" aria-label="Search type">
          <option value="listings" selected>Listings</option>
          <option value="users">Users</option>
        </select>
        <label class="is-hidden" for="searchQ">Search query</label>
        <input type="search" name="q" id="searchQ" placeholder="Search fabrics, shops, or styles…" aria-label="Search query"/>
        <button type="submit" aria-label="Search">Search</button>
      </form>

      <!-- Filter tabs (placeholder for future wiring) -->
      <div class="tab-row is-hidden" id="tabRow" aria-hidden="true">
        <button type="button" class="tab" data-panel="pContent" aria-expanded="false">Content</button>
        <button type="button" class="tab" data-panel="pColor"   aria-expanded="false">Color</button>
        <button type="button" class="tab" data-panel="pPrice"   aria-expanded="false">$/yard</button>
        <button type="button" class="tab" data-panel="pYards"   aria-expanded="false">Yards</button>
        <button type="button" class="tab" data-panel="pMore"    aria-expanded="false">More</button>
      </div>

      <div class="panel-grid is-hidden" aria-hidden="true">
        <div id="pContent" class="panel content-panel">
          <div class="list">
            <div class="check"><input id="cotton" type="checkbox"><label for="cotton">Cotton</label></div>
            <div class="check"><input id="linen"  type="checkbox"><label for="linen">Linen</label></div>
            <div class="check"><input id="wool"   type="checkbox"><label for="wool">Wool</label></div>
            <div class="check"><input id="silk"   type="checkbox"><label for="silk">Silk</label></div>
            <div class="check"><input id="rayon"  type="checkbox"><label for="rayon">Rayon/Viscose</label></div>
          </div>
        </div>
        <div id="pColor" class="panel">
          <div class="row">
            <div class="field">
              <label for="color">Primary color</label>
              <select id="color">
                <option value="">Any</option>
                <option>Black</option><option>White</option><option>Blue</option>
                <option>Green</option><option>Red</option><option>Yellow</option>
                <option>Purple</option><option>Brown</option><option>Gray</option>
              </select>
            </div>
          </div>
        </div>
        <div id="pPrice" class="panel">
          <div class="row">
            <div class="field"><label for="pmin">$ / yd (min)</label><input id="pmin" type="number" min="0" step="1" placeholder="0"></div>
            <div class="field"><label for="pmax">$ / yd (max)</label><input id="pmax" type="number" min="0" step="1" placeholder="100"></div>
          </div>
        </div>
        <div id="pYards" class="panel">
          <div class="row">
            <div class="field"><label for="ymin">Yards (min)</label><input id="ymin" type="number" min="0" step="0.5" placeholder="0"></div>
            <div class="field"><label for="ymax">Yards (max)</label><input id="ymax" type="number" min="0" step="0.5" placeholder="10"></div>
          </div>
        </div>
        <div id="pMore" class="panel">
          <div class="row">
            <div class="field"><label for="width">Width</label><input id="width" type="number" min="0" step="1" placeholder="inches"></div>
            <div class="field"><label for="gsm">Weight (GSM)</label><input id="gsm" type="number" min="0" step="10" placeholder="e.g., 180"></div>
          </div>
        </div>
        <div id="pMore2" class="panel"></div>
      </div>

      <div class="global-actions is-hidden" aria-hidden="true">
        <button class="btn" id="clearAll" type="button">Clear</button>
        <button class="btn btn-primary" id="applyAll" type="button">Apply</button>
      </div>
    </div>
  </section>

  <!-- HOW IT WORKS SUMMARY -->
  <section class="how-it-works" aria-labelledby="howTitle">
    <div class="hiw-shell">
      <div class="hiw-header">
        <div class="hiw-title" id="howTitle">How Hemline Market works</div>
        <div class="hiw-subtitle">
          Hemline Market helps sewists find their next project and gives unused fabric a second life.
        </div>
      </div>
      <ul class="hiw-list">
        <li>Browse fabrics from independent sellers</li>
        <li>List your own fabric</li>
        <li>Hemline Market connects buyers and sellers with secure checkout and prepaid labels</li>
      </ul>
      <div class="hiw-tagline">Sew more. Waste less. Create freely.</div>
    </div>
  </section>

  <!-- MAIN -->
  <div class="layout">
    <main class="section" aria-label="New listings">
      <h2>New Listings</h2>

      <div class="grid" id="newListingsGrid" aria-live="polite"></div>
      <p id="newListingsEmpty" class="muted-small">
        Newest fabrics will appear here as they’re published.
      </p>

      <div class="below-rails">
        <section class="panel" aria-label="Favorites">
          <header>Favorites</header>
          <div class="panel-body">
            <div class="likes-grid">
              <a class="like" href="browse.html?type=listings" aria-label="Japanese Denim"></a>
              <a class="like" href="browse.html?type=listings" aria-label="Silk Charmeuse"></a>
              <a class="like" href="browse.html?type=listings" aria-label="European Linen"></a>
              <a class="like" href="browse.html?type=listings" aria-label="Italian Wool Suiting"></a>
              <a class="like" href="browse.html?type=listings" aria-label="Cupro/Silk Satin"></a>
              <a class="like" href="browse.html?type=listings" aria-label="Wool Crepe"></a>
            </div>
          </div>
        </section>

        <section class="panel" aria-label="Recent Views">
          <header>Recent Views</header>
          <div class="panel-body">
            <div class="likes-grid">
              <a class="like" href="browse.html?type=listings" aria-label="Italian Silk Twill"></a>
              <a class="like" href="browse.html?type=listings" aria-label="Wool Crepe"></a>
              <a class="like" href="browse.html?type=listings" aria-label="Cotton Poplin"></a>
              <a class="like" href="browse.html?type=listings" aria-label="Linen Canvas"></a>
              <a class="like" href="browse.html?type=listings" aria-label="Tencel Twill"></a>
              <a class="like" href="browse.html?type=listings" aria-label="Alpaca Bouclé"></a>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- UNIVERSAL FOOTER (injected by hm-shell.js) -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Shared shell (universal header/footer + menu + header session) -->
  <script src="scripts/hm-shell.js"></script>

  <script>
    // Render shared header + footer
    window.HM && window.HM.renderShell({ currentPage: "" });

    (function(){
      // Home search → browse.html?q=...&type=...
      const form = document.getElementById('homeSearch');
      if(form){
        form.addEventListener('submit', function(e){
          e.preventDefault();
          const type = (document.getElementById('searchType') || {}).value || 'listings';
          const q    = (document.getElementById('searchQ') || {}).value || '';
          const url  = 'browse.html?type=' + encodeURIComponent(type) + '&q=' + encodeURIComponent(q);
          window.location.href = url;
        });
      }

      // Supabase client for homepage (new listings + hero CTAs)
      let supabaseClient = null;
      if(window.supabase){
        supabaseClient = window.supabase.createClient(
          "https://clkizksbvxjkoatdajgd.supabase.co",
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI",
          { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
        );
      }

      function moneyFromCents(c){
        if(c == null) return "";
        const v = Number(c) / 100;
        return v.toLocaleString("en-US",{
          style:"currency",
          currency:"USD",
          minimumFractionDigits:2,
          maximumFractionDigits:2
        });
      }

      function computeYards(row){
        const y1 = row.yards_available;
        const y2 = row.yardage;
        const raw = (y1 != null ? Number(y1) : (y2 != null ? Number(y2) : null));
        if(!Number.isFinite(raw) || raw <= 0) return null;
        return raw;
      }

      const grid  = document.getElementById('newListingsGrid');
      const empty = document.getElementById('newListingsEmpty');

      async function loadNewListings(){
        if(!grid || !supabaseClient) return;

        try{
          const { data:listings, error } = await supabaseClient
            .from("listings")
            .select("id,title,price_cents,orig_price_cents,yards_available,yardage,width_in,dept,status,is_published,seller_id,image_url_1,created_at")
            .eq("is_published", true)
            .order("created_at",{ ascending:false })
            .limit(6);

          if(error){
            console.warn("New listings fetch error:", error);
            return;
          }
          if(!listings || !listings.length){
            return;
          }

          const sellerIds = [...new Set(listings.map(l=>l.seller_id).filter(Boolean))];

          let profilesById = {};
          if(sellerIds.length){
            const { data:profiles, error:profError } = await supabaseClient
              .from("profiles")
              .select("id,store_name,first_name,last_name")
              .in("id", sellerIds);
            if(!profError && profiles){
              profilesById = profiles.reduce((acc,p)=>{ acc[p.id] = p; return acc; },{});
            }
          }

          grid.innerHTML = "";
          if(empty) empty.classList.add("is-hidden");

          listings.forEach(item=>{
            const profile = item.seller_id ? profilesById[item.seller_id] : null;
            const fullName = ((profile?.first_name || "") + " " + (profile?.last_name || "")).trim();
            const shopName = profile?.store_name || fullName || "";
            const sellerLabel = shopName || "Seller";

            const yards = computeYards(item);
            const priceCents = item.price_cents != null ? Number(item.price_cents) : null;
            const perYdMoney = priceCents != null ? moneyFromCents(priceCents) : "";
            const origPerMoney = item.orig_price_cents != null ? moneyFromCents(item.orig_price_cents) : "";
            const totalCents = (priceCents != null && yards != null) ? priceCents * yards : null;
            const totalMoney = totalCents != null ? moneyFromCents(totalCents) : "";

            const status = (item.status || "active").toLowerCase();
            const isSold = status === "sold";
            const canBuy = !isSold && priceCents != null && yards != null && yards > 0;

            const card = document.createElement("article");
            card.className = "listing-card";

            const href = "listing.html?id=" + encodeURIComponent(item.id);

            const safeTitle = item.title || "Untitled listing";
            const safeAlt = safeTitle.replace(/"/g,"&quot;");

            card.innerHTML = `
              <a class="listing-thumb-link" href="${href}">
                <div class="listing-thumb" aria-hidden="true">
                  ${item.image_url_1 ? `<img src="${item.image_url_1}" alt="${safeAlt}">` : ""}
                </div>
              </a>
              <div class="listing-body">
                <div class="listing-title-row">
                  <a class="listing-title" href="${href}">${safeTitle}</a>
                  ${item.dept ? `<span class="listing-dept">${item.dept}</span>` : ""}
                </div>
                ${yards != null ? `<div class="listing-yards">${yards} yards</div>` : ""}
                <div class="listing-cta-row">
                  <button type="button" class="listing-add-btn add-to-cart">
                    ${
                      canBuy && totalMoney && yards
                        ? `Add to Cart — ${totalMoney} for ${yards} yards`
                        : (isSold ? "Sold out" : "Add to Cart")
                    }
                  </button>
                </div>
                <div class="listing-price-row">
                  ${
                    perYdMoney
                      ? `<span class="listing-price-main">${perYdMoney}/yard</span>`
                      : `<span class="listing-price-main">Price coming soon</span>`
                  }
                  ${
                    origPerMoney
                      ? `<span class="listing-price-orig">${origPerMoney}/yard</span>`
                      : ""
                  }
                </div>
                <div class="listing-seller-row">
                  <span class="listing-seller-name">${sellerLabel}</span>
                </div>
              </div>
            `;

            const btn = card.querySelector(".listing-add-btn");
            if(btn){
              const perYdDollars = priceCents != null ? (priceCents / 100) : 0;
              const firstImg = item.image_url_1 || "";

              btn.dataset.id = item.id;
              btn.dataset.name = safeTitle;
              btn.dataset.amount = totalCents != null ? String(totalCents) : "0";
              btn.dataset.price = perYdDollars ? perYdDollars.toFixed(2) : "0";
              btn.dataset.yards = yards != null ? String(yards) : "0";
              btn.dataset.sellerId = item.seller_id || "";
              btn.dataset.sellerName = sellerLabel;
              btn.dataset.photo = firstImg;

              if(!canBuy){
                btn.disabled = true;
                btn.textContent = isSold ? "Sold out" : "Unavailable";
              }
            }

            grid.appendChild(card);
          });
        }catch(err){
          console.warn("New listings fetch exception:", err);
        }
      }

      loadNewListings();

      // Hero CTAs visibility based on session (header session handled in hm-shell)
      const heroAuthCtas = document.getElementById('heroAuthCtas');
      if(supabaseClient && heroAuthCtas){
        async function syncHero(){
          try{
            const { data:{ session } } = await supabaseClient.auth.getSession();
            const user = session && session.user;
            if(user) heroAuthCtas.classList.add("is-hidden");
            else     heroAuthCtas.classList.remove("is-hidden");
          }catch(e){
            console.warn("Home hero session check failed:", e);
          }
        }
        syncHero();
        supabaseClient.auth.onAuthStateChange((_event, session)=>{
          const user = session && session.user;
          if(user) heroAuthCtas.classList.add("is-hidden");
          else     heroAuthCtas.classList.remove("is-hidden");
        });
      }
    })();
  </script>

  <!-- Cart hooks -->
  <script src="scripts/cart.js"></script>
  <script src="scripts/cart-hooks.js"></script>
  <script src="assets/add-to-cart.js" defer></script>
</body>
</html>
