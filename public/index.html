<style>
/* Minimal visual state in case your CSS doesn't already style selection */
.hm-color-selected {
  outline: 2px solid var(--hm-accent, #991b1b);
  outline-offset: 2px;
  box-shadow: 0 0 0 2px rgba(153,27,27,.12);
  border-radius: 6px;
}
</style>

<script>
/* ===========================================================
   Make COLOR selectable on the home page and push to browse.
   This is defensive and won't change your layout or handlers.
   =========================================================== */
(function () {
  // Find a reasonable container for the color chips
  const colorRoot =
    document.getElementById('colorPanel') ||
    document.getElementById('colorFamilies') ||
    document.querySelector('[data-panel="colorPanel"]') ||
    document.querySelector('#panelStack #colorPanel') ||
    document.querySelector('[aria-label="Filter by color family"]');

  if (!colorRoot) return; // no color UI present

  // Helper: find all swatches inside the color area
  function allSwatches() {
    return Array.from(
      colorRoot.querySelectorAll(
        '.sw, [data-color], [data-color-name], .color-chip, [role="button"][aria-label]'
      )
    );
  }

  // Extract a human color name for a swatch
  function getName(el) {
    const tip = el.querySelector('.tip');
    const val =
      (el.getAttribute('data-color-name') || '').trim() ||
      (tip ? tip.textContent.trim() : '') ||
      (el.getAttribute('title') || '').trim() ||
      (el.getAttribute('aria-label') || '').trim() ||
      (el.textContent || '').trim();
    return val;
  }

  // Selection state helpers
  function isSelected(el) {
    return (
      el.classList.contains('hm-color-selected') ||
      el.getAttribute('data-selected') === 'true' ||
      el.getAttribute('aria-pressed') === 'true'
    );
  }
  function setSelected(el, on) {
    el.classList.toggle('hm-color-selected', on);
    el.setAttribute('data-selected', on ? 'true' : 'false');
    el.setAttribute('aria-pressed', on ? 'true' : 'false');
  }

  // Make swatches focusable buttons (no visual/layout change)
  allSwatches().forEach((el) => {
    if (!el.hasAttribute('tabindex')) el.setAttribute('tabindex', '0');
    if (!el.hasAttribute('role')) el.setAttribute('role', 'button');
    if (!el.hasAttribute('aria-pressed')) el.setAttribute('aria-pressed', 'false');
  });

  // Toggle selection on click/Enter/Space (event delegation)
  colorRoot.addEventListener('click', (e) => {
    const sw = e.target.closest('.sw, [data-color], [data-color-name], .color-chip, [role="button"][aria-label]');
    if (!sw || !colorRoot.contains(sw)) return;
    setSelected(sw, !isSelected(sw));
  });
  colorRoot.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const sw = e.target.closest('.sw, [data-color], [data-color-name], .color-chip, [role="button"][aria-label]');
    if (!sw || !colorRoot.contains(sw)) return;
    e.preventDefault();
    setSelected(sw, !isSelected(sw));
  });

  // Read selected colors
  function readSelectedColors() {
    return allSwatches()
      .filter(isSelected)
      .map(getName)
      .map((s) => s && s.toLowerCase())
      .filter(Boolean);
  }

  // Apply to URL helper
  function goToBrowse(extraParamsFromForm) {
    const url = new URL('browse.html', location);
    const params = new URLSearchParams();

    // Include search query if present
    const q = (extraParamsFromForm && extraParamsFromForm.q) || '';
    if (q) params.set('q', q);

    // Add color(s)
    const colors = readSelectedColors();
    if (colors.length) params.set('color', colors.join(','));

    url.search = params.toString();
    location.href = url.toString();
  }

  // Wire into the main Search submit
  const searchForm = document.getElementById('homeSearch');
  if (searchForm) {
    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const fd = new FormData(searchForm);
      const type = String(fd.get('type') || 'listings').toLowerCase();
      const q = String(fd.get('q') || '').trim();

      if (type === 'users') {
        const url = new URL('favorites.html', location);
        if (q) url.search = new URLSearchParams({ q }).toString();
        location.href = url.toString();
      } else {
        goToBrowse({ q });
      }
    }, { capture: true });
  }

  // Wire into the hero "Apply" button if present
  const applyBtn =
    document.getElementById('applyAll') ||
    document.querySelector('.global-actions .btn-primary');
  if (applyBtn) {
    applyBtn.addEventListener('click', () => goToBrowse(), { capture: true });
  }

  // Pre-select if color is already in URL (supports multiple comma-separated)
  (function hydrateFromURL() {
    const urlColors = (new URL(location.href)).searchParams.get('color');
    if (!urlColors) return;
    const wanted = urlColors
      .split(',')
      .map((s) => s.trim().toLowerCase())
      .filter(Boolean);
    if (!wanted.length) return;

    allSwatches().forEach((el) => {
      const nm = getName(el).toLowerCase();
      if (nm && wanted.includes(nm)) setSelected(el, true);
    });
  })();
})();
</script>
