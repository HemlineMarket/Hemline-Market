// /api/shippo/purchase_label.js
// Returns a shipping label PDF for a given orderId
// ENV: SHIPPO_API_KEY

export const config = {
  api: {
    bodyParser: false, // binary response
  },
};

export default async function handler(req, res) {
  if (req.method !== "GET") {
    res.setHeader("Allow", "GET");
    return res.status(405).json({ error: "Method Not Allowed" });
  }

  try {
    const token = process.env.SHIPPO_API_KEY;
    if (!token) {
      return res.status(500).json({ error: "Missing SHIPPO_API_KEY" });
    }

    const { orderId } = req.query;
    if (!orderId) {
      return res.status(400).json({ error: "Missing orderId" });
    }

    // ðŸ”¹ In production: look up the transaction ID from your DB by orderId.
    // For now, assume transaction id was stored in metadata = orderId
    const txResp = await fetch(
      `https://api.goshippo.com/transactions/?metadata=${encodeURIComponent(orderId)}`,
      {
        headers: {
          Authorization: `ShippoToken ${token}`,
          "Content-Type": "application/json",
        },
      }
    );

    if (!txResp.ok) {
      const txt = await txResp.text();
      throw new Error(`Shippo transaction lookup failed: ${txt}`);
    }

    const txData = await txResp.json();
    if (!txData.results || txData.results.length === 0) {
      return res.status(404).json({ error: "No label found for this order" });
    }

    // Take the first matching label
    const labelUrl = txData.results[0].label_url;
    if (!labelUrl) {
      return res.status(404).json({ error: "Label not ready" });
    }

    // Fetch the actual PDF
    const pdfResp = await fetch(labelUrl);
    if (!pdfResp.ok) {
      throw new Error("Failed to fetch label PDF");
    }

    const buf = Buffer.from(await pdfResp.arrayBuffer());

    res.setHeader("Content-Type", "application/pdf");
    res.setHeader(
      "Content-Disposition",
      `attachment; filename="${orderId}-label.pdf"`
    );
    res.status(200).send(buf);
  } catch (err) {
    console.error("purchase_label error:", err);
    res
      .status(500)
      .json({ error: "Could not retrieve label", details: err.message });
  }
}
