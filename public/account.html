// public/scripts/account-auth.js
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

// ---- CONFIG ----
const SUPABASE_URL = "https://clkizksbvxjkoatdajgd.supabase.co";
const SUPABASE_ANON =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

// Small layout fix so cards don't stretch weirdly in grids
document.addEventListener("DOMContentLoaded", () => {
  const grid = document.querySelector(".grid");
  if (grid) {
    grid.querySelectorAll(":scope > *").forEach((el) => {
      el.style.alignSelf = "flex-start";
    });
  }
});

// ---- ELEMENTS ----

// Auth drawer
const modal = document.getElementById("authOverlay");
const closeBtn = document.getElementById("authCloseBtn");

// Header
const loginHeaderBtn = document.getElementById("loginHeaderBtn");
const headerUser = document.getElementById("headerUser");

// Account layout
const accountGrid = document.getElementById("accountGrid");
const accountLoggedOut = document.getElementById("accountLoggedOut");
const accountLoginBtn = document.getElementById("accountLoginBtn");

// Profile summary
const profileAvatar = document.getElementById("profileAvatar");
const profileNameEl = document.getElementById("profileName");
const profileEmailEl = document.getElementById("profileEmail");
const profileLocationEl = document.getElementById("profileLocation");
const profileBioEl = document.getElementById("profileBio");

// Profile actions
const editPhotoBtn = document.getElementById("editPhotoBtn");
const photoInput = document.getElementById("photoInput");
const editProfileBtn = document.getElementById("editProfileBtn");
const logoutBtn = document.getElementById("logoutBtn");

// Inline profile edit panel
const profileEditPanel = document.getElementById("profileEditPanel");
const editNameInput = document.getElementById("editNameInput");
const editLocationInput = document.getElementById("editLocationInput");
const editBioInput = document.getElementById("editBioInput");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const cancelProfileBtn = document.getElementById("cancelProfileBtn");

// Vacation switch
const vacSwitch = document.getElementById("vacSwitch");

// Auth forms
const loginForm = document.getElementById("loginForm");
const signupForm = document.getElementById("signupForm");
const googleBtn = document.getElementById("googleBtn");
const appleBtn = document.getElementById("appleBtn");
const forgotPasswordBtn = document.getElementById("forgotPasswordBtn");

const errBox = document.getElementById("authError");
const msgBox = document.getElementById("authMessage");

// ---- STATE ----
let currentUser = null;

// ---- HELPERS ----
function clearMessages() {
  if (errBox) errBox.textContent = "";
  if (msgBox) msgBox.textContent = "";
}

function setError(msg) {
  if (errBox) errBox.textContent = msg || "";
}

function setMessage(msg) {
  if (msgBox) msgBox.textContent = msg || "";
}

function show(el, display = "block") {
  if (el) el.style.display = display;
}

function hide(el) {
  if (el) el.style.display = "none";
}

// Initials: prefer full_name/display_name, fall back to email
function getInitials(user) {
  const meta = user?.user_metadata || {};
  const display = (meta.full_name || meta.display_name || "").trim();
  let source = display;

  if (!source && user?.email) {
    const local = user.email.split("@")[0];
    source = local;
  }

  if (!source) return "HM";

  const parts = source.split(/\s+/);
  const first = parts[0]?.[0] || "";
  const last = parts.length > 1 ? parts[parts.length - 1]?.[0] || "" : "";
  const letters = (first + last).toUpperCase();
  return letters || "HM";
}

// Avatar storage key per user
function avatarKeyFor(user) {
  if (!user?.id) return null;
  return `hm-avatar-${user.id}`;
}

function saveAvatar(user, dataUrl) {
  const key = avatarKeyFor(user);
  if (!key) return;
  try {
    localStorage.setItem(key, dataUrl);
  } catch (e) {
    console.warn("Could not save avatar to localStorage", e);
  }
}

function loadAvatar(user) {
  const key = avatarKeyFor(user);
  if (!key) return;
  const dataUrl = localStorage.getItem(key);
  if (!dataUrl) return;
  if (profileAvatar) {
    profileAvatar.style.backgroundImage = `url(${dataUrl})`;
    profileAvatar.textContent = "";
  }
}

// ---- MODAL ----
function showModal() {
  if (!modal) return;
  modal.classList.add("show");
  clearMessages();
}

function hideModal() {
  if (!modal) return;
  modal.classList.remove("show");
  clearMessages();
}

// ---- HEADER STATE ----
function applyLoggedOutHeader() {
  if (headerUser) headerUser.classList.add("is-hidden");
  if (loginHeaderBtn) {
    loginHeaderBtn.classList.remove("is-hidden");
  }
}

function applyLoggedInHeader(user) {
  const initials = getInitials(user);
  if (headerUser) {
    headerUser.textContent = initials;
    headerUser.style.backgroundImage = "";
    headerUser.classList.remove("is-hidden");
  }
  if (loginHeaderBtn) {
    loginHeaderBtn.classList.add("is-hidden");
  }
}

// ---- ACCOUNT STATE ----
function setLoggedOutUI() {
  hide(accountGrid);
  show(accountLoggedOut, "block");
  applyLoggedOutHeader();
  if (logoutBtn) hide(logoutBtn);
}

function setLoggedInUI(user) {
  show(accountGrid, "block");
  hide(accountLoggedOut);
  applyLoggedInHeader(user);
  if (logoutBtn) show(logoutBtn, "inline-block");
}

// ---- PROFILE BINDING ----
function fillProfileSummary(user) {
  const meta = user?.user_metadata || {};
  const email = user?.email || "";

  const fullMetaName = (meta.full_name || meta.display_name || "").trim();
  const nameToShow = fullMetaName || email || "Hemline Market member";

  if (profileNameEl) profileNameEl.textContent = nameToShow;
  if (profileEmailEl) profileEmailEl.textContent = email;

  const loc = (meta.location || "").trim();
  if (profileLocationEl) {
    profileLocationEl.textContent = loc || "Add your location";
    profileLocationEl.classList.toggle("muted", !loc);
  }

  const bio = (meta.bio || "").trim();
  if (profileBioEl) {
    profileBioEl.textContent = bio || "Tell buyers what you love to sew.";
    profileBioEl.classList.toggle("muted", !bio);
  }

  if (profileAvatar && !profileAvatar.style.backgroundImage) {
    profileAvatar.textContent = getInitials(user);
  }
}

function fillProfileEditForm(user) {
  const meta = user?.user_metadata || {};
  const fullMetaName = (meta.full_name || meta.display_name || "").trim();
  const loc = (meta.location || "").trim();
  const bio = (meta.bio || "").trim();

  if (editNameInput) editNameInput.value = fullMetaName || "";
  if (editLocationInput) editLocationInput.value = loc || "";
  if (editBioInput) editBioInput.value = bio || "";
}

// ---- AUTH EVENTS ----

// Header login button opens overlay instead of going away
if (loginHeaderBtn) {
  loginHeaderBtn.addEventListener("click", (e) => {
    // keep href as fallback, but prefer overlay
    e.preventDefault();
    showModal();
  });
}

if (accountLoginBtn) {
  accountLoginBtn.addEventListener("click", () => {
    showModal();
  });
}

if (closeBtn) {
  closeBtn.addEventListener("click", () => {
    hideModal();
  });
}

// Email/password login
if (loginForm) {
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearMessages();

    const email = document.getElementById("loginEmail")?.value.trim();
    const pw = document.getElementById("loginPassword")?.value.trim();

    if (!email || !pw) {
      setError("Please enter your email and password.");
      return;
    }

    const { error } = await supabase.auth.signInWithPassword({
      email,
      password: pw,
    });

    if (error) {
      const msg = error.message.toLowerCase();
      if (msg.includes("invalid login")) {
        setError("Incorrect email or password. Please try again.");
      } else {
        setError(error.message);
      }
      return;
    }

    setMessage("Welcome back to Hemline Market!");
    setTimeout(() => {
      window.location.href = "/";
    }, 700);
  });
}

// Signup
if (signupForm) {
  signupForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearMessages();

    const name = document.getElementById("signupName")?.value.trim();
    const email = document.getElementById("signupEmail")?.value.trim();
    const pw = document.getElementById("signupPassword")?.value.trim();

    if (!name || !email || !pw) {
      setError("Please fill in name, email, and password.");
      return;
    }

    const { error } = await supabase.auth.signUp({
      email,
      password: pw,
      options: {
        data: {
          full_name: name,
          display_name: name,
        },
      },
    });

    if (error) {
      setError(error.message);
      return;
    }

    setMessage(
      "Account created! Check your email to confirm, then log in to start selling your fabric."
    );
  });
}

// Forgot password
if (forgotPasswordBtn) {
  forgotPasswordBtn.addEventListener("click", async () => {
    clearMessages();

    const email = document.getElementById("loginEmail")?.value.trim();
    if (!email) {
      setError("Please enter your email first.");
      return;
    }

    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.origin + "/reset.html",
    });

    if (error) {
      setError(error.message);
      return;
    }

    setMessage("If an account exists for that email, a reset link has been sent.");
  });
}

// Google OAuth
if (googleBtn) {
  googleBtn.addEventListener("click", async () => {
    clearMessages();
    const { error } = await supabase.auth.signInWithOAuth({
      provider: "google",
      options: {
        redirectTo: window.location.origin + "/",
      },
    });
    if (error) setError(error.message);
  });
}

// Apple OAuth
if (appleBtn) {
  appleBtn.addEventListener("click", async () => {
    clearMessages();
    const { error } = await supabase.auth.signInWithOAuth({
      provider: "apple",
      options: {
        redirectTo: window.location.origin + "/",
      },
    });
    if (error) setError(error.message);
  });
}

// Log out
if (logoutBtn) {
  logoutBtn.addEventListener("click", async () => {
    clearMessages();
    await supabase.auth.signOut();
    window.location.href = "/";
  });
}

// ---- PROFILE EDIT ----
if (editProfileBtn && profileEditPanel) {
  editProfileBtn.addEventListener("click", () => {
    if (!currentUser) {
      showModal();
      return;
    }
    fillProfileEditForm(currentUser);
    show(profileEditPanel, "block");
  });
}

if (cancelProfileBtn && profileEditPanel) {
  cancelProfileBtn.addEventListener("click", () => {
    hide(profileEditPanel);
  });
}

if (saveProfileBtn) {
  saveProfileBtn.addEventListener("click", async () => {
    if (!currentUser) {
      showModal();
      return;
    }

    const newName = editNameInput?.value.trim() || "";
    const newLoc = editLocationInput?.value.trim() || "";
    const newBio = editBioInput?.value.trim() || "";

    const meta = currentUser.user_metadata || {};

    const updatedMeta = {
      ...meta,
      full_name: newName || null,
      display_name: newName || null,
      location: newLoc || null,
      bio: newBio || null,
    };

    try {
      const { data, error } = await supabase.auth.updateUser({
        data: updatedMeta,
      });

      if (error) {
        console.error("Error saving profile:", error);
        alert("There was a problem saving your profile. Please try again.");
        return;
      }

      currentUser = data.user;
      fillProfileSummary(currentUser);
      loadAvatar(currentUser);
      hide(profileEditPanel);
    } catch (e) {
      console.error(e);
      alert("There was a problem saving your profile. Please try again.");
    }
  });
}

// ---- AVATAR PHOTO UPLOAD ----
if (editPhotoBtn && photoInput) {
  editPhotoBtn.addEventListener("click", () => {
    if (!currentUser) {
      showModal();
      return;
    }
    photoInput.click();
  });

  photoInput.addEventListener("change", () => {
    const file = photoInput.files?.[0];
    if (!file) return;
    if (!file.type.startsWith("image/")) {
      alert("Please choose an image file.");
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      if (!currentUser) return;
      const dataUrl = reader.result;

      if (profileAvatar) {
        profileAvatar.style.backgroundImage = `url(${dataUrl})`;
        profileAvatar.textContent = "";
      }
      saveAvatar(currentUser, dataUrl);
    };
    reader.readAsDataURL(file);
  });
}

// ---- VACATION SWITCH (visual only) ----
if (vacSwitch) {
  vacSwitch.addEventListener("click", () => {
    const val = vacSwitch.getAttribute("data-on") === "true";
    vacSwitch.setAttribute("data-on", val ? "false" : "true");
  });
}

// ---- INITIAL LOAD ----
(async () => {
  try {
    const { data } = await supabase.auth.getSession();
    const sessionUser = data?.session?.user || null;

    if (!sessionUser) {
      setLoggedOutUI();
      return;
    }

    currentUser = sessionUser;
    setLoggedInUI(currentUser);
    fillProfileSummary(currentUser);
    loadAvatar(currentUser);
  } catch (e) {
    console.error("Error getting session:", e);
    setLoggedOutUI();
  }
})();
