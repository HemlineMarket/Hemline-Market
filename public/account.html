<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Account ‚Äî Hemline Market</title>

  <!-- Shared styles (same stack as universal pages) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
    }
    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }
    img,svg,canvas,video{max-width:100%;height:auto;display:block}
    .is-hidden{display:none!important;}

    /* ---------- ACCOUNT PAGE LAYOUT ---------- */

    main.account-wrap{
      max-width:1200px;
      margin:18px auto 24px;
      padding:0 12px;
    }

    h1.account-title{
      margin:0 0 4px;
      font-size:26px;
      font-weight:800;
      letter-spacing:.03em;
    }
    .account-subtitle{
      margin:0 0 18px;
      color:var(--hm-muted);
      font-size:14px;
    }

    /* Card shell */
    .hm-card{
      background:#fff;
      border-radius:14px;
      border:1px solid var(--hm-border);
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      margin-bottom:16px;
    }
    .hm-card-header{
      padding:10px 16px;
      border-bottom:1px solid var(--hm-border);
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#9ca3af;
      font-weight:600;
    }
    .hm-card-body{
      padding:16px;
    }

    /* Profile layout */
    .profile-row{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:flex-start;
    }
    /* Hide avatar on account page */
    .profile-avatar{
      display:none;
    }
    .profile-main{
      flex:1;
      min-width:220px;
      font-size:14px;
    }
    .profile-main-name{
      font-weight:700;
      font-size:16px;
      margin-bottom:2px;
    }
    .profile-main-email{
      color:var(--hm-muted);
      font-size:13px;
      margin-bottom:6px;
    }
    .profile-main-extra{
      font-size:13px;
      line-height:1.4;
      white-space:pre-line;
    }
    .profile-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:16px;
    }
    .pill-link{
      flex:1 1 140px;
      min-width:140px;
      max-width:260px;
      border-radius:999px;
      border:1px solid var(--hm-border);
      background:#fff;
      padding:10px 14px;
      text-decoration:none;
      display:flex;
      flex-direction:column;
      justify-content:center;
      box-shadow:0 4px 12px rgba(15,23,42,.04);
    }
    .pill-link-title{
      font-size:13px;
      font-weight:700;
      color:#111827;
    }
    .pill-link-sub{
      font-size:12px;
      color:#6b7280;
      margin-top:2px;
    }

    .btn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--hm-border);
      background:#fff;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-primary{
      border-color:var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      box-shadow:0 2px 10px rgba(153,27,27,.28);
    }

    /* Profile incomplete warning */
    .profile-warning{
      display:flex;
      align-items:center;
      gap:16px;
      padding:16px 20px;
      background:#fef3c7;
      border-bottom:1px solid #fcd34d;
      flex-wrap:wrap;
    }
    .profile-warning.is-hidden{
      display:none;
    }
    .warning-icon{
      font-size:24px;
    }
    .warning-content{
      flex:1;
      min-width:200px;
    }
    .warning-content strong{
      display:block;
      color:#92400e;
      font-size:14px;
    }
    .warning-content p{
      margin:4px 0 0;
      font-size:13px;
      color:#a16207;
    }

    /* Payouts */
    .payout-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      font-size:13px;
    }
    .payout-copy{
      max-width:640px;
    }
    .payout-copy strong{
      display:block;
      font-size:14px;
      margin-bottom:3px;
    }
    .hint{
      font-size:12px;
      color:var(--hm-muted);
      margin-top:6px;
    }
    .payout-side{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      min-width:180px;
    }
    .inline-note{
      font-size:12px;
      color:var(--hm-muted);
      max-width:220px;
      text-align:right;
    }

    /* Address + forms */
    .address-block{
      font-size:13px;
      white-space:pre-line;
      color:#111827;
      margin-bottom:10px;
    }

    .field-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:8px;
    }
    .field{
      flex:1 1 140px;
      min-width:140px;
      display:flex;
      flex-direction:column;
      gap:3px;
      font-size:13px;
    }
    .field label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#6b7280;
      font-weight:600;
    }
    .field input,
    .field textarea,
    .field select{
      padding:7px 9px;
      border-radius:10px;
      border:1px solid var(--hm-border);
      font:inherit;
      font-size:13px;
      background:#f9fafb;
    }
    .field textarea{
      resize:vertical;
      min-height:70px;
    }
    .form-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
    }

    .muted-small{
      font-size:12px;
      color:var(--hm-muted);
      margin-top:6px;
    }

    .field-error{
      font-size:12px;
      color:#b91c1c;
      margin-top:2px;
    }

    /* Vacation + security */
    .toggle-row{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
    }

    /* Simple inline editor panels */
    .editor-panel{
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid #f3f4f6;
    }

    /* Small-screen tweaks */
    @media (max-width:700px){
      .payout-row{flex-direction:column;align-items:flex-start;}
      .profile-row{flex-direction:row;}
      .pill-link{max-width:none;}
      .payout-side{align-items:flex-start;}
      .inline-note{text-align:left;}
    }
  </style>
</head>
<body>

  <!-- Universal header placeholder -->
  <div id="hm-shell-header"></div>

  <main class="account-wrap" id="maincontent">
    <h1 class="account-title">Account</h1>
    <p class="account-subtitle">
      Manage your profile, payouts, shipping, vacation hold, and security.
    </p>

    <!-- PROFILE CARD -->
    <section class="hm-card" aria-labelledby="profileHeading">
      <div class="hm-card-header" id="profileHeading">Profile</div>
      
      <!-- Incomplete profile warning -->
      <div class="profile-warning is-hidden" id="profileWarning">
        <div class="warning-icon">‚ö†Ô∏è</div>
        <div class="warning-content">
          <strong>Complete your profile to buy or sell</strong>
          <p>Please add your name, contact email, and shipping address before you can make purchases or list items for sale.</p>
        </div>
        <button class="btn btn-primary" type="button" id="btnCompleteProfile">Complete Profile</button>
      </div>
      
      <div class="hm-card-body">
        <div class="profile-row">
          <div class="profile-avatar" id="profileAvatar">HM</div>
          <div class="profile-main">
            <div class="profile-main-name" id="profileName">Hemline member</div>
            <div class="profile-main-email" id="profileEmail">you@example.com</div>
            <div class="profile-main-extra" id="profileExtra">
              <!-- store name + bio will appear here -->
            </div>

            <div class="profile-actions">
              <button class="btn" type="button" id="btnEditProfile">Edit profile</button>
              <button class="btn" type="button" id="btnLogout">Log out</button>
            </div>
          </div>
        </div>

        <!-- Pills row -->
        <div class="pill-row" aria-label="Account quick links">
          <a class="pill-link" href="purchases.html">
            <span class="pill-link-title">Purchases</span>
            <span class="pill-link-sub">View your buying history</span>
          </a>
          <a class="pill-link" href="sales.html">
            <span class="pill-link-title">Sales</span>
            <span class="pill-link-sub">Manage your sales orders</span>
          </a>
          <a class="pill-link" href="messages.html">
            <span class="pill-link-title">Messages</span>
            <span class="pill-link-sub">Talk with buyers and sellers</span>
          </a>
          <a class="pill-link" href="favorites.html">
            <span class="pill-link-title">Favorites</span>
            <span class="pill-link-sub">Saved fabrics you like</span>
          </a>
          <a class="pill-link" href="atelier.html">
            <span class="pill-link-title">Your Atelier</span>
            <span class="pill-link-sub">Manage your fabric listings</span>
          </a>
        </div>

        <!-- PROFILE EDITOR -->
        <section class="editor-panel is-hidden" id="profileEditor" aria-label="Edit profile">
          <form id="profileForm">
            <div class="field-row">
              <div class="field">
                <label for="firstName">First name</label>
                <input id="firstName" name="firstName" type="text" autocomplete="given-name">
              </div>
              <div class="field">
                <label for="lastName">Last name</label>
                <input id="lastName" name="lastName" type="text" autocomplete="family-name">
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="contactEmail">Contact email <span style="color:#991b1b;">*</span></label>
                <input id="contactEmail" name="contactEmail" type="email" placeholder="your@email.com" autocomplete="email">
                <p class="muted-small">Required for order confirmations, shipping updates, and purchase protection. This won't be shared publicly.</p>
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="storeName">Store name</label>
                <input id="storeName" name="storeName" type="text" placeholder="Aurora Atelier, Espresso Studio‚Ä¶">
                <p class="muted-small" id="storeNameHint">
                  This becomes your shop link. Use letters, numbers, spaces, apostrophes, and hyphens. No emojis or extra symbols.
                </p>
                <p class="muted-small" id="storeSlugPreviewRow">
                  Store link preview:
                  <code>hemline.market/shop/<span id="storeSlugPreview">your-shop</span></code>
                </p>
                <p class="field-error" id="storeNameError"></p>
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="bio">Short bio</label>
                <textarea id="bio" name="bio" placeholder="Tell buyers about your sourcing and sewing style."></textarea>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" type="submit">Save profile</button>
              <button class="btn" type="button" id="cancelProfileEdit">Cancel</button>
            </div>
            <p class="muted-small">
              Profile details appear on your Atelier page. Shipping address and payouts stay private.
            </p>
          </form>
        </section>
      </div>
    </section>

    <!-- PAYOUTS (REAL STRIPE DASHBOARD BUTTON) -->
    <section class="hm-card" aria-labelledby="payoutHeading">
      <div class="hm-card-header" id="payoutHeading">Payouts</div>
      <div class="hm-card-body">
        <div class="payout-row">
          <div class="payout-copy">
            <strong>Payouts &amp; payments</strong>
            <span>
              Stripe powers payments and payouts for your shop using a secure Stripe Express account.
              Hemline Market doesn‚Äôt see your full bank or card details.
            </span>
            <p class="hint">
              Use the button on the right to open your Stripe Express dashboard. There you can update
              bank details, tax information, and payout settings.
            </p>
          </div>
          <div class="payout-side">
            <button class="btn btn-primary" type="button" id="btnStripe">
              Manage Stripe payouts
            </button>
            <div class="inline-note" id="stripeNote"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- SHIPPING ADDRESS -->
    <section class="hm-card" aria-labelledby="addressHeading">
      <div class="hm-card-header" id="addressHeading">Shipping address</div>
      <div class="hm-card-body">
        <h3 style="margin:0 0 4px;font-size:14px;font-weight:700;">Ship-from address</h3>
        <p class="muted-small" style="margin-top:0;">
          This address prints on prepaid labels for your fabric sales and purchases.
        </p>

        <div class="address-block" id="addressDisplay">
          Add your ship-from name and address.
        </div>

        <button class="btn" type="button" id="btnEditAddress">Edit address</button>

        <section class="editor-panel is-hidden" id="addressEditor" aria-label="Edit shipping address">
          <form id="addressForm">
            <div class="field-row">
              <div class="field">
                <label for="addrName">Name</label>
                <input id="addrName" name="addrName" type="text" autocomplete="name">
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="addrLine1">Street address</label>
                <input id="addrLine1" name="addrLine1" type="text" autocomplete="address-line1">
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="addrLine2">Apartment, suite, etc.</label>
                <input id="addrLine2" name="addrLine2" type="text" autocomplete="address-line2">
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="addrCity">City</label>
                <input id="addrCity" name="addrCity" type="text" autocomplete="address-level2">
              </div>
              <div class="field">
                <label for="addrState">State</label>
                <input id="addrState" name="addrState" type="text" autocomplete="address-level1">
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="addrZip">Postal code</label>
                <input id="addrZip" name="addrZip" type="text" inputmode="numeric" autocomplete="postal-code">
              </div>
              <div class="field">
                <label for="addrCountry">Country</label>
                <select id="addrCountry" name="addrCountry">
                  <option value="United States">United States</option>
                  <option value="">Other</option>
                </select>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" type="submit">Save address</button>
              <button class="btn" type="button" id="cancelAddressEdit">Cancel</button>
            </div>
            <p class="muted-small">
              USPS-style address suggestions can be wired in later from your backend; this form keeps
              your details tidy until then.
            </p>
          </form>
        </section>
      </div>
    </section>

    <!-- STATUS -->
    <section class="hm-card" aria-labelledby="statusHeading">
      <div class="hm-card-header" id="statusHeading">Status</div>
      <div class="hm-card-body">
        <h3 style="margin:0 0 4px;font-size:14px;font-weight:700;">Vacation hold</h3>
        <p class="muted-small" style="margin-top:0;">
          Pause new orders while you‚Äôre away. You‚Äôll still see your messages and history.
        </p>
        <label class="toggle-row">
          <input id="vacationToggle" type="checkbox">
          <span>Turn on vacation hold</span>
        </label>
      </div>
    </section>

    <!-- SECURITY -->
    <section class="hm-card" aria-labelledby="securityHeading">
      <div class="hm-card-header" id="securityHeading">Security</div>
      <div class="hm-card-body">
        <p class="muted-small" style="margin-top:0;">
          Hemline Market passwords must be at least 8 characters and include at least one letter and one number or symbol.
          For now, password changes happen through your email provider‚Äôs reset link for the account you used to sign up.
          We‚Äôll add a dedicated security page later.
        </p>
        <button class="btn" type="button" id="btnChangePassword">Change password</button>
      </div>
    </section>
  </main>

  <!-- Universal footer placeholder -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase (for header + account logic) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Universal shell JS -->
  <script src="scripts/hm-shell.js"></script>

  <!-- Account page logic -->
  <script>
    // Render shell first (this creates window.HM.supabase)
    window.HM && window.HM.renderShell({ currentPage: "account" });

    // Use the shared Supabase client to avoid session conflicts
    var supabaseClient = window.supabase_client || (window.HM && window.HM.supabase);
    if (!supabaseClient) {
      supabaseClient = window.supabase.createClient(
        "https://clkizksbvxjkoatdajgd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI",
        { auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
      );
    }
    window.supabase_client = supabaseClient;

    function initialsFromEmail(email){
      if(!email) return "HM";
      const handle = email.split("@")[0].replace(/[\.\_\-]+/g," ").trim();
      const parts = handle.split(" ").filter(Boolean);
      if(parts.length === 1) return (parts[0][0] + (parts[0][1] || '')).toUpperCase();
      return (parts[0][0] + parts[1][0]).toUpperCase();
    }

    function initialsFromProfile(firstName, lastName, email){
      if(firstName && lastName){
        return (firstName[0] + lastName[0]).toUpperCase();
      }
      if(firstName){
        return (firstName[0] + (firstName[1] || '')).toUpperCase();
      }
      return initialsFromEmail(email);
    }

    // Turn a store name into a URL-safe slug for the shop link
    function slugifyStoreName(raw){
      if(!raw) return "";
      return raw
        .trim()
        .toLowerCase()
        .replace(/['‚Äô]/g, "s")       // Thor's ‚Üí thors
        .replace(/[^a-z0-9]+/g,"-")  // spaces ‚Üí hyphens
        .replace(/^-+|-+$/g,"");     // trim edges
    }

    // Validate store name for use as a link
    function validateStoreName(raw){
      raw = (raw || "").trim();
      if(!raw){
        // Store name is optional; empty is allowed
        return { ok:true, slug:"" };
      }

      // 1) Raw name must only have letters, numbers, spaces, apostrophes, and hyphens
      if(!/^[A-Za-z0-9\s'\-]+$/.test(raw)){
        return {
          ok:false,
          slug:slugifyStoreName(raw),
          message:"Use only letters, numbers, spaces, apostrophes, and hyphens for your store name. Remove other symbols like ! or emoji."
        };
      }

      // 2) Slug must be a sane, URL-safe link
      const slug = slugifyStoreName(raw);
      if(slug.length < 3){
        return {
          ok:false,
          slug,
          message:"Store name is too short. Use at least 3 characters with letters or numbers."
        };
      }
      if(slug.length > 40){
        return {
          ok:false,
          slug,
          message:"Store name is too long. Try 40 characters or fewer."
        };
      }
      if(!/^[a-z0-9\-]+$/.test(slug)){
        return {
          ok:false,
          slug,
          message:"Use only letters, numbers, and hyphens for your store link."
        };
      }
      return { ok:true, slug };
    }

    async function ensureSession({maxWaitMs=3000} = {}){
      let { data:{ session } } = await supabaseClient.auth.getSession();
      if(session?.user) return session;
      const start = Date.now();
      while(!session?.user && Date.now() - start < maxWaitMs){
        await new Promise(r=>setTimeout(r,120));
        ({ data:{ session } } = await supabaseClient.auth.getSession());
      }
      return session;
    }

    (async function initAccount(){
      const session = await ensureSession();
      if(!session || !session.user){
        window.location.href = "auth.html?view=login";
        return;
      }

      const user = session.user;
      const email = user.email || "you@example.com";
      const userId = user.id;

      // LocalStorage keys
      const PROFILE_KEY = "hm_profile_" + userId;
      const ADDRESS_KEY = "hm_address_" + userId;
      const VAC_KEY     = "hm_vacation_" + userId;

      // ‚úÖ NEW: when Account saves an address, also save it in Checkout‚Äôs expected format
      function syncAddressToCheckoutKeys(accountAddr){
        try{
          const checkoutAddr = {
            // checkout.html uses these names
            email: "",
            phone: "",
            name: (accountAddr.addrName || "").trim(),
            line1: (accountAddr.addrLine1 || "").trim(),
            line2: (accountAddr.addrLine2 || "").trim(),
            city:  (accountAddr.addrCity  || "").trim(),
            state: (accountAddr.addrState || "").trim(),
            zip:   (accountAddr.addrZip   || "").trim(),
            country: "US"
          };

          // Write both a global fallback and a user-specific key
          localStorage.setItem("hm_checkout_address", JSON.stringify(checkoutAddr));
          localStorage.setItem("hm_checkout_address_" + userId, JSON.stringify(checkoutAddr));
        }catch(e){
          // ignore
        }
      }

      // Elements
      const profileNameEl        = document.getElementById('profileName');
      const profileEmailEl       = document.getElementById('profileEmail');
      const profileExtraEl       = document.getElementById('profileExtra');
      const profileAvatarEl      = document.getElementById('profileAvatar');
      const profileEditor        = document.getElementById('profileEditor');
      const profileForm          = document.getElementById('profileForm');
      const storeNameInput       = document.getElementById('storeName');
      const storeSlugPreviewEl   = document.getElementById('storeSlugPreview');
      const storeNameErrorEl     = document.getElementById('storeNameError');

      const addressDisplay       = document.getElementById('addressDisplay');
      const addressEditor        = document.getElementById('addressEditor');
      const addressForm          = document.getElementById('addressForm');

      const vacationToggle       = document.getElementById('vacationToggle');

      const stripeBtn            = document.getElementById('btnStripe');
      const stripeNoteEl         = document.getElementById('stripeNote');

      profileEmailEl.textContent = email;

      // ---- Helper: Check if email is Apple relay or looks auto-generated ----
      function isRelayEmail(email) {
        return email && (
          email.includes('@privaterelay.appleid.com') ||
          email.includes('@relay.') ||
          /^[a-z0-9]{8,}@/.test(email) // random string emails
        );
      }

      function isAutoGeneratedName(name) {
        if (!name) return true;
        // Check if name looks like an email prefix or random string
        return /^[a-z0-9]{6,}$/i.test(name) || name === "Hemline member";
      }

      // ---- Load profile from Supabase FIRST, then localStorage as fallback ----
      let profile = {};
      let address = {};
      let supabaseProfile = null;
      
      // Try to load from Supabase profiles table
      try {
        const { data: profileData, error: profileError } = await supabaseClient
          .from('profiles')
          .select('*')
          .eq('id', userId)
          .maybeSingle();
        
        if (!profileError && profileData) {
          supabaseProfile = profileData;
          // Map Supabase profile to our local format - use correct column names!
          profile = {
            firstName: profileData.first_name || '',
            lastName: profileData.last_name || '',
            storeName: profileData.store_name || '',
            bio: profileData.bio || '',
            storeSlug: profileData.store_slug || slugifyStoreName(profileData.store_name || ''),
            contactEmail: profileData.contact_email || ''
          };
          console.log('[Account] Loaded profile from Supabase:', profile);
        }
      } catch (e) {
        console.warn('Error loading profile from Supabase:', e);
      }

      // Also check user_metadata for address and additional info
      const userMeta = user.user_metadata || {};
      if (userMeta.first_name || userMeta.last_name) {
        profile.firstName = profile.firstName || userMeta.first_name || '';
        profile.lastName = profile.lastName || userMeta.last_name || '';
      }
      if (userMeta.shop_name) {
        profile.storeName = profile.storeName || userMeta.shop_name || '';
      }

      // Load address from user_metadata first
      if (userMeta.ship_address1) {
        address = {
          addrName: userMeta.ship_name || '',
          addrLine1: userMeta.ship_address1 || '',
          addrLine2: userMeta.ship_address2 || '',
          addrCity: userMeta.ship_city || '',
          addrState: userMeta.ship_state || '',
          addrZip: userMeta.ship_postal || ''
        };
        console.log('[Account] Loaded address from user_metadata:', address);
      }

      // Fallback to localStorage if Supabase didn't have data
      if (!profile.firstName && !profile.lastName) {
        try {
          const raw = localStorage.getItem(PROFILE_KEY);
          if (raw) {
            const localProfile = JSON.parse(raw) || {};
            profile = { ...localProfile, ...profile }; // Supabase data takes priority
            console.log('[Account] Merged with localStorage profile');
          }
        } catch (e) {
          console.warn("Profile parse failed", e);
        }
      }

      // Fallback address from localStorage
      if (!address.addrLine1) {
        try {
          const rawA = localStorage.getItem(ADDRESS_KEY);
          if (rawA) {
            const localAddr = JSON.parse(rawA) || {};
            address = { ...localAddr, ...address };
          }
        } catch (e) {
          console.warn("Address parse failed", e);
        }
      }

      // ---- Check profile completeness ----
      const hasRealName = profile.firstName && profile.lastName && 
                          !isAutoGeneratedName(profile.firstName) && 
                          !isAutoGeneratedName(profile.lastName);
      const hasAddress = address.addrLine1 && address.addrCity && address.addrState && address.addrZip;
      const hasRelayEmail = isRelayEmail(email);
      const hasContactEmail = profile.contactEmail && !isRelayEmail(profile.contactEmail);
      const isProfileComplete = hasRealName && hasAddress && hasContactEmail;

      // Store completeness globally for other pages to check
      window.HM = window.HM || {};
      window.HM.profileComplete = isProfileComplete;
      window.HM.hasRealName = hasRealName;
      window.HM.hasAddress = hasAddress;
      window.HM.hasContactEmail = hasContactEmail;
      localStorage.setItem('hm_profile_complete', JSON.stringify({
        complete: isProfileComplete,
        hasRealName,
        hasAddress,
        hasContactEmail,
        hasRelayEmail,
        userId
      }));

      // Show warning if incomplete
      const profileWarning = document.getElementById('profileWarning');
      const btnCompleteProfile = document.getElementById('btnCompleteProfile');
      if (profileWarning) {
        if (!isProfileComplete) {
          profileWarning.classList.remove('is-hidden');
          if (btnCompleteProfile) {
            btnCompleteProfile.onclick = () => {
              document.getElementById('btnEditProfile')?.click();
            };
          }
        } else {
          profileWarning.classList.add('is-hidden');
        }
      }

      // Compute display name - show "Add your information" if incomplete
      if(profile.firstName && profile.lastName && !isAutoGeneratedName(profile.firstName)){
        profileNameEl.textContent =
          (profile.firstName || "") + (profile.lastName ? (" " + profile.lastName) : "");
      } else if (hasRelayEmail || isAutoGeneratedName(email.split("@")[0])) {
        profileNameEl.textContent = "Add your information";
        profileNameEl.style.color = "#9ca3af";
        profileNameEl.style.fontStyle = "italic";
      } else {
        profileNameEl.textContent = email.split("@")[0] || "Hemline member";
      }

      // Hide relay email, show prompt instead
      if (hasRelayEmail) {
        profileEmailEl.textContent = "Email hidden ‚Äî add a contact email in your profile";
        profileEmailEl.style.color = "#9ca3af";
        profileEmailEl.style.fontStyle = "italic";
      }

      // Store slug (backfill for old profiles)
      const existingSlug = profile.storeSlug || slugifyStoreName(profile.storeName || "");

      const profileLines = [];
      if(profile.storeName) profileLines.push("Store name: " + profile.storeName);
      if(existingSlug)      profileLines.push("Store link: hemline.market/shop/" + existingSlug);
      if(profile.bio)       profileLines.push(profile.bio);
      profileExtraEl.textContent = profileLines.join("\n");

      // Avatar initials based on profile/email (still computed even if hidden)
      const avatarInitials = initialsFromProfile(profile.firstName, profile.lastName, email);
      profileAvatarEl.style.backgroundImage = "";
      profileAvatarEl.textContent = avatarInitials;

      // Prefill profile form + slug preview
      if(profileForm){
        profileForm.firstName.value = profile.firstName || "";
        profileForm.lastName.value  = profile.lastName  || "";
        const contactEmailInput = document.getElementById('contactEmail');
        if(contactEmailInput) {
          // Default to login email if no contact email set and login email is real
          contactEmailInput.value = profile.contactEmail || (!hasRelayEmail ? email : "");
        }
        if(storeNameInput){
          storeNameInput.value = profile.storeName || "";
        }
        if(storeSlugPreviewEl){
          storeSlugPreviewEl.textContent = existingSlug || "your-shop";
        }
        const bioInput = document.getElementById('bio');
        if(bioInput) bioInput.value = profile.bio || "";
      }

      // Live slug preview as user types (no hard errors until submit)
      if(storeNameInput && storeSlugPreviewEl){
        storeNameInput.addEventListener('input', ()=>{
          const raw  = storeNameInput.value;
          const slug = slugifyStoreName(raw);
          storeSlugPreviewEl.textContent = slug || "your-shop";
          if(storeNameErrorEl) storeNameErrorEl.textContent = "";
          storeNameInput.removeAttribute("aria-invalid");
        });
      }

      // ---- Address display (already loaded above) ----

      // If address name is empty but we have profile name, prefill it
      if(!address.addrName && (profile.firstName || profile.lastName)){
        const dn = (profile.firstName || "") + (profile.lastName ? (" " + profile.lastName) : "");
        if(dn.trim()){
          address.addrName = dn.trim();
          try{
            localStorage.setItem(ADDRESS_KEY, JSON.stringify(address));
          }catch(e){}
        }
      }

      function renderAddress(){
        if(!address || !address.addrLine1){
          addressDisplay.textContent = "Add your ship-from name and address.";
          return;
        }
        const lines = [];
        if(address.addrName)  lines.push(address.addrName);
        let line1 = address.addrLine1;
        if(address.addrLine2) line1 += "\n" + address.addrLine2;
        lines.push(line1);

        let cityLine = "";
        if(address.addrCity)  cityLine += address.addrCity;
        if(address.addrState) cityLine += (cityLine ? ", " : "") + address.addrState;
        if(address.addrZip)   cityLine += (cityLine ? " " : "") + address.addrZip;
        if(cityLine)          lines.push(cityLine);
        if(address.addrCountry) lines.push(address.addrCountry);

        addressDisplay.textContent = lines.join("\n");
      }
      renderAddress();

      // Fill address form safely
      addressForm.addrName.value    = address.addrName    || "";
      addressForm.addrLine1.value   = address.addrLine1   || "";
      addressForm.addrLine2.value   = address.addrLine2   || "";
      addressForm.addrCity.value    = address.addrCity    || "";
      addressForm.addrState.value   = address.addrState   || "";
      addressForm.addrZip.value     = address.addrZip     || "";
      addressForm.addrCountry.value = address.addrCountry || "United States";

      // Vacation toggle
      try{
        const vacRaw = localStorage.getItem(VAC_KEY);
        vacationToggle.checked = vacRaw === "on";
      }catch(e){}

      vacationToggle.addEventListener('change', () => {
        localStorage.setItem(VAC_KEY, vacationToggle.checked ? "on" : "off");
      });

      // ---- Profile button handlers ----
      document.getElementById('btnEditProfile').addEventListener('click', () => {
        profileEditor.classList.remove('is-hidden');
        profileForm.firstName.focus();
      });

      document.getElementById('cancelProfileEdit').addEventListener('click', () => {
        profileEditor.classList.add('is-hidden');
      });

      profileForm.addEventListener('submit', (e)=>{
        e.preventDefault();

        const rawStoreName = (storeNameInput ? storeNameInput.value : "").trim();
        const storeCheck   = validateStoreName(rawStoreName);

        if(!storeCheck.ok){
          if(storeNameErrorEl) storeNameErrorEl.textContent = storeCheck.message;
          if(storeSlugPreviewEl) storeSlugPreviewEl.textContent = storeCheck.slug || "your-shop";
          if(storeNameInput){
            storeNameInput.setAttribute("aria-invalid","true");
            storeNameInput.focus();
          }
          return;
        }else{
          if(storeNameErrorEl) storeNameErrorEl.textContent = "";
          if(storeNameInput) storeNameInput.removeAttribute("aria-invalid");
        }

        const contactEmailInput = document.getElementById('contactEmail');
        const contactEmailValue = contactEmailInput ? contactEmailInput.value.trim() : '';

        const next = {
          firstName: profileForm.firstName.value.trim(),
          lastName:  profileForm.lastName.value.trim(),
          storeName: rawStoreName,
          storeSlug: storeCheck.slug,
          bio:       profileForm.bio.value.trim(),
          contactEmail: contactEmailValue
        };
        localStorage.setItem(PROFILE_KEY, JSON.stringify(next));
        profile = next;

        // ‚úÖ Also update Supabase profiles table so atelier reflects changes
        const fullName = ((next.firstName || "") + " " + (next.lastName || "")).trim();
        if (userId) {
          supabaseClient
            .from("profiles")
            .upsert({
              id: userId,
              first_name: next.firstName || null,
              last_name: next.lastName || null,
              display_name: fullName || null,
              store_name: next.storeName || null,
              store_slug: next.storeSlug || null,
              bio: next.bio || null,
              contact_email: next.contactEmail || null,
            }, { onConflict: 'id' })
            .then(({ error }) => {
              if (error) console.error("Profile sync error:", error);
              else console.log("[Account] Profile saved to Supabase");
            });
          
          // Also update user_metadata for address and cross-device sync
          supabaseClient.auth.updateUser({
            data: {
              first_name: next.firstName || null,
              last_name: next.lastName || null,
              display_name: fullName || null,
              shop_name: next.storeName || null,
            }
          }).then(({ error }) => {
            if (error) console.error("User metadata sync error:", error);
          });
        }

        const displayName =
          (next.firstName || "") + (next.lastName ? (" " + next.lastName) : "");
        profileNameEl.textContent =
          displayName || (email.split("@")[0] || "Hemline member");

        const newLines = [];
        if(next.storeName) newLines.push("Store name: " + next.storeName);
        if(next.storeSlug) newLines.push("Store link: hemline.market/shop/" + next.storeSlug);
        if(next.bio)       newLines.push(next.bio);
        profileExtraEl.textContent = newLines.join("\n");

        const initials = initialsFromProfile(next.firstName, next.lastName, email);
        profileAvatarEl.style.backgroundImage = "";
        profileAvatarEl.textContent = initials;

        if(storeSlugPreviewEl){
          storeSlugPreviewEl.textContent = next.storeSlug || "your-shop";
        }

        if(!address.addrName && displayName.trim()){
          address.addrName = displayName.trim();
          try{
            localStorage.setItem(ADDRESS_KEY, JSON.stringify(address));
          }catch(e){}
          addressForm.addrName.value = address.addrName;
          renderAddress();
        }

        profileEditor.classList.add('is-hidden');
      });

      // ---- Address editor ----
      document.getElementById('btnEditAddress').addEventListener('click', ()=>{
        addressEditor.classList.remove('is-hidden');
        addressForm.addrName.focus();
      });

      document.getElementById('cancelAddressEdit').addEventListener('click', ()=>{
        addressEditor.classList.add('is-hidden');
      });

      // ‚úÖ MODIFIED: also sync the checkout address keys when saving from Account
      addressForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const next = {
          addrName:  addressForm.addrName.value.trim(),
          addrLine1: addressForm.addrLine1.value.trim(),
          addrLine2: addressForm.addrLine2.value.trim(),
          addrCity:  addressForm.addrCity.value.trim(),
          addrState: addressForm.addrState.value.trim(),
          addrZip:   addressForm.addrZip.value.trim(),
          addrCountry: addressForm.addrCountry.value || "United States"
        };
        localStorage.setItem(ADDRESS_KEY, JSON.stringify(next));

        // üî• THIS is the fix: make checkout read the updated address
        syncAddressToCheckoutKeys(next);

        // ‚úÖ Also sync to Supabase user_metadata for cross-device sync
        try {
          await supabaseClient.auth.updateUser({
            data: {
              ship_name: next.addrName || null,
              ship_address1: next.addrLine1 || null,
              ship_address2: next.addrLine2 || null,
              ship_city: next.addrCity || null,
              ship_state: next.addrState || null,
              ship_postal: next.addrZip || null,
              ship_country: next.addrCountry || 'United States'
            }
          });
          console.log("[Account] Address saved to Supabase user_metadata");
        } catch (err) {
          console.error("Address sync error:", err);
        }

        address = next;
        renderAddress();
        addressEditor.classList.add('is-hidden');
      });

      // ---- Stripe Express button (calls Edge Function) ----
      function setStripeNote(msg){
        if(!stripeNoteEl) return;
        stripeNoteEl.textContent = msg || "";
      }

      if(stripeBtn){
        stripeBtn.addEventListener('click', async ()=>{
          stripeBtn.disabled = true;
          stripeBtn.textContent = "Opening Stripe‚Ä¶";
          setStripeNote("");

          try{
            const { data:{ session } } = await supabaseClient.auth.getSession();
            const accessToken = session?.access_token;
            if(!accessToken){
              setStripeNote("You need to be signed in to manage payouts.");
              stripeBtn.disabled = false;
              stripeBtn.textContent = "Manage Stripe payouts";
              return;
            }

            const resp = await fetch(
              "https://clkizksbvxjkoatdajgd.supabase.co/functions/v1/onboard",
              {
                method:"POST",
                headers:{
                  "Authorization":"Bearer " + accessToken,
                  "Content-Type":"application/json"
                },
                body: JSON.stringify({})
              }
            );

            if(!resp.ok){
              console.error("Stripe onboard error", resp.status);
              setStripeNote("We couldn‚Äôt open Stripe right now. Please try again in a moment.");
              stripeBtn.disabled = false;
              stripeBtn.textContent = "Manage Stripe payouts";
              return;
            }

            const payload = await resp.json();
            if(payload && payload.url){
              window.location.href = payload.url;
            }else{
              setStripeNote("Stripe link was missing. Please try again.");
              stripeBtn.disabled = false;
              stripeBtn.textContent = "Manage Stripe payouts";
            }
          }catch(err){
            console.error("Stripe onboard exception", err);
            setStripeNote("Something went wrong opening Stripe. Try again.");
            stripeBtn.disabled = false;
            stripeBtn.textContent = "Manage Stripe payouts";
          }
        });
      }

      // ---- Logout + password info ----
      document.getElementById('btnLogout').addEventListener('click', async ()=>{
        await supabaseClient.auth.signOut();
        window.location.href = "auth.html?view=login";
      });

      document.getElementById('btnChangePassword').addEventListener('click', ()=>{
        alert(
          "To change your password, use the reset link sent to the email address you used to sign up. " +
          "Passwords must be at least 8 characters and include at least one letter and one number or symbol."
        );
      });
    })();
  </script>

  <!-- Render universal header/footer shell with current page highlighted -->
  <script>
    window.HM && window.HM.renderShell({ currentPage: "account" });
  </script>
</body>
</html>
