<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Account — Hemline Market</title>

  <!-- Shared styles (same stack as universal pages) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
  <link rel="apple-touch-icon" href="/images/icon.png">
  
  <!-- Cropper.js for avatar cropping -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
    }
    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:
        url("images/homepage.jpeg") center/cover fixed no-repeat,
        var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }
    main img, main svg, main canvas, main video{max-width:100%;height:auto;display:block}
    .is-hidden{display:none!important;}

    /* ---------- ACCOUNT PAGE LAYOUT ---------- */

    main.account-wrap{
      max-width:1200px;
      margin:18px auto 24px;
      padding:0 12px;
    }

    h1.account-title{
      margin:0 0 4px;
      font-size:26px;
      font-weight:800;
      letter-spacing:.03em;
      color:#fff;
      text-shadow:0 2px 8px rgba(0,0,0,.5);
    }
    .account-subtitle{
      margin:0 0 18px;
      color:#111;
      font-size:14px;
      background:rgba(255,255,255,.85);
      display:inline-block;
      padding:4px 10px;
      border-radius:6px;
    }

    /* Card shell */
    .hm-card{
      background:#fff;
      border-radius:14px;
      border:1px solid var(--hm-border);
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      margin-bottom:16px;
    }
    .hm-card-header{
      padding:10px 16px;
      border-bottom:1px solid var(--hm-border);
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#9ca3af;
      font-weight:600;
    }
    .hm-card-body{
      padding:16px;
    }

    /* Profile layout */
    .profile-row{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:flex-start;
    }
    
    /* Profile Avatar Upload Section */
    /* Profile Avatar Upload Section - v2024.12.27 */
    .profile-avatar-section {
      position: relative;
      flex-shrink: 0;
    }
    
    .profile-avatar-circle {
      width: 80px !important;
      height: 80px !important;
      border-radius: 50% !important;
      background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      overflow: hidden !important;
      border: 3px solid rgba(153, 27, 27, 0.2) !important;
      box-shadow: 0 4px 12px rgba(153, 27, 27, 0.15) !important;
      position: relative !important;
      font-size: 0 !important;
      color: transparent !important;
    }
    
    .profile-avatar-placeholder {
      width: 40px;
      height: 40px;
      color: #fff !important;
      position: absolute;
      z-index: 2;
    }
    
    .profile-avatar-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-avatar-img.is-hidden {
      display: none;
    }
    
    .profile-avatar-edit {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #fff;
      background: var(--hm-accent);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: transform 0.15s, background 0.15s;
    }
    
    .profile-avatar-edit:hover {
      background: #7f1d1d;
      transform: scale(1.1);
    }
    
    .profile-avatar-edit svg {
      width: 14px;
      height: 14px;
    }
    
    /* Avatar upload loading state */
    .profile-avatar-section.uploading .profile-avatar-circle {
      opacity: 0.6;
    }
    
    .profile-avatar-section.uploading .profile-avatar-edit {
      pointer-events: none;
    }
    
    /* Crop Modal */
    .crop-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .crop-modal.active {
      display: flex;
    }
    
    .crop-modal-content {
      background: #fff;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .crop-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--hm-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .crop-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    
    .crop-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--hm-muted);
      padding: 0;
      line-height: 1;
    }
    
    .crop-modal-body {
      padding: 20px;
      flex: 1;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f0f0;
    }
    
    .crop-container {
      max-width: 100%;
      max-height: 400px;
    }
    
    .crop-container img {
      max-width: 100%;
      display: block;
    }
    
    .crop-modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--hm-border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    .crop-modal-footer .btn {
      padding: 10px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .crop-modal-footer .btn-cancel {
      background: #f3f4f6;
      border: 1px solid var(--hm-border);
      color: var(--hm-text);
    }
    
    .crop-modal-footer .btn-save {
      background: var(--hm-accent);
      border: none;
      color: #fff;
    }
    
    .crop-modal-footer .btn-save:hover {
      background: #7f1d1d;
    }
    
    /* Hide old avatar on account page */
    .profile-avatar{
      display:none;
    }
    .profile-main{
      flex:1;
      min-width:220px;
      font-size:14px;
    }
    .profile-main-name{
      font-weight:700;
      font-size:16px;
      margin-bottom:2px;
    }
    .profile-main-email{
      color:var(--hm-muted);
      font-size:13px;
      margin-bottom:6px;
    }
    .profile-main-extra{
      font-size:13px;
      line-height:1.4;
      white-space:pre-line;
    }
    .profile-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:16px;
    }
    .pill-link{
      flex:1 1 140px;
      min-width:140px;
      max-width:260px;
      border-radius:999px;
      border:1px solid var(--hm-border);
      background:#fff;
      padding:10px 14px;
      text-decoration:none;
      display:flex;
      flex-direction:column;
      justify-content:center;
      box-shadow:0 4px 12px rgba(15,23,42,.04);
    }
    .pill-link-title{
      font-size:13px;
      font-weight:700;
      color:#111827;
    }
    .pill-link-sub{
      font-size:12px;
      color:#6b7280;
      margin-top:2px;
    }

    .btn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--hm-border);
      background:#fff;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-primary{
      border-color:var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      box-shadow:0 2px 10px rgba(153,27,27,.28);
    }

    /* Profile incomplete warning */
    .profile-warning{
      display:flex;
      align-items:center;
      gap:16px;
      padding:16px 20px;
      background:#fef3c7;
      border-bottom:1px solid #fcd34d;
      flex-wrap:wrap;
    }
    .profile-warning.is-hidden{
      display:none;
    }
    .warning-icon{
      font-size:24px;
    }
    .warning-content{
      flex:1;
      min-width:200px;
    }
    .warning-content strong{
      display:block;
      color:#92400e;
      font-size:14px;
    }
    .warning-content p{
      margin:4px 0 0;
      font-size:13px;
      color:#a16207;
    }

    /* Payouts */
    .payout-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      font-size:13px;
    }
    .payout-copy{
      max-width:640px;
    }
    .payout-copy strong{
      display:block;
      font-size:14px;
      margin-bottom:3px;
    }
    .hint{
      font-size:12px;
      color:var(--hm-muted);
      margin-top:6px;
    }
    .payout-side{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      min-width:180px;
    }
    .inline-note{
      font-size:12px;
      color:var(--hm-muted);
      max-width:220px;
      text-align:right;
    }

    /* Address + forms */
    .address-block{
      font-size:13px;
      white-space:pre-line;
      color:#111827;
      margin-bottom:10px;
    }

    .field-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:8px;
    }
    .field{
      flex:1 1 140px;
      min-width:140px;
      display:flex;
      flex-direction:column;
      gap:3px;
      font-size:13px;
    }
    .field label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#6b7280;
      font-weight:600;
    }
    .field input,
    .field textarea,
    .field select{
      padding:7px 9px;
      border-radius:10px;
      border:1px solid var(--hm-border);
      font:inherit;
      font-size:16px; /* Prevents iOS zoom on focus */
      background:#f9fafb;
    }
    @media (min-width: 768px) {
      .field input,
      .field textarea,
      .field select{
        font-size:13px;
      }
    }
    .field textarea{
      resize:vertical;
      min-height:70px;
    }
    .form-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
    }

    .muted-small{
      font-size:12px;
      color:var(--hm-muted);
      margin-top:6px;
    }

    .field-error{
      font-size:12px;
      color:#b91c1c;
      margin-top:2px;
    }

    /* Vacation + security */
    .toggle-row{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
    }

    /* Simple inline editor panels */
    .editor-panel{
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid #f3f4f6;
    }

    /* Small-screen tweaks */
    @media (max-width:700px){
      .payout-row{flex-direction:column;align-items:flex-start;}
      .profile-row{flex-direction:row;}
      .pill-link{max-width:none;}
      .payout-side{align-items:flex-start;}
      .inline-note{text-align:left;}
    }
  @media(max-width:768px){body{background-position:20% center;}}
  </style>
</head>
<body>

  <!-- Universal header placeholder -->
  <div id="hm-shell-header"></div>

  <main class="account-wrap" id="maincontent">
    <h1 class="account-title">Account</h1>
    <p class="account-subtitle">
      Manage your profile, payouts, shipping, vacation hold, and security.
    </p>

    <!-- PROFILE CARD -->
    <section class="hm-card" aria-labelledby="profileHeading">
      <div class="hm-card-header" id="profileHeading">Profile</div>
      
      <!-- Incomplete profile warning -->
      <div class="profile-warning is-hidden" id="profileWarning">
        <div class="warning-icon">⚠️</div>
        <div class="warning-content">
          <strong>Complete your profile to buy or sell</strong>
          <p id="profileWarningText">Please add your name, contact email, and shipping address before you can make purchases or list items for sale.</p>
        </div>
        <button class="btn btn-primary" type="button" id="btnCompleteProfile">Complete Profile</button>
      </div>
      
      <div class="hm-card-body">
        <div class="profile-row">
          <!-- Profile Photo Upload -->
          <div class="profile-avatar-section" id="profileAvatarSection">
            <div class="profile-avatar-circle" id="profileAvatarCircle">
              <svg class="profile-avatar-placeholder" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4z"/>
                <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
              </svg>
              <img class="profile-avatar-img is-hidden" id="profileAvatarImg" alt="Profile photo" />
            </div>
            <button class="profile-avatar-edit" type="button" id="btnEditAvatar" title="Upload photo">
              <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
            </button>
            <input type="file" id="avatarFileInput" accept="image/*" hidden />
          </div>
          
          <div class="profile-main">
            <div class="profile-main-name" id="profileName">Hemline member</div>
            <div class="profile-main-email" id="profileEmail">you@example.com</div>
            <div class="profile-main-extra" id="profileExtra">
              <!-- store name + bio will appear here -->
            </div>

            <div class="profile-actions">
              <button class="btn" type="button" id="btnEditProfile">Edit profile</button>
              <button class="btn" type="button" id="btnLogout">Log out</button>
            </div>
          </div>
        </div>

        <!-- Pills row -->
        <div class="pill-row" aria-label="Account quick links">
          <a class="pill-link" href="purchases.html">
            <span class="pill-link-title">Purchases</span>
            <span class="pill-link-sub">View your buying history</span>
          </a>
          <a class="pill-link" href="sales.html">
            <span class="pill-link-title">Sales</span>
            <span class="pill-link-sub">Manage your sales orders</span>
          </a>
          <a class="pill-link" href="messages.html">
            <span class="pill-link-title">Messages</span>
            <span class="pill-link-sub">Talk with buyers and sellers</span>
          </a>
          <a class="pill-link" href="favorites.html">
            <span class="pill-link-title">Favorites</span>
            <span class="pill-link-sub">Saved fabrics you like</span>
          </a>
          <a class="pill-link" href="atelier.html">
            <span class="pill-link-title">Your Atelier</span>
            <span class="pill-link-sub">Manage your fabric listings</span>
          </a>
        </div>

        <!-- PROFILE EDITOR -->
        <section class="editor-panel is-hidden" id="profileEditor" aria-label="Edit profile">
          <form id="profileForm">
            <div class="field-row">
              <div class="field">
                <label for="firstName">First name</label>
                <input id="firstName" name="firstName" type="text" autocomplete="given-name">
              </div>
              <div class="field">
                <label for="lastName">Last name</label>
                <input id="lastName" name="lastName" type="text" autocomplete="family-name">
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="contactEmail">Contact email <span style="color:#991b1b;">*</span></label>
                <input id="contactEmail" name="contactEmail" type="email" placeholder="your@email.com" autocomplete="email">
                <p class="muted-small">Required for order confirmations, shipping updates, and purchase protection. This won't be shared publicly.</p>
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="storeName">Store name</label>
                <input id="storeName" name="storeName" type="text" placeholder="Aurora Atelier, Espresso Studio…">
                <p class="muted-small" id="storeNameHint">
                  This becomes your shop link. Use letters, numbers, spaces, apostrophes, and hyphens. No emojis or extra symbols.<br>
                  <strong style="color:#b45309;">⚠️ Store names are unique and permanent once set.</strong> Choose carefully!
                </p>
                <p class="muted-small" id="storeSlugPreviewRow">
                  Store link preview:
                  <code>hemline.market/shop/<span id="storeSlugPreview">your-shop</span></code>
                </p>
                <p class="field-error" id="storeNameError"></p>
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="bio">Bio <span style="color:#9ca3af;font-weight:normal;">(optional)</span></label>
                <textarea id="bio" name="bio" rows="2" placeholder="Tell buyers a bit about you or your fabric collection…"></textarea>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" type="submit">Save profile</button>
              <button class="btn" type="button" id="cancelProfileEdit">Cancel</button>
            </div>
            <p class="muted-small">
              Profile details appear on your Atelier page. Shipping address and payouts stay private.
            </p>
          </form>
        </section>
      </div>
    </section>

    <!-- PAYOUTS (REAL STRIPE DASHBOARD BUTTON) -->
    <section class="hm-card" aria-labelledby="payoutHeading">
      <div class="hm-card-header" id="payoutHeading">Payouts</div>
      <div class="hm-card-body">
        <div class="payout-row">
          <div class="payout-copy">
            <strong>Payouts &amp; payments</strong>
            <span>
              Stripe powers payments and payouts for your shop using a secure Stripe Express account.
              Hemline Market doesn’t see your full bank or card details.
            </span>
            <p class="hint">
              Use the button on the right to open your Stripe Express dashboard. There you can update
              bank details, tax information, and payout settings.
            </p>
          </div>
          <div class="payout-side">
            <button class="btn btn-primary" type="button" id="btnStripe">
              Manage Stripe payouts
            </button>
            <div class="inline-note" id="stripeNote"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- SHIPPING ADDRESS -->
    <section class="hm-card" aria-labelledby="addressHeading">
      <div class="hm-card-header" id="addressHeading">Shipping address</div>
      <div class="hm-card-body">
        <h3 style="margin:0 0 4px;font-size:14px;font-weight:700;">Ship-from address</h3>
        <p class="muted-small" style="margin-top:0;">
          This address prints on prepaid labels for your fabric sales and purchases.
        </p>

        <div class="address-block" id="addressDisplay">
          Add your ship-from name and address.
        </div>

        <button class="btn" type="button" id="btnEditAddress">Edit address</button>

        <section class="editor-panel is-hidden" id="addressEditor" aria-label="Edit shipping address">
          <form id="addressForm">
            <div class="field-row">
              <div class="field">
                <label for="addrName">Name</label>
                <input id="addrName" name="addrName" type="text" autocomplete="name">
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="addrLine1">Street address</label>
                <input id="addrLine1" name="addrLine1" type="text" autocomplete="address-line1">
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="addrLine2">Apartment, suite, etc.</label>
                <input id="addrLine2" name="addrLine2" type="text" autocomplete="address-line2">
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="addrCity">City</label>
                <input id="addrCity" name="addrCity" type="text" autocomplete="address-level2">
              </div>
              <div class="field">
                <label for="addrState">State</label>
                <input id="addrState" name="addrState" type="text" autocomplete="address-level1">
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="addrZip">Postal code</label>
                <input id="addrZip" name="addrZip" type="text" inputmode="numeric" autocomplete="postal-code">
              </div>
              <div class="field">
                <label for="addrCountry">Country</label>
                <select id="addrCountry" name="addrCountry" disabled>
                  <option value="United States">United States</option>
                </select>
                <p class="muted-small" style="margin-top:4px;">Currently only available in the US.</p>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" type="submit">Save address</button>
              <button class="btn" type="button" id="cancelAddressEdit">Cancel</button>
            </div>
            <p class="muted-small">
              USPS-style address suggestions can be wired in later from your backend; this form keeps
              your details tidy until then.
            </p>
          </form>
        </section>
      </div>
    </section>

    <!-- STATUS -->
    <section class="hm-card" aria-labelledby="statusHeading">
      <div class="hm-card-header" id="statusHeading">Status</div>
      <div class="hm-card-body">
        <h3 style="margin:0 0 4px;font-size:14px;font-weight:700;">Vacation hold</h3>
        <p class="muted-small" style="margin-top:0;">
          Pause new orders while you’re away. You’ll still see your messages and history.
        </p>
        <label class="toggle-row">
          <input id="vacationToggle" type="checkbox">
          <span>Turn on vacation hold</span>
        </label>
      </div>
    </section>

    <!-- SECURITY -->
    <section class="hm-card" aria-labelledby="securityHeading">
      <div class="hm-card-header" id="securityHeading">Security</div>
      <div class="hm-card-body">
        <p class="muted-small" style="margin-top:0;">
          Hemline Market passwords must be at least 8 characters and include at least one letter and one number or symbol.
          For now, password changes happen through your email provider’s reset link for the account you used to sign up.
          We’ll add a dedicated security page later.
        </p>
        <button class="btn" type="button" id="btnChangePassword">Change password</button>
      </div>
    </section>
  </main>

  <!-- Universal footer placeholder -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase (for header + account logic) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Universal shell JS -->
  <script src="scripts/hm-shell.js"></script>

  <!-- Account page logic -->
  <script>
    // Render shell first (this creates window.HM.supabase)
    window.HM && window.HM.renderShell({ currentPage: "account" });

    // Use the shared Supabase client to avoid session conflicts
    var supabaseClient = window.supabase_client || (window.HM && window.HM.supabase);
    if (!supabaseClient) {
      supabaseClient = window.supabase.createClient(
        "https://clkizksbvxjkoatdajgd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI",
        { auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
      );
    }
    window.supabase_client = supabaseClient;

    function initialsFromEmail(email){
      if(!email) return "HM";
      const handle = email.split("@")[0].replace(/[\.\_\-]+/g," ").trim();
      const parts = handle.split(" ").filter(Boolean);
      if(parts.length === 1) return (parts[0][0] + (parts[0][1] || '')).toUpperCase();
      return (parts[0][0] + parts[1][0]).toUpperCase();
    }

    function initialsFromProfile(firstName, lastName, email){
      if(firstName && lastName){
        return (firstName[0] + lastName[0]).toUpperCase();
      }
      if(firstName){
        return (firstName[0] + (firstName[1] || '')).toUpperCase();
      }
      return initialsFromEmail(email);
    }

    // Turn a store name into a URL-safe slug for the shop link
    function slugifyStoreName(raw){
      if(!raw) return "";
      return raw
        .trim()
        .toLowerCase()
        .replace(/['’]/g, "s")       // Thor's → thors
        .replace(/[^a-z0-9]+/g,"-")  // spaces → hyphens
        .replace(/^-+|-+$/g,"");     // trim edges
    }

    // Validate store name for use as a link
    // Blocked words list
    const BLOCKED_STORE_WORDS = [
      // Profanity
      'fuck', 'shit', 'ass', 'bitch', 'damn', 'crap', 'piss', 'cunt', 'dick', 'cock', 'bastard', 'whore', 'slut',
      // Slurs and hate
      'nazi', 'hitler', 'kkk', 'nigger', 'nigga', 'faggot', 'fag', 'retard', 'chink', 'spic', 'kike',
      // Explicit
      'porn', 'xxx', 'sex', 'nude', 'naked', 'penis', 'vagina', 'dildo', 'horny', 'onlyfans',
      // Platform impersonation
      'hemline', 'hemlinemarket', 'hemline-market', 'official', 'admin', 'administrator', 'support', 'moderator', 'staff', 'helpdesk', 'customer-service',
      // Trust manipulation
      'verified', 'authentic', 'legit', 'trusted', 'real', 'official'
    ];

    function containsBlockedWord(text) {
      const lower = text.toLowerCase().replace(/[^a-z0-9]/g, '');
      for (const word of BLOCKED_STORE_WORDS) {
        if (lower.includes(word.replace(/[^a-z0-9]/g, ''))) {
          return true;
        }
      }
      return false;
    }

    function containsContactInfo(text) {
      // Check for phone numbers (3+ consecutive digits)
      if (/\d{3,}/.test(text)) return 'phone number';
      // Check for email pattern
      if (/@/.test(text)) return 'email address';
      // Check for URLs
      if (/\.(com|net|org|io|co|shop|store|market)/i.test(text)) return 'website URL';
      if (/https?:\/\//i.test(text)) return 'website URL';
      if (/www\./i.test(text)) return 'website URL';
      return null;
    }

    function validateStoreName(raw){
      raw = (raw || "").trim();
      if(!raw){
        // Store name is optional; empty is allowed
        return { ok:true, slug:"", needsUniquenessCheck: false };
      }

      // 1) Check for blocked words
      if(containsBlockedWord(raw)){
        return {
          ok:false,
          slug:slugifyStoreName(raw),
          message:"This store name contains prohibited words. Please choose a different name."
        };
      }

      // 2) Check for contact info (phone, email, URL)
      const contactType = containsContactInfo(raw);
      if(contactType){
        return {
          ok:false,
          slug:slugifyStoreName(raw),
          message:`Store names cannot contain a ${contactType}. Please remove it.`
        };
      }

      // 3) Raw name must only have letters, numbers, spaces, apostrophes, and hyphens
      if(!/^[A-Za-z0-9\s'\-]+$/.test(raw)){
        return {
          ok:false,
          slug:slugifyStoreName(raw),
          message:"Use only letters, numbers, spaces, apostrophes, and hyphens for your store name. Remove other symbols like ! or emoji."
        };
      }

      // 4) Slug must be a sane, URL-safe link
      const slug = slugifyStoreName(raw);
      if(slug.length < 3){
        return {
          ok:false,
          slug,
          message:"Store name is too short. Use at least 3 characters with letters or numbers."
        };
      }
      if(slug.length > 40){
        return {
          ok:false,
          slug,
          message:"Store name is too long. Try 40 characters or fewer."
        };
      }
      if(!/^[a-z0-9\-]+$/.test(slug)){
        return {
          ok:false,
          slug,
          message:"Use only letters, numbers, and hyphens for your store link."
        };
      }
      return { ok:true, slug, needsUniquenessCheck: true };
    }

    // Check if store name is unique in database
    async function checkStoreNameUnique(storeName, storeSlug, currentUserId) {
      if (!storeName && !storeSlug) return { unique: true };
      
      try {
        // Check by exact store_name (case-insensitive)
        const { data: byName, error: nameErr } = await supabaseClient
          .from('profiles')
          .select('id, store_name')
          .ilike('store_name', storeName)
          .neq('id', currentUserId)
          .limit(1);
        
        if (!nameErr && byName && byName.length > 0) {
          return { unique: false, reason: 'This store name is already taken. Please choose a different name.' };
        }

        // Check by store_slug
        const { data: bySlug, error: slugErr } = await supabaseClient
          .from('profiles')
          .select('id, store_slug')
          .eq('store_slug', storeSlug)
          .neq('id', currentUserId)
          .limit(1);
        
        if (!slugErr && bySlug && bySlug.length > 0) {
          return { unique: false, reason: 'This store link is already taken. Please choose a different name.' };
        }

        return { unique: true };
      } catch (e) {
        console.error('Uniqueness check error:', e);
        // Allow save but log error - don't block user if DB check fails
        return { unique: true };
      }
    }

    async function ensureSession({maxWaitMs=3000} = {}){
      let { data:{ session } } = await supabaseClient.auth.getSession();
      if(session?.user) return session;
      const start = Date.now();
      while(!session?.user && Date.now() - start < maxWaitMs){
        await new Promise(r=>setTimeout(r,120));
        ({ data:{ session } } = await supabaseClient.auth.getSession());
      }
      return session;
    }

    (async function initAccount(){
      const session = await ensureSession();
      if(!session || !session.user){
        window.location.href = "auth.html?view=login";
        return;
      }

      const user = session.user;
      const email = user.email || "you@example.com";
      const userId = user.id;

      // LocalStorage keys
      const PROFILE_KEY = "hm_profile_" + userId;
      const ADDRESS_KEY = "hm_address_" + userId;
      const VAC_KEY     = "hm_vacation_" + userId;

      // ✅ NEW: when Account saves an address, also save it in Checkout’s expected format
      function syncAddressToCheckoutKeys(accountAddr){
        try{
          const checkoutAddr = {
            // checkout.html uses these names
            email: "",
            phone: "",
            name: (accountAddr.addrName || "").trim(),
            line1: (accountAddr.addrLine1 || "").trim(),
            line2: (accountAddr.addrLine2 || "").trim(),
            city:  (accountAddr.addrCity  || "").trim(),
            state: (accountAddr.addrState || "").trim(),
            zip:   (accountAddr.addrZip   || "").trim(),
            country: "US"
          };

          // Write both a global fallback and a user-specific key
          localStorage.setItem("hm_checkout_address", JSON.stringify(checkoutAddr));
          localStorage.setItem("hm_checkout_address_" + userId, JSON.stringify(checkoutAddr));
        }catch(e){
          // ignore
        }
      }

      // Elements
      const profileNameEl        = document.getElementById('profileName');
      const profileEmailEl       = document.getElementById('profileEmail');
      const profileExtraEl       = document.getElementById('profileExtra');
      const profileEditor        = document.getElementById('profileEditor');
      const profileForm          = document.getElementById('profileForm');
      const storeNameInput       = document.getElementById('storeName');
      const storeSlugPreviewEl   = document.getElementById('storeSlugPreview');
      const storeNameErrorEl     = document.getElementById('storeNameError');
      const storeNameHintEl      = document.getElementById('storeNameHint');

      // Avatar upload elements
      const avatarSection        = document.getElementById('profileAvatarSection');
      const avatarCircle         = document.getElementById('profileAvatarCircle');
      const avatarImg            = document.getElementById('profileAvatarImg');
      const avatarPlaceholder    = avatarCircle?.querySelector('.profile-avatar-placeholder');
      const avatarEditBtn        = document.getElementById('btnEditAvatar');
      const avatarFileInput      = document.getElementById('avatarFileInput');

      const addressDisplay       = document.getElementById('addressDisplay');
      const addressEditor        = document.getElementById('addressEditor');
      const addressForm          = document.getElementById('addressForm');

      const vacationToggle       = document.getElementById('vacationToggle');

      const stripeBtn            = document.getElementById('btnStripe');
      const stripeNoteEl         = document.getElementById('stripeNote');

      profileEmailEl.textContent = email;

      // ---- Avatar Upload Functions ----
      const AVATAR_BUCKET = 'Avatars';

      function showAvatar(url) {
        if (url && avatarImg && avatarPlaceholder) {
          avatarImg.src = url;
          avatarImg.classList.remove('is-hidden');
          avatarPlaceholder.style.display = 'none';
          // Also update localStorage for header avatar
          if (userId) { localStorage.setItem(`hm-avatar-${userId}`, url); }
        }
      }

      function hideAvatar() {
        if (avatarImg && avatarPlaceholder) {
          avatarImg.classList.add('is-hidden');
          avatarPlaceholder.style.display = '';
          if (userId) { localStorage.removeItem(`hm-avatar-${userId}`); }
        }
      }

      async function uploadAvatar(file) {
        if (!file || !userId) return null;

        // Validate file
        if (!file.type.startsWith('image/')) {
          alert('Please select an image file.');
          return null;
        }
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
          alert('Image must be smaller than 5MB.');
          return null;
        }

        avatarSection?.classList.add('uploading');

        try {
          // Create unique filename
          const ext = file.name.split('.').pop().toLowerCase() || 'jpg';
          const filename = `${userId}/avatar-${Date.now()}.${ext}`;

          // Upload to Supabase storage
          const { data, error: uploadError } = await supabaseClient.storage
            .from(AVATAR_BUCKET)
            .upload(filename, file, {
              cacheControl: '3600',
              upsert: true,
              contentType: file.type
            });

          if (uploadError) {
            console.error('Avatar upload error:', uploadError);
            // Check if it's a bucket/permissions error
            if (uploadError.message?.includes('bucket') || uploadError.statusCode === 400) {
              alert('Profile photo uploads are not yet enabled. Please contact support or try again later.');
            } else {
              alert('Failed to upload image: ' + (uploadError.message || 'Please try again.'));
            }
            return null;
          }

          // Get public URL
          const { data: urlData } = supabaseClient.storage
            .from(AVATAR_BUCKET)
            .getPublicUrl(data.path);

          const publicUrl = urlData?.publicUrl;
          if (!publicUrl) {
            alert('Failed to get image URL. Please try again.');
            return null;
          }

          // Save to profiles table
          const { error: profileError } = await supabaseClient
            .from('profiles')
            .upsert({
              id: userId,
              avatar_url: publicUrl
            }, { onConflict: 'id' });

          if (profileError) {
            console.error('Profile avatar update error:', profileError);
          }

          // Also update user_metadata
          await supabaseClient.auth.updateUser({
            data: { avatar_url: publicUrl }
          });

          console.log('[Account] Avatar uploaded successfully:', publicUrl);
          return publicUrl;

        } catch (err) {
          console.error('Avatar upload exception:', err);
          alert('Something went wrong. Please try again.');
          return null;
        } finally {
          avatarSection?.classList.remove('uploading');
        }
      }

      // Wire up avatar upload with crop modal
      const cropModal = document.getElementById('cropModal');
      const cropImage = document.getElementById('cropImage');
      const cropModalClose = document.getElementById('cropModalClose');
      const cropCancel = document.getElementById('cropCancel');
      const cropSave = document.getElementById('cropSave');
      let cropper = null;
      let pendingFile = null;

      function openCropModal(file) {
        pendingFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          cropImage.src = e.target.result;
          cropModal.classList.add('active');
          
          // Initialize cropper after image loads
          cropImage.onload = () => {
            if (cropper) {
              cropper.destroy();
            }
            cropper = new Cropper(cropImage, {
              aspectRatio: 1,
              viewMode: 1,
              dragMode: 'move',
              autoCropArea: 1,
              cropBoxMovable: true,
              cropBoxResizable: true,
              guides: false,
              center: true,
              background: false,
              responsive: true,
            });
          };
        };
        reader.readAsDataURL(file);
      }

      function closeCropModal() {
        cropModal.classList.remove('active');
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        pendingFile = null;
        cropImage.src = '';
      }

      async function saveCroppedImage() {
        if (!cropper) return;
        
        // Get cropped canvas
        const canvas = cropper.getCroppedCanvas({
          width: 256,
          height: 256,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high',
        });
        
        if (!canvas) {
          alert('Could not crop image. Please try again.');
          return;
        }
        
        // Convert to blob
        canvas.toBlob(async (blob) => {
          if (!blob) {
            alert('Could not process image. Please try again.');
            return;
          }
          
          // Create a File from the blob
          const croppedFile = new File([blob], 'avatar.jpg', { type: 'image/jpeg' });
          
          closeCropModal();
          
          // Upload the cropped image
          const url = await uploadAvatar(croppedFile);
          if (url) {
            showAvatar(url);
          }
        }, 'image/jpeg', 0.9);
      }

      // Event listeners for crop modal
      if (cropModalClose) {
        cropModalClose.addEventListener('click', closeCropModal);
      }
      if (cropCancel) {
        cropCancel.addEventListener('click', closeCropModal);
      }
      if (cropSave) {
        cropSave.addEventListener('click', saveCroppedImage);
      }
      
      // Close modal on backdrop click
      if (cropModal) {
        cropModal.addEventListener('click', (e) => {
          if (e.target === cropModal) {
            closeCropModal();
          }
        });
      }

      if (avatarEditBtn && avatarFileInput) {
        avatarEditBtn.addEventListener('click', () => {
          avatarFileInput.click();
        });

        avatarFileInput.addEventListener('change', async () => {
          const file = avatarFileInput.files?.[0];
          if (!file) return;

          // Validate file type
          if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            avatarFileInput.value = '';
            return;
          }
          
          // Open crop modal instead of uploading directly
          openCropModal(file);

          // Reset input so same file can be selected again
          avatarFileInput.value = '';
        });
      }

      // ---- Helper: Check if email is Apple relay or looks auto-generated ----
      function isRelayEmail(email) {
        if (!email) return false;
        // Only flag actual relay/private emails, not normal emails with numbers
        return (
          email.includes('@privaterelay.appleid.com') ||
          email.includes('@relay.')
        );
      }

      function isAutoGeneratedName(name) {
        if (!name) return true;
        // Check if name looks like an auto-generated string:
        // - All lowercase with numbers (like "8vdv64nck6")
        // - Or exactly "Hemline member"
        // Real names like "Kalwar" have capital letters and no numbers
        const looksAutoGenerated = /^[a-z0-9]{6,}$/.test(name) && /\d/.test(name);
        return looksAutoGenerated || name === "Hemline member";
      }

      // ---- Load profile from Supabase FIRST, then localStorage as fallback ----
      let profile = {};
      let address = {};
      let supabaseProfile = null;
      
      // Try to load from Supabase profiles table
      try {
        const { data: profileData, error: profileError } = await supabaseClient
          .from('profiles')
          .select('*')
          .eq('id', userId)
          .maybeSingle();
        
        if (!profileError && profileData) {
          supabaseProfile = profileData;
          // Map Supabase profile to our local format - use correct column names!
          profile = {
            firstName: profileData.first_name || '',
            lastName: profileData.last_name || '',
            storeName: profileData.store_name || '',
            bio: profileData.bio || '',
            storeSlug: profileData.store_slug || slugifyStoreName(profileData.store_name || ''),
            contactEmail: profileData.contact_email || '',
            avatarUrl: profileData.avatar_url || ''
          };
          console.log('[Account] Loaded profile from Supabase:', profile);
          
          // Show avatar if we have one
          if (profile.avatarUrl) {
            showAvatar(profile.avatarUrl);
          }
        }
      } catch (e) {
        console.warn('Error loading profile from Supabase:', e);
      }

      // Also check user_metadata for address and additional info
      const userMeta = user.user_metadata || {};
      if (userMeta.first_name || userMeta.last_name) {
        profile.firstName = profile.firstName || userMeta.first_name || '';
        profile.lastName = profile.lastName || userMeta.last_name || '';
      }
      if (userMeta.shop_name) {
        profile.storeName = profile.storeName || userMeta.shop_name || '';
      }
      // Check user_metadata for avatar_url as fallback
      if (userMeta.avatar_url && !profile.avatarUrl) {
        profile.avatarUrl = userMeta.avatar_url;
        showAvatar(profile.avatarUrl);
      }
      // ✅ Check user_metadata for contact_email - use it if profile doesn't have one
      if (userMeta.contact_email) {
        profile.contactEmail = profile.contactEmail || userMeta.contact_email;
        console.log('[Account] Found contact_email in user_metadata:', userMeta.contact_email);
      }
      
      // DEBUG: Show what we found
      console.log('[Account] Final contactEmail:', profile.contactEmail);
      console.log('[Account] userMeta:', JSON.stringify(userMeta));

      // Load address from user_metadata first
      if (userMeta.ship_address1) {
        address = {
          addrName: userMeta.ship_name || '',
          addrLine1: userMeta.ship_address1 || '',
          addrLine2: userMeta.ship_address2 || '',
          addrCity: userMeta.ship_city || '',
          addrState: userMeta.ship_state || '',
          addrZip: userMeta.ship_postal || ''
        };
        console.log('[Account] Loaded address from user_metadata:', address);
      }

      // Fallback to localStorage if Supabase didn't have data
      if (!profile.firstName && !profile.lastName) {
        try {
          const raw = localStorage.getItem(PROFILE_KEY);
          if (raw) {
            const localProfile = JSON.parse(raw) || {};
            profile = { ...localProfile, ...profile }; // Supabase data takes priority
            console.log('[Account] Merged with localStorage profile');
          }
        } catch (e) {
          console.warn("Profile parse failed", e);
        }
      }

      // Fallback address from localStorage
      if (!address.addrLine1) {
        try {
          const rawA = localStorage.getItem(ADDRESS_KEY);
          if (rawA) {
            const localAddr = JSON.parse(rawA) || {};
            address = { ...localAddr, ...address };
          }
        } catch (e) {
          console.warn("Address parse failed", e);
        }
      }

      // ---- Check profile completeness ----
      const hasRealName = !!(profile.firstName && profile.lastName && 
                          !isAutoGeneratedName(profile.firstName) && 
                          !isAutoGeneratedName(profile.lastName));
      const hasAddress = !!(address.addrLine1 && address.addrCity && address.addrState && address.addrZip);
      const hasRelayEmail = isRelayEmail(email);
      const hasContactEmail = !!(profile.contactEmail && !isRelayEmail(profile.contactEmail));
      const isProfileComplete = hasRealName && hasAddress && hasContactEmail;
      
      // Debug logging
      console.log('[Account] Profile completeness check:', {
        firstName: profile.firstName,
        lastName: profile.lastName,
        isAutoGenFirst: isAutoGeneratedName(profile.firstName),
        isAutoGenLast: isAutoGeneratedName(profile.lastName),
        hasRealName,
        hasAddress,
        hasContactEmail,
        contactEmail: profile.contactEmail,
        isProfileComplete
      });

      // Store completeness globally for other pages to check
      window.HM = window.HM || {};
      window.HM.profileComplete = isProfileComplete;
      window.HM.hasRealName = hasRealName;
      window.HM.hasAddress = hasAddress;
      window.HM.hasContactEmail = hasContactEmail;
      localStorage.setItem('hm_profile_complete', JSON.stringify({
        complete: isProfileComplete,
        hasRealName,
        hasAddress,
        hasContactEmail,
        hasRelayEmail,
        userId
      }));

      // Show warning if incomplete
      const profileWarning = document.getElementById('profileWarning');
      const btnCompleteProfile = document.getElementById('btnCompleteProfile');
      
      // ✅ Reusable function to re-check completeness and update UI
      function recheckAndUpdateCompleteness() {
        const nowHasRealName = !!(profile.firstName && profile.lastName && 
                              !isAutoGeneratedName(profile.firstName) && 
                              !isAutoGeneratedName(profile.lastName));
        const nowHasAddress = !!(address.addrLine1 && address.addrCity && address.addrState && address.addrZip);
        const nowHasContactEmail = !!(profile.contactEmail && !isRelayEmail(profile.contactEmail));
        const nowComplete = nowHasRealName && nowHasAddress && nowHasContactEmail;
        
        console.log('[Account] Re-checking completeness:', { nowHasRealName, nowHasAddress, nowHasContactEmail, nowComplete });
        
        // Update global state
        window.HM = window.HM || {};
        window.HM.profileComplete = nowComplete;
        window.HM.hasRealName = nowHasRealName;
        window.HM.hasAddress = nowHasAddress;
        window.HM.hasContactEmail = nowHasContactEmail;
        localStorage.setItem('hm_profile_complete', JSON.stringify({
          complete: nowComplete,
          hasRealName: nowHasRealName,
          hasAddress: nowHasAddress,
          hasContactEmail: nowHasContactEmail,
          hasRelayEmail,
          userId
        }));
        
        // Update banner visibility
        if (profileWarning) {
          if (nowComplete) {
            profileWarning.classList.add('is-hidden');
          } else {
            profileWarning.classList.remove('is-hidden');
          }
        }
        
        // Update profile name display style if now complete
        if (nowHasRealName) {
          profileNameEl.style.color = '';
          profileNameEl.style.fontStyle = '';
        }
        
        return nowComplete;
      }
      
      if (profileWarning) {
        if (!isProfileComplete) {
          profileWarning.classList.remove('is-hidden');
          if (btnCompleteProfile) {
            btnCompleteProfile.onclick = () => {
              document.getElementById('btnEditProfile')?.click();
            };
          }
        } else {
          profileWarning.classList.add('is-hidden');
        }
      }

      // Compute display name - show "Add your information" if incomplete
      if(profile.firstName && profile.lastName && !isAutoGeneratedName(profile.firstName)){
        profileNameEl.textContent =
          (profile.firstName || "") + (profile.lastName ? (" " + profile.lastName) : "");
      } else if (hasRelayEmail || isAutoGeneratedName(email.split("@")[0])) {
        profileNameEl.textContent = "Add your information";
        profileNameEl.style.color = "#9ca3af";
        profileNameEl.style.fontStyle = "italic";
      } else {
        profileNameEl.textContent = email.split("@")[0] || "Hemline member";
      }

      // Hide relay email, show prompt instead - BUT show contact email if we have one
      if (hasRelayEmail) {
        if (profile.contactEmail && !isRelayEmail(profile.contactEmail)) {
          // Show the contact email instead
          profileEmailEl.textContent = profile.contactEmail;
          profileEmailEl.style.color = "";
          profileEmailEl.style.fontStyle = "";
        } else {
          profileEmailEl.textContent = "Email hidden — add a contact email in your profile";
          profileEmailEl.style.color = "#9ca3af";
          profileEmailEl.style.fontStyle = "italic";
        }
      }

      // Store slug (backfill for old profiles)
      const existingSlug = profile.storeSlug || slugifyStoreName(profile.storeName || "");

      // Build profile extra info with clickable store link
      const profileLines = [];
      if(profile.storeName) profileLines.push("Store name: " + profile.storeName);
      if(profile.bio) profileLines.push(profile.bio);
      
      // Set text content for non-link items
      profileExtraEl.innerHTML = '';
      if(profile.storeName) {
        const nameLine = document.createElement('div');
        nameLine.textContent = "Store name: " + profile.storeName;
        profileExtraEl.appendChild(nameLine);
      }
      if(existingSlug) {
        const linkLine = document.createElement('div');
        linkLine.innerHTML = 'Store link: <a href="https://hemlinemarket.com/atelier.html?shop=' + encodeURIComponent(existingSlug) + '" target="_blank" style="color:#991b1b;">hemlinemarket.com/shop/' + existingSlug + '</a>';
        profileExtraEl.appendChild(linkLine);
      }
      if(profile.bio) {
        const bioLine = document.createElement('div');
        bioLine.textContent = profile.bio;
        bioLine.style.marginTop = '4px';
        profileExtraEl.appendChild(bioLine);
      }

      // Prefill profile form + slug preview
      if(profileForm){
        profileForm.firstName.value = profile.firstName || "";
        profileForm.lastName.value  = profile.lastName  || "";
        const contactEmailInput = document.getElementById('contactEmail');
        if(contactEmailInput) {
          // Default to login email if no contact email set and login email is real
          contactEmailInput.value = profile.contactEmail || (!hasRelayEmail ? email : "");
        }
        if(storeNameInput){
          storeNameInput.value = profile.storeName || "";
          // If store name is already set, disable the field and show lock message
          if(profile.storeName && profile.storeName.trim()){
            storeNameInput.disabled = true;
            storeNameInput.style.background = "#f3f4f6";
            storeNameInput.style.cursor = "not-allowed";
            if(storeNameHintEl){
              storeNameHintEl.innerHTML = '🔒 <strong>Store name is locked.</strong> Store names are permanent once set. Contact support if you need to change it.';
              storeNameHintEl.style.color = "#6b7280";
            }
          }
        }
        if(storeSlugPreviewEl){
          storeSlugPreviewEl.textContent = existingSlug || "your-shop";
        }
        const bioInput = document.getElementById('bio');
        if(bioInput) bioInput.value = profile.bio || "";
      }

      // Live slug preview as user types (no hard errors until submit)
      if(storeNameInput && storeSlugPreviewEl){
        storeNameInput.addEventListener('input', ()=>{
          const raw  = storeNameInput.value;
          const slug = slugifyStoreName(raw);
          storeSlugPreviewEl.textContent = slug || "your-shop";
          if(storeNameErrorEl) storeNameErrorEl.textContent = "";
          storeNameInput.removeAttribute("aria-invalid");
        });
      }

      // ---- Address display (already loaded above) ----

      // If address name is empty but we have profile name, prefill it
      if(!address.addrName && (profile.firstName || profile.lastName)){
        const dn = (profile.firstName || "") + (profile.lastName ? (" " + profile.lastName) : "");
        if(dn.trim()){
          address.addrName = dn.trim();
          try{
            localStorage.setItem(ADDRESS_KEY, JSON.stringify(address));
          }catch(e){}
        }
      }

      function renderAddress(){
        if(!address || !address.addrLine1){
          addressDisplay.textContent = "Add your ship-from name and address.";
          return;
        }
        const lines = [];
        if(address.addrName)  lines.push(address.addrName);
        let line1 = address.addrLine1;
        if(address.addrLine2) line1 += "\n" + address.addrLine2;
        lines.push(line1);

        let cityLine = "";
        if(address.addrCity)  cityLine += address.addrCity;
        if(address.addrState) cityLine += (cityLine ? ", " : "") + address.addrState;
        if(address.addrZip)   cityLine += (cityLine ? " " : "") + address.addrZip;
        if(cityLine)          lines.push(cityLine);
        if(address.addrCountry) lines.push(address.addrCountry);

        addressDisplay.textContent = lines.join("\n");
      }
      renderAddress();

      // Fill address form safely
      addressForm.addrName.value    = address.addrName    || "";
      addressForm.addrLine1.value   = address.addrLine1   || "";
      addressForm.addrLine2.value   = address.addrLine2   || "";
      addressForm.addrCity.value    = address.addrCity    || "";
      addressForm.addrState.value   = address.addrState   || "";
      addressForm.addrZip.value     = address.addrZip     || "";
      addressForm.addrCountry.value = address.addrCountry || "United States";

      // Vacation toggle - load from Supabase profile
      try{
        const { data: profileData } = await supabaseClient
          .from("profiles")
          .select("vacation_mode")
          .eq("id", userId)
          .single();
        
        vacationToggle.checked = profileData?.vacation_mode === true;
      }catch(e){
        // Fallback to localStorage
        const vacRaw = localStorage.getItem(VAC_KEY);
        vacationToggle.checked = vacRaw === "on";
      }

      vacationToggle.addEventListener('change', async () => {
        const isOn = vacationToggle.checked;
        localStorage.setItem(VAC_KEY, isOn ? "on" : "off");
        
        // Also save to Supabase for persistence across devices
        try{
          await supabaseClient
            .from("profiles")
            .update({ vacation_mode: isOn })
            .eq("id", userId);
        }catch(e){
          console.warn("Failed to save vacation mode to Supabase", e);
        }
      });

      // ---- Profile button handlers ----
      document.getElementById('btnEditProfile').addEventListener('click', () => {
        profileEditor.classList.remove('is-hidden');
        profileForm.firstName.focus();
      });

      document.getElementById('cancelProfileEdit').addEventListener('click', () => {
        profileEditor.classList.add('is-hidden');
      });

      profileForm.addEventListener('submit', async (e)=>{
        e.preventDefault();

        // FIX: Get submit button reference and original text for proper reset
        const submitBtn = profileForm.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn ? submitBtn.textContent : "Save profile";

        try {
          const rawStoreName = (storeNameInput ? storeNameInput.value : "").trim();
          
          // Check if user already has a store name set - if so, they can't change it
          const existingStoreName = (profile.storeName || "").trim();
          if(existingStoreName && rawStoreName !== existingStoreName){
            if(storeNameErrorEl) storeNameErrorEl.textContent = "Store names are permanent and cannot be changed. Contact support if you need help.";
            if(storeNameInput){
              storeNameInput.value = existingStoreName; // Reset to original
              storeNameInput.setAttribute("aria-invalid","true");
            }
            return;
          }
          
          const storeCheck = validateStoreName(rawStoreName);

          if(!storeCheck.ok){
            if(storeNameErrorEl) storeNameErrorEl.textContent = storeCheck.message;
            if(storeSlugPreviewEl) storeSlugPreviewEl.textContent = storeCheck.slug || "your-shop";
            if(storeNameInput){
              storeNameInput.setAttribute("aria-invalid","true");
              storeNameInput.focus();
            }
            return;
          }else{
            if(storeNameErrorEl) storeNameErrorEl.textContent = "";
            if(storeNameInput) storeNameInput.removeAttribute("aria-invalid");
          }

          // Check uniqueness if this is a new store name
          if(storeCheck.needsUniquenessCheck && rawStoreName && !existingStoreName){
            if(submitBtn){
              submitBtn.disabled = true;
              submitBtn.textContent = "Checking...";
            }
            
            const uniqueCheck = await checkStoreNameUnique(rawStoreName, storeCheck.slug, userId);
            
            // FIX: Reset button immediately after check completes
            if(submitBtn){
              submitBtn.disabled = false;
              submitBtn.textContent = originalBtnText;
            }
            
            if(!uniqueCheck.unique){
              if(storeNameErrorEl) storeNameErrorEl.textContent = uniqueCheck.reason;
              if(storeNameInput){
                storeNameInput.setAttribute("aria-invalid","true");
                storeNameInput.focus();
              }
              return;
            }
          }

          const contactEmailInput = document.getElementById('contactEmail');
          const contactEmailValue = contactEmailInput ? contactEmailInput.value.trim() : '';

          const next = {
            firstName: profileForm.firstName.value.trim(),
            lastName:  profileForm.lastName.value.trim(),
            storeName: rawStoreName,
            storeSlug: storeCheck.slug,
            bio:       (profileForm.bio?.value || '').trim(),
            contactEmail: contactEmailValue
          };
          localStorage.setItem(PROFILE_KEY, JSON.stringify(next));
        profile = next;

        // ✅ Also update Supabase profiles table so atelier reflects changes
        const fullName = ((next.firstName || "") + " " + (next.lastName || "")).trim();
        if (userId) {
          // FIX: Use await instead of .then() to properly handle errors
          const { error: profileError } = await supabaseClient
            .from("profiles")
            .upsert({
              id: userId,
              first_name: next.firstName || null,
              last_name: next.lastName || null,
              display_name: fullName || null,
              store_name: next.storeName || null,
              store_slug: next.storeSlug || null,
              bio: next.bio || null,
              contact_email: next.contactEmail || null,
            }, { onConflict: 'id' });
          
          if (profileError) {
            console.error("Profile sync error:", profileError);
            // Don't block - profile data is also in localStorage
          } else {
            console.log("[Account] Profile saved to Supabase");
          }
          
          // Also update user_metadata for address and cross-device sync
          const { error: metaError } = await supabaseClient.auth.updateUser({
            data: {
              first_name: next.firstName || null,
              last_name: next.lastName || null,
              display_name: fullName || null,
              shop_name: next.storeName || null,
              contact_email: next.contactEmail || null,
            }
          });
          
          if (metaError) {
            console.error("User metadata sync error:", metaError);
            alert("Error saving email: " + metaError.message);
          } else {
            console.log("[Account] User metadata saved successfully");
          }
        }

        const displayName =
          (next.firstName || "") + (next.lastName ? (" " + next.lastName) : "");
        profileNameEl.textContent =
          displayName || (email.split("@")[0] || "Hemline member");
        profileNameEl.style.color = '';
        profileNameEl.style.fontStyle = '';

        // ✅ Force update the email display immediately after save
        if (next.contactEmail) {
          profileEmailEl.textContent = next.contactEmail;
          profileEmailEl.style.color = "";
          profileEmailEl.style.fontStyle = "";
        }

        // ✅ Update email display - show contact email if we have one
        if (next.contactEmail && !isRelayEmail(next.contactEmail)) {
          profileEmailEl.textContent = next.contactEmail;
          profileEmailEl.style.color = "";
          profileEmailEl.style.fontStyle = "";
        }

        // Update profile extra with clickable store link
        profileExtraEl.innerHTML = '';
        if(next.storeName) {
          const nameLine = document.createElement('div');
          nameLine.textContent = "Store name: " + next.storeName;
          profileExtraEl.appendChild(nameLine);
        }
        if(next.storeSlug) {
          const linkLine = document.createElement('div');
          linkLine.innerHTML = 'Store link: <a href="https://hemlinemarket.com/atelier.html?shop=' + encodeURIComponent(next.storeSlug) + '" target="_blank" style="color:#991b1b;">hemlinemarket.com/shop/' + next.storeSlug + '</a>';
          profileExtraEl.appendChild(linkLine);
        }
        if(next.bio) {
          const bioLine = document.createElement('div');
          bioLine.textContent = next.bio;
          bioLine.style.marginTop = '4px';
          profileExtraEl.appendChild(bioLine);
        }

        if(storeSlugPreviewEl){
          storeSlugPreviewEl.textContent = next.storeSlug || "your-shop";
        }

        if(!address.addrName && displayName.trim()){
          address.addrName = displayName.trim();
          try{
            localStorage.setItem(ADDRESS_KEY, JSON.stringify(address));
          }catch(e){}
          addressForm.addrName.value = address.addrName;
          renderAddress();
        }

        profileEditor.classList.add('is-hidden');
        
        // ✅ Re-check completeness and update warning banner
        const nowComplete = recheckAndUpdateCompleteness();
        
        // Also directly check and hide if name + email are done (address checked separately)
        if (next.firstName && next.lastName && next.contactEmail) {
          console.log('[Account] Profile info complete, checking address...');
          if (address.addrLine1 && address.addrCity && address.addrState && address.addrZip) {
            console.log('[Account] All complete! Hiding banner.');
            if (profileWarning) profileWarning.classList.add('is-hidden');
          } else {
            console.log('[Account] Still need address. Banner stays visible.');
          }
        }
        
        } catch (err) {
          // FIX: Handle any unexpected errors
          console.error('[Account] Profile save error:', err);
          alert('Something went wrong. Please try again.');
        } finally {
          // FIX: Always reset button state, no matter what
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
          }
        }
      });

      // ---- Address editor ----
      document.getElementById('btnEditAddress').addEventListener('click', ()=>{
        addressEditor.classList.remove('is-hidden');
        addressForm.addrName.focus();
      });

      document.getElementById('cancelAddressEdit').addEventListener('click', ()=>{
        addressEditor.classList.add('is-hidden');
      });

      // ✅ MODIFIED: also sync the checkout address keys when saving from Account
      addressForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const next = {
          addrName:  addressForm.addrName.value.trim(),
          addrLine1: addressForm.addrLine1.value.trim(),
          addrLine2: addressForm.addrLine2.value.trim(),
          addrCity:  addressForm.addrCity.value.trim(),
          addrState: addressForm.addrState.value.trim(),
          addrZip:   addressForm.addrZip.value.trim(),
          addrCountry: addressForm.addrCountry.value || "United States"
        };
        localStorage.setItem(ADDRESS_KEY, JSON.stringify(next));

        // 🔥 THIS is the fix: make checkout read the updated address
        syncAddressToCheckoutKeys(next);

        // ✅ Also sync to Supabase user_metadata for cross-device sync
        try {
          await supabaseClient.auth.updateUser({
            data: {
              ship_name: next.addrName || null,
              ship_address1: next.addrLine1 || null,
              ship_address2: next.addrLine2 || null,
              ship_city: next.addrCity || null,
              ship_state: next.addrState || null,
              ship_postal: next.addrZip || null,
              ship_country: next.addrCountry || 'United States'
            }
          });
          console.log("[Account] Address saved to Supabase user_metadata");
        } catch (err) {
          console.error("Address sync error:", err);
        }

        address = next;
        renderAddress();
        addressEditor.classList.add('is-hidden');
        
        // ✅ Re-check completeness and update warning banner
        recheckAndUpdateCompleteness();
      });

      // ---- Stripe Express button (calls Edge Function) ----
      function setStripeNote(msg){
        if(!stripeNoteEl) return;
        stripeNoteEl.textContent = msg || "";
      }

      if(stripeBtn){
        stripeBtn.addEventListener('click', async ()=>{
          stripeBtn.disabled = true;
          stripeBtn.textContent = "Opening Stripe…";
          setStripeNote("");

          try{
            const { data:{ session } } = await supabaseClient.auth.getSession();
            const accessToken = session?.access_token;
            if(!accessToken){
              setStripeNote("You need to be signed in to manage payouts.");
              stripeBtn.disabled = false;
              stripeBtn.textContent = "Manage Stripe payouts";
              return;
            }

            const resp = await fetch(
              "https://clkizksbvxjkoatdajgd.supabase.co/functions/v1/onboard",
              {
                method:"POST",
                headers:{
                  "Authorization":"Bearer " + accessToken,
                  "Content-Type":"application/json"
                },
                body: JSON.stringify({})
              }
            );

            if(!resp.ok){
              console.error("Stripe onboard error", resp.status);
              setStripeNote("We couldn’t open Stripe right now. Please try again in a moment.");
              stripeBtn.disabled = false;
              stripeBtn.textContent = "Manage Stripe payouts";
              return;
            }

            const payload = await resp.json();
            if(payload && payload.url){
              window.location.href = payload.url;
            }else{
              setStripeNote("Stripe link was missing. Please try again.");
              stripeBtn.disabled = false;
              stripeBtn.textContent = "Manage Stripe payouts";
            }
          }catch(err){
            console.error("Stripe onboard exception", err);
            setStripeNote("Something went wrong opening Stripe. Try again.");
            stripeBtn.disabled = false;
            stripeBtn.textContent = "Manage Stripe payouts";
          }
        });
      }

      // ---- Logout + password info ----
      document.getElementById('btnLogout').addEventListener('click', async ()=>{
        // FIX: Clear all user-specific localStorage data to prevent data leakage
        const keysToRemove = [
          PROFILE_KEY,
          ADDRESS_KEY,
          VAC_KEY,
          `hm-avatar-${userId}`,
          `hm_checkout_address_${userId}`,
          'avatarUrl',  // Legacy global key
          'hm_profile_complete',
          'hm_checkout_address',
          'hm_cart'
        ];
        keysToRemove.forEach(key => {
          try { localStorage.removeItem(key); } catch(e) {}
        });
        
        await supabaseClient.auth.signOut();
        window.location.href = "auth.html?view=login";
      });

      document.getElementById('btnChangePassword').addEventListener('click', ()=>{
        alert(
          "To change your password, use the reset link sent to the email address you used to sign up. " +
          "Passwords must be at least 8 characters and include at least one letter and one number or symbol."
        );
      });
    })();
  </script>

  <!-- Crop Modal -->
  <div class="crop-modal" id="cropModal">
    <div class="crop-modal-content">
      <div class="crop-modal-header">
        <h3>Adjust Photo</h3>
        <button type="button" class="crop-modal-close" id="cropModalClose">&times;</button>
      </div>
      <div class="crop-modal-body">
        <div class="crop-container">
          <img id="cropImage" src="" alt="Crop preview">
        </div>
      </div>
      <div class="crop-modal-footer">
        <button type="button" class="btn btn-cancel" id="cropCancel">Cancel</button>
        <button type="button" class="btn btn-save" id="cropSave">Save Photo</button>
      </div>
    </div>
  </div>

  <!-- Render universal header/footer shell with current page highlighted -->
  <script>
    window.HM && window.HM.renderShell({ currentPage: "account" });
  </script>
</body>
</html>
