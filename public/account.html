<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Account — Hemline Market</title>

  <!-- Shared styles -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
    }
    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }
    img,svg,canvas,video{max-width:100%;height:auto;display:block}
    .is-hidden{display:none!important;}

    main.account-wrap{
      max-width:1200px;
      margin:18px auto 24px;
      padding:0 12px;
    }

    h1.account-title{
      margin:0 0 4px;
      font-size:26px;
      font-weight:800;
      letter-spacing:.03em;
    }

    .account-subtitle{
      margin:0 0 18px;
      color:var(--hm-muted);
      font-size:14px;
    }

    .hm-card{
      background:#fff;
      border-radius:14px;
      border:1px solid var(--hm-border);
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      margin-bottom:16px;
    }
    .hm-card-header{
      padding:10px 16px;
      border-bottom:1px solid var(--hm-border);
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#9ca3af;
      font-weight:600;
    }
    .hm-card-body{
      padding:16px;
    }

    .profile-row{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:flex-start;
    }
    .profile-main{
      flex:1;
      min-width:220px;
      font-size:14px;
    }
    .profile-main-name{
      font-weight:700;
      font-size:16px;
      margin-bottom:2px;
    }
    .profile-main-email{
      color:var(--hm-muted);
      font-size:13px;
      margin-bottom:6px;
    }
    .profile-main-extra{
      font-size:13px;
      line-height:1.4;
      white-space:pre-line;
    }
    .profile-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:16px;
    }
    .pill-link{
      flex:1 1 140px;
      min-width:140px;
      max-width:260px;
      border-radius:999px;
      border:1px solid var(--hm-border);
      background:#fff;
      padding:10px 14px;
      text-decoration:none;
      display:flex;
      flex-direction:column;
      justify-content:center;
      box-shadow:0 4px 12px rgba(15,23,42,.04);
    }
    .pill-link-title{
      font-size:13px;
      font-weight:700;
      color:#111827;
    }
    .pill-link-sub{
      font-size:12px;
      color:#6b7280;
      margin-top:2px;
    }

    .btn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--hm-border);
      background:#fff;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-primary{
      border-color:var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      box-shadow:0 2px 10px rgba(153,27,27,.28);
    }

    .payout-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      font-size:13px;
    }
    .payout-copy{
      max-width:640px;
    }
    .payout-copy strong{
      display:block;
      font-size:14px;
      margin-bottom:3px;
    }
    .hint{
      font-size:12px;
      color:var(--hm-muted);
      margin-top:6px;
    }
    .payout-side{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      min-width:180px;
    }
    .inline-note{
      font-size:12px;
      color:var(--hm-muted);
      max-width:220px;
      text-align:right;
    }

    .address-block{
      font-size:13px;
      white-space:pre-line;
      color:#111827;
      margin-bottom:10px;
    }

    .field-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:8px;
    }
    .field{
      flex:1 1 140px;
      min-width:140px;
      display:flex;
      flex-direction:column;
      gap:3px;
      font-size:13px;
    }
    .field label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#6b7280;
      font-weight:600;
    }
    .field input,
    .field textarea,
    .field select{
      padding:7px 9px;
      border-radius:10px;
      border:1px solid var(--hm-border);
      font:inherit;
      font-size:13px;
      background:#f9fafb;
    }
    .field textarea{
      resize:vertical;
      min-height:70px;
    }
    .form-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
    }
    .muted-small{
      font-size:12px;
      color:var(--hm-muted);
      margin-top:6px;
    }
    .field-error{
      font-size:12px;
      color:#b91c1c;
      margin-top:2px;
    }

    .toggle-row{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
    }

    .editor-panel{
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid #f3f4f6;
    }

    @media (max-width:700px){
      .payout-row{flex-direction:column;align-items:flex-start;}
      .pill-link{max-width:none;}
      .payout-side{align-items:flex-start;}
      .inline-note{text-align:left;}
    }
  </style>
</head>
<body>

<div id="hm-shell-header"></div>

<main class="account-wrap" id="maincontent">
  <h1 class="account-title">Account</h1>
  <p class="account-subtitle">Manage your profile, payouts, shipping, vacation hold, and security.</p>

  <!-- PROFILE CARD -->
  <section class="hm-card">
    <div class="hm-card-header">Profile</div>
    <div class="hm-card-body">
      <div class="profile-row">
        <div class="profile-main">
          <div class="profile-main-name" id="profileName">Hemline member</div>
          <div class="profile-main-email" id="profileEmail">you@example.com</div>
          <div class="profile-main-extra" id="profileExtra"></div>

          <div class="profile-actions">
            <button class="btn" id="btnEditProfile">Edit profile</button>
            <button class="btn" id="btnLogout">Log out</button>
          </div>
        </div>
      </div>

      <div class="pill-row">
        <a class="pill-link" href="purchases.html">
          <span class="pill-link-title">Purchases</span>
          <span class="pill-link-sub">View your buying history</span>
        </a>
        <a class="pill-link" href="sales.html">
          <span class="pill-link-title">Sales</span>
          <span class="pill-link-sub">Manage your sales orders</span>
        </a>
        <a class="pill-link" href="messages.html">
          <span class="pill-link-title">Messages</span>
          <span class="pill-link-sub">Talk with buyers and sellers</span>
        </a>
        <a class="pill-link" href="favorites.html">
          <span class="pill-link-title">Favorites</span>
          <span class="pill-link-sub">Saved fabrics you like</span>
        </a>
        <a class="pill-link" href="atelier.html">
          <span class="pill-link-title">Your Atelier</span>
          <span class="pill-link-sub">Manage your fabric listings</span>
        </a>
      </div>

      <!-- EDITOR -->
      <section class="editor-panel is-hidden" id="profileEditor">
        <form id="profileForm">
          <div class="field-row">
            <div class="field">
              <label for="firstName">First name</label>
              <input id="firstName" name="firstName" type="text">
            </div>
            <div class="field">
              <label for="lastName">Last name</label>
              <input id="lastName" name="lastName" type="text">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="storeName">Store name</label>
              <input id="storeName" name="storeName" type="text">
              <p class="muted-small" id="storeNameHint">
                This becomes your shop link.
              </p>
              <p class="muted-small">
                Store link:
                <code>hemline.market/shop/<span id="storeSlugPreview">your-shop</span></code>
              </p>
              <p class="field-error" id="storeNameError"></p>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="bio">Short bio</label>
              <textarea id="bio" name="bio"></textarea>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary" type="submit">Save profile</button>
            <button class="btn" type="button" id="cancelProfileEdit">Cancel</button>
          </div>
        </form>
      </section>
    </div>
  </section>

  <!-- PAYOUTS -->
  <section class="hm-card">
    <div class="hm-card-header">Payouts</div>
    <div class="hm-card-body">
      <div class="payout-row">
        <div class="payout-copy">
          <strong>Payouts &amp; payments</strong>
          Stripe powers payments and payouts.
          <p class="hint">Use the button to open your Stripe Express dashboard.</p>
        </div>
        <div class="payout-side">
          <button class="btn btn-primary" id="btnStripe">Manage Stripe payouts</button>
          <div class="inline-note" id="stripeNote"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ADDRESS -->
  <section class="hm-card">
    <div class="hm-card-header">Shipping address</div>
    <div class="hm-card-body">
      <h3 style="margin:0 0 4px;font-size:14px;font-weight:700;">Ship-from address</h3>
      <p class="muted-small">This prints on prepaid labels.</p>

      <div class="address-block" id="addressDisplay">
        Add your ship-from name and address.
      </div>

      <button class="btn" id="btnEditAddress">Edit address</button>

      <section class="editor-panel is-hidden" id="addressEditor">
        <form id="addressForm">
          <div class="field-row">
            <div class="field">
              <label for="addrName">Name</label>
              <input id="addrName" name="addrName" type="text">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="addrLine1">Street address</label>
              <input id="addrLine1" name="addrLine1" type="text">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="addrLine2">Apartment, suite, etc.</label>
              <input id="addrLine2" name="addrLine2" type="text">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="addrCity">City</label>
              <input id="addrCity" name="addrCity" type="text">
            </div>
            <div class="field">
              <label for="addrState">State</label>
              <input id="addrState" name="addrState" type="text">
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="addrZip">Postal code</label>
              <input id="addrZip" name="addrZip" type="text">
            </div>
            <div class="field">
              <label for="addrCountry">Country</label>
              <select id="addrCountry" name="addrCountry">
                <option value="United States">United States</option>
                <option value="">Other</option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary" type="submit">Save address</button>
            <button class="btn" type="button" id="cancelAddressEdit">Cancel</button>
          </div>
        </form>
      </section>
    </div>
  </section>

  <!-- STATUS -->
  <section class="hm-card">
    <div class="hm-card-header">Status</div>
    <div class="hm-card-body">
      <h3 style="margin:0 0 4px;font-size:14px;font-weight:700;">Vacation hold</h3>
      <label class="toggle-row">
        <input id="vacationToggle" type="checkbox">
        <span>Turn on vacation hold</span>
      </label>
    </div>
  </section>

  <!-- SECURITY -->
  <section class="hm-card">
    <div class="hm-card-header">Security</div>
    <div class="hm-card-body">
      <p class="muted-small">To change your password, use your email provider’s reset link.</p>
      <button class="btn" id="btnChangePassword">Change password</button>
    </div>
  </section>
</main>

<div id="hm-shell-footer"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/hm-shell.js"></script>

<script>
const supabaseClient = window.supabase.createClient(
  "https://clkizksbvxjkoatdajgd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI",
  { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
);

function slugify(raw){
  if(!raw) return "";
  return raw.trim().toLowerCase()
    .replace(/['’]/g,"s")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/^-+|-+$/g,"");
}

function validate(raw){
  raw = (raw||"").trim();
  if(!raw) return {ok:true,slug:""};
  if(!/^[A-Za-z0-9\s'\-]+$/.test(raw))
    return {ok:false, slug:slugify(raw), message:"Invalid characters."};
  const s = slugify(raw);
  if(s.length<3) return {ok:false,slug:s,message:"Too short."};
  if(s.length>40) return {ok:false,slug:s,message:"Too long."};
  return {ok:true,slug:s};
}

async function ensureSession(){
  let {data:{session}} = await supabaseClient.auth.getSession();
  if(session?.user) return session;
  const start = Date.now();
  while(!session?.user && Date.now()-start<3000){
    await new Promise(r=>setTimeout(r,120));
    ({data:{session}}=await supabaseClient.auth.getSession());
  }
  return session;
}

(async function init(){
  const session = await ensureSession();
  if(!session || !session.user){
    window.location.href="auth.html?view=login";
    return;
  }

  const user = session.user;
  const email = user.email;
  const userId = user.id;

  const PROFILE_KEY="hm_profile_"+userId;
  const ADDRESS_KEY="hm_address_"+userId;
  const VAC_KEY="hm_vacation_"+userId;

  const profileNameEl=document.getElementById("profileName");
  const profileEmailEl=document.getElementById("profileEmail");
  const profileExtraEl=document.getElementById("profileExtra");

  const profileEditor=document.getElementById("profileEditor");
  const profileForm=document.getElementById("profileForm");
  const storeNameInput=document.getElementById("storeName");
  const storeSlugPreview=document.getElementById("storeSlugPreview");
  const storeNameError=document.getElementById("storeNameError");

  profileEmailEl.textContent=email;

  let profile={};
  try{ const raw=localStorage.getItem(PROFILE_KEY); if(raw) profile=JSON.parse(raw)||{}; }catch{}

  let displayName="";
  if(profile.storeName) displayName=profile.storeName;
  else if(profile.firstName||profile.lastName)
    displayName=(profile.firstName||"")+(profile.lastName?" "+profile.lastName:"");
  else displayName=email.split("@")[0];

  profileNameEl.textContent=displayName;

  const lines=[];
  if(profile.storeName) lines.push("Store name: "+profile.storeName);
  if(profile.storeSlug) lines.push("Store link: hemline.market/shop/"+profile.storeSlug);
  if(profile.bio) lines.push(profile.bio);
  profileExtraEl.textContent=lines.join("\n");

  let address={};
  try{ const raw=localStorage.getItem(ADDRESS_KEY); if(raw) address=JSON.parse(raw)||{}; }catch{}

  const addressDisplay=document.getElementById("addressDisplay");
  function renderAddress(){
    if(!address.addrLine1){
      addressDisplay.textContent="Add your ship-from name and address.";
      return;
    }
    const arr=[];
    if(address.addrName) arr.push(address.addrName);
    let l1=address.addrLine1;
    if(address.addrLine2) l1+="\n"+address.addrLine2;
    arr.push(l1);
    const city=[];
    if(address.addrCity) city.push(address.addrCity);
    if(address.addrState) city.push(address.addrState);
    if(address.addrZip) city.push(address.addrZip);
    if(city.length) arr.push(city.join(" "));
    if(address.addrCountry) arr.push(address.addrCountry);
    addressDisplay.textContent=arr.join("\n");
  }
  renderAddress();

  const addressForm=document.getElementById("addressForm");
  addressForm.addrName.value=address.addrName||"";
  addressForm.addrLine1.value=address.addrLine1||"";
  addressForm.addrLine2.value=address.addrLine2||"";
  addressForm.addrCity.value=address.addrCity||"";
  addressForm.addrState.value=address.addrState||"";
  addressForm.addrZip.value=address.addrZip||"";
  addressForm.addrCountry.value=address.addrCountry||"United States";

  document.getElementById("btnEditProfile").onclick=()=>{
    profileEditor.classList.remove("is-hidden");
    profileForm.firstName.focus();
  };
  document.getElementById("cancelProfileEdit").onclick=()=>{
    profileEditor.classList.add("is-hidden");
  };

  profileForm.onsubmit=e=>{
    e.preventDefault();

    const raw=storeNameInput.value.trim();
    const check=validate(raw);
    if(!check.ok){
      storeNameError.textContent=check.message;
      storeSlugPreview.textContent=check.slug;
      storeNameInput.focus();
      return;
    }
    storeNameError.textContent="";
    const next={
      firstName:profileForm.firstName.value.trim(),
      lastName:profileForm.lastName.value.trim(),
      storeName:raw,
      storeSlug:check.slug,
      bio:profileForm.bio.value.trim()
    };
    localStorage.setItem(PROFILE_KEY,JSON.stringify(next));
    profile=next;

    let dn="";
    if(next.storeName) dn=next.storeName;
    else if(next.firstName||next.lastName)
      dn=(next.firstName||"")+(next.lastName?" "+next.lastName:"");
    else dn=email.split("@")[0];
    profileNameEl.textContent=dn;

    const arr=[];
    if(next.storeName) arr.push("Store name: "+next.storeName);
    if(next.storeSlug) arr.push("Store link: hemline.market/shop/"+next.storeSlug);
    if(next.bio) arr.push(next.bio);
    profileExtraEl.textContent=arr.join("\n");

    storeSlugPreview.textContent=next.storeSlug||"your-shop";

    profileEditor.classList.add("is-hidden");
  };

  document.getElementById("btnEditAddress").onclick=()=>{
    document.getElementById("addressEditor").classList.remove("is-hidden");
    addressForm.addrName.focus();
  };
  document.getElementById("cancelAddressEdit").onclick=()=>{
    document.getElementById("addressEditor").classList.add("is-hidden");
  };
  addressForm.onsubmit=e=>{
    e.preventDefault();
    const next={
      addrName:addressForm.addrName.value.trim(),
      addrLine1:addressForm.addrLine1.value.trim(),
      addrLine2:addressForm.addrLine2.value.trim(),
      addrCity:addressForm.addrCity.value.trim(),
      addrState:addressForm.addrState.value.trim(),
      addrZip:addressForm.addrZip.value.trim(),
      addrCountry:addressForm.addrCountry.value
    };
    address=next;
    localStorage.setItem(ADDRESS_KEY,JSON.stringify(next));
    renderAddress();
    document.getElementById("addressEditor").classList.add("is-hidden");
  };

  const vacationToggle=document.getElementById("vacationToggle");
  vacationToggle.checked=localStorage.getItem(VAC_KEY)==="on";
  vacationToggle.onchange=()=>{
    localStorage.setItem(VAC_KEY,vacationToggle.checked?"on":"off");
  };

  document.getElementById("btnLogout").onclick=async()=>{
    await supabaseClient.auth.signOut();
    window.location.href="auth.html?view=login";
  };

  document.getElementById("btnChangePassword").onclick=()=>{
    alert("Use your email provider’s reset link.");
  };

  const stripeBtn=document.getElementById("btnStripe");
  const stripeNote=document.getElementById("stripeNote");

  stripeBtn.onclick=async()=>{
    stripeBtn.disabled=true;
    stripeBtn.textContent="Opening Stripe…";
    stripeNote.textContent="";

    const {data:{session}}=await supabaseClient.auth.getSession();
    const token=session?.access_token;
    if(!token){
      stripeNote.textContent="You must be logged in.";
      stripeBtn.disabled=false;
      stripeBtn.textContent="Manage Stripe payouts";
      return;
    }

    const r=await fetch(
      "https://clkizksbvxjkoatdajgd.supabase.co/functions/v1/onboard",
      {
        method:"POST",
        headers:{
          "Authorization":"Bearer "+token,
          "Content-Type":"application/json"
        }
      }
    );

    if(!r.ok){
      stripeNote.textContent="Unable to open Stripe.";
      stripeBtn.disabled=false;
      stripeBtn.textContent="Manage Stripe payouts";
      return;
    }

    const data=await r.json();
    if(data?.url) window.location.href=data.url;
    else{
      stripeNote.textContent="Missing Stripe link.";
      stripeBtn.disabled=false;
      stripeBtn.textContent="Manage Stripe payouts";
    }
  };
})();
</script>

<script>
window.HM && window.HM.renderShell({ currentPage:"account" });
</script>

</body>
</html>
