<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Purchases — Hemline Market</title>

  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">

  <!-- Shared styles (universal stack) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-text:#111827;
      --hm-muted:#6b7280;
      --hm-border:#e5e7eb;
      --hm-bg:#f4f4f7;
      --hm-card:#ffffff;
    }

    html, body{
      margin:0;
      background:var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    .wrap{
      max-width:1100px;
      margin:18px auto 28px;
      padding:0 12px;
    }

    .page-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin:6px 0 14px;
    }
    .page-head h1{
      margin:0;
      font-size:34px;
      letter-spacing:-0.02em;
    }
    .sub{
      margin:6px 0 0;
      color:var(--hm-muted);
      font-size:13px;
    }
    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--hm-muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid var(--hm-border);
      color:#374151;
      font-weight:600;
      font-size:12px;
    }

    .panel{
      background:rgba(255,255,255,.7);
      border:1px solid var(--hm-border);
      border-radius:14px;
      padding:14px;
    }

    .notice{
      border:1px solid #f3d1d1;
      background:#fff7f7;
      color:#7f1d1d;
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:10px;
    }

    .card{
      display:flex;
      gap:12px;
      align-items:stretch;
      background:var(--hm-card);
      border:1px solid var(--hm-border);
      border-radius:14px;
      overflow:hidden;
    }

    .thumb{
      width:132px;
      min-width:132px;
      background:linear-gradient(180deg,#f8fafc,#eef2f7);
      display:grid;
      place-items:center;
      position:relative;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb .fallback{
      font-weight:900;
      color:#9ca3af;
      font-size:28px;
      letter-spacing:.08em;
    }

    .body{
      flex:1;
      padding:12px 12px 12px 0;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }

    .row1{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      padding-top:10px;
      padding-right:12px;
    }

    .title{
      font-weight:800;
      font-size:15px;
      line-height:1.2;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:520px;
    }

    .badges{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--hm-muted);
      font-size:12px;
      flex-wrap:wrap;
      padding-right:12px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--hm-border);
      background:#fff;
      font-weight:700;
      font-size:11px;
      color:#374151;
    }
    .badge.paid{
      border-color:#c7d2fe;
      background:#eef2ff;
      color:#3730a3;
    }

    .right{
      text-align:right;
      padding-right:12px;
      min-width:190px;
    }
    .topline{
      font-weight:900;
      font-size:14px;
      color:#111827;
      white-space:nowrap;
    }
    .smallline{
      margin-top:2px;
      color:var(--hm-muted);
      font-size:12px;
      white-space:nowrap;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      padding:0 12px 12px 0;
      flex-wrap:wrap;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--hm-border);
      background:#fff;
      color:#111827;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      text-decoration:none;
      line-height:1;
    }
    .btn:hover{ filter:brightness(.98); }

    .btn.primary{
      border-color:var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
    }

    @media(max-width:720px){
      .thumb{ width:96px; min-width:96px; }
      .title{ max-width:260px; }
      .right{ min-width:auto; }
      .row1{ flex-direction:column; align-items:flex-start; }
      .right{ text-align:left; padding-right:0; }
      .body{ padding-right:12px; }
    }
  </style>
</head>

<body>
  <!-- UNIVERSAL HEADER (injected by hm-shell.js) -->
  <div id="hm-shell-header"></div>

  <main class="wrap">
    <div class="page-head">
      <div>
        <h1>Your Purchases</h1>
        <div class="sub">Fabric you’ve purchased on Hemline Market.</div>
      </div>
      <div class="meta">
        <span id="authState">—</span>
        <span id="countPill" class="pill" style="display:none"></span>
      </div>
    </div>

    <section class="panel">
      <div id="notice" class="notice" style="display:none"></div>
      <div id="list" class="list"></div>

      <div id="empty" style="display:none;color:var(--hm-muted);padding:14px 2px;">
        You haven’t purchased anything yet.
      </div>
    </section>
  </main>

  <!-- UNIVERSAL FOOTER (injected by hm-shell.js) -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase JS (CDN, non-module) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Shared shell (universal header/footer + menu + header session) -->
  <script src="scripts/hm-shell.js"></script>

  <script>
    // Render shared header + footer
    window.HM && window.HM.renderShell({ currentPage: "purchases" });
  </script>

  <script>
    // IMPORTANT: keep this page non-module; use window.supabase from CDN.
    const SUPABASE_URL = "https://clkizksbvxjkoatdajgd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI";

    const sb = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const elNotice = document.getElementById("notice");
    const elList   = document.getElementById("list");
    const elEmpty  = document.getElementById("empty");
    const elAuth   = document.getElementById("authState");
    const elPill   = document.getElementById("countPill");

    function showNotice(msg){
      elNotice.style.display = "block";
      elNotice.textContent = msg;
    }
    function hideNotice(){
      elNotice.style.display = "none";
      elNotice.textContent = "";
    }

    function moneyFromCents(cents){
      const n = Number(cents || 0) / 100;
      return n.toLocaleString("en-US", { style:"currency", currency:"USD", minimumFractionDigits:2, maximumFractionDigits:2 });
    }

    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleDateString("en-US", { year:"numeric", month:"short", day:"numeric" });
      }catch(e){
        return "";
      }
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;");
    }

    function extractSnapshot(order){
      // Be defensive: snapshot shapes evolve.
      const snap = order?.listing_snapshot || {};
      const items = Array.isArray(snap.items) ? snap.items : [];
      const first = items[0] || {};

      const title =
        snap.listing_title ||
        order.listing_title ||
        first.name ||
        "Purchase";

      const photo =
        first.photo ||
        snap.photo ||
        snap.image_url_1 ||
        snap.image ||
        "";

      // quantity may represent yards (your current system uses qty ~ yards)
      const qty =
        Number(first.qty ?? snap.qty ?? order.qty ?? 0) || 0;

      return { title, photo, qty };
    }

    function renderPurchaseCard(order){
      const { title, photo, qty } = extractSnapshot(order);

      const listingId = order.listing_id || order.listingId || "";
      const href = listingId ? ("listing.html?id=" + encodeURIComponent(listingId)) : "";

      const status = String(order.status || "").toUpperCase();
      const paid = status === "PAID" || status === "COMPLETED" || status === "FULFILLED";

      const itemsCents = Number(order.items_cents ?? order.itemsCents ?? null);
      const shippingCents = Number(order.shipping_cents ?? order.shippingCents ?? null);
      const totalCents = Number(order.total_cents ?? order.totalCents ?? null);

      // Prefer explicit cents; fall back to best available.
      const effectiveItems = Number.isFinite(itemsCents) ? itemsCents : (Number.isFinite(totalCents) ? totalCents : 0);
      const effectiveShip  = Number.isFinite(shippingCents) ? shippingCents : 0;

      const topLineParts = [];
      if(Number.isFinite(effectiveItems) && qty){
        topLineParts.push(`${moneyFromCents(effectiveItems)} for ${qty} ${qty === 1 ? "yard" : "yards"}`);
      }else if(Number.isFinite(effectiveItems)){
        topLineParts.push(`${moneyFromCents(effectiveItems)}`);
      }
      const topLine = topLineParts.join(" ");

      const right2 = `${moneyFromCents(effectiveShip)} shipping`;

      const badgeHtml = paid
        ? `<span class="badge paid">PAID</span>`
        : `<span class="badge">ORDER</span>`;

      const when = order.created_at ? fmtDate(order.created_at) : "";

      const thumbHtml = photo
        ? `<img src="${esc(photo)}" alt="${esc(title)}">`
        : `<div class="fallback">HM</div>`;

      const card = document.createElement("article");
      card.className = "card";

      card.innerHTML = `
        <div class="thumb">${thumbHtml}</div>

        <div class="body">
          <div class="row1">
            <div style="min-width:0">
              <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                <h3 class="title">${esc(title)}</h3>
              </div>
              <div class="badges">
                ${badgeHtml}
                ${qty ? `<span>${qty} ${qty === 1 ? "yard" : "yards"}</span>` : ``}
                ${when ? `<span>•</span><span>${esc(when)}</span>` : ``}
              </div>
            </div>

            <div class="right">
              <div class="topline">${esc(topLine)}</div>
              <div class="smallline">${esc(right2)}</div>
            </div>
          </div>

          <div class="actions">
            ${
              href
                ? `<a class="btn" href="${href}" title="Open listing">↗ Listing</a>`
                : `<span class="btn" style="opacity:.6;cursor:not-allowed;">↗ Listing</span>`
            }
          </div>
        </div>
      `;

      return card;
    }

    async function loadPurchases(){
      if(!sb){
        showNotice("Supabase client not found. (Check the Supabase CDN script tag.)");
        elAuth.textContent = "Not ready";
        return;
      }

      hideNotice();
      elList.innerHTML = "";
      elEmpty.style.display = "none";
      elPill.style.display = "none";

      // Session required (buyer_id filter depends on current user)
      const { data: sessionData, error: sessionErr } = await sb.auth.getSession();
      if(sessionErr){
        console.error("getSession error", sessionErr);
      }
      const session = sessionData?.session;
      const user = session?.user;

      if(!user){
        elAuth.textContent = "Not signed in";
        showNotice("Please sign in to view your purchases.");
        elEmpty.style.display = "block";
        return;
      }

      elAuth.textContent = "Signed in";

      // Fetch orders where this user is the buyer
      let orders = [];
      try{
        const { data, error } = await sb
          .from("orders")
          .select("id, created_at, status, buyer_id, listing_id, listing_snapshot, items_cents, shipping_cents, total_cents")
          .eq("buyer_id", user.id)
          .order("created_at", { ascending:false })
          .limit(50);

        if(error){
          console.error("orders fetch error", error);
          showNotice("Error loading purchases. (Check orders RLS for buyer read.)");
          return;
        }

        orders = data || [];
      }catch(e){
        console.error("orders fetch exception", e);
        showNotice("Error loading purchases.");
        return;
      }

      if(!orders.length){
        elEmpty.style.display = "block";
        return;
      }

      elPill.style.display = "inline-flex";
      elPill.textContent = orders.length === 1 ? "1 purchase" : `${orders.length} purchases`;

      orders.forEach(o => elList.appendChild(renderPurchaseCard(o)));
    }

    document.addEventListener("DOMContentLoaded", loadPurchases);
  </script>
</body>
</html>
