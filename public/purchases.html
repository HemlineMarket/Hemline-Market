<script>
  function formatMoney(cents){
    const n = Number(cents || 0) / 100;
    return n.toLocaleString(undefined,{ style:"currency", currency:"USD" });
  }

  function formatDate(iso){
    if (!iso) return "";
    const d = new Date(iso);
    return d.toLocaleDateString(undefined,{
      month:"short",
      day:"numeric",
      year:"numeric"
    });
  }

  async function waitForSupabase(timeout = 4000){
    const start = Date.now();
    while (!window.HM || !window.HM.supabase){
      if (Date.now() - start > timeout) return null;
      await new Promise(r => setTimeout(r, 100));
    }
    return window.HM.supabase;
  }

  document.addEventListener("DOMContentLoaded", async () => {
    window.HM.renderShell({ currentPage:"purchases" });

    const supabase = await waitForSupabase();
    if (!supabase){
      console.error("Supabase not available");
      return;
    }

    const list  = document.getElementById("purchasesList");
    const empty = document.getElementById("emptyState");

    const { data:{ session } } = await supabase.auth.getSession();
    if (!session || !session.user){
      empty.style.display = "block";
      empty.textContent = "Sign in to view your purchases.";
      return;
    }

    const uid   = session.user.id;
    const email = session.user.email;

    const { data, error } = await supabase
      .from("orders")
      .select("*")
      .or(`buyer_id.eq.${uid},buyer_email.eq.${email}`)
      .order("created_at", { ascending:false });

    if (error){
      console.error(error);
      empty.style.display = "block";
      empty.textContent = "Unable to load purchases.";
      return;
    }

    if (!data || !data.length){
      empty.style.display = "block";
      return;
    }

    empty.style.display = "none";
    list.innerHTML = "";

    data.forEach(o => {
      const card = document.createElement("div");
      card.className = "purchase-card";

      card.innerHTML = `
        <div class="purchase-top">
          <span>Order #${String(o.id).slice(0,8)}</span>
          <span>${formatDate(o.created_at)}</span>
        </div>

        <div class="purchase-status">
          ${String(o.status || "PAID").toUpperCase()}
        </div>

        <div class="purchase-meta">
          <div>Total: <strong>${formatMoney(o.total_cents)}</strong></div>
        </div>

        <div class="purchase-items">
          <div><span class="name">${o.listing_title || o.listing_name || "Purchase"}</span></div>
        </div>
      `;

      list.appendChild(card);
    });
  });
</script>
