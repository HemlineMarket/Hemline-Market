<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Purchases ‚Äî Hemline Market</title>

  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
  <link rel="apple-touch-icon" href="/images/icon.png">
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
      --hm-card:rgba(255,255,255,.96);
    }
    html,body{margin:0;background:url("images/homepage.jpeg") center/cover fixed no-repeat,var(--hm-bg);color:var(--hm-text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:980px;margin:18px auto 28px;padding:0 12px}
    h1{margin:10px 0 4px;font-size:32px}
    .sub{color:var(--hm-muted);margin:0 0 14px}
    .bar{display:flex;justify-content:space-between;align-items:center;margin:8px 0 14px;gap:12px;flex-wrap:wrap}
    .pill{font-size:12px;color:#374151;background:#fff;border:1px solid var(--hm-border);border-radius:999px;padding:6px 10px}

    .notice{
      background:#fff;border:1px solid var(--hm-border);border-radius:12px;
      padding:12px;color:#374151;display:none
    }
    .notice.error{border-color:#fecaca;background:#fff1f2;color:#7f1d1d;display:block}
    .notice.ok{display:block}

    .grid{display:grid;gap:12px}

    .card{
      background:var(--hm-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      padding:12px;
      display:flex;
      gap:12px;
      align-items:start;
      overflow:hidden;
    }
    .thumbLink{display:block;text-decoration:none;color:inherit;flex-shrink:0}
    .thumb{
      width:110px;height:110px;border-radius:12px;overflow:hidden;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      display:flex;align-items:center;justify-content:center;
      flex-shrink:0;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb-placeholder{
      width:100%;height:100%;
      display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    }
    .thumb-placeholder svg{color:#9ca3af;}

    .row1{display:flex;gap:10px;align-items:flex-start}
    .title{font-weight:800;font-size:15px}
    .meta{font-size:13px;color:var(--hm-muted);margin-top:2px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .right{margin-left:auto;text-align:right}
    .total{font-weight:800}
    .small{font-size:12px;color:var(--hm-muted);margin-top:2px}

    .actions{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
    .btn{
      padding:8px 10px;border-radius:10px;border:1px solid var(--hm-border);background:#fff;
      font-weight:700;font-size:13px;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      text-decoration:none;color:#374151;
    }
    .btn:hover{border-color:#d1d5db}
    .btn-danger{
      background:var(--hm-accent);
      border-color:var(--hm-accent);
      color:#fff;
      padding:8px 10px;
      font-size:13px;
      font-weight:700;
    }
    .btn-disabled{
      opacity:.55; cursor:not-allowed;
    }

    .select{
      padding:8px 10px;border-radius:10px;border:1px solid var(--hm-border);background:#fff;
      font-size:13px;min-width:240px;
    }

    .note{
      font-size:12px;color:var(--hm-muted);margin-top:8px
    }
    .note.warn{color:#b45309;font-weight:600}

    .statusBadge{
      font-size:12px;
      border:1px solid var(--hm-border);
      border-radius:999px;
      padding:4px 10px;
      background:#fff;
      font-weight:700;
      color:#374151;
    }

    .miniIcon{
      width:18px;height:18px;display:inline-grid;place-items:center;
      border-radius:6px;background:#f3f4f6;border:1px solid #e5e7eb;
      font-size:12px;line-height:1;
    }

    /* Loading skeleton */
    .skeleton-card{
      background:var(--hm-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      padding:12px;
      display:flex;
      gap:12px;
      align-items:start;
    }
    .skeleton-thumb{
      width:110px;height:110px;border-radius:12px;
      background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%);
      background-size:200% 100%;
      animation:skeleton-shimmer 1.5s ease-in-out infinite;
      flex-shrink:0;
    }
    .skeleton-lines{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px 0}
    .skeleton-line{
      height:14px;border-radius:6px;
      background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%);
      background-size:200% 100%;
      animation:skeleton-shimmer 1.5s ease-in-out infinite;
    }
    .skeleton-line.w80{width:80%}
    .skeleton-line.w60{width:60%}
    .skeleton-line.w40{width:40%}
    @keyframes skeleton-shimmer{
      0%{background-position:200% 0}
      100%{background-position:-200% 0}
    }

    @media(max-width:640px){
      .card{flex-direction:column}
      .thumb{width:100%;height:180px}
      .right{text-align:left;margin-left:0}
      .row1{flex-wrap:wrap}
      .select{min-width:0;width:100%}
    }
  @media(max-width:768px){body{background-position:20% center;}}
  </style>
  <!-- Vercel Web Analytics -->
  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
</head>

<body>
  <div id="hm-shell-header"></div>

  <main class="wrap">
    <div class="bar">
      <div>
        <h1>Your Purchases</h1>
        <p class="sub">Fabric you've purchased on Hemline Market.</p>
      </div>
      <div class="pill" id="statusPill">Loading...</div>
    </div>

    <div id="msg" class="notice"></div>
    <div id="list" class="grid"></div>
  </main>

  <div id="hm-shell-footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="scripts/hm-shell.js"></script>

  <script>
    window.HM && window.HM.renderShell({ currentPage: "purchases" });

    const supabaseClient = window.__hm_supabase || (window.__hm_supabase =
      window.supabase.createClient(
        "https://clkizksbvxjkoatdajgd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI"
      )
    );

    const elList = document.getElementById("list");
    const elMsg  = document.getElementById("msg");
    const elPill = document.getElementById("statusPill");

    function showMsg(text, kind){
      elMsg.style.display = "block";
      elMsg.className = "notice " + (kind === "error" ? "error" : "ok");
      elMsg.textContent = text;
    }
    function clearMsg(){ elMsg.style.display = "none"; elMsg.textContent = ""; }

    function money(cents){
      const v = (Number(cents || 0) / 100);
      return v.toLocaleString("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2});
    }
    function fmtDate(iso){
      try{ return new Date(iso).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}); }
      catch(e){ return ""; }
    }
    function minutesSince(iso){
      if(!iso) return Infinity;
      const ms = Date.now() - new Date(iso).getTime();
      return ms / 60000;
    }

    function minutesRemaining(iso){
      if(!iso) return 0;
      const elapsed = minutesSince(iso);
      return Math.max(0, 30 - elapsed);
    }

    function formatTimeRemaining(iso){
      const mins = minutesRemaining(iso);
      if(mins <= 0) return null;
      const m = Math.floor(mins);
      const s = Math.floor((mins - m) * 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function listingHref(listingId){
      return "listing.html?id=" + encodeURIComponent(listingId);
    }
    
    function orderHref(orderId){
      return "order-buyer.html?id=" + encodeURIComponent(orderId);
    }

    function safeUpper(x){ return String(x || "").toUpperCase(); }

    function supportMailto(order, reasonLabel){
      const orderShort = String(order.id || "").slice(0, 8);
      const created = order.created_at ? new Date(order.created_at).toISOString() : "";
      const status = safeUpper(order.status || "");

      const body =
`Hi Hemline Market Support,

I need help with my order.

Reason: ${reasonLabel}
Order: ${orderShort} (${order.id})
Purchased: ${created}
Status: ${status}

Please advise next steps.
`;

      const subject = encodeURIComponent(`Order help: ${reasonLabel} (#${orderShort})`);
      const mailto = `mailto:hello@hemlinemarket.com?subject=${subject}&body=${encodeURIComponent(body)}`;
      window.location.href = mailto;
    }

    async function buyerCancelOrder(order, user){
      const status = safeUpper(order.status || "");
      const isCancelled = (status === "CANCELED" || status === "CANCELLED");
      const alreadyRequested = !!order.cancel_requested_at;
      const within = minutesSince(order.created_at) <= 30;

      if(!within || isCancelled || alreadyRequested) return { ok:false, skipped:true };

      // Get auth token for API call
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session?.access_token) {
        return { ok:false, error: "Please sign in to cancel orders" };
      }

      // Call the API to handle Stripe refund, emails, and notifications
      try {
        const response = await fetch("/api/cancel_purchase", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${session.access_token}`
          },
          body: JSON.stringify({
            order_id: order.id
          })
        });

        const data = await response.json();

        if(!response.ok){
          console.error("[purchases] cancel API error:", data);
          return { ok:false, error: data.error || "Cancel failed" };
        }

        return { ok:true, refund_id: data.refund_id };
      } catch(err){
        console.error("[purchases] cancel failed:", err);
        return { ok:false, error: err.message };
      }
    }

    function showLoadingSkeleton(){
      elList.innerHTML = `
        <div class="skeleton-card">
          <div class="skeleton-thumb"></div>
          <div class="skeleton-lines">
            <div class="skeleton-line w80"></div>
            <div class="skeleton-line w60"></div>
            <div class="skeleton-line w40"></div>
          </div>
        </div>
        <div class="skeleton-card" style="opacity:0.7">
          <div class="skeleton-thumb"></div>
          <div class="skeleton-lines">
            <div class="skeleton-line w60"></div>
            <div class="skeleton-line w80"></div>
            <div class="skeleton-line w40"></div>
          </div>
        </div>
        <div class="skeleton-card" style="opacity:0.4">
          <div class="skeleton-thumb"></div>
          <div class="skeleton-lines">
            <div class="skeleton-line w80"></div>
            <div class="skeleton-line w40"></div>
            <div class="skeleton-line w60"></div>
          </div>
        </div>
      `;
    }

    async function loadPurchases(){
      clearMsg();
      elPill.textContent = "Loading...";
      showLoadingSkeleton();

      const { data: sessData, error: sessErr } = await supabaseClient.auth.getSession();
      if(sessErr){
        console.error(sessErr);
        elPill.textContent = "Not ready";
        elList.innerHTML = "";
        showMsg("Session error. Please refresh.", "error");
        return;
      }

      const user = sessData?.session?.user;
      if(!user){
        elPill.textContent = "Not signed in";
        elList.innerHTML = "";
        showMsg("Please sign in to view your purchases.", "error");
        return;
      }

      const uid = user.id;

      // Fetch orders - exclude self-purchases in query
      // Note: listing_image is the correct field name from webhook
      const { data: orders, error: ordErr } = await supabaseClient
        .from("orders")
        .select("id, created_at, status, total_cents, shipping_cents, listing_id, listing_title, listing_image, cancel_requested_at, canceled_at, canceled_by, cancel_reason, seller_id, shipped_at, tracking_number, delivered_at")
        .eq("buyer_id", uid)
        .neq("seller_id", uid)
        .order("created_at", { ascending:false })
        .limit(100);

      if(ordErr){
        console.error("Orders fetch error:", ordErr);
        elPill.textContent = "Error";
        elList.innerHTML = "";
        showMsg("Error loading purchases. Please try again.", "error");
        return;
      }

      const list = orders || [];
      if(!list.length){
        elPill.textContent = "0 purchases";
        elList.innerHTML = "";
        showMsg("You haven't purchased anything yet.", "ok");
        return;
      }

      elPill.textContent = list.length === 1 ? "1 purchase" : `${list.length} purchases`;

      // Fetch listing images as fallback
      const ids = Array.from(new Set(list.map(o => o.listing_id).filter(Boolean)));
      const listingMap = {};
      if(ids.length){
        const { data: listings, error: lErr } = await supabaseClient
          .from("listings")
          .select("id, title, image_url_1")
          .in("id", ids);

        if(!lErr && listings){
          listings.forEach(l => listingMap[l.id] = l);
        } else {
          console.warn("Listing fetch failed (non-fatal):", lErr);
        }
      }

      elList.innerHTML = "";

      list.forEach(order => {
        const listing = listingMap[order.listing_id] || null;

        // Use order fields first, fallback to listing
        const title = order.listing_title || listing?.title || "Fabric Order";
        // FIXED: Use listing_image (from webhook), fallback to listing_image_url, then listing.image_url_1
        const img = order.listing_image || order.listing_image_url || listing?.image_url_1 || "";
        const hasListing = !!order.listing_id;

        const status = safeUpper(order.status || "PAID");

        const totalCents = Number(order.total_cents || 0);
        const shipCents = Number(order.shipping_cents || 0);

        const within = minutesSince(order.created_at) <= 30;
        const isCancelled = (status === "CANCELED" || status === "CANCELLED");
        const alreadyRequested = !!order.cancel_requested_at;
        const canCancel = within && !isCancelled && !alreadyRequested && (status === "PAID" || status === "PENDING" || status === "");

        const orderShort = String(order.id || "").slice(0,8);

        const card = document.createElement("div");
        card.className = "card";

        // Build image HTML with fallback
        let thumbHtml = '';
        if(img){
          thumbHtml = hasListing 
            ? `<a class="thumbLink" href="${listingHref(order.listing_id)}" aria-label="Open listing">
                <div class="thumb"><img src="${img}" alt="" onerror="this.style.display='none';this.parentElement.innerHTML='<div class=thumb-placeholder><svg width=40 height=40 viewBox=0 0 24 24 fill=none stroke=#9ca3af stroke-width=1.5><rect x=3 y=3 width=18 height=18 rx=2/><circle cx=8.5 cy=8.5 r=1.5/><path d=M21 15l-5-5L5 21/></svg></div>'"></div>
              </a>`
            : `<div class="thumb"><img src="${img}" alt="" onerror="this.style.display='none';this.parentElement.innerHTML='<div class=thumb-placeholder><svg width=40 height=40 viewBox=0 0 24 24 fill=none stroke=#9ca3af stroke-width=1.5><rect x=3 y=3 width=18 height=18 rx=2/><circle cx=8.5 cy=8.5 r=1.5/><path d=M21 15l-5-5L5 21/></svg></div>'"></div>`;
        } else {
          thumbHtml = `<div class="thumb">
            <div class="thumb-placeholder">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="1.5">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <path d="M21 15l-5-5L5 21"/>
              </svg>
            </div>
          </div>`;
        }

        // FIXED: Cancel within 30 min = just a button, no reason needed
        // After 30 min = Contact Support link
        // Problem dropdown only for non-cancelled, after 30 min
        let cancelHtml = '';
        let problemHtml = '';
        let noteHtml = '';

        if(isCancelled){
          cancelHtml = `<span class="note">Order cancelled</span>`;
          noteHtml = `<div class="note">Order cancelled.</div>`;
        } else if(canCancel){
          // Within 30 minutes - simple cancel button with countdown
          const timeLeft = formatTimeRemaining(order.created_at);
          cancelHtml = `<button class="btn btn-danger" data-cancel-btn>Cancel</button>`;
          noteHtml = `<div class="note warn" data-countdown="${order.created_at}">‚è±Ô∏è Cancel window: <strong>${timeLeft || '0:00'}</strong> remaining</div>`;
        } else {
          // After 30 minutes - show problem dropdown and contact support
          problemHtml = `
            <select class="select" data-problem>
              <option value="">Problems / Order Inquiry</option>
              <option value="delayed">Order is Delayed</option>
              <option value="not_as_described">Order Not as Described</option>
              <option value="message_seller">Message Seller</option>
              <option value="contact_support">Contact Support Center</option>
            </select>
          `;
          cancelHtml = `<a class="btn" href="contact.html?subject=Order%20${orderShort}">Contact Support</a>`;
        }

        card.innerHTML = `
          ${thumbHtml}

          <div style="flex:1;min-width:0;">
            <div class="row1">
              <div>
                <a href="${orderHref(order.id)}" class="title" style="text-decoration:none;color:inherit">${title}</a>
                <div class="meta">
                  <span class="statusBadge">${status}</span>
                  <span>Purchased ${fmtDate(order.created_at)}</span>
                  <span class="pill">Order #${orderShort}</span>
                </div>
              </div>

              <div class="right">
                <div class="total">${money(totalCents)}</div>
                <div class="small">Shipping: ${money(shipCents)}</div>
              </div>
            </div>

            <div class="actions">
              <a class="btn" href="${orderHref(order.id)}">
                <span class="miniIcon">üì¶</span>
                <span>View Order</span>
              </a>
              ${hasListing ? `
                <a class="btn" href="${listingHref(order.listing_id)}" aria-label="View listing">
                  <span class="miniIcon">‚Üó</span>
                  <span>View listing</span>
                </a>
              ` : ``}
              ${(status === 'DELIVERED' || status === 'COMPLETE') && hasListing ? `
                <button class="btn" data-relist-btn data-listing-id="${order.listing_id}" data-listing-title="${title.replace(/"/g, '&quot;')}">
                  <span class="miniIcon">üîÑ</span>
                  <span>Relist</span>
                </button>
              ` : ``}

              ${problemHtml}

              ${cancelHtml}
            </div>

            ${noteHtml}
          </div>
        `;

        // Handle problem dropdown (only exists after 30 min)
        const sel = card.querySelector("[data-problem]");
        if(sel){
          sel.addEventListener("change", async () => {
            const v = sel.value;
            if(!v) return;

            if(v === "delayed"){
              supportMailto(order, "Order is Delayed");
            } else if(v === "not_as_described"){
              supportMailto(order, "Order Not as Described");
            } else if(v === "message_seller"){
              supportMailto(order, "Message Seller");
            } else {
              supportMailto(order, "Contact Support Center");
            }

            sel.value = "";
          });
        }

        // Handle cancel button (only exists within 30 min)
        const cancelBtn = card.querySelector("[data-cancel-btn]");
        if(cancelBtn){
          cancelBtn.addEventListener("click", async () => {
            // Simple confirmation
            if(!confirm("Cancel this order? You'll receive a full refund.")) return;
            
            cancelBtn.disabled = true;
            cancelBtn.textContent = "Cancelling...";
            const res = await buyerCancelOrder(order, user);
            if(res?.ok){
              loadPurchases();
              return;
            }
            cancelBtn.textContent = "Cancel";
            cancelBtn.disabled = false;
            alert("Could not cancel order. Please contact support.");
          });
        }

        // Handle relist button (only exists for DELIVERED/COMPLETE orders)
        const relistBtn = card.querySelector("[data-relist-btn]");
        if(relistBtn){
          relistBtn.addEventListener("click", async () => {
            const listingId = relistBtn.dataset.listingId;
            const listingTitle = relistBtn.dataset.listingTitle;
            
            if(!confirm(`Relist "${listingTitle}"?\n\nThis will create a draft listing based on this item. Images will display "Relisted from [original seller]" watermark.\n\nYou can edit all details before publishing.`)) return;
            
            relistBtn.disabled = true;
            relistBtn.innerHTML = '<span class="miniIcon">‚è≥</span> <span>Creating...</span>';
            
            try {
              const session = await supabase.auth.getSession();
              const token = session?.data?.session?.access_token;
              if(!token) throw new Error("Please sign in to relist");
              
              const res = await fetch("/api/listings/relist", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ listing_id: listingId })
              });
              
              const data = await res.json();
              
              if(!res.ok) throw new Error(data.error || "Failed to create relist");
              
              alert("Relist created! Redirecting to edit...");
              window.location.href = `/sell.html?edit=${data.listing.id}`;
              
            } catch(err) {
              console.error("Relist error:", err);
              alert(err.message || "Failed to create relist. Please try again.");
              relistBtn.disabled = false;
              relistBtn.innerHTML = '<span class="miniIcon">üîÑ</span> <span>Relist</span>';
            }
          });
        }

        elList.appendChild(card);
      });

      // Start countdown timer updates
      startCountdownTimers();
    }

    // Update countdown timers every second
    let countdownInterval = null;
    function startCountdownTimers(){
      if(countdownInterval) clearInterval(countdownInterval);
      
      countdownInterval = setInterval(() => {
        const countdowns = document.querySelectorAll('[data-countdown]');
        countdowns.forEach(el => {
          const iso = el.dataset.countdown;
          const timeLeft = formatTimeRemaining(iso);
          if(timeLeft){
            el.innerHTML = `‚è±Ô∏è Cancel window: <strong>${timeLeft}</strong> remaining`;
          } else {
            // Time expired - reload to update UI
            clearInterval(countdownInterval);
            loadPurchases();
          }
        });
      }, 1000);
    }

    loadPurchases();
  </script>
</body>
</html>
