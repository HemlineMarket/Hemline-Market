<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Purchases — Hemline Market</title>

  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico"/>
</head>
<body>

  <main style="max-width:1100px;margin:24px auto;padding:0 16px;">
    <h1>Your Purchases</h1>
    <p>Everything you’ve bought, pulled directly from Supabase.</p>

    <div>
      <span id="status">Signed out</span> ·
      <span id="count">0</span> items
    </div>

    <div id="list"></div>
    <pre id="err" style="color:red;"></pre>
  </main>

  <!-- IMPORTANT: Supabase client is an ES MODULE -->
  <script type="module">
    import { supabase } from '/scripts/supabase-client.js';

    const status = document.getElementById('status');
    const count = document.getElementById('count');
    const list = document.getElementById('list');
    const err = document.getElementById('err');

    try {
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        location.href = '/account.html';
        throw new Error('No session');
      }

      status.textContent = 'Signed in';

      const { data, error } = await supabase
        .from('purchases_feed')
        .select('*')
        .order('purchased_at', { ascending: false });

      if (error) throw error;

      count.textContent = data.length;

      list.innerHTML = data.map(p => `
        <div style="margin:12px 0;padding:12px;border:1px solid #ddd;">
          <strong>${p.listing_title}</strong><br/>
          $${(p.item_price_cents/100).toFixed(2)}<br/>
          Order ${String(p.order_id).slice(0,8)}
        </div>
      `).join('');

    } catch (e) {
      err.textContent = e.message;
    }
  </script>

</body>
</html>
