<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Purchases — Hemline Market</title>

  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico"/>

  <style>
    :root{
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
      --hm-card:#ffffff;
    }
    html,body{margin:0;background:var(--hm-bg);color:var(--hm-text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1180px;margin:0 auto;padding:18px 14px 40px}
    .page-title{margin:10px 0 6px;font-size:28px;letter-spacing:-.02em}
    .sub{margin:0 0 16px;color:var(--hm-muted)}
    .layout{display:grid;grid-template-columns:260px 1fr;gap:18px;align-items:start}
    @media (max-width: 920px){ .layout{grid-template-columns:1fr} .sidebar{display:none} }

    .card{background:var(--hm-card);border:1px solid var(--hm-border);border-radius:16px;overflow:hidden}
    .sidebar .sec{padding:12px 12px}
    .sidebar h3{margin:0 0 10px;font-size:13px;color:var(--hm-muted);text-transform:uppercase;letter-spacing:.08em}
    .nav a{display:flex;align-items:center;justify-content:space-between;padding:10px 10px;border-radius:12px;text-decoration:none;color:inherit}
    .nav a:hover{background:#f3f4f6}
    .nav .active{background:#eef2ff}
    .nav small{color:var(--hm-muted);font-weight:600}

    .main .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px;border-bottom:1px solid var(--hm-border)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--hm-border);border-radius:999px;background:#fff;font-size:13px}
    .btn{border:1px solid var(--hm-border);background:#fff;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn:hover{border-color:#d1d5db}

    .searchRow{padding:12px 14px;border-bottom:1px solid var(--hm-border);display:flex;gap:10px;align-items:center}
    .search{
      width:100%;
      border:1px solid var(--hm-border);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }

    .list{display:flex;flex-direction:column}
    .row{display:flex;gap:12px;align-items:flex-start;padding:14px;border-top:1px solid var(--hm-border);text-decoration:none;color:inherit;background:#fff}
    .row:hover{background:#fafafa}
    .thumb{width:56px;height:56px;border-radius:12px;background:#f3f4f6;border:1px solid var(--hm-border);flex:0 0 auto;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .title{font-weight:850;margin:0 0 4px;letter-spacing:-.01em;line-height:1.2}
    .meta{color:var(--hm-muted);font-size:13px}
    .price{margin-left:auto;font-weight:950;white-space:nowrap}

    .empty{display:none;padding:16px;color:var(--hm-muted)}
    .err{display:none;padding:14px;background:#fff5f5;color:#991b1b;border-top:1px solid var(--hm-border);white-space:pre-wrap}
    .cta{display:none;padding:14px;border-top:1px solid var(--hm-border);background:#fff;align-items:center;justify-content:space-between;gap:10px}
    .cta p{margin:0;color:var(--hm-muted)}
  </style>
</head>

<body>
  <!-- Universal header/footer -->
  <div id="hm-shell-header"></div>

  <main class="wrap">
    <h1 class="page-title">Your Purchases</h1>
    <p class="sub">Everything you’ve bought, pulled directly from Supabase.</p>

    <div class="layout">
      <!-- Left nav (Purchases only) -->
      <aside class="sidebar card">
        <div class="sec">
          <h3>Order Activity</h3>
          <nav class="nav">
            <a class="active" href="/purchases.html">My Purchases <small id="navCount">0</small></a>
          </nav>
        </div>
      </aside>

      <!-- Main -->
      <section class="main card">
        <div class="topbar">
          <div class="chips">
            <span class="pill"><strong id="status">Checking…</strong></span>
            <span class="pill"><strong id="count">0</strong> items</span>
          </div>
          <button class="btn" id="refreshBtn" type="button">Refresh</button>
        </div>

        <div class="searchRow">
          <input id="q" class="search" placeholder="Search My Purchases" autocomplete="off"/>
        </div>

        <div id="cta" class="cta">
          <p>You’re signed out. Sign in to view your purchases.</p>
          <a class="btn" href="/account.html" style="text-decoration:none;display:inline-block;">Go to Sign In</a>
        </div>

        <div id="list" class="list"></div>
        <div id="empty" class="empty">No purchases yet.</div>
        <div id="err" class="err"></div>
      </section>
    </div>
  </main>

  <div id="hm-shell-footer"></div>

  <!-- Universal shell JS -->
  <script src="scripts/hm-shell.js"></script>
  <script>
    window.HM && window.HM.renderShell({ currentPage: "purchases" });
  </script>

  <!-- Page logic (USES THE SAME MODULE CLIENT AS THE REST OF YOUR SITE) -->
  <script type="module">
    import { supabase } from "/scripts/supabase-client.js";

    const statusEl = document.getElementById("status");
    const countEl = document.getElementById("count");
    const navCount = document.getElementById("navCount");
    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");
    const errEl = document.getElementById("err");
    const ctaEl = document.getElementById("cta");
    const refreshBtn = document.getElementById("refreshBtn");
    const qEl = document.getElementById("q");

    const esc = (s) => String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");

    const money = (cents) =>
      (Number(cents || 0) / 100).toLocaleString(undefined, { style: "currency", currency: "USD" });

    const showErr = (msg) => {
      errEl.style.display = msg ? "block" : "none";
      errEl.textContent = msg || "";
    };

    let allRows = [];

    function render(){
      const q = (qEl.value || "").trim().toLowerCase();
      const rows = q
        ? allRows.filter(r =>
            String(r.listing_title || "").toLowerCase().includes(q) ||
            String(r.order_id || "").toLowerCase().includes(q)
          )
        : allRows;

      countEl.textContent = String(rows.length);
      navCount.textContent = String(rows.length);

      if (!rows.length){
        listEl.innerHTML = "";
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      listEl.innerHTML = rows.map(r => {
        const href = "/listing.html?id=" + encodeURIComponent(r.listing_id);
        const title = esc(r.listing_title || "Listing");
        const price = esc(money(r.item_price_cents));
        const orderShort = esc(String(r.order_id || "").slice(0,8));
        const st = esc(String(r.listing_status || "").toUpperCase());
        const thumb = r.thumbnail_url ? `<img src="${esc(r.thumbnail_url)}" alt="">` : "";
        return `
          <a class="row" href="${href}">
            <div class="thumb">${thumb}</div>
            <div style="min-width:0;">
              <div class="title">${title}</div>
              <div class="meta">${st ? (st + " • ") : ""}Order ${orderShort}</div>
            </div>
            <div class="price">${price}</div>
          </a>
        `;
      }).join("");
    }

    async function load(){
      showErr("");
      listEl.innerHTML = "";
      emptyEl.style.display = "none";
      ctaEl.style.display = "none";
      statusEl.textContent = "Checking…";
      countEl.textContent = "0";
      navCount.textContent = "0";

      const { data: sessionData, error: sessionErr } = await supabase.auth.getSession();
      if (sessionErr){
        statusEl.textContent = "Error";
        showErr(sessionErr.message || String(sessionErr));
        return;
      }

      const session = sessionData?.session;
      if (!session){
        statusEl.textContent = "Signed out";
        ctaEl.style.display = "flex";
        return;
      }

      statusEl.textContent = "Signed in";

      const { data, error } = await supabase
        .from("purchases_feed")
        .select("order_id,purchased_at,listing_id,listing_title,item_price_cents,thumbnail_url,listing_status,seller_id")
        .order("purchased_at", { ascending: false });

      if (error){
        showErr(error.message || String(error));
        return;
      }

      allRows = Array.isArray(data) ? data : [];
      render();
    }

    // keep the page in sync if auth changes
    supabase.auth.onAuthStateChange(() => load());

    refreshBtn.addEventListener("click", () => load().catch(e => showErr(e?.message || String(e))));
    qEl.addEventListener("input", render);

    load().catch(e => { statusEl.textContent = "Error"; showErr(e?.message || String(e)); });
  </script>
</body>
</html>
