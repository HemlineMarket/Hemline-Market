<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Purchases â€” Hemline Market</title>

  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>

  <!-- Shared styles -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    main{max-width:900px;margin:24px auto;padding:0 14px}
    h1{font-size:22px;margin-bottom:14px}

    .order-card{
      background:#fff;
      border:1px solid var(--hm-border);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
    }

    .order-top{
      display:flex;
      justify-content:space-between;
      font-size:13px;
      color:var(--hm-muted);
      margin-bottom:6px;
    }

    .purchase-items{
      margin-top:6px;
    }

    .purchase-items .name{
      font-weight:700;
      font-size:14px;
    }

    .purchase-spec{
      font-size:13px;
      color:var(--hm-muted);
      margin-top:2px;
      margin-bottom:4px;
    }

    a.view-link{
      display:inline-block;
      margin-top:4px;
      padding:5px 10px;
      font-size:13px;
      font-weight:600;
      border:1px solid var(--hm-border);
      border-radius:999px;
      text-decoration:none;
      color:#111;
    }

    .empty{
      text-align:center;
      color:var(--hm-muted);
      margin-top:60px;
    }
  </style>
</head>
<body>

<div id="hm-shell-header"></div>

<main>
  <h1>Your Purchases</h1>
  <div id="ordersList"></div>
  <div id="emptyState" class="empty" style="display:none">
    You havenâ€™t purchased anything yet.
  </div>
</main>

<div id="hm-shell-footer"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/hm-shell.js"></script>

<script>
window.HM && window.HM.renderShell({ currentPage:"purchases" });

(async ()=>{
  const supabase = window.HM?.supabase;
  if(!supabase) return;

  const list  = document.getElementById("ordersList");
  const empty = document.getElementById("emptyState");

  const { data:{ session } } = await supabase.auth.getSession();
  if(!session?.user){
    location.href = "auth.html?view=login";
    return;
  }

  const uid   = session.user.id;
  const email = session.user.email;

  /* ðŸ”‘ THIS IS THE FIX:
     Query by buyer_id OR buyer_email
     This is why past purchases now appear.
  */
  const { data, error } = await supabase
    .from("orders")
    .select("*")
    .or(`buyer_id.eq.${uid},buyer_email.eq.${email}`)
    .order("created_at",{ ascending:false });

  if(error){
    console.error(error);
    empty.style.display="block";
    empty.textContent="Unable to load purchases.";
    return;
  }

  if(!data || data.length===0){
    empty.style.display="block";
    return;
  }

  list.innerHTML="";
  empty.style.display="none";

  data.forEach(o=>{
    const snap = o.listing_snapshot || {};
    const items = snap.items || [];
    const first = items[0] || {};

    const title =
      o.listing_title ||
      first.title ||
      "Fabric purchase";

    // Fabric spec (display-only)
    const content =
      first.content ||
      first.fiber_content ||
      "";
    const width =
      first.width ||
      first.width_inches ||
      first.width_in ||
      "";

    let specText="";
    if(content && width){
      specText = `${content} Â· ${width} wide`;
    } else if(content){
      specText = content;
    } else if(width){
      specText = `${width} wide`;
    }

    const specHtml = specText
      ? `<div class="purchase-spec">${specText}</div>`
      : "";

    const totalCents = Number(
      o.total_cents ??
      o.amount_total_cents ??
      0
    );

    const money = (totalCents/100).toLocaleString("en-US",{
      style:"currency",
      currency:o.currency || "USD"
    });

    const card = document.createElement("div");
    card.className="order-card";

    card.innerHTML = `
      <div class="order-top">
        <span>Order ${String(o.id).slice(0,8)}</span>
        <span>${new Date(o.created_at).toLocaleDateString()}</span>
      </div>

      <div class="purchase-items">
        <div><span class="name">${title}</span></div>
        ${specHtml}
        ${
          o.listing_id
            ? `<a class="view-link" href="listing.html?id=${o.listing_id}">View listing</a>`
            : ""
        }
      </div>

      <div class="purchase-spec">
        Total: ${money}
      </div>
    `;

    list.appendChild(card);
  });
})();
</script>

</body>
</html>
