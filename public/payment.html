<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Payment — Hemline Market</title>
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hem-header.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <style>
    body{margin:0;background:#fafafa;color:#111827;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .container{max-width:1100px;margin:20px auto;padding:0 12px;display:grid;grid-template-columns:1fr 360px;gap:20px}
    @media(max-width:900px){.container{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    h1{margin:0 0 16px}
    label{display:block;font-size:14px;font-weight:600;margin:6px 0}
    input{width:100%;height:40px;border:1px solid #e5e7eb;border-radius:8px;padding:0 10px;margin-bottom:10px}
    .stripe-box{height:40px;border:1px solid #e5e7eb;border-radius:8px;display:flex;align-items:center;padding:0 10px;margin-bottom:10px}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .btn{background:#991b1b;color:#fff;border:0;border-radius:999px;padding:10px 18px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-outline{background:#fff;color:#991b1b;border:1px solid #e5e7eb;padding:10px 18px;border-radius:999px;font-weight:700;cursor:pointer}
    .order-item{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
    .muted{color:#6b7280;font-size:14px}
    .line{height:1px;background:#e5e7eb;margin:12px 0}
    .grand{font-weight:800;font-size:18px}
    #msg{margin-top:10px;font-size:14px}
  </style>
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>

<header class="hm-header">
  <div class="wrap">
    <a class="hm-brand" href="index.html">Hemline Market</a>
  </div>
</header>

<div class="container">
  <!-- LEFT -->
  <section class="card">
    <h1>Payment</h1>
    <form id="payment-form">
      <label for="email">Email (for receipt)</label>
      <input id="email" type="email" placeholder="you@example.com" required>

      <label for="cardholder-name">Name on card</label>
      <input id="cardholder-name" type="text" placeholder="Full name" required>

      <label>Card number</label>
      <div id="card-number" class="stripe-box"></div>

      <div class="row">
        <div>
          <label>Expiry</label>
          <div id="card-expiry" class="stripe-box"></div>
        </div>
        <div>
          <label>CVC</label>
          <div id="card-cvc" class="stripe-box"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="zip">ZIP (optional)</label>
          <input id="zip" placeholder="ZIP" inputmode="numeric" maxlength="10">
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <a href="checkout.html" class="btn-outline">Back</a>
        <button id="submit" class="btn">Pay</button>
      </div>
      <div id="msg" class="muted"></div>
    </form>
    <p class="muted" style="margin-top:10px">Secure • Card encrypted • Buyer Protection</p>
  </section>

  <!-- RIGHT -->
  <aside class="card">
    <h2>Order summary</h2>
    <div id="order-items"></div>
    <div class="line"></div>
    <div class="order-item"><span>Subtotal</span><span id="subTotal">$0.00</span></div>
    <div class="order-item"><span>Shipping</span><span id="shipTotal">$0.00</span></div>
    <div class="order-item"><span>Tax</span><span class="muted">Calculated at payment</span></div>
    <div class="line"></div>
    <div class="order-item grand"><span>Total</span><span id="grandTotal">$0.00</span></div>
  </aside>
</div>

<footer class="hm-footer">
  <div class="footer-wrap">
    <div class="copy">© 2025 Hemline Market</div>
    <nav class="footer-links">
      <a href="about.html">About</a>
      <a href="faq.html">FAQ</a>
      <a href="contact.html">Contact</a>
      <a href="terms.html">Terms</a>
      <a href="privacy.html">Privacy</a>
    </nav>
  </div>
</footer>

<script>
(async function(){
  // Stripe publishable key
  const stripe = Stripe("pk_test_51Rx9wcFi9JRhHIdimg0GjJUrSKPGXUuk0Zlq6eN4qKWoRaqZWLeVhfde7yXN31tpg9cbBpX1AiuXeM7uxnUapXrR00CptT5icK");
  const elements = stripe.elements();

  // Separate Elements so all fields are always visible
  const style = { base:{ fontSize:"16px", color:"#111827", "::placeholder":{color:"#9ca3af"} }, invalid:{color:"#dc2626"} };
  const cardNumber = elements.create("cardNumber", { style });
  const cardExpiry = elements.create("cardExpiry", { style });
  const cardCvc    = elements.create("cardCvc", { style });
  cardNumber.mount("#card-number");
  cardExpiry.mount("#card-expiry");
  cardCvc.mount("#card-cvc");

  const fmt = c => "$" + (Math.max(0,c)/100).toFixed(2);

  // ---- Client shipping preview (display only) ----
  function tierCents(yards){ if(yards < 3) return 500; if(yards <= 10) return 800; return 1500; }
  function yardsForItem(it){
    const qty = Number(it.qty || 1);
    if (it.yards !== undefined && it.yards !== null && it.yards !== "") {
      return (Number(it.yards) || 0) * qty;
    }
    return qty;
  }
  function previewTotals(cart){
    let subtotal = 0;
    const groups = {};
    for(const it of cart){
      subtotal += (Number(it.amount||0) * Number(it.qty||1));
      const sellerId = it.sellerId || "default_seller";
      const name = it.sellerName || "Seller";
      const yards = yardsForItem(it);
      if(!groups[sellerId]) groups[sellerId] = { name, yards:0 };
      groups[sellerId].yards += yards;
    }
    const shipping = Object.values(groups).reduce((s,g)=>s+tierCents(g.yards),0);
    return { subtotal, shipping, total: subtotal + shipping };
  }

  // Load cart and render preview
  const cart = JSON.parse(localStorage.getItem("hm_cart") || "[]");
  const itemsEl = document.getElementById("order-items");
  itemsEl.innerHTML = "";
  cart.forEach(it=>{
    const line = (it.amount||0) * (it.qty||1);
    const row = document.createElement("div");
    row.className = "order-item";
    const yards = (it.yards!==undefined && it.yards!==null && it.yards!=='') ? ` (${it.yards} yd)` : "";
    row.innerHTML = `<span>${(it.name||"Item") + yards}</span><span>${fmt(line)}</span>`;
    itemsEl.appendChild(row);
  });
  const prev = previewTotals(cart);
  document.getElementById("subTotal").textContent = fmt(prev.subtotal);
  document.getElementById("shipTotal").textContent = fmt(prev.shipping);
  document.getElementById("grandTotal").textContent = fmt(prev.total);

  // ---- Submit & charge using server-computed totals ----
  const form = document.getElementById("payment-form");
  const submitBtn = document.getElementById("submit");
  const msg = document.getElementById("msg");

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!cart.length){ alert("Your cart is empty."); return; }

    submitBtn.disabled = true;
    msg.textContent = "Creating payment…";

    const email = document.getElementById("email").value.trim();
    const name  = document.getElementById("cardholder-name").value.trim();
    const postal = document.getElementById("zip").value.trim();

    try{
      // 1) Ask server to create PaymentIntent from the cart
      const resp = await fetch("/api/create-payment-intent", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ cart, email })
      });
      const data = await resp.json();
      if(!resp.ok) throw new Error(data.error || "Failed to create payment.");
      const clientSecret = data.clientSecret || data.client_secret;
      if(!clientSecret) throw new Error("Missing client secret from server.");

      // Update summary to *server* totals (real charge)
      const totals = data.totals || { subtotal:0, shipping:0, total:0 };
      document.getElementById("subTotal").textContent = fmt(totals.subtotal);
      document.getElementById("shipTotal").textContent = fmt(totals.shipping);
      document.getElementById("grandTotal").textContent = fmt(totals.total);

      // 2) Confirm payment (use cardNumber with separate Elements)
      msg.textContent = "Confirming card…";
      const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
        payment_method: {
          card: cardNumber,
          billing_details: {
            email: email || undefined,
            name:  name  || undefined,
            address: postal ? { postal_code: postal } : undefined
          }
        }
      });
      if(error) throw error;
      if(!paymentIntent || paymentIntent.status !== "succeeded"){
        throw new Error("Payment not completed.");
      }

      // 3) Snapshot for thanks page + redirect
      const orderId = "HM-" + Math.floor(100000 + Math.random()*900000);
      localStorage.setItem("hm_last_checkout_totals", JSON.stringify({
        orderId,
        subtotal: totals.subtotal,
        shipping: totals.shipping
      }));
      localStorage.setItem("hm_last_checkout_items", JSON.stringify(cart));

      localStorage.removeItem("hm_cart");
      localStorage.removeItem("hm_cart_shipping");
      window.location.href = "thanks.html?o=" + encodeURIComponent(orderId);
    }catch(err){
      console.error(err);
      alert(err.message || "Payment error.");
      submitBtn.disabled = false;
      msg.textContent = "";
    }
  });
})();
</script>

</body>
</html>
