<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Payment â€” Hemline Market</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#fafafa;color:#111}
    .container{max-width:1100px;margin:20px auto;padding:0 12px;display:grid;grid-template-columns:1fr 360px;gap:20px}
    @media(max-width:900px){.container{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    h1{margin-top:0}
    label{display:block;margin:10px 0 4px;font-weight:600;font-size:14px}
    input{width:100%;height:40px;padding:0 10px;border:1px solid #e5e7eb;border-radius:8px}
    .btn{margin-top:14px;background:#991b1b;color:#fff;padding:12px 20px;border-radius:999px;border:none;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .order-item{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    .line{height:1px;background:#e5e7eb;margin:10px 0}
    .grand{font-weight:800;font-size:18px}
  </style>
</head>
<body>

<main class="container">
  <!-- LEFT: Card form -->
  <section class="card">
    <h1>Payment</h1>
    <form id="payment-form">
      <label for="email">Email (for receipt)</label>
      <input id="email" type="email" placeholder="you@example.com" required>

      <label for="name">Name on card</label>
      <input id="name" placeholder="Full name" required>

      <label>Card details</label>
      <div id="card-element" style="padding:10px;border:1px solid #e5e7eb;border-radius:8px"></div>

      <button id="submit" class="btn">Pay</button>
    </form>
    <div id="error-message" style="color:#b91c1c;margin-top:10px"></div>
  </section>

  <!-- RIGHT: Order summary -->
  <aside class="card">
    <h2>Order summary</h2>
    <div id="order-items"></div>
    <div class="line"></div>
    <div class="order-item"><span>Subtotal</span><span id="sub">$0.00</span></div>
    <div class="order-item"><span>Shipping</span><span id="ship">$0.00</span></div>
    <div class="order-item"><span>Tax</span><span>Calculated at payment</span></div>
    <div class="line"></div>
    <div class="order-item grand"><span>Total</span><span id="tot">$0.00</span></div>
  </aside>
</main>

<script src="https://js.stripe.com/v3/"></script>
<script>
(async function(){
  const STRIPE_PK = "pk_test_51Rx9wcFi9JRhHIdimg0GjJUrSKPGXUuk0Zlq6eN4qKWoRaqZWLeVhfde7yXN31tpg9cbBpX1AiuXeM7uxnUapXrR00CptT5icK"; // your publishable key
  const stripe = Stripe(STRIPE_PK);

  const elements = stripe.elements();
  const cardElement = elements.create("card");
  cardElement.mount("#card-element");

  const form = document.getElementById("payment-form");
  const submitBtn = document.getElementById("submit");
  const errorMsg = document.getElementById("error-message");

  // Load cart + shipping from localStorage
  function fmt(c){ return "$"+(c/100).toFixed(2); }
  const cart = JSON.parse(localStorage.getItem("hm_cart")||"[]");
  const ship = JSON.parse(localStorage.getItem("hm_cart_shipping")||"{}");

  let subtotal=0;
  const itemsEl=document.getElementById("order-items");
  cart.forEach(it=>{
    const line=(it.amount||0)*(it.qty||1);
    subtotal+=line;
    const div=document.createElement("div");
    div.className="order-item";
    div.innerHTML=`<span>${it.name||"Fabric"} ${it.yards||""} yd</span><span>${fmt(line)}</span>`;
    itemsEl.appendChild(div);
  });

  const shipCost=ship.total_cents||0;
  document.getElementById("sub").textContent=fmt(subtotal);
  document.getElementById("ship").textContent=fmt(shipCost);
  document.getElementById("tot").textContent=fmt(subtotal+shipCost);

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    submitBtn.disabled=true;
    errorMsg.textContent="";

    try{
      // create intent on server
      const res = await fetch("/api/create-payment-intent",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          email:document.getElementById("email").value,
          amount: subtotal+shipCost
        })
      });
      const data = await res.json();
      if(!data.clientSecret) throw new Error("Failed to create payment intent");

      const {error, paymentIntent} = await stripe.confirmCardPayment(data.clientSecret,{
        payment_method:{
          card:cardElement,
          billing_details:{ name:document.getElementById("name").value, email:document.getElementById("email").value }
        }
      });

      if(error){ errorMsg.textContent=error.message; submitBtn.disabled=false; return; }

      alert("Payment successful!");
      localStorage.removeItem("hm_cart");
      localStorage.removeItem("hm_cart_shipping");
      window.location.href="thankyou.html";
    }catch(err){
      errorMsg.textContent=err.message;
      submitBtn.disabled=false;
    }
  });
})();
</script>
</body>
</html>
