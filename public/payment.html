<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Payment — Hemline Market</title>
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hem-header.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <style>
    body{margin:0;background:#fafafa;color:#111827;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .container{max-width:1100px;margin:20px auto;padding:0 12px;display:grid;grid-template-columns:1fr 360px;gap:20px}
    @media(max-width:900px){.container{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    h1{margin:0 0 16px}
    label{display:block;font-size:14px;font-weight:600;margin:6px 0}
    input{width:100%;height:40px;border:1px solid #e5e7eb;border-radius:8px;padding:0 10px;margin-bottom:10px}
    .btn{background:#991b1b;color:#fff;border:0;border-radius:999px;padding:10px 18px;font-weight:700;cursor:pointer}
    .btn-outline{background:#fff;color:#991b1b;border:1px solid #e5e7eb;padding:10px 18px;border-radius:999px;font-weight:700;cursor:pointer}
    .order-item{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
    .muted{color:#6b7280;font-size:14px}
    .line{height:1px;background:#e5e7eb;margin:12px 0}
    .grand{font-weight:800;font-size:18px}
  </style>
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>

<header class="hm-header">
  <div class="wrap">
    <a class="hm-brand" href="index.html">Hemline Market</a>
  </div>
</header>

<div class="container">
  <!-- LEFT -->
  <section class="card">
    <h1>Payment</h1>
    <form id="payment-form">
      <label for="email">Email (for receipt)</label>
      <input id="email" type="email" placeholder="you@example.com" required>

      <label for="cardholder-name">Name on card</label>
      <input id="cardholder-name" type="text" placeholder="Full name" required>

      <label>Card details</label>
      <div id="card-element" style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:10px"></div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <a href="checkout.html" class="btn-outline">Back</a>
        <button id="submit" class="btn">Pay</button>
      </div>
    </form>
    <p class="muted" style="margin-top:10px">Secure • Card encrypted • Buyer Protection</p>
  </section>

  <!-- RIGHT -->
  <aside class="card">
    <h2>Order summary</h2>
    <div id="order-items"></div>
    <div class="line"></div>
    <div class="order-item"><span>Subtotal</span><span id="subTotal">$0.00</span></div>
    <div class="order-item"><span>Shipping</span><span id="shipTotal">$0.00</span></div>
    <div class="order-item"><span>Tax</span><span class="muted">Calculated at payment</span></div>
    <div class="line"></div>
    <div class="order-item grand"><span>Total</span><span id="grandTotal">$0.00</span></div>
  </aside>
</div>

<footer class="hm-footer">
  <div class="footer-wrap">
    <div class="copy">© 2025 Hemline Market</div>
    <nav class="footer-links">
      <a href="about.html">About</a>
      <a href="faq.html">FAQ</a>
      <a href="contact.html">Contact</a>
      <a href="terms.html">Terms</a>
      <a href="privacy.html">Privacy</a>
    </nav>
  </div>
</footer>

<script>
(async function(){
  // Your publishable key
  const stripe = Stripe("pk_test_51Rx9wcFi9JRhHIdimg0GjJUrSKPGXUuk0Zlq6eN4qKWoRaqZWLeVhfde7yXN31tpg9cbBpX1AiuXeM7uxnUapXrR00CptT5icK");
  const elements = stripe.elements();
  const cardElement = elements.create("card");
  cardElement.mount("#card-element");

  // Load cart + shipping
  const cart = JSON.parse(localStorage.getItem("hm_cart") || "[]");
  const ship = JSON.parse(localStorage.getItem("hm_cart_shipping") || "{}");
  const orderItems = document.getElementById("order-items");
  const fmt = c => "$" + (c/100).toFixed(2);

  let subtotal = 0;
  orderItems.innerHTML = "";
  cart.forEach(it=>{
    const line = (it.amount||0)*(it.qty||1);
    subtotal += line;
    const div = document.createElement("div");
    div.className = "order-item";
    div.innerHTML = `<span>${it.name||"Item"} ${it.yards?`(${it.yards} yd)`:''}</span><span>${fmt(line)}</span>`;
    orderItems.appendChild(div);
  });

  const shipping = ship.total_cents || 0;
  const total = subtotal + shipping;
  document.getElementById("subTotal").textContent = fmt(subtotal);
  document.getElementById("shipTotal").textContent = fmt(shipping);
  document.getElementById("grandTotal").textContent = fmt(total);

  // Submit
  document.getElementById("payment-form").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const email = document.getElementById("email").value.trim();

    // 1) Create intent on server
    const res = await fetch("/api/create-payment-intent",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ amount: total, currency:"usd", receipt_email: email || undefined })
    });
    const data = await res.json();
    if(!res.ok || !data.clientSecret){ alert(data.error || "Failed to create payment"); return; }

    // 2) Confirm card payment
    const {error, paymentIntent} = await stripe.confirmCardPayment(data.clientSecret,{
      payment_method:{
        card: cardElement,
        billing_details: { email: email || undefined, name: (document.getElementById("cardholder-name").value||"").trim() || undefined }
      }
    });

    if(error){ alert(error.message); return; }
    if(!paymentIntent || paymentIntent.status!=="succeeded"){ alert("Payment not completed."); return; }

    // 3) Generate order number and cache totals for thanks page
    const orderId = "HM-" + Math.floor(100000 + Math.random()*900000); // e.g., HM-273326
    localStorage.setItem("hm_last_checkout_totals", JSON.stringify({
      orderId, subtotal, shipping
    }));

    // 4) Clear cart + redirect with order in query
    localStorage.removeItem("hm_cart");
    localStorage.removeItem("hm_cart_shipping");
    window.location.href = "thanks.html?o=" + encodeURIComponent(orderId);
  });
})();
</script>

</body>
</html>
