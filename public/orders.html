<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hemline — Orders</title>
<style>:root{--ink:#0f172a;--bg:#fafafa;--card:#fff;--line:#e5e7eb;--accent:#0ea5e9}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:24px;background:var(--bg);color:var(--ink)}
.wrap{max-width:820px;margin:auto}
.top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.link{color:var(--accent);text-decoration:none}
.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
.box{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px;margin-bottom:20px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
.hdr{font-size:1.1rem;margin-bottom:6px}
.meta{color:#475569;font-size:.9rem}
.item{display:flex;align-items:center;gap:10px;margin:6px 0}
.thumb{width:44px;height:44px;object-fit:cover;border-radius:6px;border:1px solid var(--line)}
.amt{margin-left:auto;font-weight:600}
</style></head>
<body>
<div class="wrap">
  <div class="top">
    <a class="link" href="listings.html">← Back to Listings</a>
    <div>
      <span id="count" class="meta"></span>
      <button id="clearLocal" class="btn" title="Removes only local device receipts; server orders remain.">Clear Local Receipts</button>
    </div>
  </div>
  <h1>Your Orders</h1>
  <div id="msg" class="meta"></div>
  <div id="list">Loading…</div>
</div>

<script>
const SUPABASE_URL="https://clkizksbvxjkoatdajgd.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjM4MDE1ODIsImV4cCI6MjAzOTM3NzU4Mn0.MEu0Ex0bTtVnNuB-tAek95UbwsKdbWipzJrN84aKhlg";
const PH="https://via.placeholder.com/80?text=Fabric";
const $=id=>document.getElementById(id);

async function load(){
  const list=$("list"), msg=$("msg"); let orders=[];
  // try server
  try{
    const r=await fetch(`${SUPABASE_URL}/rest/v1/orders?select=*`,{headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`},cache:"no-store"});
    if(r.ok){orders=await r.json();}
  }catch(e){msg.textContent=`Server unavailable; showing local receipts.`}
  // merge local
  const local=JSON.parse(localStorage.getItem("hem_orders")||"[]");
  const merged=[...orders.map(o=>({id:o.id,when:o.created_at,items:o.items,subtotal:o.subtotal})), ...local];
  // dedupe by id (keep first)
  const seen=new Set(); const final=[];
  merged.forEach(o=>{const k=o.id||o.when; if(seen.has(k))return; seen.add(k); final.push(o);});
  // sort newest first
  final.sort((a,b)=>new Date(b.when||b.created_at||0)-new Date(a.when||a.created_at||0));
  $("count").textContent = final.length?`${final.length} order(s)`:``;

  list.innerHTML="";
  if(!final.length){list.innerHTML="<p>No orders yet.</p>";return}

  final.forEach(o=>{
    const box=document.createElement("div"); box.className="box";
    const when=new Date(o.when||Date.now()).toLocaleString();
    box.innerHTML=`<div class="hdr">Order #${o.id||"(local)"}</div><div class="meta">${when}</div>`;
    (o.items||[]).forEach(it=>{
      const q=+it.qty||1, p=+it.price||0;
      const row=document.createElement("div"); row.className="item";
      row.innerHTML=`<img class="thumb" src="${it.img||PH}" onerror="this.src='${PH}'"><div>${it.title||"Fabric"} <span class="meta">x${q}</span></div><div class="amt">$${(q*p).toFixed(2)}</div>`;
      box.appendChild(row);
    });
    const sum=o.subtotal ?? (o.items||[]).reduce((a,b)=>a+(+b.price||0)*(+b.qty||1),0);
    const tot=document.createElement("div"); tot.className="amt"; tot.style.marginTop="8px"; tot.textContent="Subtotal: $"+sum.toFixed(2);
    box.appendChild(tot);
    list.appendChild(box);
  });
}

// clear ONLY local receipts
$("clearLocal").onclick=()=>{localStorage.removeItem("hem_orders"); load();};

load();
</script>
</body></html>
