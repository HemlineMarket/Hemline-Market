<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hemline — Orders</title>
<style>
:root{--ink:#0f172a;--bg:#fafafa;--card:#fff;--line:#e5e7eb;--accent:#0ea5e9}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:24px;background:var(--bg);color:var(--ink)}
.wrap{max-width:820px;margin:auto}.top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.link{color:var(--accent);text-decoration:none}.btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
.order{background:var(--card);border:1px solid var(--line);border-radius:12px;margin:12px 0;overflow:hidden}
.hdr{margin:0;padding:14px 16px;background:#f3f4f6;cursor:pointer;display:flex;justify-content:space-between;gap:10px}
.meta{color:#475569;font-size:.9rem}.details{display:none;padding:12px 16px}
.item{display:flex;gap:10px;align-items:center;margin:6px 0}
.thumb{width:42px;height:42px;object-fit:cover;border-radius:8px;border:1px solid var(--line);background:#f1f5f9}
.total{margin-top:10px;text-align:right;font-weight:700}.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
</style></head>
<body><div class="wrap">
  <div class="top">
    <a class="link" href="listings.html">← Back to “Listings”</a>
    <div>
      <span id="count" class="meta"></span>
      <button id="clearLocal" class="btn" title="Removes only local-device receipts">Clear Local Receipts</button>
    </div>
  </div>
  <h1>Your Orders</h1>
  <div id="msg" class="meta"></div>
  <div id="orders">Loading…</div>
</div>
<script>
const SUPABASE_URL="https://clkizksbvxjkoatdajgd.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjM4MDE1ODIsImV4cCI6MjAzOTM3NzU4Mn0.MEu0Ex0bTtVnNuB-tAek95UbwsKdbWipzJrN84aKhlg";
const PH="https://via.placeholder.com/80?text=Fabric"; const $=id=>document.getElementById(id);

function mailto(order,total){const to=localStorage.getItem("hem_email")||""; const when=order.created_at?new Date(order.created_at).toLocaleString():(order.when||"");
  const lines=(order.items||[]).map(it=>`• ${it.title||"Fabric"}  x${it.qty||1}  $${((+it.price||0)*(+it.qty||1)).toFixed(2)}`).join("%0A");
  const subject=`Hemline Market receipt — ${order.id||"(local)"}`;
  const body=`Thank you for your order!%0A%0AOrder: ${order.id||"(local)"}%0ADate: ${when}%0A%0AItems:%0A${lines}%0A%0ATotal: $${total.toFixed(2)}%0A%0A— Hemline Market`;
  window.location.href=`mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${body}`;}

function render(list,source){
  const box=$("orders"); const msg=$("msg");
  msg.textContent=source==="rest"?`${list.length} order(s)`:`Showing local receipts (offline)`;
  if(!list.length){box.innerHTML="<p>No orders yet.</p>";$("count").textContent="";return}
  $("count").textContent=`${list.length} order(s)`; box.innerHTML="";
  list.forEach((o,i)=>{const wrap=document.createElement("div");wrap.className="order";
    const when=o.created_at?new Date(o.created_at).toLocaleString():(o.when?new Date(o.when).toLocaleString():"");
    const hdr=document.createElement("div");hdr.className="hdr";hdr.innerHTML=`<span>Order #${o.id||i+1} ${when?`• <span class="meta">${when}</span>`:""}</span><span>Details ▾</span>`;
    const det=document.createElement("div");det.className="details"; let total=0;
    const items=Array.isArray(o.items)?o.items:[]; if(!items.length){det.innerHTML="<p class='meta'>No items found.</p>"}else{
      items.forEach(it=>{const q=+it.qty||1,p=+it.price||0; total+=q*p;
        const row=document.createElement("div");row.className="item";
        row.innerHTML=`<img class="thumb" src="${it.img||PH}" onerror="this.src='${PH}'"><div><div><strong>${it.title||"Fabric"}</strong></div><div class="meta">Qty ${q}</div></div><div style="margin-left:auto">$${(q*p).toFixed(2)}</div>`;
        det.appendChild(row);
      });
      const t=document.createElement("div");t.className="total";t.textContent="Total: $"+total.toFixed(2);det.appendChild(t);
      const actions=document.createElement("div");actions.className="actions";
      const email=document.createElement("button");email.className="btn";email.textContent="Email receipt"; email.onclick=()=>mailto(o,total);
      const print=document.createElement("button");print.className="btn";print.textContent="Print"; print.onclick=()=>window.print();
      actions.appendChild(email);actions.appendChild(print);det.appendChild(actions);
    }
    hdr.onclick=()=>{det.style.display=det.style.display==="block"?"none":"block"};
    wrap.appendChild(hdr);wrap.appendChild(det);box.appendChild(wrap);
  });
}

async function load(){
  const local=JSON.parse(localStorage.getItem("hem_orders")||"[]").map(x=>({id:x.id,created_at:x.when,items:x.items,subtotal:x.subtotal}));
  try{
    const r=await fetch(`${SUPABASE_URL}/rest/v1/orders?select=*`,{headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`},cache:"no-store"});
    if(!r.ok) throw new Error(r.status); const data=await r.json();
    // merge + dedupe by id, newest first
    const all=[...data,...local]; const seen=new Set(); const merged=all.filter(o=>{const k=o.id||o.created_at; if(seen.has(k))return false; seen.add(k); return true;})
      .sort((a,b)=>new Date(b.created_at||0)-new Date(a.created_at||0));
    render(merged,"rest");
  }catch(_){
    const onlyLocal=[...local].sort((a,b)=>new Date(b.created_at||0)-new Date(a.created_at||0));
    render(onlyLocal,"local");
  }
}

$("clearLocal").onclick=()=>{localStorage.removeItem("hem_orders"); load();};
load();
</script>
</body></html>
