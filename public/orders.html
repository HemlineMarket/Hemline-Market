<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hemline — Orders</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:24px;background:#fafafa;color:#0f172a}
.wrap{max-width:820px;margin:auto}
.top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.order{background:#fff;border:1px solid #e5e7eb;border-radius:12px;margin:12px 0;overflow:hidden}
.hdr{margin:0;padding:14px 16px;background:#f3f4f6;cursor:pointer;display:flex;justify-content:space-between;gap:10px}
.meta{color:#475569;font-size:.9rem}
.details{display:none;padding:12px 16px}
.item{display:flex;gap:10px;align-items:center;margin:6px 0}
.thumb{width:42px;height:42px;object-fit:cover;border-radius:8px;background:#f1f5f9;border:1px solid #e5e7eb}
.total{margin-top:10px;text-align:right;font-weight:700}
.actions{display:flex;gap:8px;margin-top:10px;justify-content:flex-end}
.btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
.link{color:#0ea5e9;text-decoration:none}
</style></head>
<body><div class="wrap">
<div class="top">
  <a class="link" href="listings.html">← Back to Listings</a>
  <span id="count" class="meta"></span>
</div>
<h1>Your Orders</h1>
<div id="orders">Loading…</div>
</div>
<script>
const SUPABASE_URL="https://clkizksbvxjkoatdajgd.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjM4MDE1ODIsImV4cCI6MjAzOTM3NzU4Mn0.MEu0Ex0bTtVnNuB-tAek95UbwsKdbWipzJrN84aKhlg";
const PH="https://via.placeholder.com/80?text=Fabric";

function mailtoReceipt(order,total){
  const to=localStorage.getItem("hem_email")||"";
  const subject=`Hemline Market receipt — ${order.id||"(no id)"}`;
  const lines=(order.items||[]).map(it=>{
    const qty=Number(it.qty||1),price=Number(it.price||0);
    return `• ${it.title||"Fabric"}  x${qty}  $${(qty*price).toFixed(2)}`;
  }).join("%0A");
  const when=order.created_at?new Date(order.created_at).toLocaleString():"";
  const body=`Thank you for your order!%0A%0AOrder: ${order.id||""}%0ADate: ${when}%0A%0AItems:%0A${lines}%0A%0ATotal: $${total.toFixed(2)}%0A%0A— Hemline Market`;
  window.location.href=`mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${body}`;
}

async function load(){
  const box=document.getElementById("orders");
  try{
    const r=await fetch(`${SUPABASE_URL}/rest/v1/orders?select=*`,{headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`},cache:"no-store"});
    const data=await r.json();
    // newest first
    data.sort((a,b)=>new Date(b.created_at||0)-new Date(a.created_at||0));
    document.getElementById("count").textContent = data.length?`${data.length} order(s)`:``;
    if(!data.length){box.innerHTML="<p>No orders found.</p>";return}
    box.innerHTML="";
    data.forEach((o,idx)=>{
      const wrap=document.createElement("div");wrap.className="order";
      const when=o.created_at?new Date(o.created_at).toLocaleString():"Unknown date";
      const hdr=document.createElement("div");hdr.className="hdr";
      hdr.innerHTML=`<span>Order #${idx+1} • <span class="meta">${when}</span></span><span>Details ▾</span>`;
      const det=document.createElement("div");det.className="details";
      let total=0; const items=Array.isArray(o.items)?o.items:[];
      if(!items.length){det.innerHTML="<p class='meta'>No items found.</p>";}
      else{
        items.forEach(it=>{
          const qty=Number(it.qty||1),price=Number(it.price||0); total+=qty*price;
          const row=document.createElement("div");row.className="item";
          row.innerHTML=`<img class="thumb" src="${it.img||PH}" onerror="this.src='${PH}'" alt="">
            <div><div><strong>${it.title||"Fabric"}</strong></div><div class="meta">Qty ${qty}</div></div>
            <div style="margin-left:auto">$${(qty*price).toFixed(2)}</div>`;
          det.appendChild(row);
        });
        const t=document.createElement("div");t.className="total";t.textContent="Total: $"+total.toFixed(2);det.appendChild(t);
        const actions=document.createElement("div");actions.className="actions";
        const emailBtn=document.createElement("button");emailBtn.className="btn";emailBtn.textContent="Email receipt";
        emailBtn.onclick=()=>mailtoReceipt(o,total);
        const printBtn=document.createElement("button");printBtn.className="btn";printBtn.textContent="Print";
        printBtn.onclick=()=>window.print();
        actions.appendChild(emailBtn);actions.appendChild(printBtn);det.appendChild(actions);
      }
      hdr.onclick=()=>{det.style.display=det.style.display==="block"?"none":"block"};
      wrap.appendChild(hdr);wrap.appendChild(det);box.appendChild(wrap);
    });
  }catch(err){box.textContent="Error loading orders.";}
}
load();
</script></body></html>
