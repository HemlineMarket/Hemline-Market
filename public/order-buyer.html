<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Order Details — Hemline Market</title>

  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
      --hm-card:rgba(255,255,255,.96);
      --hm-green:#065f46;
      --hm-green-bg:#ecfdf5;
      --hm-blue:#1e40af;
      --hm-blue-bg:#eff6ff;
      --hm-yellow:#92400e;
      --hm-yellow-bg:#fef3c7;
    }
    html,body{margin:0;background:var(--hm-bg);color:var(--hm-text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    
    .wrap{max-width:900px;margin:0 auto;padding:18px 12px 40px}
    
    .back{
      display:inline-flex;align-items:center;gap:6px;
      color:var(--hm-accent);text-decoration:none;font-weight:600;
      margin-bottom:16px;font-size:14px;
    }
    .back:hover{text-decoration:underline}
    .back svg{width:18px;height:18px}

    .pageHeader{
      display:flex;justify-content:space-between;align-items:flex-start;
      margin-bottom:20px;flex-wrap:wrap;gap:12px;
    }
    .pageHeader h1{margin:0;font-size:24px}
    .orderNumber{color:var(--hm-muted);font-size:14px;margin-top:4px}

    .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media(max-width:800px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--hm-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      overflow:hidden;
    }
    .card-header{
      padding:14px 16px;
      border-bottom:1px solid var(--hm-border);
      font-weight:700;font-size:15px;background:#fafafa;
    }
    .card-body{padding:16px}

    .statusBadge{
      display:inline-flex;align-items:center;gap:5px;
      font-size:12px;font-weight:700;padding:6px 12px;
      border-radius:999px;text-transform:uppercase;letter-spacing:0.3px;
    }
    .statusBadge.paid{background:var(--hm-yellow-bg);color:var(--hm-yellow);border:1px solid #fcd34d}
    .statusBadge.shipped{background:var(--hm-blue-bg);color:var(--hm-blue);border:1px solid #93c5fd}
    .statusBadge.delivered,.statusBadge.complete{background:var(--hm-green-bg);color:var(--hm-green);border:1px solid #6ee7b7}
    .statusBadge.canceled{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}

    .itemRow{
      display:flex;gap:14px;align-items:flex-start;
      padding-bottom:16px;margin-bottom:16px;
      border-bottom:1px solid #f3f4f6;
    }
    .itemThumb{
      width:100px;height:100px;border-radius:10px;overflow:hidden;
      background:#f9fafb;border:1px solid var(--hm-border);flex-shrink:0;
      display:flex;align-items:center;justify-content:center;
    }
    .itemThumb img{width:100%;height:100%;object-fit:cover}
    .thumb-placeholder{
      width:100%;height:100%;
      display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    }
    .thumb-placeholder svg{color:#9ca3af;}
    .itemInfo{flex:1}
    .itemTitle{font-weight:700;font-size:16px;margin-bottom:4px}
    .itemMeta{color:var(--hm-muted);font-size:13px}
    .itemMeta a{color:var(--hm-accent);text-decoration:none}
    .itemMeta a:hover{text-decoration:underline}
    .itemPrice{font-weight:700;font-size:18px;text-align:right}

    .priceRow{
      display:flex;justify-content:space-between;
      padding:8px 0;font-size:14px;
    }
    .priceRow.total{
      border-top:2px solid var(--hm-border);
      margin-top:8px;padding-top:12px;
      font-weight:700;font-size:16px;
    }
    .priceRow .label{color:var(--hm-muted)}
    .priceRow.total .label{color:var(--hm-text)}

    .timeline{padding:8px 0}
    .timelineStep{
      display:flex;align-items:flex-start;gap:12px;
      padding:12px 0;position:relative;
    }
    .timelineStep:not(:last-child)::before{
      content:'';position:absolute;left:11px;top:36px;
      width:2px;height:calc(100% - 24px);background:#e5e7eb;
    }
    .timelineStep.complete:not(:last-child)::before{background:var(--hm-green)}
    .timelineDot{
      width:24px;height:24px;border-radius:50%;
      background:#fff;border:2px solid #e5e7eb;
      display:flex;align-items:center;justify-content:center;
      flex-shrink:0;font-size:12px;
    }
    .timelineStep.complete .timelineDot{
      background:var(--hm-green);border-color:var(--hm-green);color:#fff;
    }
    .timelineStep.active .timelineDot{
      background:var(--hm-blue);border-color:var(--hm-blue);color:#fff;
    }
    .timelineContent{flex:1}
    .timelineTitle{font-weight:600;font-size:14px}
    .timelineDate{color:var(--hm-muted);font-size:12px;margin-top:2px}

    .trackingLink{
      display:flex;align-items:center;gap:8px;
      background:var(--hm-blue-bg);padding:12px;border-radius:8px;
      font-size:14px;color:var(--hm-blue);margin-top:12px;
    }
    .trackingLink a{color:var(--hm-blue);font-weight:600}

    .addressBox{
      background:#f9fafb;padding:12px;border-radius:8px;
      font-size:14px;line-height:1.5;
    }
    .addressBox .name{font-weight:600}

    .actions{display:flex;flex-direction:column;gap:10px}
    .btn{
      padding:12px 16px;border-radius:10px;border:1px solid var(--hm-border);
      background:#fff;font-weight:600;font-size:14px;cursor:pointer;
      text-decoration:none;color:#374151;text-align:center;
      display:flex;align-items:center;justify-content:center;gap:8px;
      transition:all 0.15s;
    }
    .btn:hover{background:#f9fafb;border-color:#d1d5db}
    .btn-danger{background:#fff;border-color:#fca5a5;color:#991b1b}
    .btn-danger:hover{background:#fef2f2}
    .btn svg{width:18px;height:18px}

    .cancelWarning{
      background:var(--hm-yellow-bg);border:1px solid #fcd34d;
      border-radius:8px;padding:12px;font-size:13px;
      color:var(--hm-yellow);margin-bottom:12px;
    }

    .loading{text-align:center;padding:60px 20px;color:var(--hm-muted)}
    .error{
      background:#fef2f2;border:1px solid #fecaca;
      color:#991b1b;padding:16px;border-radius:10px;text-align:center;
    }
  </style>
</head>

<body>
  <div id="hm-shell-header"></div>

  <main class="wrap">
    <a class="back" href="purchases.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back to Purchases
    </a>

    <div id="content">
      <div class="loading">Loading order details...</div>
    </div>
  </main>

  <div id="hm-shell-footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="scripts/hm-shell.js"></script>

  <script>
    window.HM && window.HM.renderShell({ currentPage: "purchases" });

    const supabaseClient = window.__hm_supabase || (window.__hm_supabase =
      window.supabase.createClient(
        "https://clkizksbvxjkoatdajgd.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI"
      )
    );

    const contentEl = document.getElementById("content");

    function money(cents){ return "$" + (Number(cents || 0) / 100).toFixed(2); }
    function fmtDate(iso){
      if(!iso) return "";
      return new Date(iso).toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric",year:"numeric"});
    }
    function fmtDateTime(iso){
      if(!iso) return "";
      return new Date(iso).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"});
    }
    function getOrderId(){
      return new URLSearchParams(window.location.search).get("id");
    }
    function minutesSince(iso){
      if(!iso) return Infinity;
      return (Date.now() - new Date(iso).getTime()) / 60000;
    }

    function getStatusInfo(status){
      const s = (status || "").toUpperCase();
      if(s === "PAID" || s === "PENDING") return { class:"paid", label:"Awaiting Shipment", step:1 };
      if(s === "SHIPPED") return { class:"shipped", label:"Shipped", step:2 };
      if(s === "DELIVERED") return { class:"delivered", label:"Delivered", step:3 };
      if(s === "COMPLETE") return { class:"complete", label:"Complete", step:4 };
      if(s === "CANCELED" || s === "CANCELLED") return { class:"canceled", label:"Cancelled", step:0 };
      return { class:"", label:status || "Unknown", step:0 };
    }

    async function loadOrder(){
      const orderId = getOrderId();
      if(!orderId){
        contentEl.innerHTML = '<div class="error">No order ID provided.</div>';
        return;
      }

      const { data: sessData } = await supabaseClient.auth.getSession();
      const user = sessData?.session?.user;
      if(!user){
        contentEl.innerHTML = '<div class="error">Please sign in to view this order.</div>';
        return;
      }

      const { data: order, error: orderErr } = await supabaseClient
        .from("orders")
        .select("*")
        .eq("id", orderId)
        .eq("buyer_id", user.id)
        .maybeSingle();

      if(orderErr || !order){
        contentEl.innerHTML = '<div class="error">Order not found or you don\'t have permission to view it.</div>';
        return;
      }

      let listing = null;
      if(order.listing_id){
        const { data } = await supabaseClient
          .from("listings")
          .select("id, title, image_url_1, image_url")
          .eq("id", order.listing_id)
          .maybeSingle();
        listing = data;
      }

      renderOrder(order, listing, user);
    }

    function renderOrder(order, listing, user){
      const img = order.listing_image_url || listing?.image_url_1 || listing?.image_url || null;
      const title = order.listing_title || listing?.title || "Fabric Order";
      const statusInfo = getStatusInfo(order.status);
      
      const itemsCents = Number(order.items_cents || order.total_cents || 0);
      const shipCents = Number(order.shipping_cents || 0);
      const totalCents = Number(order.total_cents || (itemsCents + shipCents));
      const orderShort = order.id.slice(0, 8);
      
      const isCanceled = statusInfo.step === 0;
      const within30Min = minutesSince(order.created_at) <= 30;
      const canCancel = within30Min && !isCanceled && statusInfo.step === 1;
      const hasShipping = order.shipping_address_line1 || order.shipping_city;

      contentEl.innerHTML = `
        <div class="pageHeader">
          <div>
            <h1>Order Details</h1>
            <div class="orderNumber">Order #${orderShort} · ${fmtDate(order.created_at)}</div>
          </div>
          <span class="statusBadge ${statusInfo.class}">${statusInfo.label}</span>
        </div>

        <div class="grid">
          <div>
            <div class="card" style="margin-bottom:16px">
              <div class="card-header">Item Purchased</div>
              <div class="card-body">
                <div class="itemRow">
                  ${img ? `<div class="itemThumb"><img src="${img}" alt="${title}"></div>` : ``}
                  <div class="itemInfo">
                    <div class="itemTitle">${title}</div>
                    <div class="itemMeta">
                      ${order.listing_id ? `<a href="listing.html?id=${order.listing_id}">View listing</a>` : ''}
                    </div>
                  </div>
                  <div class="itemPrice">${money(itemsCents)}</div>
                </div>

                <div class="priceRow">
                  <span class="label">Item price</span>
                  <span>${money(itemsCents)}</span>
                </div>
                <div class="priceRow">
                  <span class="label">Shipping</span>
                  <span>${money(shipCents)}</span>
                </div>
                <div class="priceRow total">
                  <span class="label">Total Paid</span>
                  <span>${money(totalCents)}</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">Order Timeline</div>
              <div class="card-body">
                <div class="timeline">
                  ${renderTimeline(order, statusInfo.step)}
                </div>
                ${order.tracking_number ? `
                  <div class="trackingLink">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                      <rect x="1" y="3" width="15" height="13" rx="2"/>
                      <path d="M16 8h4l3 3v5a2 2 0 0 1-2 2h-1"/>
                      <circle cx="5.5" cy="18.5" r="2.5"/>
                      <circle cx="18.5" cy="18.5" r="2.5"/>
                    </svg>
                    Tracking: <a href="https://tools.usps.com/go/TrackConfirmAction?tLabels=${order.tracking_number}" target="_blank">${order.tracking_number}</a>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>

          <div>
            ${hasShipping ? `
              <div class="card" style="margin-bottom:16px">
                <div class="card-header">Shipping To</div>
                <div class="card-body">
                  <div class="addressBox">
                    <div class="name">${order.shipping_name || ''}</div>
                    <div>${order.shipping_address_line1 || ''}</div>
                    ${order.shipping_address_line2 ? `<div>${order.shipping_address_line2}</div>` : ''}
                    <div>${order.shipping_city || ''}, ${order.shipping_state || ''} ${order.shipping_postal_code || ''}</div>
                  </div>
                </div>
              </div>
            ` : ''}

            <div class="card">
              <div class="card-header">Actions</div>
              <div class="card-body">
                ${canCancel ? `
                  <div class="cancelWarning">
                    ⏱ You can cancel for ${Math.round(30 - minutesSince(order.created_at))} more minutes
                  </div>
                ` : ''}
                <div class="actions">
                  ${canCancel ? `<button class="btn btn-danger" id="cancelBtn">Cancel Order</button>` : ''}
                  ${order.seller_id ? `
                    <a href="messages.html?to=${order.seller_id}&order=${order.id}" class="btn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                      Message Seller
                    </a>
                  ` : ''}
                  ${order.listing_id ? `
                    <a href="listing.html?id=${order.listing_id}" class="btn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                      View Listing
                    </a>
                  ` : ''}
                  <a href="contact.html?subject=Order%20${orderShort}" class="btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Get Help
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      const cancelBtn = document.getElementById("cancelBtn");
      if(cancelBtn){
        cancelBtn.addEventListener("click", async () => {
          if(!confirm("Cancel this order?")) return;
          cancelBtn.disabled = true;
          cancelBtn.textContent = "Cancelling...";

          const { error } = await supabaseClient
            .from("orders")
            .update({
              status: "CANCELED",
              canceled_at: new Date().toISOString(),
              canceled_by: user.id,
              cancel_reason: "buyer_canceled"
            })
            .eq("id", order.id)
            .eq("buyer_id", user.id);

          if(error){
            alert("Could not cancel. Please contact support.");
            cancelBtn.disabled = false;
            cancelBtn.textContent = "Cancel Order";
          } else {
            location.reload();
          }
        });
      }
    }

    function renderTimeline(order, currentStep){
      if(currentStep === 0){
        return `
          <div class="timelineStep complete">
            <div class="timelineDot">✓</div>
            <div class="timelineContent">
              <div class="timelineTitle">Order Placed</div>
              <div class="timelineDate">${fmtDateTime(order.created_at)}</div>
            </div>
          </div>
          <div class="timelineStep active">
            <div class="timelineDot">✕</div>
            <div class="timelineContent">
              <div class="timelineTitle">Cancelled</div>
              <div class="timelineDate">${fmtDateTime(order.canceled_at) || ''}</div>
            </div>
          </div>
        `;
      }

      const steps = [
        { label: "Order Placed", date: order.created_at, step: 1 },
        { label: "Shipped", date: order.shipped_at, step: 2 },
        { label: "Delivered", date: order.delivered_at, step: 3 },
        { label: "Complete", date: order.completed_at, step: 4 }
      ];

      return steps.map(s => {
        const isComplete = currentStep >= s.step;
        const isActive = currentStep === s.step;
        return `
          <div class="timelineStep ${isComplete ? 'complete' : isActive ? 'active' : ''}">
            <div class="timelineDot">${isComplete ? '✓' : s.step}</div>
            <div class="timelineContent">
              <div class="timelineTitle">${s.label}</div>
              ${s.date ? `<div class="timelineDate">${fmtDateTime(s.date)}</div>` : ''}
            </div>
          </div>
        `;
      }).join("");
    }

    loadOrder();
  </script>
</body>
</html>
