<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Hemline — Favorites</title>
  <style>
    :root { --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --bg:#fafafa; --card:#ffffff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px;font-weight:700}
    .btn{display:inline-block;padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;margin-left:8px}
    #status{max-width:1100px;margin:12px auto;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    main{max-width:1100px;margin:0 auto;padding:0 16px 24px}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:560px){.grid{grid-template-columns:1fr 1fr}}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr 1fr}}

    .card{position:relative;display:block;background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .tile{display:block;color:inherit;text-decoration:none}
    .thumb{display:block;aspect-ratio:4/5;background:#f3f4f6}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:10px 12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .price{font-weight:700}
    .sub{margin-top:2px;color:var(--muted);font-size:13px;min-height:1.2em}

    .heart{position:absolute;top:10px;right:10px;width:40px;height:40px;border:1px solid var(--line);border-radius:999px;background:#fff;display:grid;place-items:center;cursor:pointer;z-index:3}
    .heart svg{width:18px;height:18px;fill:none;stroke:#111;stroke-width:2}
    .heart.active svg{fill:#ef4444;stroke:#ef4444}
    .heart:active{transform:scale(.96)}

    a,a:visited,a:active{color:inherit;text-decoration:none;-webkit-tap-highlight-color:transparent}
    .tile:active .title,.tile:active .price{color:inherit}
    button{-webkit-tap-highlight-color:transparent}
  </style>

  <!-- Env + helpers -->
  <script src="/env.js"></script>
  <script>
    (function loadSupabase(){
      function add(src, cb){const s=document.createElement('script');s.src=src;s.onload=cb;s.onerror=cb;document.head.appendChild(s);}
      add("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js", function(){
        if (!window.supabase) add("https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js", function(){});
      });
    })();
  </script>
  <script src="/app.js"></script>
</head>
<body>
  <header>
    Hemline
    <a class="btn" href="/index.html">Home</a>
    <a class="btn" href="/listings.html">Listings</a>
    <a class="btn" href="/favorites.html">Favorites</a>
  </header>

  <div id="status">Loading favorites…</div>
  <main><div id="grid" class="grid" aria-live="polite"></div></main>

  <script>
    (async () => {
      const s = document.getElementById('status'); const grid = document.getElementById('grid');
      function show(msg){ s.textContent = msg; }

      let tries=0; while(!window.supabase && tries<20){ await new Promise(r=>setTimeout(r,150)); tries++; }
      if (!window.supabase) return show('Error loading Supabase.');
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) return show('Missing env.');

      const sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

      // Require login
      const { data: sess } = await sb.auth.getSession();
      const userId = sess?.session?.user?.id || null;
      if (!userId) { show('Please sign in to view your favorites.'); hm.toast('Sign in to view favorites.'); return; }

      // Join favorites -> listings (fallback to 2-step if join unsupported)
      let favs = [];
      try {
        const res = await sb
          .from('favorites')
          .select('listing_id, created_at')
          .order('created_at', { ascending:false })
          .limit(200);
        favs = hm.guard(res, 'Couldn’t load favorites.');
      } catch (_) {
        return show('Couldn’t load favorites.');
      }
      if (!favs.length) return show('No favorites yet.');

      // Fetch those listings
      const ids = favs.map(f => f.listing_id);
      let listings = [];
      try {
        const res = await sb
          .from('listings')
          .select('id,title,price_cents,cover_url,subtitle,tags')
          .in('id', ids);
        listings = hm.guard(res, 'Couldn’t load listings for favorites.');
      } catch (_) {
        return show('Couldn’t load listings for favorites.');
      }

      // Keep original order by created_at of favorite
      const byId = new Map(listings.map(r => [r.id, r]));
      const ordered = favs.map(f => byId.get(f.listing_id)).filter(Boolean);
      show(''); s.hidden = true;

      // Render
      grid.innerHTML = ordered.map(r=>{
        const price = r?.price_cents ? ('$'+(r.price_cents/100).toFixed(2)) : '';
        const sub = r?.subtitle || (Array.isArray(r?.tags) ? r.tags.join(', ') : (r?.tags || ''));
        const img = r?.cover_url || '';
        return `
          <div class="card" data-id="${r?.id}">
            <a class="tile" href="/listing.html?id=${encodeURIComponent(r?.id)}">
              <span class="thumb"><img alt="" ${img ? `src="${img}"` : 'style="display:none"'}></span>
              <span class="meta">
                <span class="row"><span class="title">${r?.title ?? 'Untitled'}</span><span class="price">${price}</span></span>
                <span class="sub">${sub || ''}</span>
              </span>
            </a>
            <button type="button" class="heart active" data-heart aria-label="Unsave">
              <svg viewBox="0 0 24 24"><path d="M20.8 4.6a5.6 5.6 0 0 0-7.9 0l-.9.9-.9-.9a5.6 5.6 0 1 0-7.9 7.9l.9.9 7.9 7.9 7.9-7.9.9-.9a5.6 5.6 0 0 0 0-7.9z"/></svg>
            </button>
          </div>`;
      }).join('');

      // Unfavorite from the list
      grid.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-heart]'); if (!btn) return;
        e.preventDefault(); e.stopPropagation();
        const id = btn.closest('.card')?.dataset?.id; if (!id) return;

        try {
          hm.guard(await sb.from('favorites').delete().eq('listing_id', id).eq('user_id', userId), 'Couldn’t remove favorite.');
          btn.closest('.card')?.remove();
          hm.toast('Removed from Favorites.');
          if (!grid.children.length) { s.hidden=false; show('No favorites yet.'); }
        } catch (err) {
          hm.toast(hm.normalizeSupabaseError(err));
        }
      });
    })();
  </script>
</body>
</html>
