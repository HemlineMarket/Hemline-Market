<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Favorites — Hemline Market</title>

  <!-- Shared CSS stack (universal) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#991b1b;
      --bg:#f4f4f7;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:
        linear-gradient(to bottom,rgba(255,255,255,.55) 0%,rgba(255,255,255,.45) 100%),
        url("images/homepage.jpeg") center/cover fixed no-repeat,
        var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    /* PAGE-SPECIFIC LAYOUT ONLY (no header/footer styling here) */
    main.wrap{
      max-width:1200px;
      margin:16px auto 28px;
      padding:0 12px;
    }
    h1{
      margin:0 0 6px;
      font-size:28px;
      font-weight:800;
      color:#fff;
      text-shadow:0 2px 8px rgba(0,0,0,.5);
    }
    .subtle{
      color:#fff;
      text-shadow:0 1px 4px rgba(0,0,0,.5);
      margin:0 0 12px;
      font-size:14px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
    }
    @media(max-width:1020px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}

    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .rel{position:relative}
    .photo{
      width:100%;
      aspect-ratio:4/3;
      object-fit:cover;
      display:block;
      background:linear-gradient(180deg,#f8fafc,#eef2f7);
    }
    .heart{
      position:absolute;
      top:8px;
      right:8px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:999px;
      width:32px;
      height:32px;
      display:grid;
      place-items:center;
      cursor:pointer;
      padding:0;
    }
    .heart svg{
      width:18px;
      height:18px;
      stroke:#b91c1c;
      fill:#b91c1c;
    }
    .bd{
      padding:10px;
    }
    .title{
      font-weight:700;
      font-size:14px;
    }
    .meta{
      color:#6b7280;
      font-size:12px;
      margin-top:2px;
    }
    .row{
      display:flex;
      gap:8px;
      margin-top:8px;
    }
    .btn{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:700;
      cursor:pointer;
      font-size:13px;
    }
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .empty{
      border:2px dashed #e5e7eb;
      border-radius:12px;
      padding:20px;
      text-align:center;
      color:#374151;
      font-size:14px;
      margin-top:8px;
      background:rgba(255,255,255,.9);
    }
  </style>
</head>
<body>

  <!-- Universal header placeholder -->
  <div id="hm-shell-header"></div>

  <!-- MAIN -->
  <main class="wrap" id="maincontent">
    <h1>Favorites</h1>
    <p class="subtle">Your saved fabrics.</p>

    <div id="signInPrompt" class="empty" style="display:none;">
      <a href="auth.html?view=login" style="color:#991b1b;text-decoration:none;font-weight:600;">Sign in</a> to see your favorites.
    </div>
    <div id="empty" class="empty" style="display:none;">
      No favorites yet. Browse listings and tap the heart to save fabrics.
    </div>
    <section id="grid" class="grid" aria-live="polite"></section>
  </main>

  <!-- Universal footer placeholder -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase (for universal header/session) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Universal shell JS -->
  <script src="scripts/hm-shell.js"></script>

  <!-- Page-specific JS: favorites store/rendering only -->
  <script>
  (async function(){
    const STORAGE_KEY = 'hm_favs';
    const grid  = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const signInPrompt = document.getElementById('signInPrompt');

    // Check if user is signed in
    const supabase = window.HM?.supabase;
    let isSignedIn = false;
    
    if (supabase) {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        isSignedIn = !!session?.user;
      } catch (e) {
        console.error('[favorites] Auth check failed:', e);
      }
    }

    // If not signed in, show sign-in prompt
    if (!isSignedIn) {
      if (signInPrompt) signInPrompt.style.display = 'block';
      if (empty) empty.style.display = 'none';
      if (grid) grid.style.display = 'none';
      return;
    }

    function getFavs(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      }catch(_){
        return [];
      }
    }

    function setFavs(favs){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(favs || []));
      }catch(_){}
    }

    function removeFav(id){
      const next = getFavs().filter(x => String(x.id) !== String(id));
      setFavs(next);
      renderFavorites();
    }

    function formatPrice(fav){
      // tolerate both legacy and new shapes
      if (fav.perYd != null){
        const v = Number(fav.perYd);
        if (!isNaN(v)) return '$' + v.toFixed(2) + '/yard';
      }
      if (fav.price_per_yard != null){
        const v = Number(fav.price_per_yard);
        if (!isNaN(v)) return '$' + v.toFixed(2) + '/yard';
      }
      if (fav.price_cents != null){
        const cents = Number(fav.price_cents);
        if (!isNaN(cents)){
          const val = cents/100;
          return val.toLocaleString(
            'en-US',
            { style:'currency', currency:'USD', minimumFractionDigits:2 }
          ) + '/yard';
        }
      }
      return '';
    }

    function formatMeta(fav){
      const parts = [];
      const price = formatPrice(fav);
      if (price) parts.push(price);

      const yards = fav.yards_available != null ? fav.yards_available : fav.yards;
      if (yards != null && yards !== ''){
        parts.push(yards + ' yd');
      }

      const width = fav.width_inches != null ? fav.width_inches : fav.width;
      if (width != null && width !== ''){
        parts.push(width + '″');
      }

      return parts.join(' · ');
    }

    function favHref(fav){
      if (fav.href) return fav.href;
      if (fav.url) return fav.url;
      if (fav.id != null) return 'listing.html?id=' + encodeURIComponent(fav.id);
      return 'browse.html?type=listings';
    }

    function favPhoto(fav){
      return fav.photo || fav.image_url_1 || fav.image || '';
    }

    function renderFavorites(){
      const favs = getFavs();
      if (!grid || !empty) return;

      grid.innerHTML = '';
      if (!favs.length){
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      favs.forEach(fav=>{
        const card  = document.createElement('article');
        card.className = 'card';

        const rel   = document.createElement('div');
        rel.className = 'rel';

        const img   = document.createElement('img');
        img.className = 'photo';
        img.alt  = fav.title || 'Fabric photo';
        const src = favPhoto(fav);
        if (src) img.src = src;

        const heart = document.createElement('button');
        heart.type = 'button';
        heart.className = 'heart';
        heart.setAttribute('aria-label','Remove from favorites');
        heart.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
        `;
        heart.addEventListener('click', ()=> removeFav(fav.id));

        rel.appendChild(img);
        rel.appendChild(heart);

        const bd   = document.createElement('div');
        bd.className = 'bd';

        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = fav.title || 'Untitled fabric';

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = formatMeta(fav);

        const row  = document.createElement('div');
        row.className = 'row';

        const view = document.createElement('a');
        view.className = 'btn primary';
        view.href = favHref(fav);
        view.textContent = 'View';

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', ()=> removeFav(fav.id));

        row.appendChild(view);
        row.appendChild(removeBtn);

        bd.appendChild(title);
        bd.appendChild(meta);
        bd.appendChild(row);

        card.appendChild(rel);
        card.appendChild(bd);
        grid.appendChild(card);
      });
    }

    renderFavorites();
  })();
  </script>

  <!-- Cart hooks (global) -->
  <script src="assets/add-to-cart.js" defer></script>

  <!-- Render universal shell with current page -->
  <script>
    window.HM && window.HM.renderShell({ currentPage: "favorites" });
  </script>
</body>
</html>
