<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Notifications — Hemline Market</title>

  <!-- UNIVERSAL CSS STACK -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --hm-border:#e5e7eb;
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --bg:#ffffff;
      --bg-page:#fafafa;
      --accent:#991b1b;
    }

    html,body{
      margin:0;
      background:
        url("images/homepage.jpeg") center/cover fixed no-repeat,
        var(--bg-page);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      max-width:100%;
      overflow-x:hidden;
    }

    main.wrap{
      max-width:700px;
      margin:0 auto;
      padding:0 12px 16px;
    }

    h1{
      margin:18px 0 12px;
      font-size:24px;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    h1::before{
      content:'';
      width:4px;
      height:24px;
      background:var(--accent);
      border-radius:2px;
    }

    .card{
      background:var(--bg);
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
    }

    .notif-empty{
      padding:32px 18px;
      font-size:14px;
      color:var(--muted);
      text-align:center;
    }

    .notif-list{
      list-style:none;
      margin:0;
      padding:0;
    }

    /* Individual notification item */
    .notif-item{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      transition:background 0.15s;
      cursor:pointer;
    }

    .notif-item:last-child{
      border-bottom:none;
    }

    .notif-item:hover{
      background:#fafafa;
    }

    /* Unread indicator dot */
    .notif-dot{
      width:10px;
      height:10px;
      border-radius:50%;
      background:#d1d5db;
      flex-shrink:0;
      margin-top:5px;
    }

    .notif-item.unread .notif-dot{
      background:var(--accent);
      box-shadow:0 0 0 3px rgba(153,27,27,0.15);
    }

    /* Content area */
    .notif-content{
      flex:1;
      min-width:0;
    }

    .notif-title-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:4px;
    }

    .notif-title{
      font-size:14px;
      font-weight:400;
      color:var(--muted);
      line-height:1.4;
    }

    /* Unread = bold and dark */
    .notif-item.unread .notif-title{
      font-weight:600;
      color:var(--ink);
    }

    /* Type pill */
    .notif-pill{
      font-size:10px;
      padding:3px 8px;
      border-radius:6px;
      border:1px solid var(--line);
      color:var(--muted);
      white-space:nowrap;
      flex-shrink:0;
      text-transform:uppercase;
      letter-spacing:0.3px;
      font-weight:600;
    }

    .notif-pill.sale{
      border-color:#dcfce7;
      color:#15803d;
      background:#f0fdf4;
    }

    .notif-pill.message{
      border-color:#fecaca;
      color:#b91c1c;
      background:#fef2f2;
    }

    .notif-pill.favorite{
      border-color:#fce7f3;
      color:#be185d;
      background:#fdf2f8;
    }

    .notif-pill.comment{
      border-color:#dbeafe;
      color:#1d4ed8;
      background:#eff6ff;
    }

    .notif-pill.threadtalk{
      border-color:#f3e8ff;
      color:#7c3aed;
      background:#faf5ff;
    }

    .notif-body{
      font-size:13px;
      color:#6b7280;
      line-height:1.4;
      margin-bottom:4px;
    }

    .notif-item.unread .notif-body{
      color:#4b5563;
    }

    .notif-meta{
      font-size:11px;
      color:#9ca3af;
    }

    .notif-link{
      display:inline-block;
      margin-top:6px;
      font-size:12px;
      font-weight:600;
      color:var(--accent);
      text-decoration:none;
      padding:4px 0;
    }

    .notif-link:hover{
      text-decoration:underline;
    }

    /* Read notification = faded */
    .notif-item:not(.unread){
      opacity:0.7;
    }

    .notif-item:not(.unread):hover{
      opacity:1;
    }

    /* Mobile */
    @media (max-width:640px){
      main.wrap{
        padding:0 10px 16px;
      }
      
      h1{
        font-size:20px;
        margin:14px 0 10px;
      }

      .notif-item{
        padding:12px 14px;
        gap:10px;
      }

      .notif-dot{
        width:8px;
        height:8px;
        margin-top:6px;
      }

      .notif-title{
        font-size:13px;
      }

      .notif-pill{
        font-size:9px;
        padding:2px 6px;
      }

      .notif-body{
        font-size:12px;
      }

      .notif-title-row{
        flex-direction:column;
        gap:6px;
      }

      .notif-pill{
        align-self:flex-start;
      }
    }
  </style>
</head>
<body>

<div id="hm-shell-header"></div>

<main class="wrap" id="maincontent">
  <h1>Notifications</h1>

  <section class="card" aria-label="Notifications feed">
    <div class="notif-empty" id="notifEmpty">
      Checking for notifications…
    </div>
    <ul class="notif-list" id="notifList"></ul>
  </section>
</main>

<div id="hm-shell-footer"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/hm-shell.js"></script>

<script>
  const supabaseClient = window.supabase.createClient(
    "https://clkizksbvxjkoatdajgd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI",
    {
      auth:{
        persistSession:true,
        autoRefreshToken:true,
        detectSessionInUrl:true
      }
    }
  );

  const notifListEl  = document.getElementById("notifList");
  const notifEmptyEl = document.getElementById("notifEmpty");

  function formatWhen(iso){
    if(!iso) return "";
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return "";
    const now = new Date();
    const diffMs = now - d;
    const diffMin = Math.floor(diffMs/60000);
    const diffHr  = Math.floor(diffMs/3600000);
    const diffDay = Math.floor(diffMs/86400000);

    if(diffMin < 1) return "Just now";
    if(diffMin < 60) return diffMin + " min ago";
    if(diffHr  < 24) return diffHr + " hr" + (diffHr === 1 ? "" : "s") + " ago";
    if(diffDay < 7) return diffDay + " day" + (diffDay === 1 ? "" : "s") + " ago";

    return d.toLocaleDateString([],{
      month:"short",
      day:"numeric",
      year:"numeric"
    });
  }

  async function ensureSession(maxWaitMs=3000){
    let { data:{ session } } = await supabaseClient.auth.getSession();
    if(session) return session;

    const start = Date.now();
    while(!session && (Date.now() - start < maxWaitMs)){
      await new Promise(r => setTimeout(r, 200));
      ({ data:{ session } } = await supabaseClient.auth.getSession());
    }
    return session;
  }

  async function loadNotifications(){
    const session = await ensureSession();
    if(!session){
      notifEmptyEl.textContent = "Sign in to see notifications.";
      return;
    }

    const uid = session.user.id;
    const { data, error } = await supabaseClient
      .from("notifications")
      .select("id, type, kind, title, body, href, link, created_at, read_at")
      .eq("user_id", uid)
      .order("created_at", { ascending:false })
      .limit(50);

    if(error){
      console.error("Notifications error:", error);
      notifEmptyEl.textContent = "Could not load notifications.";
      return;
    }

    if(!data || !data.length){
      notifEmptyEl.textContent = "No notifications yet.";
      return;
    }

    notifEmptyEl.style.display = "none";
    const unreadIds = [];

    data.forEach(n => {
      const li = document.createElement("li");
      li.className = "notif-item";

      const isUnread = !n.read_at;
      if(isUnread){
        li.classList.add("unread");
        unreadIds.push(n.id);
      }

      const typeLabel = {
        "sale": "Sale",
        "message": "Message",
        "favorite": "Favorite",
        "comment": "Comment",
        "threadtalk": "ThreadTalk",
        "thread_comment": "ThreadTalk",
        "thread_reaction": "ThreadTalk",
        "thread_activity": "ThreadTalk",
        "comment_reply": "ThreadTalk",
        "comment_reaction": "ThreadTalk",
        "order": "Order",
        "shipping": "Shipping",
        "review": "Review"
      }[n.type || n.kind] || "Update";

      const pillClass = {
        "sale": "sale",
        "message": "message",
        "favorite": "favorite",
        "comment": "comment",
        "threadtalk": "threadtalk",
        "thread_comment": "threadtalk",
        "thread_reaction": "threadtalk",
        "thread_activity": "threadtalk",
        "comment_reply": "threadtalk",
        "comment_reaction": "threadtalk"
      }[n.type || n.kind] || "";

      const href = n.href || n.link || "#";

      li.innerHTML = `
        <div class="notif-dot"></div>
        <div class="notif-content">
          <div class="notif-title-row">
            <span class="notif-title">${n.title || "Notification"}</span>
            <span class="notif-pill ${pillClass}">${typeLabel}</span>
          </div>
          ${n.body ? `<div class="notif-body">${n.body}</div>` : ""}
          <div class="notif-meta">${formatWhen(n.created_at)}</div>
          ${href !== "#" ? `<a class="notif-link" href="${href}">View →</a>` : ""}
        </div>
      `;

      // Click anywhere to navigate
      li.addEventListener("click", (e) => {
        if(e.target.tagName !== "A" && href !== "#"){
          window.location.href = href;
        }
      });

      notifListEl.appendChild(li);
    });

    // Mark unread as read after short delay
    if(unreadIds.length){
      setTimeout(async () => {
        const nowIso = new Date().toISOString();
        await supabaseClient
          .from("notifications")
          .update({ read_at: nowIso })
          .in("id", unreadIds);
      }, 2000);
    }
  }

  window.HM && window.HM.renderShell({ currentPage: "notifications" });
  loadNotifications();
</script>

</body>
</html>
