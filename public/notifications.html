<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Notifications — Hemline Market</title>

  <!-- UNIVERSAL CSS STACK -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>

  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --bg:#ffffff;
      --bg-page:#fafafa;
      --accent:#991b1b;
    }

    html,body{
      margin:0;
      background:var(--bg-page);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      max-width:100%;
      overflow-x:hidden;
    }

    main.wrap{
      max-width:1200px;
      margin:0 auto;
      padding:0 12px 16px;
    }

    h1{
      margin:18px 0 12px;
      font-size:24px;
      font-weight:800;
    }

    .card{
      background:var(--bg);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 0;
    }

    .notif-empty{
      padding:16px 18px;
      font-size:14px;
      color:var(--muted);
    }

    .notif-list{
      list-style:none;
      margin:0;
      padding:0;
    }

    .notif-item{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:12px 18px;
      border-top:1px solid var(--line);
    }

    .notif-item:first-child{
      border-top:none;
    }

    .notif-title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .notif-title{
      font-size:14px;
      font-weight:600;
      color:var(--ink);
    }

    .notif-title.unread{
      color:#b91c1c;
    }

    .notif-pill{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      white-space:nowrap;
    }

    .notif-pill.message{
      border-color:#fecaca;
      color:#b91c1c;
      background:#fef2f2;
    }

    .notif-body{
      font-size:13px;
      color:#4b5563;
    }

    .notif-meta{
      font-size:11px;
      color:var(--muted);
    }

    .notif-link{
      margin-top:4px;
      font-size:12px;
      color:var(--accent);
      text-decoration:none;
    }

    .notif-link:hover{
      text-decoration:underline;
    }

    @media (max-width:640px){
      .notif-item{
        padding:10px 14px;
      }
      .notif-title-row{
        flex-direction:column;
        align-items:flex-start;
      }
    }
  </style>
</head>
<body>

<!-- UNIVERSAL HEADER -->
<div id="hm-shell-header"></div>

<main class="wrap" id="maincontent">
  <h1>Notifications</h1>

  <section class="card" aria-label="Notifications feed">
    <div class="notif-empty" id="notifEmpty">
      Checking for notifications…
    </div>
    <ul class="notif-list" id="notifList"></ul>
  </section>
</main>

<!-- UNIVERSAL FOOTER -->
<div id="hm-shell-footer"></div>

<!-- JS STACK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/hm-shell.js"></script>

<script>
  // Same project as messages
  const supabaseClient = window.supabase.createClient(
    "https://clkizksbvxjkoatdajgd.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI",
    {
      auth:{
        persistSession:true,
        autoRefreshToken:true,
        detectSessionInUrl:true
      }
    }
  );

  const notifListEl  = document.getElementById("notifList");
  const notifEmptyEl = document.getElementById("notifEmpty");

  function formatWhen(iso){
    if(!iso) return "";
    const d = new Date(iso);
    if(Number.isNaN(d.getTime())) return "";
    const now = new Date();
    const diffMs = now - d;
    const diffMin = Math.floor(diffMs/60000);
    const diffHr  = Math.floor(diffMs/3600000);
    const diffDay = Math.floor(diffMs/86400000);

    if(diffMin < 1) return "Just now";
    if(diffMin < 60) return diffMin + " min ago";
    if(diffHr  < 24) return diffHr + " hr" + (diffHr === 1 ? "" : "s") + " ago";
    if(diffDay < 7) return diffDay + " day" + (diffDay === 1 ? "" : "s") + " ago";

    return d.toLocaleDateString([],{
      month:"short",
      day:"numeric",
      year:"numeric"
    });
  }

  async function ensureSession(maxWaitMs=3000){
    let { data:{ session } } = await supabaseClient.auth.getSession();
    if(session?.user) return session;
    const start = Date.now();
    while(!session?.user && Date.now() - start < maxWaitMs){
      await new Promise(r => setTimeout(r, 120));
      ({ data:{ session } } = await supabaseClient.auth.getSession());
    }
    return session || null;
  }

  async function loadNotifications(){
    const session = await ensureSession();
    if(!session || !session.user){
      window.location.href = "auth.html?view=login";
      return;
    }

    const userId = session.user.id;

    const { data, error } = await supabaseClient
      .from("notifications")
      .select("id, type, kind, title, body, href, link, created_at, is_read")
      .eq("user_id", userId)
      .order("created_at", { ascending:false })
      .limit(50);

    if(error){
      console.error("Error loading notifications", error);
      notifEmptyEl.textContent = "We couldn’t load notifications. Please refresh.";
      return;
    }

    if(!data || !data.length){
      notifEmptyEl.textContent = "No notifications yet.";
      notifListEl.innerHTML = "";
      return;
    }

    notifEmptyEl.style.display = "none";
    notifListEl.innerHTML = "";

    const unreadIds = [];

    data.forEach(n => {
      const li = document.createElement("li");
      li.className = "notif-item";

      const titleRow = document.createElement("div");
      titleRow.className = "notif-title-row";

      const title = document.createElement("div");
      title.className = "notif-title";
      const isUnread = n.is_read !== true;
      if(isUnread){
        title.classList.add("unread");
        unreadIds.push(n.id);
      }
      title.textContent = n.title || "Notification";

      const pill = document.createElement("span");
      pill.className = "notif-pill";
      const type = n.kind || n.type || "notice";
      pill.textContent = type === "message"
        ? "Message"
        : type.charAt(0).toUpperCase() + type.slice(1);
      if(type === "message"){
        pill.classList.add("message");
      }

      titleRow.appendChild(title);
      titleRow.appendChild(pill);
      li.appendChild(titleRow);

      if(n.body){
        const body = document.createElement("div");
        body.className = "notif-body";
        body.textContent = n.body;
        li.appendChild(body);
      }

      const meta = document.createElement("div");
      meta.className = "notif-meta";
      meta.textContent = formatWhen(n.created_at);
      li.appendChild(meta);

      const href = n.href || n.link || "";
      if(href){
        const a = document.createElement("a");
        a.className = "notif-link";
        a.href = href;
        a.textContent = "Open";
        li.appendChild(a);
      }

      notifListEl.appendChild(li);
    });

    // Mark unread as read
    if(unreadIds.length){
      const nowIso = new Date().toISOString();
      supabaseClient
        .from("notifications")
        .update({ is_read:true, read_at:nowIso, seen_at:nowIso })
        .in("id", unreadIds)
        .then(({ error }) => {
          if(error) console.warn("Error marking notifications read", error);
        });
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    loadNotifications();
  });
</script>

<script>
  window.HM && window.HM.renderShell({ currentPage: "notifications" });
</script>

</body>
</html>
