<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Notifications — Hemline Market</title>

  <!-- Shared CSS stack (universal) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-text:#111827;
      --hm-muted:#6b7280;
      --hm-border:#e5e7eb;
      --hm-bg:#fafafa;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }
    img,svg,canvas,video{max-width:100%;height:auto;display:block}

    /* PAGE LAYOUT (notifications only) */
    .wrap-main{
      max-width:1200px;
      margin:18px auto 28px;
      padding:0 12px;
    }

    .pagehead{
      margin:4px 0 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .pagehead h1{
      margin:0;
      font-size:22px;
      font-weight:800;
    }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--hm-border);
      background:#fff;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    .notif-card{
      background:#fff;
      border:1px solid var(--hm-border);
      border-radius:12px;
      overflow:hidden;
    }
    .group{
      padding:10px 12px;
      border-bottom:1px solid var(--hm-border);
      background:#fafafa;
      font-weight:700;
      color:#374151;
      font-size:13px;
    }
    .list{display:grid;}
    .item{
      display:grid;
      grid-template-columns:auto 1fr;
      gap:12px;
      align-items:center;
      padding:12px;
      border-bottom:1px solid var(--hm-border);
      cursor:pointer;
    }
    .item:last-child{border-bottom:0;}
    .item.read{cursor:default;}
    .item:hover{
      background:#f9fafb;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:50%;
      background:var(--hm-accent);
      opacity:.95;
      flex-shrink:0;
    }
    .item.read .dot{opacity:0;}
    .title{font-weight:700;font-size:14px;}
    .meta{
      color:var(--hm-muted);
      font-size:12px;
      margin-top:2px;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill-kind{
      font-size:11px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      padding:2px 8px;
      background:#f9fafb;
      color:#374151;
    }
    .when{font-size:11px;}
    .empty{
      padding:14px;
      color:#6b7280;
      font-size:13px;
    }
  </style>
</head>
<body>

  <!-- Universal header placeholder -->
  <div id="hm-shell-header"></div>

  <main class="wrap-main">
    <div class="pagehead">
      <h1>Notifications</h1>
      <div class="actions">
        <button class="btn" id="markAll">Mark all as read</button>
        <button class="btn" id="clearAll">Clear</button>
      </div>
    </div>

    <section class="notif-card" id="notifCard">
      <div class="group">Today</div>
      <div class="list" id="listToday"></div>

      <div class="group">Earlier</div>
      <div class="list" id="listEarlier"></div>
    </section>
  </main>

  <!-- Universal footer placeholder -->
  <div id="hm-shell-footer"></div>

  <!-- Supabase (for universal header/session) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Universal shell JS -->
  <script src="scripts/hm-shell.js"></script>

  <!-- Notifications logic: reads from localStorage "hm_notifications" -->
  <script>
  (function(){
    const NOTIF_KEY   = 'hm_notifications';
    const UNREAD_KEY  = 'hm_notifications_unread'; // numeric unread count for header/badge
    const listToday   = document.getElementById('listToday');
    const listEarlier = document.getElementById('listEarlier');

    function getNotifs(){
      try{
        const raw = localStorage.getItem(NOTIF_KEY);
        const data = raw ? JSON.parse(raw) : [];
        return Array.isArray(data) ? data : [];
      }catch(_){
        return [];
      }
    }

    function saveNotifs(arr){
      const safe = Array.isArray(arr) ? arr : [];
      try{
        localStorage.setItem(NOTIF_KEY, JSON.stringify(safe));
        // Update unread count so the header can show a number
        const unreadCount = safe.filter(n => n && n.unread !== false).length;
        localStorage.setItem(UNREAD_KEY, String(unreadCount));
      }catch(_){}
    }

    function isToday(date){
      const d = new Date(date);
      if(!Number.isFinite(d.getTime())) return false;
      const now = new Date();
      return d.getFullYear() === now.getFullYear() &&
             d.getMonth()    === now.getMonth() &&
             d.getDate()     === now.getDate();
    }

    function formatWhen(iso){
      if(!iso) return '';
      const d = new Date(iso);
      if(!Number.isFinite(d.getTime())) return '';
      return d.toLocaleString(undefined,{
        month:'short',
        day:'numeric'
      });
    }

    function renderList(container, items, isTodayGroup){
      container.innerHTML = '';
      if(!items.length){
        if(isTodayGroup){
          const div = document.createElement('div');
          div.className = 'empty';
          div.textContent = "You’re all caught up.";
          container.appendChild(div);
        }
        return;
      }

      items.forEach(n=>{
        const row = document.createElement('div');
        row.className = 'item' + (n.unread === false ? ' read' : '');
        row.dataset.id = n.id || '';

        const dot = document.createElement('span');
        dot.className = 'dot';
        dot.setAttribute('aria-hidden','true');

        const main = document.createElement('div');
        const title = document.createElement('div');
        title.className = 'title';
        title.textContent = n.title || 'Notification';

        const meta = document.createElement('div');
        meta.className = 'meta';

        const pill = document.createElement('span');
        pill.className = 'pill-kind';
        pill.textContent = n.kind || 'Activity';
        meta.appendChild(pill);

        if(n.meta){
          const metaText = document.createElement('span');
          metaText.textContent = n.meta;
          meta.appendChild(metaText);
        }

        const when = document.createElement('span');
        when.className = 'when';
        when.textContent = formatWhen(n.created_at);
        meta.appendChild(when);

        main.appendChild(title);
        main.appendChild(meta);

        row.appendChild(dot);
        row.appendChild(main);

        // Clicking the row:
        // - If there's an href, navigate there.
        // - Also mark this notif as read in localStorage.
        row.addEventListener('click', ()=>{
          const notifs = getNotifs();
          const idx = notifs.findIndex(x => x.id === n.id);
          if(idx !== -1){
            notifs[idx].unread = false;
            saveNotifs(notifs);
          }
          row.classList.add('read');
          if(n.href){
            window.location.href = n.href;
          }
        });

        container.appendChild(row);
      });
    }

    function renderAll(){
      const all = getNotifs().sort((a,b)=>{
        return new Date(b.created_at||0) - new Date(a.created_at||0);
      });

      const todays  = all.filter(n => isToday(n.created_at));
      const earlier = all.filter(n => !isToday(n.created_at));

      renderList(listToday, todays, true);
      renderList(listEarlier, earlier, false);
    }

    // Mark everything as read as soon as the notifications page is opened
    function markAllAsRead(){
      const current = getNotifs();
      if(!current.length){
        saveNotifs(current); // also ensures unread count key is 0
        return;
      }
      const updated = current.map(n => ({ ...n, unread:false }));
      saveNotifs(updated);
    }

    // Buttons (still here, but they're now just helpers if new notifs arrive while on-page)
    const markAllBtn = document.getElementById('markAll');
    const clearAllBtn = document.getElementById('clearAll');

    if(markAllBtn){
      markAllBtn.addEventListener('click', ()=>{
        markAllAsRead();
        renderAll();
      });
    }
    if(clearAllBtn){
      clearAllBtn.addEventListener('click', ()=>{
        saveNotifs([]);
        renderAll();
      });
    }

    // On page load:
    // 1) Mark everything as read (visiting = "I saw these")
    // 2) Render the lists
    markAllAsRead();
    renderAll();
  })();
  </script>

  <!-- Render universal shell with current page -->
  <script>
    window.HM && window.HM.renderShell({ currentPage: "notifications" });
  </script>
</body>
</html>
