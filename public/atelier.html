<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Your Atelier — Hemline Market</title>

  <!-- Shared styles -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-text:#111827;
      --hm-muted:#6b7280;
      --hm-border:#e5e7eb;
      --hm-bg:#f3f4f6;
      --hm-card:#ffffff;
    }
    body{
      margin:0;
      background:var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }
    main.wrap{
      max-width:1100px;
      margin:18px auto 28px;
      padding:0 12px;
    }
    h1{
      margin:0 0 4px;
      font-size:28px;
      font-weight:800;
    }
    .subtle{
      margin:0 0 18px;
      font-size:14px;
      color:var(--hm-muted);
    }

    /* Logged-out notice */
    #atelierLoggedOut{
      margin-top:16px;
      background:#fff;
      border:1px solid var(--hm-border);
      border-radius:12px;
      padding:16px 16px 14px;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
      display:none;
    }
    #atelierLoggedOut h2{
      margin:0 0 6px;
      font-size:18px;
      font-weight:700;
    }
    #atelierLoggedOut p{
      margin:0 0 10px;
      font-size:14px;
      color:var(--hm-muted);
    }
    #atelierLoggedOut .actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .btn{
      padding:8px 14px;
      border-radius:10px;
      border:1px solid var(--hm-border);
      background:#fff;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }
    .btn.primary{
      border-color:var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      box-shadow:0 2px 8px rgba(153,27,27,.25);
    }

    /* Atelier layout */
    #atelierGrid{
      display:grid;
      grid-template-columns:1.2fr 1.8fr;
      gap:14px;
      align-items:flex-start;
      display:none; /* shown by JS when user is loaded */
    }
    @media (max-width:960px){
      #atelierGrid{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:var(--hm-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .card .hd{
      padding:10px 12px;
      border-bottom:1px solid var(--hm-border);
      font-weight:800;
      font-size:15px;
    }
    .card .bd{
      padding:12px;
      font-size:14px;
    }

    /* Profile card */
    .profile-top{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .profile-avatar{
      width:52px;
      height:52px;
      border-radius:999px;
      border:1px solid var(--hm-border);
      display:inline-grid;
      place-items:center;
      font-weight:800;
      font-size:18px;
      color:#334155;
      background:#f9fafb;
      background-size:cover;
      background-position:center;
    }
    .profile-main{
      flex:1;
      min-width:0;
    }
    .profile-name{
      font-weight:800;
      margin-bottom:2px;
    }
    .profile-location{
      font-size:13px;
      color:var(--hm-muted);
    }
    .profile-bio{
      margin-top:6px;
      font-size:13px;
      color:#374151;
    }
    .profile-shop{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed var(--hm-border);
      font-size:13px;
    }
    .profile-shop-handle{
      font-weight:700;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }
    .profile-shop-tagline{
      margin-top:2px;
      color:var(--hm-muted);
    }
    .profile-links{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      font-size:12px;
    }
    .profile-links a{
      color:#2563eb;
      text-decoration:none;
    }
    .profile-links a:hover{
      text-decoration:underline;
    }
    .profile-footnote{
      margin-top:10px;
      padding-top:8px;
      border-top:1px solid #f3f4f6;
      font-size:12px;
      color:var(--hm-muted);
    }
    .profile-metrics{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px 12px;
      font-size:12px;
      color:#4b5563;
    }

    /* Listings card */
    .listings-header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:13px;
      color:var(--hm-muted);
    }
    .listings-header-row strong{
      color:var(--hm-text);
    }
    .listings-grid{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:900px){
      .listings-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    @media (max-width:640px){
      .listings-grid{
        grid-template-columns:1fr;
      }
    }
    .listing-tile{
      border-radius:12px;
      border:1px solid var(--hm-border);
      background:#f9fafb;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      min-height:120px;
    }
    .listing-img{
      height:80px;
      background:linear-gradient(135deg,#e5e7eb,#f3f4f6);
    }
    .listing-body{
      padding:8px 10px 10px;
      font-size:12px;
    }
    .listing-title{
      font-weight:700;
      margin-bottom:2px;
    }
    .listing-price{
      margin-top:4px;
      font-weight:700;
    }
    .listing-meta{
      margin-top:2px;
      color:var(--hm-muted);
      font-size:11px;
    }
    .listings-empty{
      margin-top:8px;
      font-size:13px;
      color:var(--hm-muted);
    }

    /* Footer tweak for this page */
    .hm-footer{
      margin-top:24px;
      background:#fff;
      border-top:1px solid var(--hm-border);
    }
  </style>
</head>
<body>

<!-- HEADER (shared layout) -->
<header class="hm-header" role="banner">
  <div class="wrap">
    <div class="left">
      <button class="hamburger" id="openMenu" type="button" aria-label="Open menu" aria-controls="menuSheet" aria-expanded="false">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
          <line x1="4" y1="6"  x2="20" y2="6"></line>
          <line x1="4" y1="12" x2="20" y2="12"></line>
          <line x1="4" y1="18" x2="20" y2="18"></line>
        </svg>
      </button>
      <a class="hm-brand" href="index.html">Hemline Market</a>
    </div>

    <div class="right">
      <a class="hm-icon" href="browse.html" aria-label="Browse &amp; search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.3-4.3"></path>
        </svg>
      </a>
      <a class="hm-icon" href="ThreadTalk.html" aria-label="ThreadTalk" title="ThreadTalk">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M4 6.5A4.5 4.5 0 0 1 8.5 2h7A4.5 4.5 0 0 1 20 6.5v5A4.5 4.5 0 0 1 15.5 16H12l-4 4v-4H8.5A4.5 4.5 0 0 1 4 11.5z"></path>
        </svg>
      </a>
      <a class="hm-icon" href="favorites.html" aria-label="Favorites">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
      </a>
      <a class="hm-icon" href="notifications.html" aria-label="Notifications">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
      </a>
      <a class="hm-icon" href="cart.html" aria-label="Cart">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="9"  cy="21" r="1"></circle>
          <circle cx="18" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
      </a>

      <!-- Avatar used across site -->
      <a class="hm-avatar" id="headerAvatar" href="account.html" title="Your account" style="display:none;">AA</a>

      <!-- Shown when logged OUT -->
      <button class="cta-header" id="loginHeaderBtn" type="button" aria-label="Log in to Hemline Market">
        Log in
      </button>

      <a class="hm-btn-primary" href="sell.html">Sell</a>
    </div>
  </div>
</header>

<!-- OVERLAY + LEFT MENU (shared) -->
<div id="sheetOverlay" aria-hidden="true"></div>

<aside class="sheet" id="menuSheet" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Site menu">
  <header>
    <strong>Menu</strong>
    <button class="close" id="closeMenu" aria-label="Close menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </header>
  <nav>
    <a href="browse.html">Browse</a>
    <a href="atelier.html">My Atelier</a>
    <a href="sell.html">Sell Fabric</a>
    <a href="ThreadTalk.html">ThreadTalk</a>
    <a href="account.html">Account</a>
    <a href="contact.html">Contact</a>
  </nav>
</aside>

<main class="wrap" id="maincontent">
  <h1>Your Atelier</h1>
  <p class="subtle">
    Your public shop profile and listings. Buyers see this page when they tap your name on a listing.
  </p>

  <!-- LOGGED OUT STATE -->
  <section id="atelierLoggedOut">
    <h2>Sign in to see your atelier</h2>
    <p>
      Log in to preview the shop page buyers will see and to start listing fabric.
    </p>
    <div class="actions">
      <a href="auth.html" class="btn primary">Log in or create account</a>
      <a href="browse.html" class="btn">Browse fabric</a>
    </div>
  </section>

  <!-- LOGGED IN STATE -->
  <div id="atelierGrid">
    <!-- LEFT: Profile -->
    <section class="card">
      <div class="hd">Profile</div>
      <div class="bd">
        <div class="profile-top">
          <div id="atelierAvatar" class="profile-avatar">AA</div>
          <div class="profile-main">
            <div id="atelierName" class="profile-name">Hemline Member</div>
            <div id="atelierLocation" class="profile-location">City, State</div>
            <p id="atelierBio" class="profile-bio">
              A short bio about sewing, fabric, and favorite projects will show here.
            </p>
          </div>
        </div>

        <div class="profile-shop">
          <div id="atelierHandle" class="profile-shop-handle">@loomlab</div>
          <div id="atelierTagline" class="profile-shop-tagline">
            Designer deadstock &amp; luxury fabrics.
          </div>
          <div class="profile-links" id="atelierLinks" style="display:none;">
            <a id="atelierWebsite" href="#" target="_blank" rel="noopener noreferrer"></a>
            <span id="atelierSocials"></span>
          </div>
        </div>

        <div class="profile-metrics">
          <span id="atelierCompleted">0 completed listings</span>
          <span id="atelierOnTime">· 0% on-time shipping</span>
        </div>

        <div class="profile-footnote">
          Buyers only see this page — not your address or payout info.  
          Edit your name, location, and bio on your <a href="account.html">Account</a> page.
        </div>
      </div>
    </section>

    <!-- RIGHT: Listings -->
    <section class="card">
      <div class="hd">Listings</div>
      <div class="bd">
        <div class="listings-header-row">
          <strong>Available fabric</strong>
          <span id="activeListingCount">0 active listings</span>
        </div>

        <div class="listings-grid" id="listingsGrid">
          <article class="listing-tile">
            <div class="listing-img"></div>
            <div class="listing-body">
              <div class="listing-title">Your fabric listing will show here</div>
              <div class="listing-price">$—</div>
              <div class="listing-meta">Once wired to Supabase, this will pull real data.</div>
            </div>
          </article>

          <article class="listing-tile">
            <div class="listing-img"></div>
            <div class="listing-body">
              <div class="listing-title">Designer deadstock, atelier finds</div>
              <div class="listing-price">$—</div>
              <div class="listing-meta">Yards, fiber content, and shipping show here.</div>
            </div>
          </article>

          <article class="listing-tile">
            <div class="listing-img"></div>
            <div class="listing-body">
              <div class="listing-title">Linen, wool, silk &amp; more</div>
              <div class="listing-price">$—</div>
              <div class="listing-meta">As you list fabric, cards will replace these samples.</div>
            </div>
          </article>
        </div>

        <p class="listings-empty" id="listingsEmpty">
          No active listings yet. List fabric from your <a href="sell.html">Sell</a> page and they’ll appear here.
        </p>
      </div>
    </section>
  </div>
</main>

<footer class="hm-footer" role="contentinfo">
  <div class="footer-wrap">
    <div class="copy">© 2025 Hemline Market</div>
    <nav class="footer-links" aria-label="Footer">
      <a href="about.html">About</a>
      <a href="faq.html">FAQ</a>
      <a href="contact.html">Contact</a>
      <a href="terms.html">Terms</a>
      <a href="privacy.html">Privacy</a>
    </nav>
  </div>
</footer>

<!-- JS: Hamburger / sheet + simple session-aware UI -->
<script type="module">
  // ---- MENU SHEET ----
  (function(){
    const sheet   = document.getElementById('menuSheet');
    const openBtn = document.getElementById('openMenu');
    const closeBtn= document.getElementById('closeMenu');
    const overlay = document.getElementById('sheetOverlay');

    function lockScroll(lock){
      document.body.style.overflow = lock ? 'hidden' : '';
    }
    function openSheet(){
      if (!sheet) return;
      sheet.classList.add('open');
      sheet.setAttribute('aria-hidden','false');
      if (overlay){
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden','false');
      }
      if (openBtn) openBtn.setAttribute('aria-expanded','true');
      lockScroll(true);
    }
    function closeSheet(){
      if (!sheet) return;
      sheet.classList.remove('open');
      sheet.setAttribute('aria-hidden','true');
      if (overlay){
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden','true');
      }
      if (openBtn) openBtn.setAttribute('aria-expanded','false');
      lockScroll(false);
    }

    if (openBtn && closeBtn && sheet){
      openBtn.addEventListener('click', (e)=>{ e.preventDefault(); openSheet(); });
      closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeSheet(); });
      if (overlay){
        overlay.addEventListener('click', closeSheet);
      }
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape') closeSheet();
      });
    }
  })();

  // ---- SUPABASE + PROFILE PREVIEW ----
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://clkizksbvxjkoatdajgd.supabase.co";
  const SUPABASE_ANON =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  function getInitials(fullName, email){
    const name = (fullName || "").trim();
    if (name){
      const parts = name.split(/\s+/);
      if (parts.length === 1) return parts[0].slice(0,2).toUpperCase();
      return (parts[0][0] + (parts[1][0] || "")).toUpperCase();
    }
    if (email){
      const local = email.split("@")[0] || "";
      if (local) return local.slice(0,2).toUpperCase();
    }
    return "HM";
  }

  async function fetchOrCreateProfile(user){
    try{
      const { data, error } = await supabase
        .from("profiles")
        .select("id, full_name, tagline, location")
        .eq("id", user.id)
        .maybeSingle();

      if (error){
        console.warn("Error loading profile for atelier:", error);
      }
      if (data) return data;

      // Create a very basic profile if it doesn't exist yet
      const fullName = user.email || "Hemline Member";
      const { data: inserted, error: insertError } = await supabase
        .from("profiles")
        .insert({
          id: user.id,
          full_name: fullName,
          tagline: "",
          location: ""
        })
        .select("id, full_name, tagline, location")
        .single();

      if (insertError){
        console.warn("Error creating profile row:", insertError);
        return { id:user.id, full_name:fullName, tagline:"", location:"" };
      }
      return inserted;
    }catch(e){
      console.error("Unexpected profile error:", e);
      return {
        id: user.id,
        full_name: user.email || "Hemline Member",
        tagline: "",
        location: ""
      };
    }
  }

  function applyHeaderUser(user, profile){
    const headerInitials = document.getElementById("headerAvatar");
    const loginHeaderBtn = document.getElementById("loginHeaderBtn");
    const initials = getInitials(profile?.full_name, user?.email);

    if (headerInitials){
      headerInitials.textContent = initials;
      headerInitials.style.display = "inline-grid";
    }
    if (loginHeaderBtn){
      loginHeaderBtn.style.display = "none";
    }

    // Try to reuse avatar image from localStorage if present
    try{
      const avatarUrl = localStorage.getItem("avatarUrl");
      if (avatarUrl && headerInitials){
        headerInitials.style.backgroundImage = `url('${avatarUrl}')`;
        headerInitials.style.backgroundSize = "cover";
        headerInitials.style.backgroundPosition = "center";
        headerInitials.textContent = "";
      }
    }catch(e){}
  }

  function applyAtelierUI(user, profile){
    const loggedOut = document.getElementById("atelierLoggedOut");
    const grid = document.getElementById("atelierGrid");

    if (loggedOut) loggedOut.style.display = "none";
    if (grid) grid.style.display = "grid";

    const nameEl = document.getElementById("atelierName");
    const locEl  = document.getElementById("atelierLocation");
    const bioEl  = document.getElementById("atelierBio");
    const avatar = document.getElementById("atelierAvatar");
    const handle = document.getElementById("atelierHandle");
    const tagline= document.getElementById("atelierTagline");
    const websiteLink = document.getElementById("atelierWebsite");
    const linksWrap   = document.getElementById("atelierLinks");
    const socialsSpan = document.getElementById("atelierSocials");

    const fullName = profile.full_name || user.email || "Hemline Member";
    if (nameEl) nameEl.textContent = fullName;
    if (locEl)  locEl.textContent  = profile.location || "Location coming soon";
    if (bioEl){
      bioEl.textContent = profile.tagline?.trim()
        ? profile.tagline
        : "Add a short note about your sourcing, favorite textiles, or sewing style on your Account page.";
    }

    const initials = getInitials(fullName, user.email);
    if (avatar){
      avatar.textContent = initials;
      try{
        const avatarUrl = localStorage.getItem("avatarUrl");
        if (avatarUrl){
          avatar.textContent = "";
          avatar.style.backgroundImage = `url('${avatarUrl}')`;
        }
      }catch(e){}
    }

    // Simple handle: @ + first word of name or local-part of email
    let rawHandle = "";
    if (fullName && fullName !== user.email){
      rawHandle = fullName.split(/\s+/)[0];
    }else if (user.email){
      rawHandle = user.email.split("@")[0];
    }
    if (handle){
      handle.textContent = rawHandle ? "@" + rawHandle.toLowerCase() : "@yourshop";
    }

    // Fun default tagline if none set
    if (tagline && !profile.tagline){
      tagline.textContent = "Designer deadstock, atelier finds, and fabrics with a story.";
    }

    // Website + socials: for now we just look in localStorage
    let hasLink = false;
    try{
      const website = localStorage.getItem("hm.shop.website") || "";
      const insta   = localStorage.getItem("hm.shop.instagram") || "";
      const tiktok  = localStorage.getItem("hm.shop.tiktok") || "";

      if (website && websiteLink){
        websiteLink.href = website;
        websiteLink.textContent = website.replace(/^https?:\/\//,"");
        hasLink = true;
      }
      const socials = [];
      if (insta) socials.push(`Instagram: @${insta.replace(/^@/,"")}`);
      if (tiktok) socials.push(`TikTok: @${tiktok.replace(/^@/,"")}`);
      if (socialsSpan && socials.length){
        socialsSpan.textContent = socials.join(" · ");
        hasLink = true;
      }
    }catch(e){}

    if (linksWrap){
      linksWrap.style.display = hasLink ? "flex" : "none";
    }

    // Simple metrics stub; later we’ll wire real numbers
    const completedEl = document.getElementById("atelierCompleted");
    const onTimeEl    = document.getElementById("atelierOnTime");
    if (completedEl) completedEl.textContent = "0 completed listings";
    if (onTimeEl) onTimeEl.textContent = "· 0% on-time shipping";
  }

  function showLoggedOutUI(){
    const loggedOut = document.getElementById("atelierLoggedOut");
    const grid = document.getElementById("atelierGrid");
    if (grid) grid.style.display = "none";
    if (loggedOut) loggedOut.style.display = "block";

    const headerInitials = document.getElementById("headerAvatar");
    const loginHeaderBtn = document.getElementById("loginHeaderBtn");
    if (headerInitials) headerInitials.style.display = "none";
    if (loginHeaderBtn) loginHeaderBtn.style.display = "inline-block";
  }

  // Init
  (async ()=>{
    try{
      const { data, error } = await supabase.auth.getUser();
      if (error){
        console.error("Atelier: getUser error", error);
      }
      const user = data?.user || null;
      if (!user){
        showLoggedOutUI();
        return;
      }

      const profile = await fetchOrCreateProfile(user);
      applyHeaderUser(user, profile);
      applyAtelierUI(user, profile);
    }catch(e){
      console.error("Atelier init error:", e);
      showLoggedOutUI();
    }
  })();

  // Header login button -> auth page
  (function(){
    const loginBtn = document.getElementById("loginHeaderBtn");
    if (loginBtn){
      loginBtn.addEventListener("click", ()=>{
        window.location.href = "auth.html";
      });
    }
  })();
</script>
</body>
</html>
