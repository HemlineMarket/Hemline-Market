<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Atelier â€” Hemline Market</title>

  <!-- Tell browsers not to aggressively cache this HTML -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>

  <!-- Shared styles (universal header/footer stack) -->
  <link rel="stylesheet" href="styles/hm-modern.css"/>
  <link rel="stylesheet" href="styles/hm-header.css"/>
  <link rel="stylesheet" href="styles/hm-typography.css"/>
  <link rel="stylesheet" href="styles/hm-footer.css"/>
  <link rel="stylesheet" href="styles/hm-badges.css"/>
  <link rel="icon" href="/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
  <link rel="apple-touch-icon" href="/images/icon.png">

  <style>
    :root{
      --hm-accent:#991b1b;
      --hm-border:#e5e7eb;
      --hm-muted:#6b7280;
      --hm-text:#111827;
      --hm-bg:#f4f4f7;
      --hm-bg-card:rgba(255,255,255,.96);
    }
    html,body{
      margin:0;
      max-width:100%;
      overflow-x:hidden;
      background:
        url("images/homepage.jpeg") center/cover fixed no-repeat,
        var(--hm-bg);
      color:var(--hm-text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }
    main img, main svg, main canvas, main video{max-width:100%;height:auto;display:block}
    .is-hidden{display:none!important;}

    /* PAGE LAYOUT */
    main.atelier-wrap{
      max-width:1200px;
      margin:18px auto 24px;
      padding:0 12px 24px;
    }

    h1.atelier-title{
      margin:0 0 4px;
      font-size:26px;
      font-weight:800;
      letter-spacing:.03em;
    }
    .atelier-title a{
      color:var(--hm-accent);
      text-decoration:none;
    }
    .atelier-title a:hover{
      text-decoration:underline;
    }
    .atelier-subtitle{
      margin:0 0 18px;
      color:var(--hm-muted);
      font-size:14px;
    }

    .hm-card{
      background:#fff;
      border-radius:14px;
      border:1px solid var(--hm-border);
      box-shadow:0 6px 18px rgba(15,23,42,.06);
      margin-bottom:16px;
    }
    .hm-card-header{
      padding:10px 16px;
      border-bottom:1px solid var(--hm-border);
      font-size:11px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#9ca3af;
      font-weight:600;
    }
    .hm-card-body{
      padding:16px;
      font-size:14px;
    }

    /* TOP STORE INFO 3-COLUMN GRID (DESKTOP/TABLET) */
    .atelier-store-top{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:16px;
      margin-bottom:18px;
    }
    @media(max-width:960px){
      .atelier-store-top{
        grid-template-columns:repeat(3,minmax(0,1fr));
      }
    }
    @media(max-width:640px){
      .atelier-store-top{
        display:none; /* hide big cards on mobile */
      }
    }

    /* MOBILE QUICK INFO */
    .atelier-store-mobile{
      display:none;
      margin-bottom:16px;
    }
    @media(max-width:640px){
      .atelier-store-mobile{
        display:block;
      }
    }
    .atelier-mobile-actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      align-items:flex-start;
    }
    @media(max-width:420px){
      .atelier-mobile-actions{
        grid-template-columns:1fr;
      }
    }
    .atelier-mobile-rating .rating-pill{
      margin-top:0;
      margin-bottom:4px;
    }

    .btn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--hm-border);
      background:#fff;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-primary{
      border-color:var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      box-shadow:0 2px 10px rgba(153,27,27,.28);
    }

    /* LISTING GRID LAYOUT (atelier) */
    .listings-header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .listings-empty{
      margin-top:12px;
      padding:12px 14px;
      border-radius:12px;
      border:1px dashed #d1d5db;
      background:#f9fafb;
      font-size:13px;
      color:#6b7280;
    }

    .atelier-listings-grid{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
      align-items:flex-start;
    }
    @media (max-width:900px){
      .atelier-listings-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    @media (max-width:560px){
      .atelier-listings-grid{
        grid-template-columns:repeat(2,minmax(0,1fr)); /* keep 2 cols on small phones */
      }
    }

    .listings-upcoming{
      margin-top:18px;
    }

    /* LISTING CARDS â€“ COPIED FROM HOMEPAGE */
    .listing-card{
      background:var(--hm-bg-card);
      border:1px solid var(--hm-border);
      border-radius:12px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .listing-thumb-link{
      display:block;
      text-decoration:none;
      color:inherit;
    }
    .listing-thumb{
      aspect-ratio:1/1;
      background:linear-gradient(180deg,#f8fafc,#eef2f7);
      display:grid;
      place-items:center;
      overflow:hidden;
      position:relative;
    }
    .listing-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    /* Not for sale badge and styling */
    .not-for-sale-badge{
      position:absolute;
      top:8px;
      left:8px;
      background:rgba(107,114,128,0.9);
      color:#fff;
      font-size:11px;
      font-weight:600;
      padding:4px 8px;
      border-radius:4px;
      z-index:2;
    }
    .listing-card.not-for-sale .listing-add-btn{
      background:#9ca3af;
      cursor:not-allowed;
    }
    .listing-body{
      padding:8px 10px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .listing-title-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:6px;
    }
    .listing-title{
      font-weight:700;
      font-size:14px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:normal;
      line-height:1.3;
      text-decoration:none;
      color:#111827;
    }
    .listing-dept{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#f3f4f6;
      color:#4b5563;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .listing-yards{
      font-size:12px;
      color:#4b5563;
    }
    .listing-cta-row{
      margin-top:4px;
    }
    .listing-add-btn{
      width:100%;
      border-radius:10px;
      border:1px solid var(--hm-accent);
      background:var(--hm-accent);
      color:#fff;
      font-weight:700;
      font-size:13px;
      padding:8px 10px;
      cursor:pointer;
      white-space:normal;
      line-height:1.3;
    }
    .listing-add-btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    .listing-price-row{
      margin-top:6px;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
    }
    .listing-price-main{
      font-weight:700;
      color:#111827;
    }
    .listing-price-orig{
      text-decoration:line-through;
      color:#9ca3af;
    }
    .listing-seller-row{
      margin-top:4px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      color:#6b7280;
    }
    .listing-seller-name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* PROFILE PANEL */
    .profile-panel{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .profile-main{
      flex:1;
      min-width:0;
    }
    .profile-name{
      font-weight:700;
      font-size:15px;
      margin-bottom:2px;
    }
    .profile-shop{
      font-size:13px;
      color:#6b7280;
      margin-bottom:6px;
    }
    .profile-bio{
      font-size:13px;
      margin-bottom:10px;
      white-space:pre-line;
    }

    /* SHARE / RATING */
    .share-input-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:8px;
    }
    .share-input-row input{
      flex:1;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid var(--hm-border);
      font-size:13px;
      background:#f9fafb;
    }
    .share-note,
    .rating-note{
      margin-top:8px;
      font-size:12px;
      color:#6b7280;
    }
    .rating-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      font-size:12px;
      margin-top:10px;
      background:#f9fafb;
      color:#6b7280;
    }

    .error-msg{
      margin-bottom:12px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #fecaca;
      background:#fef2f2;
      color:#b91c1c;
      font-size:13px;
    }

    /* ATELIER AVATAR - v2024.12.27 */
    .atelier-avatar {
      width: 60px !important;
      height: 60px !important;
      border-radius: 50% !important;
      background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      flex-shrink: 0 !important;
      overflow: hidden !important;
      border: 3px solid rgba(153, 27, 27, 0.2) !important;
      box-shadow: 0 4px 12px rgba(153, 27, 27, 0.15) !important;
      position: relative !important;
      font-size: 0 !important;
      color: transparent !important;
    }
    
    .atelier-avatar svg {
      width: 32px;
      height: 32px;
      color: #fff !important;
      fill: #fff !important;
      position: absolute;
      z-index: 2;
    }
    
    .atelier-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      z-index: 3;
    }

    /* CATEGORY TABS */
    .atelier-category-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--hm-border);
      flex-wrap: wrap;
      align-items: flex-end;
    }
    
    .atelier-coming-soon-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .atelier-coming-soon-label {
      font-size: 11px;
      font-weight: 700;
      color: #92400e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .atelier-coming-soon-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .atelier-tab {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: 1px solid var(--hm-border);
      border-radius: 10px;
      background: #fff;
      font-size: 13px;
      font-weight: 600;
      color: var(--hm-muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .atelier-tab:hover:not(:disabled) {
      border-color: var(--hm-accent);
      color: var(--hm-accent);
      background: #fef7f7;
    }

    .atelier-tab.active {
      border-color: var(--hm-accent);
      background: var(--hm-accent);
      color: #fff;
      box-shadow: 0 2px 8px rgba(153, 27, 27, 0.2);
    }

    .atelier-tab:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }

    .atelier-tab svg {
      flex-shrink: 0;
    }

    .atelier-tab-badge {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(153, 27, 27, 0.1);
      color: var(--hm-accent);
      margin-left: 4px;
    }

    .atelier-tab.active .atelier-tab-badge {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
    }

    .atelier-tab:disabled .atelier-tab-badge {
      background: #f3f4f6;
      color: #9ca3af;
    }

    /* COMING SOON TABS - Exciting gold style */
    .atelier-tab-coming {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
      border-color: #f59e0b !important;
      color: #92400e !important;
      cursor: pointer !important;
      opacity: 1 !important;
    }

    .atelier-tab-coming:hover {
      background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%) !important;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .atelier-tab-badge-new {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      color: #fff;
      font-weight: 700;
      margin-left: 6px;
      box-shadow: 0 2px 6px rgba(153, 27, 27, 0.3);
      animation: pulse-badge 2s ease-in-out infinite;
      white-space: nowrap;
    }

    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* TAB PANELS */
    .atelier-tab-panel {
      display: none;
    }

    .atelier-tab-panel.active {
      display: block;
    }

    /* COMING SOON STATE */
    .atelier-coming-soon {
      text-align: center;
      padding: 50px 20px;
      background: linear-gradient(135deg, #fdfcfb 0%, #fff8f8 50%, #faf5f0 100%);
      border-radius: 16px;
      border: 2px dashed #e8d4d4;
      position: relative;
      overflow: hidden;
    }

    .atelier-coming-soon::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(153,27,27,0.03) 0%, transparent 50%);
      animation: pulse 4s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.1); opacity: 1; }
    }

    .atelier-coming-soon-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
      color: #fff;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(153, 27, 27, 0.3);
      font-size: 42px;
      position: relative;
      z-index: 1;
    }

    .atelier-coming-soon h3 {
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 700;
      color: #991b1b;
      position: relative;
      z-index: 1;
    }

    .atelier-coming-soon p {
      margin: 0 auto 8px;
      font-size: 15px;
      color: var(--hm-muted);
      max-width: 420px;
      line-height: 1.6;
      position: relative;
      z-index: 1;
    }

    .atelier-coming-soon-sub {
      font-size: 13px !important;
      color: #991b1b !important;
      font-weight: 600;
      margin-top: 12px !important;
    }

    /* Photo Modal */
    .photo-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .photo-modal.active {
      display: flex;
    }

    .photo-modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    .photo-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      font-size: 32px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      line-height: 1;
    }

    @media (max-width: 640px) {
      .atelier-category-tabs {
        flex-direction: column;
        gap: 8px;
      }
      
      .atelier-tab {
        padding: 10px 14px;
        font-size: 13px;
        width: 100%;
        justify-content: flex-start;
      }
      
      .atelier-tab-coming {
        flex-wrap: wrap;
        gap: 6px;
      }
      
      .atelier-tab-badge-new {
        font-size: 10px;
        padding: 2px 8px;
      }
    }
  @media(max-width:768px){body{background-position:20% center;}}
  </style>
  <!-- Vercel Web Analytics -->
  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>

<div id="hm-shell-header"></div>

<main class="atelier-wrap" id="maincontent">
  <header>
    <h1 class="atelier-title" id="atelierTitle">Atelier</h1>
    <p class="atelier-subtitle" id="atelierSubtitle">
      Browse fabrics from this studio and discover the story behind each piece.
    </p>
  </header>

  <div id="atelierError" class="error-msg" style="display:none;"></div>

  <!-- MOBILE QUICK INFO (message + rating) -->
  <section class="atelier-store-mobile" aria-label="Atelier quick info">
    <div class="atelier-mobile-actions">
      <button class="btn btn-primary" type="button" id="btnMessageSellerMobile">
        Message this seller
      </button>
      <div class="atelier-mobile-rating">
        <div class="rating-pill">Not yet rated</div>
        <p class="rating-note">
          After at least 5 completed orders, the shopâ€™s rating will appear here.
        </p>
      </div>
    </div>
  </section>

  <!-- STORE INFO - TWO COLUMNS (stacks on mobile) -->
  <style>
    .atelier-store-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .atelier-store-grid {
        grid-template-columns: 1fr;
      }
    }
  @media(max-width:768px){body{background-position:20% center;}}
  </style>
  <section class="atelier-store-grid" aria-label="Atelier information">
    <!-- COLUMN 1: STORE / OWNER -->
    <section class="hm-card" aria-labelledby="profileHeading">
      <div class="hm-card-header" id="profileHeading">Store</div>
      <div class="hm-card-body">
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:12px;">
          <div class="atelier-avatar" id="atelierAvatar" style="cursor:pointer;" title="View larger photo">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4z"/>
              <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
            </svg>
          </div>
          <div class="profile-name" id="atelierOwnerName" style="font-size:18px;font-weight:600;">Hemline member</div>
          <div id="atelierBadges" class="seller-badges" style="margin-top:8px;"></div>
        </div>
        
        <!-- Bio section -->
        <div id="atelierBioSection" style="margin-bottom:12px;display:none;">
          <p id="atelierBioText" style="margin:0;font-size:14px;color:#6b7280;line-height:1.5;"></p>
        </div>
        
        <!-- Share link row -->
        <div style="margin-bottom:12px;">
          <div style="display:flex;gap:8px;">
            <input id="shareLinkInput" type="text" readonly style="flex:1;padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px;background:#f9fafb;">
            <button class="btn" type="button" id="btnCopyLink">Copy</button>
          </div>
        </div>

        <button class="btn btn-primary" type="button" id="btnEditShop" style="display:none;">Edit Atelier details</button>
        <button class="btn" type="button" id="btnMessageSeller" style="margin-top:8px;display:none;">Message this seller</button>
      </div>
    </section>

    <!-- COLUMN 2: RATING -->
    <section class="hm-card" aria-labelledby="ratingHeading">
      <div class="hm-card-header" id="ratingHeading">Rating</div>
      <div class="hm-card-body">
        <div class="rating-pill" id="ratingPill">Not yet rated</div>
        <p class="rating-note" id="ratingNote" style="margin:8px 0 0;font-size:12px;">After 5 completed orders, this seller's rating will appear.</p>
        
        <!-- V2 Features (owner only) -->
        <div id="v2FeaturesSection" style="display:none;margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb;">
          <p style="margin:0 0 10px;font-size:11px;font-weight:600;color:#991b1b;text-transform:uppercase;letter-spacing:0.5px;">âœ¨ Coming in Version 2</p>
          <div style="display:flex;flex-wrap:wrap;gap:8px;">
            <span style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border:1px solid #f59e0b;border-radius:999px;font-size:13px;font-weight:600;color:#92400e;">ðŸ“¦ Bulk listings</span>
            <span style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border:1px solid #f59e0b;border-radius:999px;font-size:13px;font-weight:600;color:#92400e;">ðŸ“Š Sales analytics</span>
          </div>
        </div>
      </div>
    </section>
  </section>
  
  <!-- Hidden elements for backwards compatibility -->
  <div id="atelierShopName" style="display:none;"></div>
  <div id="atelierStoreLink" style="display:none;"></div>
  <div id="atelierBio" style="display:none;"></div>

  <!-- LISTINGS CARD -->
  <section class="hm-card" aria-labelledby="listingsHeading">
    <div class="hm-card-header" id="listingsHeading">Listings</div>
    <div class="hm-card-body">
      
      <!-- Category Tabs -->
      <div class="atelier-category-tabs" role="tablist">
        <button class="atelier-tab active" role="tab" aria-selected="true" data-category="fabrics" id="tab-fabrics">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/><path d="M7 7h10v2H7zm0 4h10v2H7zm0 4h7v2H7z"/></svg>
          <span>Fabrics</span>
        </button>
        
        <!-- Coming Soon Section -->
        <div class="atelier-coming-soon-group">
          <div class="atelier-coming-soon-label">âœ¨ Coming soon in version 2</div>
          <div class="atelier-coming-soon-tabs">
            <button class="atelier-tab atelier-tab-coming" role="tab" aria-selected="false" data-category="patterns" id="tab-patterns">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
              <span>Sewing Patterns</span>
            </button>
            <button class="atelier-tab atelier-tab-coming" role="tab" aria-selected="false" data-category="pieces" id="tab-pieces">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M18.5 3H6c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-3 13h-3v3h-1v-3H8.5v-1h3v-3h1v3h3v1z"/></svg>
              <span>Handmade Goods</span>
            </button>
            <button class="atelier-tab atelier-tab-coming" role="tab" aria-selected="false" data-category="equipment" id="tab-equipment">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>
              <span>Equipment</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Fabrics Panel (Active) -->
      <div class="atelier-tab-panel active" role="tabpanel" id="panel-fabrics" aria-labelledby="tab-fabrics">
        <div class="listings-header-row">
          <strong style="font-size:14px;">Fabrics from this shop</strong>
        </div>

        <!-- Live listings empty state -->
        <div class="listings-empty" id="listingsEmpty">
          No active listings yet. When this shop lists fabrics, cards will appear here with photos,
          yardage, and prices.
        </div>

        <!-- Grid of live cards -->
        <div class="atelier-listings-grid" id="listingsGrid" style="display:none;"></div>

        <!-- Owner-only upcoming block -->
        <section id="upcomingSection" class="listings-upcoming" style="display:none;">
          <h3 style="margin:14px 0 4px;font-size:14px;">Scheduled for release</h3>
          <p id="upcomingNote" style="margin:0 0 8px;font-size:12px;color:#6b7280;">
            Only you can see these listings until their release time.
          </p>
          <div class="atelier-listings-grid" id="upcomingGrid"></div>
        </section>
      </div>
      
      <!-- Sewing Patterns Panel (Coming Soon) -->
      <div class="atelier-tab-panel" role="tabpanel" id="panel-patterns" aria-labelledby="tab-patterns" hidden>
        <div class="atelier-coming-soon">
          <div class="atelier-coming-soon-icon">
            âœ¨
          </div>
          <h3>Sewing Patterns â€” Coming Soon!</h3>
          <p>Soon you'll be able to list and sell PDF and physical sewing patterns right here in your Atelier.</p>
        </div>
      </div>
      
      <!-- Handmade Goods Panel (Coming Soon) -->
      <div class="atelier-tab-panel" role="tabpanel" id="panel-pieces" aria-labelledby="tab-pieces" hidden>
        <div class="atelier-coming-soon">
          <div class="atelier-coming-soon-icon">
            ðŸª¡
          </div>
          <h3>Handmade Goods â€” Coming Soon!</h3>
          <p>Turn your creations into income! List and sell your handmade garments, accessories, quilts, bags, and finished pieces to the Hemline community.</p>
          <p class="atelier-coming-soon-sub">This feature is on its way!</p>
        </div>
      </div>
      
      <!-- Equipment Panel (Coming Soon) -->
      <div class="atelier-tab-panel" role="tabpanel" id="panel-equipment" aria-labelledby="tab-equipment" hidden>
        <div class="atelier-coming-soon">
          <div class="atelier-coming-soon-icon">
            ðŸ§°
          </div>
          <h3>Sewing Equipment â€” Coming Soon!</h3>
          <p>Soon you'll be able to list and sell sewing machines, sergers, dress forms, cutting tools, and other equipment right here in your Atelier.</p>
        </div>
      </div>
      
    </div>
  </section>
</main>

<div id="hm-shell-footer"></div>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="scripts/hm-shell.js"></script>

<script>
  // Render shell first
  window.HM && window.HM.renderShell({ currentPage: "atelier" });

  // Use shared Supabase client
  var supabaseClient = window.supabase_client || (window.HM && window.HM.supabase);
  if (!supabaseClient) {
    supabaseClient = window.supabase.createClient(
      "https://clkizksbvxjkoatdajgd.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsa2l6a3Nidnhqa29hdGRhamdkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2ODAyMDUsImV4cCI6MjA3MDI1NjIwNX0.m3wd6UAuqxa7BpcQof9mmzd8zdsmadwGDO0x7-nyBjI",
      { auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
    );
  }
  window.supabase_client = supabaseClient;

  function slugifyStoreName(raw){
    if(!raw) return "";
    return raw
      .trim()
      .toLowerCase()
      .replace(/['â€™]/g,"s")
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/^-+|-+$/g,"");
  }

  function moneyFromCents(c){
    if(c == null) return "";
    const v = Number(c) / 100;
    return v.toLocaleString("en-US",{
      style:"currency",
      currency:"USD",
      minimumFractionDigits:2,
      maximumFractionDigits:2
    });
  }

  function computeYards(row){
    const y1 = row.yards_available;
    const y2 = row.yardage;
    const raw = (y1 != null ? Number(y1) : (y2 != null ? Number(y2) : null));
    if(!Number.isFinite(raw) || raw <= 0) return null;
    return raw;
  }

  /**
   * Sort fiber content to display premium/natural fibers first
   * Priority: Wool, Silk, Cotton, Linen before synthetics like Spandex
   */
  const FIBER_PRIORITY = {
    'cashmere': 1, 'vicuna': 2, 'qiviut': 3,
    'silk': 5, 'mulberry silk': 5,
    'wool': 10, 'merino': 11, 'alpaca': 12, 'mohair': 13, 'angora': 14, 'camel': 15, 'yak': 16,
    'linen': 20, 'flax': 20,
    'cotton': 25, 'pima cotton': 24, 'egyptian cotton': 23, 'supima': 24,
    'hemp': 30, 'ramie': 31, 'jute': 32, 'bamboo': 35,
    'leather': 40,
    'viscose': 50, 'rayon': 51, 'modal': 52, 'lyocell': 53, 'tencel': 53, 'cupro': 54, 'acetate': 55, 'triacetate': 56,
    'polyester': 70, 'nylon': 71, 'acrylic': 72,
    'spandex': 80, 'elastane': 80, 'lycra': 80, 'spandex / elastane': 80,
    'lurex': 85, 'metallic': 86,
    'other': 99
  };

  function formatContentForDisplay(content) {
    if (!content) return "";
    const fibers = content.split(",").map(s => s.trim()).filter(Boolean);
    // Sort by priority (natural fibers first)
    fibers.sort((a, b) => {
      const aPriority = FIBER_PRIORITY[a.toLowerCase()] ?? 60;
      const bPriority = FIBER_PRIORITY[b.toLowerCase()] ?? 60;
      return aPriority - bPriority;
    });
    // Shorten "Spandex / Elastane" to "Elastane" for display
    return fibers.map(s => s === "Spandex / Elastane" ? "Elastane" : s).join(", ");
  }

  function getListingBadgeLabel(listing) {
    const parts = [];
    
    // Add fiber content (e.g., "Wool, Silk")
    if (listing.content && listing.content !== "Not sure" && listing.content !== "Other") {
      parts.push(formatContentForDisplay(listing.content));
    }
    
    // Add fabric type (e.g., "Jersey", "Suiting")
    if (listing.fabric_type) {
      parts.push(listing.fabric_type);
    } else if (listing.feels_like) {
      const feels = listing.feels_like.split(",")[0].trim();
      parts.push(feels.charAt(0).toUpperCase() + feels.slice(1));
    }
    
    return parts.join(" Â· ");
  }

  async function ensureSession({maxWaitMs=3000} = {}){
    let { data:{ session } } = await supabaseClient.auth.getSession();
    if(session?.user) return session;
    const start = Date.now();
    while(!session?.user && Date.now() - start < maxWaitMs){
      await new Promise(r=>setTimeout(r,120));
      ({ data:{ session } } = await supabaseClient.auth.getSession());
    }
    return session || null;
  }

  function showAtelierError(msg){
    const el = document.getElementById("atelierError");
    if(!el) return;
    el.textContent = msg;
    el.style.display = "block";
  }

  async function loadListingsForSeller(sellerId, sellerLabel, isOwn){
    const grid  = document.getElementById("listingsGrid");
    const empty = document.getElementById("listingsEmpty");
    const upcomingSection = document.getElementById("upcomingSection");
    const upcomingGrid = document.getElementById("upcomingGrid");

    if(!grid || !empty || !sellerId){
      empty.style.display="block";
      grid.style.display="none";
      if(upcomingSection) upcomingSection.style.display = "none";
      return;
    }

    try{
      const { data, error } = await supabaseClient
        .from("listings")
        .select("*")
        .eq("seller_id", sellerId)
        .order("published_at", { ascending:false });

      if(error){
        showAtelierError("We couldnâ€™t load listings for this shop.");
        empty.style.display="block";
        grid.style.display="none";
        if(upcomingSection) upcomingSection.style.display = "none";
        return;
      }

      grid.innerHTML = "";
      if(upcomingGrid) upcomingGrid.innerHTML = "";

      const now = new Date();

      // Filter listings based on whether viewing own shop or someone else's
      // Own shop: show ACTIVE + NOT_FOR_SALE + SOLD listings
      // Other shops: only show ACTIVE + is_published true (no sold items)
      // NOTE: Sold items hidden from public for now during early launch phase
      const rows = (data || []).filter(x => {
        const status = (x.status || "active").toLowerCase();
        
        if (isOwn) {
          // Owner sees active and sold listings
          return status === "active" || status === "sold";
        } else {
          // Public visitors only see published active listings (no sold)
          return x.is_published === true && status === "active";
        }
      });

      const live = rows.filter(x =>
        !x.published_at || new Date(x.published_at) <= now
      );

      const upcoming = isOwn
        ? rows.filter(x => x.published_at && new Date(x.published_at) > now)
        : [];

      if(!live.length){
        empty.style.display="block";
        grid.style.display="none";
      }else{
        empty.style.display="none";
        grid.style.display="grid";
      }

      function renderCard(container, item){
        const yards = computeYards(item);
        const priceCents = item.price_cents != null ? Number(item.price_cents) : null;
        const origPriceCents = item.orig_price_cents != null ? Number(item.orig_price_cents) : null;
        const perYdMoney = priceCents != null ? moneyFromCents(priceCents) : "";
        const origPerMoney = origPriceCents != null ? moneyFromCents(origPriceCents) : "";
        const hasDiscount = origPriceCents != null && priceCents != null && origPriceCents > priceCents;
        const totalCents = (priceCents != null && yards != null) ? priceCents * yards : null;
        const totalMoney = totalCents != null ? moneyFromCents(totalCents) : "";

        const status = (item.status || "active").toLowerCase();
        const isNotForSale = item.is_published === false && status === "active";
        const isSold = !isNotForSale && status === "sold";
        const canBuy = !isSold && !isNotForSale && priceCents != null && yards != null && yards > 0;

        const card = document.createElement("article");
        card.className = "listing-card" + (isNotForSale ? " not-for-sale" : "");

        const href = "listing.html?id=" + encodeURIComponent(item.id);
        const safeTitle = item.title || "Untitled listing";
        const safeAlt = safeTitle.replace(/"/g,"&quot;");

        const badgeLabel = getListingBadgeLabel(item);

        card.innerHTML = `
          <a class="listing-thumb-link" href="${href}">
            <div class="listing-thumb" aria-hidden="true">
              ${isNotForSale ? '<div class="not-for-sale-badge">Not for Sale</div>' : ''}
              ${item.image_url_1 ? `<img src="${item.image_url_1}" alt="${safeAlt}" loading="lazy" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:#9ca3af;font-size:12px;\\'>Image unavailable</div>';">` : '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#9ca3af;font-size:12px;">No image</div>'}
            </div>
          </a>
          <div class="listing-body">
            <div class="listing-title-row">
              <a class="listing-title" href="${href}">${safeTitle}</a>
            </div>
            ${yards != null ? `<div class="listing-yards">${yards} yards${badgeLabel ? ` <span class="listing-dept">${badgeLabel}</span>` : ""}</div>` : ""}
            <div class="listing-cta-row">
              <button type="button" class="listing-add-btn add-to-cart" ${isNotForSale ? 'disabled' : ''}>
                ${
                  isNotForSale
                    ? "Not for Sale"
                    : (canBuy && totalMoney && yards
                      ? `Add to Cart â€” ${totalMoney} for ${yards} yards`
                      : (isSold ? "Sold out" : "Add to Cart"))
                }
              </button>
            </div>
            <div class="listing-price-row">
              ${
                perYdMoney
                  ? `<span class="listing-price-main">${perYdMoney}/yard</span>`
                  : `<span class="listing-price-main">Price coming soon</span>`
              }
              ${
                hasDiscount && origPerMoney
                  ? `<span class="listing-price-orig">${origPerMoney}/yard</span>`
                  : ""
              }
            </div>
            <div class="listing-seller-row">
              <span class="listing-seller-name">${sellerLabel || ""}</span>
            </div>
          </div>
        `;

        const btn = card.querySelector(".listing-add-btn");
        if(btn){
          const perYdDollars = priceCents != null ? (priceCents / 100) : 0;
          const firstImg = item.image_url_1 || "";

          btn.dataset.id = item.id;
          btn.dataset.name = safeTitle;
          btn.dataset.amount = totalCents != null ? String(totalCents) : "0";
          btn.dataset.price = perYdDollars ? perYdDollars.toFixed(2) : "0";
          btn.dataset.yards = yards != null ? String(yards) : "0";
          btn.dataset.sellerId = item.seller_id || "";
          btn.dataset.sellerName = sellerLabel || "";
          btn.dataset.photo = firstImg;

          if(!canBuy && !isNotForSale){
            btn.disabled = true;
            // Show "Sold" if no yards available, "Unavailable" only if missing price
            if (priceCents == null) {
              btn.textContent = "Unavailable";
            } else {
              btn.textContent = "Sold";
            }
          }
        }

        container.appendChild(card);
      }

      // Render live listings
      live.forEach(item => renderCard(grid, item));

      // Render upcoming listings for owner only
      if(isOwn && upcoming.length && upcomingSection && upcomingGrid){
        upcomingSection.style.display = "block";
        upcomingGrid.innerHTML = "";
        upcoming.forEach(item => renderCard(upcomingGrid, item));
      }else if(upcomingSection){
        upcomingSection.style.display = "none";
      }

    }catch(err){
      showAtelierError("Unexpected error loading listings.");
      const upcomingSection = document.getElementById("upcomingSection");
      if(upcomingSection) upcomingSection.style.display = "none";
    }
  }

  async function initAtelier(){
    const params = new URLSearchParams(window.location.search);
    const shopSlugParam = params.get("shop");
    let viewedSellerId  = params.get("u");

    if(viewedSellerId && viewedSellerId.startsWith("user=")){
      viewedSellerId = viewedSellerId.slice(5);
    }

    const session = await ensureSession();
    const loggedIn = session?.user || null;

    const ownerNameEl = document.getElementById("atelierOwnerName");
    const shopNameEl  = document.getElementById("atelierShopName");
    const bioEl       = document.getElementById("atelierBio");
    const titleEl     = document.getElementById("atelierTitle");
    const subEl       = document.getElementById("atelierSubtitle");
    const editBtn     = document.getElementById("btnEditShop");
    const shareInput  = document.getElementById("shareLinkInput");
    const copyBtn     = document.getElementById("btnCopyLink");
    const msgBtn      = document.getElementById("btnMessageSeller");
    const msgBtnMobile= document.getElementById("btnMessageSellerMobile");

    let sellerId = null;
    let profile = null;

    try{
      if(viewedSellerId){
        sellerId = viewedSellerId;
        const { data } = await supabaseClient
          .from("profiles")
          .select("*")
          .eq("id", sellerId)
          .maybeSingle();
        profile = data;
      }else if(shopSlugParam){
        const normalized = shopSlugParam.replace(/-/g," ").trim();
        const { data } = await supabaseClient
          .from("profiles")
          .select("*")
          .ilike("store_name", normalized);
        if(data && data.length){
          profile = data[0];
          sellerId = profile.id;
        }
      }else if(loggedIn){
        sellerId = loggedIn.id;
        const { data } = await supabaseClient
          .from("profiles")
          .select("*")
          .eq("id", sellerId)
          .maybeSingle();
        profile = data;
      }
    }catch(_){}

    const isOwn = !!(loggedIn && sellerId && loggedIn.id===sellerId);

    // Avatar element
    const avatarEl = document.getElementById("atelierAvatar");

    // Helper to show avatar
    function showSellerAvatar(avatarUrl) {
      if (avatarEl && avatarUrl) {
        avatarEl.innerHTML = `<img src="${avatarUrl}" alt="Seller photo" onerror="this.style.display='none';this.parentElement.innerHTML='<span style=\\'display:flex;align-items:center;justify-content:center;width:100%;height:100%;background:#f3f4f6;color:#9ca3af;font-size:24px;border-radius:50%;\\'>ðŸ‘¤</span>';" />`;
      }
    }

    if(!sellerId){
      titleEl.textContent="Atelier";
      subEl.textContent="Sign in or follow a seller link to view an Atelier.";
      ownerNameEl.textContent="Hemline member";
      shopNameEl.textContent="Store name";
      bioEl.textContent="";
      editBtn.style.display = loggedIn ? "inline-flex" : "none";
      if(editBtn.onclick) editBtn.onclick = ()=>window.location.href="account.html";
      msgBtn.style.display="none";
      if(msgBtnMobile) msgBtnMobile.style.display="none";
      shareInput.value=window.location.href;
      copyBtn.onclick=()=>navigator.clipboard.writeText(shareInput.value);
      loadListingsForSeller(null,"",false);
      return;
    }

    let first = "";
    let last  = "";
    let store = profile?.shop_name || profile?.store_name || "";
    let bio   = profile?.bio || "";
    let email = profile?.email || (isOwn?loggedIn.email:"");
    let avatarUrl = profile?.avatar_url || "";

    // Show seller avatar if available
    if (avatarUrl) {
      showSellerAvatar(avatarUrl);
    }

    // Parse full_name into first/last if available
    if (profile?.full_name) {
      const nameParts = profile.full_name.split(' ');
      first = nameParts[0] || "";
      last = nameParts.slice(1).join(' ') || "";
    }
    
    // Also check user_metadata if this is the owner's own atelier
    if (isOwn && loggedIn.user_metadata) {
      const meta = loggedIn.user_metadata;
      first = first || meta.first_name || "";
      last = last || meta.last_name || "";
      store = store || meta.shop_name || "";
      // Check for avatar in user_metadata
      if (!avatarUrl && meta.avatar_url) {
        avatarUrl = meta.avatar_url;
        showSellerAvatar(avatarUrl);
      }
    }

    // Helper: check if name looks auto-generated (relay email prefix)
    function isAutoGenerated(name) {
      if (!name) return true;
      return /^[a-z0-9]{6,}$/i.test(name) || name === "Hemline member";
    }

    // If owner hasn't set up profile yet, show friendly prompt
    const profileIncomplete = isOwn && !first && !last && !store;
    const nameIsGibberish = isAutoGenerated(loggedIn?.email?.split("@")[0]);

    let fullName, shopDisplay;
    
    if (profileIncomplete || (isOwn && nameIsGibberish && !first && !store)) {
      fullName = "Set up your profile";
      shopDisplay = "Your Shop";
    } else {
      fullName = (first+" "+last).trim() || profile?.display_name || profile?.full_name || (isOwn ? loggedIn.email.split("@")[0] : "Hemline member");
      
      if(store.trim()){
        shopDisplay = store.trim();
      }else if(first && last){
        shopDisplay = first+" "+last[0].toUpperCase()+".";
      }else if(first){
        shopDisplay = first;
      }else{
        shopDisplay = fullName;
      }
    }

    titleEl.textContent="Atelier: "+shopDisplay;
    subEl.textContent= profileIncomplete ? "Complete your profile to set up your shop." : "";
    ownerNameEl.textContent=fullName;
    
    // Render seller badges - only for verified sellers
    const atelierBadgesEl = document.getElementById("atelierBadges");
    if(atelierBadgesEl && profile && profile.stripe_account_id){
      atelierBadgesEl.innerHTML = "";
      
      // Founder badge (red with star) - highest priority
      if(profile.is_founder){
        const badge = document.createElement("span");
        badge.className = "badge-founder";
        badge.textContent = "Founder";
        atelierBadgesEl.appendChild(badge);
      }
      // OG Seller badge (gold with crown) - first 300 verified sellers
      else if(profile.is_early_seller){
        const badge = document.createElement("span");
        badge.className = "badge-og-seller";
        badge.textContent = "OG Seller";
        atelierBadgesEl.appendChild(badge);
      }
      // Verified seller badge (green) - all other verified sellers
      else {
        const badge = document.createElement("span");
        badge.className = "badge-verified";
        badge.textContent = "Verified";
        atelierBadgesEl.appendChild(badge);
      }
    }
    
    // Display bio if available
    const bioSection = document.getElementById("atelierBioSection");
    const bioText = document.getElementById("atelierBioText");
    if (bio && bio.trim() && bioSection && bioText) {
      bioText.textContent = bio;
      bioSection.style.display = "block";
    }
    
    // Only show "Store name:" if it's different from the owner name
    if (store && store !== fullName && !profileIncomplete) {
      shopNameEl.textContent = "Store name: " + store;
    } else if (profileIncomplete) {
      shopNameEl.textContent = "Add your store name in your profile";
    } else {
      shopNameEl.textContent = ""; // Don't repeat the name
    }

    let slug = slugifyStoreName(shopDisplay);
    
    // Use pretty URL format: hemlinemarket.com/shop/afroza
    const prettyUrl = "https://hemlinemarket.com/shop/" + (slug || sellerId);
    // Actual working URL for the link
    const shareUrl = window.location.origin + "/atelier.html?shop=" + encodeURIComponent(slug || sellerId);

    // Show pretty URL in share input
    shareInput.value = prettyUrl;
    copyBtn.onclick = () => {
      navigator.clipboard.writeText(prettyUrl);
      copyBtn.textContent = 'Copied!';
      setTimeout(() => copyBtn.textContent = 'Copy', 2000);
    };

    // make store name in title clickable
    const safeName = shopDisplay
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
    titleEl.innerHTML = 'Atelier: <a href="'+shareUrl+'" id="atelierTitleLink">'+safeName+'</a>';

    if(isOwn){
      editBtn.style.display="inline-flex";
      editBtn.onclick=()=>window.location.href="account.html";
      msgBtn.style.display="none";
      if(msgBtnMobile) msgBtnMobile.style.display="none";
      
      // Update rating note for owner
      const ratingNote = document.getElementById("ratingNote");
      if(ratingNote) ratingNote.textContent = "After 5 completed orders, your rating will appear.";
      
      // Show seller tools section for owner
      const v2FeaturesSection = document.getElementById("v2FeaturesSection");
      if (v2FeaturesSection) {
        v2FeaturesSection.style.display = "block";
      }
    }else{
      editBtn.style.display="none";
      msgBtn.style.display="inline-flex";
      msgBtn.onclick=()=>window.location.href="messages.html?user="+sellerId;
      if(msgBtnMobile){
        msgBtnMobile.style.display="inline-flex";
        msgBtnMobile.onclick=()=>window.location.href="messages.html?user="+sellerId;
      }
    }

    // Display seller rating (only if 5+ completed sales)
    const ratingPill = document.getElementById("ratingPill");
    const ratingStars = document.getElementById("ratingStars");
    const mobileRatingPill = document.querySelector(".atelier-mobile-rating .rating-pill");
    
    if(profile && profile.completed_sales >= 5 && profile.rating_count >= 1){
      const avg = parseFloat(profile.rating_average) || 0;
      const fullStars = Math.floor(avg);
      const halfStar = (avg - fullStars) >= 0.5;
      const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
      
      const starsHtml = 'â˜…'.repeat(fullStars) + (halfStar ? 'Â½' : '') + 'â˜†'.repeat(emptyStars);
      const ratingText = `${avg.toFixed(1)} / 5 (${profile.rating_count} review${profile.rating_count === 1 ? '' : 's'})`;
      
      if(ratingPill){
        ratingPill.innerHTML = `<span style="color:#fbbf24;font-size:18px;letter-spacing:2px;">${starsHtml}</span>`;
        ratingPill.style.background = "#fef3c7";
        ratingPill.style.border = "1px solid #fcd34d";
      }
      if(ratingStars){
        ratingStars.style.display = "block";
        ratingStars.innerHTML = `<span style="font-size:14px;color:#6b7280;">${ratingText}</span>`;
      }
      if(mobileRatingPill){
        mobileRatingPill.innerHTML = `<span style="color:#fbbf24;">${starsHtml}</span> ${avg.toFixed(1)}`;
        mobileRatingPill.style.background = "#fef3c7";
      }
    } else {
      // Not enough sales yet
      const salesNeeded = Math.max(0, 5 - (profile?.completed_sales || 0));
      if(ratingPill && salesNeeded > 0){
        ratingPill.textContent = "Not yet rated";
      } else if(ratingPill){
        ratingPill.textContent = "No reviews yet";
      }
    }

    loadListingsForSeller(sellerId, shopDisplay, isOwn);
  }

  initAtelier();
</script>

<script>
  // Category tabs functionality
  (function() {
    const tabs = document.querySelectorAll('.atelier-tab');
    const panels = document.querySelectorAll('.atelier-tab-panel');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // Only allow clicking on non-disabled tabs
        if (this.disabled) return;
        
        const category = this.dataset.category;
        
        // Update tabs
        tabs.forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });
        this.classList.add('active');
        this.setAttribute('aria-selected', 'true');
        
        // Update panels
        panels.forEach(p => {
          p.classList.remove('active');
          p.hidden = true;
        });
        
        const targetPanel = document.getElementById('panel-' + category);
        if (targetPanel) {
          targetPanel.classList.add('active');
          targetPanel.hidden = false;
        }
      });
    });
  })();
</script>

<script>
  window.HM && window.HM.renderShell({ currentPage: "atelier" });
</script>

<!-- Cart hooks so Add to Cart works here too -->
<script src="assets/add-to-cart.js" defer></script>

<!-- Photo Modal -->
<div class="photo-modal" id="photoModal">
  <button class="photo-modal-close" id="photoModalClose">&times;</button>
  <img id="photoModalImg" src="" alt="Profile photo">
</div>

<script>
  // Photo modal functionality
  (function() {
    const avatarEl = document.getElementById('atelierAvatar');
    const modal = document.getElementById('photoModal');
    const modalImg = document.getElementById('photoModalImg');
    const closeBtn = document.getElementById('photoModalClose');

    if (avatarEl && modal && modalImg) {
      avatarEl.addEventListener('click', () => {
        const img = avatarEl.querySelector('img');
        if (img && img.src) {
          modalImg.src = img.src;
          modal.classList.add('active');
        }
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target === closeBtn) {
          modal.classList.remove('active');
        }
      });

      closeBtn.addEventListener('click', () => {
        modal.classList.remove('active');
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          modal.classList.remove('active');
        }
      });
    }
  })();
</script>

</body>
</html>
