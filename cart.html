<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Cart · Hemline Market</title>

  <link rel="stylesheet" href="styles/hm-modern.css" />
  <link rel="stylesheet" href="styles/hem-header.css" />
  <link rel="stylesheet" href="styles/hm-typography.css" />

  <style>
    :root{ --hm-border:#e5e7eb; --hm-soft:#fafafa; --hm-muted:#6b7280; --hm-text:#111827; --hm-accent:#991b1b; }
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px}
    .page{max-width:900px;margin:24px auto;padding:0 16px}
    .cart{display:grid;gap:12px}
    .cart-row{display:grid;grid-template-columns:1fr auto auto auto;gap:12px;align-items:center;border:1px solid var(--hm-border);border-radius:12px;padding:12px;background:#fff}
    .cart-row .title{font-weight:700}
    .cart-row .price{color:var(--hm-muted);font-size:14px}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{width:30px;height:30px;border:1px solid var(--hm-border);border-radius:8px;background:#fff}
    .line{font-weight:700}
    .remove{border:1px solid var(--hm-border);background:#fff;border-radius:8px;padding:6px 10px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px;border-top:1px solid var(--hm-border);padding-top:12px}
    .subtotal{font-weight:800}
    .btn{border:1px solid var(--hm-border);border-radius:10px;padding:10px 14px;background:#fff}
    .btn-primary{border-color:var(--hm-accent);background:var(--hm-accent);color:#fff;font-weight:800}
    .empty{max-width:600px;margin:32px auto;padding:24px;border:1px dashed var(--hm-border);border-radius:14px;text-align:center;color:var(--hm-muted)}
    .empty a{display:inline-block;margin-top:12px;padding:10px 16px;border-radius:999px;background:var(--hm-accent);color:#fff;font-weight:700;text-decoration:none;border:1px solid var(--hm-accent)}
    /* cart badge in header */
    .cart-badge{position:absolute;top:-6px;right:-8px;min-width:18px;height:18px;padding:0 4px;display:none;align-items:center;justify-content:center;background:var(--hm-accent);color:#fff;border-radius:999px;font-size:11px;font-weight:800;line-height:18px;border:1px solid #fff}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="hm-header" role="banner">
    <div class="wrap">
      <div class="left">
        <a class="hm-brand" href="index.html">Hemline Market</a>
        <nav class="hm-nav" aria-label="Primary">
          <a href="browse.html">Browse</a>
        </nav>
      </div>
      <div class="right">
        <a class="hm-icon" href="cart.html" aria-label="Cart" style="position:relative">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="9"  cy="21" r="1"></circle>
            <circle cx="18" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
          <span class="cart-badge" data-cart-badge></span>
        </a>
      </div>
    </div>
  </header>

  <!-- CART -->
  <main class="page">
    <h1>Your Cart</h1>

    <!-- Visible when we have items -->
    <div id="cartArea" style="display:none">
      <div id="cartList" class="cart"></div>
      <div class="footer">
        <div class="subtotal">Subtotal: <span id="subtotal">$0.00</span></div>
        <div class="actions">
          <button id="continueBtn" class="btn">Continue shopping</button>
          <button id="checkoutBtn" class="btn btn-primary">Checkout</button>
        </div>
      </div>
    </div>

    <!-- Empty state -->
    <div id="emptyState" class="empty" style="display:none">
      <h2>Your cart is empty</h2>
      <p>When you add a fabric to your cart, it will appear here.</p>
      <a href="browse.html">Browse Fabrics</a>
    </div>
  </main>

  <footer class="hm-footer" role="contentinfo">
    <div class="wrap" style="padding:12px 16px;border-top:1px solid var(--hm-border)">
      <div style="color:var(--hm-muted)">© 2025 Hemline Market</div>
      <nav class="footer-links" aria-label="Footer">
        <a href="about.html">About</a>
        <a href="faq.html">FAQ</a>
        <a href="terms.html">Terms</a>
        <a href="privacy.html">Privacy</a>
      </nav>
    </div>
  </footer>

  <!-- CART CORE (badge + storage) -->
  <script src="scripts/cart.js"></script>

  <!-- PAGE LOGIC -->
  <script>
  (function () {
    const $ = (s) => document.querySelector(s);
    const cartArea = $('#cartArea');
    const emptyState = $('#emptyState');
    const listEl = $('#cartList');
    const subtotalEl = $('#subtotal');
    const checkoutBtn = $('#checkoutBtn');
    const continueBtn = $('#continueBtn');

    // expose a badge updater for other pages to call if needed
    window.HM_CART_BADGE_UPDATE = function () {
      const b = document.querySelector('[data-cart-badge]');
      if (!b) return;
      const total = (window.Cart?.get() || []).reduce((n,i)=>n+i.quantity,0);
      b.textContent = total > 99 ? '99+' : String(total);
      b.style.display = total ? 'inline-flex' : 'none';
    };

    function fmt(cents){ return '$' + (cents/100).toFixed(2); }

    function render(){
      const items = window.Cart.get();
      if (!items.length){
        cartArea.style.display = 'none';
        emptyState.style.display = 'block';
        subtotalEl.textContent = fmt(0);
        window.HM_CART_BADGE_UPDATE();
        return;
      }
      cartArea.style.display = 'block';
      emptyState.style.display = 'none';

      listEl.innerHTML = '';
      items.forEach(it=>{
        const row = document.createElement('div');
        row.className = 'cart-row';
        row.innerHTML = `
          <div class="info">
            <div class="title">${it.name}</div>
            <div class="price">${fmt(it.price)}</div>
          </div>
          <div class="qty">
            <button class="dec" aria-label="Decrease">−</button>
            <span class="q">${it.quantity}</span>
            <button class="inc" aria-label="Increase">+</button>
          </div>
          <div class="line">${fmt(it.price * it.quantity)}</div>
          <button class="remove" aria-label="Remove">Remove</button>
        `;
        row.querySelector('.inc').addEventListener('click', ()=>{ Cart.setQty(it.id, it.quantity+1); render(); });
        row.querySelector('.dec').addEventListener('click', ()=>{ Cart.setQty(it.id, Math.max(0, it.quantity-1)); render(); });
        row.querySelector('.remove').addEventListener('click', ()=>{ Cart.remove(it.id); render(); });
        listEl.appendChild(row);
      });

      subtotalEl.textContent = fmt(Cart.totalCents());
      window.HM_CART_BADGE_UPDATE();
    }

    // continue shopping
    continueBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      location.href = 'browse.html';
    });

    // checkout
    checkoutBtn.addEventListener('click', async ()=>{
      const items = Cart.get();
      if (!items.length) return;
      checkoutBtn.disabled = true;
      checkoutBtn.textContent = 'Processing…';
      try{
        const payload = {
          items: items.map(i=>({
            id: i.id, name: i.name, amount: i.price, quantity: i.quantity, currency: i.currency
          }))
        };
        const res = await fetch('/api/checkout/stripe', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        // Helpful errors: 404 → host likely redirected to home
        if (res.status === 404) {
          alert('Checkout endpoint not found (/api/checkout/stripe). If you are on a static host, you need a server function for Stripe.');
          return;
        }

        const data = await res.json().catch(()=> ({}));
        if (res.ok && data.url) {
          window.location.href = data.url;
        } else {
          alert(data.error || 'Could not start checkout.');
        }
      } catch(err){
        alert('Network or server error starting checkout.');
      } finally{
        checkoutBtn.disabled = false;
        checkoutBtn.textContent = 'Checkout';
      }
    });

    // initial
    render();
  })();
  </script>
</body>
</html>
